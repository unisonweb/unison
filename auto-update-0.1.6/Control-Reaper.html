<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Control.Reaper</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">auto-update-0.1.6: Efficiently run periodic, on-demand actions</span><ul class="links" id="page-menu"><li><a href="src/Control.Reaper.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>Safe-Inferred</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Control.Reaper</p></div><div id="table-of-contents"><div id="contents-list"><p class="caption" onclick="window.scrollTo(0,0)">Contents</p><ul><li><a href="#g:1">Example: Regularly cleaning a cache</a></li><li><a href="#g:2">Settings</a></li><li><a href="#g:3">Accessors</a></li><li><a href="#g:4">Type</a></li><li><a href="#g:5">Creation</a></li><li><a href="#g:6">Helper</a></li></ul></div></div><div id="description"><p class="caption">Description</p><div class="doc"><p>This module provides the ability to create reapers: dedicated cleanup
 threads. These threads will automatically spawn and die based on the
 presence of a workload to process on. Example uses include:</p><ul><li>Killing long-running jobs</li><li>Closing unused connections in a connection pool</li><li>Pruning a cache of old items (see example below)</li></ul><p>For real-world usage, search the <a href="https://github.com/yesodweb/wai">WAI family of packages</a>
 for imports of <a href="Control-Reaper.html">Control.Reaper</a>.</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><span class="keyword">data</span> <a href="#t:ReaperSettings">ReaperSettings</a> workload item</li><li class="src short"><a href="#v:defaultReaperSettings">defaultReaperSettings</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> [item] item</li><li class="src short"><a href="#v:reaperAction">reaperAction</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> workload item -&gt; workload -&gt; <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> (workload -&gt; workload)</li><li class="src short"><a href="#v:reaperDelay">reaperDelay</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> workload item -&gt; <a href="../base-4.18.2.1/Data-Int.html#t:Int" title="Data.Int">Int</a></li><li class="src short"><a href="#v:reaperCons">reaperCons</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> workload item -&gt; item -&gt; workload -&gt; workload</li><li class="src short"><a href="#v:reaperNull">reaperNull</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> workload item -&gt; workload -&gt; <a href="../base-4.18.2.1/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a></li><li class="src short"><a href="#v:reaperEmpty">reaperEmpty</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> workload item -&gt; workload</li><li class="src short"><span class="keyword">data</span> <a href="#t:Reaper">Reaper</a> workload item = <a href="#v:Reaper">Reaper</a> {<ul class="subs"><li><a href="#v:reaperAdd">reaperAdd</a> :: item -&gt; <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> ()</li><li><a href="#v:reaperRead">reaperRead</a> :: <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> workload</li><li><a href="#v:reaperStop">reaperStop</a> :: <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> workload</li><li><a href="#v:reaperKill">reaperKill</a> :: <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> ()</li></ul>}</li><li class="src short"><a href="#v:mkReaper">mkReaper</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> workload item -&gt; <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> (<a href="Control-Reaper.html#t:Reaper" title="Control.Reaper">Reaper</a> workload item)</li><li class="src short"><a href="#v:mkListAction">mkListAction</a> :: (item -&gt; <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> (<a href="../base-4.18.2.1/Data-Maybe.html#t:Maybe" title="Data.Maybe">Maybe</a> item')) -&gt; [item] -&gt; <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> ([item'] -&gt; [item'])</li></ul></details></div><div id="interface"><a href="#g:1" id="g:1"><h1>Example: Regularly cleaning a cache</h1></a><div class="doc"><p>In this example code, we use a <code><a href="Data-Map-Strict.html#v:Map" title="Data.Map.Strict">Map</a></code> to cache fibonacci numbers, and a <code><a href="Control-Reaper.html#t:Reaper" title="Control.Reaper">Reaper</a></code> to prune the cache.</p><p>The <code>main</code> function first creates a <code><a href="Control-Reaper.html#t:Reaper" title="Control.Reaper">Reaper</a></code>, with fields to initialize the
 cache (<code><a href="Control-Reaper.html#v:reaperEmpty" title="Control.Reaper">reaperEmpty</a></code>), add items to it (<code><a href="Control-Reaper.html#v:reaperCons" title="Control.Reaper">reaperCons</a></code>), and prune it (<code><a href="Control-Reaper.html#v:reaperAction" title="Control.Reaper">reaperAction</a></code>).
 The reaper will run every two seconds (<code><a href="Control-Reaper.html#v:reaperDelay" title="Control.Reaper">reaperDelay</a></code>), but will stop running while
 <code><a href="Control-Reaper.html#v:reaperNull" title="Control.Reaper">reaperNull</a></code> is true.</p><p><code>main</code> then loops infinitely (<code><a href="../base-4.18.2.1/Control-Monad.html#v:forever" title="Control.Monad">forever</a></code>). Each second it calculates the fibonacci number
 for a value between 30 and 34, first trying the cache (<code><a href="Control-Reaper.html#v:reaperRead" title="Control.Reaper">reaperRead</a></code> and <code><a href="Data-Map-Strict.html#v:lookup" title="Data.Map.Strict">lookup</a></code>),
 then falling back to manually calculating it (<code>fib</code>)
 and updating the cache with the result (<code><a href="Control-Reaper.html#v:reaperAdd" title="Control.Reaper">reaperAdd</a></code>)</p><p><code>clean</code> simply removes items cached for more than 10 seconds.
 This function is where you would perform IO-related cleanup,
 like killing threads or closing connections, if that was the purpose of your reaper.</p><pre>module Main where

import <a href="Data-Time.html">Data.Time</a> (UTCTime, getCurrentTime, diffUTCTime)
import <a href="Control-Reaper.html">Control.Reaper</a>
import <a href="../base-4.18.2.1/Control-Concurrent.html">Control.Concurrent</a> (threadDelay)
import <a href="Data-Map-Strict.html">Data.Map.Strict</a> (Map)
import qualified <a href="Data-Map-Strict.html">Data.Map.Strict</a> as Map
import <a href="../base-4.18.2.1/Control-Monad.html">Control.Monad</a> (forever)
import <a href="System-Random.html">System.Random</a> (getStdRandom, randomR)

fib :: <code><a href="../base-4.18.2.1/Data-Int.html#t:Int" title="Data.Int">Int</a></code> -&gt; <code><a href="../base-4.18.2.1/Data-Int.html#t:Int" title="Data.Int">Int</a></code>
fib 0 = 0
fib 1 = 1
fib n = fib (n-1) + fib (n-2)

type Cache = <code><a href="Data-Map-Strict.html#v:Map" title="Data.Map.Strict">Map</a></code> <code><a href="../base-4.18.2.1/Data-Int.html#t:Int" title="Data.Int">Int</a></code> (<code><a href="../base-4.18.2.1/Data-Int.html#t:Int" title="Data.Int">Int</a></code>, <code><a href="Data-Time-Clock.html#v:UTCTime" title="Data.Time.Clock">UTCTime</a></code>)

main :: IO ()
main = do
  reaper &lt;- <code><a href="Control-Reaper.html#v:mkReaper" title="Control.Reaper">mkReaper</a></code> <code><a href="Control-Reaper.html#v:defaultReaperSettings" title="Control.Reaper">defaultReaperSettings</a></code>
    { <code><a href="Control-Reaper.html#v:reaperEmpty" title="Control.Reaper">reaperEmpty</a></code> = Map.<code><a href="Data-Map-Strict.html#v:empty" title="Data.Map.Strict">empty</a></code>
    , <code><a href="Control-Reaper.html#v:reaperCons" title="Control.Reaper">reaperCons</a></code> = \(k, v, time) workload -&gt; Map.<code><a href="Data-Map-Strict.html#v:insert" title="Data.Map.Strict">insert</a></code> k (v, time) workload
    , <code><a href="Control-Reaper.html#v:reaperAction" title="Control.Reaper">reaperAction</a></code> = clean
    , <code><a href="Control-Reaper.html#v:reaperDelay" title="Control.Reaper">reaperDelay</a></code> = 1000000 * 2 -- Clean every 2 seconds
    , <code><a href="Control-Reaper.html#v:reaperNull" title="Control.Reaper">reaperNull</a></code> = Map.<code><a href="Data-Map-Strict.html#v:null" title="Data.Map.Strict">null</a></code>
    }
  forever $ do
    fibArg &lt;- <code><a href="System-Random.html#v:getStdRandom" title="System.Random">getStdRandom</a></code> (<code><a href="System-Random.html#v:randomR" title="System.Random">randomR</a></code> (30,34))
    cache &lt;- <code><a href="Control-Reaper.html#v:reaperRead" title="Control.Reaper">reaperRead</a></code> reaper
    let cachedResult = Map.<code><a href="Data-Map-Strict.html#v:lookup" title="Data.Map.Strict">lookup</a></code> fibArg cache
    case cachedResult of
      <code><a href="../base-4.18.2.1/Data-Maybe.html#v:Just" title="Data.Maybe">Just</a></code> (fibResult, _createdAt) -&gt; <code><a href="../base-4.18.2.1/System-IO.html#v:putStrLn" title="System.IO">putStrLn</a></code> $ &quot;Found in cache: `fib &quot; ++ <code><a href="../base-4.18.2.1/Text-Show.html#v:show" title="Text.Show">show</a></code> fibArg ++ &quot;` &quot; ++ <code><a href="../base-4.18.2.1/Text-Show.html#v:show" title="Text.Show">show</a></code> fibResult
      <code><a href="../base-4.18.2.1/Data-Maybe.html#v:Nothing" title="Data.Maybe">Nothing</a></code> -&gt; do
        let fibResult = fib fibArg
        <code><a href="../base-4.18.2.1/System-IO.html#v:putStrLn" title="System.IO">putStrLn</a></code> $ &quot;Calculating `fib &quot; ++ <code><a href="../base-4.18.2.1/Text-Show.html#v:show" title="Text.Show">show</a></code> fibArg ++ &quot;` &quot; ++ <code><a href="../base-4.18.2.1/Text-Show.html#v:show" title="Text.Show">show</a></code> fibResult
        time &lt;- <code><a href="Data-Time-Clock.html#v:getCurrentTime" title="Data.Time.Clock">getCurrentTime</a></code>
        (<code><a href="Control-Reaper.html#v:reaperAdd" title="Control.Reaper">reaperAdd</a></code> reaper) (fibArg, fibResult, time)
    <code><a href="../base-4.18.2.1/Control-Concurrent.html#v:threadDelay" title="Control.Concurrent">threadDelay</a></code> 1000000 -- 1 second

-- Remove items &gt; 10 seconds old
clean :: Cache -&gt; IO (Cache -&gt; Cache)
clean oldMap = do
  currentTime &lt;- <code><a href="Data-Time-Clock.html#v:getCurrentTime" title="Data.Time.Clock">getCurrentTime</a></code>
  let pruned = Map.<code><a href="Data-Map-Strict.html#v:filter" title="Data.Map.Strict">filter</a></code> (\(_, createdAt) -&gt; currentTime `diffUTCTime` createdAt &lt; 10.0) oldMap
  return (\newData -&gt; Map.<code><a href="Data-Map-Strict.html#v:union" title="Data.Map.Strict">union</a></code> pruned newData)
</pre></div><a href="#g:2" id="g:2"><h1>Settings</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:ReaperSettings" class="def">ReaperSettings</a> workload item <a href="src/Control.Reaper.html#ReaperSettings" class="link">Source</a> <a href="#t:ReaperSettings" class="selflink">#</a></p><div class="doc"><p>Settings for creating a reaper. This type has two parameters:
 <code>workload</code> gives the entire workload, whereas <code>item</code> gives an
 individual piece of the queue. A common approach is to have <code>workload</code>
 be a list of <code>item</code>s. This is encouraged by <code><a href="Control-Reaper.html#v:defaultReaperSettings" title="Control.Reaper">defaultReaperSettings</a></code> and
 <code><a href="Control-Reaper.html#v:mkListAction" title="Control.Reaper">mkListAction</a></code>.</p><p><em>Since: 0.1.1</em></p></div></div><div class="top"><p class="src"><a id="v:defaultReaperSettings" class="def">defaultReaperSettings</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> [item] item <a href="src/Control.Reaper.html#defaultReaperSettings" class="link">Source</a> <a href="#v:defaultReaperSettings" class="selflink">#</a></p><div class="doc"><p>Default <code>ReaperSettings</code> value, biased towards having a list of work
 items.</p><p><em>Since: 0.1.1</em></p></div></div><a href="#g:3" id="g:3"><h1>Accessors</h1></a><div class="top"><p class="src"><a id="v:reaperAction" class="def">reaperAction</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> workload item -&gt; workload -&gt; <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> (workload -&gt; workload) <a href="src/Control.Reaper.html#reaperAction" class="link">Source</a> <a href="#v:reaperAction" class="selflink">#</a></p><div class="doc"><p>The action to perform on a workload. The result of this is a
 &quot;workload modifying&quot; function. In the common case of using lists,
 the result should be a difference list that prepends the remaining
 workload to the temporary workload. The temporary workload here
 refers to items added to the workload while the reaper action is
 running. For help with setting up such an action, see <code><a href="Control-Reaper.html#v:mkListAction" title="Control.Reaper">mkListAction</a></code>.</p><p>Default: do nothing with the workload, and then prepend it to the
 temporary workload. This is incredibly useless; you should
 definitely override this default.</p><p><em>Since: 0.1.1</em></p></div></div><div class="top"><p class="src"><a id="v:reaperDelay" class="def">reaperDelay</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> workload item -&gt; <a href="../base-4.18.2.1/Data-Int.html#t:Int" title="Data.Int">Int</a> <a href="src/Control.Reaper.html#reaperDelay" class="link">Source</a> <a href="#v:reaperDelay" class="selflink">#</a></p><div class="doc"><p>Number of microseconds to delay between calls of <code><a href="Control-Reaper.html#v:reaperAction" title="Control.Reaper">reaperAction</a></code>.</p><p>Default: 30 seconds.</p><p><em>Since: 0.1.1</em></p></div></div><div class="top"><p class="src"><a id="v:reaperCons" class="def">reaperCons</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> workload item -&gt; item -&gt; workload -&gt; workload <a href="src/Control.Reaper.html#reaperCons" class="link">Source</a> <a href="#v:reaperCons" class="selflink">#</a></p><div class="doc"><p>Add an item onto a workload.</p><p>Default: list consing.</p><p><em>Since: 0.1.1</em></p></div></div><div class="top"><p class="src"><a id="v:reaperNull" class="def">reaperNull</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> workload item -&gt; workload -&gt; <a href="../base-4.18.2.1/Data-Bool.html#t:Bool" title="Data.Bool">Bool</a> <a href="src/Control.Reaper.html#reaperNull" class="link">Source</a> <a href="#v:reaperNull" class="selflink">#</a></p><div class="doc"><p>Check if a workload is empty, in which case the worker thread
 will shut down.</p><p>Default: <code><a href="../base-4.18.2.1/Data-Foldable.html#v:null" title="Data.Foldable">null</a></code>.</p><p><em>Since: 0.1.1</em></p></div></div><div class="top"><p class="src"><a id="v:reaperEmpty" class="def">reaperEmpty</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> workload item -&gt; workload <a href="src/Control.Reaper.html#reaperEmpty" class="link">Source</a> <a href="#v:reaperEmpty" class="selflink">#</a></p><div class="doc"><p>An empty workload.</p><p>Default: empty list.</p><p><em>Since: 0.1.1</em></p></div></div><a href="#g:4" id="g:4"><h1>Type</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:Reaper" class="def">Reaper</a> workload item <a href="src/Control.Reaper.html#Reaper" class="link">Source</a> <a href="#t:Reaper" class="selflink">#</a></p><div class="doc"><p>A data structure to hold reaper APIs.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:Reaper" class="def">Reaper</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:reaperAdd" class="def">reaperAdd</a> :: item -&gt; <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> ()</dfn><div class="doc"><p>Adding an item to the workload</p></div></li><li><dfn class="src"><a id="v:reaperRead" class="def">reaperRead</a> :: <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> workload</dfn><div class="doc"><p>Reading workload.</p></div></li><li><dfn class="src"><a id="v:reaperStop" class="def">reaperStop</a> :: <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> workload</dfn><div class="doc"><p>Stopping the reaper thread if exists.
   The current workload is returned.</p></div></li><li><dfn class="src"><a id="v:reaperKill" class="def">reaperKill</a> :: <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> ()</dfn><div class="doc"><p>Killing the reaper thread immediately if exists.</p></div></li></ul></div></td></tr></table></div></div><a href="#g:5" id="g:5"><h1>Creation</h1></a><div class="top"><p class="src"><a id="v:mkReaper" class="def">mkReaper</a> :: <a href="Control-Reaper.html#t:ReaperSettings" title="Control.Reaper">ReaperSettings</a> workload item -&gt; <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> (<a href="Control-Reaper.html#t:Reaper" title="Control.Reaper">Reaper</a> workload item) <a href="src/Control.Reaper.html#mkReaper" class="link">Source</a> <a href="#v:mkReaper" class="selflink">#</a></p><div class="doc"><p>Create a reaper addition function. This function can be used to add
 new items to the workload. Spawning of reaper threads will be handled
 for you automatically.</p><p><em>Since: 0.1.1</em></p></div></div><a href="#g:6" id="g:6"><h1>Helper</h1></a><div class="top"><p class="src"><a id="v:mkListAction" class="def">mkListAction</a> :: (item -&gt; <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> (<a href="../base-4.18.2.1/Data-Maybe.html#t:Maybe" title="Data.Maybe">Maybe</a> item')) -&gt; [item] -&gt; <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> ([item'] -&gt; [item']) <a href="src/Control.Reaper.html#mkListAction" class="link">Source</a> <a href="#v:mkListAction" class="selflink">#</a></p><div class="doc"><p>A helper function for creating <code><a href="Control-Reaper.html#v:reaperAction" title="Control.Reaper">reaperAction</a></code> functions. You would
 provide this function with a function to process a single work item and
 return either a new work item, or <code>Nothing</code> if the work item is
 expired.</p><p><em>Since: 0.1.1</em></p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.29.2</p></div></body></html>