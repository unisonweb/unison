<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- See Note [Arbitary Maybe Void]</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-simplifiable-class-constraints #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.LSP.Protocol.QuickCheck.Message</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Row</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">R</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Row.Records</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">R</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Void</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Message</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.LSP.Protocol.QuickCheck.Types.html"><span class="hs-identifier">Language.LSP.Protocol.QuickCheck.Types</span></a></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Types</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Test.QuickCheck</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Test.QuickCheck.Arbitrary.Generic</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Test.QuickCheck.Instances</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span id="local-6989586621679216466"><span id="local-6989586621679216475"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenericArbitrary</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestMessage</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Arbitrary</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RequestMessage</span></span></span></span><span>
</span><span id="line-19"></span><span id="local-6989586621679216622"><span id="local-6989586621679216630"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenericArbitrary</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponseMessage</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Arbitrary</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponseMessage</span></span></span></span><span>
</span><span id="line-20"></span><span id="local-6989586621679216772"><span id="local-6989586621679216780"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">via</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenericArbitrary</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NotificationMessage</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Arbitrary</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NotificationMessage</span></span></span></span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-comment">-- See Note [Arbitary Maybe Void]</span><span>
</span><span id="line-23"></span><span class="hs-keyword">instance</span><span> </span><span class="hs-pragma">{-# OVERLAPS</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span id="local-6989586621679216881"><span class="annot"><span class="hs-identifier hs-type">Arbitrary</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-24"></span><span>  </span><span id="local-6989586621679216886"><span class="annot"><span class="annottext">arbitrary :: Gen (Maybe Void)
</span><a href="#local-6989586621679216886"><span class="hs-identifier hs-var hs-var hs-var hs-var">arbitrary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Void -&gt; Gen (Maybe Void)
forall a. a -&gt; Gen a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe Void
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-comment">-- FIXME: there is something funny with the way we're representing error data.</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- Should be able to have these instances!</span><span>
</span><span id="line-28"></span><span class="hs-comment">{-
deriving via (GenericArbitrary ResponseError) instance Arbitrary ResponseError

deriving via
  (GenericArbitrary (TResponseError m))
  instance
    (Arbitrary (ErrorData m)) =&gt; Arbitrary (TResponseError m)

deriving via
  (GenericArbitrary (TResponseMEssage m))
  instance
    (Arbitrary (MessageResult m), Arbitrary (ErrorData m)) =&gt; Arbitrary (TResponseMEssage m)
-}</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679216439"><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ErrorData</span></span><span> </span><span class="annot"><a href="#local-6989586621679216439"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Arbitrary</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TResponseError</span></span><span> </span><span class="annot"><a href="#local-6989586621679216439"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-43"></span><span>  </span><span id="local-6989586621679216904"><span class="annot"><span class="annottext">arbitrary :: Gen (TResponseError m)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">arbitrary</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LSPErrorCodes |? ErrorCodes)
-&gt; Text -&gt; Maybe (Maybe Void) -&gt; TResponseError m
(LSPErrorCodes |? ErrorCodes)
-&gt; Text -&gt; Maybe (ErrorData m) -&gt; TResponseError m
forall (f :: MessageDirection) (m :: Method f 'Request).
(LSPErrorCodes |? ErrorCodes)
-&gt; Text -&gt; Maybe (ErrorData m) -&gt; TResponseError m
</span><span class="hs-identifier hs-var">TResponseError</span></span><span> </span><span class="annot"><span class="annottext">((LSPErrorCodes |? ErrorCodes)
 -&gt; Text -&gt; Maybe (Maybe Void) -&gt; TResponseError m)
-&gt; Gen (LSPErrorCodes |? ErrorCodes)
-&gt; Gen (Text -&gt; Maybe (Maybe Void) -&gt; TResponseError m)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Gen (LSPErrorCodes |? ErrorCodes)
forall a. Arbitrary a =&gt; Gen a
</span><span class="hs-identifier hs-var">arbitrary</span></span><span> </span><span class="annot"><span class="annottext">Gen (Text -&gt; Maybe (Maybe Void) -&gt; TResponseError m)
-&gt; Gen Text -&gt; Gen (Maybe (Maybe Void) -&gt; TResponseError m)
forall a b. Gen (a -&gt; b) -&gt; Gen a -&gt; Gen b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Gen Text
forall a. Arbitrary a =&gt; Gen a
</span><span class="hs-identifier hs-var">arbitrary</span></span><span> </span><span class="annot"><span class="annottext">Gen (Maybe (Maybe Void) -&gt; TResponseError m)
-&gt; Gen (Maybe (Maybe Void)) -&gt; Gen (TResponseError m)
forall a b. Gen (a -&gt; b) -&gt; Gen a -&gt; Gen b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe Void) -&gt; Gen (Maybe (Maybe Void))
forall a. a -&gt; Gen a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Maybe Void)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-44"></span><span>  </span><span id="local-6989586621679216937"><span class="annot"><span class="annottext">shrink :: TResponseError m -&gt; [TResponseError m]
</span><a href="#local-6989586621679216937"><span class="hs-identifier hs-var hs-var hs-var hs-var">shrink</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TResponseError m -&gt; [TResponseError m]
forall a.
(Generic a, RecursivelyShrink (Rep a), GSubterms (Rep a) a) =&gt;
a -&gt; [a]
</span><span class="hs-identifier hs-var">genericShrink</span></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Arbitrary</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ResponseError</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-47"></span><span>  </span><span id="local-6989586621679216950"><span class="annot"><span class="annottext">arbitrary :: Gen ResponseError
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">arbitrary</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LSPErrorCodes |? ErrorCodes)
-&gt; Text -&gt; Maybe Value -&gt; ResponseError
</span><span class="hs-identifier hs-var">ResponseError</span></span><span> </span><span class="annot"><span class="annottext">((LSPErrorCodes |? ErrorCodes)
 -&gt; Text -&gt; Maybe Value -&gt; ResponseError)
-&gt; Gen (LSPErrorCodes |? ErrorCodes)
-&gt; Gen (Text -&gt; Maybe Value -&gt; ResponseError)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Gen (LSPErrorCodes |? ErrorCodes)
forall a. Arbitrary a =&gt; Gen a
</span><span class="hs-identifier hs-var">arbitrary</span></span><span> </span><span class="annot"><span class="annottext">Gen (Text -&gt; Maybe Value -&gt; ResponseError)
-&gt; Gen Text -&gt; Gen (Maybe Value -&gt; ResponseError)
forall a b. Gen (a -&gt; b) -&gt; Gen a -&gt; Gen b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Gen Text
forall a. Arbitrary a =&gt; Gen a
</span><span class="hs-identifier hs-var">arbitrary</span></span><span> </span><span class="annot"><span class="annottext">Gen (Maybe Value -&gt; ResponseError)
-&gt; Gen (Maybe Value) -&gt; Gen ResponseError
forall a b. Gen (a -&gt; b) -&gt; Gen a -&gt; Gen b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Value -&gt; Gen (Maybe Value)
forall a. a -&gt; Gen a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-48"></span><span>  </span><span id="local-6989586621679216982"><span class="annot"><span class="annottext">shrink :: ResponseError -&gt; [ResponseError]
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">shrink</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResponseError -&gt; [ResponseError]
forall a.
(Generic a, RecursivelyShrink (Rep a), GSubterms (Rep a) a) =&gt;
a -&gt; [a]
</span><span class="hs-identifier hs-var">genericShrink</span></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-comment">-- See Note [Arbitary Maybe Void]</span><span>
</span><span id="line-51"></span><span id="local-6989586621679216986"><span id="local-6989586621679216994"><span class="hs-keyword">deriving</span><span> </span><span class="hs-keyword">via</span><span>
</span><span id="line-52"></span><span>  </span><span id="local-6989586621679216464"><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">GenericArbitrary</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TResponseMessage</span></span><span> </span><span class="annot"><a href="#local-6989586621679216464"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-keyword">instance</span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Arbitrary</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MessageResult</span></span><span> </span><span class="annot"><a href="#local-6989586621679216464"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ErrorData</span></span><span> </span><span class="annot"><a href="#local-6989586621679216464"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Arbitrary</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TResponseMessage</span></span><span> </span><span class="annot"><a href="#local-6989586621679216464"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-comment">-- These require a method singleton. We need something like SingI from</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- singletons to pass that into the class instance</span><span>
</span><span id="line-58"></span><span class="hs-comment">{-
instance (Arbitrary (MessageParams m)) =&gt; Arbitrary (TRequestMessage m) where
  arbitrary = TRequestMessage &lt;$&gt; arbitrary &lt;*&gt; arbitrary &lt;*&gt; arbitrary &lt;*&gt; arbitrary
  shrink = genericShrink

instance (Arbitrary (MessageParams m)) =&gt; Arbitrary (TNotificationMessage m) where
  arbitrary = TNotificationMessage &lt;$&gt; arbitrary &lt;*&gt; arbitrary &lt;*&gt; arbitrary
  shrink = genericShrink
-}</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-comment">{- Note [Arbitary Maybe Void]
For methods that don't have error data, we say that their error data type is 'Void'.
This means that the error data field has type 'Maybe Void', i.e. can only be 'Nothing',
which is what we want.

However, we have a problem with the Arbitrary instance. There is an 'Arbitrary (Maybe a)'
instance which depends on an 'Arbitrary a' instance - but there is no 'Arbitrary Void'
instance, and apparently can't be since we can't make an empty generator.

So we cheat a bit:
- Define an overlapping 'Arbitrary (Maybe Void)' instance
- Define the instances for response messages to require 'Arbitrary (Maybe (ErrorData m))',
  which delays GHC picking the actual instance until the use site, so it can pick
  the overlapping one.
-}</span><span>
</span><span id="line-83"></span></pre></body></html>