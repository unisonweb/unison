<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">unison-parser-typechecker-0.0.0</span><ul class="links" id="page-menu"><li><a href="src/Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>Safe-Inferred</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4</p></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:migrateSchema3To4">migrateSchema3To4</a> :: <a href="../unison-sqlite-0.0.0/Unison-Sqlite-Transaction.html#t:Transaction" title="Unison.Sqlite.Transaction">Transaction</a> ()</li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:migrateSchema3To4" class="def">migrateSchema3To4</a> :: <a href="../unison-sqlite-0.0.0/Unison-Sqlite-Transaction.html#t:Transaction" title="Unison.Sqlite.Transaction">Transaction</a> () <a href="src/Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrateSchema3To4" class="link">Source</a> <a href="#v:migrateSchema3To4" class="selflink">#</a></p><div class="doc"><p>There was a bug in previous versions of UCM which incorrectly used causal hashes as branch hashes.
 This remained undetected because there was never a need for this hash to be verifiable,
 and the hashes were still unique because the namespace hash was PART of the causal hash.
 It did however result in many identical branches being stored multiple times under
 different <code>primary_hash_id</code>s.</p><p>However, with the advent of Share and Sync, we now need to correctly verify these namespace
 hashes.</p><p>This migration fixes the issue by re-hashing namespace objects where the value_hash_id of a
 causal matches the self_hash_id.
 Luckily this doesn't change any causal hashes.</p><p>However, due to the possibility of multiple identical objects stored under different
 <code>primary_hash_id</code>s, we may now have multiple objects with the same <code>primary_hash_id</code>, which
 our DB schema doesn't allow.</p><p>To address this, we keep exactly one <code>canonical</code> object for each hash, then remap all
 references to old objects into this canonical object instead. Unfortunately this requires
 mapping over every branch object and traversing the child references.</p><p>It was also discovered that some developers had many branches which referenced objects
 which weren't in their codebase. We're not yet sure how this happened, but it's unlikely
 to be the case for most end users, and it turned out that these references were in causals
 and branches which were unreachable from the root namespace. As a fix, this migration also
 tracks every causal and branch which is reachable from the root namespace and deletes all
 causals and namespaces which are unreachable. Note that this may orphan some definitions,
 patches, etc. which were previously referenced in an <code>unreachable</code> branch, but they were
 already floating around in an unreachable state.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.29.2</p></div></body></html>