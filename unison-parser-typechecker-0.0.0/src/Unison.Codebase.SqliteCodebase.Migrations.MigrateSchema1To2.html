<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ApplicativeDo #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2</span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateSchema1To2"><span class="hs-identifier">migrateSchema1To2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">where</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TVar</span></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">from</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Lens</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">runExceptT</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Strict</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Except</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">throwE</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Trans.Writer.CPS</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Writer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">execWriter</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">tell</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Generics.Product</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Generics.Sum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">_Ctor</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.Extra</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">nubOrd</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Tuple</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">swap</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Tuple.Extra</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(***)</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Zip</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Zip</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Environment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lookupEnv</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO.Unsafe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafePerformIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Branch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NamespaceStats</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.HashTags</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">BranchHash</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">CausalHash</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">PatchHash</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Reference</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C.Reference</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Reference</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UReference</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Referent</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UReferent</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Branch.Full</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Branch.Full</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S.Branch.Full</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Causal</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GDbCausal</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Causal</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SC.DbCausal</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GDbCausal</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.DbId</span></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">BranchHashId</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="hs-identifier">BranchObjectId</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="hs-identifier">CausalHashId</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><span class="hs-identifier">HashId</span></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><span class="hs-identifier">ObjectId</span></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><span class="hs-identifier">PatchObjectId</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="hs-identifier">TextId</span></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.LocalizeObject</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S.LocalizeObject</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Operations</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ops</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Patch.Format</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S.Patch.Format</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Patch.Full</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Patch.TermEdit</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TermEdit</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Patch.TypeEdit</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TypeEdit</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Queries</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.V2.HashHandle</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">v2HashHandle</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Sync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Sync</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sync</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sync</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.WatchKind</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">WatchKind</span></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.WatchKind</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WK</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ABT</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ABT</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Conversions.html"><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Conversions</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cv</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.DbHelpers.html"><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.DbHelpers</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Hashing</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html"><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Operations</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CodebaseOps</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ConstructorReference</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ConstructorReference</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ConstructorType</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CT</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DD</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration.ConstructorId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ConstructorId</span></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hash</span></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Hash</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Unison</span></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Hashing.V2</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Hashing</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Hashing.V2.Convert.html"><span class="hs-identifier">Unison.Hashing.V2.Convert</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Convert</span></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Parser.Ann</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Pattern</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Pattern</span></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Pattern</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Pattern</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Reference</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Referent</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ReferentPrime</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Referent'</span></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sqlite</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Symbol</span></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Term</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Term</span></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Type</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Type</span></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Type</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">foldMapM</span></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">log</span></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#verboseOutput"><span class="hs-identifier hs-type">verboseOutput</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-87"></span><span id="verboseOutput"><span class="annot"><span class="annottext">verboseOutput :: Bool
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#verboseOutput"><span class="hs-identifier hs-var hs-var">verboseOutput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><span class="annottext">Maybe [Char] -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Maybe [Char]) -&gt; Maybe [Char]
forall a. IO a -&gt; a
</span><span class="hs-identifier hs-var">unsafePerformIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; IO (Maybe [Char])
</span><span class="hs-identifier hs-var">lookupEnv</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;UNISON_MIGRATION_DEBUG&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#verboseOutput"><span class="hs-pragma hs-type">verboseOutput</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateSchema1To2"><span class="hs-identifier hs-type">migrateSchema1To2</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">CodebaseOps.TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">CodebaseOps.DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-96"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span id="migrateSchema1To2"><span class="annot"><span class="annottext">migrateSchema1To2 :: (Reference -&gt; Transaction ConstructorType)
-&gt; TVar (Map (New Hash) TermBufferEntry)
-&gt; TVar (Map (New Hash) DeclBufferEntry)
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateSchema1To2"><span class="hs-identifier hs-var hs-var">migrateSchema1To2</span></a></span></span><span> </span><span id="local-6989586621680537877"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680537877"><span class="hs-identifier hs-var">getDeclType</span></a></span></span><span> </span><span id="local-6989586621680537878"><span class="annot"><span class="annottext">TVar (Map (New Hash) TermBufferEntry)
</span><a href="#local-6989586621680537878"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680537879"><span class="annot"><span class="annottext">TVar (Map (New Hash) DeclBufferEntry)
</span><a href="#local-6989586621680537879"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-98"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Starting codebase migration. This may take a while, it's a good time to make some tea &#9749;&#65039;&quot;</span></span><span>
</span><span id="line-99"></span><span>  </span><span id="local-6989586621680537881"><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680537881"><span class="hs-identifier hs-var">corruptedCausals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction [CausalHashId]
</span><span class="hs-identifier hs-var">Q.getCausalsWithoutBranchObjects</span></span><span>
</span><span id="line-100"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Transaction () -&gt; Transaction ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; ([CausalHashId] -&gt; Bool) -&gt; [CausalHashId] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[CausalHashId] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([CausalHashId] -&gt; Bool) -&gt; [CausalHashId] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680537881"><span class="hs-identifier hs-var">corruptedCausals</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Transaction ()) -&gt; [Char] -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;&#9888;&#65039;  I detected &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CausalHashId] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680537881"><span class="hs-identifier hs-var">corruptedCausals</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; corrupted namespace(s) in the history of the codebase.&quot;</span></span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;This is due to a bug in a previous version of ucm.&quot;</span></span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;This only affects the history of your codebase, the most up-to-date iteration will remain intact.&quot;</span></span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;I'll go ahead with the migration, but will replace any corrupted namespaces with empty ones.&quot;</span></span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Updating Namespace Root...&quot;</span></span><span>
</span><span id="line-107"></span><span>  </span><span id="local-6989586621680537889"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680537889"><span class="hs-identifier hs-var">rootCausalHashId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction CausalHashId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#expectNamespaceRoot"><span class="hs-identifier hs-var">expectNamespaceRoot</span></a></span><span>
</span><span id="line-108"></span><span>  </span><span id="local-6989586621680537891"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680537891"><span class="hs-identifier hs-var">numEntitiesToMigrate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall a. Num a =&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; Int) -&gt; Transaction [Int] -&gt; Transaction Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Transaction Int] -&gt; Transaction [Int]
forall (t :: * -&gt; *) (f :: * -&gt; *) a.
(Traversable t, Applicative f) =&gt;
t (f a) -&gt; f (t a)
forall (f :: * -&gt; *) a. Applicative f =&gt; [f a] -&gt; f [a]
</span><span class="hs-identifier hs-var">sequenceA</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Transaction Int
</span><span class="hs-identifier hs-var">Q.countObjects</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Transaction Int
</span><span class="hs-identifier hs-var">Q.countCausals</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Transaction Int
</span><span class="hs-identifier hs-var">Q.countWatches</span></span><span class="hs-special">]</span><span>
</span><span id="line-109"></span><span>  </span><span id="local-6989586621680537898"><span class="annot"><span class="annottext">(BranchHashId, BranchHash)
</span><a href="#local-6989586621680537898"><span class="hs-identifier hs-var">v2EmptyBranchHashInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction (BranchHashId, BranchHash)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#saveV2EmptyBranch"><span class="hs-identifier hs-var">saveV2EmptyBranch</span></a></span><span>
</span><span id="line-110"></span><span>  </span><span id="local-6989586621680537900"><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680537900"><span class="hs-identifier hs-var">watches</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><span class="annottext">(WatchKind -&gt; Transaction [Entity])
-&gt; [WatchKind] -&gt; Transaction [Entity]
forall (m :: * -&gt; *) (f :: * -&gt; *) b a.
(Monad m, Foldable f, Monoid b) =&gt;
(a -&gt; m b) -&gt; f a -&gt; m b
</span><span class="hs-identifier hs-var">foldMapM</span></span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680537901"><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680537901"><span class="hs-identifier hs-var">watchKind</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Old Id -&gt; Entity) -&gt; [Old Id] -&gt; [Entity]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; Old Id -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#W"><span class="hs-identifier hs-var">W</span></a></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680537901"><span class="hs-identifier hs-var">watchKind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Old Id] -&gt; [Entity])
-&gt; Transaction [Old Id] -&gt; Transaction [Entity]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction [Old Id]
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#watches"><span class="hs-identifier hs-var">CodebaseOps.watches</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; [Char]
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#watchKind2to1"><span class="hs-identifier hs-var">Cv.watchKind2to1</span></a></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680537901"><span class="hs-identifier hs-var">watchKind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-special">[</span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-identifier hs-var">WK.RegularWatch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-identifier hs-var">WK.TestWatch</span></span><span class="hs-special">]</span><span>
</span><span id="line-114"></span><span>  </span><span id="local-6989586621680537907"><span class="annot"><span class="annottext">MigrationState
</span><a href="#local-6989586621680537907"><span class="hs-identifier hs-var">migrationState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-115"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) h.
(Monad m, Show h) =&gt;
Sync m h -&gt; Progress m h -&gt; [h] -&gt; m ()
</span><span class="hs-identifier hs-var">Sync.sync</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Reference -&gt; Transaction ConstructorType)
-&gt; TVar (Map (New Hash) TermBufferEntry)
-&gt; TVar (Map (New Hash) DeclBufferEntry)
-&gt; Sync (StateT MigrationState Transaction) Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrationSync"><span class="hs-identifier hs-var">migrationSync</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680537877"><span class="hs-identifier hs-var">getDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) TermBufferEntry)
</span><a href="#local-6989586621680537878"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) DeclBufferEntry)
</span><a href="#local-6989586621680537879"><span class="hs-identifier hs-var">declBuffer</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Progress (StateT MigrationState Transaction) Entity
</span><a href="#local-6989586621680537910"><span class="hs-identifier hs-var">progress</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680537891"><span class="hs-identifier hs-var">numEntitiesToMigrate</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHashId -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#CausalE"><span class="hs-identifier hs-var">CausalE</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680537889"><span class="hs-identifier hs-var">rootCausalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">Entity -&gt; [Entity] -&gt; [Entity]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680537900"><span class="hs-identifier hs-var">watches</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>      </span><span class="annot"><span class="annottext">StateT MigrationState Transaction ()
-&gt; MigrationState -&gt; Transaction MigrationState
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m s
</span><span class="hs-operator hs-var">`execStateT`</span></span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
-&gt; Map CausalHashId (New (CausalHash, CausalHashId))
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
-&gt; Set (New Hash)
-&gt; Int
-&gt; (BranchHashId, BranchHash)
-&gt; MigrationState
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-var">MigrationState</span></a></span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span> </span><span class="annot"><span class="annottext">Map CausalHashId (New (CausalHash, CausalHashId))
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span> </span><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span> </span><span class="annot"><span class="annottext">Set (New Hash)
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">(BranchHashId, BranchHash)
</span><a href="#local-6989586621680537898"><span class="hs-identifier hs-var">v2EmptyBranchHashInfo</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680537916"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680537916"><span class="hs-identifier hs-var">newRootCausalHashId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MigrationState -&gt; Map CausalHashId (New (CausalHash, CausalHashId))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AcausalMapping%3AMigrationState"><span class="hs-identifier hs-var">causalMapping</span></a></span><span> </span><span class="annot"><span class="annottext">MigrationState
</span><a href="#local-6989586621680537907"><span class="hs-identifier hs-var">migrationState</span></a></span><span> </span><span class="annot"><span class="annottext">Map CausalHashId (New (CausalHash, CausalHashId))
-&gt; Getting
     (Endo (New (CausalHash, CausalHashId)))
     (Map CausalHashId (New (CausalHash, CausalHashId)))
     (New (CausalHash, CausalHashId))
-&gt; New (CausalHash, CausalHashId)
forall s a. HasCallStack =&gt; s -&gt; Getting (Endo a) s a -&gt; a
</span><span class="hs-operator hs-var">^?!</span></span><span> </span><span class="annot"><span class="annottext">Index (Map CausalHashId (New (CausalHash, CausalHashId)))
-&gt; Traversal'
     (Map CausalHashId (New (CausalHash, CausalHashId)))
     (IxValue (Map CausalHashId (New (CausalHash, CausalHashId))))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (Map CausalHashId (New (CausalHash, CausalHashId)))
CausalHashId
</span><a href="#local-6989586621680537889"><span class="hs-identifier hs-var">rootCausalHashId</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Updating Namespace Root...&quot;</span></span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><span class="annottext">CausalHashId -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#setNamespaceRoot"><span class="hs-identifier hs-var">setNamespaceRoot</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680537916"><span class="hs-identifier hs-var">newRootCausalHashId</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Rewriting old object IDs...&quot;</span></span><span>
</span><span id="line-121"></span><span>  </span><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
-&gt; (ObjectId
    -&gt; (ObjectId, HashId, New Hash, New Hash) -&gt; Transaction ())
-&gt; Transaction ()
forall i (t :: * -&gt; *) (f :: * -&gt; *) a b.
(FoldableWithIndex i t, Applicative f) =&gt;
t a -&gt; (i -&gt; a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">ifor_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MigrationState
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AobjLookup%3AMigrationState"><span class="hs-identifier hs-var">objLookup</span></a></span><span> </span><span class="annot"><span class="annottext">MigrationState
</span><a href="#local-6989586621680537907"><span class="hs-identifier hs-var">migrationState</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680537923"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680537923"><span class="hs-identifier hs-var">oldObjId</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680537924"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680537924"><span class="hs-identifier hs-var">newObjId</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">New Hash
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">New Hash
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><span class="annottext">ObjectId -&gt; ObjectId -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Q.recordObjectRehash</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680537923"><span class="hs-identifier hs-var">oldObjId</span></a></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680537924"><span class="hs-identifier hs-var">newObjId</span></a></span><span>
</span><span id="line-123"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Garbage collecting orphaned objects...&quot;</span></span><span>
</span><span id="line-124"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.garbageCollectObjectsWithoutHashes</span></span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Garbage collecting orphaned watches...&quot;</span></span><span>
</span><span id="line-126"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.garbageCollectWatchesWithoutObjects</span></span><span>
</span><span id="line-127"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Updating Schema Version...&quot;</span></span><span>
</span><span id="line-128"></span><span>  </span><span class="annot"><span class="annottext">SchemaVersion -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Q.setSchemaVersion</span></span><span> </span><span class="annot"><span class="annottext">SchemaVersion
</span><span class="hs-number">2</span></span><span>
</span><span id="line-129"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-130"></span><span>    </span><span class="annot"><a href="#local-6989586621680537910"><span class="hs-identifier hs-type">progress</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sync.Progress</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span id="local-6989586621680537910"><span class="annot"><span class="annottext">progress :: Int -&gt; Progress (StateT MigrationState Transaction) Entity
</span><a href="#local-6989586621680537910"><span class="hs-identifier hs-var hs-var">progress</span></a></span></span><span> </span><span id="local-6989586621680537929"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680537929"><span class="hs-identifier hs-var">numToMigrate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-132"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680537930"><span class="hs-identifier hs-type">incrementProgress</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>          </span><span id="local-6989586621680537930"><span class="annot"><span class="annottext">incrementProgress :: StateT MigrationState Transaction ()
</span><a href="#local-6989586621680537930"><span class="hs-identifier hs-var hs-var">incrementProgress</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-134"></span><span>            </span><span id="local-6989586621680537931"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680537931"><span class="hs-identifier hs-var">numDone</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;numMigrated&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; (Int, Int)) -&gt; MigrationState -&gt; (Int, MigrationState))
-&gt; Int -&gt; StateT MigrationState Transaction Int
forall s (m :: * -&gt; *) a.
(MonadState s m, Num a) =&gt;
LensLike' ((,) a) s a -&gt; a -&gt; m a
</span><span class="hs-operator hs-var">&lt;+=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-135"></span><span>            </span><span class="annot"><span class="annottext">Transaction () -&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction () -&gt; StateT MigrationState Transaction ())
-&gt; Transaction () -&gt; StateT MigrationState Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Transaction ()) -&gt; IO () -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IO ()
</span><span class="hs-identifier hs-var">putStr</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; IO ()) -&gt; [Char] -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;\r &#127959;  &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680537931"><span class="hs-identifier hs-var">numDone</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; / ~&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680537929"><span class="hs-identifier hs-var">numToMigrate</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; entities migrated. &#128679;&quot;</span></span><span>
</span><span id="line-136"></span><span>          </span><span class="annot"><a href="#local-6989586621680537937"><span class="hs-identifier hs-type">need</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>          </span><span id="local-6989586621680537937"><span class="annot"><span class="annottext">need :: Entity -&gt; StateT MigrationState Transaction ()
</span><a href="#local-6989586621680537937"><span class="hs-identifier hs-var hs-var">need</span></a></span></span><span> </span><span id="local-6989586621680537938"><span class="annot"><span class="annottext">Entity
</span><a href="#local-6989586621680537938"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; StateT MigrationState Transaction ()
-&gt; StateT MigrationState Transaction ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#verboseOutput"><span class="hs-identifier hs-var">verboseOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction ()
 -&gt; StateT MigrationState Transaction ())
-&gt; StateT MigrationState Transaction ()
-&gt; StateT MigrationState Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Transaction () -&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction () -&gt; StateT MigrationState Transaction ())
-&gt; Transaction () -&gt; StateT MigrationState Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Transaction ()) -&gt; [Char] -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Need: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Entity -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Entity
</span><a href="#local-6989586621680537938"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-138"></span><span>          </span><span class="annot"><a href="#local-6989586621680537939"><span class="hs-identifier hs-type">done</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>          </span><span id="local-6989586621680537939"><span class="annot"><span class="annottext">done :: Entity -&gt; StateT MigrationState Transaction ()
</span><a href="#local-6989586621680537939"><span class="hs-identifier hs-var hs-var">done</span></a></span></span><span> </span><span id="local-6989586621680537940"><span class="annot"><span class="annottext">Entity
</span><a href="#local-6989586621680537940"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>            </span><span class="annot"><span class="annottext">Bool
-&gt; StateT MigrationState Transaction ()
-&gt; StateT MigrationState Transaction ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#verboseOutput"><span class="hs-identifier hs-var">verboseOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction ()
 -&gt; StateT MigrationState Transaction ())
-&gt; StateT MigrationState Transaction ()
-&gt; StateT MigrationState Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Transaction () -&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction () -&gt; StateT MigrationState Transaction ())
-&gt; Transaction () -&gt; StateT MigrationState Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Transaction ()) -&gt; [Char] -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Done: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Entity -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Entity
</span><a href="#local-6989586621680537940"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-141"></span><span>            </span><span class="annot"><span class="annottext">StateT MigrationState Transaction ()
</span><a href="#local-6989586621680537930"><span class="hs-identifier hs-var">incrementProgress</span></a></span><span>
</span><span id="line-142"></span><span>          </span><span class="annot"><a href="#local-6989586621680537941"><span class="hs-identifier hs-type">errorHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>          </span><span id="local-6989586621680537941"><span class="annot"><span class="annottext">errorHandler :: Entity -&gt; StateT MigrationState Transaction ()
</span><a href="#local-6989586621680537941"><span class="hs-identifier hs-var hs-var">errorHandler</span></a></span></span><span> </span><span id="local-6989586621680537942"><span class="annot"><span class="annottext">Entity
</span><a href="#local-6989586621680537942"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Entity
</span><a href="#local-6989586621680537942"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-145"></span><span>              </span><span class="hs-comment">-- We expect non-fatal errors when migrating watches.</span><span>
</span><span id="line-146"></span><span>              </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#W"><span class="hs-identifier hs-type">W</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; StateT MigrationState Transaction ()
forall a. a -&gt; StateT MigrationState Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>              </span><span id="local-6989586621680537943"><span class="annot"><span class="annottext">Entity
</span><a href="#local-6989586621680537943"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Transaction () -&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction () -&gt; StateT MigrationState Transaction ())
-&gt; Transaction () -&gt; StateT MigrationState Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Transaction ()) -&gt; [Char] -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Error: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Entity -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Entity
</span><a href="#local-6989586621680537943"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-148"></span><span>            </span><span class="annot"><span class="annottext">StateT MigrationState Transaction ()
</span><a href="#local-6989586621680537930"><span class="hs-identifier hs-var">incrementProgress</span></a></span><span>
</span><span id="line-149"></span><span>          </span><span class="annot"><a href="#local-6989586621680537944"><span class="hs-identifier hs-type">allDone</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>          </span><span id="local-6989586621680537944"><span class="annot"><span class="annottext">allDone :: StateT MigrationState Transaction ()
</span><a href="#local-6989586621680537944"><span class="hs-identifier hs-var hs-var">allDone</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Transaction () -&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction () -&gt; StateT MigrationState Transaction ())
-&gt; Transaction () -&gt; StateT MigrationState Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Transaction ()) -&gt; [Char] -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;\nFinished migrating, initiating cleanup.&quot;</span></span><span>
</span><span id="line-151"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sync.Progress</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">Entity -&gt; StateT MigrationState Transaction ()
need :: Entity -&gt; StateT MigrationState Transaction ()
need :: Entity -&gt; StateT MigrationState Transaction ()
</span><a href="#local-6989586621680537937"><span class="hs-identifier hs-var hs-var">need</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Entity -&gt; StateT MigrationState Transaction ()
done :: Entity -&gt; StateT MigrationState Transaction ()
done :: Entity -&gt; StateT MigrationState Transaction ()
</span><a href="#local-6989586621680537939"><span class="hs-identifier hs-var hs-var">done</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">error :: Entity -&gt; StateT MigrationState Transaction ()
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Entity -&gt; StateT MigrationState Transaction ()
</span><a href="#local-6989586621680537941"><span class="hs-identifier hs-var">errorHandler</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction ()
allDone :: StateT MigrationState Transaction ()
allDone :: StateT MigrationState Transaction ()
</span><a href="#local-6989586621680537944"><span class="hs-identifier hs-var hs-var">allDone</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#expectNamespaceRoot"><span class="hs-identifier hs-type">expectNamespaceRoot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHashId</span></span><span>
</span><span id="line-154"></span><span id="expectNamespaceRoot"><span class="annot"><span class="annottext">expectNamespaceRoot :: Transaction CausalHashId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#expectNamespaceRoot"><span class="hs-identifier hs-var hs-var">expectNamespaceRoot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-155"></span><span>  </span><span class="annot"><span class="annottext">Sql -&gt; Transaction CausalHashId
forall a. (FromField a, HasCallStack) =&gt; Sql -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.queryOneCol</span></span><span> </span><span class="annot"><span class="annottext">Sql
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#loadNamespaceRootSql"><span class="hs-identifier hs-var">loadNamespaceRootSql</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#loadNamespaceRootSql"><span class="hs-identifier hs-type">loadNamespaceRootSql</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Sql</span></span><span>
</span><span id="line-158"></span><span id="loadNamespaceRootSql"><span class="annot"><span class="annottext">loadNamespaceRootSql :: Sql
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#loadNamespaceRootSql"><span class="hs-identifier hs-var hs-var">loadNamespaceRootSql</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><span class="">[Sqlite.sql|
    SELECT causal_id
    FROM namespace_root
  |]</span></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#setNamespaceRoot"><span class="hs-identifier hs-type">setNamespaceRoot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHashId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span id="setNamespaceRoot"><span class="annot"><span class="annottext">setNamespaceRoot :: CausalHashId -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#setNamespaceRoot"><span class="hs-identifier hs-var hs-var">setNamespaceRoot</span></a></span></span><span> </span><span id="local-6989586621680537954"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680537954"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-166"></span><span>  </span><span class="annot"><span class="annottext">Sql -&gt; Transaction Bool
forall a. (FromField a, HasCallStack) =&gt; Sql -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.queryOneCol</span></span><span> </span><span class="annot"><span class="">[Sqlite.sql| SELECT EXISTS (SELECT 1 FROM namespace_root) |]</span></span><span> </span><span class="annot"><span class="annottext">Transaction Bool -&gt; (Bool -&gt; Transaction ()) -&gt; Transaction ()
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-167"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span> </span><span class="annot"><span class="">[Sqlite.sql| INSERT INTO namespace_root VALUES (:id) |]</span></span><span>
</span><span id="line-168"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span> </span><span class="annot"><span class="">[Sqlite.sql| UPDATE namespace_root SET causal_id = :id |]</span></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-type">log</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span id="log"><span class="annot"><span class="annottext">log :: [Char] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#log"><span class="hs-identifier hs-var hs-var">log</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-172"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Transaction ())
-&gt; ([Char] -&gt; IO ()) -&gt; [Char] -&gt; Transaction ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="hs-keyword">type</span><span> </span><span id="Old"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-var">Old</span></a></span></span><span> </span><span id="local-6989586621680537958"><span class="annot"><a href="#local-6989586621680537958"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680537958"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="hs-keyword">type</span><span> </span><span id="New"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-var">New</span></a></span></span><span> </span><span id="local-6989586621680537959"><span class="annot"><a href="#local-6989586621680537959"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680537959"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="hs-keyword">type</span><span> </span><span id="ConstructorName"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#ConstructorName"><span class="hs-identifier hs-var">ConstructorName</span></a></span></span><span> </span><span id="local-6989586621680537961"><span class="annot"><a href="#local-6989586621680537961"><span class="hs-identifier hs-type">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680537961"><span class="hs-identifier hs-type">v</span></a></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="hs-keyword">type</span><span> </span><span id="DeclName"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#DeclName"><span class="hs-identifier hs-var">DeclName</span></a></span></span><span> </span><span id="local-6989586621680537962"><span class="annot"><a href="#local-6989586621680537962"><span class="hs-identifier hs-type">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621680537962"><span class="hs-identifier hs-type">v</span></a></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-keyword">data</span><span> </span><span id="MigrationState"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-var">MigrationState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MigrationState"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-var">MigrationState</span></a></span></span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-comment">-- Mapping between old cycle-position -&gt; new cycle-position for a given Decl object.</span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AreferenceMapping%3AMigrationState"><span class="annot"><span class="annottext">MigrationState -&gt; Map SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AreferenceMapping%3AMigrationState"><span class="hs-identifier hs-var hs-var">referenceMapping</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-type">New</span></a></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-185"></span><span>    </span><span id="%24sel%3AcausalMapping%3AMigrationState"><span class="annot"><span class="annottext">MigrationState -&gt; Map CausalHashId (New (CausalHash, CausalHashId))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AcausalMapping%3AMigrationState"><span class="hs-identifier hs-var hs-var">causalMapping</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHashId</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-type">New</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHashId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-comment">-- We also store the old hash for this object ID since we need a way to</span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-comment">-- convert Object Reference IDs into Hash Reference IDs so we can use the referenceMapping.</span><span>
</span><span id="line-188"></span><span>    </span><span id="%24sel%3AobjLookup%3AMigrationState"><span class="annot"><span class="annottext">MigrationState
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AobjLookup%3AMigrationState"><span class="hs-identifier hs-var hs-var">objLookup</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-type">New</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-type">New</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-type">New</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-comment">-- Remember the hashes of term/decls that we have already migrated to avoid migrating them twice.</span><span>
</span><span id="line-190"></span><span>    </span><span id="%24sel%3AmigratedDefnHashes%3AMigrationState"><span class="annot"><span class="annottext">MigrationState -&gt; Set (New Hash)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AmigratedDefnHashes%3AMigrationState"><span class="hs-identifier hs-var hs-var">migratedDefnHashes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-191"></span><span>    </span><span id="%24sel%3AnumMigrated%3AMigrationState"><span class="annot"><span class="annottext">MigrationState -&gt; Int
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AnumMigrated%3AMigrationState"><span class="hs-identifier hs-var hs-var">numMigrated</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-192"></span><span>    </span><span id="%24sel%3Av2EmptyBranchHashInfo%3AMigrationState"><span class="annot"><span class="annottext">MigrationState -&gt; (BranchHashId, BranchHash)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3Av2EmptyBranchHashInfo%3AMigrationState"><span class="hs-identifier hs-var hs-var">v2EmptyBranchHashInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BranchHashId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BranchHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680537968"><span id="local-6989586621680537970"><span class="annot"><span class="annottext">(forall x. MigrationState -&gt; Rep MigrationState x)
-&gt; (forall x. Rep MigrationState x -&gt; MigrationState)
-&gt; Generic MigrationState
forall x. Rep MigrationState x -&gt; MigrationState
forall x. MigrationState -&gt; Rep MigrationState x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. MigrationState -&gt; Rep MigrationState x
from :: forall x. MigrationState -&gt; Rep MigrationState x
$cto :: forall x. Rep MigrationState x -&gt; MigrationState
to :: forall x. Rep MigrationState x -&gt; MigrationState
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="hs-keyword">data</span><span> </span><span id="Entity"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-var">Entity</span></a></span></span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TermComponent"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermComponent"><span class="hs-identifier hs-var">TermComponent</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Unison.Hash</span></span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DeclComponent"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#DeclComponent"><span class="hs-identifier hs-var">DeclComponent</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Unison.Hash</span></span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CausalE"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#CausalE"><span class="hs-identifier hs-var">CausalE</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHashId</span></span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="BranchE"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#BranchE"><span class="hs-identifier hs-var">BranchE</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PatchE"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#PatchE"><span class="hs-identifier hs-var">PatchE</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="W"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#W"><span class="hs-identifier hs-var">W</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">WK.WatchKind</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680537977"><span id="local-6989586621680537991"><span class="annot"><span class="annottext">Entity -&gt; Entity -&gt; Bool
(Entity -&gt; Entity -&gt; Bool)
-&gt; (Entity -&gt; Entity -&gt; Bool) -&gt; Eq Entity
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: Entity -&gt; Entity -&gt; Bool
== :: Entity -&gt; Entity -&gt; Bool
$c/= :: Entity -&gt; Entity -&gt; Bool
/= :: Entity -&gt; Entity -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680537998"><span id="local-6989586621680538008"><span id="local-6989586621680538011"><span id="local-6989586621680538014"><span id="local-6989586621680538017"><span id="local-6989586621680538020"><span id="local-6989586621680538023"><span class="annot"><span class="annottext">Eq Entity
Eq Entity =&gt;
(Entity -&gt; Entity -&gt; Ordering)
-&gt; (Entity -&gt; Entity -&gt; Bool)
-&gt; (Entity -&gt; Entity -&gt; Bool)
-&gt; (Entity -&gt; Entity -&gt; Bool)
-&gt; (Entity -&gt; Entity -&gt; Bool)
-&gt; (Entity -&gt; Entity -&gt; Entity)
-&gt; (Entity -&gt; Entity -&gt; Entity)
-&gt; Ord Entity
Entity -&gt; Entity -&gt; Bool
Entity -&gt; Entity -&gt; Ordering
Entity -&gt; Entity -&gt; Entity
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: Entity -&gt; Entity -&gt; Ordering
compare :: Entity -&gt; Entity -&gt; Ordering
$c&lt; :: Entity -&gt; Entity -&gt; Bool
&lt; :: Entity -&gt; Entity -&gt; Bool
$c&lt;= :: Entity -&gt; Entity -&gt; Bool
&lt;= :: Entity -&gt; Entity -&gt; Bool
$c&gt; :: Entity -&gt; Entity -&gt; Bool
&gt; :: Entity -&gt; Entity -&gt; Bool
$c&gt;= :: Entity -&gt; Entity -&gt; Bool
&gt;= :: Entity -&gt; Entity -&gt; Bool
$cmax :: Entity -&gt; Entity -&gt; Entity
max :: Entity -&gt; Entity -&gt; Entity
$cmin :: Entity -&gt; Entity -&gt; Entity
min :: Entity -&gt; Entity -&gt; Entity
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538027"><span id="local-6989586621680538044"><span id="local-6989586621680538047"><span class="annot"><span class="annottext">Int -&gt; Entity -&gt; [Char] -&gt; [Char]
[Entity] -&gt; [Char] -&gt; [Char]
Entity -&gt; [Char]
(Int -&gt; Entity -&gt; [Char] -&gt; [Char])
-&gt; (Entity -&gt; [Char])
-&gt; ([Entity] -&gt; [Char] -&gt; [Char])
-&gt; Show Entity
forall a.
(Int -&gt; a -&gt; [Char] -&gt; [Char])
-&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; [Char] -&gt; [Char]) -&gt; Show a
$cshowsPrec :: Int -&gt; Entity -&gt; [Char] -&gt; [Char]
showsPrec :: Int -&gt; Entity -&gt; [Char] -&gt; [Char]
$cshow :: Entity -&gt; [Char]
show :: Entity -&gt; [Char]
$cshowList :: [Entity] -&gt; [Char] -&gt; [Char]
showList :: [Entity] -&gt; [Char] -&gt; [Char]
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrationSync"><span class="hs-identifier hs-type">migrationSync</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-206"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span></span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">CodebaseOps.TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">CodebaseOps.DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Sync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span>
</span><span id="line-211"></span><span id="migrationSync"><span class="annot"><span class="annottext">migrationSync :: (Reference -&gt; Transaction ConstructorType)
-&gt; TVar (Map (New Hash) TermBufferEntry)
-&gt; TVar (Map (New Hash) DeclBufferEntry)
-&gt; Sync (StateT MigrationState Transaction) Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrationSync"><span class="hs-identifier hs-var hs-var">migrationSync</span></a></span></span><span> </span><span id="local-6989586621680538050"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680538050"><span class="hs-identifier hs-var">getDeclType</span></a></span></span><span> </span><span id="local-6989586621680538051"><span class="annot"><span class="annottext">TVar (Map (New Hash) TermBufferEntry)
</span><a href="#local-6989586621680538051"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680538052"><span class="annot"><span class="annottext">TVar (Map (New Hash) DeclBufferEntry)
</span><a href="#local-6989586621680538052"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Entity
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; Sync (StateT MigrationState Transaction) Entity
forall (m :: * -&gt; *) entity.
(entity -&gt; m (TrySyncResult entity)) -&gt; Sync m entity
</span><span class="hs-identifier hs-var">Sync</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-212"></span><span>  </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermComponent"><span class="hs-identifier hs-type">TermComponent</span></a></span><span> </span><span id="local-6989586621680538053"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538053"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Reference -&gt; Transaction ConstructorType)
-&gt; TVar (Map (New Hash) TermBufferEntry)
-&gt; TVar (Map (New Hash) DeclBufferEntry)
-&gt; New Hash
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateTermComponent"><span class="hs-identifier hs-var">migrateTermComponent</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680538050"><span class="hs-identifier hs-var">getDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) TermBufferEntry)
</span><a href="#local-6989586621680538051"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) DeclBufferEntry)
</span><a href="#local-6989586621680538052"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538053"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#DeclComponent"><span class="hs-identifier hs-type">DeclComponent</span></a></span><span> </span><span id="local-6989586621680538055"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538055"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) TermBufferEntry)
-&gt; TVar (Map (New Hash) DeclBufferEntry)
-&gt; New Hash
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateDeclComponent"><span class="hs-identifier hs-var">migrateDeclComponent</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) TermBufferEntry)
</span><a href="#local-6989586621680538051"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) DeclBufferEntry)
</span><a href="#local-6989586621680538052"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538055"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#BranchE"><span class="hs-identifier hs-type">BranchE</span></a></span><span> </span><span id="local-6989586621680538057"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538057"><span class="hs-identifier hs-var">objectId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ObjectId
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateBranch"><span class="hs-identifier hs-var">migrateBranch</span></a></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538057"><span class="hs-identifier hs-var">objectId</span></a></span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#CausalE"><span class="hs-identifier hs-type">CausalE</span></a></span><span> </span><span id="local-6989586621680538059"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538059"><span class="hs-identifier hs-var">causalHashId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CausalHashId
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateCausal"><span class="hs-identifier hs-var">migrateCausal</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538059"><span class="hs-identifier hs-var">causalHashId</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#PatchE"><span class="hs-identifier hs-type">PatchE</span></a></span><span> </span><span id="local-6989586621680538061"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538061"><span class="hs-identifier hs-var">objectId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatchObjectId
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migratePatch"><span class="hs-identifier hs-var">migratePatch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ObjectId -&gt; PatchObjectId
</span><span class="hs-identifier hs-var">PatchObjectId</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538061"><span class="hs-identifier hs-var">objectId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>  </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#W"><span class="hs-identifier hs-type">W</span></a></span><span> </span><span id="local-6989586621680538064"><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680538064"><span class="hs-identifier hs-var">watchKind</span></a></span></span><span> </span><span id="local-6989586621680538065"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538065"><span class="hs-identifier hs-var">watchId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Reference -&gt; Transaction ConstructorType)
-&gt; WatchKind
-&gt; Old Id
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateWatch"><span class="hs-identifier hs-var">migrateWatch</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680538050"><span class="hs-identifier hs-var">getDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680538064"><span class="hs-identifier hs-var">watchKind</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538065"><span class="hs-identifier hs-var">watchId</span></a></span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateCausal"><span class="hs-identifier hs-type">migrateCausal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHashId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sync.TrySyncResult</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span id="migrateCausal"><span class="annot"><span class="annottext">migrateCausal :: CausalHashId
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateCausal"><span class="hs-identifier hs-var hs-var">migrateCausal</span></a></span></span><span> </span><span id="local-6989586621680538067"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538067"><span class="hs-identifier hs-var">oldCausalHashId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Either (TrySyncResult Entity) (TrySyncResult Entity)
 -&gt; TrySyncResult Entity)
-&gt; StateT
     MigrationState
     Transaction
     (Either (TrySyncResult Entity) (TrySyncResult Entity))
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall a b.
(a -&gt; b)
-&gt; StateT MigrationState Transaction a
-&gt; StateT MigrationState Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TrySyncResult Entity -&gt; TrySyncResult Entity)
-&gt; (TrySyncResult Entity -&gt; TrySyncResult Entity)
-&gt; Either (TrySyncResult Entity) (TrySyncResult Entity)
-&gt; TrySyncResult Entity
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity -&gt; TrySyncResult Entity
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity -&gt; TrySyncResult Entity
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT
   MigrationState
   Transaction
   (Either (TrySyncResult Entity) (TrySyncResult Entity))
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; (ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (TrySyncResult Entity)
    -&gt; StateT
         MigrationState
         Transaction
         (Either (TrySyncResult Entity) (TrySyncResult Entity)))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity)
  (StateT MigrationState Transaction)
  (TrySyncResult Entity)
-&gt; StateT
     MigrationState
     Transaction
     (Either (TrySyncResult Entity) (TrySyncResult Entity))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult Entity)
   (StateT MigrationState Transaction)
   (TrySyncResult Entity)
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity) (StateT MigrationState Transaction) Bool
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">whenM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHashId
-&gt; Map CausalHashId (New (CausalHash, CausalHashId)) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">Map.member</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538067"><span class="hs-identifier hs-var">oldCausalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">(Map CausalHashId (New (CausalHash, CausalHashId)) -&gt; Bool)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map CausalHashId (New (CausalHash, CausalHashId)))
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Map CausalHashId (New (CausalHash, CausalHashId)))
  MigrationState
  (Map CausalHashId (New (CausalHash, CausalHashId)))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map CausalHashId (New (CausalHash, CausalHashId)))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;causalMapping&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">throwE</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.PreviouslyDone</span></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>  </span><span id="local-6989586621680538074"><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680538074"><span class="hs-identifier hs-var">oldBranchHashId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction BranchHashId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     BranchHashId
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction BranchHashId
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      BranchHashId)
-&gt; (Transaction BranchHashId
    -&gt; StateT MigrationState Transaction BranchHashId)
-&gt; Transaction BranchHashId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     BranchHashId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction BranchHashId
-&gt; StateT MigrationState Transaction BranchHashId
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction BranchHashId
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      BranchHashId)
-&gt; Transaction BranchHashId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     BranchHashId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId -&gt; Transaction BranchHashId
</span><span class="hs-identifier hs-var">Q.expectCausalValueHashId</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538067"><span class="hs-identifier hs-var">oldCausalHashId</span></a></span><span>
</span><span id="line-224"></span><span>  </span><span id="local-6989586621680538076"><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680538076"><span class="hs-identifier hs-var">oldCausalParentHashIds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction [CausalHashId]
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     [CausalHashId]
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction [CausalHashId]
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      [CausalHashId])
-&gt; (Transaction [CausalHashId]
    -&gt; StateT MigrationState Transaction [CausalHashId])
-&gt; Transaction [CausalHashId]
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     [CausalHashId]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction [CausalHashId]
-&gt; StateT MigrationState Transaction [CausalHashId]
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction [CausalHashId]
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      [CausalHashId])
-&gt; Transaction [CausalHashId]
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     [CausalHashId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId -&gt; Transaction [CausalHashId]
</span><span class="hs-identifier hs-var">Q.loadCausalParents</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538067"><span class="hs-identifier hs-var">oldCausalHashId</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>  </span><span id="local-6989586621680538078"><span class="annot"><span class="annottext">Maybe ObjectId
</span><a href="#local-6989586621680538078"><span class="hs-identifier hs-var">maybeOldBranchObjId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><span class="annottext">StateT MigrationState Transaction (Maybe ObjectId)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Maybe ObjectId)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction (Maybe ObjectId)
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (Maybe ObjectId))
-&gt; (Transaction (Maybe ObjectId)
    -&gt; StateT MigrationState Transaction (Maybe ObjectId))
-&gt; Transaction (Maybe ObjectId)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Maybe ObjectId)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe ObjectId)
-&gt; StateT MigrationState Transaction (Maybe ObjectId)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (Maybe ObjectId)
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (Maybe ObjectId))
-&gt; Transaction (Maybe ObjectId)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Maybe ObjectId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-228"></span><span>      </span><span class="annot"><span class="annottext">HashId -&gt; Transaction (Maybe ObjectId)
</span><span class="hs-identifier hs-var">Q.loadObjectIdForAnyHashId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchHashId -&gt; HashId
</span><span class="hs-identifier hs-var">unBranchHashId</span></span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680538074"><span class="hs-identifier hs-var">oldBranchHashId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>  </span><span id="local-6989586621680538081"><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538081"><span class="hs-identifier hs-var">migratedObjIds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MigrationState
 -&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">MigrationState
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AobjLookup%3AMigrationState"><span class="hs-identifier hs-var">objLookup</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-comment">-- If the branch for this causal hasn't been migrated, migrate it first.</span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538083"><span class="annot"><span class="annottext">unmigratedBranch :: [Entity]
</span><a href="#local-6989586621680538083"><span class="hs-identifier hs-var hs-var">unmigratedBranch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-232"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ObjectId
</span><a href="#local-6989586621680538078"><span class="hs-identifier hs-var">maybeOldBranchObjId</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-233"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680538084"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538084"><span class="hs-identifier hs-var">branchObjId</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538084"><span class="hs-identifier hs-var">branchObjId</span></a></span><span> </span><span class="annot"><span class="annottext">ObjectId
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`Map.notMember`</span></span><span> </span><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538081"><span class="hs-identifier hs-var">migratedObjIds</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ObjectId -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#BranchE"><span class="hs-identifier hs-var">BranchE</span></a></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538084"><span class="hs-identifier hs-var">branchObjId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-234"></span><span>          </span><span class="annot"><span class="annottext">Maybe ObjectId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span>  </span><span id="local-6989586621680538086"><span class="annot"><span class="annottext">Map CausalHashId (New (CausalHash, CausalHashId))
</span><a href="#local-6989586621680538086"><span class="hs-identifier hs-var">migratedCausals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MigrationState
 -&gt; Map CausalHashId (New (CausalHash, CausalHashId)))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map CausalHashId (New (CausalHash, CausalHashId)))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">MigrationState -&gt; Map CausalHashId (New (CausalHash, CausalHashId))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AcausalMapping%3AMigrationState"><span class="hs-identifier hs-var">causalMapping</span></a></span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538087"><span class="annot"><span class="annottext">unmigratedParents :: [Entity]
</span><a href="#local-6989586621680538087"><span class="hs-identifier hs-var hs-var">unmigratedParents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-238"></span><span>        </span><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680538076"><span class="hs-identifier hs-var">oldCausalParentHashIds</span></a></span><span>
</span><span id="line-239"></span><span>          </span><span class="annot"><span class="annottext">[CausalHashId]
-&gt; ([CausalHashId] -&gt; [CausalHashId]) -&gt; [CausalHashId]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(CausalHashId -&gt; Bool) -&gt; [CausalHashId] -&gt; [CausalHashId]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHashId
-&gt; Map CausalHashId (New (CausalHash, CausalHashId)) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`Map.notMember`</span></span><span> </span><span class="annot"><span class="annottext">Map CausalHashId (New (CausalHash, CausalHashId))
</span><a href="#local-6989586621680538086"><span class="hs-identifier hs-var">migratedCausals</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>          </span><span class="annot"><span class="annottext">[CausalHashId] -&gt; ([CausalHashId] -&gt; [Entity]) -&gt; [Entity]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(CausalHashId -&gt; Entity) -&gt; [CausalHashId] -&gt; [Entity]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#CausalE"><span class="hs-identifier hs-var">CausalE</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538089"><span class="annot"><span class="annottext">unmigratedEntities :: [Entity]
</span><a href="#local-6989586621680538089"><span class="hs-identifier hs-var hs-var">unmigratedEntities</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538083"><span class="hs-identifier hs-var">unmigratedBranch</span></a></span><span> </span><span class="annot"><span class="annottext">[Entity] -&gt; [Entity] -&gt; [Entity]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538087"><span class="hs-identifier hs-var">unmigratedParents</span></a></span><span>
</span><span id="line-242"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; ([Entity] -&gt; Bool) -&gt; [Entity] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Entity] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([Entity] -&gt; Bool) -&gt; [Entity] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538087"><span class="hs-identifier hs-var">unmigratedParents</span></a></span><span> </span><span class="annot"><span class="annottext">[Entity] -&gt; [Entity] -&gt; [Entity]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538083"><span class="hs-identifier hs-var">unmigratedBranch</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">throwE</span></span><span> </span><span class="annot"><span class="annottext">(TrySyncResult Entity
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Entity] -&gt; TrySyncResult Entity
forall entity. [entity] -&gt; TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Missing</span></span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538089"><span class="hs-identifier hs-var">unmigratedEntities</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621680538091"><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680538091"><span class="hs-identifier hs-var">newBranchHashId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538092"><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680538092"><span class="hs-identifier hs-var">newBranchHash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ObjectId
</span><a href="#local-6989586621680538078"><span class="hs-identifier hs-var">maybeOldBranchObjId</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-245"></span><span>    </span><span class="hs-comment">-- Some codebases are corrupted, likely due to interrupted save operations.</span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-comment">-- It's unfortunate, but rather than fail the whole migration we'll just replace them</span><span>
</span><span id="line-247"></span><span>    </span><span class="hs-comment">-- with an empty branch.</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">Maybe ObjectId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Getting
  (BranchHashId, BranchHash)
  MigrationState
  (BranchHashId, BranchHash)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (BranchHashId, BranchHash)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;v2EmptyBranchHashInfo&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680538093"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538093"><span class="hs-identifier hs-var">branchObjId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-250"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ObjectId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538094"><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680538094"><span class="hs-identifier hs-var">newBranchHashId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538095"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538095"><span class="hs-identifier hs-var">newBranchHash</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">New Hash
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538081"><span class="hs-identifier hs-var">migratedObjIds</span></a></span><span> </span><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
-&gt; Getting
     (Endo (ObjectId, HashId, New Hash, New Hash))
     (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
     (ObjectId, HashId, New Hash, New Hash)
-&gt; (ObjectId, HashId, New Hash, New Hash)
forall s a. HasCallStack =&gt; s -&gt; Getting (Endo a) s a -&gt; a
</span><span class="hs-operator hs-var">^?!</span></span><span> </span><span class="annot"><span class="annottext">Index (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
-&gt; Traversal'
     (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
     (IxValue (Map ObjectId (ObjectId, HashId, New Hash, New Hash)))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
ObjectId
</span><a href="#local-6989586621680538093"><span class="hs-identifier hs-var">branchObjId</span></a></span><span>
</span><span id="line-251"></span><span>      </span><span class="annot"><span class="annottext">(BranchHashId, BranchHash)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (BranchHashId, BranchHash)
forall a.
a
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashId -&gt; BranchHashId
</span><span class="hs-identifier hs-var">BranchHashId</span></span><span> </span><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680538094"><span class="hs-identifier hs-var">newBranchHashId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; BranchHash
</span><span class="hs-identifier hs-var">BranchHash</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538095"><span class="hs-identifier hs-var">newBranchHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680538098"><span class="annot"><span class="annottext">Set (New Hash)
</span><a href="#local-6989586621680538098"><span class="hs-identifier hs-var">newParentHashes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538099"><span class="annot"><span class="annottext">Set CausalHashId
</span><a href="#local-6989586621680538099"><span class="hs-identifier hs-var">newParentHashIds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-254"></span><span>        </span><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680538076"><span class="hs-identifier hs-var">oldCausalParentHashIds</span></a></span><span>
</span><span id="line-255"></span><span>          </span><span class="annot"><span class="annottext">[CausalHashId]
-&gt; ([CausalHashId] -&gt; [New (CausalHash, CausalHashId)])
-&gt; [New (CausalHash, CausalHashId)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(CausalHashId -&gt; New (CausalHash, CausalHashId))
-&gt; [CausalHashId] -&gt; [New (CausalHash, CausalHashId)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680538100"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538100"><span class="hs-identifier hs-var">oldParentHashId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map CausalHashId (New (CausalHash, CausalHashId))
</span><a href="#local-6989586621680538086"><span class="hs-identifier hs-var">migratedCausals</span></a></span><span> </span><span class="annot"><span class="annottext">Map CausalHashId (New (CausalHash, CausalHashId))
-&gt; Getting
     (Endo (New (CausalHash, CausalHashId)))
     (Map CausalHashId (New (CausalHash, CausalHashId)))
     (New (CausalHash, CausalHashId))
-&gt; New (CausalHash, CausalHashId)
forall s a. HasCallStack =&gt; s -&gt; Getting (Endo a) s a -&gt; a
</span><span class="hs-operator hs-var">^?!</span></span><span> </span><span class="annot"><span class="annottext">Index (Map CausalHashId (New (CausalHash, CausalHashId)))
-&gt; Traversal'
     (Map CausalHashId (New (CausalHash, CausalHashId)))
     (IxValue (Map CausalHashId (New (CausalHash, CausalHashId))))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (Map CausalHashId (New (CausalHash, CausalHashId)))
CausalHashId
</span><a href="#local-6989586621680538100"><span class="hs-identifier hs-var">oldParentHashId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>          </span><span class="annot"><span class="annottext">[New (CausalHash, CausalHashId)]
-&gt; ([New (CausalHash, CausalHashId)]
    -&gt; ([CausalHash], [CausalHashId]))
-&gt; ([CausalHash], [CausalHashId])
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[New (CausalHash, CausalHashId)] -&gt; ([CausalHash], [CausalHashId])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span>
</span><span id="line-257"></span><span>          </span><span class="annot"><span class="annottext">([CausalHash], [CausalHashId])
-&gt; (([CausalHash], [CausalHashId])
    -&gt; (Set (New Hash), Set CausalHashId))
-&gt; (Set (New Hash), Set CausalHashId)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">([CausalHash] -&gt; Set (New Hash))
-&gt; ([CausalHashId] -&gt; Set CausalHashId)
-&gt; ([CausalHash], [CausalHashId])
-&gt; (Set (New Hash), Set CausalHashId)
forall a b c d. (a -&gt; b) -&gt; (c -&gt; d) -&gt; (a, c) -&gt; (b, d)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[New Hash] -&gt; Set (New Hash)
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([New Hash] -&gt; Set (New Hash))
-&gt; ([CausalHash] -&gt; [New Hash]) -&gt; [CausalHash] -&gt; Set (New Hash)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CausalHash -&gt; New Hash) -&gt; [CausalHash] -&gt; [New Hash]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">CausalHash -&gt; New Hash
</span><span class="hs-identifier hs-var">unCausalHash</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CausalHashId] -&gt; Set CausalHashId
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538105"><span class="hs-identifier hs-type">newCausalHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span>
</span><span id="line-260"></span><span>      </span><span id="local-6989586621680538105"><span class="annot"><span class="annottext">newCausalHash :: CausalHash
</span><a href="#local-6989586621680538105"><span class="hs-identifier hs-var hs-var">newCausalHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-261"></span><span>        </span><span class="annot"><span class="annottext">New Hash -&gt; CausalHash
</span><span class="hs-identifier hs-var">CausalHash</span></span><span> </span><span class="annot"><span class="annottext">(New Hash -&gt; CausalHash) -&gt; New Hash -&gt; CausalHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-262"></span><span>          </span><span class="annot"><span class="annottext">Causal -&gt; New Hash
forall a. ContentAddressable a =&gt; a -&gt; New Hash
</span><span class="hs-identifier hs-var">Hashing.contentHash</span></span><span>
</span><span id="line-263"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Hashing.Causal</span></span><span>
</span><span id="line-264"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">branchHash :: New Hash
</span><span class="hs-identifier hs-var">branchHash</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchHash -&gt; New Hash
</span><span class="hs-identifier hs-var">unBranchHash</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680538092"><span class="hs-identifier hs-var">newBranchHash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-265"></span><span>                </span><span class="annot"><span class="annottext">parents :: Set (New Hash)
</span><span class="hs-identifier hs-var">parents</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set (New Hash)
</span><a href="#local-6989586621680538098"><span class="hs-identifier hs-var">newParentHashes</span></a></span><span>
</span><span id="line-266"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-267"></span><span>  </span><span id="local-6989586621680538112"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538112"><span class="hs-identifier hs-var">newCausalHashId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction CausalHashId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     CausalHashId
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction CausalHashId
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      CausalHashId)
-&gt; (Transaction CausalHashId
    -&gt; StateT MigrationState Transaction CausalHashId)
-&gt; Transaction CausalHashId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     CausalHashId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction CausalHashId
-&gt; StateT MigrationState Transaction CausalHashId
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction CausalHashId
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      CausalHashId)
-&gt; Transaction CausalHashId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     CausalHashId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CausalHash -&gt; Transaction CausalHashId
</span><span class="hs-identifier hs-var">Q.saveCausalHash</span></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680538105"><span class="hs-identifier hs-var">newCausalHash</span></a></span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538114"><span class="annot"><span class="annottext">newCausal :: GDbCausal CausalHashId BranchHashId
</span><a href="#local-6989586621680538114"><span class="hs-identifier hs-var hs-var">newCausal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-269"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">DbCausal</span></span><span>
</span><span id="line-270"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:selfHash:DbCausal :: CausalHashId
</span><span class="hs-identifier hs-var">selfHash</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538112"><span class="hs-identifier hs-var">newCausalHashId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-271"></span><span>            </span><span class="annot"><span class="annottext">$sel:valueHash:DbCausal :: BranchHashId
</span><span class="hs-identifier hs-var">valueHash</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680538091"><span class="hs-identifier hs-var">newBranchHashId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-272"></span><span>            </span><span class="annot"><span class="annottext">$sel:parents:DbCausal :: Set CausalHashId
</span><span class="hs-identifier hs-var">parents</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set CausalHashId
</span><a href="#local-6989586621680538099"><span class="hs-identifier hs-var">newParentHashIds</span></a></span><span>
</span><span id="line-273"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateT MigrationState Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction ()
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; (Transaction () -&gt; StateT MigrationState Transaction ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction () -&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-275"></span><span>    </span><span class="annot"><span class="annottext">HashHandle
-&gt; CausalHashId -&gt; BranchHashId -&gt; [CausalHashId] -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Q.saveCausal</span></span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span>
</span><span id="line-277"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GDbCausal CausalHashId BranchHashId -&gt; CausalHashId
forall causalHash valueHash.
GDbCausal causalHash valueHash -&gt; causalHash
</span><span class="hs-identifier hs-var">SC.DbCausal.selfHash</span></span><span> </span><span class="annot"><span class="annottext">GDbCausal CausalHashId BranchHashId
</span><a href="#local-6989586621680538114"><span class="hs-identifier hs-var">newCausal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">GDbCausal CausalHashId BranchHashId -&gt; BranchHashId
forall causalHash valueHash.
GDbCausal causalHash valueHash -&gt; valueHash
</span><span class="hs-identifier hs-var">SC.DbCausal.valueHash</span></span><span> </span><span class="annot"><span class="annottext">GDbCausal CausalHashId BranchHashId
</span><a href="#local-6989586621680538114"><span class="hs-identifier hs-var">newCausal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set CausalHashId -&gt; [CausalHashId]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set CausalHashId -&gt; [CausalHashId])
-&gt; Set CausalHashId -&gt; [CausalHashId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GDbCausal CausalHashId BranchHashId -&gt; Set CausalHashId
forall causalHash valueHash.
GDbCausal causalHash valueHash -&gt; Set causalHash
</span><span class="hs-identifier hs-var">SC.DbCausal.parents</span></span><span> </span><span class="annot"><span class="annottext">GDbCausal CausalHashId BranchHashId
</span><a href="#local-6989586621680538114"><span class="hs-identifier hs-var">newCausal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>  </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;causalMapping&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Map CausalHashId (New (CausalHash, CausalHashId))
  -&gt; Identity (Map CausalHashId (New (CausalHash, CausalHashId))))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; (Map CausalHashId (New (CausalHash, CausalHashId))
    -&gt; Map CausalHashId (New (CausalHash, CausalHashId)))
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; (a -&gt; b) -&gt; m ()
</span><span class="hs-operator hs-var">%=</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
-&gt; New (CausalHash, CausalHashId)
-&gt; Map CausalHashId (New (CausalHash, CausalHashId))
-&gt; Map CausalHashId (New (CausalHash, CausalHashId))
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538067"><span class="hs-identifier hs-var">oldCausalHashId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680538105"><span class="hs-identifier hs-var">newCausalHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538112"><span class="hs-identifier hs-var">newCausalHashId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Done</span></span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateBranch"><span class="hs-identifier hs-type">migrateBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sync.TrySyncResult</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span id="migrateBranch"><span class="annot"><span class="annottext">migrateBranch :: ObjectId
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateBranch"><span class="hs-identifier hs-var hs-var">migrateBranch</span></a></span></span><span> </span><span id="local-6989586621680538124"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538124"><span class="hs-identifier hs-var">oldObjectId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Either (TrySyncResult Entity) (TrySyncResult Entity)
 -&gt; TrySyncResult Entity)
-&gt; StateT
     MigrationState
     Transaction
     (Either (TrySyncResult Entity) (TrySyncResult Entity))
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall a b.
(a -&gt; b)
-&gt; StateT MigrationState Transaction a
-&gt; StateT MigrationState Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TrySyncResult Entity -&gt; TrySyncResult Entity)
-&gt; (TrySyncResult Entity -&gt; TrySyncResult Entity)
-&gt; Either (TrySyncResult Entity) (TrySyncResult Entity)
-&gt; TrySyncResult Entity
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity -&gt; TrySyncResult Entity
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity -&gt; TrySyncResult Entity
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT
   MigrationState
   Transaction
   (Either (TrySyncResult Entity) (TrySyncResult Entity))
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; (ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (TrySyncResult Entity)
    -&gt; StateT
         MigrationState
         Transaction
         (Either (TrySyncResult Entity) (TrySyncResult Entity)))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity)
  (StateT MigrationState Transaction)
  (TrySyncResult Entity)
-&gt; StateT
     MigrationState
     Transaction
     (Either (TrySyncResult Entity) (TrySyncResult Entity))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult Entity)
   (StateT MigrationState Transaction)
   (TrySyncResult Entity)
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-287"></span><span>  </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity) (StateT MigrationState Transaction) Bool
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">whenM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ObjectId
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">Map.member</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538124"><span class="hs-identifier hs-var">oldObjectId</span></a></span><span> </span><span class="annot"><span class="annottext">(Map ObjectId (ObjectId, HashId, New Hash, New Hash) -&gt; Bool)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
  MigrationState
  (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;objLookup&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">throwE</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.PreviouslyDone</span></span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span>  </span><span id="local-6989586621680538125"><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680538125"><span class="hs-identifier hs-var">oldBranch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction DbBranch
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) DbBranch
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction DbBranch
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      DbBranch)
-&gt; (Transaction DbBranch
    -&gt; StateT MigrationState Transaction DbBranch)
-&gt; Transaction DbBranch
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) DbBranch
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction DbBranch -&gt; StateT MigrationState Transaction DbBranch
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction DbBranch
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      DbBranch)
-&gt; Transaction DbBranch
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) DbBranch
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; Transaction DbBranch
</span><span class="hs-identifier hs-var">Ops.expectDbBranch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ObjectId -&gt; BranchObjectId
</span><span class="hs-identifier hs-var">BranchObjectId</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538124"><span class="hs-identifier hs-var">oldObjectId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>  </span><span id="local-6989586621680538128"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538128"><span class="hs-identifier hs-var">oldHash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction (New Hash)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (New Hash)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction (New Hash)
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (New Hash))
-&gt; (Transaction (New Hash)
    -&gt; StateT MigrationState Transaction (New Hash))
-&gt; Transaction (New Hash)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (New Hash)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction (New Hash)
-&gt; StateT MigrationState Transaction (New Hash)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (New Hash)
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (New Hash))
-&gt; Transaction (New Hash)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (New Hash)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; Transaction (New Hash)
</span><span class="hs-identifier hs-var">Q.expectPrimaryHashByObjectId</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538124"><span class="hs-identifier hs-var">oldObjectId</span></a></span><span>
</span><span id="line-291"></span><span>  </span><span id="local-6989586621680538130"><span class="annot"><span class="annottext">Branch'
  TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId)
</span><a href="#local-6989586621680538130"><span class="hs-identifier hs-var">oldBranchWithHashes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT
  MigrationState
  Transaction
  (Branch'
     TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Branch'
        TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT
   MigrationState
   Transaction
   (Branch'
      TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (Branch'
         TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId)))
-&gt; (Transaction
      (Branch'
         TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
    -&gt; StateT
         MigrationState
         Transaction
         (Branch'
            TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId)))
-&gt; Transaction
     (Branch'
        TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Branch'
        TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction
  (Branch'
     TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
-&gt; StateT
     MigrationState
     Transaction
     (Branch'
        TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction
   (Branch'
      TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (Branch'
         TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId)))
-&gt; Transaction
     (Branch'
        TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Branch'
        TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LensLike
  Transaction
  DbBranch
  (Branch'
     TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
  ObjectId
  (New Hash)
-&gt; LensLike
     Transaction
     DbBranch
     (Branch'
        TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
     ObjectId
     (New Hash)
forall (f :: * -&gt; *) s t a b.
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-identifier hs-var">traverseOf</span></span><span> </span><span class="annot"><span class="annottext">LensLike
  Transaction
  DbBranch
  (Branch'
     TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
  ObjectId
  (New Hash)
forall h' t h p c.
(Ord h', Ord t, Ord h) =&gt;
Traversal (Branch' t h p c) (Branch' t h' p c) h h'
Traversal
  DbBranch
  (Branch'
     TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
  ObjectId
  (New Hash)
</span><span class="hs-identifier hs-var">S.branchHashes_</span></span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; Transaction (New Hash)
</span><span class="hs-identifier hs-var">Q.expectPrimaryHashByObjectId</span></span><span> </span><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680538125"><span class="hs-identifier hs-var">oldBranch</span></a></span><span>
</span><span id="line-292"></span><span>  </span><span id="local-6989586621680538133"><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538133"><span class="hs-identifier hs-var">migratedRefs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MigrationState -&gt; Map SomeReferenceId SomeReferenceId)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map SomeReferenceId SomeReferenceId)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">MigrationState -&gt; Map SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AreferenceMapping%3AMigrationState"><span class="hs-identifier hs-var">referenceMapping</span></a></span><span>
</span><span id="line-293"></span><span>  </span><span id="local-6989586621680538134"><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538134"><span class="hs-identifier hs-var">migratedObjects</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MigrationState
 -&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">MigrationState
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AobjLookup%3AMigrationState"><span class="hs-identifier hs-var">objLookup</span></a></span><span>
</span><span id="line-294"></span><span>  </span><span id="local-6989586621680538135"><span class="annot"><span class="annottext">Map CausalHashId (New (CausalHash, CausalHashId))
</span><a href="#local-6989586621680538135"><span class="hs-identifier hs-var">migratedCausals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MigrationState
 -&gt; Map CausalHashId (New (CausalHash, CausalHashId)))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map CausalHashId (New (CausalHash, CausalHashId)))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">MigrationState -&gt; Map CausalHashId (New (CausalHash, CausalHashId))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AcausalMapping%3AMigrationState"><span class="hs-identifier hs-var">causalMapping</span></a></span><span>
</span><span id="line-295"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538136"><span class="hs-identifier hs-type">allMissingTypesAndTerms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-296"></span><span>      </span><span id="local-6989586621680538136"><span class="annot"><span class="annottext">allMissingTypesAndTerms :: [Entity]
</span><a href="#local-6989586621680538136"><span class="hs-identifier hs-var hs-var">allMissingTypesAndTerms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-297"></span><span>        </span><span class="annot"><span class="annottext">Branch'
  TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId)
</span><a href="#local-6989586621680538130"><span class="hs-identifier hs-var">oldBranchWithHashes</span></a></span><span>
</span><span id="line-298"></span><span>          </span><span class="annot"><span class="annottext">Branch'
  TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId)
-&gt; Getting
     (Endo [Entity])
     (Branch'
        TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
     Entity
-&gt; [Entity]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; Branch'
     TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId)
-&gt; Const
     (Endo [Entity])
     (Branch'
        TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
forall t h p c.
(Ord t, Ord h) =&gt;
Traversal' (Branch' t h p c) (SomeReference (Id' h))
Traversal'
  (Branch'
     TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
  SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#branchSomeRefs_"><span class="hs-identifier hs-var">branchSomeRefs_</span></a></span><span>
</span><span id="line-299"></span><span>            </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
 -&gt; Branch'
      TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId)
 -&gt; Const
      (Endo [Entity])
      (Branch'
         TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId)))
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; Getting
     (Endo [Entity])
     (Branch'
        TextId (New Hash) PatchObjectId (BranchObjectId, CausalHashId))
     Entity
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId
Iso' SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#uRefIdAsRefId_"><span class="hs-identifier hs-var">uRefIdAsRefId_</span></a></span><span>
</span><span id="line-300"></span><span>            </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
 -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; SomeReferenceId
-&gt; Const (Endo [Entity]) SomeReferenceId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Bool)
-&gt; (SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; SomeReferenceId
-&gt; Const (Endo [Entity]) SomeReferenceId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) a.
(Choice p, Applicative f) =&gt;
(a -&gt; Bool) -&gt; Optic' p f a a
</span><span class="hs-identifier hs-var">filtered</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeReferenceId -&gt; Map SomeReferenceId SomeReferenceId -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`Map.notMember`</span></span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538133"><span class="hs-identifier hs-var">migratedRefs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>            </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
 -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; SomeReferenceId
-&gt; Const (Endo [Entity]) SomeReferenceId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Entity)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; SomeReferenceId
-&gt; Const (Endo [Entity]) SomeReferenceId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferenceIdToEntity"><span class="hs-identifier hs-var">someReferenceIdToEntity</span></a></span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538143"><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538143"><span class="hs-identifier hs-var">allMissingPatches</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-304"></span><span>        </span><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680538125"><span class="hs-identifier hs-var">oldBranch</span></a></span><span>
</span><span id="line-305"></span><span>          </span><span class="annot"><span class="annottext">DbBranch -&gt; Getting (Endo [Entity]) DbBranch Entity -&gt; [Entity]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">(PatchObjectId -&gt; Const (Endo [Entity]) PatchObjectId)
-&gt; DbBranch -&gt; Const (Endo [Entity]) DbBranch
forall t h p c p' (f :: * -&gt; *).
Applicative f =&gt;
(p -&gt; f p') -&gt; Branch' t h p c -&gt; f (Branch' t h p' c)
</span><span class="hs-identifier hs-var">S.patches_</span></span><span>
</span><span id="line-306"></span><span>            </span><span class="annot"><span class="annottext">((PatchObjectId -&gt; Const (Endo [Entity]) PatchObjectId)
 -&gt; DbBranch -&gt; Const (Endo [Entity]) DbBranch)
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; PatchObjectId -&gt; Const (Endo [Entity]) PatchObjectId)
-&gt; Getting (Endo [Entity]) DbBranch Entity
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PatchObjectId -&gt; ObjectId)
-&gt; (ObjectId -&gt; Const (Endo [Entity]) ObjectId)
-&gt; PatchObjectId
-&gt; Const (Endo [Entity]) PatchObjectId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId -&gt; ObjectId
</span><span class="hs-identifier hs-var">unPatchObjectId</span></span><span>
</span><span id="line-307"></span><span>            </span><span class="annot"><span class="annottext">((ObjectId -&gt; Const (Endo [Entity]) ObjectId)
 -&gt; PatchObjectId -&gt; Const (Endo [Entity]) PatchObjectId)
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; ObjectId -&gt; Const (Endo [Entity]) ObjectId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; PatchObjectId
-&gt; Const (Endo [Entity]) PatchObjectId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ObjectId -&gt; Bool)
-&gt; Optic' (-&gt;) (Const (Endo [Entity])) ObjectId ObjectId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) a.
(Choice p, Applicative f) =&gt;
(a -&gt; Bool) -&gt; Optic' p f a a
</span><span class="hs-identifier hs-var">filtered</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ObjectId
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`Map.notMember`</span></span><span> </span><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538134"><span class="hs-identifier hs-var">migratedObjects</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>            </span><span class="annot"><span class="annottext">Optic' (-&gt;) (Const (Endo [Entity])) ObjectId ObjectId
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; ObjectId -&gt; Const (Endo [Entity]) ObjectId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; ObjectId
-&gt; Const (Endo [Entity]) ObjectId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ObjectId -&gt; Entity)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; ObjectId
-&gt; Const (Endo [Entity]) ObjectId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#PatchE"><span class="hs-identifier hs-var">PatchE</span></a></span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538146"><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538146"><span class="hs-identifier hs-var">allMissingChildBranches</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-311"></span><span>        </span><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680538125"><span class="hs-identifier hs-var">oldBranch</span></a></span><span>
</span><span id="line-312"></span><span>          </span><span class="annot"><span class="annottext">DbBranch -&gt; Getting (Endo [Entity]) DbBranch Entity -&gt; [Entity]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">((BranchObjectId, CausalHashId)
 -&gt; Const (Endo [Entity]) (BranchObjectId, CausalHashId))
-&gt; DbBranch -&gt; Const (Endo [Entity]) DbBranch
forall t h p c c' (f :: * -&gt; *).
Applicative f =&gt;
(c -&gt; f c') -&gt; Branch' t h p c -&gt; f (Branch' t h p c')
</span><span class="hs-identifier hs-var">S.childrenHashes_</span></span><span>
</span><span id="line-313"></span><span>            </span><span class="annot"><span class="annottext">(((BranchObjectId, CausalHashId)
  -&gt; Const (Endo [Entity]) (BranchObjectId, CausalHashId))
 -&gt; DbBranch -&gt; Const (Endo [Entity]) DbBranch)
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; (BranchObjectId, CausalHashId)
    -&gt; Const (Endo [Entity]) (BranchObjectId, CausalHashId))
-&gt; Getting (Endo [Entity]) DbBranch Entity
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(BranchObjectId -&gt; Const (Endo [Entity]) BranchObjectId)
-&gt; (BranchObjectId, CausalHashId)
-&gt; Const (Endo [Entity]) (BranchObjectId, CausalHashId)
forall s t a b. Field1 s t a b =&gt; Lens s t a b
Lens
  (BranchObjectId, CausalHashId)
  (BranchObjectId, CausalHashId)
  BranchObjectId
  BranchObjectId
</span><span class="hs-identifier hs-var">_1</span></span><span>
</span><span id="line-314"></span><span>            </span><span class="annot"><span class="annottext">((BranchObjectId -&gt; Const (Endo [Entity]) BranchObjectId)
 -&gt; (BranchObjectId, CausalHashId)
 -&gt; Const (Endo [Entity]) (BranchObjectId, CausalHashId))
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; BranchObjectId -&gt; Const (Endo [Entity]) BranchObjectId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; (BranchObjectId, CausalHashId)
-&gt; Const (Endo [Entity]) (BranchObjectId, CausalHashId)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(BranchObjectId -&gt; ObjectId)
-&gt; (ObjectId -&gt; Const (Endo [Entity]) ObjectId)
-&gt; BranchObjectId
-&gt; Const (Endo [Entity]) BranchObjectId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; ObjectId
</span><span class="hs-identifier hs-var">unBranchObjectId</span></span><span>
</span><span id="line-315"></span><span>            </span><span class="annot"><span class="annottext">((ObjectId -&gt; Const (Endo [Entity]) ObjectId)
 -&gt; BranchObjectId -&gt; Const (Endo [Entity]) BranchObjectId)
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; ObjectId -&gt; Const (Endo [Entity]) ObjectId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; BranchObjectId
-&gt; Const (Endo [Entity]) BranchObjectId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ObjectId -&gt; Bool)
-&gt; Optic' (-&gt;) (Const (Endo [Entity])) ObjectId ObjectId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) a.
(Choice p, Applicative f) =&gt;
(a -&gt; Bool) -&gt; Optic' p f a a
</span><span class="hs-identifier hs-var">filtered</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ObjectId
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`Map.notMember`</span></span><span> </span><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538134"><span class="hs-identifier hs-var">migratedObjects</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>            </span><span class="annot"><span class="annottext">Optic' (-&gt;) (Const (Endo [Entity])) ObjectId ObjectId
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; ObjectId -&gt; Const (Endo [Entity]) ObjectId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; ObjectId
-&gt; Const (Endo [Entity]) ObjectId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ObjectId -&gt; Entity)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; ObjectId
-&gt; Const (Endo [Entity]) ObjectId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#BranchE"><span class="hs-identifier hs-var">BranchE</span></a></span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538150"><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538150"><span class="hs-identifier hs-var">allMissingChildCausals</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-319"></span><span>        </span><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680538125"><span class="hs-identifier hs-var">oldBranch</span></a></span><span>
</span><span id="line-320"></span><span>          </span><span class="annot"><span class="annottext">DbBranch -&gt; Getting (Endo [Entity]) DbBranch Entity -&gt; [Entity]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">((BranchObjectId, CausalHashId)
 -&gt; Const (Endo [Entity]) (BranchObjectId, CausalHashId))
-&gt; DbBranch -&gt; Const (Endo [Entity]) DbBranch
forall t h p c c' (f :: * -&gt; *).
Applicative f =&gt;
(c -&gt; f c') -&gt; Branch' t h p c -&gt; f (Branch' t h p c')
</span><span class="hs-identifier hs-var">S.childrenHashes_</span></span><span>
</span><span id="line-321"></span><span>            </span><span class="annot"><span class="annottext">(((BranchObjectId, CausalHashId)
  -&gt; Const (Endo [Entity]) (BranchObjectId, CausalHashId))
 -&gt; DbBranch -&gt; Const (Endo [Entity]) DbBranch)
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; (BranchObjectId, CausalHashId)
    -&gt; Const (Endo [Entity]) (BranchObjectId, CausalHashId))
-&gt; Getting (Endo [Entity]) DbBranch Entity
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CausalHashId -&gt; Const (Endo [Entity]) CausalHashId)
-&gt; (BranchObjectId, CausalHashId)
-&gt; Const (Endo [Entity]) (BranchObjectId, CausalHashId)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
Lens
  (BranchObjectId, CausalHashId)
  (BranchObjectId, CausalHashId)
  CausalHashId
  CausalHashId
</span><span class="hs-identifier hs-var">_2</span></span><span>
</span><span id="line-322"></span><span>            </span><span class="annot"><span class="annottext">((CausalHashId -&gt; Const (Endo [Entity]) CausalHashId)
 -&gt; (BranchObjectId, CausalHashId)
 -&gt; Const (Endo [Entity]) (BranchObjectId, CausalHashId))
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; CausalHashId -&gt; Const (Endo [Entity]) CausalHashId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; (BranchObjectId, CausalHashId)
-&gt; Const (Endo [Entity]) (BranchObjectId, CausalHashId)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CausalHashId -&gt; Bool)
-&gt; (CausalHashId -&gt; Const (Endo [Entity]) CausalHashId)
-&gt; CausalHashId
-&gt; Const (Endo [Entity]) CausalHashId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) a.
(Choice p, Applicative f) =&gt;
(a -&gt; Bool) -&gt; Optic' p f a a
</span><span class="hs-identifier hs-var">filtered</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHashId
-&gt; Map CausalHashId (New (CausalHash, CausalHashId)) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`Map.notMember`</span></span><span> </span><span class="annot"><span class="annottext">Map CausalHashId (New (CausalHash, CausalHashId))
</span><a href="#local-6989586621680538135"><span class="hs-identifier hs-var">migratedCausals</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>            </span><span class="annot"><span class="annottext">((CausalHashId -&gt; Const (Endo [Entity]) CausalHashId)
 -&gt; CausalHashId -&gt; Const (Endo [Entity]) CausalHashId)
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; CausalHashId -&gt; Const (Endo [Entity]) CausalHashId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; CausalHashId
-&gt; Const (Endo [Entity]) CausalHashId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(CausalHashId -&gt; Entity)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; CausalHashId
-&gt; Const (Endo [Entity]) CausalHashId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#CausalE"><span class="hs-identifier hs-var">CausalE</span></a></span><span>
</span><span id="line-324"></span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-comment">-- Identify dependencies and bail out if they aren't all built</span><span>
</span><span id="line-326"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538152"><span class="hs-identifier hs-type">allMissingReferences</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-327"></span><span>      </span><span id="local-6989586621680538152"><span class="annot"><span class="annottext">allMissingReferences :: [Entity]
</span><a href="#local-6989586621680538152"><span class="hs-identifier hs-var hs-var">allMissingReferences</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-328"></span><span>        </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538136"><span class="hs-identifier hs-var">allMissingTypesAndTerms</span></a></span><span>
</span><span id="line-329"></span><span>          </span><span class="annot"><span class="annottext">[Entity] -&gt; [Entity] -&gt; [Entity]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538143"><span class="hs-identifier hs-var">allMissingPatches</span></a></span><span>
</span><span id="line-330"></span><span>          </span><span class="annot"><span class="annottext">[Entity] -&gt; [Entity] -&gt; [Entity]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538146"><span class="hs-identifier hs-var">allMissingChildBranches</span></a></span><span>
</span><span id="line-331"></span><span>          </span><span class="annot"><span class="annottext">[Entity] -&gt; [Entity] -&gt; [Entity]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538150"><span class="hs-identifier hs-var">allMissingChildCausals</span></a></span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; ([Entity] -&gt; Bool) -&gt; [Entity] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Entity] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([Entity] -&gt; Bool) -&gt; [Entity] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538152"><span class="hs-identifier hs-var">allMissingReferences</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult Entity) (StateT MigrationState Transaction) ()
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-334"></span><span>    </span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">throwE</span></span><span> </span><span class="annot"><span class="annottext">(TrySyncResult Entity
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-335"></span><span>      </span><span class="annot"><span class="annottext">[Entity] -&gt; TrySyncResult Entity
forall entity. [entity] -&gt; TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Missing</span></span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538152"><span class="hs-identifier hs-var">allMissingReferences</span></a></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538153"><span class="annot"><span class="annottext">remapPatchObjectId :: PatchObjectId -&gt; PatchObjectId
</span><a href="#local-6989586621680538153"><span class="hs-identifier hs-var hs-var">remapPatchObjectId</span></a></span></span><span> </span><span id="local-6989586621680538154"><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680538154"><span class="hs-identifier hs-var">patchObjId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ObjectId
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
-&gt; Maybe (ObjectId, HashId, New Hash, New Hash)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatchObjectId -&gt; ObjectId
</span><span class="hs-identifier hs-var">unPatchObjectId</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680538154"><span class="hs-identifier hs-var">patchObjId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538134"><span class="hs-identifier hs-var">migratedObjects</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-338"></span><span>        </span><span class="annot"><span class="annottext">Maybe (ObjectId, HashId, New Hash, New Hash)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; PatchObjectId
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; PatchObjectId) -&gt; [Char] -&gt; PatchObjectId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Expected patch: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680538154"><span class="hs-identifier hs-var">patchObjId</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; to be migrated&quot;</span></span><span>
</span><span id="line-339"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680538157"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538157"><span class="hs-identifier hs-var">newPatchObjId</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">New Hash
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">New Hash
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; PatchObjectId
</span><span class="hs-identifier hs-var">PatchObjectId</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538157"><span class="hs-identifier hs-var">newPatchObjId</span></a></span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538158"><span class="annot"><span class="annottext">remapCausalHashId :: CausalHashId -&gt; CausalHashId
</span><a href="#local-6989586621680538158"><span class="hs-identifier hs-var hs-var">remapCausalHashId</span></a></span></span><span> </span><span id="local-6989586621680538159"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538159"><span class="hs-identifier hs-var">causalHashId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CausalHashId
-&gt; Map CausalHashId (New (CausalHash, CausalHashId))
-&gt; Maybe (New (CausalHash, CausalHashId))
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538159"><span class="hs-identifier hs-var">causalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">Map CausalHashId (New (CausalHash, CausalHashId))
</span><a href="#local-6989586621680538135"><span class="hs-identifier hs-var">migratedCausals</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-341"></span><span>        </span><span class="annot"><span class="annottext">Maybe (New (CausalHash, CausalHashId))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; CausalHashId
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; CausalHashId) -&gt; [Char] -&gt; CausalHashId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Expected causal hash id: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538159"><span class="hs-identifier hs-var">causalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; to be migrated&quot;</span></span><span>
</span><span id="line-342"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538160"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538160"><span class="hs-identifier hs-var">newCausalHashId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680538160"><span class="hs-identifier hs-var">newCausalHashId</span></a></span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538161"><span class="annot"><span class="annottext">remapBranchObjectId :: BranchObjectId -&gt; BranchObjectId
</span><a href="#local-6989586621680538161"><span class="hs-identifier hs-var hs-var">remapBranchObjectId</span></a></span></span><span> </span><span id="local-6989586621680538162"><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680538162"><span class="hs-identifier hs-var">objId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ObjectId
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
-&gt; Maybe (ObjectId, HashId, New Hash, New Hash)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchObjectId -&gt; ObjectId
</span><span class="hs-identifier hs-var">unBranchObjectId</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680538162"><span class="hs-identifier hs-var">objId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538134"><span class="hs-identifier hs-var">migratedObjects</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-344"></span><span>        </span><span class="annot"><span class="annottext">Maybe (ObjectId, HashId, New Hash, New Hash)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; BranchObjectId
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; BranchObjectId) -&gt; [Char] -&gt; BranchObjectId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Expected object: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680538162"><span class="hs-identifier hs-var">objId</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; to be migrated&quot;</span></span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680538163"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538163"><span class="hs-identifier hs-var">newBranchObjId</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">New Hash
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">New Hash
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; BranchObjectId
</span><span class="hs-identifier hs-var">BranchObjectId</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538163"><span class="hs-identifier hs-var">newBranchObjId</span></a></span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538164"><span class="hs-identifier hs-type">newBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.DbBranch</span></span><span>
</span><span id="line-348"></span><span>      </span><span id="local-6989586621680538164"><span class="annot"><span class="annottext">newBranch :: DbBranch
</span><a href="#local-6989586621680538164"><span class="hs-identifier hs-var hs-var">newBranch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-349"></span><span>        </span><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680538125"><span class="hs-identifier hs-var">oldBranch</span></a></span><span>
</span><span id="line-350"></span><span>          </span><span class="annot"><span class="annottext">DbBranch -&gt; (DbBranch -&gt; DbBranch) -&gt; DbBranch
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(SomeReference (Id' ObjectId)
 -&gt; Identity (SomeReference (Id' ObjectId)))
-&gt; DbBranch -&gt; Identity DbBranch
forall t h p c.
(Ord t, Ord h) =&gt;
Traversal' (Branch' t h p c) (SomeReference (Id' h))
Traversal' DbBranch (SomeReference (Id' ObjectId))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#branchSomeRefs_"><span class="hs-identifier hs-var">branchSomeRefs_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReference (Id' ObjectId)
  -&gt; Identity (SomeReference (Id' ObjectId)))
 -&gt; DbBranch -&gt; Identity DbBranch)
-&gt; (SomeReference (Id' ObjectId) -&gt; SomeReference (Id' ObjectId))
-&gt; DbBranch
-&gt; DbBranch
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
-&gt; Map SomeReferenceId SomeReferenceId
-&gt; SomeReference (Id' ObjectId)
-&gt; SomeReference (Id' ObjectId)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#remapObjIdRefs"><span class="hs-identifier hs-var">remapObjIdRefs</span></a></span><span> </span><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538134"><span class="hs-identifier hs-var">migratedObjects</span></a></span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538133"><span class="hs-identifier hs-var">migratedRefs</span></a></span><span>
</span><span id="line-351"></span><span>          </span><span class="annot"><span class="annottext">DbBranch -&gt; (DbBranch -&gt; DbBranch) -&gt; DbBranch
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(PatchObjectId -&gt; Identity PatchObjectId)
-&gt; DbBranch -&gt; Identity DbBranch
forall t h p c p' (f :: * -&gt; *).
Applicative f =&gt;
(p -&gt; f p') -&gt; Branch' t h p c -&gt; f (Branch' t h p' c)
</span><span class="hs-identifier hs-var">S.patches_</span></span><span> </span><span class="annot"><span class="annottext">((PatchObjectId -&gt; Identity PatchObjectId)
 -&gt; DbBranch -&gt; Identity DbBranch)
-&gt; (PatchObjectId -&gt; PatchObjectId) -&gt; DbBranch -&gt; DbBranch
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId -&gt; PatchObjectId
</span><a href="#local-6989586621680538153"><span class="hs-identifier hs-var">remapPatchObjectId</span></a></span><span>
</span><span id="line-352"></span><span>          </span><span class="annot"><span class="annottext">DbBranch -&gt; (DbBranch -&gt; DbBranch) -&gt; DbBranch
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((BranchObjectId, CausalHashId)
 -&gt; Identity (BranchObjectId, CausalHashId))
-&gt; DbBranch -&gt; Identity DbBranch
forall t h p c c' (f :: * -&gt; *).
Applicative f =&gt;
(c -&gt; f c') -&gt; Branch' t h p c -&gt; f (Branch' t h p c')
</span><span class="hs-identifier hs-var">S.childrenHashes_</span></span><span> </span><span class="annot"><span class="annottext">(((BranchObjectId, CausalHashId)
  -&gt; Identity (BranchObjectId, CausalHashId))
 -&gt; DbBranch -&gt; Identity DbBranch)
-&gt; ((BranchObjectId, CausalHashId)
    -&gt; (BranchObjectId, CausalHashId))
-&gt; DbBranch
-&gt; DbBranch
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchObjectId -&gt; BranchObjectId
</span><a href="#local-6989586621680538161"><span class="hs-identifier hs-var">remapBranchObjectId</span></a></span><span> </span><span class="annot"><span class="annottext">(BranchObjectId -&gt; BranchObjectId)
-&gt; (CausalHashId -&gt; CausalHashId)
-&gt; (BranchObjectId, CausalHashId)
-&gt; (BranchObjectId, CausalHashId)
forall a b c d. (a -&gt; b) -&gt; (c -&gt; d) -&gt; (a, c) -&gt; (b, d)
</span><span class="hs-operator hs-var">***</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId -&gt; CausalHashId
</span><a href="#local-6989586621680538158"><span class="hs-identifier hs-var">remapCausalHashId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span>  </span><span id="local-6989586621680538167"><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680538167"><span class="hs-identifier hs-var">newHash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction BranchHash
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     BranchHash
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction BranchHash
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      BranchHash)
-&gt; (Transaction BranchHash
    -&gt; StateT MigrationState Transaction BranchHash)
-&gt; Transaction BranchHash
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     BranchHash
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction BranchHash
-&gt; StateT MigrationState Transaction BranchHash
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction BranchHash
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      BranchHash)
-&gt; Transaction BranchHash
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     BranchHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DbBranch -&gt; Transaction BranchHash
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.DbHelpers.html#dbBranchHash"><span class="hs-identifier hs-var">Hashing.dbBranchHash</span></a></span><span> </span><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680538164"><span class="hs-identifier hs-var">newBranch</span></a></span><span>
</span><span id="line-355"></span><span>  </span><span id="local-6989586621680538169"><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680538169"><span class="hs-identifier hs-var">newHashId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction BranchHashId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     BranchHashId
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction BranchHashId
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      BranchHashId)
-&gt; (Transaction BranchHashId
    -&gt; StateT MigrationState Transaction BranchHashId)
-&gt; Transaction BranchHashId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     BranchHashId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction BranchHashId
-&gt; StateT MigrationState Transaction BranchHashId
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction BranchHashId
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      BranchHashId)
-&gt; Transaction BranchHashId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     BranchHashId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BranchHash -&gt; Transaction BranchHashId
</span><span class="hs-identifier hs-var">Q.saveBranchHash</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680538167"><span class="hs-identifier hs-var">newHash</span></a></span><span>
</span><span id="line-356"></span><span>  </span><span id="local-6989586621680538171"><span class="annot"><span class="annottext">NamespaceStats
</span><a href="#local-6989586621680538171"><span class="hs-identifier hs-var">stats</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction NamespaceStats
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     NamespaceStats
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction NamespaceStats
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      NamespaceStats)
-&gt; (Transaction NamespaceStats
    -&gt; StateT MigrationState Transaction NamespaceStats)
-&gt; Transaction NamespaceStats
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     NamespaceStats
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction NamespaceStats
-&gt; StateT MigrationState Transaction NamespaceStats
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction NamespaceStats
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      NamespaceStats)
-&gt; Transaction NamespaceStats
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     NamespaceStats
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DbBranchV -&gt; Transaction NamespaceStats
</span><span class="hs-identifier hs-var">Ops.namespaceStatsForDbBranch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DbBranch -&gt; DbBranchV
</span><span class="hs-identifier hs-var">Ops.DbBranchV2</span></span><span> </span><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680538164"><span class="hs-identifier hs-var">newBranch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>  </span><span id="local-6989586621680538174"><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680538174"><span class="hs-identifier hs-var">newObjectId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction BranchObjectId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     BranchObjectId
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction BranchObjectId
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      BranchObjectId)
-&gt; (Transaction BranchObjectId
    -&gt; StateT MigrationState Transaction BranchObjectId)
-&gt; Transaction BranchObjectId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     BranchObjectId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction BranchObjectId
-&gt; StateT MigrationState Transaction BranchObjectId
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction BranchObjectId
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      BranchObjectId)
-&gt; Transaction BranchObjectId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     BranchObjectId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
-&gt; BranchHashId
-&gt; NamespaceStats
-&gt; DbBranchV
-&gt; Transaction BranchObjectId
</span><span class="hs-identifier hs-var">Ops.saveDbBranchUnderHashId</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680538169"><span class="hs-identifier hs-var">newHashId</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceStats
</span><a href="#local-6989586621680538171"><span class="hs-identifier hs-var">stats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DbBranch -&gt; DbBranchV
</span><span class="hs-identifier hs-var">Ops.DbBranchV2</span></span><span> </span><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680538164"><span class="hs-identifier hs-var">newBranch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>  </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;objLookup&quot;</span></span><span>
</span><span id="line-359"></span><span>    </span><span class="annot"><span class="annottext">((Map ObjectId (ObjectId, HashId, New Hash, New Hash)
  -&gt; Identity (Map ObjectId (ObjectId, HashId, New Hash, New Hash)))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; (Map ObjectId (ObjectId, HashId, New Hash, New Hash)
    -&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash))
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; (a -&gt; b) -&gt; m ()
</span><span class="hs-operator hs-var">%=</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
-&gt; (ObjectId, HashId, New Hash, New Hash)
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span>
</span><span id="line-360"></span><span>      </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538124"><span class="hs-identifier hs-var">oldObjectId</span></a></span><span>
</span><span id="line-361"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; ObjectId
</span><span class="hs-identifier hs-var">unBranchObjectId</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680538174"><span class="hs-identifier hs-var">newObjectId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-362"></span><span>        </span><span class="annot"><span class="annottext">BranchHashId -&gt; HashId
</span><span class="hs-identifier hs-var">unBranchHashId</span></span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680538169"><span class="hs-identifier hs-var">newHashId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-363"></span><span>        </span><span class="annot"><span class="annottext">BranchHash -&gt; New Hash
</span><span class="hs-identifier hs-var">unBranchHash</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680538167"><span class="hs-identifier hs-var">newHash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-364"></span><span>        </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538128"><span class="hs-identifier hs-var">oldHash</span></a></span><span>
</span><span id="line-365"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Done</span></span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migratePatch"><span class="hs-identifier hs-type">migratePatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PatchObjectId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sync.TrySyncResult</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span id="migratePatch"><span class="annot"><span class="annottext">migratePatch :: PatchObjectId
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migratePatch"><span class="hs-identifier hs-var hs-var">migratePatch</span></a></span></span><span> </span><span id="local-6989586621680538176"><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680538176"><span class="hs-identifier hs-var">oldObjectId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Either (TrySyncResult Entity) (TrySyncResult Entity)
 -&gt; TrySyncResult Entity)
-&gt; StateT
     MigrationState
     Transaction
     (Either (TrySyncResult Entity) (TrySyncResult Entity))
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall a b.
(a -&gt; b)
-&gt; StateT MigrationState Transaction a
-&gt; StateT MigrationState Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TrySyncResult Entity -&gt; TrySyncResult Entity)
-&gt; (TrySyncResult Entity -&gt; TrySyncResult Entity)
-&gt; Either (TrySyncResult Entity) (TrySyncResult Entity)
-&gt; TrySyncResult Entity
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity -&gt; TrySyncResult Entity
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity -&gt; TrySyncResult Entity
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT
   MigrationState
   Transaction
   (Either (TrySyncResult Entity) (TrySyncResult Entity))
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; (ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (TrySyncResult Entity)
    -&gt; StateT
         MigrationState
         Transaction
         (Either (TrySyncResult Entity) (TrySyncResult Entity)))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity)
  (StateT MigrationState Transaction)
  (TrySyncResult Entity)
-&gt; StateT
     MigrationState
     Transaction
     (Either (TrySyncResult Entity) (TrySyncResult Entity))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult Entity)
   (StateT MigrationState Transaction)
   (TrySyncResult Entity)
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-370"></span><span>  </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity) (StateT MigrationState Transaction) Bool
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">whenM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ObjectId
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">Map.member</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatchObjectId -&gt; ObjectId
</span><span class="hs-identifier hs-var">unPatchObjectId</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680538176"><span class="hs-identifier hs-var">oldObjectId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map ObjectId (ObjectId, HashId, New Hash, New Hash) -&gt; Bool)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
  MigrationState
  (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map ObjectId (ObjectId, HashId, New Hash, New Hash))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;objLookup&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">throwE</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.PreviouslyDone</span></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span>  </span><span id="local-6989586621680538177"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538177"><span class="hs-identifier hs-var">oldHash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction (New Hash)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (New Hash)
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction (New Hash)
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (New Hash))
-&gt; (Transaction (New Hash)
    -&gt; StateT MigrationState Transaction (New Hash))
-&gt; Transaction (New Hash)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (New Hash)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction (New Hash)
-&gt; StateT MigrationState Transaction (New Hash)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (New Hash)
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (New Hash))
-&gt; Transaction (New Hash)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (New Hash)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; Transaction (New Hash)
</span><span class="hs-identifier hs-var">Q.expectPrimaryHashByObjectId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatchObjectId -&gt; ObjectId
</span><span class="hs-identifier hs-var">unPatchObjectId</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680538176"><span class="hs-identifier hs-var">oldObjectId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-373"></span><span>  </span><span id="local-6989586621680538178"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680538178"><span class="hs-identifier hs-var">oldPatch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction Patch
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) Patch
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction Patch
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) Patch)
-&gt; (Transaction Patch -&gt; StateT MigrationState Transaction Patch)
-&gt; Transaction Patch
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) Patch
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction Patch -&gt; StateT MigrationState Transaction Patch
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction Patch
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) Patch)
-&gt; Transaction Patch
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) Patch
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId -&gt; Transaction Patch
</span><span class="hs-identifier hs-var">Ops.expectDbPatch</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680538176"><span class="hs-identifier hs-var">oldObjectId</span></a></span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span>  </span><span id="local-6989586621680538180"><span class="annot"><span class="annottext">Patch' TextId (New Hash) (New Hash)
</span><a href="#local-6989586621680538180"><span class="hs-identifier hs-var">oldPatchWithHashes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Patch'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TextId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-376"></span><span>    </span><span class="annot"><span class="annottext">StateT
  MigrationState Transaction (Patch' TextId (New Hash) (New Hash))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Patch' TextId (New Hash) (New Hash))
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT
   MigrationState Transaction (Patch' TextId (New Hash) (New Hash))
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (Patch' TextId (New Hash) (New Hash)))
-&gt; (Transaction (Patch' TextId (New Hash) (New Hash))
    -&gt; StateT
         MigrationState Transaction (Patch' TextId (New Hash) (New Hash)))
-&gt; Transaction (Patch' TextId (New Hash) (New Hash))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Patch' TextId (New Hash) (New Hash))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction (Patch' TextId (New Hash) (New Hash))
-&gt; StateT
     MigrationState Transaction (Patch' TextId (New Hash) (New Hash))
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (Patch' TextId (New Hash) (New Hash))
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (Patch' TextId (New Hash) (New Hash)))
-&gt; Transaction (Patch' TextId (New Hash) (New Hash))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Patch' TextId (New Hash) (New Hash))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-377"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680538178"><span class="hs-identifier hs-var">oldPatch</span></a></span><span> </span><span class="annot"><span class="annottext">Patch
-&gt; (Patch -&gt; Transaction (Patch' TextId (New Hash) ObjectId))
-&gt; Transaction (Patch' TextId (New Hash) ObjectId)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(HashId -&gt; Transaction (New Hash))
-&gt; Patch -&gt; Transaction (Patch' TextId (New Hash) ObjectId)
forall t h' h o.
(Ord t, Ord h') =&gt;
Traversal (Patch' t h o) (Patch' t h' o) h h'
Traversal
  Patch (Patch' TextId (New Hash) ObjectId) HashId (New Hash)
</span><span class="hs-identifier hs-var">S.patchH_</span></span><span> </span><span class="annot"><span class="annottext">((HashId -&gt; Transaction (New Hash))
 -&gt; Patch -&gt; Transaction (Patch' TextId (New Hash) ObjectId))
-&gt; (HashId -&gt; Transaction (New Hash))
-&gt; Patch
-&gt; Transaction (Patch' TextId (New Hash) ObjectId)
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">HashId -&gt; Transaction (New Hash)
</span><span class="hs-identifier hs-var">Q.expectHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>        </span><span class="annot"><span class="annottext">Transaction (Patch' TextId (New Hash) ObjectId)
-&gt; (Patch' TextId (New Hash) ObjectId
    -&gt; Transaction (Patch' TextId (New Hash) (New Hash)))
-&gt; Transaction (Patch' TextId (New Hash) (New Hash))
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ObjectId -&gt; Transaction (New Hash))
-&gt; Patch' TextId (New Hash) ObjectId
-&gt; Transaction (Patch' TextId (New Hash) (New Hash))
forall t o' h o.
(Ord t, Ord o') =&gt;
Traversal (Patch' t h o) (Patch' t h o') o o'
Traversal
  (Patch' TextId (New Hash) ObjectId)
  (Patch' TextId (New Hash) (New Hash))
  ObjectId
  (New Hash)
</span><span class="hs-identifier hs-var">S.patchO_</span></span><span> </span><span class="annot"><span class="annottext">((ObjectId -&gt; Transaction (New Hash))
 -&gt; Patch' TextId (New Hash) ObjectId
 -&gt; Transaction (Patch' TextId (New Hash) (New Hash)))
-&gt; (ObjectId -&gt; Transaction (New Hash))
-&gt; Patch' TextId (New Hash) ObjectId
-&gt; Transaction (Patch' TextId (New Hash) (New Hash))
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; Transaction (New Hash)
</span><span class="hs-identifier hs-var">Q.expectPrimaryHashByObjectId</span></span><span class="hs-special">)</span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span>  </span><span id="local-6989586621680538185"><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538185"><span class="hs-identifier hs-var">migratedRefs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MigrationState -&gt; Map SomeReferenceId SomeReferenceId)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map SomeReferenceId SomeReferenceId)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">MigrationState -&gt; Map SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AreferenceMapping%3AMigrationState"><span class="hs-identifier hs-var">referenceMapping</span></a></span><span>
</span><span id="line-381"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538186"><span class="annot"><span class="annottext">isUnmigratedRef :: SomeReferenceId -&gt; Bool
</span><a href="#local-6989586621680538186"><span class="hs-identifier hs-var hs-var">isUnmigratedRef</span></a></span></span><span> </span><span id="local-6989586621680538187"><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538187"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; Map SomeReferenceId SomeReferenceId -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">Map.notMember</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538187"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538185"><span class="hs-identifier hs-var">migratedRefs</span></a></span><span>
</span><span id="line-382"></span><span>  </span><span class="hs-comment">-- 2. Determine whether all things the patch refers to are built.</span><span>
</span><span id="line-383"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538188"><span class="hs-identifier hs-type">unmigratedDependencies</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-384"></span><span>      </span><span id="local-6989586621680538188"><span class="annot"><span class="annottext">unmigratedDependencies :: [Entity]
</span><a href="#local-6989586621680538188"><span class="hs-identifier hs-var hs-var">unmigratedDependencies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-385"></span><span>        </span><span class="annot"><span class="annottext">Patch' TextId (New Hash) (New Hash)
</span><a href="#local-6989586621680538180"><span class="hs-identifier hs-var">oldPatchWithHashes</span></a></span><span> </span><span class="annot"><span class="annottext">Patch' TextId (New Hash) (New Hash)
-&gt; Getting
     (Endo [Entity]) (Patch' TextId (New Hash) (New Hash)) Entity
-&gt; [Entity]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; Patch' TextId (New Hash) (New Hash)
-&gt; Const (Endo [Entity]) (Patch' TextId (New Hash) (New Hash))
forall t h o.
(Ord t, Ord h) =&gt;
Traversal
  (Patch' t h o)
  (Patch' t h o)
  (SomeReference (Id' h))
  (SomeReference (Id' h))
Traversal
  (Patch' TextId (New Hash) (New Hash))
  (Patch' TextId (New Hash) (New Hash))
  SomeReferenceId
  SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patchSomeRefsH_"><span class="hs-identifier hs-var">patchSomeRefsH_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
 -&gt; Patch' TextId (New Hash) (New Hash)
 -&gt; Const (Endo [Entity]) (Patch' TextId (New Hash) (New Hash)))
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; Getting
     (Endo [Entity]) (Patch' TextId (New Hash) (New Hash)) Entity
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId
Iso' SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#uRefIdAsRefId_"><span class="hs-identifier hs-var">uRefIdAsRefId_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
 -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; SomeReferenceId
-&gt; Const (Endo [Entity]) SomeReferenceId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Bool)
-&gt; (SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; SomeReferenceId
-&gt; Const (Endo [Entity]) SomeReferenceId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) a.
(Choice p, Applicative f) =&gt;
(a -&gt; Bool) -&gt; Optic' p f a a
</span><span class="hs-identifier hs-var">filtered</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; Bool
</span><a href="#local-6989586621680538186"><span class="hs-identifier hs-var">isUnmigratedRef</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
 -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; SomeReferenceId
-&gt; Const (Endo [Entity]) SomeReferenceId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Entity)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; SomeReferenceId
-&gt; Const (Endo [Entity]) SomeReferenceId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferenceIdToEntity"><span class="hs-identifier hs-var">someReferenceIdToEntity</span></a></span><span>
</span><span id="line-386"></span><span>          </span><span class="annot"><span class="annottext">[Entity] -&gt; [Entity] -&gt; [Entity]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Patch' TextId (New Hash) (New Hash)
</span><a href="#local-6989586621680538180"><span class="hs-identifier hs-var">oldPatchWithHashes</span></a></span><span> </span><span class="annot"><span class="annottext">Patch' TextId (New Hash) (New Hash)
-&gt; Getting
     (Endo [Entity]) (Patch' TextId (New Hash) (New Hash)) Entity
-&gt; [Entity]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; Patch' TextId (New Hash) (New Hash)
-&gt; Const (Endo [Entity]) (Patch' TextId (New Hash) (New Hash))
forall t h o.
(Ord t, Ord h, Ord o) =&gt;
Traversal' (Patch' t h o) (SomeReference (Id' o))
Traversal
  (Patch' TextId (New Hash) (New Hash))
  (Patch' TextId (New Hash) (New Hash))
  SomeReferenceId
  SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patchSomeRefsO_"><span class="hs-identifier hs-var">patchSomeRefsO_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
 -&gt; Patch' TextId (New Hash) (New Hash)
 -&gt; Const (Endo [Entity]) (Patch' TextId (New Hash) (New Hash)))
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; Getting
     (Endo [Entity]) (Patch' TextId (New Hash) (New Hash)) Entity
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId
Iso' SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#uRefIdAsRefId_"><span class="hs-identifier hs-var">uRefIdAsRefId_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
 -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; SomeReferenceId
-&gt; Const (Endo [Entity]) SomeReferenceId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Bool)
-&gt; (SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; SomeReferenceId
-&gt; Const (Endo [Entity]) SomeReferenceId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) a.
(Choice p, Applicative f) =&gt;
(a -&gt; Bool) -&gt; Optic' p f a a
</span><span class="hs-identifier hs-var">filtered</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; Bool
</span><a href="#local-6989586621680538186"><span class="hs-identifier hs-var">isUnmigratedRef</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
 -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; ((Entity -&gt; Const (Endo [Entity]) Entity)
    -&gt; SomeReferenceId -&gt; Const (Endo [Entity]) SomeReferenceId)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; SomeReferenceId
-&gt; Const (Endo [Entity]) SomeReferenceId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Entity)
-&gt; (Entity -&gt; Const (Endo [Entity]) Entity)
-&gt; SomeReferenceId
-&gt; Const (Endo [Entity]) SomeReferenceId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferenceIdToEntity"><span class="hs-identifier hs-var">someReferenceIdToEntity</span></a></span><span>
</span><span id="line-387"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; ([Entity] -&gt; Bool) -&gt; [Entity] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Entity] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([Entity] -&gt; Bool) -&gt; [Entity] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538188"><span class="hs-identifier hs-var">unmigratedDependencies</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">throwE</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Entity] -&gt; TrySyncResult Entity
forall entity. [entity] -&gt; TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Missing</span></span><span> </span><span class="annot"><span class="annottext">[Entity]
</span><a href="#local-6989586621680538188"><span class="hs-identifier hs-var">unmigratedDependencies</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538191"><span class="hs-identifier hs-type">hashToHashId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashId</span></span><span>
</span><span id="line-390"></span><span>      </span><span id="local-6989586621680538191"><span class="annot"><span class="annottext">hashToHashId :: New Hash -&gt; Transaction HashId
</span><a href="#local-6989586621680538191"><span class="hs-identifier hs-var hs-var">hashToHashId</span></a></span></span><span> </span><span id="local-6989586621680538192"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538192"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-391"></span><span>        </span><span class="annot"><span class="annottext">HashId -&gt; Maybe HashId -&gt; HashId
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; HashId
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; HashId) -&gt; [Char] -&gt; HashId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;expected hashId for hash: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538192"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe HashId -&gt; HashId)
-&gt; Transaction (Maybe HashId) -&gt; Transaction HashId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Transaction (Maybe HashId)
</span><span class="hs-identifier hs-var">Q.loadHashIdByHash</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538192"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538195"><span class="hs-identifier hs-type">hashToObjectId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span>
</span><span id="line-393"></span><span>      </span><span id="local-6989586621680538195"><span class="annot"><span class="annottext">hashToObjectId :: New Hash -&gt; Transaction ObjectId
</span><a href="#local-6989586621680538195"><span class="hs-identifier hs-var hs-var">hashToObjectId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Transaction HashId
</span><a href="#local-6989586621680538191"><span class="hs-identifier hs-var">hashToHashId</span></a></span><span> </span><span class="annot"><span class="annottext">(New Hash -&gt; Transaction HashId)
-&gt; (HashId -&gt; Transaction ObjectId)
-&gt; New Hash
-&gt; Transaction ObjectId
forall (m :: * -&gt; *) a b c.
Monad m =&gt;
(a -&gt; m b) -&gt; (b -&gt; m c) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&gt;=&gt;</span></span><span> </span><span class="annot"><span class="annottext">HashId -&gt; Transaction ObjectId
</span><span class="hs-identifier hs-var">Q.expectObjectIdForPrimaryHashId</span></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span>  </span><span id="local-6989586621680538198"><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538198"><span class="hs-identifier hs-var">migratedReferences</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MigrationState -&gt; Map SomeReferenceId SomeReferenceId)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map SomeReferenceId SomeReferenceId)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">MigrationState -&gt; Map SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AreferenceMapping%3AMigrationState"><span class="hs-identifier hs-var">referenceMapping</span></a></span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538199"><span class="hs-identifier hs-type">remapRef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span>
</span><span id="line-397"></span><span>      </span><span id="local-6989586621680538199"><span class="annot"><span class="annottext">remapRef :: SomeReferenceId -&gt; SomeReferenceId
</span><a href="#local-6989586621680538199"><span class="hs-identifier hs-var hs-var">remapRef</span></a></span></span><span> </span><span id="local-6989586621680538200"><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538200"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
-&gt; SomeReferenceId
-&gt; Map SomeReferenceId SomeReferenceId
-&gt; SomeReferenceId
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">Map.findWithDefault</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538200"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538200"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538198"><span class="hs-identifier hs-var">migratedReferences</span></a></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538202"><span class="annot"><span class="annottext">newPatch :: Patch' TextId (New Hash) (New Hash)
</span><a href="#local-6989586621680538202"><span class="hs-identifier hs-var hs-var">newPatch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-400"></span><span>        </span><span class="annot"><span class="annottext">Patch' TextId (New Hash) (New Hash)
</span><a href="#local-6989586621680538180"><span class="hs-identifier hs-var">oldPatchWithHashes</span></a></span><span>
</span><span id="line-401"></span><span>          </span><span class="annot"><span class="annottext">Patch' TextId (New Hash) (New Hash)
-&gt; (Patch' TextId (New Hash) (New Hash)
    -&gt; Patch' TextId (New Hash) (New Hash))
-&gt; Patch' TextId (New Hash) (New Hash)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Identity SomeReferenceId)
-&gt; Patch' TextId (New Hash) (New Hash)
-&gt; Identity (Patch' TextId (New Hash) (New Hash))
forall t h o.
(Ord t, Ord h) =&gt;
Traversal
  (Patch' t h o)
  (Patch' t h o)
  (SomeReference (Id' h))
  (SomeReference (Id' h))
Traversal
  (Patch' TextId (New Hash) (New Hash))
  (Patch' TextId (New Hash) (New Hash))
  SomeReferenceId
  SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patchSomeRefsH_"><span class="hs-identifier hs-var">patchSomeRefsH_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Identity SomeReferenceId)
 -&gt; Patch' TextId (New Hash) (New Hash)
 -&gt; Identity (Patch' TextId (New Hash) (New Hash)))
-&gt; ((SomeReferenceId -&gt; Identity SomeReferenceId)
    -&gt; SomeReferenceId -&gt; Identity SomeReferenceId)
-&gt; (SomeReferenceId -&gt; Identity SomeReferenceId)
-&gt; Patch' TextId (New Hash) (New Hash)
-&gt; Identity (Patch' TextId (New Hash) (New Hash))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Identity SomeReferenceId)
-&gt; SomeReferenceId -&gt; Identity SomeReferenceId
Iso' SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#uRefIdAsRefId_"><span class="hs-identifier hs-var">uRefIdAsRefId_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Identity SomeReferenceId)
 -&gt; Patch' TextId (New Hash) (New Hash)
 -&gt; Identity (Patch' TextId (New Hash) (New Hash)))
-&gt; (SomeReferenceId -&gt; SomeReferenceId)
-&gt; Patch' TextId (New Hash) (New Hash)
-&gt; Patch' TextId (New Hash) (New Hash)
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; SomeReferenceId
</span><a href="#local-6989586621680538199"><span class="hs-identifier hs-var">remapRef</span></a></span><span>
</span><span id="line-402"></span><span>          </span><span class="annot"><span class="annottext">Patch' TextId (New Hash) (New Hash)
-&gt; (Patch' TextId (New Hash) (New Hash)
    -&gt; Patch' TextId (New Hash) (New Hash))
-&gt; Patch' TextId (New Hash) (New Hash)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Identity SomeReferenceId)
-&gt; Patch' TextId (New Hash) (New Hash)
-&gt; Identity (Patch' TextId (New Hash) (New Hash))
forall t h o.
(Ord t, Ord h, Ord o) =&gt;
Traversal' (Patch' t h o) (SomeReference (Id' o))
Traversal
  (Patch' TextId (New Hash) (New Hash))
  (Patch' TextId (New Hash) (New Hash))
  SomeReferenceId
  SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patchSomeRefsO_"><span class="hs-identifier hs-var">patchSomeRefsO_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Identity SomeReferenceId)
 -&gt; Patch' TextId (New Hash) (New Hash)
 -&gt; Identity (Patch' TextId (New Hash) (New Hash)))
-&gt; ((SomeReferenceId -&gt; Identity SomeReferenceId)
    -&gt; SomeReferenceId -&gt; Identity SomeReferenceId)
-&gt; (SomeReferenceId -&gt; Identity SomeReferenceId)
-&gt; Patch' TextId (New Hash) (New Hash)
-&gt; Identity (Patch' TextId (New Hash) (New Hash))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Identity SomeReferenceId)
-&gt; SomeReferenceId -&gt; Identity SomeReferenceId
Iso' SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#uRefIdAsRefId_"><span class="hs-identifier hs-var">uRefIdAsRefId_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Identity SomeReferenceId)
 -&gt; Patch' TextId (New Hash) (New Hash)
 -&gt; Identity (Patch' TextId (New Hash) (New Hash)))
-&gt; (SomeReferenceId -&gt; SomeReferenceId)
-&gt; Patch' TextId (New Hash) (New Hash)
-&gt; Patch' TextId (New Hash) (New Hash)
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; SomeReferenceId
</span><a href="#local-6989586621680538199"><span class="hs-identifier hs-var">remapRef</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span>  </span><span id="local-6989586621680538203"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680538203"><span class="hs-identifier hs-var">newPatchWithIds</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Patch</span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-405"></span><span>    </span><span class="annot"><span class="annottext">StateT MigrationState Transaction Patch
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) Patch
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction Patch
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) Patch)
-&gt; (Transaction Patch -&gt; StateT MigrationState Transaction Patch)
-&gt; Transaction Patch
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) Patch
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction Patch -&gt; StateT MigrationState Transaction Patch
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction Patch
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) Patch)
-&gt; Transaction Patch
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) Patch
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-406"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Patch' TextId (New Hash) (New Hash)
</span><a href="#local-6989586621680538202"><span class="hs-identifier hs-var">newPatch</span></a></span><span> </span><span class="annot"><span class="annottext">Patch' TextId (New Hash) (New Hash)
-&gt; (Patch' TextId (New Hash) (New Hash)
    -&gt; Transaction (Patch' TextId HashId (New Hash)))
-&gt; Transaction (Patch' TextId HashId (New Hash))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(New Hash -&gt; Transaction HashId)
-&gt; Patch' TextId (New Hash) (New Hash)
-&gt; Transaction (Patch' TextId HashId (New Hash))
forall t h' h o.
(Ord t, Ord h') =&gt;
Traversal (Patch' t h o) (Patch' t h' o) h h'
Traversal
  (Patch' TextId (New Hash) (New Hash))
  (Patch' TextId HashId (New Hash))
  (New Hash)
  HashId
</span><span class="hs-identifier hs-var">S.patchH_</span></span><span> </span><span class="annot"><span class="annottext">((New Hash -&gt; Transaction HashId)
 -&gt; Patch' TextId (New Hash) (New Hash)
 -&gt; Transaction (Patch' TextId HashId (New Hash)))
-&gt; (New Hash -&gt; Transaction HashId)
-&gt; Patch' TextId (New Hash) (New Hash)
-&gt; Transaction (Patch' TextId HashId (New Hash))
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Transaction HashId
</span><a href="#local-6989586621680538191"><span class="hs-identifier hs-var">hashToHashId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>        </span><span class="annot"><span class="annottext">Transaction (Patch' TextId HashId (New Hash))
-&gt; (Patch' TextId HashId (New Hash) -&gt; Transaction Patch)
-&gt; Transaction Patch
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(New Hash -&gt; Transaction ObjectId)
-&gt; Patch' TextId HashId (New Hash) -&gt; Transaction Patch
forall t o' h o.
(Ord t, Ord o') =&gt;
Traversal (Patch' t h o) (Patch' t h o') o o'
Traversal
  (Patch' TextId HashId (New Hash)) Patch (New Hash) ObjectId
</span><span class="hs-identifier hs-var">S.patchO_</span></span><span> </span><span class="annot"><span class="annottext">((New Hash -&gt; Transaction ObjectId)
 -&gt; Patch' TextId HashId (New Hash) -&gt; Transaction Patch)
-&gt; (New Hash -&gt; Transaction ObjectId)
-&gt; Patch' TextId HashId (New Hash)
-&gt; Transaction Patch
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Transaction ObjectId
</span><a href="#local-6989586621680538195"><span class="hs-identifier hs-var">hashToObjectId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680538204"><span class="annot"><span class="annottext">PatchLocalIds
</span><a href="#local-6989586621680538204"><span class="hs-identifier hs-var">localPatchIds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538205"><span class="annot"><span class="annottext">LocalPatch
</span><a href="#local-6989586621680538205"><span class="hs-identifier hs-var">localPatch</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Patch -&gt; (PatchLocalIds, LocalPatch)
</span><span class="hs-identifier hs-var">S.LocalizeObject.localizePatch</span></span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680538203"><span class="hs-identifier hs-var">newPatchWithIds</span></a></span><span>
</span><span id="line-410"></span><span>  </span><span id="local-6989586621680538207"><span class="annot"><span class="annottext">PatchHash
</span><a href="#local-6989586621680538207"><span class="hs-identifier hs-var">newHash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction PatchHash
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     PatchHash
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction PatchHash
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      PatchHash)
-&gt; (Transaction PatchHash
    -&gt; StateT MigrationState Transaction PatchHash)
-&gt; Transaction PatchHash
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     PatchHash
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction PatchHash
-&gt; StateT MigrationState Transaction PatchHash
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction PatchHash
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      PatchHash)
-&gt; Transaction PatchHash
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     PatchHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Patch -&gt; Transaction PatchHash
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.DbHelpers.html#dbPatchHash"><span class="hs-identifier hs-var">Hashing.dbPatchHash</span></a></span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680538203"><span class="hs-identifier hs-var">newPatchWithIds</span></a></span><span>
</span><span id="line-411"></span><span>  </span><span id="local-6989586621680538209"><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680538209"><span class="hs-identifier hs-var">newObjectId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-412"></span><span>    </span><span class="annot"><span class="annottext">StateT MigrationState Transaction PatchObjectId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     PatchObjectId
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction PatchObjectId
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      PatchObjectId)
-&gt; (Transaction PatchObjectId
    -&gt; StateT MigrationState Transaction PatchObjectId)
-&gt; Transaction PatchObjectId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     PatchObjectId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction PatchObjectId
-&gt; StateT MigrationState Transaction PatchObjectId
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction PatchObjectId
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      PatchObjectId)
-&gt; Transaction PatchObjectId
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     PatchObjectId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-413"></span><span>      </span><span class="annot"><span class="annottext">HashHandle -&gt; PatchHash -&gt; PatchFormat -&gt; Transaction PatchObjectId
</span><span class="hs-identifier hs-var">Ops.saveDbPatch</span></span><span>
</span><span id="line-414"></span><span>        </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span>
</span><span id="line-415"></span><span>        </span><span class="annot"><span class="annottext">PatchHash
</span><a href="#local-6989586621680538207"><span class="hs-identifier hs-var">newHash</span></a></span><span>
</span><span id="line-416"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatchLocalIds -&gt; LocalPatch -&gt; PatchFormat
</span><span class="hs-identifier hs-var">S.Patch.Format.Full</span></span><span> </span><span class="annot"><span class="annottext">PatchLocalIds
</span><a href="#local-6989586621680538204"><span class="hs-identifier hs-var">localPatchIds</span></a></span><span> </span><span class="annot"><span class="annottext">LocalPatch
</span><a href="#local-6989586621680538205"><span class="hs-identifier hs-var">localPatch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>  </span><span id="local-6989586621680538212"><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680538212"><span class="hs-identifier hs-var">newHashId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction HashId
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) HashId
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction HashId
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) HashId)
-&gt; (Transaction HashId -&gt; StateT MigrationState Transaction HashId)
-&gt; Transaction HashId
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) HashId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction HashId -&gt; StateT MigrationState Transaction HashId
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction HashId
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) HashId)
-&gt; Transaction HashId
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) HashId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Transaction HashId
</span><span class="hs-identifier hs-var">Q.expectHashIdByHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatchHash -&gt; New Hash
</span><span class="hs-identifier hs-var">unPatchHash</span></span><span> </span><span class="annot"><span class="annottext">PatchHash
</span><a href="#local-6989586621680538207"><span class="hs-identifier hs-var">newHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>  </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;objLookup&quot;</span></span><span>
</span><span id="line-419"></span><span>    </span><span class="annot"><span class="annottext">((Map ObjectId (ObjectId, HashId, New Hash, New Hash)
  -&gt; Identity (Map ObjectId (ObjectId, HashId, New Hash, New Hash)))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; (Map ObjectId (ObjectId, HashId, New Hash, New Hash)
    -&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash))
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; (a -&gt; b) -&gt; m ()
</span><span class="hs-operator hs-var">%=</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
-&gt; (ObjectId, HashId, New Hash, New Hash)
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span>
</span><span id="line-420"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatchObjectId -&gt; ObjectId
</span><span class="hs-identifier hs-var">unPatchObjectId</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680538176"><span class="hs-identifier hs-var">oldObjectId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-421"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">PatchObjectId -&gt; ObjectId
</span><span class="hs-identifier hs-var">unPatchObjectId</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680538209"><span class="hs-identifier hs-var">newObjectId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-422"></span><span>        </span><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680538212"><span class="hs-identifier hs-var">newHashId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-423"></span><span>        </span><span class="annot"><span class="annottext">PatchHash -&gt; New Hash
</span><span class="hs-identifier hs-var">unPatchHash</span></span><span> </span><span class="annot"><span class="annottext">PatchHash
</span><a href="#local-6989586621680538207"><span class="hs-identifier hs-var">newHash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-424"></span><span>        </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538177"><span class="hs-identifier hs-var">oldHash</span></a></span><span>
</span><span id="line-425"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Done</span></span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span class="hs-comment">-- | PLAN</span><span>
</span><span id="line-429"></span><span class="hs-comment">-- *</span><span>
</span><span id="line-430"></span><span class="hs-comment">-- NOTE: this implementation assumes that watches will be migrated AFTER everything else is finished.</span><span>
</span><span id="line-431"></span><span class="hs-comment">-- This is because it's difficult for us to know otherwise whether a reference refers to something which doesn't exist, or just</span><span>
</span><span id="line-432"></span><span class="hs-comment">-- something that hasn't been migrated yet. If we do it last, we know that missing references are indeed just missing from the codebase.</span><span>
</span><span id="line-433"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateWatch"><span class="hs-identifier hs-type">migrateWatch</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-434"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span></span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-436"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">WatchKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-437"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-438"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sync.TrySyncResult</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span id="migrateWatch"><span class="annot"><span class="annottext">migrateWatch :: (Reference -&gt; Transaction ConstructorType)
-&gt; WatchKind
-&gt; Old Id
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateWatch"><span class="hs-identifier hs-var hs-var">migrateWatch</span></a></span></span><span> </span><span id="local-6989586621680538215"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680538215"><span class="hs-identifier hs-var">getDeclType</span></a></span></span><span> </span><span id="local-6989586621680538216"><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680538216"><span class="hs-identifier hs-var">watchKind</span></a></span></span><span> </span><span id="local-6989586621680538217"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538217"><span class="hs-identifier hs-var">oldWatchId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Either (TrySyncResult Entity) (TrySyncResult Entity)
 -&gt; TrySyncResult Entity)
-&gt; StateT
     MigrationState
     Transaction
     (Either (TrySyncResult Entity) (TrySyncResult Entity))
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall a b.
(a -&gt; b)
-&gt; StateT MigrationState Transaction a
-&gt; StateT MigrationState Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TrySyncResult Entity -&gt; TrySyncResult Entity)
-&gt; (TrySyncResult Entity -&gt; TrySyncResult Entity)
-&gt; Either (TrySyncResult Entity) (TrySyncResult Entity)
-&gt; TrySyncResult Entity
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity -&gt; TrySyncResult Entity
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity -&gt; TrySyncResult Entity
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT
   MigrationState
   Transaction
   (Either (TrySyncResult Entity) (TrySyncResult Entity))
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; (ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (TrySyncResult Entity)
    -&gt; StateT
         MigrationState
         Transaction
         (Either (TrySyncResult Entity) (TrySyncResult Entity)))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity)
  (StateT MigrationState Transaction)
  (TrySyncResult Entity)
-&gt; StateT
     MigrationState
     Transaction
     (Either (TrySyncResult Entity) (TrySyncResult Entity))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult Entity)
   (StateT MigrationState Transaction)
   (TrySyncResult Entity)
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-440"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538218"><span class="annot"><span class="annottext">watchKindV1 :: [Char]
</span><a href="#local-6989586621680538218"><span class="hs-identifier hs-var hs-var">watchKindV1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WatchKind -&gt; [Char]
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#watchKind2to1"><span class="hs-identifier hs-var">Cv.watchKind2to1</span></a></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680538216"><span class="hs-identifier hs-var">watchKind</span></a></span><span>
</span><span id="line-441"></span><span>  </span><span id="local-6989586621680538219"><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538219"><span class="hs-identifier hs-var">watchResultTerm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-442"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateT
  MigrationState Transaction (Maybe (Term (DeclName Symbol) Ann))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Maybe (Term (DeclName Symbol) Ann))
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT
   MigrationState Transaction (Maybe (Term (DeclName Symbol) Ann))
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (Maybe (Term (DeclName Symbol) Ann)))
-&gt; (Transaction (Maybe (Term (DeclName Symbol) Ann))
    -&gt; StateT
         MigrationState Transaction (Maybe (Term (DeclName Symbol) Ann)))
-&gt; Transaction (Maybe (Term (DeclName Symbol) Ann))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Maybe (Term (DeclName Symbol) Ann))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe (Term (DeclName Symbol) Ann))
-&gt; StateT
     MigrationState Transaction (Maybe (Term (DeclName Symbol) Ann))
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Reference -&gt; Transaction ConstructorType)
-&gt; [Char]
-&gt; Old Id
-&gt; Transaction (Maybe (Term (DeclName Symbol) Ann))
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getWatch"><span class="hs-identifier hs-var">CodebaseOps.getWatch</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680538215"><span class="hs-identifier hs-var">getDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680538218"><span class="hs-identifier hs-var">watchKindV1</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538217"><span class="hs-identifier hs-var">oldWatchId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity)
  (StateT MigrationState Transaction)
  (Maybe (Term (DeclName Symbol) Ann))
-&gt; (Maybe (Term (DeclName Symbol) Ann)
    -&gt; ExceptT
         (TrySyncResult Entity)
         (StateT MigrationState Transaction)
         (Term (DeclName Symbol) Ann))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Term (DeclName Symbol) Ann)
forall a b.
ExceptT
  (TrySyncResult Entity) (StateT MigrationState Transaction) a
-&gt; (a
    -&gt; ExceptT
         (TrySyncResult Entity) (StateT MigrationState Transaction) b)
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-443"></span><span>      </span><span class="hs-comment">-- The hash which we're watching doesn't exist in the codebase, throw out this watch.</span><span>
</span><span id="line-444"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Term (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Term (DeclName Symbol) Ann)
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">throwE</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Done</span></span><span>
</span><span id="line-445"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680538221"><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538221"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Term (DeclName Symbol) Ann)
forall a.
a
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538221"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-446"></span><span>  </span><span id="local-6989586621680538222"><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538222"><span class="hs-identifier hs-var">migratedReferences</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MigrationState -&gt; Map SomeReferenceId SomeReferenceId)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map SomeReferenceId SomeReferenceId)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">MigrationState -&gt; Map SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AreferenceMapping%3AMigrationState"><span class="hs-identifier hs-var">referenceMapping</span></a></span><span>
</span><span id="line-447"></span><span>  </span><span id="local-6989586621680538223"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538223"><span class="hs-identifier hs-var">newWatchId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
-&gt; Map SomeReferenceId SomeReferenceId -&gt; Maybe SomeReferenceId
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; SomeReferenceId
forall ref. ref -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermReference"><span class="hs-identifier hs-var">TermReference</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538217"><span class="hs-identifier hs-var">oldWatchId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538222"><span class="hs-identifier hs-var">migratedReferences</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-448"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermReference"><span class="hs-identifier hs-type">TermReference</span></a></span><span> </span><span id="local-6989586621680538225"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538225"><span class="hs-identifier hs-var">newRef</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Old Id
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) (Old Id)
forall a.
a
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538225"><span class="hs-identifier hs-var">newRef</span></a></span><span>
</span><span id="line-449"></span><span>    </span><span class="annot"><span class="annottext">Maybe SomeReferenceId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) (Old Id)
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">throwE</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.NonFatalError</span></span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538227"><span class="hs-identifier hs-type">maybeRemappedTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term.Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span>      </span><span id="local-6989586621680538227"><span class="annot"><span class="annottext">maybeRemappedTerm :: Maybe (Term (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538227"><span class="hs-identifier hs-var hs-var">maybeRemappedTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-452"></span><span>        </span><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538219"><span class="hs-identifier hs-var">watchResultTerm</span></a></span><span>
</span><span id="line-453"></span><span>          </span><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
-&gt; (Term (DeclName Symbol) Ann
    -&gt; Maybe (Term (DeclName Symbol) Ann))
-&gt; Maybe (Term (DeclName Symbol) Ann)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' Maybe (Term (DeclName Symbol) Ann) SomeReferenceId
forall (m :: * -&gt; *) v a.
(Monad m, Ord v) =&gt;
LensLike' m (Term v a) SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#termReferences_"><span class="hs-identifier hs-var">termReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">LensLike' Maybe (Term (DeclName Symbol) Ann) SomeReferenceId
-&gt; LensLike' Maybe (Term (DeclName Symbol) Ann) SomeReferenceId
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680538229"><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538229"><span class="hs-identifier hs-var">someRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
-&gt; Map SomeReferenceId SomeReferenceId -&gt; Maybe SomeReferenceId
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538229"><span class="hs-identifier hs-var">someRef</span></a></span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538222"><span class="hs-identifier hs-var">migratedReferences</span></a></span><span>
</span><span id="line-454"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Term (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538227"><span class="hs-identifier hs-var">maybeRemappedTerm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-455"></span><span>    </span><span class="hs-comment">-- One or more references in the result didn't exist in our codebase.</span><span>
</span><span id="line-456"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Term (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
forall a.
a
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.NonFatalError</span></span><span>
</span><span id="line-457"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680538230"><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538230"><span class="hs-identifier hs-var">remappedTerm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-458"></span><span>      </span><span class="annot"><span class="annottext">StateT MigrationState Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction ()
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; (Transaction () -&gt; StateT MigrationState Transaction ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction () -&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Old Id -&gt; Term (DeclName Symbol) Ann -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putWatch"><span class="hs-identifier hs-var">CodebaseOps.putWatch</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621680538218"><span class="hs-identifier hs-var">watchKindV1</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538223"><span class="hs-identifier hs-var">newWatchId</span></a></span><span> </span><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538230"><span class="hs-identifier hs-var">remappedTerm</span></a></span><span>
</span><span id="line-459"></span><span>      </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Done</span></span><span>
</span><span id="line-460"></span><span>
</span><span id="line-461"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#uRefIdAsRefId_"><span class="hs-identifier hs-type">uRefIdAsRefId_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Iso'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span>
</span><span id="line-462"></span><span id="uRefIdAsRefId_"><span class="annot"><span class="annottext">uRefIdAsRefId_ :: Iso' SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#uRefIdAsRefId_"><span class="hs-identifier hs-var hs-var">uRefIdAsRefId_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnIso (Old Id) (Old Id) (Old Id) (Old Id)
-&gt; Iso' SomeReferenceId SomeReferenceId
forall (f :: * -&gt; *) (g :: * -&gt; *) s t a b.
(Functor f, Functor g) =&gt;
AnIso s t a b -&gt; Iso (f s) (g t) (f a) (g b)
</span><span class="hs-identifier hs-var">mapping</span></span><span> </span><span class="annot"><span class="annottext">AnIso (Old Id) (Old Id) (Old Id) (Old Id)
Iso' (Old Id) (Old Id)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#uRefAsRef_"><span class="hs-identifier hs-var">uRefAsRef_</span></a></span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#uRefAsRef_"><span class="hs-identifier hs-type">uRefAsRef_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Iso'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span>
</span><span id="line-465"></span><span id="uRefAsRef_"><span class="annot"><span class="annottext">uRefAsRef_ :: Iso' (Old Id) (Old Id)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#uRefAsRef_"><span class="hs-identifier hs-var hs-var">uRefAsRef_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Old Id -&gt; Old Id) -&gt; (Old Id -&gt; Old Id) -&gt; Iso' (Old Id) (Old Id)
forall s a b t. (s -&gt; a) -&gt; (b -&gt; t) -&gt; Iso s t a b
</span><span class="hs-identifier hs-var">iso</span></span><span> </span><span class="annot"><span class="annottext">Old Id -&gt; Old Id
forall {h}. Id' h -&gt; Id' h
</span><a href="#local-6989586621680538248"><span class="hs-identifier hs-var">intoRef</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id -&gt; Old Id
forall {h}. Id' h -&gt; Id' h
</span><a href="#local-6989586621680538249"><span class="hs-identifier hs-var">intoURef</span></a></span><span>
</span><span id="line-466"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-467"></span><span>    </span><span id="local-6989586621680538248"><span class="annot"><span class="annottext">intoRef :: Id' h -&gt; Id' h
</span><a href="#local-6989586621680538248"><span class="hs-identifier hs-var hs-var">intoRef</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id</span></span><span> </span><span id="local-6989586621680538251"><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621680538251"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span id="local-6989586621680538252"><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538252"><span class="hs-identifier hs-var">pos</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">h -&gt; Old ConstructorId -&gt; Id' h
forall h. h -&gt; Old ConstructorId -&gt; Id' h
</span><span class="hs-identifier hs-var">Reference.Id</span></span><span> </span><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621680538251"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538252"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-468"></span><span>    </span><span id="local-6989586621680538249"><span class="annot"><span class="annottext">intoURef :: Id' h -&gt; Id' h
</span><a href="#local-6989586621680538249"><span class="hs-identifier hs-var hs-var">intoURef</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680538253"><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621680538253"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span id="local-6989586621680538254"><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538254"><span class="hs-identifier hs-var">pos</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">h -&gt; Old ConstructorId -&gt; Id' h
forall h. h -&gt; Old ConstructorId -&gt; Id' h
</span><span class="hs-identifier hs-var">UReference.Id</span></span><span> </span><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621680538253"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538254"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-469"></span><span>
</span><span id="line-470"></span><span class="hs-comment">-- Project an S.Referent'' into its SomeReferenceObjId's</span><span>
</span><span id="line-471"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferent_"><span class="hs-identifier hs-type">someReferent_</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-472"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680536282"><span class="annot"><a href="#local-6989586621680536282"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621680536283"><span class="annot"><a href="#local-6989586621680536283"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-473"></span><span>  </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680536281"><span class="annot"><a href="#local-6989586621680536281"><span class="hs-identifier hs-type">ref</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536281"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536281"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-474"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Branch.Full.Referent''</span></span><span> </span><span class="annot"><a href="#local-6989586621680536282"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536283"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536283"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-475"></span><span id="someReferent_"><span class="annot"><span class="annottext">someReferent_ :: forall t h.
(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Referent'' t h) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferent_"><span class="hs-identifier hs-var hs-var">someReferent_</span></a></span></span><span> </span><span id="local-6989586621680538270"><span class="annot"><span class="annottext">forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="#local-6989586621680538270"><span class="hs-identifier hs-var">typeOrTermTraversal_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-476"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TermReference' t h
 -&gt; BazaarT
      (-&gt;)
      f
      (SomeReference (Id' h))
      (SomeReference (Id' h))
      (TermReference' t h))
-&gt; Referent'' t h
-&gt; BazaarT
     (-&gt;)
     f
     (SomeReference (Id' h))
     (SomeReference (Id' h))
     (Referent'' t h)
forall tmr tyr tmr' (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p tmr (f tmr') -&gt; p (Referent' tmr tyr) (f (Referent' tmr' tyr))
</span><span class="hs-identifier hs-var">UReferent._Ref</span></span><span> </span><span class="annot"><span class="annottext">((TermReference' t h
  -&gt; BazaarT
       (-&gt;)
       f
       (SomeReference (Id' h))
       (SomeReference (Id' h))
       (TermReference' t h))
 -&gt; Referent'' t h
 -&gt; BazaarT
      (-&gt;)
      f
      (SomeReference (Id' h))
      (SomeReference (Id' h))
      (Referent'' t h))
-&gt; ((SomeReference (Id' h)
     -&gt; BazaarT
          (-&gt;)
          f
          (SomeReference (Id' h))
          (SomeReference (Id' h))
          (SomeReference (Id' h)))
    -&gt; TermReference' t h
    -&gt; BazaarT
         (-&gt;)
         f
         (SomeReference (Id' h))
         (SomeReference (Id' h))
         (TermReference' t h))
-&gt; (SomeReference (Id' h)
    -&gt; BazaarT
         (-&gt;)
         f
         (SomeReference (Id' h))
         (SomeReference (Id' h))
         (SomeReference (Id' h)))
-&gt; Referent'' t h
-&gt; BazaarT
     (-&gt;)
     f
     (SomeReference (Id' h))
     (SomeReference (Id' h))
     (Referent'' t h)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (TermReference' t h) (SomeReference (Id' h))
forall t h.
(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Reference' t h) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReference_"><span class="hs-identifier hs-var">someReference_</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="#local-6989586621680538270"><span class="hs-identifier hs-var">typeOrTermTraversal_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span>    </span><span class="annot"><span class="annottext">((SomeReference (Id' h)
  -&gt; BazaarT
       (-&gt;)
       f
       (SomeReference (Id' h))
       (SomeReference (Id' h))
       (SomeReference (Id' h)))
 -&gt; Referent'' t h
 -&gt; BazaarT
      (-&gt;)
      f
      (SomeReference (Id' h))
      (SomeReference (Id' h))
      (Referent'' t h))
-&gt; ((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
    -&gt; Referent'' t h -&gt; f (Referent'' t h))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; Referent'' t h
-&gt; f (Referent'' t h)
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s t a b.
(Conjoined p, Applicative f) =&gt;
Traversing p f s t a b -&gt; Over p f s t a b -&gt; Over p f s t a b
</span><span class="hs-operator hs-var">`failing`</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">((TermReference' t h, Old ConstructorId)
 -&gt; f (TermReference' t h, Old ConstructorId))
-&gt; Referent'' t h -&gt; f (Referent'' t h)
forall tmr tyr tyr' (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p (tyr, Old ConstructorId) (f (tyr', Old ConstructorId))
-&gt; p (Referent' tmr tyr) (f (Referent' tmr tyr'))
</span><span class="hs-identifier hs-var">UReferent._Con</span></span><span>
</span><span id="line-478"></span><span>                  </span><span class="annot"><span class="annottext">(((TermReference' t h, Old ConstructorId)
  -&gt; f (TermReference' t h, Old ConstructorId))
 -&gt; Referent'' t h -&gt; f (Referent'' t h))
-&gt; ((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
    -&gt; (TermReference' t h, Old ConstructorId)
    -&gt; f (TermReference' t h, Old ConstructorId))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; Referent'' t h
-&gt; f (Referent'' t h)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(GConstructorReference (Id' h)
 -&gt; f (GConstructorReference (Id' h)))
-&gt; (TermReference' t h, Old ConstructorId)
-&gt; f (TermReference' t h, Old ConstructorId)
forall {f :: * -&gt; *} {b} {h} {h} {t}.
(Integral b, Applicative f) =&gt;
(GConstructorReference (Id' h)
 -&gt; f (GConstructorReference (Id' h)))
-&gt; (Reference' t h, b) -&gt; f (Reference' t h, b)
</span><a href="#local-6989586621680538277"><span class="hs-identifier hs-var">asPair_</span></a></span><span> </span><span class="hs-comment">-- Need to unpack the embedded reference AND remap between mismatched Constructor ID types.</span><span>
</span><span id="line-479"></span><span>                  </span><span class="annot"><span class="annottext">((GConstructorReference (Id' h)
  -&gt; f (GConstructorReference (Id' h)))
 -&gt; (TermReference' t h, Old ConstructorId)
 -&gt; f (TermReference' t h, Old ConstructorId))
-&gt; ((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
    -&gt; GConstructorReference (Id' h)
    -&gt; f (GConstructorReference (Id' h)))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; (TermReference' t h, Old ConstructorId)
-&gt; f (TermReference' t h, Old ConstructorId)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; GConstructorReference (Id' h)
-&gt; f (GConstructorReference (Id' h))
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref))
-&gt; GConstructorReference ref -&gt; f (GConstructorReference ref)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asConstructorReference_"><span class="hs-identifier hs-var">asConstructorReference_</span></a></span><span>
</span><span id="line-480"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-482"></span><span>    </span><span id="local-6989586621680538277"><span class="annot"><span class="annottext">asPair_ :: (GConstructorReference (Id' h)
 -&gt; f (GConstructorReference (Id' h)))
-&gt; (Reference' t h, b) -&gt; f (Reference' t h, b)
</span><a href="#local-6989586621680538277"><span class="hs-identifier hs-var hs-var">asPair_</span></a></span></span><span> </span><span id="local-6989586621680538305"><span class="annot"><span class="annottext">GConstructorReference (Id' h) -&gt; f (GConstructorReference (Id' h))
</span><a href="#local-6989586621680538305"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.ReferenceDerived</span></span><span> </span><span id="local-6989586621680538307"><span class="annot"><span class="annottext">Id' h
</span><a href="#local-6989586621680538307"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538308"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621680538308"><span class="hs-identifier hs-var">conId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-483"></span><span>      </span><span class="annot"><span class="annottext">GConstructorReference (Id' h) -&gt; f (GConstructorReference (Id' h))
</span><a href="#local-6989586621680538305"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id' h -&gt; Old ConstructorId -&gt; GConstructorReference (Id' h)
forall r. r -&gt; Old ConstructorId -&gt; GConstructorReference r
</span><span class="hs-identifier hs-var">ConstructorReference.ConstructorReference</span></span><span> </span><span class="annot"><span class="annottext">Id' h
</span><a href="#local-6989586621680538307"><span class="hs-identifier hs-var">id'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Old ConstructorId
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621680538308"><span class="hs-identifier hs-var">conId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>        </span><span class="annot"><span class="annottext">f (GConstructorReference (Id' h))
-&gt; (GConstructorReference (Id' h) -&gt; (Reference' t h, b))
-&gt; f (Reference' t h, b)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference.ConstructorReference</span></span><span> </span><span id="local-6989586621680538311"><span class="annot"><span class="annottext">Id' h
</span><a href="#local-6989586621680538311"><span class="hs-identifier hs-var">newId</span></a></span></span><span> </span><span id="local-6989586621680538312"><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538312"><span class="hs-identifier hs-var">newConId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-485"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id' h -&gt; Reference' t h
forall t h. Id' h -&gt; Reference' t h
</span><span class="hs-identifier hs-var">UReference.ReferenceDerived</span></span><span> </span><span class="annot"><span class="annottext">Id' h
</span><a href="#local-6989586621680538311"><span class="hs-identifier hs-var">newId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Old ConstructorId -&gt; b
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538312"><span class="hs-identifier hs-var">newConId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>    </span><span class="annot"><a href="#local-6989586621680538277"><span class="hs-identifier hs-var">asPair_</span></a></span><span> </span><span class="annot"><span class="annottext">GConstructorReference (Id' h) -&gt; f (GConstructorReference (Id' h))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.ReferenceBuiltin</span></span><span> </span><span id="local-6989586621680538314"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680538314"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538315"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621680538315"><span class="hs-identifier hs-var">conId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Reference' t h, b) -&gt; f (Reference' t h, b)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; Reference' t h
forall t h. t -&gt; Reference' t h
</span><span class="hs-identifier hs-var">UReference.ReferenceBuiltin</span></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621680538314"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621680538315"><span class="hs-identifier hs-var">conId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span id="local-6989586621680536301"><span id="local-6989586621680536302"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReference_"><span class="hs-identifier hs-type">someReference_</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-489"></span><span>  </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680538316"><span class="annot"><a href="#local-6989586621680538316"><span class="hs-identifier hs-type">ref</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="annot"><a href="#local-6989586621680538316"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538316"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-490"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Reference'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536301"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536302"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536302"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-491"></span><span id="someReference_"><span class="annot"><span class="annottext">someReference_ :: forall t h.
(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Reference' t h) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReference_"><span class="hs-identifier hs-var hs-var">someReference_</span></a></span></span><span> </span><span id="local-6989586621680538321"><span class="annot"><span class="annottext">forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="#local-6989586621680538321"><span class="hs-identifier hs-var">typeOrTermTraversal_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Id' h -&gt; f (Id' h)) -&gt; Reference' t h -&gt; f (Reference' t h)
forall t h h' (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p (Id' h) (f (Id' h')) -&gt; p (Reference' t h) (f (Reference' t h'))
</span><span class="hs-identifier hs-var">UReference._ReferenceDerived</span></span><span> </span><span class="annot"><span class="annottext">((Id' h -&gt; f (Id' h)) -&gt; Reference' t h -&gt; f (Reference' t h))
-&gt; ((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
    -&gt; Id' h -&gt; f (Id' h))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; Reference' t h
-&gt; f (Reference' t h)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; Id' h -&gt; f (Id' h)
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="#local-6989586621680538321"><span class="hs-identifier hs-var">typeOrTermTraversal_</span></a></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span id="local-6989586621680536344"><span id="local-6989586621680536345"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someMetadataSetFormat_"><span class="hs-identifier hs-type">someMetadataSetFormat_</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-494"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536344"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536345"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-495"></span><span>  </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680538324"><span class="annot"><a href="#local-6989586621680538324"><span class="hs-identifier hs-type">ref</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="annot"><a href="#local-6989586621680538324"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538324"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-496"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Branch.Full.MetadataSetFormat'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536344"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536345"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536345"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-497"></span><span id="someMetadataSetFormat_"><span class="annot"><span class="annottext">someMetadataSetFormat_ :: forall t h.
(Ord t, Ord h) =&gt;
(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (MetadataSetFormat' t h) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someMetadataSetFormat_"><span class="hs-identifier hs-var hs-var">someMetadataSetFormat_</span></a></span></span><span> </span><span id="local-6989586621680538333"><span class="annot"><span class="annottext">forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="#local-6989586621680538333"><span class="hs-identifier hs-var">typeOrTermTraversal_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-498"></span><span>  </span><span class="annot"><span class="annottext">(Reference' t h -&gt; f (Reference' t h))
-&gt; MetadataSetFormat' t h -&gt; f (MetadataSetFormat' t h)
forall t h h'.
(Ord t, Ord h, Ord h') =&gt;
Traversal
  (MetadataSetFormat' t h)
  (MetadataSetFormat' t h')
  (Reference' t h)
  (Reference' t h')
Traversal
  (MetadataSetFormat' t h)
  (MetadataSetFormat' t h)
  (Reference' t h)
  (Reference' t h)
</span><span class="hs-identifier hs-var">S.Branch.Full.metadataSetFormatReferences_</span></span><span> </span><span class="annot"><span class="annottext">((Reference' t h -&gt; f (Reference' t h))
 -&gt; MetadataSetFormat' t h -&gt; f (MetadataSetFormat' t h))
-&gt; ((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
    -&gt; Reference' t h -&gt; f (Reference' t h))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; MetadataSetFormat' t h
-&gt; f (MetadataSetFormat' t h)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Reference' t h) (SomeReference (Id' h))
forall t h.
(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Reference' t h) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReference_"><span class="hs-identifier hs-var">someReference_</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="#local-6989586621680538333"><span class="hs-identifier hs-var">typeOrTermTraversal_</span></a></span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span id="local-6989586621680536355"><span id="local-6989586621680536356"><span id="local-6989586621680536357"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferenceMetadata_"><span class="hs-identifier hs-type">someReferenceMetadata_</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536355"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536356"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536357"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-502"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536355"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536357"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-503"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621680536355"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Branch.Full.MetadataSetFormat'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536356"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536357"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536357"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-506"></span><span id="someReferenceMetadata_"><span class="annot"><span class="annottext">someReferenceMetadata_ :: forall k t h.
(Ord k, Ord t, Ord h) =&gt;
Traversal' k (SomeReference (Id' h))
-&gt; Traversal'
     (Map k (MetadataSetFormat' t h)) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferenceMetadata_"><span class="hs-identifier hs-var hs-var">someReferenceMetadata_</span></a></span></span><span> </span><span id="local-6989586621680538357"><span class="annot"><span class="annottext">Traversal' k (SomeReference (Id' h))
</span><a href="#local-6989586621680538357"><span class="hs-identifier hs-var">keyTraversal_</span></a></span></span><span> </span><span id="local-6989586621680538358"><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538358"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621680538359"><span class="annot"><span class="annottext">Map k (MetadataSetFormat' t h)
</span><a href="#local-6989586621680538359"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-507"></span><span>  </span><span class="annot"><span class="annottext">Map k (MetadataSetFormat' t h) -&gt; [(k, MetadataSetFormat' t h)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map k (MetadataSetFormat' t h)
</span><a href="#local-6989586621680538359"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-508"></span><span>    </span><span class="annot"><span class="annottext">[(k, MetadataSetFormat' t h)]
-&gt; ([(k, MetadataSetFormat' t h)]
    -&gt; f [(k, MetadataSetFormat' t h)])
-&gt; f [(k, MetadataSetFormat' t h)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((k, MetadataSetFormat' t h) -&gt; f (k, MetadataSetFormat' t h))
-&gt; [(k, MetadataSetFormat' t h)] -&gt; f [(k, MetadataSetFormat' t h)]
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  [(k, MetadataSetFormat' t h)]
  [(k, MetadataSetFormat' t h)]
  (k, MetadataSetFormat' t h)
  (k, MetadataSetFormat' t h)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">(((k, MetadataSetFormat' t h) -&gt; f (k, MetadataSetFormat' t h))
 -&gt; [(k, MetadataSetFormat' t h)]
 -&gt; f [(k, MetadataSetFormat' t h)])
-&gt; ((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
    -&gt; (k, MetadataSetFormat' t h) -&gt; f (k, MetadataSetFormat' t h))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; [(k, MetadataSetFormat' t h)]
-&gt; f [(k, MetadataSetFormat' t h)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Optical
  (-&gt;) (-&gt;) f k k (SomeReference (Id' h)) (SomeReference (Id' h))
-&gt; Optical
     (-&gt;)
     (-&gt;)
     f
     (MetadataSetFormat' t h)
     (MetadataSetFormat' t h)
     (SomeReference (Id' h))
     (SomeReference (Id' h))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; (k, MetadataSetFormat' t h)
-&gt; f (k, MetadataSetFormat' t h)
forall (q :: * -&gt; * -&gt; *) (f :: * -&gt; *) (r :: * -&gt; * -&gt; *)
       (p :: * -&gt; * -&gt; *) s t a b s' t'.
(Representable q, Applicative (Rep q), Applicative f,
 Bitraversable r) =&gt;
Optical p q f s t a b
-&gt; Optical p q f s' t' a b -&gt; Optical p q f (r s s') (r t t') a b
</span><span class="hs-identifier hs-var">beside</span></span><span> </span><span class="annot"><span class="annottext">Optical
  (-&gt;) (-&gt;) f k k (SomeReference (Id' h)) (SomeReference (Id' h))
Traversal' k (SomeReference (Id' h))
</span><a href="#local-6989586621680538357"><span class="hs-identifier hs-var">keyTraversal_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (MetadataSetFormat' t h) (SomeReference (Id' h))
forall t h.
(Ord t, Ord h) =&gt;
(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (MetadataSetFormat' t h) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someMetadataSetFormat_"><span class="hs-identifier hs-var">someMetadataSetFormat_</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTermReference_"><span class="hs-identifier hs-var">asTermReference_</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
 -&gt; [(k, MetadataSetFormat' t h)]
 -&gt; f [(k, MetadataSetFormat' t h)])
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; [(k, MetadataSetFormat' t h)]
-&gt; f [(k, MetadataSetFormat' t h)]
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538358"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-509"></span><span>    </span><span class="annot"><span class="annottext">f [(k, MetadataSetFormat' t h)]
-&gt; ([(k, MetadataSetFormat' t h)]
    -&gt; Map k (MetadataSetFormat' t h))
-&gt; f (Map k (MetadataSetFormat' t h))
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(k, MetadataSetFormat' t h)] -&gt; Map k (MetadataSetFormat' t h)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span>
</span><span id="line-510"></span><span>
</span><span id="line-511"></span><span id="local-6989586621680536180"><span id="local-6989586621680536181"><span id="local-6989586621680536182"><span id="local-6989586621680536183"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#branchSomeRefs_"><span class="hs-identifier hs-type">branchSomeRefs_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536180"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536181"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Branch'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536180"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536181"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536182"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536183"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536181"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-512"></span><span id="branchSomeRefs_"><span class="annot"><span class="annottext">branchSomeRefs_ :: forall t h p c.
(Ord t, Ord h) =&gt;
Traversal' (Branch' t h p c) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#branchSomeRefs_"><span class="hs-identifier hs-var hs-var">branchSomeRefs_</span></a></span></span><span> </span><span id="local-6989586621680538393"><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538393"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Branch.Full.Branch</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680538395"><span class="annot"><span class="annottext">Map t c
children :: Map t c
$sel:children:Branch :: forall t h p c. Branch' t h p c -&gt; Map t c
</span><a href="#local-6989586621680538395"><span class="hs-identifier hs-var hs-var">children</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538397"><span class="annot"><span class="annottext">Map t p
patches :: Map t p
$sel:patches:Branch :: forall t h p c. Branch' t h p c -&gt; Map t p
</span><a href="#local-6989586621680538397"><span class="hs-identifier hs-var hs-var">patches</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538399"><span class="annot"><span class="annottext">Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
terms :: Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
$sel:terms:Branch :: forall t h p c.
Branch' t h p c
-&gt; Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
</span><a href="#local-6989586621680538399"><span class="hs-identifier hs-var hs-var">terms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538401"><span class="annot"><span class="annottext">Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
types :: Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
$sel:types:Branch :: forall t h p c.
Branch' t h p c
-&gt; Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
</span><a href="#local-6989586621680538401"><span class="hs-identifier hs-var hs-var">types</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-513"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538403"><span class="annot"><span class="annottext">newTypesMap :: f (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h)))
</span><a href="#local-6989586621680538403"><span class="hs-identifier hs-var hs-var">newTypesMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
</span><a href="#local-6989586621680538401"><span class="hs-identifier hs-var">types</span></a></span><span> </span><span class="annot"><span class="annottext">Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
-&gt; (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
    -&gt; f (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))))
-&gt; f (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h)))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Map (TypeReference' t h) (MetadataSetFormat' t h)
 -&gt; f (Map (TypeReference' t h) (MetadataSetFormat' t h)))
-&gt; Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
-&gt; f (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h)))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h)))
  (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h)))
  (Map (TypeReference' t h) (MetadataSetFormat' t h))
  (Map (TypeReference' t h) (MetadataSetFormat' t h))
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">((Map (TypeReference' t h) (MetadataSetFormat' t h)
  -&gt; f (Map (TypeReference' t h) (MetadataSetFormat' t h)))
 -&gt; Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
 -&gt; f (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))))
-&gt; ((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
    -&gt; Map (TypeReference' t h) (MetadataSetFormat' t h)
    -&gt; f (Map (TypeReference' t h) (MetadataSetFormat' t h)))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
-&gt; f (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Traversal' (TypeReference' t h) (SomeReference (Id' h))
-&gt; Traversal'
     (Map (TypeReference' t h) (MetadataSetFormat' t h))
     (SomeReference (Id' h))
forall k t h.
(Ord k, Ord t, Ord h) =&gt;
Traversal' k (SomeReference (Id' h))
-&gt; Traversal'
     (Map k (MetadataSetFormat' t h)) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferenceMetadata_"><span class="hs-identifier hs-var">someReferenceMetadata_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (TypeReference' t h) (SomeReference (Id' h))
forall t h.
(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Reference' t h) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReference_"><span class="hs-identifier hs-var">someReference_</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTypeReference_"><span class="hs-identifier hs-var">asTypeReference_</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
 -&gt; Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
 -&gt; f (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
-&gt; f (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h)))
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538393"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-514"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538409"><span class="annot"><span class="annottext">newTermsMap :: f (Map t (Map (Referent'' t h) (MetadataSetFormat' t h)))
</span><a href="#local-6989586621680538409"><span class="hs-identifier hs-var hs-var">newTermsMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
</span><a href="#local-6989586621680538399"><span class="hs-identifier hs-var">terms</span></a></span><span> </span><span class="annot"><span class="annottext">Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
-&gt; (Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
    -&gt; f (Map t (Map (Referent'' t h) (MetadataSetFormat' t h))))
-&gt; f (Map t (Map (Referent'' t h) (MetadataSetFormat' t h)))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Map (Referent'' t h) (MetadataSetFormat' t h)
 -&gt; f (Map (Referent'' t h) (MetadataSetFormat' t h)))
-&gt; Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
-&gt; f (Map t (Map (Referent'' t h) (MetadataSetFormat' t h)))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  (Map t (Map (Referent'' t h) (MetadataSetFormat' t h)))
  (Map t (Map (Referent'' t h) (MetadataSetFormat' t h)))
  (Map (Referent'' t h) (MetadataSetFormat' t h))
  (Map (Referent'' t h) (MetadataSetFormat' t h))
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">((Map (Referent'' t h) (MetadataSetFormat' t h)
  -&gt; f (Map (Referent'' t h) (MetadataSetFormat' t h)))
 -&gt; Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
 -&gt; f (Map t (Map (Referent'' t h) (MetadataSetFormat' t h))))
-&gt; ((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
    -&gt; Map (Referent'' t h) (MetadataSetFormat' t h)
    -&gt; f (Map (Referent'' t h) (MetadataSetFormat' t h)))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
-&gt; f (Map t (Map (Referent'' t h) (MetadataSetFormat' t h)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Traversal' (Referent'' t h) (SomeReference (Id' h))
-&gt; Traversal'
     (Map (Referent'' t h) (MetadataSetFormat' t h))
     (SomeReference (Id' h))
forall k t h.
(Ord k, Ord t, Ord h) =&gt;
Traversal' k (SomeReference (Id' h))
-&gt; Traversal'
     (Map k (MetadataSetFormat' t h)) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferenceMetadata_"><span class="hs-identifier hs-var">someReferenceMetadata_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Referent'' t h) (SomeReference (Id' h))
forall t h.
(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Referent'' t h) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferent_"><span class="hs-identifier hs-var">someReferent_</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTermReference_"><span class="hs-identifier hs-var">asTermReference_</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
 -&gt; Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
 -&gt; f (Map t (Map (Referent'' t h) (MetadataSetFormat' t h))))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
-&gt; f (Map t (Map (Referent'' t h) (MetadataSetFormat' t h)))
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538393"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-515"></span><span>  </span><span class="annot"><span class="annottext">Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
-&gt; Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
-&gt; Map t p
-&gt; Map t c
-&gt; Branch' t h p c
forall t h p c.
Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
-&gt; Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
-&gt; Map t p
-&gt; Map t c
-&gt; Branch' t h p c
</span><span class="hs-identifier hs-var">S.Branch.Full.Branch</span></span><span> </span><span class="annot"><span class="annottext">(Map t (Map (Referent'' t h) (MetadataSetFormat' t h))
 -&gt; Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
 -&gt; Map t p
 -&gt; Map t c
 -&gt; Branch' t h p c)
-&gt; f (Map t (Map (Referent'' t h) (MetadataSetFormat' t h)))
-&gt; f (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
      -&gt; Map t p -&gt; Map t c -&gt; Branch' t h p c)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">f (Map t (Map (Referent'' t h) (MetadataSetFormat' t h)))
</span><a href="#local-6989586621680538409"><span class="hs-identifier hs-var">newTermsMap</span></a></span><span> </span><span class="annot"><span class="annottext">f (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h))
   -&gt; Map t p -&gt; Map t c -&gt; Branch' t h p c)
-&gt; f (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h)))
-&gt; f (Map t p -&gt; Map t c -&gt; Branch' t h p c)
forall a b. f (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">f (Map t (Map (TypeReference' t h) (MetadataSetFormat' t h)))
</span><a href="#local-6989586621680538403"><span class="hs-identifier hs-var">newTypesMap</span></a></span><span> </span><span class="annot"><span class="annottext">f (Map t p -&gt; Map t c -&gt; Branch' t h p c)
-&gt; f (Map t p) -&gt; f (Map t c -&gt; Branch' t h p c)
forall a b. f (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map t p -&gt; f (Map t p)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Map t p
</span><a href="#local-6989586621680538397"><span class="hs-identifier hs-var">patches</span></a></span><span> </span><span class="annot"><span class="annottext">f (Map t c -&gt; Branch' t h p c)
-&gt; f (Map t c) -&gt; f (Branch' t h p c)
forall a b. f (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map t c -&gt; f (Map t c)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Map t c
</span><a href="#local-6989586621680538395"><span class="hs-identifier hs-var">children</span></a></span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span id="local-6989586621680536240"><span id="local-6989586621680536241"><span id="local-6989586621680536242"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patchSomeRefsH_"><span class="hs-identifier hs-type">patchSomeRefsH_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536240"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536241"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Patch'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536240"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536241"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536242"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Patch'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536240"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536241"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536242"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536241"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536241"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-518"></span><span id="patchSomeRefsH_"><span class="annot"><span class="annottext">patchSomeRefsH_ :: forall t h o.
(Ord t, Ord h) =&gt;
Traversal
  (Patch' t h o)
  (Patch' t h o)
  (SomeReference (Id' h))
  (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patchSomeRefsH_"><span class="hs-identifier hs-var hs-var">patchSomeRefsH_</span></a></span></span><span> </span><span id="local-6989586621680538438"><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538438"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Patch</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680538440"><span class="annot"><span class="annottext">Map (Referent'' t h) (Set (TermEdit' t o))
termEdits :: Map (Referent'' t h) (Set (TermEdit' t o))
$sel:termEdits:Patch :: forall t h o.
Patch' t h o -&gt; Map (Referent'' t h) (Set (TermEdit' t o))
</span><a href="#local-6989586621680538440"><span class="hs-identifier hs-var hs-var">termEdits</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538442"><span class="annot"><span class="annottext">Map (Reference' t h) (Set (TypeEdit' t o))
typeEdits :: Map (Reference' t h) (Set (TypeEdit' t o))
$sel:typeEdits:Patch :: forall t h o.
Patch' t h o -&gt; Map (Reference' t h) (Set (TypeEdit' t o))
</span><a href="#local-6989586621680538442"><span class="hs-identifier hs-var hs-var">typeEdits</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-519"></span><span>  </span><span id="local-6989586621680538444"><span class="annot"><span class="annottext">Map (Referent'' t h) (Set (TermEdit' t o))
</span><a href="#local-6989586621680538444"><span class="hs-identifier hs-var">newTermEdits</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Referent'' t h, Set (TermEdit' t o))]
-&gt; Map (Referent'' t h) (Set (TermEdit' t o))
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Referent'' t h, Set (TermEdit' t o))]
 -&gt; Map (Referent'' t h) (Set (TermEdit' t o)))
-&gt; f [(Referent'' t h, Set (TermEdit' t o))]
-&gt; f (Map (Referent'' t h) (Set (TermEdit' t o)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Referent'' t h) (Set (TermEdit' t o))
-&gt; [(Referent'' t h, Set (TermEdit' t o))]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map (Referent'' t h) (Set (TermEdit' t o))
</span><a href="#local-6989586621680538440"><span class="hs-identifier hs-var">termEdits</span></a></span><span> </span><span class="annot"><span class="annottext">[(Referent'' t h, Set (TermEdit' t o))]
-&gt; ([(Referent'' t h, Set (TermEdit' t o))]
    -&gt; f [(Referent'' t h, Set (TermEdit' t o))])
-&gt; f [(Referent'' t h, Set (TermEdit' t o))]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((Referent'' t h, Set (TermEdit' t o))
 -&gt; f (Referent'' t h, Set (TermEdit' t o)))
-&gt; [(Referent'' t h, Set (TermEdit' t o))]
-&gt; f [(Referent'' t h, Set (TermEdit' t o))]
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  [(Referent'' t h, Set (TermEdit' t o))]
  [(Referent'' t h, Set (TermEdit' t o))]
  (Referent'' t h, Set (TermEdit' t o))
  (Referent'' t h, Set (TermEdit' t o))
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">(((Referent'' t h, Set (TermEdit' t o))
  -&gt; f (Referent'' t h, Set (TermEdit' t o)))
 -&gt; [(Referent'' t h, Set (TermEdit' t o))]
 -&gt; f [(Referent'' t h, Set (TermEdit' t o))])
-&gt; ((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
    -&gt; (Referent'' t h, Set (TermEdit' t o))
    -&gt; f (Referent'' t h, Set (TermEdit' t o)))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; [(Referent'' t h, Set (TermEdit' t o))]
-&gt; f [(Referent'' t h, Set (TermEdit' t o))]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Referent'' t h -&gt; f (Referent'' t h))
-&gt; (Referent'' t h, Set (TermEdit' t o))
-&gt; f (Referent'' t h, Set (TermEdit' t o))
forall s t a b. Field1 s t a b =&gt; Lens s t a b
Lens
  (Referent'' t h, Set (TermEdit' t o))
  (Referent'' t h, Set (TermEdit' t o))
  (Referent'' t h)
  (Referent'' t h)
</span><span class="hs-identifier hs-var">_1</span></span><span> </span><span class="annot"><span class="annottext">((Referent'' t h -&gt; f (Referent'' t h))
 -&gt; (Referent'' t h, Set (TermEdit' t o))
 -&gt; f (Referent'' t h, Set (TermEdit' t o)))
-&gt; ((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
    -&gt; Referent'' t h -&gt; f (Referent'' t h))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; (Referent'' t h, Set (TermEdit' t o))
-&gt; f (Referent'' t h, Set (TermEdit' t o))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Referent'' t h) (SomeReference (Id' h))
forall t h.
(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Referent'' t h) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferent_"><span class="hs-identifier hs-var">someReferent_</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTermReference_"><span class="hs-identifier hs-var">asTermReference_</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
 -&gt; [(Referent'' t h, Set (TermEdit' t o))]
 -&gt; f [(Referent'' t h, Set (TermEdit' t o))])
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; [(Referent'' t h, Set (TermEdit' t o))]
-&gt; f [(Referent'' t h, Set (TermEdit' t o))]
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538438"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>  </span><span id="local-6989586621680538447"><span class="annot"><span class="annottext">Map (Reference' t h) (Set (TypeEdit' t o))
</span><a href="#local-6989586621680538447"><span class="hs-identifier hs-var">newTypeEdits</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Reference' t h, Set (TypeEdit' t o))]
-&gt; Map (Reference' t h) (Set (TypeEdit' t o))
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Reference' t h, Set (TypeEdit' t o))]
 -&gt; Map (Reference' t h) (Set (TypeEdit' t o)))
-&gt; f [(Reference' t h, Set (TypeEdit' t o))]
-&gt; f (Map (Reference' t h) (Set (TypeEdit' t o)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Reference' t h) (Set (TypeEdit' t o))
-&gt; [(Reference' t h, Set (TypeEdit' t o))]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map (Reference' t h) (Set (TypeEdit' t o))
</span><a href="#local-6989586621680538442"><span class="hs-identifier hs-var">typeEdits</span></a></span><span> </span><span class="annot"><span class="annottext">[(Reference' t h, Set (TypeEdit' t o))]
-&gt; ([(Reference' t h, Set (TypeEdit' t o))]
    -&gt; f [(Reference' t h, Set (TypeEdit' t o))])
-&gt; f [(Reference' t h, Set (TypeEdit' t o))]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((Reference' t h, Set (TypeEdit' t o))
 -&gt; f (Reference' t h, Set (TypeEdit' t o)))
-&gt; [(Reference' t h, Set (TypeEdit' t o))]
-&gt; f [(Reference' t h, Set (TypeEdit' t o))]
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  [(Reference' t h, Set (TypeEdit' t o))]
  [(Reference' t h, Set (TypeEdit' t o))]
  (Reference' t h, Set (TypeEdit' t o))
  (Reference' t h, Set (TypeEdit' t o))
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">(((Reference' t h, Set (TypeEdit' t o))
  -&gt; f (Reference' t h, Set (TypeEdit' t o)))
 -&gt; [(Reference' t h, Set (TypeEdit' t o))]
 -&gt; f [(Reference' t h, Set (TypeEdit' t o))])
-&gt; ((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
    -&gt; (Reference' t h, Set (TypeEdit' t o))
    -&gt; f (Reference' t h, Set (TypeEdit' t o)))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; [(Reference' t h, Set (TypeEdit' t o))]
-&gt; f [(Reference' t h, Set (TypeEdit' t o))]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Reference' t h -&gt; f (Reference' t h))
-&gt; (Reference' t h, Set (TypeEdit' t o))
-&gt; f (Reference' t h, Set (TypeEdit' t o))
forall s t a b. Field1 s t a b =&gt; Lens s t a b
Lens
  (Reference' t h, Set (TypeEdit' t o))
  (Reference' t h, Set (TypeEdit' t o))
  (Reference' t h)
  (Reference' t h)
</span><span class="hs-identifier hs-var">_1</span></span><span> </span><span class="annot"><span class="annottext">((Reference' t h -&gt; f (Reference' t h))
 -&gt; (Reference' t h, Set (TypeEdit' t o))
 -&gt; f (Reference' t h, Set (TypeEdit' t o)))
-&gt; ((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
    -&gt; Reference' t h -&gt; f (Reference' t h))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; (Reference' t h, Set (TypeEdit' t o))
-&gt; f (Reference' t h, Set (TypeEdit' t o))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Reference' t h) (SomeReference (Id' h))
forall t h.
(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Reference' t h) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReference_"><span class="hs-identifier hs-var">someReference_</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTypeReference_"><span class="hs-identifier hs-var">asTypeReference_</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
 -&gt; [(Reference' t h, Set (TypeEdit' t o))]
 -&gt; f [(Reference' t h, Set (TypeEdit' t o))])
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; [(Reference' t h, Set (TypeEdit' t o))]
-&gt; f [(Reference' t h, Set (TypeEdit' t o))]
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538438"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Patch</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:termEdits:Patch :: Map (Referent'' t h) (Set (TermEdit' t o))
</span><span class="hs-identifier hs-var">termEdits</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Referent'' t h) (Set (TermEdit' t o))
</span><a href="#local-6989586621680538444"><span class="hs-identifier hs-var">newTermEdits</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:typeEdits:Patch :: Map (Reference' t h) (Set (TypeEdit' t o))
</span><span class="hs-identifier hs-var">typeEdits</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Reference' t h) (Set (TypeEdit' t o))
</span><a href="#local-6989586621680538447"><span class="hs-identifier hs-var">newTypeEdits</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span id="local-6989586621680536243"><span id="local-6989586621680536244"><span id="local-6989586621680536245"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patchSomeRefsO_"><span class="hs-identifier hs-type">patchSomeRefsO_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536243"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536244"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536245"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Patch'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536243"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536244"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536245"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536245"><span class="hs-identifier hs-type">o</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-524"></span><span id="patchSomeRefsO_"><span class="annot"><span class="annottext">patchSomeRefsO_ :: forall t h o.
(Ord t, Ord h, Ord o) =&gt;
Traversal' (Patch' t h o) (SomeReference (Id' o))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patchSomeRefsO_"><span class="hs-identifier hs-var hs-var">patchSomeRefsO_</span></a></span></span><span> </span><span id="local-6989586621680538471"><span class="annot"><span class="annottext">SomeReference (Id' o) -&gt; f (SomeReference (Id' o))
</span><a href="#local-6989586621680538471"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Patch</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680538472"><span class="annot"><span class="annottext">Map (Referent'' t h) (Set (TermEdit' t o))
$sel:termEdits:Patch :: forall t h o.
Patch' t h o -&gt; Map (Referent'' t h) (Set (TermEdit' t o))
termEdits :: Map (Referent'' t h) (Set (TermEdit' t o))
</span><span class="hs-identifier hs-var hs-var">termEdits</span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538473"><span class="annot"><span class="annottext">Map (Reference' t h) (Set (TypeEdit' t o))
$sel:typeEdits:Patch :: forall t h o.
Patch' t h o -&gt; Map (Reference' t h) (Set (TypeEdit' t o))
typeEdits :: Map (Reference' t h) (Set (TypeEdit' t o))
</span><span class="hs-identifier hs-var hs-var">typeEdits</span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-525"></span><span>  </span><span id="local-6989586621680538474"><span class="annot"><span class="annottext">Map (Referent'' t h) (Set (TermEdit' t o))
</span><a href="#local-6989586621680538474"><span class="hs-identifier hs-var">newTermEdits</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Referent'' t h) (Set (TermEdit' t o))
</span><a href="#local-6989586621680538472"><span class="hs-identifier hs-var">termEdits</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Referent'' t h) (Set (TermEdit' t o))
-&gt; (Map (Referent'' t h) (Set (TermEdit' t o))
    -&gt; f (Map (Referent'' t h) (Set (TermEdit' t o))))
-&gt; f (Map (Referent'' t h) (Set (TermEdit' t o)))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Set (TermEdit' t o) -&gt; f (Set (TermEdit' t o)))
-&gt; Map (Referent'' t h) (Set (TermEdit' t o))
-&gt; f (Map (Referent'' t h) (Set (TermEdit' t o)))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  (Map (Referent'' t h) (Set (TermEdit' t o)))
  (Map (Referent'' t h) (Set (TermEdit' t o)))
  (Set (TermEdit' t o))
  (Set (TermEdit' t o))
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">((Set (TermEdit' t o) -&gt; f (Set (TermEdit' t o)))
 -&gt; Map (Referent'' t h) (Set (TermEdit' t o))
 -&gt; f (Map (Referent'' t h) (Set (TermEdit' t o))))
-&gt; ((SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
    -&gt; Set (TermEdit' t o) -&gt; f (Set (TermEdit' t o)))
-&gt; (SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
-&gt; Map (Referent'' t h) (Set (TermEdit' t o))
-&gt; f (Map (Referent'' t h) (Set (TermEdit' t o)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TermEdit' t o -&gt; f (TermEdit' t o))
-&gt; Set (TermEdit' t o) -&gt; f (Set (TermEdit' t o))
forall (f :: * -&gt; *) b a.
(Applicative f, Ord b) =&gt;
(a -&gt; f b) -&gt; Set a -&gt; f (Set b)
</span><span class="hs-identifier hs-var">Set.traverse</span></span><span> </span><span class="annot"><span class="annottext">((TermEdit' t o -&gt; f (TermEdit' t o))
 -&gt; Set (TermEdit' t o) -&gt; f (Set (TermEdit' t o)))
-&gt; ((SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
    -&gt; TermEdit' t o -&gt; f (TermEdit' t o))
-&gt; (SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
-&gt; Set (TermEdit' t o)
-&gt; f (Set (TermEdit' t o))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
-&gt; TermEdit' t o -&gt; f (TermEdit' t o)
forall t h (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; TermEdit' t h -&gt; f (TermEdit' t h)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#termEditRefs_"><span class="hs-identifier hs-var">termEditRefs_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
 -&gt; Map (Referent'' t h) (Set (TermEdit' t o))
 -&gt; f (Map (Referent'' t h) (Set (TermEdit' t o))))
-&gt; (SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
-&gt; Map (Referent'' t h) (Set (TermEdit' t o))
-&gt; f (Map (Referent'' t h) (Set (TermEdit' t o)))
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' o) -&gt; f (SomeReference (Id' o))
</span><a href="#local-6989586621680538471"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span>  </span><span id="local-6989586621680538477"><span class="annot"><span class="annottext">Map (Reference' t h) (Set (TypeEdit' t o))
</span><a href="#local-6989586621680538477"><span class="hs-identifier hs-var">newTypeEdits</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Reference' t h) (Set (TypeEdit' t o))
</span><a href="#local-6989586621680538473"><span class="hs-identifier hs-var">typeEdits</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Reference' t h) (Set (TypeEdit' t o))
-&gt; (Map (Reference' t h) (Set (TypeEdit' t o))
    -&gt; f (Map (Reference' t h) (Set (TypeEdit' t o))))
-&gt; f (Map (Reference' t h) (Set (TypeEdit' t o)))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Set (TypeEdit' t o) -&gt; f (Set (TypeEdit' t o)))
-&gt; Map (Reference' t h) (Set (TypeEdit' t o))
-&gt; f (Map (Reference' t h) (Set (TypeEdit' t o)))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  (Map (Reference' t h) (Set (TypeEdit' t o)))
  (Map (Reference' t h) (Set (TypeEdit' t o)))
  (Set (TypeEdit' t o))
  (Set (TypeEdit' t o))
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">((Set (TypeEdit' t o) -&gt; f (Set (TypeEdit' t o)))
 -&gt; Map (Reference' t h) (Set (TypeEdit' t o))
 -&gt; f (Map (Reference' t h) (Set (TypeEdit' t o))))
-&gt; ((SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
    -&gt; Set (TypeEdit' t o) -&gt; f (Set (TypeEdit' t o)))
-&gt; (SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
-&gt; Map (Reference' t h) (Set (TypeEdit' t o))
-&gt; f (Map (Reference' t h) (Set (TypeEdit' t o)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TypeEdit' t o -&gt; f (TypeEdit' t o))
-&gt; Set (TypeEdit' t o) -&gt; f (Set (TypeEdit' t o))
forall (f :: * -&gt; *) b a.
(Applicative f, Ord b) =&gt;
(a -&gt; f b) -&gt; Set a -&gt; f (Set b)
</span><span class="hs-identifier hs-var">Set.traverse</span></span><span> </span><span class="annot"><span class="annottext">((TypeEdit' t o -&gt; f (TypeEdit' t o))
 -&gt; Set (TypeEdit' t o) -&gt; f (Set (TypeEdit' t o)))
-&gt; ((SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
    -&gt; TypeEdit' t o -&gt; f (TypeEdit' t o))
-&gt; (SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
-&gt; Set (TypeEdit' t o)
-&gt; f (Set (TypeEdit' t o))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
-&gt; TypeEdit' t o -&gt; f (TypeEdit' t o)
forall t h (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; TypeEdit' t h -&gt; f (TypeEdit' t h)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#typeEditRefs_"><span class="hs-identifier hs-var">typeEditRefs_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
 -&gt; Map (Reference' t h) (Set (TypeEdit' t o))
 -&gt; f (Map (Reference' t h) (Set (TypeEdit' t o))))
-&gt; (SomeReference (Id' o) -&gt; f (SomeReference (Id' o)))
-&gt; Map (Reference' t h) (Set (TypeEdit' t o))
-&gt; f (Map (Reference' t h) (Set (TypeEdit' t o)))
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' o) -&gt; f (SomeReference (Id' o))
</span><a href="#local-6989586621680538471"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-527"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Patch</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:termEdits:Patch :: Map (Referent'' t h) (Set (TermEdit' t o))
</span><span class="hs-identifier hs-var">termEdits</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Referent'' t h) (Set (TermEdit' t o))
</span><a href="#local-6989586621680538474"><span class="hs-identifier hs-var">newTermEdits</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:typeEdits:Patch :: Map (Reference' t h) (Set (TypeEdit' t o))
</span><span class="hs-identifier hs-var">typeEdits</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Reference' t h) (Set (TypeEdit' t o))
</span><a href="#local-6989586621680538477"><span class="hs-identifier hs-var">newTypeEdits</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-528"></span><span>
</span><span id="line-529"></span><span id="local-6989586621680536449"><span id="local-6989586621680536450"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#termEditRefs_"><span class="hs-identifier hs-type">termEditRefs_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TermEdit.TermEdit'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536450"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536449"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536449"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-530"></span><span id="termEditRefs_"><span class="annot"><span class="annottext">termEditRefs_ :: forall t h (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; TermEdit' t h -&gt; f (TermEdit' t h)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#termEditRefs_"><span class="hs-identifier hs-var hs-var">termEditRefs_</span></a></span></span><span> </span><span id="local-6989586621680538486"><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538486"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TermEdit.Replace</span></span><span> </span><span id="local-6989586621680538488"><span class="annot"><span class="annottext">Referent' t h
</span><a href="#local-6989586621680538488"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621680538489"><span class="annot"><span class="annottext">Typing
</span><a href="#local-6989586621680538489"><span class="hs-identifier hs-var">typing</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-531"></span><span>  </span><span class="annot"><span class="annottext">Referent' t h -&gt; Typing -&gt; TermEdit' t h
forall t h. Referent' t h -&gt; Typing -&gt; TermEdit' t h
</span><span class="hs-identifier hs-var">TermEdit.Replace</span></span><span> </span><span class="annot"><span class="annottext">(Referent' t h -&gt; Typing -&gt; TermEdit' t h)
-&gt; f (Referent' t h) -&gt; f (Typing -&gt; TermEdit' t h)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Referent' t h
</span><a href="#local-6989586621680538488"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Referent' t h
-&gt; (Referent' t h -&gt; f (Referent' t h)) -&gt; f (Referent' t h)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Referent' t h) (SomeReference (Id' h))
forall t h.
(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Referent'' t h) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferent_"><span class="hs-identifier hs-var">someReferent_</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTermReference_"><span class="hs-identifier hs-var">asTermReference_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
 -&gt; Referent' t h -&gt; f (Referent' t h))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; Referent' t h
-&gt; f (Referent' t h)
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538486"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f (Typing -&gt; TermEdit' t h) -&gt; f Typing -&gt; f (TermEdit' t h)
forall a b. f (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Typing -&gt; f Typing
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Typing
</span><a href="#local-6989586621680538489"><span class="hs-identifier hs-var">typing</span></a></span><span>
</span><span id="line-532"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#termEditRefs_"><span class="hs-identifier hs-var">termEditRefs_</span></a></span><span> </span><span id="local-6989586621680538492"><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538492"><span class="hs-identifier hs-var">_f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TermEdit' t h
</span><span class="hs-identifier hs-var">TermEdit.Deprecate</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TermEdit' t h -&gt; f (TermEdit' t h)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TermEdit' t h
forall t h. TermEdit' t h
</span><span class="hs-identifier hs-var">TermEdit.Deprecate</span></span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span id="local-6989586621680536451"><span id="local-6989586621680536452"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#typeEditRefs_"><span class="hs-identifier hs-type">typeEditRefs_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TypeEdit.TypeEdit'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536452"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536451"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536451"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-535"></span><span id="typeEditRefs_"><span class="annot"><span class="annottext">typeEditRefs_ :: forall t h (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; TypeEdit' t h -&gt; f (TypeEdit' t h)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#typeEditRefs_"><span class="hs-identifier hs-var hs-var">typeEditRefs_</span></a></span></span><span> </span><span id="local-6989586621680538499"><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538499"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TypeEdit.Replace</span></span><span> </span><span id="local-6989586621680538501"><span class="annot"><span class="annottext">Reference' t h
</span><a href="#local-6989586621680538501"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-536"></span><span>  </span><span class="annot"><span class="annottext">Reference' t h -&gt; TypeEdit' t h
forall t h. Reference' t h -&gt; TypeEdit' t h
</span><span class="hs-identifier hs-var">TypeEdit.Replace</span></span><span> </span><span class="annot"><span class="annottext">(Reference' t h -&gt; TypeEdit' t h)
-&gt; f (Reference' t h) -&gt; f (TypeEdit' t h)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference' t h
</span><a href="#local-6989586621680538501"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Reference' t h
-&gt; (Reference' t h -&gt; f (Reference' t h)) -&gt; f (Reference' t h)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Reference' t h) (SomeReference (Id' h))
forall t h.
(forall ref (f :: * -&gt; *).
 Applicative f =&gt;
 (SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref)
-&gt; Traversal' (Reference' t h) (SomeReference (Id' h))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReference_"><span class="hs-identifier hs-var">someReference_</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTypeReference_"><span class="hs-identifier hs-var">asTypeReference_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
 -&gt; Reference' t h -&gt; f (Reference' t h))
-&gt; (SomeReference (Id' h) -&gt; f (SomeReference (Id' h)))
-&gt; Reference' t h
-&gt; f (Reference' t h)
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538499"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#typeEditRefs_"><span class="hs-identifier hs-var">typeEditRefs_</span></a></span><span> </span><span id="local-6989586621680538504"><span class="annot"><span class="annottext">SomeReference (Id' h) -&gt; f (SomeReference (Id' h))
</span><a href="#local-6989586621680538504"><span class="hs-identifier hs-var">_f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeEdit' t h
</span><span class="hs-identifier hs-var">TypeEdit.Deprecate</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeEdit' t h -&gt; f (TypeEdit' t h)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TypeEdit' t h
forall t h. TypeEdit' t h
</span><span class="hs-identifier hs-var">TypeEdit.Deprecate</span></span><span>
</span><span id="line-538"></span><span>
</span><span id="line-539"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateTermComponent"><span class="hs-identifier hs-type">migrateTermComponent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-540"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span></span><span>
</span><span id="line-541"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-542"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">CodebaseOps.TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-543"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">CodebaseOps.DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-544"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Unison.Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-545"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sync.TrySyncResult</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-546"></span><span id="migrateTermComponent"><span class="annot"><span class="annottext">migrateTermComponent :: (Reference -&gt; Transaction ConstructorType)
-&gt; TVar (Map (New Hash) TermBufferEntry)
-&gt; TVar (Map (New Hash) DeclBufferEntry)
-&gt; New Hash
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateTermComponent"><span class="hs-identifier hs-var hs-var">migrateTermComponent</span></a></span></span><span> </span><span id="local-6989586621680538506"><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680538506"><span class="hs-identifier hs-var">getDeclType</span></a></span></span><span> </span><span id="local-6989586621680538507"><span class="annot"><span class="annottext">TVar (Map (New Hash) TermBufferEntry)
</span><a href="#local-6989586621680538507"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680538508"><span class="annot"><span class="annottext">TVar (Map (New Hash) DeclBufferEntry)
</span><a href="#local-6989586621680538508"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span id="local-6989586621680538509"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538509"><span class="hs-identifier hs-var">oldHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Either (TrySyncResult Entity) (TrySyncResult Entity)
 -&gt; TrySyncResult Entity)
-&gt; StateT
     MigrationState
     Transaction
     (Either (TrySyncResult Entity) (TrySyncResult Entity))
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall a b.
(a -&gt; b)
-&gt; StateT MigrationState Transaction a
-&gt; StateT MigrationState Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TrySyncResult Entity -&gt; TrySyncResult Entity)
-&gt; (TrySyncResult Entity -&gt; TrySyncResult Entity)
-&gt; Either (TrySyncResult Entity) (TrySyncResult Entity)
-&gt; TrySyncResult Entity
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity -&gt; TrySyncResult Entity
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity -&gt; TrySyncResult Entity
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT
   MigrationState
   Transaction
   (Either (TrySyncResult Entity) (TrySyncResult Entity))
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; (ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (TrySyncResult Entity)
    -&gt; StateT
         MigrationState
         Transaction
         (Either (TrySyncResult Entity) (TrySyncResult Entity)))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity)
  (StateT MigrationState Transaction)
  (TrySyncResult Entity)
-&gt; StateT
     MigrationState
     Transaction
     (Either (TrySyncResult Entity) (TrySyncResult Entity))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult Entity)
   (StateT MigrationState Transaction)
   (TrySyncResult Entity)
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-547"></span><span>  </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity) (StateT MigrationState Transaction) Bool
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">whenM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">New Hash -&gt; Set (New Hash) -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538509"><span class="hs-identifier hs-var">oldHash</span></a></span><span> </span><span class="annot"><span class="annottext">(Set (New Hash) -&gt; Bool)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Set (New Hash))
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Getting (Set (New Hash)) MigrationState (Set (New Hash))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Set (New Hash))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;migratedDefnHashes&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">throwE</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.PreviouslyDone</span></span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>
</span><span id="line-549"></span><span>  </span><span id="local-6989586621680538511"><span class="annot"><span class="annottext">[(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]
</span><a href="#local-6989586621680538511"><span class="hs-identifier hs-var">oldComponent</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-550"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateT
  MigrationState
  Transaction
  (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT
   MigrationState
   Transaction
   (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]))
-&gt; (Transaction
      (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
    -&gt; StateT
         MigrationState
         Transaction
         (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]))
-&gt; Transaction
     (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction
  (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
-&gt; StateT
     MigrationState
     Transaction
     (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction
   (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]))
-&gt; Transaction
     (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Reference -&gt; Transaction ConstructorType)
-&gt; New Hash
-&gt; Transaction
     (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTermComponentWithTypes"><span class="hs-identifier hs-var">CodebaseOps.getTermComponentWithTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Reference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680538506"><span class="hs-identifier hs-var">getDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538509"><span class="hs-identifier hs-var">oldHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity)
  (StateT MigrationState Transaction)
  (Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
-&gt; (Maybe
      [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]
    -&gt; ExceptT
         (TrySyncResult Entity)
         (StateT MigrationState Transaction)
         [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]
forall a b.
ExceptT
  (TrySyncResult Entity) (StateT MigrationState Transaction) a
-&gt; (a
    -&gt; ExceptT
         (TrySyncResult Entity) (StateT MigrationState Transaction) b)
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-551"></span><span>      </span><span class="annot"><span class="annottext">Maybe [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char]
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char]
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)])
-&gt; [Char]
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Hash was missing from codebase: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538509"><span class="hs-identifier hs-var">oldHash</span></a></span><span>
</span><span id="line-552"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680538513"><span class="annot"><span class="annottext">[(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]
</span><a href="#local-6989586621680538513"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]
forall a.
a
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]
</span><a href="#local-6989586621680538513"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538514"><span class="hs-identifier hs-type">componentIDMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term.Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-555"></span><span>      </span><span id="local-6989586621680538514"><span class="annot"><span class="annottext">componentIDMap :: Map
  (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538514"><span class="hs-identifier hs-var hs-var">componentIDMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Old Id,
  (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))]
-&gt; Map
     (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Old Id,
   (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))]
 -&gt; Map
      (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
-&gt; [(Old Id,
     (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))]
-&gt; Map
     (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">New Hash
-&gt; [(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]
-&gt; [(Old Id,
     (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))]
forall a. New Hash -&gt; [a] -&gt; [(Old Id, a)]
</span><span class="hs-identifier hs-var">Reference.componentFor</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538509"><span class="hs-identifier hs-var">oldHash</span></a></span><span> </span><span class="annot"><span class="annottext">[(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)]
</span><a href="#local-6989586621680538511"><span class="hs-identifier hs-var">oldComponent</span></a></span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538516"><span class="hs-identifier hs-type">unhashed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term.Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>      </span><span id="local-6989586621680538516"><span class="annot"><span class="annottext">unhashed :: Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538516"><span class="hs-identifier hs-var hs-var">unhashed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Old Id) (Term (DeclName Symbol) Ann)
-&gt; Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
forall v a.
Var v =&gt;
Map (Old Id) (Term v a) -&gt; Map (Old Id) (v, Term v a)
</span><span class="hs-identifier hs-var">Term.unhashComponent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; Term (DeclName Symbol) Ann
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
 -&gt; Term (DeclName Symbol) Ann)
-&gt; Map
     (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; Map (Old Id) (Term (DeclName Symbol) Ann)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map
  (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538514"><span class="hs-identifier hs-var">componentIDMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-558"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538519"><span class="hs-identifier hs-type">vToOldReferenceMapping</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-559"></span><span>      </span><span id="local-6989586621680538519"><span class="annot"><span class="annottext">vToOldReferenceMapping :: Map (DeclName Symbol) (Old Id)
</span><a href="#local-6989586621680538519"><span class="hs-identifier hs-var hs-var">vToOldReferenceMapping</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-560"></span><span>        </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538516"><span class="hs-identifier hs-var">unhashed</span></a></span><span>
</span><span id="line-561"></span><span>          </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
-&gt; (Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
    -&gt; [(Old Id, (DeclName Symbol, Term (DeclName Symbol) Ann))])
-&gt; [(Old Id, (DeclName Symbol, Term (DeclName Symbol) Ann))]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
-&gt; [(Old Id, (DeclName Symbol, Term (DeclName Symbol) Ann))]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span>
</span><span id="line-562"></span><span>          </span><span class="annot"><span class="annottext">[(Old Id, (DeclName Symbol, Term (DeclName Symbol) Ann))]
-&gt; ([(Old Id, (DeclName Symbol, Term (DeclName Symbol) Ann))]
    -&gt; [(DeclName Symbol, Old Id)])
-&gt; [(DeclName Symbol, Old Id)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((Old Id, (DeclName Symbol, Term (DeclName Symbol) Ann))
 -&gt; (DeclName Symbol, Old Id))
-&gt; [(Old Id, (DeclName Symbol, Term (DeclName Symbol) Ann))]
-&gt; [(DeclName Symbol, Old Id)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680538520"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538520"><span class="hs-identifier hs-var">refId</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680538521"><span class="annot"><span class="annottext">DeclName Symbol
</span><a href="#local-6989586621680538521"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538522"><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538522"><span class="hs-identifier hs-var">_trm</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DeclName Symbol
</span><a href="#local-6989586621680538521"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538520"><span class="hs-identifier hs-var">refId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-563"></span><span>          </span><span class="annot"><span class="annottext">[(DeclName Symbol, Old Id)]
-&gt; ([(DeclName Symbol, Old Id)] -&gt; Map (DeclName Symbol) (Old Id))
-&gt; Map (DeclName Symbol) (Old Id)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(DeclName Symbol, Old Id)] -&gt; Map (DeclName Symbol) (Old Id)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span>  </span><span id="local-6989586621680538523"><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538523"><span class="hs-identifier hs-var">referencesMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MigrationState -&gt; Map SomeReferenceId SomeReferenceId)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map SomeReferenceId SomeReferenceId)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">MigrationState -&gt; Map SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AreferenceMapping%3AMigrationState"><span class="hs-identifier hs-var">referenceMapping</span></a></span><span>
</span><span id="line-566"></span><span>
</span><span id="line-567"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538524"><span class="hs-identifier hs-type">allMissingReferences</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-568"></span><span>      </span><span id="local-6989586621680538524"><span class="annot"><span class="annottext">allMissingReferences :: [SomeReferenceId]
</span><a href="#local-6989586621680538524"><span class="hs-identifier hs-var hs-var">allMissingReferences</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-569"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538535"><span class="annot"><span class="annottext">missingTermRefs :: [SomeReferenceId]
</span><a href="#local-6989586621680538535"><span class="hs-identifier hs-var hs-var">missingTermRefs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-570"></span><span>              </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538516"><span class="hs-identifier hs-var">unhashed</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
-&gt; (Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
    -&gt; [SomeReferenceId])
-&gt; [SomeReferenceId]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike
  (WriterT [SomeReferenceId] Identity)
  (Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann))
  (Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann))
  SomeReferenceId
  SomeReferenceId
-&gt; Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
-&gt; [SomeReferenceId]
forall a s t. LensLike (Writer [a]) s t a a -&gt; s -&gt; [a]
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#foldSetter"><span class="hs-identifier hs-var">foldSetter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((DeclName Symbol, Term (DeclName Symbol) Ann)
 -&gt; WriterT
      [SomeReferenceId]
      Identity
      (DeclName Symbol, Term (DeclName Symbol) Ann))
-&gt; Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
-&gt; WriterT
     [SomeReferenceId]
     Identity
     (Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  (Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann))
  (Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann))
  (DeclName Symbol, Term (DeclName Symbol) Ann)
  (DeclName Symbol, Term (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">(((DeclName Symbol, Term (DeclName Symbol) Ann)
  -&gt; WriterT
       [SomeReferenceId]
       Identity
       (DeclName Symbol, Term (DeclName Symbol) Ann))
 -&gt; Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
 -&gt; WriterT
      [SomeReferenceId]
      Identity
      (Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)))
-&gt; ((SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
    -&gt; (DeclName Symbol, Term (DeclName Symbol) Ann)
    -&gt; WriterT
         [SomeReferenceId]
         Identity
         (DeclName Symbol, Term (DeclName Symbol) Ann))
-&gt; LensLike
     (WriterT [SomeReferenceId] Identity)
     (Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann))
     (Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann))
     SomeReferenceId
     SomeReferenceId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Term (DeclName Symbol) Ann
 -&gt; WriterT [SomeReferenceId] Identity (Term (DeclName Symbol) Ann))
-&gt; (DeclName Symbol, Term (DeclName Symbol) Ann)
-&gt; WriterT
     [SomeReferenceId]
     Identity
     (DeclName Symbol, Term (DeclName Symbol) Ann)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
Lens
  (DeclName Symbol, Term (DeclName Symbol) Ann)
  (DeclName Symbol, Term (DeclName Symbol) Ann)
  (Term (DeclName Symbol) Ann)
  (Term (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="annot"><span class="annottext">((Term (DeclName Symbol) Ann
  -&gt; WriterT [SomeReferenceId] Identity (Term (DeclName Symbol) Ann))
 -&gt; (DeclName Symbol, Term (DeclName Symbol) Ann)
 -&gt; WriterT
      [SomeReferenceId]
      Identity
      (DeclName Symbol, Term (DeclName Symbol) Ann))
-&gt; ((SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
    -&gt; Term (DeclName Symbol) Ann
    -&gt; WriterT [SomeReferenceId] Identity (Term (DeclName Symbol) Ann))
-&gt; (SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
-&gt; (DeclName Symbol, Term (DeclName Symbol) Ann)
-&gt; WriterT
     [SomeReferenceId]
     Identity
     (DeclName Symbol, Term (DeclName Symbol) Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
-&gt; Term (DeclName Symbol) Ann
-&gt; WriterT [SomeReferenceId] Identity (Term (DeclName Symbol) Ann)
forall (m :: * -&gt; *) v a.
(Monad m, Ord v) =&gt;
LensLike' m (Term v a) SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#termReferences_"><span class="hs-identifier hs-var">termReferences_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-571"></span><span>            </span><span id="local-6989586621680538546"><span class="annot"><span class="annottext">missingTypeRefs :: [SomeReferenceId]
</span><a href="#local-6989586621680538546"><span class="hs-identifier hs-var hs-var">missingTypeRefs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-572"></span><span>              </span><span class="annot"><span class="annottext">Map
  (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538514"><span class="hs-identifier hs-var">componentIDMap</span></a></span><span>
</span><span id="line-573"></span><span>                </span><span class="annot"><span class="annottext">Map
  (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; (Map
      (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
    -&gt; [SomeReferenceId])
-&gt; [SomeReferenceId]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike
  (WriterT [SomeReferenceId] Identity)
  (Map
     (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
  (Map
     (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
  SomeReferenceId
  SomeReferenceId
-&gt; Map
     (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; [SomeReferenceId]
forall a s t. LensLike (Writer [a]) s t a a -&gt; s -&gt; [a]
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#foldSetter"><span class="hs-identifier hs-var">foldSetter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
 -&gt; WriterT
      [SomeReferenceId]
      Identity
      (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
-&gt; Map
     (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; WriterT
     [SomeReferenceId]
     Identity
     (Map
        (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  (Map
     (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
  (Map
     (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
  (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
  (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">(((Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
  -&gt; WriterT
       [SomeReferenceId]
       Identity
       (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
 -&gt; Map
      (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
 -&gt; WriterT
      [SomeReferenceId]
      Identity
      (Map
         (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)))
-&gt; ((SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
    -&gt; (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
    -&gt; WriterT
         [SomeReferenceId]
         Identity
         (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
-&gt; LensLike
     (WriterT [SomeReferenceId] Identity)
     (Map
        (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
     (Map
        (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
     SomeReferenceId
     SomeReferenceId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Type (DeclName Symbol) Ann
 -&gt; WriterT [SomeReferenceId] Identity (Type (DeclName Symbol) Ann))
-&gt; (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; WriterT
     [SomeReferenceId]
     Identity
     (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
Lens
  (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
  (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
  (Type (DeclName Symbol) Ann)
  (Type (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="annot"><span class="annottext">((Type (DeclName Symbol) Ann
  -&gt; WriterT [SomeReferenceId] Identity (Type (DeclName Symbol) Ann))
 -&gt; (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
 -&gt; WriterT
      [SomeReferenceId]
      Identity
      (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
-&gt; ((SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
    -&gt; Type (DeclName Symbol) Ann
    -&gt; WriterT [SomeReferenceId] Identity (Type (DeclName Symbol) Ann))
-&gt; (SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
-&gt; (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; WriterT
     [SomeReferenceId]
     Identity
     (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
-&gt; Type (DeclName Symbol) Ann
-&gt; WriterT [SomeReferenceId] Identity (Type (DeclName Symbol) Ann)
forall (m :: * -&gt; *) v a.
(Monad m, Ord v) =&gt;
LensLike' m (Type v a) SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#typeReferences_"><span class="hs-identifier hs-var">typeReferences_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-574"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Bool) -&gt; [SomeReferenceId] -&gt; [SomeReferenceId]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeReferenceId -&gt; Map SomeReferenceId SomeReferenceId -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`Map.notMember`</span></span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538523"><span class="hs-identifier hs-var">referencesMap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SomeReferenceId]
</span><a href="#local-6989586621680538535"><span class="hs-identifier hs-var">missingTermRefs</span></a></span><span> </span><span class="annot"><span class="annottext">[SomeReferenceId] -&gt; [SomeReferenceId] -&gt; [SomeReferenceId]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SomeReferenceId]
</span><a href="#local-6989586621680538546"><span class="hs-identifier hs-var">missingTypeRefs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>
</span><span id="line-576"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; ([SomeReferenceId] -&gt; Bool) -&gt; [SomeReferenceId] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[SomeReferenceId] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([SomeReferenceId] -&gt; Bool) -&gt; [SomeReferenceId] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SomeReferenceId]
</span><a href="#local-6989586621680538524"><span class="hs-identifier hs-var">allMissingReferences</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult Entity) (StateT MigrationState Transaction) ()
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-577"></span><span>    </span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">throwE</span></span><span> </span><span class="annot"><span class="annottext">(TrySyncResult Entity
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-578"></span><span>      </span><span class="annot"><span class="annottext">[Entity] -&gt; TrySyncResult Entity
forall entity. [entity] -&gt; TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Missing</span></span><span> </span><span class="annot"><span class="annottext">([Entity] -&gt; TrySyncResult Entity)
-&gt; ([Entity] -&gt; [Entity]) -&gt; [Entity] -&gt; TrySyncResult Entity
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Entity] -&gt; [Entity]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">nubOrd</span></span><span> </span><span class="annot"><span class="annottext">([Entity] -&gt; TrySyncResult Entity)
-&gt; [Entity] -&gt; TrySyncResult Entity
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-579"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeReferenceId -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferenceIdToEntity"><span class="hs-identifier hs-var">someReferenceIdToEntity</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Entity) -&gt; [SomeReferenceId] -&gt; [Entity]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SomeReferenceId]
</span><a href="#local-6989586621680538524"><span class="hs-identifier hs-var">allMissingReferences</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-580"></span><span>
</span><span id="line-581"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538548"><span class="hs-identifier hs-type">getMigratedReference</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-type">New</span></a></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span>
</span><span id="line-582"></span><span>      </span><span id="local-6989586621680538548"><span class="annot"><span class="annottext">getMigratedReference :: SomeReferenceId -&gt; SomeReferenceId
</span><a href="#local-6989586621680538548"><span class="hs-identifier hs-var hs-var">getMigratedReference</span></a></span></span><span> </span><span id="local-6989586621680538549"><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538549"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-583"></span><span>        </span><span class="annot"><span class="annottext">SomeReferenceId
-&gt; SomeReferenceId
-&gt; Map SomeReferenceId SomeReferenceId
-&gt; SomeReferenceId
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">Map.findWithDefault</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; SomeReferenceId
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; SomeReferenceId) -&gt; [Char] -&gt; SomeReferenceId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;unmigrated reference&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538549"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538549"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538523"><span class="hs-identifier hs-var">referencesMap</span></a></span><span>
</span><span id="line-584"></span><span>
</span><span id="line-585"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538558"><span class="annot"><span class="annottext">Map
  (Old Id)
  (DeclName Symbol, Term (DeclName Symbol) Ann,
   Type (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538558"><span class="hs-identifier hs-var">remappedReferences</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term.Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-586"></span><span>        </span><span class="annot"><span class="annottext">((DeclName Symbol, Term (DeclName Symbol) Ann)
 -&gt; (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
 -&gt; (DeclName Symbol, Term (DeclName Symbol) Ann,
     Type (DeclName Symbol) Ann))
-&gt; Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
-&gt; Map
     (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; Map
     (Old Id)
     (DeclName Symbol, Term (DeclName Symbol) Ann,
      Type (DeclName Symbol) Ann)
forall a b c.
(a -&gt; b -&gt; c) -&gt; Map (Old Id) a -&gt; Map (Old Id) b -&gt; Map (Old Id) c
forall (f :: * -&gt; *) a b c.
Zip f =&gt;
(a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c
</span><span class="hs-identifier hs-var">Zip.zipWith</span></span><span>
</span><span id="line-587"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680538560"><span class="annot"><span class="annottext">DeclName Symbol
</span><a href="#local-6989586621680538560"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538561"><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538561"><span class="hs-identifier hs-var">trm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538562"><span class="annot"><span class="annottext">Type (DeclName Symbol) Ann
</span><a href="#local-6989586621680538562"><span class="hs-identifier hs-var">typ</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-588"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DeclName Symbol
</span><a href="#local-6989586621680538560"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-589"></span><span>                </span><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538561"><span class="hs-identifier hs-var">trm</span></a></span><span> </span><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
-&gt; (Term (DeclName Symbol) Ann -&gt; Term (DeclName Symbol) Ann)
-&gt; Term (DeclName Symbol) Ann
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' Identity (Term (DeclName Symbol) Ann) SomeReferenceId
forall (m :: * -&gt; *) v a.
(Monad m, Ord v) =&gt;
LensLike' m (Term v a) SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#termReferences_"><span class="hs-identifier hs-var">termReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">LensLike' Identity (Term (DeclName Symbol) Ann) SomeReferenceId
-&gt; (SomeReferenceId -&gt; SomeReferenceId)
-&gt; Term (DeclName Symbol) Ann
-&gt; Term (DeclName Symbol) Ann
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; SomeReferenceId
</span><a href="#local-6989586621680538548"><span class="hs-identifier hs-var">getMigratedReference</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-590"></span><span>                </span><span class="annot"><span class="annottext">Type (DeclName Symbol) Ann
</span><a href="#local-6989586621680538562"><span class="hs-identifier hs-var">typ</span></a></span><span> </span><span class="annot"><span class="annottext">Type (DeclName Symbol) Ann
-&gt; (Type (DeclName Symbol) Ann -&gt; Type (DeclName Symbol) Ann)
-&gt; Type (DeclName Symbol) Ann
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike' Identity (Type (DeclName Symbol) Ann) SomeReferenceId
forall (m :: * -&gt; *) v a.
(Monad m, Ord v) =&gt;
LensLike' m (Type v a) SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#typeReferences_"><span class="hs-identifier hs-var">typeReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">LensLike' Identity (Type (DeclName Symbol) Ann) SomeReferenceId
-&gt; (SomeReferenceId -&gt; SomeReferenceId)
-&gt; Type (DeclName Symbol) Ann
-&gt; Type (DeclName Symbol) Ann
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; SomeReferenceId
</span><a href="#local-6989586621680538548"><span class="hs-identifier hs-var">getMigratedReference</span></a></span><span>
</span><span id="line-591"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-592"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-593"></span><span>          </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Term (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538516"><span class="hs-identifier hs-var">unhashed</span></a></span><span>
</span><span id="line-594"></span><span>          </span><span class="annot"><span class="annottext">Map
  (Old Id) (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538514"><span class="hs-identifier hs-var">componentIDMap</span></a></span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538563"><span class="hs-identifier hs-type">newTermComponents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-type">New</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term.Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-597"></span><span>      </span><span id="local-6989586621680538563"><span class="annot"><span class="annottext">newTermComponents :: Map
  (DeclName Symbol)
  (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538563"><span class="hs-identifier hs-var hs-var">newTermComponents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-598"></span><span>        </span><span class="annot"><span class="annottext">Map
  (Old Id)
  (DeclName Symbol, Term (DeclName Symbol) Ann,
   Type (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538558"><span class="hs-identifier hs-var">remappedReferences</span></a></span><span>
</span><span id="line-599"></span><span>          </span><span class="annot"><span class="annottext">Map
  (Old Id)
  (DeclName Symbol, Term (DeclName Symbol) Ann,
   Type (DeclName Symbol) Ann)
-&gt; (Map
      (Old Id)
      (DeclName Symbol, Term (DeclName Symbol) Ann,
       Type (DeclName Symbol) Ann)
    -&gt; [(DeclName Symbol, Term (DeclName Symbol) Ann,
         Type (DeclName Symbol) Ann)])
-&gt; [(DeclName Symbol, Term (DeclName Symbol) Ann,
     Type (DeclName Symbol) Ann)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map
  (Old Id)
  (DeclName Symbol, Term (DeclName Symbol) Ann,
   Type (DeclName Symbol) Ann)
-&gt; [(DeclName Symbol, Term (DeclName Symbol) Ann,
     Type (DeclName Symbol) Ann)]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">Map.elems</span></span><span>
</span><span id="line-600"></span><span>          </span><span class="annot"><span class="annottext">[(DeclName Symbol, Term (DeclName Symbol) Ann,
  Type (DeclName Symbol) Ann)]
-&gt; ([(DeclName Symbol, Term (DeclName Symbol) Ann,
      Type (DeclName Symbol) Ann)]
    -&gt; [(DeclName Symbol,
         (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ()))])
-&gt; [(DeclName Symbol,
     (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ()))]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((DeclName Symbol, Term (DeclName Symbol) Ann,
  Type (DeclName Symbol) Ann)
 -&gt; (DeclName Symbol,
     (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ())))
-&gt; [(DeclName Symbol, Term (DeclName Symbol) Ann,
     Type (DeclName Symbol) Ann)]
-&gt; [(DeclName Symbol,
     (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ()))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680538565"><span class="annot"><span class="annottext">DeclName Symbol
</span><a href="#local-6989586621680538565"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538566"><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538566"><span class="hs-identifier hs-var">trm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538567"><span class="annot"><span class="annottext">Type (DeclName Symbol) Ann
</span><a href="#local-6989586621680538567"><span class="hs-identifier hs-var">typ</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DeclName Symbol
</span><a href="#local-6989586621680538565"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538566"><span class="hs-identifier hs-var">trm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type (DeclName Symbol) Ann
</span><a href="#local-6989586621680538567"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-601"></span><span>          </span><span class="annot"><span class="annottext">[(DeclName Symbol,
  (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ()))]
-&gt; ([(DeclName Symbol,
      (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ()))]
    -&gt; Map
         (DeclName Symbol)
         (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ()))
-&gt; Map
     (DeclName Symbol)
     (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ())
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(DeclName Symbol,
  (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ()))]
-&gt; Map
     (DeclName Symbol)
     (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ())
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span>
</span><span id="line-602"></span><span>          </span><span class="annot"><span class="annottext">Map
  (DeclName Symbol)
  (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ())
-&gt; (Map
      (DeclName Symbol)
      (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ())
    -&gt; Map
         (DeclName Symbol)
         (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann,
          ()))
-&gt; Map
     (DeclName Symbol)
     (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann,
      ())
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map
  (DeclName Symbol)
  (Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann, ())
-&gt; Map
     (DeclName Symbol)
     (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann,
      ())
forall v a extra.
Var v =&gt;
Map v (Term v a, Type v a, extra)
-&gt; Map v (Old Id, Term v a, Type v a, extra)
</span><a href="Unison.Hashing.V2.Convert.html#hashTermComponents"><span class="hs-identifier hs-var">Convert.hashTermComponents</span></a></span><span>
</span><span id="line-603"></span><span>          </span><span class="annot"><span class="annottext">Map
  (DeclName Symbol)
  (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann,
   ())
-&gt; (Map
      (DeclName Symbol)
      (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann,
       ())
    -&gt; Map
         (DeclName Symbol)
         (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
-&gt; Map
     (DeclName Symbol)
     (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann,
  ())
 -&gt; (Old Id, Term (DeclName Symbol) Ann,
     Type (DeclName Symbol) Ann))
-&gt; Map
     (DeclName Symbol)
     (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann,
      ())
-&gt; Map
     (DeclName Symbol)
     (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
forall a b.
(a -&gt; b) -&gt; Map (DeclName Symbol) a -&gt; Map (DeclName Symbol) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680538569"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538569"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538570"><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538570"><span class="hs-identifier hs-var">trm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538571"><span class="annot"><span class="annottext">Type (DeclName Symbol) Ann
</span><a href="#local-6989586621680538571"><span class="hs-identifier hs-var">typ</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538569"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538570"><span class="hs-identifier hs-var">trm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type (DeclName Symbol) Ann
</span><a href="#local-6989586621680538571"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-604"></span><span>
</span><span id="line-605"></span><span>  </span><span class="annot"><span class="annottext">Map
  (DeclName Symbol)
  (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; (DeclName Symbol
    -&gt; (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
    -&gt; ExceptT
         (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map (DeclName Symbol) ())
forall i (t :: * -&gt; *) (f :: * -&gt; *) a b.
(TraversableWithIndex i t, Applicative f) =&gt;
t a -&gt; (i -&gt; a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">ifor</span></span><span> </span><span class="annot"><span class="annottext">Map
  (DeclName Symbol)
  (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538563"><span class="hs-identifier hs-var">newTermComponents</span></a></span><span> </span><span class="annot"><span class="annottext">((DeclName Symbol
  -&gt; (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
  -&gt; ExceptT
       (TrySyncResult Entity) (StateT MigrationState Transaction) ())
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (Map (DeclName Symbol) ()))
-&gt; (DeclName Symbol
    -&gt; (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
    -&gt; ExceptT
         (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map (DeclName Symbol) ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680538573"><span class="annot"><span class="annottext">DeclName Symbol
</span><a href="#local-6989586621680538573"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680538574"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538574"><span class="hs-identifier hs-var">newReferenceId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538575"><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538575"><span class="hs-identifier hs-var">trm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538576"><span class="annot"><span class="annottext">Type (DeclName Symbol) Ann
</span><a href="#local-6989586621680538576"><span class="hs-identifier hs-var">typ</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-606"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538577"><span class="annot"><span class="annottext">oldReferenceId :: Old Id
</span><a href="#local-6989586621680538577"><span class="hs-identifier hs-var hs-var">oldReferenceId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (DeclName Symbol) (Old Id)
</span><a href="#local-6989586621680538519"><span class="hs-identifier hs-var">vToOldReferenceMapping</span></a></span><span> </span><span class="annot"><span class="annottext">Map (DeclName Symbol) (Old Id)
-&gt; Getting
     (Endo (Old Id)) (Map (DeclName Symbol) (Old Id)) (Old Id)
-&gt; Old Id
forall s a. HasCallStack =&gt; s -&gt; Getting (Endo a) s a -&gt; a
</span><span class="hs-operator hs-var">^?!</span></span><span> </span><span class="annot"><span class="annottext">Index (Map (DeclName Symbol) (Old Id))
-&gt; Traversal'
     (Map (DeclName Symbol) (Old Id))
     (IxValue (Map (DeclName Symbol) (Old Id)))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (Map (DeclName Symbol) (Old Id))
DeclName Symbol
</span><a href="#local-6989586621680538573"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-607"></span><span>    </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;referenceMapping&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Map SomeReferenceId SomeReferenceId
  -&gt; Identity (Map SomeReferenceId SomeReferenceId))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; (Map SomeReferenceId SomeReferenceId
    -&gt; Map SomeReferenceId SomeReferenceId)
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; (a -&gt; b) -&gt; m ()
</span><span class="hs-operator hs-var">%=</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
-&gt; SomeReferenceId
-&gt; Map SomeReferenceId SomeReferenceId
-&gt; Map SomeReferenceId SomeReferenceId
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; SomeReferenceId
forall ref. ref -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermReference"><span class="hs-identifier hs-var">TermReference</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538577"><span class="hs-identifier hs-var">oldReferenceId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; SomeReferenceId
forall ref. ref -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermReference"><span class="hs-identifier hs-var">TermReference</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538574"><span class="hs-identifier hs-var">newReferenceId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-608"></span><span>    </span><span class="annot"><span class="annottext">StateT MigrationState Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction ()
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; (Transaction () -&gt; StateT MigrationState Transaction ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction () -&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) TermBufferEntry)
-&gt; TVar (Map (New Hash) DeclBufferEntry)
-&gt; Old Id
-&gt; Term (DeclName Symbol) Ann
-&gt; Type (DeclName Symbol) Ann
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTerm"><span class="hs-identifier hs-var">CodebaseOps.putTerm</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) TermBufferEntry)
</span><a href="#local-6989586621680538507"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) DeclBufferEntry)
</span><a href="#local-6989586621680538508"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538574"><span class="hs-identifier hs-var">newReferenceId</span></a></span><span> </span><span class="annot"><span class="annottext">Term (DeclName Symbol) Ann
</span><a href="#local-6989586621680538575"><span class="hs-identifier hs-var">trm</span></a></span><span> </span><span class="annot"><span class="annottext">Type (DeclName Symbol) Ann
</span><a href="#local-6989586621680538576"><span class="hs-identifier hs-var">typ</span></a></span><span>
</span><span id="line-609"></span><span>
</span><span id="line-610"></span><span>  </span><span class="hs-comment">-- Need to get one of the new references to grab its hash, doesn't matter which one since</span><span>
</span><span id="line-611"></span><span>  </span><span class="hs-comment">-- all hashes in the component are the same.</span><span>
</span><span id="line-612"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Map
  (DeclName Symbol)
  (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538563"><span class="hs-identifier hs-var">newTermComponents</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  (DeclName Symbol)
  (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; Getting
     (First (New Hash))
     (Map
        (DeclName Symbol)
        (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
     (New Hash)
-&gt; Maybe (New Hash)
forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><span class="hs-operator hs-var">^?</span></span><span> </span><span class="annot"><span class="annottext">((Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
 -&gt; Const
      (First (New Hash))
      (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
-&gt; Map
     (DeclName Symbol)
     (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; Const
     (First (New Hash))
     (Map
        (DeclName Symbol)
        (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  (Map
     (DeclName Symbol)
     (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
  (Map
     (DeclName Symbol)
     (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
  (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
  (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">(((Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
  -&gt; Const
       (First (New Hash))
       (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
 -&gt; Map
      (DeclName Symbol)
      (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
 -&gt; Const
      (First (New Hash))
      (Map
         (DeclName Symbol)
         (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)))
-&gt; ((New Hash -&gt; Const (First (New Hash)) (New Hash))
    -&gt; (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
    -&gt; Const
         (First (New Hash))
         (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
-&gt; Getting
     (First (New Hash))
     (Map
        (DeclName Symbol)
        (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
     (New Hash)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Old Id -&gt; Const (First (New Hash)) (Old Id))
-&gt; (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; Const
     (First (New Hash))
     (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
forall s t a b. Field1 s t a b =&gt; Lens s t a b
Lens
  (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
  (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
  (Old Id)
  (Old Id)
</span><span class="hs-identifier hs-var">_1</span></span><span> </span><span class="annot"><span class="annottext">((Old Id -&gt; Const (First (New Hash)) (Old Id))
 -&gt; (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
 -&gt; Const
      (First (New Hash))
      (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann))
-&gt; ((New Hash -&gt; Const (First (New Hash)) (New Hash))
    -&gt; Old Id -&gt; Const (First (New Hash)) (Old Id))
-&gt; (New Hash -&gt; Const (First (New Hash)) (New Hash))
-&gt; (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
-&gt; Const
     (First (New Hash))
     (Old Id, Term (DeclName Symbol) Ann, Type (DeclName Symbol) Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Old Id -&gt; New Hash)
-&gt; (New Hash -&gt; Const (First (New Hash)) (New Hash))
-&gt; Old Id
-&gt; Const (First (New Hash)) (Old Id)
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Old Id -&gt; New Hash
</span><span class="hs-identifier hs-var">Reference.idToHash</span></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-613"></span><span>    </span><span class="annot"><span class="annottext">Maybe (New Hash)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall a.
a
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680538581"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538581"><span class="hs-identifier hs-var">newHash</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">New Hash -&gt; New Hash -&gt; StateT MigrationState Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#insertObjectMappingForHash"><span class="hs-identifier hs-var">insertObjectMappingForHash</span></a></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538509"><span class="hs-identifier hs-var">oldHash</span></a></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538581"><span class="hs-identifier hs-var">newHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-615"></span><span>
</span><span id="line-616"></span><span>  </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;migratedDefnHashes&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Set (New Hash) -&gt; Identity (Set (New Hash)))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; (Set (New Hash) -&gt; Set (New Hash))
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; (a -&gt; b) -&gt; m ()
</span><span class="hs-operator hs-var">%=</span></span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Set (New Hash) -&gt; Set (New Hash)
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.insert</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538509"><span class="hs-identifier hs-var">oldHash</span></a></span><span>
</span><span id="line-617"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Done</span></span><span>
</span><span id="line-618"></span><span>
</span><span id="line-619"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateDeclComponent"><span class="hs-identifier hs-type">migrateDeclComponent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-620"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">CodebaseOps.TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-621"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">CodebaseOps.DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-622"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Unison.Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-623"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sync.TrySyncResult</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-624"></span><span id="migrateDeclComponent"><span class="annot"><span class="annottext">migrateDeclComponent :: TVar (Map (New Hash) TermBufferEntry)
-&gt; TVar (Map (New Hash) DeclBufferEntry)
-&gt; New Hash
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#migrateDeclComponent"><span class="hs-identifier hs-var hs-var">migrateDeclComponent</span></a></span></span><span> </span><span id="local-6989586621680538584"><span class="annot"><span class="annottext">TVar (Map (New Hash) TermBufferEntry)
</span><a href="#local-6989586621680538584"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680538585"><span class="annot"><span class="annottext">TVar (Map (New Hash) DeclBufferEntry)
</span><a href="#local-6989586621680538585"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span id="local-6989586621680538586"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538586"><span class="hs-identifier hs-var">oldHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Either (TrySyncResult Entity) (TrySyncResult Entity)
 -&gt; TrySyncResult Entity)
-&gt; StateT
     MigrationState
     Transaction
     (Either (TrySyncResult Entity) (TrySyncResult Entity))
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall a b.
(a -&gt; b)
-&gt; StateT MigrationState Transaction a
-&gt; StateT MigrationState Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TrySyncResult Entity -&gt; TrySyncResult Entity)
-&gt; (TrySyncResult Entity -&gt; TrySyncResult Entity)
-&gt; Either (TrySyncResult Entity) (TrySyncResult Entity)
-&gt; TrySyncResult Entity
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity -&gt; TrySyncResult Entity
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity -&gt; TrySyncResult Entity
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT
   MigrationState
   Transaction
   (Either (TrySyncResult Entity) (TrySyncResult Entity))
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; (ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (TrySyncResult Entity)
    -&gt; StateT
         MigrationState
         Transaction
         (Either (TrySyncResult Entity) (TrySyncResult Entity)))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity)
  (StateT MigrationState Transaction)
  (TrySyncResult Entity)
-&gt; StateT
     MigrationState
     Transaction
     (Either (TrySyncResult Entity) (TrySyncResult Entity))
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult Entity)
   (StateT MigrationState Transaction)
   (TrySyncResult Entity)
 -&gt; StateT MigrationState Transaction (TrySyncResult Entity))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (TrySyncResult Entity)
-&gt; StateT MigrationState Transaction (TrySyncResult Entity)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-625"></span><span>  </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity) (StateT MigrationState Transaction) Bool
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">whenM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">New Hash -&gt; Set (New Hash) -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538586"><span class="hs-identifier hs-var">oldHash</span></a></span><span> </span><span class="annot"><span class="annottext">(Set (New Hash) -&gt; Bool)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Set (New Hash))
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Getting (Set (New Hash)) MigrationState (Set (New Hash))
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Set (New Hash))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;migratedDefnHashes&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">throwE</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.PreviouslyDone</span></span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>
</span><span id="line-627"></span><span>  </span><span id="local-6989586621680538587"><span id="local-6989586621680538588"><span id="local-6989586621680538589"><span class="annot"><span class="annottext">[Decl (DeclName Symbol) Ann]
</span><a href="#local-6989586621680538589"><span class="hs-identifier hs-var">declComponent</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">DD.Decl</span></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538588"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-628"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateT
  MigrationState Transaction (Maybe [Decl (DeclName Symbol) Ann])
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Maybe [Decl (DeclName Symbol) Ann])
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT
   MigrationState Transaction (Maybe [Decl (DeclName Symbol) Ann])
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (Maybe [Decl (DeclName Symbol) Ann]))
-&gt; (Transaction (Maybe [Decl (DeclName Symbol) Ann])
    -&gt; StateT
         MigrationState Transaction (Maybe [Decl (DeclName Symbol) Ann]))
-&gt; Transaction (Maybe [Decl (DeclName Symbol) Ann])
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Maybe [Decl (DeclName Symbol) Ann])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe [Decl (DeclName Symbol) Ann])
-&gt; StateT
     MigrationState Transaction (Maybe [Decl (DeclName Symbol) Ann])
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (Maybe [Decl (DeclName Symbol) Ann])
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      (Maybe [Decl (DeclName Symbol) Ann]))
-&gt; Transaction (Maybe [Decl (DeclName Symbol) Ann])
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Maybe [Decl (DeclName Symbol) Ann])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Transaction (Maybe [Decl (DeclName Symbol) Ann])
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getDeclComponent"><span class="hs-identifier hs-var">CodebaseOps.getDeclComponent</span></a></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538586"><span class="hs-identifier hs-var">oldHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult Entity)
  (StateT MigrationState Transaction)
  (Maybe [Decl (DeclName Symbol) Ann])
-&gt; (Maybe [Decl (DeclName Symbol) Ann]
    -&gt; ExceptT
         (TrySyncResult Entity)
         (StateT MigrationState Transaction)
         [Decl (DeclName Symbol) Ann])
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     [Decl (DeclName Symbol) Ann]
forall a b.
ExceptT
  (TrySyncResult Entity) (StateT MigrationState Transaction) a
-&gt; (a
    -&gt; ExceptT
         (TrySyncResult Entity) (StateT MigrationState Transaction) b)
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-629"></span><span>      </span><span class="annot"><span class="annottext">Maybe [Decl (DeclName Symbol) Ann]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char]
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     [Decl (DeclName Symbol) Ann]
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char]
 -&gt; ExceptT
      (TrySyncResult Entity)
      (StateT MigrationState Transaction)
      [Decl (DeclName Symbol) Ann])
-&gt; [Char]
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     [Decl (DeclName Symbol) Ann]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Expected decl component for hash:&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538586"><span class="hs-identifier hs-var">oldHash</span></a></span><span>
</span><span id="line-630"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680538591"><span class="annot"><span class="annottext">[Decl (DeclName Symbol) Ann]
</span><a href="#local-6989586621680538591"><span class="hs-identifier hs-var">dc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Decl (DeclName Symbol) Ann]
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     [Decl (DeclName Symbol) Ann]
forall a.
a
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[Decl (DeclName Symbol) Ann]
</span><a href="#local-6989586621680538591"><span class="hs-identifier hs-var">dc</span></a></span><span>
</span><span id="line-631"></span><span>
</span><span id="line-632"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538592"><span class="hs-identifier hs-type">componentIDMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DD.Decl</span></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538588"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-633"></span><span>      </span><span id="local-6989586621680538592"><span class="annot"><span class="annottext">componentIDMap :: Map (Old Id) (Decl (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538592"><span class="hs-identifier hs-var hs-var">componentIDMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Old Id, Decl (DeclName Symbol) Ann)]
-&gt; Map (Old Id) (Decl (DeclName Symbol) Ann)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Old Id, Decl (DeclName Symbol) Ann)]
 -&gt; Map (Old Id) (Decl (DeclName Symbol) Ann))
-&gt; [(Old Id, Decl (DeclName Symbol) Ann)]
-&gt; Map (Old Id) (Decl (DeclName Symbol) Ann)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">New Hash
-&gt; [Decl (DeclName Symbol) Ann]
-&gt; [(Old Id, Decl (DeclName Symbol) Ann)]
forall a. New Hash -&gt; [a] -&gt; [(Old Id, a)]
</span><span class="hs-identifier hs-var">Reference.componentFor</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538586"><span class="hs-identifier hs-var">oldHash</span></a></span><span> </span><span class="annot"><span class="annottext">[Decl (DeclName Symbol) Ann]
</span><a href="#local-6989586621680538589"><span class="hs-identifier hs-var">declComponent</span></a></span><span>
</span><span id="line-634"></span><span>
</span><span id="line-635"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538593"><span class="hs-identifier hs-type">unhashed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#DeclName"><span class="hs-identifier hs-type">DeclName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DD.Decl</span></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538588"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-636"></span><span>      </span><span id="local-6989586621680538593"><span class="annot"><span class="annottext">unhashed :: Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538593"><span class="hs-identifier hs-var hs-var">unhashed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (Old Id) (Decl (DeclName Symbol) Ann)
-&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
forall v a.
Var v =&gt;
Map (Old Id) (Decl v a) -&gt; Map (Old Id) (v, Decl v a)
</span><span class="hs-identifier hs-var">DD.unhashComponent</span></span><span> </span><span class="annot"><span class="annottext">Map (Old Id) (Decl (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538592"><span class="hs-identifier hs-var">componentIDMap</span></a></span><span>
</span><span id="line-637"></span><span>
</span><span id="line-638"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538595"><span class="hs-identifier hs-type">allTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538588"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-639"></span><span>      </span><span id="local-6989586621680538595"><span class="annot"><span class="annottext">allTypes :: [Type (DeclName Symbol) Ann]
</span><a href="#local-6989586621680538595"><span class="hs-identifier hs-var hs-var">allTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-640"></span><span>        </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538593"><span class="hs-identifier hs-var">unhashed</span></a></span><span>
</span><span id="line-641"></span><span>          </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; Getting
     (Endo [Type (DeclName Symbol) Ann])
     (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann))
     (Type (DeclName Symbol) Ann)
-&gt; [Type (DeclName Symbol) Ann]
forall s a. s -&gt; Getting (Endo [a]) s a -&gt; [a]
</span><span class="hs-operator hs-var">^..</span></span><span> </span><span class="annot"><span class="annottext">((DeclName Symbol, Decl (DeclName Symbol) Ann)
 -&gt; Const
      (Endo [Type (DeclName Symbol) Ann])
      (DeclName Symbol, Decl (DeclName Symbol) Ann))
-&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; Const
     (Endo [Type (DeclName Symbol) Ann])
     (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann))
  (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann))
  (DeclName Symbol, Decl (DeclName Symbol) Ann)
  (DeclName Symbol, Decl (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">traversed</span></span><span>
</span><span id="line-642"></span><span>            </span><span class="annot"><span class="annottext">(((DeclName Symbol, Decl (DeclName Symbol) Ann)
  -&gt; Const
       (Endo [Type (DeclName Symbol) Ann])
       (DeclName Symbol, Decl (DeclName Symbol) Ann))
 -&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
 -&gt; Const
      (Endo [Type (DeclName Symbol) Ann])
      (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)))
-&gt; ((Type (DeclName Symbol) Ann
     -&gt; Const
          (Endo [Type (DeclName Symbol) Ann]) (Type (DeclName Symbol) Ann))
    -&gt; (DeclName Symbol, Decl (DeclName Symbol) Ann)
    -&gt; Const
         (Endo [Type (DeclName Symbol) Ann])
         (DeclName Symbol, Decl (DeclName Symbol) Ann))
-&gt; Getting
     (Endo [Type (DeclName Symbol) Ann])
     (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann))
     (Type (DeclName Symbol) Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Decl (DeclName Symbol) Ann
 -&gt; Const
      (Endo [Type (DeclName Symbol) Ann]) (Decl (DeclName Symbol) Ann))
-&gt; (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; Const
     (Endo [Type (DeclName Symbol) Ann])
     (DeclName Symbol, Decl (DeclName Symbol) Ann)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
Lens
  (DeclName Symbol, Decl (DeclName Symbol) Ann)
  (DeclName Symbol, Decl (DeclName Symbol) Ann)
  (Decl (DeclName Symbol) Ann)
  (Decl (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">_2</span></span><span>
</span><span id="line-643"></span><span>            </span><span class="annot"><span class="annottext">((Decl (DeclName Symbol) Ann
  -&gt; Const
       (Endo [Type (DeclName Symbol) Ann]) (Decl (DeclName Symbol) Ann))
 -&gt; (DeclName Symbol, Decl (DeclName Symbol) Ann)
 -&gt; Const
      (Endo [Type (DeclName Symbol) Ann])
      (DeclName Symbol, Decl (DeclName Symbol) Ann))
-&gt; ((Type (DeclName Symbol) Ann
     -&gt; Const
          (Endo [Type (DeclName Symbol) Ann]) (Type (DeclName Symbol) Ann))
    -&gt; Decl (DeclName Symbol) Ann
    -&gt; Const
         (Endo [Type (DeclName Symbol) Ann]) (Decl (DeclName Symbol) Ann))
-&gt; (Type (DeclName Symbol) Ann
    -&gt; Const
         (Endo [Type (DeclName Symbol) Ann]) (Type (DeclName Symbol) Ann))
-&gt; (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; Const
     (Endo [Type (DeclName Symbol) Ann])
     (DeclName Symbol, Decl (DeclName Symbol) Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Optical
  (-&gt;)
  (-&gt;)
  (Const (Endo [Type (DeclName Symbol) Ann]))
  (EffectDeclaration (DeclName Symbol) Ann)
  (EffectDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
-&gt; Optical
     (-&gt;)
     (-&gt;)
     (Const (Endo [Type (DeclName Symbol) Ann]))
     (DataDeclaration (DeclName Symbol) Ann)
     (DataDeclaration (DeclName Symbol) Ann)
     (DataDeclaration (DeclName Symbol) Ann)
     (DataDeclaration (DeclName Symbol) Ann)
-&gt; (DataDeclaration (DeclName Symbol) Ann
    -&gt; Const
         (Endo [Type (DeclName Symbol) Ann])
         (DataDeclaration (DeclName Symbol) Ann))
-&gt; Decl (DeclName Symbol) Ann
-&gt; Const
     (Endo [Type (DeclName Symbol) Ann]) (Decl (DeclName Symbol) Ann)
forall (q :: * -&gt; * -&gt; *) (f :: * -&gt; *) (r :: * -&gt; * -&gt; *)
       (p :: * -&gt; * -&gt; *) s t a b s' t'.
(Representable q, Applicative (Rep q), Applicative f,
 Bitraversable r) =&gt;
Optical p q f s t a b
-&gt; Optical p q f s' t' a b -&gt; Optical p q f (r s s') (r t t') a b
</span><span class="hs-identifier hs-var">beside</span></span><span> </span><span class="annot"><span class="annottext">Optical
  (-&gt;)
  (-&gt;)
  (Const (Endo [Type (DeclName Symbol) Ann]))
  (EffectDeclaration (DeclName Symbol) Ann)
  (EffectDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
forall v a (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Profunctor p, Functor f) =&gt;
p (DataDeclaration v a) (f (DataDeclaration v a))
-&gt; p (EffectDeclaration v a) (f (EffectDeclaration v a))
</span><span class="hs-identifier hs-var">DD.asDataDecl_</span></span><span> </span><span class="annot"><span class="annottext">Optical
  (-&gt;)
  (-&gt;)
  (Const (Endo [Type (DeclName Symbol) Ann]))
  (DataDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-644"></span><span>            </span><span class="annot"><span class="annottext">((DataDeclaration (DeclName Symbol) Ann
  -&gt; Const
       (Endo [Type (DeclName Symbol) Ann])
       (DataDeclaration (DeclName Symbol) Ann))
 -&gt; Decl (DeclName Symbol) Ann
 -&gt; Const
      (Endo [Type (DeclName Symbol) Ann]) (Decl (DeclName Symbol) Ann))
-&gt; ((Type (DeclName Symbol) Ann
     -&gt; Const
          (Endo [Type (DeclName Symbol) Ann]) (Type (DeclName Symbol) Ann))
    -&gt; DataDeclaration (DeclName Symbol) Ann
    -&gt; Const
         (Endo [Type (DeclName Symbol) Ann])
         (DataDeclaration (DeclName Symbol) Ann))
-&gt; (Type (DeclName Symbol) Ann
    -&gt; Const
         (Endo [Type (DeclName Symbol) Ann]) (Type (DeclName Symbol) Ann))
-&gt; Decl (DeclName Symbol) Ann
-&gt; Const
     (Endo [Type (DeclName Symbol) Ann]) (Decl (DeclName Symbol) Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(DataDeclaration (DeclName Symbol) Ann
 -&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)])
-&gt; Optic'
     (-&gt;)
     (Const (Endo [Type (DeclName Symbol) Ann]))
     (DataDeclaration (DeclName Symbol) Ann)
     [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration (DeclName Symbol) Ann
-&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
forall v a. DataDeclaration v a -&gt; [(a, v, Type v a)]
</span><span class="hs-identifier hs-var">DD.constructors'</span></span><span>
</span><span id="line-645"></span><span>            </span><span class="annot"><span class="annottext">Optic'
  (-&gt;)
  (Const (Endo [Type (DeclName Symbol) Ann]))
  (DataDeclaration (DeclName Symbol) Ann)
  [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
-&gt; ((Type (DeclName Symbol) Ann
     -&gt; Const
          (Endo [Type (DeclName Symbol) Ann]) (Type (DeclName Symbol) Ann))
    -&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
    -&gt; Const
         (Endo [Type (DeclName Symbol) Ann])
         [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)])
-&gt; (Type (DeclName Symbol) Ann
    -&gt; Const
         (Endo [Type (DeclName Symbol) Ann]) (Type (DeclName Symbol) Ann))
-&gt; DataDeclaration (DeclName Symbol) Ann
-&gt; Const
     (Endo [Type (DeclName Symbol) Ann])
     (DataDeclaration (DeclName Symbol) Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
 -&gt; Const
      (Endo [Type (DeclName Symbol) Ann])
      (Ann, DeclName Symbol, Type (DeclName Symbol) Ann))
-&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
-&gt; Const
     (Endo [Type (DeclName Symbol) Ann])
     [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
  [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
  (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
  (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">traversed</span></span><span>
</span><span id="line-646"></span><span>            </span><span class="annot"><span class="annottext">(((Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
  -&gt; Const
       (Endo [Type (DeclName Symbol) Ann])
       (Ann, DeclName Symbol, Type (DeclName Symbol) Ann))
 -&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
 -&gt; Const
      (Endo [Type (DeclName Symbol) Ann])
      [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)])
-&gt; ((Type (DeclName Symbol) Ann
     -&gt; Const
          (Endo [Type (DeclName Symbol) Ann]) (Type (DeclName Symbol) Ann))
    -&gt; (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
    -&gt; Const
         (Endo [Type (DeclName Symbol) Ann])
         (Ann, DeclName Symbol, Type (DeclName Symbol) Ann))
-&gt; (Type (DeclName Symbol) Ann
    -&gt; Const
         (Endo [Type (DeclName Symbol) Ann]) (Type (DeclName Symbol) Ann))
-&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
-&gt; Const
     (Endo [Type (DeclName Symbol) Ann])
     [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Type (DeclName Symbol) Ann
 -&gt; Const
      (Endo [Type (DeclName Symbol) Ann]) (Type (DeclName Symbol) Ann))
-&gt; (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
-&gt; Const
     (Endo [Type (DeclName Symbol) Ann])
     (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
forall s t a b. Field3 s t a b =&gt; Lens s t a b
Lens
  (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
  (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
  (Type (DeclName Symbol) Ann)
  (Type (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">_3</span></span><span>
</span><span id="line-647"></span><span>
</span><span id="line-648"></span><span>  </span><span id="local-6989586621680538599"><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538599"><span class="hs-identifier hs-var">migratedReferences</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(MigrationState -&gt; Map SomeReferenceId SomeReferenceId)
-&gt; ExceptT
     (TrySyncResult Entity)
     (StateT MigrationState Transaction)
     (Map SomeReferenceId SomeReferenceId)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">MigrationState -&gt; Map SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#%24sel%3AreferenceMapping%3AMigrationState"><span class="hs-identifier hs-var">referenceMapping</span></a></span><span>
</span><span id="line-649"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538600"><span class="hs-identifier hs-type">unmigratedRefIds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-650"></span><span>      </span><span id="local-6989586621680538600"><span class="annot"><span class="annottext">unmigratedRefIds :: [SomeReferenceId]
</span><a href="#local-6989586621680538600"><span class="hs-identifier hs-var hs-var">unmigratedRefIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-651"></span><span>        </span><span class="annot"><span class="annottext">[Type (DeclName Symbol) Ann]
</span><a href="#local-6989586621680538595"><span class="hs-identifier hs-var">allTypes</span></a></span><span>
</span><span id="line-652"></span><span>          </span><span class="annot"><span class="annottext">[Type (DeclName Symbol) Ann]
-&gt; ([Type (DeclName Symbol) Ann] -&gt; [SomeReferenceId])
-&gt; [SomeReferenceId]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike
  (WriterT [SomeReferenceId] Identity)
  [Type (DeclName Symbol) Ann]
  [Type (DeclName Symbol) Ann]
  SomeReferenceId
  SomeReferenceId
-&gt; [Type (DeclName Symbol) Ann] -&gt; [SomeReferenceId]
forall a s t. LensLike (Writer [a]) s t a a -&gt; s -&gt; [a]
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#foldSetter"><span class="hs-identifier hs-var">foldSetter</span></a></span><span>
</span><span id="line-653"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(Type (DeclName Symbol) Ann
 -&gt; WriterT [SomeReferenceId] Identity (Type (DeclName Symbol) Ann))
-&gt; [Type (DeclName Symbol) Ann]
-&gt; WriterT [SomeReferenceId] Identity [Type (DeclName Symbol) Ann]
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  [Type (DeclName Symbol) Ann]
  [Type (DeclName Symbol) Ann]
  (Type (DeclName Symbol) Ann)
  (Type (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="hs-comment">-- Every type in the list</span><span>
</span><span id="line-654"></span><span>                </span><span class="annot"><span class="annottext">((Type (DeclName Symbol) Ann
  -&gt; WriterT [SomeReferenceId] Identity (Type (DeclName Symbol) Ann))
 -&gt; [Type (DeclName Symbol) Ann]
 -&gt; WriterT [SomeReferenceId] Identity [Type (DeclName Symbol) Ann])
-&gt; ((SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
    -&gt; Type (DeclName Symbol) Ann
    -&gt; WriterT [SomeReferenceId] Identity (Type (DeclName Symbol) Ann))
-&gt; LensLike
     (WriterT [SomeReferenceId] Identity)
     [Type (DeclName Symbol) Ann]
     [Type (DeclName Symbol) Ann]
     SomeReferenceId
     SomeReferenceId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
-&gt; Type (DeclName Symbol) Ann
-&gt; WriterT [SomeReferenceId] Identity (Type (DeclName Symbol) Ann)
forall (m :: * -&gt; *) v a.
(Monad m, Ord v) =&gt;
LensLike' m (Type v a) SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#typeReferences_"><span class="hs-identifier hs-var">typeReferences_</span></a></span><span>
</span><span id="line-655"></span><span>                </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
 -&gt; Type (DeclName Symbol) Ann
 -&gt; WriterT [SomeReferenceId] Identity (Type (DeclName Symbol) Ann))
-&gt; ((SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
    -&gt; SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
-&gt; (SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
-&gt; Type (DeclName Symbol) Ann
-&gt; WriterT [SomeReferenceId] Identity (Type (DeclName Symbol) Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Bool)
-&gt; (SomeReferenceId -&gt; Writer [SomeReferenceId] SomeReferenceId)
-&gt; SomeReferenceId
-&gt; Writer [SomeReferenceId] SomeReferenceId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) a.
(Choice p, Applicative f) =&gt;
(a -&gt; Bool) -&gt; Optic' p f a a
</span><span class="hs-identifier hs-var">filtered</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeReferenceId -&gt; Map SomeReferenceId SomeReferenceId -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`Map.notMember`</span></span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538599"><span class="hs-identifier hs-var">migratedReferences</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-657"></span><span>
</span><span id="line-658"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; ([SomeReferenceId] -&gt; Bool) -&gt; [SomeReferenceId] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[SomeReferenceId] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([SomeReferenceId] -&gt; Bool) -&gt; [SomeReferenceId] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SomeReferenceId]
</span><a href="#local-6989586621680538600"><span class="hs-identifier hs-var">unmigratedRefIds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-659"></span><span>    </span><span class="annot"><span class="annottext">TrySyncResult Entity
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) e a. Monad m =&gt; e -&gt; ExceptT e m a
</span><span class="hs-identifier hs-var">throwE</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Entity] -&gt; TrySyncResult Entity
forall entity. [entity] -&gt; TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Missing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Entity] -&gt; [Entity]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">nubOrd</span></span><span> </span><span class="annot"><span class="annottext">([Entity] -&gt; [Entity])
-&gt; ([SomeReferenceId] -&gt; [Entity]) -&gt; [SomeReferenceId] -&gt; [Entity]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; Entity) -&gt; [SomeReferenceId] -&gt; [Entity]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferenceIdToEntity"><span class="hs-identifier hs-var">someReferenceIdToEntity</span></a></span><span> </span><span class="annot"><span class="annottext">([SomeReferenceId] -&gt; [Entity]) -&gt; [SomeReferenceId] -&gt; [Entity]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SomeReferenceId]
</span><a href="#local-6989586621680538600"><span class="hs-identifier hs-var">unmigratedRefIds</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-660"></span><span>
</span><span id="line-661"></span><span>  </span><span class="hs-comment">-- At this point we know we have all the required mappings from old references  to new ones.</span><span>
</span><span id="line-662"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538601"><span class="hs-identifier hs-type">remapTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538588"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538588"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-663"></span><span>      </span><span id="local-6989586621680538601"><span class="annot"><span class="annottext">remapTerm :: Type (DeclName Symbol) Ann -&gt; Type (DeclName Symbol) Ann
</span><a href="#local-6989586621680538601"><span class="hs-identifier hs-var hs-var">remapTerm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LensLike' Identity (Type (DeclName Symbol) Ann) SomeReferenceId
forall (m :: * -&gt; *) v a.
(Monad m, Ord v) =&gt;
LensLike' m (Type v a) SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#typeReferences_"><span class="hs-identifier hs-var">typeReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">LensLike' Identity (Type (DeclName Symbol) Ann) SomeReferenceId
-&gt; (SomeReferenceId -&gt; SomeReferenceId)
-&gt; Type (DeclName Symbol) Ann
-&gt; Type (DeclName Symbol) Ann
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680538602"><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538602"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
-&gt; SomeReferenceId
-&gt; Map SomeReferenceId SomeReferenceId
-&gt; SomeReferenceId
forall k a. Ord k =&gt; a -&gt; k -&gt; Map k a -&gt; a
</span><span class="hs-identifier hs-var">Map.findWithDefault</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; SomeReferenceId
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;unmigrated reference&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538602"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538599"><span class="hs-identifier hs-var">migratedReferences</span></a></span><span>
</span><span id="line-664"></span><span>
</span><span id="line-665"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538603"><span class="hs-identifier hs-type">remappedReferences</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#DeclName"><span class="hs-identifier hs-type">DeclName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DD.Decl</span></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538588"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-666"></span><span>      </span><span id="local-6989586621680538603"><span class="annot"><span class="annottext">remappedReferences :: Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538603"><span class="hs-identifier hs-var hs-var">remappedReferences</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-667"></span><span>        </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538593"><span class="hs-identifier hs-var">unhashed</span></a></span><span>
</span><span id="line-668"></span><span>          </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
    -&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann))
-&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((DeclName Symbol, Decl (DeclName Symbol) Ann)
 -&gt; Identity (DeclName Symbol, Decl (DeclName Symbol) Ann))
-&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; Identity
     (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann))
  (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann))
  (DeclName Symbol, Decl (DeclName Symbol) Ann)
  (DeclName Symbol, Decl (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="hs-comment">-- Traverse map of reference IDs</span><span>
</span><span id="line-669"></span><span>            </span><span class="annot"><span class="annottext">(((DeclName Symbol, Decl (DeclName Symbol) Ann)
  -&gt; Identity (DeclName Symbol, Decl (DeclName Symbol) Ann))
 -&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
 -&gt; Identity
      (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)))
-&gt; ((Type (DeclName Symbol) Ann
     -&gt; Identity (Type (DeclName Symbol) Ann))
    -&gt; (DeclName Symbol, Decl (DeclName Symbol) Ann)
    -&gt; Identity (DeclName Symbol, Decl (DeclName Symbol) Ann))
-&gt; (Type (DeclName Symbol) Ann
    -&gt; Identity (Type (DeclName Symbol) Ann))
-&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; Identity
     (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Decl (DeclName Symbol) Ann
 -&gt; Identity (Decl (DeclName Symbol) Ann))
-&gt; (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; Identity (DeclName Symbol, Decl (DeclName Symbol) Ann)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
Lens
  (DeclName Symbol, Decl (DeclName Symbol) Ann)
  (DeclName Symbol, Decl (DeclName Symbol) Ann)
  (Decl (DeclName Symbol) Ann)
  (Decl (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="hs-comment">-- Select the DataDeclaration</span><span>
</span><span id="line-670"></span><span>            </span><span class="annot"><span class="annottext">((Decl (DeclName Symbol) Ann
  -&gt; Identity (Decl (DeclName Symbol) Ann))
 -&gt; (DeclName Symbol, Decl (DeclName Symbol) Ann)
 -&gt; Identity (DeclName Symbol, Decl (DeclName Symbol) Ann))
-&gt; ((Type (DeclName Symbol) Ann
     -&gt; Identity (Type (DeclName Symbol) Ann))
    -&gt; Decl (DeclName Symbol) Ann
    -&gt; Identity (Decl (DeclName Symbol) Ann))
-&gt; (Type (DeclName Symbol) Ann
    -&gt; Identity (Type (DeclName Symbol) Ann))
-&gt; (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; Identity (DeclName Symbol, Decl (DeclName Symbol) Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Optical
  (-&gt;)
  (-&gt;)
  Identity
  (EffectDeclaration (DeclName Symbol) Ann)
  (EffectDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
-&gt; Optical
     (-&gt;)
     (-&gt;)
     Identity
     (DataDeclaration (DeclName Symbol) Ann)
     (DataDeclaration (DeclName Symbol) Ann)
     (DataDeclaration (DeclName Symbol) Ann)
     (DataDeclaration (DeclName Symbol) Ann)
-&gt; (DataDeclaration (DeclName Symbol) Ann
    -&gt; Identity (DataDeclaration (DeclName Symbol) Ann))
-&gt; Decl (DeclName Symbol) Ann
-&gt; Identity (Decl (DeclName Symbol) Ann)
forall (q :: * -&gt; * -&gt; *) (f :: * -&gt; *) (r :: * -&gt; * -&gt; *)
       (p :: * -&gt; * -&gt; *) s t a b s' t'.
(Representable q, Applicative (Rep q), Applicative f,
 Bitraversable r) =&gt;
Optical p q f s t a b
-&gt; Optical p q f s' t' a b -&gt; Optical p q f (r s s') (r t t') a b
</span><span class="hs-identifier hs-var">beside</span></span><span> </span><span class="annot"><span class="annottext">Optical
  (-&gt;)
  (-&gt;)
  Identity
  (EffectDeclaration (DeclName Symbol) Ann)
  (EffectDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
forall v a (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Profunctor p, Functor f) =&gt;
p (DataDeclaration v a) (f (DataDeclaration v a))
-&gt; p (EffectDeclaration v a) (f (EffectDeclaration v a))
</span><span class="hs-identifier hs-var">DD.asDataDecl_</span></span><span> </span><span class="annot"><span class="annottext">Optical
  (-&gt;)
  (-&gt;)
  Identity
  (DataDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
  (DataDeclaration (DeclName Symbol) Ann)
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-comment">-- Unpack effect decls</span><span>
</span><span id="line-671"></span><span>            </span><span class="annot"><span class="annottext">((DataDeclaration (DeclName Symbol) Ann
  -&gt; Identity (DataDeclaration (DeclName Symbol) Ann))
 -&gt; Decl (DeclName Symbol) Ann
 -&gt; Identity (Decl (DeclName Symbol) Ann))
-&gt; ((Type (DeclName Symbol) Ann
     -&gt; Identity (Type (DeclName Symbol) Ann))
    -&gt; DataDeclaration (DeclName Symbol) Ann
    -&gt; Identity (DataDeclaration (DeclName Symbol) Ann))
-&gt; (Type (DeclName Symbol) Ann
    -&gt; Identity (Type (DeclName Symbol) Ann))
-&gt; Decl (DeclName Symbol) Ann
-&gt; Identity (Decl (DeclName Symbol) Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
 -&gt; Identity [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)])
-&gt; DataDeclaration (DeclName Symbol) Ann
-&gt; Identity (DataDeclaration (DeclName Symbol) Ann)
forall v a (f :: * -&gt; *).
Functor f =&gt;
([(a, v, Type v a)] -&gt; f [(a, v, Type v a)])
-&gt; DataDeclaration v a -&gt; f (DataDeclaration v a)
</span><span class="hs-identifier hs-var">DD.constructors_</span></span><span> </span><span class="hs-comment">-- Get the data constructors</span><span>
</span><span id="line-672"></span><span>            </span><span class="annot"><span class="annottext">(([(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
  -&gt; Identity [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)])
 -&gt; DataDeclaration (DeclName Symbol) Ann
 -&gt; Identity (DataDeclaration (DeclName Symbol) Ann))
-&gt; ((Type (DeclName Symbol) Ann
     -&gt; Identity (Type (DeclName Symbol) Ann))
    -&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
    -&gt; Identity [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)])
-&gt; (Type (DeclName Symbol) Ann
    -&gt; Identity (Type (DeclName Symbol) Ann))
-&gt; DataDeclaration (DeclName Symbol) Ann
-&gt; Identity (DataDeclaration (DeclName Symbol) Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
 -&gt; Identity (Ann, DeclName Symbol, Type (DeclName Symbol) Ann))
-&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
-&gt; Identity [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
  [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
  (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
  (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="hs-comment">-- traverse the list of them</span><span>
</span><span id="line-673"></span><span>            </span><span class="annot"><span class="annottext">(((Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
  -&gt; Identity (Ann, DeclName Symbol, Type (DeclName Symbol) Ann))
 -&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
 -&gt; Identity [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)])
-&gt; ((Type (DeclName Symbol) Ann
     -&gt; Identity (Type (DeclName Symbol) Ann))
    -&gt; (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
    -&gt; Identity (Ann, DeclName Symbol, Type (DeclName Symbol) Ann))
-&gt; (Type (DeclName Symbol) Ann
    -&gt; Identity (Type (DeclName Symbol) Ann))
-&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
-&gt; Identity [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Type (DeclName Symbol) Ann
 -&gt; Identity (Type (DeclName Symbol) Ann))
-&gt; (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
-&gt; Identity (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
forall s t a b. Field3 s t a b =&gt; Lens s t a b
Lens
  (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
  (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
  (Type (DeclName Symbol) Ann)
  (Type (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">_3</span></span><span> </span><span class="hs-comment">-- Select the Type term.</span><span>
</span><span id="line-674"></span><span>            </span><span class="annot"><span class="annottext">((Type (DeclName Symbol) Ann
  -&gt; Identity (Type (DeclName Symbol) Ann))
 -&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
 -&gt; Identity
      (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)))
-&gt; (Type (DeclName Symbol) Ann -&gt; Type (DeclName Symbol) Ann)
-&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-operator hs-var">%~</span></span><span> </span><span class="annot"><span class="annottext">Type (DeclName Symbol) Ann -&gt; Type (DeclName Symbol) Ann
</span><a href="#local-6989586621680538601"><span class="hs-identifier hs-var">remapTerm</span></a></span><span>
</span><span id="line-675"></span><span>
</span><span id="line-676"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538605"><span class="hs-identifier hs-type">declNameToOldReference</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#DeclName"><span class="hs-identifier hs-type">DeclName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>      </span><span id="local-6989586621680538605"><span class="annot"><span class="annottext">declNameToOldReference :: Map (DeclName Symbol) (Old Id)
</span><a href="#local-6989586621680538605"><span class="hs-identifier hs-var hs-var">declNameToOldReference</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(DeclName Symbol, Old Id)] -&gt; Map (DeclName Symbol) (Old Id)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(DeclName Symbol, Old Id)] -&gt; Map (DeclName Symbol) (Old Id))
-&gt; (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
    -&gt; [(DeclName Symbol, Old Id)])
-&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; Map (DeclName Symbol) (Old Id)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Old Id, DeclName Symbol) -&gt; (DeclName Symbol, Old Id))
-&gt; [(Old Id, DeclName Symbol)] -&gt; [(DeclName Symbol, Old Id)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Old Id, DeclName Symbol) -&gt; (DeclName Symbol, Old Id)
forall a b. (a, b) -&gt; (b, a)
</span><span class="hs-identifier hs-var">swap</span></span><span> </span><span class="annot"><span class="annottext">([(Old Id, DeclName Symbol)] -&gt; [(DeclName Symbol, Old Id)])
-&gt; (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
    -&gt; [(Old Id, DeclName Symbol)])
-&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; [(DeclName Symbol, Old Id)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol) -&gt; [(Old Id, DeclName Symbol)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">(Map (Old Id) (DeclName Symbol) -&gt; [(Old Id, DeclName Symbol)])
-&gt; (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
    -&gt; Map (Old Id) (DeclName Symbol))
-&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; [(Old Id, DeclName Symbol)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((DeclName Symbol, Decl (DeclName Symbol) Ann) -&gt; DeclName Symbol)
-&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; Map (Old Id) (DeclName Symbol)
forall a b. (a -&gt; b) -&gt; Map (Old Id) a -&gt; Map (Old Id) b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(DeclName Symbol, Decl (DeclName Symbol) Ann) -&gt; DeclName Symbol
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
 -&gt; Map (DeclName Symbol) (Old Id))
-&gt; Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; Map (DeclName Symbol) (Old Id)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538603"><span class="hs-identifier hs-var">remappedReferences</span></a></span><span>
</span><span id="line-678"></span><span>
</span><span id="line-679"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538606"><span class="hs-identifier hs-type">newComponent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#DeclName"><span class="hs-identifier hs-type">DeclName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DD.Decl</span></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538588"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-680"></span><span>      </span><span id="local-6989586621680538606"><span class="annot"><span class="annottext">newComponent :: [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
</span><a href="#local-6989586621680538606"><span class="hs-identifier hs-var hs-var">newComponent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-681"></span><span>        </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538603"><span class="hs-identifier hs-var">remappedReferences</span></a></span><span>
</span><span id="line-682"></span><span>          </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; (Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
    -&gt; [(DeclName Symbol, Decl (DeclName Symbol) Ann)])
-&gt; [(DeclName Symbol, Decl (DeclName Symbol) Ann)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map (Old Id) (DeclName Symbol, Decl (DeclName Symbol) Ann)
-&gt; [(DeclName Symbol, Decl (DeclName Symbol) Ann)]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">Map.elems</span></span><span>
</span><span id="line-683"></span><span>          </span><span class="annot"><span class="annottext">[(DeclName Symbol, Decl (DeclName Symbol) Ann)]
-&gt; ([(DeclName Symbol, Decl (DeclName Symbol) Ann)]
    -&gt; Map (DeclName Symbol) (Decl (DeclName Symbol) Ann))
-&gt; Map (DeclName Symbol) (Decl (DeclName Symbol) Ann)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(DeclName Symbol, Decl (DeclName Symbol) Ann)]
-&gt; Map (DeclName Symbol) (Decl (DeclName Symbol) Ann)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span>
</span><span id="line-684"></span><span>          </span><span class="annot"><span class="annottext">Map (DeclName Symbol) (Decl (DeclName Symbol) Ann)
-&gt; (Map (DeclName Symbol) (Decl (DeclName Symbol) Ann)
    -&gt; ResolutionResult
         Ann [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)])
-&gt; ResolutionResult
     Ann [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map (DeclName Symbol) (Decl (DeclName Symbol) Ann)
-&gt; ResolutionResult
     Ann [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
forall v a.
Var v =&gt;
Map v (Decl v a) -&gt; ResolutionResult a [(v, Old Id, Decl v a)]
</span><a href="Unison.Hashing.V2.Convert.html#hashDecls"><span class="hs-identifier hs-var">Convert.hashDecls</span></a></span><span>
</span><span id="line-685"></span><span>          </span><span class="annot"><span class="annottext">ResolutionResult
  Ann [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
-&gt; (ResolutionResult
      Ann [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
    -&gt; [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)])
-&gt; [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
-&gt; ResolutionResult
     Ann [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
-&gt; [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
forall b a. b -&gt; Either a b -&gt; b
</span><span class="hs-identifier hs-var">fromRight</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;unexpected resolution error&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-686"></span><span>
</span><span id="line-687"></span><span>  </span><span class="annot"><span class="annottext">[(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
-&gt; ((DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
    -&gt; ExceptT
         (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
</span><a href="#local-6989586621680538606"><span class="hs-identifier hs-var">newComponent</span></a></span><span> </span><span class="annot"><span class="annottext">(((DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
  -&gt; ExceptT
       (TrySyncResult Entity) (StateT MigrationState Transaction) ())
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; ((DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
    -&gt; ExceptT
         (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680538610"><span class="annot"><span class="annottext">DeclName Symbol
</span><a href="#local-6989586621680538610"><span class="hs-identifier hs-var">declName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538611"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538611"><span class="hs-identifier hs-var">newReferenceId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538612"><span class="annot"><span class="annottext">Decl (DeclName Symbol) Ann
</span><a href="#local-6989586621680538612"><span class="hs-identifier hs-var">dd</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-688"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680538613"><span class="annot"><span class="annottext">oldReferenceId :: Old Id
</span><a href="#local-6989586621680538613"><span class="hs-identifier hs-var hs-var">oldReferenceId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map (DeclName Symbol) (Old Id)
</span><a href="#local-6989586621680538605"><span class="hs-identifier hs-var">declNameToOldReference</span></a></span><span> </span><span class="annot"><span class="annottext">Map (DeclName Symbol) (Old Id)
-&gt; Getting
     (Endo (Old Id)) (Map (DeclName Symbol) (Old Id)) (Old Id)
-&gt; Old Id
forall s a. HasCallStack =&gt; s -&gt; Getting (Endo a) s a -&gt; a
</span><span class="hs-operator hs-var">^?!</span></span><span> </span><span class="annot"><span class="annottext">Index (Map (DeclName Symbol) (Old Id))
-&gt; Traversal'
     (Map (DeclName Symbol) (Old Id))
     (IxValue (Map (DeclName Symbol) (Old Id)))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (Map (DeclName Symbol) (Old Id))
DeclName Symbol
</span><a href="#local-6989586621680538610"><span class="hs-identifier hs-var">declName</span></a></span><span>
</span><span id="line-689"></span><span>    </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;referenceMapping&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Map SomeReferenceId SomeReferenceId
  -&gt; Identity (Map SomeReferenceId SomeReferenceId))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; (Map SomeReferenceId SomeReferenceId
    -&gt; Map SomeReferenceId SomeReferenceId)
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; (a -&gt; b) -&gt; m ()
</span><span class="hs-operator hs-var">%=</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
-&gt; SomeReferenceId
-&gt; Map SomeReferenceId SomeReferenceId
-&gt; Map SomeReferenceId SomeReferenceId
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; SomeReferenceId
forall ref. ref -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TypeReference"><span class="hs-identifier hs-var">TypeReference</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538613"><span class="hs-identifier hs-var">oldReferenceId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; SomeReferenceId
forall ref. ref -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TypeReference"><span class="hs-identifier hs-var">TypeReference</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538611"><span class="hs-identifier hs-var">newReferenceId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span>
</span><span id="line-691"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680538615"><span class="hs-identifier hs-type">oldConstructorIds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#ConstructorName"><span class="hs-identifier hs-type">ConstructorName</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680538587"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConstructorId</span></span><span class="hs-special">)</span><span>
</span><span id="line-692"></span><span>        </span><span id="local-6989586621680538615"><span class="annot"><span class="annottext">oldConstructorIds :: Map (DeclName Symbol) (Old ConstructorId)
</span><a href="#local-6989586621680538615"><span class="hs-identifier hs-var hs-var">oldConstructorIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-693"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (Old Id) (Decl (DeclName Symbol) Ann)
</span><a href="#local-6989586621680538592"><span class="hs-identifier hs-var">componentIDMap</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Old Id) (Decl (DeclName Symbol) Ann)
-&gt; Getting
     (Endo (Decl (DeclName Symbol) Ann))
     (Map (Old Id) (Decl (DeclName Symbol) Ann))
     (Decl (DeclName Symbol) Ann)
-&gt; Decl (DeclName Symbol) Ann
forall s a. HasCallStack =&gt; s -&gt; Getting (Endo a) s a -&gt; a
</span><span class="hs-operator hs-var">^?!</span></span><span> </span><span class="annot"><span class="annottext">Index (Map (Old Id) (Decl (DeclName Symbol) Ann))
-&gt; Traversal'
     (Map (Old Id) (Decl (DeclName Symbol) Ann))
     (IxValue (Map (Old Id) (Decl (DeclName Symbol) Ann)))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (Map (Old Id) (Decl (DeclName Symbol) Ann))
Old Id
</span><a href="#local-6989586621680538613"><span class="hs-identifier hs-var">oldReferenceId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-694"></span><span>            </span><span class="annot"><span class="annottext">Decl (DeclName Symbol) Ann
-&gt; (Decl (DeclName Symbol) Ann
    -&gt; DataDeclaration (DeclName Symbol) Ann)
-&gt; DataDeclaration (DeclName Symbol) Ann
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Decl (DeclName Symbol) Ann -&gt; DataDeclaration (DeclName Symbol) Ann
forall v a. Decl v a -&gt; DataDeclaration v a
</span><span class="hs-identifier hs-var">DD.asDataDecl</span></span><span>
</span><span id="line-695"></span><span>            </span><span class="annot"><span class="annottext">DataDeclaration (DeclName Symbol) Ann
-&gt; (DataDeclaration (DeclName Symbol) Ann
    -&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)])
-&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration (DeclName Symbol) Ann
-&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
forall v a. DataDeclaration v a -&gt; [(a, v, Type v a)]
</span><span class="hs-identifier hs-var">DD.constructors'</span></span><span>
</span><span id="line-696"></span><span>            </span><span class="annot"><span class="annottext">[(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
-&gt; ([(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
    -&gt; [(DeclName Symbol, Old ConstructorId)])
-&gt; [(DeclName Symbol, Old ConstructorId)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Int
 -&gt; (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
 -&gt; (DeclName Symbol, Old ConstructorId))
-&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
-&gt; [(DeclName Symbol, Old ConstructorId)]
forall a b. (Int -&gt; a -&gt; b) -&gt; [a] -&gt; [b]
forall i (f :: * -&gt; *) a b.
FunctorWithIndex i f =&gt;
(i -&gt; a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">imap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680538618"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680538618"><span class="hs-identifier hs-var">constructorId</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680538619"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680538619"><span class="hs-identifier hs-var">_ann</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538620"><span class="annot"><span class="annottext">DeclName Symbol
</span><a href="#local-6989586621680538620"><span class="hs-identifier hs-var">constructorName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538621"><span class="annot"><span class="annottext">Type (DeclName Symbol) Ann
</span><a href="#local-6989586621680538621"><span class="hs-identifier hs-var">_type</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DeclName Symbol
</span><a href="#local-6989586621680538620"><span class="hs-identifier hs-var">constructorName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Old ConstructorId
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680538618"><span class="hs-identifier hs-var">constructorId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-697"></span><span>            </span><span class="annot"><span class="annottext">[(DeclName Symbol, Old ConstructorId)]
-&gt; ([(DeclName Symbol, Old ConstructorId)]
    -&gt; Map (DeclName Symbol) (Old ConstructorId))
-&gt; Map (DeclName Symbol) (Old ConstructorId)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(DeclName Symbol, Old ConstructorId)]
-&gt; Map (DeclName Symbol) (Old ConstructorId)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span>
</span><span id="line-698"></span><span>
</span><span id="line-699"></span><span>    </span><span class="annot"><span class="annottext">[(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
-&gt; (Int
    -&gt; (Ann, DeclName Symbol, Type (DeclName Symbol) Ann)
    -&gt; ExceptT
         (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall i (t :: * -&gt; *) (f :: * -&gt; *) a b.
(FoldableWithIndex i t, Applicative f) =&gt;
t a -&gt; (i -&gt; a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">ifor_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataDeclaration (DeclName Symbol) Ann
-&gt; [(Ann, DeclName Symbol, Type (DeclName Symbol) Ann)]
forall v a. DataDeclaration v a -&gt; [(a, v, Type v a)]
</span><span class="hs-identifier hs-var">DD.constructors'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Decl (DeclName Symbol) Ann -&gt; DataDeclaration (DeclName Symbol) Ann
forall v a. Decl v a -&gt; DataDeclaration v a
</span><span class="hs-identifier hs-var">DD.asDataDecl</span></span><span> </span><span class="annot"><span class="annottext">Decl (DeclName Symbol) Ann
</span><a href="#local-6989586621680538612"><span class="hs-identifier hs-var">dd</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Old ConstructorId
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680538622"><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538622"><span class="hs-identifier hs-var">newConstructorId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680538623"><span class="annot"><span class="annottext">Ann
</span><a href="#local-6989586621680538623"><span class="hs-identifier hs-var">_ann</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538624"><span class="annot"><span class="annottext">DeclName Symbol
</span><a href="#local-6989586621680538624"><span class="hs-identifier hs-var">constructorName</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538625"><span class="annot"><span class="annottext">Type (DeclName Symbol) Ann
</span><a href="#local-6989586621680538625"><span class="hs-identifier hs-var">_type</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-700"></span><span>      </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;referenceMapping&quot;</span></span><span>
</span><span id="line-701"></span><span>        </span><span class="annot"><span class="annottext">((Map SomeReferenceId SomeReferenceId
  -&gt; Identity (Map SomeReferenceId SomeReferenceId))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; (Map SomeReferenceId SomeReferenceId
    -&gt; Map SomeReferenceId SomeReferenceId)
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; (a -&gt; b) -&gt; m ()
</span><span class="hs-operator hs-var">%=</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
-&gt; SomeReferenceId
-&gt; Map SomeReferenceId SomeReferenceId
-&gt; Map SomeReferenceId SomeReferenceId
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span>
</span><span id="line-702"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; Old ConstructorId -&gt; SomeReferenceId
forall ref. ref -&gt; Old ConstructorId -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#ConstructorReference"><span class="hs-identifier hs-var">ConstructorReference</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538613"><span class="hs-identifier hs-var">oldReferenceId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map (DeclName Symbol) (Old ConstructorId)
</span><a href="#local-6989586621680538615"><span class="hs-identifier hs-var">oldConstructorIds</span></a></span><span> </span><span class="annot"><span class="annottext">Map (DeclName Symbol) (Old ConstructorId)
-&gt; Getting
     (Endo (Old ConstructorId))
     (Map (DeclName Symbol) (Old ConstructorId))
     (Old ConstructorId)
-&gt; Old ConstructorId
forall s a. HasCallStack =&gt; s -&gt; Getting (Endo a) s a -&gt; a
</span><span class="hs-operator hs-var">^?!</span></span><span> </span><span class="annot"><span class="annottext">Index (Map (DeclName Symbol) (Old ConstructorId))
-&gt; Traversal'
     (Map (DeclName Symbol) (Old ConstructorId))
     (IxValue (Map (DeclName Symbol) (Old ConstructorId)))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (Map (DeclName Symbol) (Old ConstructorId))
DeclName Symbol
</span><a href="#local-6989586621680538624"><span class="hs-identifier hs-var">constructorName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-703"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; Old ConstructorId -&gt; SomeReferenceId
forall ref. ref -&gt; Old ConstructorId -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#ConstructorReference"><span class="hs-identifier hs-var">ConstructorReference</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538611"><span class="hs-identifier hs-var">newReferenceId</span></a></span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538622"><span class="hs-identifier hs-var">newConstructorId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-704"></span><span>
</span><span id="line-705"></span><span>    </span><span class="annot"><span class="annottext">StateT MigrationState Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction ()
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; (Transaction () -&gt; StateT MigrationState Transaction ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction () -&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult Entity) (StateT MigrationState Transaction) ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) TermBufferEntry)
-&gt; TVar (Map (New Hash) DeclBufferEntry)
-&gt; Old Id
-&gt; Decl (DeclName Symbol) Ann
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTypeDeclaration"><span class="hs-identifier hs-var">CodebaseOps.putTypeDeclaration</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) TermBufferEntry)
</span><a href="#local-6989586621680538584"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (New Hash) DeclBufferEntry)
</span><a href="#local-6989586621680538585"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538611"><span class="hs-identifier hs-var">newReferenceId</span></a></span><span> </span><span class="annot"><span class="annottext">Decl (DeclName Symbol) Ann
</span><a href="#local-6989586621680538612"><span class="hs-identifier hs-var">dd</span></a></span><span>
</span><span id="line-706"></span><span>
</span><span id="line-707"></span><span>  </span><span class="hs-comment">-- Need to get one of the new references to grab its hash, doesn't matter which one since</span><span>
</span><span id="line-708"></span><span>  </span><span class="hs-comment">-- all hashes in the component are the same.</span><span>
</span><span id="line-709"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
</span><a href="#local-6989586621680538606"><span class="hs-identifier hs-var">newComponent</span></a></span><span> </span><span class="annot"><span class="annottext">[(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
-&gt; Getting
     (First (New Hash))
     [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
     (New Hash)
-&gt; Maybe (New Hash)
forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><span class="hs-operator hs-var">^?</span></span><span> </span><span class="annot"><span class="annottext">((DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
 -&gt; Const
      (First (New Hash))
      (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann))
-&gt; [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
-&gt; Const
     (First (New Hash))
     [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
  [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
  (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
  (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">(((DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
  -&gt; Const
       (First (New Hash))
       (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann))
 -&gt; [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
 -&gt; Const
      (First (New Hash))
      [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)])
-&gt; ((New Hash -&gt; Const (First (New Hash)) (New Hash))
    -&gt; (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
    -&gt; Const
         (First (New Hash))
         (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann))
-&gt; Getting
     (First (New Hash))
     [(DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)]
     (New Hash)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Old Id -&gt; Const (First (New Hash)) (Old Id))
-&gt; (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
-&gt; Const
     (First (New Hash))
     (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
Lens
  (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
  (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
  (Old Id)
  (Old Id)
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="annot"><span class="annottext">((Old Id -&gt; Const (First (New Hash)) (Old Id))
 -&gt; (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
 -&gt; Const
      (First (New Hash))
      (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann))
-&gt; ((New Hash -&gt; Const (First (New Hash)) (New Hash))
    -&gt; Old Id -&gt; Const (First (New Hash)) (Old Id))
-&gt; (New Hash -&gt; Const (First (New Hash)) (New Hash))
-&gt; (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
-&gt; Const
     (First (New Hash))
     (DeclName Symbol, Old Id, Decl (DeclName Symbol) Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Old Id -&gt; New Hash)
-&gt; (New Hash -&gt; Const (First (New Hash)) (New Hash))
-&gt; Old Id
-&gt; Const (First (New Hash)) (Old Id)
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">Old Id -&gt; New Hash
</span><span class="hs-identifier hs-var">Reference.idToHash</span></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-710"></span><span>    </span><span class="annot"><span class="annottext">Maybe (New Hash)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall a.
a
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-711"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680538628"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538628"><span class="hs-identifier hs-var">newHash</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction ()
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult Entity) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">New Hash -&gt; New Hash -&gt; StateT MigrationState Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#insertObjectMappingForHash"><span class="hs-identifier hs-var">insertObjectMappingForHash</span></a></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538586"><span class="hs-identifier hs-var">oldHash</span></a></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538628"><span class="hs-identifier hs-var">newHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-712"></span><span>  </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;migratedDefnHashes&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Set (New Hash) -&gt; Identity (Set (New Hash)))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; (Set (New Hash) -&gt; Set (New Hash))
-&gt; ExceptT
     (TrySyncResult Entity) (StateT MigrationState Transaction) ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; (a -&gt; b) -&gt; m ()
</span><span class="hs-operator hs-var">%=</span></span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Set (New Hash) -&gt; Set (New Hash)
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.insert</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538586"><span class="hs-identifier hs-var">oldHash</span></a></span><span>
</span><span id="line-713"></span><span>
</span><span id="line-714"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">TrySyncResult Entity
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Done</span></span><span>
</span><span id="line-715"></span><span>
</span><span id="line-716"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#insertObjectMappingForHash"><span class="hs-identifier hs-type">insertObjectMappingForHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-type">New</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-717"></span><span id="insertObjectMappingForHash"><span class="annot"><span class="annottext">insertObjectMappingForHash :: New Hash -&gt; New Hash -&gt; StateT MigrationState Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#insertObjectMappingForHash"><span class="hs-identifier hs-var hs-var">insertObjectMappingForHash</span></a></span></span><span> </span><span id="local-6989586621680538629"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538629"><span class="hs-identifier hs-var">oldHash</span></a></span></span><span> </span><span id="local-6989586621680538630"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538630"><span class="hs-identifier hs-var">newHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-718"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621680538631"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538631"><span class="hs-identifier hs-var">oldObjectId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538632"><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680538632"><span class="hs-identifier hs-var">newHashId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538633"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538633"><span class="hs-identifier hs-var">newObjectId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction (ObjectId, HashId, ObjectId)
-&gt; StateT MigrationState Transaction (ObjectId, HashId, ObjectId)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-719"></span><span>    </span><span id="local-6989586621680538634"><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680538634"><span class="hs-identifier hs-var">oldHashId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Transaction HashId
</span><span class="hs-identifier hs-var">Q.expectHashIdByHash</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538629"><span class="hs-identifier hs-var">oldHash</span></a></span><span>
</span><span id="line-720"></span><span>    </span><span id="local-6989586621680538635"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538635"><span class="hs-identifier hs-var">oldObjectId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashId -&gt; Transaction ObjectId
</span><span class="hs-identifier hs-var">Q.expectObjectIdForPrimaryHashId</span></span><span> </span><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680538634"><span class="hs-identifier hs-var">oldHashId</span></a></span><span>
</span><span id="line-721"></span><span>    </span><span id="local-6989586621680538636"><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680538636"><span class="hs-identifier hs-var">newHashId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Transaction HashId
</span><span class="hs-identifier hs-var">Q.expectHashIdByHash</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538630"><span class="hs-identifier hs-var">newHash</span></a></span><span>
</span><span id="line-722"></span><span>    </span><span id="local-6989586621680538637"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538637"><span class="hs-identifier hs-var">newObjectId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashId -&gt; Transaction ObjectId
</span><span class="hs-identifier hs-var">Q.expectObjectIdForPrimaryHashId</span></span><span> </span><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680538636"><span class="hs-identifier hs-var">newHashId</span></a></span><span>
</span><span id="line-723"></span><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538635"><span class="hs-identifier hs-var">oldObjectId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680538636"><span class="hs-identifier hs-var">newHashId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538637"><span class="hs-identifier hs-var">newObjectId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-724"></span><span>  </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;objLookup&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Map ObjectId (ObjectId, HashId, New Hash, New Hash)
  -&gt; Identity (Map ObjectId (ObjectId, HashId, New Hash, New Hash)))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; (Map ObjectId (ObjectId, HashId, New Hash, New Hash)
    -&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash))
-&gt; StateT MigrationState Transaction ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; (a -&gt; b) -&gt; m ()
</span><span class="hs-operator hs-var">%=</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
-&gt; (ObjectId, HashId, New Hash, New Hash)
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538631"><span class="hs-identifier hs-var">oldObjectId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538633"><span class="hs-identifier hs-var">newObjectId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680538632"><span class="hs-identifier hs-var">newHashId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538630"><span class="hs-identifier hs-var">newHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538629"><span class="hs-identifier hs-var">oldHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-725"></span><span>
</span><span id="line-726"></span><span id="local-6989586621680536481"><span id="local-6989586621680536482"><span id="local-6989586621680536483"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#typeReferences_"><span class="hs-identifier hs-type">typeReferences_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621680536481"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536482"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LensLike'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536481"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><a href="#local-6989586621680536482"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536483"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span></span></span></span><span>
</span><span id="line-727"></span><span id="typeReferences_"><span class="annot"><span class="annottext">typeReferences_ :: forall (m :: * -&gt; *) v a.
(Monad m, Ord v) =&gt;
LensLike' m (Type v a) SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#typeReferences_"><span class="hs-identifier hs-var hs-var">typeReferences_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-728"></span><span>  </span><span class="annot"><span class="annottext">(Term F v a -&gt; m (Term F v a)) -&gt; Term F v a -&gt; m (Term F v a)
forall (f :: * -&gt; *) (m :: * -&gt; *) v a.
(Traversable f, Monad m, Ord v) =&gt;
(Term f v a -&gt; m (Term f v a)) -&gt; Term f v a -&gt; m (Term f v a)
</span><span class="hs-identifier hs-var">ABT.rewriteDown_</span></span><span> </span><span class="hs-comment">-- Focus all terms</span><span>
</span><span id="line-729"></span><span>    </span><span class="annot"><span class="annottext">((Term F v a -&gt; m (Term F v a)) -&gt; Term F v a -&gt; m (Term F v a))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; Term F v a -&gt; m (Term F v a))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; Term F v a
-&gt; m (Term F v a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(F (Term F v a) -&gt; m (F (Term F v a)))
-&gt; Term F v a -&gt; m (Term F v a)
forall (m :: * -&gt; *) (f :: * -&gt; *) v a.
Applicative m =&gt;
(f (Term f v a) -&gt; m (f (Term f v a)))
-&gt; Term f v a -&gt; m (Term f v a)
</span><span class="hs-identifier hs-var">ABT.baseFunctor_</span></span><span> </span><span class="hs-comment">-- Focus Type.F</span><span>
</span><span id="line-730"></span><span>    </span><span class="annot"><span class="annottext">((F (Term F v a) -&gt; m (F (Term F v a)))
 -&gt; Term F v a -&gt; m (Term F v a))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; F (Term F v a) -&gt; m (F (Term F v a)))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; Term F v a
-&gt; m (Term F v a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Reference -&gt; m Reference) -&gt; F (Term F v a) -&gt; m (F (Term F v a))
forall a (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p Reference (f Reference) -&gt; p (F a) (f (F a))
</span><span class="hs-identifier hs-var">Type._Ref</span></span><span> </span><span class="hs-comment">-- Only the Ref constructor has references</span><span>
</span><span id="line-731"></span><span>    </span><span class="annot"><span class="annottext">((Reference -&gt; m Reference)
 -&gt; F (Term F v a) -&gt; m (F (Term F v a)))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; Reference -&gt; m Reference)
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F (Term F v a)
-&gt; m (F (Term F v a))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Old Id -&gt; m (Old Id)) -&gt; Reference -&gt; m Reference
Prism' Reference (Old Id)
</span><span class="hs-identifier hs-var">Reference._DerivedId</span></span><span>
</span><span id="line-732"></span><span>    </span><span class="annot"><span class="annottext">((Old Id -&gt; m (Old Id)) -&gt; Reference -&gt; m Reference)
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId) -&gt; Old Id -&gt; m (Old Id))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; Reference
-&gt; m Reference
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; m SomeReferenceId) -&gt; Old Id -&gt; m (Old Id)
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTypeReference_"><span class="hs-identifier hs-var">asTypeReference_</span></a></span><span>
</span><span id="line-733"></span><span>
</span><span id="line-734"></span><span id="local-6989586621680536258"><span id="local-6989586621680536259"><span id="local-6989586621680536260"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#termReferences_"><span class="hs-identifier hs-type">termReferences_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621680536258"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536259"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LensLike'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536258"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term.Term</span></span><span> </span><span class="annot"><a href="#local-6989586621680536259"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536260"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span></span></span></span><span>
</span><span id="line-735"></span><span id="termReferences_"><span class="annot"><span class="annottext">termReferences_ :: forall (m :: * -&gt; *) v a.
(Monad m, Ord v) =&gt;
LensLike' m (Term v a) SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#termReferences_"><span class="hs-identifier hs-var hs-var">termReferences_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-736"></span><span>  </span><span class="annot"><span class="annottext">(Term (F v a a) v a -&gt; m (Term (F v a a) v a))
-&gt; Term (F v a a) v a -&gt; m (Term (F v a a) v a)
forall (f :: * -&gt; *) (m :: * -&gt; *) v a.
(Traversable f, Monad m, Ord v) =&gt;
(Term f v a -&gt; m (Term f v a)) -&gt; Term f v a -&gt; m (Term f v a)
</span><span class="hs-identifier hs-var">ABT.rewriteDown_</span></span><span> </span><span class="hs-comment">-- Focus all terms</span><span>
</span><span id="line-737"></span><span>    </span><span class="annot"><span class="annottext">((Term (F v a a) v a -&gt; m (Term (F v a a) v a))
 -&gt; Term (F v a a) v a -&gt; m (Term (F v a a) v a))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; Term (F v a a) v a -&gt; m (Term (F v a a) v a))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; Term (F v a a) v a
-&gt; m (Term (F v a a) v a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(F v a a (Term (F v a a) v a) -&gt; m (F v a a (Term (F v a a) v a)))
-&gt; Term (F v a a) v a -&gt; m (Term (F v a a) v a)
forall (m :: * -&gt; *) (f :: * -&gt; *) v a.
Applicative m =&gt;
(f (Term f v a) -&gt; m (f (Term f v a)))
-&gt; Term f v a -&gt; m (Term f v a)
</span><span class="hs-identifier hs-var">ABT.baseFunctor_</span></span><span> </span><span class="hs-comment">-- Focus Term.F</span><span>
</span><span id="line-738"></span><span>    </span><span class="annot"><span class="annottext">((F v a a (Term (F v a a) v a) -&gt; m (F v a a (Term (F v a a) v a)))
 -&gt; Term (F v a a) v a -&gt; m (Term (F v a a) v a))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; F v a a (Term (F v a a) v a)
    -&gt; m (F v a a (Term (F v a a) v a)))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; Term (F v a a) v a
-&gt; m (Term (F v a a) v a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F v a a (Term (F v a a) v a) -&gt; m (F v a a (Term (F v a a) v a))
forall tv (m :: * -&gt; *) ta pa a.
(Ord tv, Monad m) =&gt;
LensLike' m (F tv ta pa a) SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#termFReferences_"><span class="hs-identifier hs-var">termFReferences_</span></a></span><span>
</span><span id="line-739"></span><span>
</span><span id="line-740"></span><span id="local-6989586621680536562"><span id="local-6989586621680536563"><span id="local-6989586621680536564"><span id="local-6989586621680536565"><span id="local-6989586621680536566"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#termFReferences_"><span class="hs-identifier hs-type">termFReferences_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680536562"><span class="hs-identifier hs-type">tv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621680536563"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LensLike'</span></span><span> </span><span class="annot"><a href="#local-6989586621680536563"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term.F</span></span><span> </span><span class="annot"><a href="#local-6989586621680536562"><span class="hs-identifier hs-type">tv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536564"><span class="hs-identifier hs-type">ta</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536565"><span class="hs-identifier hs-type">pa</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536566"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span></span></span></span></span></span><span>
</span><span id="line-741"></span><span id="termFReferences_"><span class="annot"><span class="annottext">termFReferences_ :: forall tv (m :: * -&gt; *) ta pa a.
(Ord tv, Monad m) =&gt;
LensLike' m (F tv ta pa a) SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#termFReferences_"><span class="hs-identifier hs-var hs-var">termFReferences_</span></a></span></span><span> </span><span id="local-6989586621680538711"><span class="annot"><span class="annottext">SomeReferenceId -&gt; m SomeReferenceId
</span><a href="#local-6989586621680538711"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621680538712"><span class="annot"><span class="annottext">F tv ta pa a
</span><a href="#local-6989586621680538712"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-742"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">F tv ta pa a
</span><a href="#local-6989586621680538712"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">F tv ta pa a
-&gt; (F tv ta pa a -&gt; m (F tv ta pa a)) -&gt; m (F tv ta pa a)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Reference -&gt; m Reference) -&gt; F tv ta pa a -&gt; m (F tv ta pa a)
forall tv ta pa a (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p Reference (f Reference) -&gt; p (F tv ta pa a) (f (F tv ta pa a))
</span><span class="hs-identifier hs-var">Term._Ref</span></span><span> </span><span class="annot"><span class="annottext">((Reference -&gt; m Reference) -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; Reference -&gt; m Reference)
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Old Id -&gt; m (Old Id)) -&gt; Reference -&gt; m Reference
Prism' Reference (Old Id)
</span><span class="hs-identifier hs-var">Reference._DerivedId</span></span><span> </span><span class="annot"><span class="annottext">((Old Id -&gt; m (Old Id)) -&gt; Reference -&gt; m Reference)
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId) -&gt; Old Id -&gt; m (Old Id))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; Reference
-&gt; m Reference
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; m SomeReferenceId) -&gt; Old Id -&gt; m (Old Id)
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTermReference_"><span class="hs-identifier hs-var">asTermReference_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; m SomeReferenceId)
 -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; m SomeReferenceId
</span><a href="#local-6989586621680538711"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-743"></span><span>    </span><span class="annot"><span class="annottext">m (F tv ta pa a)
-&gt; (F tv ta pa a -&gt; m (F tv ta pa a)) -&gt; m (F tv ta pa a)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(ConstructorReference -&gt; m ConstructorReference)
-&gt; F tv ta pa a -&gt; m (F tv ta pa a)
forall tv ta pa a (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p ConstructorReference (f ConstructorReference)
-&gt; p (F tv ta pa a) (f (F tv ta pa a))
</span><span class="hs-identifier hs-var">Term._Constructor</span></span><span> </span><span class="annot"><span class="annottext">((ConstructorReference -&gt; m ConstructorReference)
 -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; ConstructorReference -&gt; m ConstructorReference)
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; m SomeReferenceId)
-&gt; ConstructorReference -&gt; m ConstructorReference
Traversal' ConstructorReference SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someRefCon_"><span class="hs-identifier hs-var">someRefCon_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; m SomeReferenceId)
 -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; m SomeReferenceId
</span><a href="#local-6989586621680538711"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-744"></span><span>    </span><span class="annot"><span class="annottext">m (F tv ta pa a)
-&gt; (F tv ta pa a -&gt; m (F tv ta pa a)) -&gt; m (F tv ta pa a)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(ConstructorReference -&gt; m ConstructorReference)
-&gt; F tv ta pa a -&gt; m (F tv ta pa a)
forall tv ta pa a (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p ConstructorReference (f ConstructorReference)
-&gt; p (F tv ta pa a) (f (F tv ta pa a))
</span><span class="hs-identifier hs-var">Term._Request</span></span><span> </span><span class="annot"><span class="annottext">((ConstructorReference -&gt; m ConstructorReference)
 -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; ConstructorReference -&gt; m ConstructorReference)
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; m SomeReferenceId)
-&gt; ConstructorReference -&gt; m ConstructorReference
Traversal' ConstructorReference SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someRefCon_"><span class="hs-identifier hs-var">someRefCon_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; m SomeReferenceId)
 -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; m SomeReferenceId
</span><a href="#local-6989586621680538711"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-745"></span><span>    </span><span class="annot"><span class="annottext">m (F tv ta pa a)
-&gt; (F tv ta pa a -&gt; m (F tv ta pa a)) -&gt; m (F tv ta pa a)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">((a, Term F tv ta) -&gt; m (a, Term F tv ta))
-&gt; F tv ta pa a -&gt; m (F tv ta pa a)
forall tv ta pa a (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p (a, Term F tv ta) (f (a, Term F tv ta))
-&gt; p (F tv ta pa a) (f (F tv ta pa a))
</span><span class="hs-identifier hs-var">Term._Ann</span></span><span> </span><span class="annot"><span class="annottext">(((a, Term F tv ta) -&gt; m (a, Term F tv ta))
 -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; (a, Term F tv ta) -&gt; m (a, Term F tv ta))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Term F tv ta -&gt; m (Term F tv ta))
-&gt; (a, Term F tv ta) -&gt; m (a, Term F tv ta)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
Lens
  (a, Term F tv ta) (a, Term F tv ta) (Term F tv ta) (Term F tv ta)
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="annot"><span class="annottext">((Term F tv ta -&gt; m (Term F tv ta))
 -&gt; (a, Term F tv ta) -&gt; m (a, Term F tv ta))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; Term F tv ta -&gt; m (Term F tv ta))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; (a, Term F tv ta)
-&gt; m (a, Term F tv ta)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; m SomeReferenceId)
-&gt; Term F tv ta -&gt; m (Term F tv ta)
forall (m :: * -&gt; *) v a.
(Monad m, Ord v) =&gt;
LensLike' m (Type v a) SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#typeReferences_"><span class="hs-identifier hs-var">typeReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; m SomeReferenceId)
 -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; m SomeReferenceId
</span><a href="#local-6989586621680538711"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-746"></span><span>    </span><span class="annot"><span class="annottext">m (F tv ta pa a)
-&gt; (F tv ta pa a -&gt; m (F tv ta pa a)) -&gt; m (F tv ta pa a)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">((a, [MatchCase pa a]) -&gt; m (a, [MatchCase pa a]))
-&gt; F tv ta pa a -&gt; m (F tv ta pa a)
forall tv ta pa a (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p (a, [MatchCase pa a]) (f (a, [MatchCase pa a]))
-&gt; p (F tv ta pa a) (f (F tv ta pa a))
</span><span class="hs-identifier hs-var">Term._Match</span></span><span> </span><span class="annot"><span class="annottext">(((a, [MatchCase pa a]) -&gt; m (a, [MatchCase pa a]))
 -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; (a, [MatchCase pa a]) -&gt; m (a, [MatchCase pa a]))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([MatchCase pa a] -&gt; m [MatchCase pa a])
-&gt; (a, [MatchCase pa a]) -&gt; m (a, [MatchCase pa a])
forall s t a b. Field2 s t a b =&gt; Lens s t a b
Lens
  (a, [MatchCase pa a])
  (a, [MatchCase pa a])
  [MatchCase pa a]
  [MatchCase pa a]
</span><span class="hs-identifier hs-var">_2</span></span><span> </span><span class="annot"><span class="annottext">(([MatchCase pa a] -&gt; m [MatchCase pa a])
 -&gt; (a, [MatchCase pa a]) -&gt; m (a, [MatchCase pa a]))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; [MatchCase pa a] -&gt; m [MatchCase pa a])
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; (a, [MatchCase pa a])
-&gt; m (a, [MatchCase pa a])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(MatchCase pa a -&gt; m (MatchCase pa a))
-&gt; [MatchCase pa a] -&gt; m [MatchCase pa a]
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  [MatchCase pa a]
  [MatchCase pa a]
  (MatchCase pa a)
  (MatchCase pa a)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">((MatchCase pa a -&gt; m (MatchCase pa a))
 -&gt; [MatchCase pa a] -&gt; m [MatchCase pa a])
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; MatchCase pa a -&gt; m (MatchCase pa a))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; [MatchCase pa a]
-&gt; m [MatchCase pa a]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Pattern pa -&gt; m (Pattern pa))
-&gt; MatchCase pa a -&gt; m (MatchCase pa a)
forall loc a (f :: * -&gt; *).
Functor f =&gt;
(Pattern loc -&gt; f (Pattern loc))
-&gt; MatchCase loc a -&gt; f (MatchCase loc a)
</span><span class="hs-identifier hs-var">Term.matchPattern_</span></span><span> </span><span class="annot"><span class="annottext">((Pattern pa -&gt; m (Pattern pa))
 -&gt; MatchCase pa a -&gt; m (MatchCase pa a))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; Pattern pa -&gt; m (Pattern pa))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; MatchCase pa a
-&gt; m (MatchCase pa a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; m SomeReferenceId)
-&gt; Pattern pa -&gt; m (Pattern pa)
forall loc (f :: * -&gt; *).
Applicative f =&gt;
(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patternReferences_"><span class="hs-identifier hs-var">patternReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; m SomeReferenceId)
 -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; m SomeReferenceId
</span><a href="#local-6989586621680538711"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-747"></span><span>    </span><span class="annot"><span class="annottext">m (F tv ta pa a)
-&gt; (F tv ta pa a -&gt; m (F tv ta pa a)) -&gt; m (F tv ta pa a)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Referent -&gt; m Referent) -&gt; F tv ta pa a -&gt; m (F tv ta pa a)
forall tv ta pa a (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p Referent (f Referent) -&gt; p (F tv ta pa a) (f (F tv ta pa a))
</span><span class="hs-identifier hs-var">Term._TermLink</span></span><span> </span><span class="annot"><span class="annottext">((Referent -&gt; m Referent) -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; Referent -&gt; m Referent)
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; m SomeReferenceId) -&gt; Referent -&gt; m Referent
Traversal' Referent SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#referentAsSomeTermReference_"><span class="hs-identifier hs-var">referentAsSomeTermReference_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; m SomeReferenceId)
 -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; m SomeReferenceId
</span><a href="#local-6989586621680538711"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-748"></span><span>    </span><span class="annot"><span class="annottext">m (F tv ta pa a)
-&gt; (F tv ta pa a -&gt; m (F tv ta pa a)) -&gt; m (F tv ta pa a)
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Reference -&gt; m Reference) -&gt; F tv ta pa a -&gt; m (F tv ta pa a)
forall tv ta pa a (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p Reference (f Reference) -&gt; p (F tv ta pa a) (f (F tv ta pa a))
</span><span class="hs-identifier hs-var">Term._TypeLink</span></span><span> </span><span class="annot"><span class="annottext">((Reference -&gt; m Reference) -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId)
    -&gt; Reference -&gt; m Reference)
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Old Id -&gt; m (Old Id)) -&gt; Reference -&gt; m Reference
Prism' Reference (Old Id)
</span><span class="hs-identifier hs-var">Reference._DerivedId</span></span><span> </span><span class="annot"><span class="annottext">((Old Id -&gt; m (Old Id)) -&gt; Reference -&gt; m Reference)
-&gt; ((SomeReferenceId -&gt; m SomeReferenceId) -&gt; Old Id -&gt; m (Old Id))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; Reference
-&gt; m Reference
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; m SomeReferenceId) -&gt; Old Id -&gt; m (Old Id)
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTypeReference_"><span class="hs-identifier hs-var">asTypeReference_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; m SomeReferenceId)
 -&gt; F tv ta pa a -&gt; m (F tv ta pa a))
-&gt; (SomeReferenceId -&gt; m SomeReferenceId)
-&gt; F tv ta pa a
-&gt; m (F tv ta pa a)
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; m SomeReferenceId
</span><a href="#local-6989586621680538711"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-749"></span><span>
</span><span id="line-750"></span><span class="annot"><span class="hs-comment">-- | Build a SomeConstructorReference</span></span><span>
</span><span id="line-751"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someRefCon_"><span class="hs-identifier hs-type">someRefCon_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference.ConstructorReference</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span>
</span><span id="line-752"></span><span id="someRefCon_"><span class="annot"><span class="annottext">someRefCon_ :: Traversal' ConstructorReference SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someRefCon_"><span class="hs-identifier hs-var hs-var">someRefCon_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ConstructorReferenceId -&gt; f ConstructorReferenceId)
-&gt; ConstructorReference -&gt; f ConstructorReference
Traversal' ConstructorReference ConstructorReferenceId
</span><a href="#local-6989586621680538727"><span class="hs-identifier hs-var">refConPair_</span></a></span><span> </span><span class="annot"><span class="annottext">((ConstructorReferenceId -&gt; f ConstructorReferenceId)
 -&gt; ConstructorReference -&gt; f ConstructorReference)
-&gt; ((SomeReferenceId -&gt; f SomeReferenceId)
    -&gt; ConstructorReferenceId -&gt; f ConstructorReferenceId)
-&gt; (SomeReferenceId -&gt; f SomeReferenceId)
-&gt; ConstructorReference
-&gt; f ConstructorReference
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; ConstructorReferenceId -&gt; f ConstructorReferenceId
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref))
-&gt; GConstructorReference ref -&gt; f (GConstructorReference ref)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asConstructorReference_"><span class="hs-identifier hs-var">asConstructorReference_</span></a></span><span>
</span><span id="line-753"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-754"></span><span>    </span><span class="annot"><a href="#local-6989586621680538727"><span class="hs-identifier hs-type">refConPair_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference.ConstructorReference</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference.ConstructorReferenceId</span></span><span>
</span><span id="line-755"></span><span>    </span><span id="local-6989586621680538727"><span class="annot"><span class="annottext">refConPair_ :: Traversal' ConstructorReference ConstructorReferenceId
</span><a href="#local-6989586621680538727"><span class="hs-identifier hs-var hs-var">refConPair_</span></a></span></span><span> </span><span id="local-6989586621680538732"><span class="annot"><span class="annottext">ConstructorReferenceId -&gt; f ConstructorReferenceId
</span><a href="#local-6989586621680538732"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621680538733"><span class="annot"><span class="annottext">ConstructorReference
</span><a href="#local-6989586621680538733"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-756"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ConstructorReference
</span><a href="#local-6989586621680538733"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-757"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference.ConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Builtin</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ConstructorReference -&gt; f ConstructorReference
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ConstructorReference
</span><a href="#local-6989586621680538733"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-758"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference.ConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.DerivedId</span></span><span> </span><span id="local-6989586621680538736"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538736"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680538737"><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538737"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-759"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference.ConstructorReference</span></span><span> </span><span id="local-6989586621680538738"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538738"><span class="hs-identifier hs-var">n'</span></a></span></span><span> </span><span id="local-6989586621680538739"><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538739"><span class="hs-identifier hs-var">c'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-760"></span><span>              </span><span class="annot"><span class="annottext">Reference -&gt; Old ConstructorId -&gt; ConstructorReference
forall r. r -&gt; Old ConstructorId -&gt; GConstructorReference r
</span><span class="hs-identifier hs-var">ConstructorReference.ConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; Reference
forall h t. Id' h -&gt; Reference' t h
</span><span class="hs-identifier hs-var">Reference.DerivedId</span></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538738"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538739"><span class="hs-identifier hs-var">c'</span></a></span><span>
</span><span id="line-761"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span>            </span><span class="annot"><span class="annottext">(ConstructorReferenceId -&gt; ConstructorReference)
-&gt; f ConstructorReferenceId -&gt; f ConstructorReference
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ConstructorReferenceId -&gt; f ConstructorReferenceId
</span><a href="#local-6989586621680538732"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; Old ConstructorId -&gt; ConstructorReferenceId
forall r. r -&gt; Old ConstructorId -&gt; GConstructorReference r
</span><span class="hs-identifier hs-var">ConstructorReference.ConstructorReference</span></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538736"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538737"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-763"></span><span>
</span><span id="line-764"></span><span id="local-6989586621680536602"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patternReferences_"><span class="hs-identifier hs-type">patternReferences_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern</span></span><span> </span><span class="annot"><a href="#local-6989586621680536602"><span class="hs-identifier hs-type">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span></span><span>
</span><span id="line-765"></span><span id="patternReferences_"><span class="annot"><span class="annottext">patternReferences_ :: forall loc (f :: * -&gt; *).
Applicative f =&gt;
(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patternReferences_"><span class="hs-identifier hs-var hs-var">patternReferences_</span></a></span></span><span> </span><span id="local-6989586621680538781"><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538781"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-766"></span><span>  </span><span id="local-6989586621680538782"><span class="annot"><span class="annottext">p :: Pattern loc
</span><a href="#local-6989586621680538782"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Unbound</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pattern loc -&gt; f (Pattern loc)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538782"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-767"></span><span>  </span><span id="local-6989586621680538784"><span class="annot"><span class="annottext">p :: Pattern loc
</span><a href="#local-6989586621680538784"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Var</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pattern loc -&gt; f (Pattern loc)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538784"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-768"></span><span>  </span><span id="local-6989586621680538786"><span class="annot"><span class="annottext">p :: Pattern loc
</span><a href="#local-6989586621680538786"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Boolean</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pattern loc -&gt; f (Pattern loc)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538786"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-769"></span><span>  </span><span id="local-6989586621680538788"><span class="annot"><span class="annottext">p :: Pattern loc
</span><a href="#local-6989586621680538788"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Int</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pattern loc -&gt; f (Pattern loc)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538788"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-770"></span><span>  </span><span id="local-6989586621680538790"><span class="annot"><span class="annottext">p :: Pattern loc
</span><a href="#local-6989586621680538790"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Nat</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pattern loc -&gt; f (Pattern loc)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538790"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-771"></span><span>  </span><span id="local-6989586621680538792"><span class="annot"><span class="annottext">p :: Pattern loc
</span><a href="#local-6989586621680538792"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Float</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pattern loc -&gt; f (Pattern loc)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538792"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-772"></span><span>  </span><span id="local-6989586621680538794"><span class="annot"><span class="annottext">p :: Pattern loc
</span><a href="#local-6989586621680538794"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Text</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pattern loc -&gt; f (Pattern loc)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538794"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-773"></span><span>  </span><span id="local-6989586621680538796"><span class="annot"><span class="annottext">p :: Pattern loc
</span><a href="#local-6989586621680538796"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Char</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pattern loc -&gt; f (Pattern loc)
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538796"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-774"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.Constructor</span></span><span> </span><span id="local-6989586621680538799"><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621680538799"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621680538800"><span class="annot"><span class="annottext">ConstructorReference
</span><a href="#local-6989586621680538800"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621680538801"><span class="annot"><span class="annottext">[Pattern loc]
</span><a href="#local-6989586621680538801"><span class="hs-identifier hs-var">patterns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-775"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680538802"><span class="annot"><span class="annottext">ConstructorReference
</span><a href="#local-6989586621680538802"><span class="hs-identifier hs-var">newRef</span></a></span></span><span> </span><span id="local-6989586621680538803"><span class="annot"><span class="annottext">[Pattern loc]
</span><a href="#local-6989586621680538803"><span class="hs-identifier hs-var">newPatterns</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">loc -&gt; ConstructorReference -&gt; [Pattern loc] -&gt; Pattern loc
forall loc.
loc -&gt; ConstructorReference -&gt; [Pattern loc] -&gt; Pattern loc
</span><span class="hs-identifier hs-var">Pattern.Constructor</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621680538799"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorReference
</span><a href="#local-6989586621680538802"><span class="hs-identifier hs-var">newRef</span></a></span><span> </span><span class="annot"><span class="annottext">[Pattern loc]
</span><a href="#local-6989586621680538803"><span class="hs-identifier hs-var">newPatterns</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-776"></span><span>      </span><span class="annot"><span class="annottext">(ConstructorReference -&gt; [Pattern loc] -&gt; Pattern loc)
-&gt; f ConstructorReference -&gt; f ([Pattern loc] -&gt; Pattern loc)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstructorReference
</span><a href="#local-6989586621680538800"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorReference
-&gt; (ConstructorReference -&gt; f ConstructorReference)
-&gt; f ConstructorReference
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; ConstructorReference -&gt; f ConstructorReference
Traversal' ConstructorReference SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someRefCon_"><span class="hs-identifier hs-var">someRefCon_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; f SomeReferenceId)
 -&gt; ConstructorReference -&gt; f ConstructorReference)
-&gt; (SomeReferenceId -&gt; f SomeReferenceId)
-&gt; ConstructorReference
-&gt; f ConstructorReference
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538781"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-777"></span><span>      </span><span class="annot"><span class="annottext">f ([Pattern loc] -&gt; Pattern loc)
-&gt; f [Pattern loc] -&gt; f (Pattern loc)
forall a b. f (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Pattern loc]
</span><a href="#local-6989586621680538801"><span class="hs-identifier hs-var">patterns</span></a></span><span> </span><span class="annot"><span class="annottext">[Pattern loc]
-&gt; ([Pattern loc] -&gt; f [Pattern loc]) -&gt; f [Pattern loc]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Pattern loc -&gt; f (Pattern loc))
-&gt; [Pattern loc] -&gt; f [Pattern loc]
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int [Pattern loc] [Pattern loc] (Pattern loc) (Pattern loc)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">((Pattern loc -&gt; f (Pattern loc))
 -&gt; [Pattern loc] -&gt; f [Pattern loc])
-&gt; ((SomeReferenceId -&gt; f SomeReferenceId)
    -&gt; Pattern loc -&gt; f (Pattern loc))
-&gt; (SomeReferenceId -&gt; f SomeReferenceId)
-&gt; [Pattern loc]
-&gt; f [Pattern loc]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
forall loc (f :: * -&gt; *).
Applicative f =&gt;
(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patternReferences_"><span class="hs-identifier hs-var">patternReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; f SomeReferenceId)
 -&gt; [Pattern loc] -&gt; f [Pattern loc])
-&gt; (SomeReferenceId -&gt; f SomeReferenceId)
-&gt; [Pattern loc]
-&gt; f [Pattern loc]
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538781"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-778"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.As</span></span><span> </span><span id="local-6989586621680538805"><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621680538805"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621680538806"><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538806"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">loc -&gt; Pattern loc -&gt; Pattern loc
forall loc. loc -&gt; Pattern loc -&gt; Pattern loc
</span><span class="hs-identifier hs-var">Pattern.As</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621680538805"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">(Pattern loc -&gt; Pattern loc) -&gt; f (Pattern loc) -&gt; f (Pattern loc)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
forall loc (f :: * -&gt; *).
Applicative f =&gt;
(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patternReferences_"><span class="hs-identifier hs-var">patternReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538781"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538806"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-779"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.EffectPure</span></span><span> </span><span id="local-6989586621680538808"><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621680538808"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621680538809"><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538809"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">loc -&gt; Pattern loc -&gt; Pattern loc
forall loc. loc -&gt; Pattern loc -&gt; Pattern loc
</span><span class="hs-identifier hs-var">Pattern.EffectPure</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621680538808"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">(Pattern loc -&gt; Pattern loc) -&gt; f (Pattern loc) -&gt; f (Pattern loc)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
forall loc (f :: * -&gt; *).
Applicative f =&gt;
(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patternReferences_"><span class="hs-identifier hs-var">patternReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538781"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538809"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-780"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.EffectBind</span></span><span> </span><span id="local-6989586621680538811"><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621680538811"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621680538812"><span class="annot"><span class="annottext">ConstructorReference
</span><a href="#local-6989586621680538812"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621680538813"><span class="annot"><span class="annottext">[Pattern loc]
</span><a href="#local-6989586621680538813"><span class="hs-identifier hs-var">patterns</span></a></span></span><span> </span><span id="local-6989586621680538814"><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538814"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-781"></span><span>    </span><span class="hs-keyword">do</span><span>
</span><span id="line-782"></span><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680538815"><span class="annot"><span class="annottext">ConstructorReference
</span><a href="#local-6989586621680538815"><span class="hs-identifier hs-var">newRef</span></a></span></span><span> </span><span id="local-6989586621680538816"><span class="annot"><span class="annottext">[Pattern loc]
</span><a href="#local-6989586621680538816"><span class="hs-identifier hs-var">newPatterns</span></a></span></span><span> </span><span id="local-6989586621680538817"><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538817"><span class="hs-identifier hs-var">newPat</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">loc
-&gt; ConstructorReference
-&gt; [Pattern loc]
-&gt; Pattern loc
-&gt; Pattern loc
forall loc.
loc
-&gt; ConstructorReference
-&gt; [Pattern loc]
-&gt; Pattern loc
-&gt; Pattern loc
</span><span class="hs-identifier hs-var">Pattern.EffectBind</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621680538811"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorReference
</span><a href="#local-6989586621680538815"><span class="hs-identifier hs-var">newRef</span></a></span><span> </span><span class="annot"><span class="annottext">[Pattern loc]
</span><a href="#local-6989586621680538816"><span class="hs-identifier hs-var">newPatterns</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538817"><span class="hs-identifier hs-var">newPat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-783"></span><span>      </span><span class="annot"><span class="annottext">(ConstructorReference
 -&gt; [Pattern loc] -&gt; Pattern loc -&gt; Pattern loc)
-&gt; f ConstructorReference
-&gt; f ([Pattern loc] -&gt; Pattern loc -&gt; Pattern loc)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstructorReference
</span><a href="#local-6989586621680538812"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorReference
-&gt; (ConstructorReference -&gt; f ConstructorReference)
-&gt; f ConstructorReference
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; ConstructorReference -&gt; f ConstructorReference
Traversal' ConstructorReference SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someRefCon_"><span class="hs-identifier hs-var">someRefCon_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; f SomeReferenceId)
 -&gt; ConstructorReference -&gt; f ConstructorReference)
-&gt; (SomeReferenceId -&gt; f SomeReferenceId)
-&gt; ConstructorReference
-&gt; f ConstructorReference
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538781"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-784"></span><span>      </span><span class="annot"><span class="annottext">f ([Pattern loc] -&gt; Pattern loc -&gt; Pattern loc)
-&gt; f [Pattern loc] -&gt; f (Pattern loc -&gt; Pattern loc)
forall a b. f (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Pattern loc]
</span><a href="#local-6989586621680538813"><span class="hs-identifier hs-var">patterns</span></a></span><span> </span><span class="annot"><span class="annottext">[Pattern loc]
-&gt; ([Pattern loc] -&gt; f [Pattern loc]) -&gt; f [Pattern loc]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Pattern loc -&gt; f (Pattern loc))
-&gt; [Pattern loc] -&gt; f [Pattern loc]
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int [Pattern loc] [Pattern loc] (Pattern loc) (Pattern loc)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">((Pattern loc -&gt; f (Pattern loc))
 -&gt; [Pattern loc] -&gt; f [Pattern loc])
-&gt; ((SomeReferenceId -&gt; f SomeReferenceId)
    -&gt; Pattern loc -&gt; f (Pattern loc))
-&gt; (SomeReferenceId -&gt; f SomeReferenceId)
-&gt; [Pattern loc]
-&gt; f [Pattern loc]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
forall loc (f :: * -&gt; *).
Applicative f =&gt;
(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patternReferences_"><span class="hs-identifier hs-var">patternReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; f SomeReferenceId)
 -&gt; [Pattern loc] -&gt; f [Pattern loc])
-&gt; (SomeReferenceId -&gt; f SomeReferenceId)
-&gt; [Pattern loc]
-&gt; f [Pattern loc]
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538781"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-785"></span><span>      </span><span class="annot"><span class="annottext">f (Pattern loc -&gt; Pattern loc)
-&gt; f (Pattern loc) -&gt; f (Pattern loc)
forall a b. f (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
forall loc (f :: * -&gt; *).
Applicative f =&gt;
(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patternReferences_"><span class="hs-identifier hs-var">patternReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538781"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538814"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-786"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pattern.SequenceLiteral</span></span><span> </span><span id="local-6989586621680538819"><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621680538819"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621680538820"><span class="annot"><span class="annottext">[Pattern loc]
</span><a href="#local-6989586621680538820"><span class="hs-identifier hs-var">patterns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-787"></span><span>    </span><span class="annot"><span class="annottext">loc -&gt; [Pattern loc] -&gt; Pattern loc
forall loc. loc -&gt; [Pattern loc] -&gt; Pattern loc
</span><span class="hs-identifier hs-var">Pattern.SequenceLiteral</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621680538819"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">([Pattern loc] -&gt; Pattern loc)
-&gt; f [Pattern loc] -&gt; f (Pattern loc)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Pattern loc]
</span><a href="#local-6989586621680538820"><span class="hs-identifier hs-var">patterns</span></a></span><span> </span><span class="annot"><span class="annottext">[Pattern loc]
-&gt; ([Pattern loc] -&gt; f [Pattern loc]) -&gt; f [Pattern loc]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Pattern loc -&gt; f (Pattern loc))
-&gt; [Pattern loc] -&gt; f [Pattern loc]
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int [Pattern loc] [Pattern loc] (Pattern loc) (Pattern loc)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">((Pattern loc -&gt; f (Pattern loc))
 -&gt; [Pattern loc] -&gt; f [Pattern loc])
-&gt; ((SomeReferenceId -&gt; f SomeReferenceId)
    -&gt; Pattern loc -&gt; f (Pattern loc))
-&gt; (SomeReferenceId -&gt; f SomeReferenceId)
-&gt; [Pattern loc]
-&gt; f [Pattern loc]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
forall loc (f :: * -&gt; *).
Applicative f =&gt;
(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patternReferences_"><span class="hs-identifier hs-var">patternReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; f SomeReferenceId)
 -&gt; [Pattern loc] -&gt; f [Pattern loc])
-&gt; (SomeReferenceId -&gt; f SomeReferenceId)
-&gt; [Pattern loc]
-&gt; f [Pattern loc]
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538781"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-788"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Pattern.SequenceOp</span></span><span> </span><span id="local-6989586621680538822"><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621680538822"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621680538823"><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538823"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621680538824"><span class="annot"><span class="annottext">SeqOp
</span><a href="#local-6989586621680538824"><span class="hs-identifier hs-var">seqOp</span></a></span></span><span> </span><span id="local-6989586621680538825"><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538825"><span class="hs-identifier hs-var">pat2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-789"></span><span>    </span><span class="annot"><span class="annottext">loc -&gt; Pattern loc -&gt; SeqOp -&gt; Pattern loc -&gt; Pattern loc
forall loc.
loc -&gt; Pattern loc -&gt; SeqOp -&gt; Pattern loc -&gt; Pattern loc
</span><span class="hs-identifier hs-var">Pattern.SequenceOp</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621680538822"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">(Pattern loc -&gt; SeqOp -&gt; Pattern loc -&gt; Pattern loc)
-&gt; f (Pattern loc) -&gt; f (SeqOp -&gt; Pattern loc -&gt; Pattern loc)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
forall loc (f :: * -&gt; *).
Applicative f =&gt;
(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patternReferences_"><span class="hs-identifier hs-var">patternReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538781"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538823"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">f (SeqOp -&gt; Pattern loc -&gt; Pattern loc)
-&gt; f SeqOp -&gt; f (Pattern loc -&gt; Pattern loc)
forall a b. f (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SeqOp -&gt; f SeqOp
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SeqOp
</span><a href="#local-6989586621680538824"><span class="hs-identifier hs-var">seqOp</span></a></span><span> </span><span class="annot"><span class="annottext">f (Pattern loc -&gt; Pattern loc)
-&gt; f (Pattern loc) -&gt; f (Pattern loc)
forall a b. f (a -&gt; b) -&gt; f a -&gt; f b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
forall loc (f :: * -&gt; *).
Applicative f =&gt;
(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; Pattern loc -&gt; f (Pattern loc)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#patternReferences_"><span class="hs-identifier hs-var">patternReferences_</span></a></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538781"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Pattern loc
</span><a href="#local-6989586621680538825"><span class="hs-identifier hs-var">pat2</span></a></span><span>
</span><span id="line-790"></span><span>
</span><span id="line-791"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#referentAsSomeTermReference_"><span class="hs-identifier hs-type">referentAsSomeTermReference_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent.Referent</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span>
</span><span id="line-792"></span><span id="referentAsSomeTermReference_"><span class="annot"><span class="annottext">referentAsSomeTermReference_ :: Traversal' Referent SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#referentAsSomeTermReference_"><span class="hs-identifier hs-var hs-var">referentAsSomeTermReference_</span></a></span></span><span> </span><span id="local-6989586621680538833"><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538833"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-793"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Referent'.Ref'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.DerivedId</span></span><span> </span><span id="local-6989586621680538835"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538835"><span class="hs-identifier hs-var">refId</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-794"></span><span>    </span><span id="local-6989586621680538836"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538836"><span class="hs-identifier hs-var">newRefId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538835"><span class="hs-identifier hs-var">refId</span></a></span><span> </span><span class="annot"><span class="annottext">Old Id -&gt; (Old Id -&gt; f (Old Id)) -&gt; f (Old Id)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId) -&gt; Old Id -&gt; f (Old Id)
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTermReference_"><span class="hs-identifier hs-var">asTermReference_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; f SomeReferenceId) -&gt; Old Id -&gt; f (Old Id))
-&gt; (SomeReferenceId -&gt; f SomeReferenceId) -&gt; Old Id -&gt; f (Old Id)
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538833"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-795"></span><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; Referent
forall r. r -&gt; Referent' r
</span><span class="hs-identifier hs-var">Referent'.Ref'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; Reference
forall h t. Id' h -&gt; Reference' t h
</span><span class="hs-identifier hs-var">Reference.DerivedId</span></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538836"><span class="hs-identifier hs-var">newRefId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-796"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Referent'.Con'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference.ConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.DerivedId</span></span><span> </span><span id="local-6989586621680538838"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538838"><span class="hs-identifier hs-var">refId</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680538839"><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538839"><span class="hs-identifier hs-var">conId</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680538840"><span class="annot"><span class="annottext">ConstructorType
</span><a href="#local-6989586621680538840"><span class="hs-identifier hs-var">conType</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-797"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; Old ConstructorId -&gt; ConstructorReferenceId
forall r. r -&gt; Old ConstructorId -&gt; GConstructorReference r
</span><span class="hs-identifier hs-var">ConstructorReference.ConstructorReference</span></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538838"><span class="hs-identifier hs-var">refId</span></a></span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538839"><span class="hs-identifier hs-var">conId</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorReferenceId
-&gt; (ConstructorReferenceId -&gt; f ConstructorReferenceId)
-&gt; f ConstructorReferenceId
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(SomeReferenceId -&gt; f SomeReferenceId)
-&gt; ConstructorReferenceId -&gt; f ConstructorReferenceId
forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref))
-&gt; GConstructorReference ref -&gt; f (GConstructorReference ref)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asConstructorReference_"><span class="hs-identifier hs-var">asConstructorReference_</span></a></span><span> </span><span class="annot"><span class="annottext">((SomeReferenceId -&gt; f SomeReferenceId)
 -&gt; ConstructorReferenceId -&gt; f ConstructorReferenceId)
-&gt; (SomeReferenceId -&gt; f SomeReferenceId)
-&gt; ConstructorReferenceId
-&gt; f ConstructorReferenceId
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; f SomeReferenceId
</span><a href="#local-6989586621680538833"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-798"></span><span>      </span><span class="annot"><span class="annottext">f ConstructorReferenceId
-&gt; (ConstructorReferenceId -&gt; Referent) -&gt; f Referent
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference.ConstructorReference</span></span><span> </span><span id="local-6989586621680538841"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538841"><span class="hs-identifier hs-var">newRefId</span></a></span></span><span> </span><span id="local-6989586621680538842"><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538842"><span class="hs-identifier hs-var">newConId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-799"></span><span>        </span><span class="annot"><span class="annottext">ConstructorReference -&gt; ConstructorType -&gt; Referent
forall r. GConstructorReference r -&gt; ConstructorType -&gt; Referent' r
</span><span class="hs-identifier hs-var">Referent'.Con'</span></span><span>
</span><span id="line-800"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reference -&gt; Old ConstructorId -&gt; ConstructorReference
forall r. r -&gt; Old ConstructorId -&gt; GConstructorReference r
</span><span class="hs-identifier hs-var">ConstructorReference.ConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; Reference
forall h t. Id' h -&gt; Reference' t h
</span><span class="hs-identifier hs-var">Reference.DerivedId</span></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680538841"><span class="hs-identifier hs-var">newRefId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680538842"><span class="hs-identifier hs-var">newConId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-801"></span><span>          </span><span class="annot"><span class="annottext">ConstructorType
</span><a href="#local-6989586621680538840"><span class="hs-identifier hs-var">conType</span></a></span><span>
</span><span id="line-802"></span><span>  </span><span id="local-6989586621680538843"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680538843"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Referent -&gt; f Referent
forall a. a -&gt; f a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680538843"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-803"></span><span>
</span><span id="line-804"></span><span class="hs-keyword">type</span><span> </span><span id="SomeReferenceId"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-var">SomeReferenceId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span>
</span><span id="line-805"></span><span>
</span><span id="line-806"></span><span class="hs-keyword">type</span><span> </span><span id="SomeReferenceObjId"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceObjId"><span class="hs-identifier hs-var">SomeReferenceObjId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span class="hs-special">)</span><span>
</span><span id="line-807"></span><span>
</span><span id="line-808"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#remapObjIdRefs"><span class="hs-identifier hs-type">remapObjIdRefs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-809"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-type">New</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-type">New</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HashId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-type">New</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Old"><span class="hs-identifier hs-type">Old</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-810"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-811"></span><span>  </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceObjId"><span class="hs-identifier hs-type">SomeReferenceObjId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-812"></span><span>  </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceObjId"><span class="hs-identifier hs-type">SomeReferenceObjId</span></a></span><span>
</span><span id="line-813"></span><span id="remapObjIdRefs"><span class="annot"><span class="annottext">remapObjIdRefs :: Map ObjectId (ObjectId, HashId, New Hash, New Hash)
-&gt; Map SomeReferenceId SomeReferenceId
-&gt; SomeReference (Id' ObjectId)
-&gt; SomeReference (Id' ObjectId)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#remapObjIdRefs"><span class="hs-identifier hs-var hs-var">remapObjIdRefs</span></a></span></span><span> </span><span id="local-6989586621680538845"><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538845"><span class="hs-identifier hs-var">objMapping</span></a></span></span><span> </span><span id="local-6989586621680538846"><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538846"><span class="hs-identifier hs-var">refMapping</span></a></span></span><span> </span><span id="local-6989586621680538847"><span class="annot"><span class="annottext">SomeReference (Id' ObjectId)
</span><a href="#local-6989586621680538847"><span class="hs-identifier hs-var">someObjIdRef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' ObjectId)
</span><a href="#local-6989586621680538848"><span class="hs-identifier hs-var">newSomeObjId</span></a></span><span>
</span><span id="line-814"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-815"></span><span>    </span><span class="annot"><a href="#local-6989586621680538849"><span class="hs-identifier hs-type">oldObjId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span>
</span><span id="line-816"></span><span>    </span><span id="local-6989586621680538849"><span class="annot"><span class="annottext">oldObjId :: ObjectId
</span><a href="#local-6989586621680538849"><span class="hs-identifier hs-var hs-var">oldObjId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' ObjectId)
</span><a href="#local-6989586621680538847"><span class="hs-identifier hs-var">someObjIdRef</span></a></span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' ObjectId)
-&gt; Getting ObjectId (SomeReference (Id' ObjectId)) ObjectId
-&gt; ObjectId
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(Id' ObjectId -&gt; Const ObjectId (Id' ObjectId))
-&gt; SomeReference (Id' ObjectId)
-&gt; Const ObjectId (SomeReference (Id' ObjectId))
forall ref ref' (f :: * -&gt; *).
Functor f =&gt;
(ref -&gt; f ref') -&gt; SomeReference ref -&gt; f (SomeReference ref')
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someRef_"><span class="hs-identifier hs-var">someRef_</span></a></span><span> </span><span class="annot"><span class="annottext">((Id' ObjectId -&gt; Const ObjectId (Id' ObjectId))
 -&gt; SomeReference (Id' ObjectId)
 -&gt; Const ObjectId (SomeReference (Id' ObjectId)))
-&gt; ((ObjectId -&gt; Const ObjectId ObjectId)
    -&gt; Id' ObjectId -&gt; Const ObjectId (Id' ObjectId))
-&gt; Getting ObjectId (SomeReference (Id' ObjectId)) ObjectId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ObjectId -&gt; Const ObjectId ObjectId)
-&gt; Id' ObjectId -&gt; Const ObjectId (Id' ObjectId)
forall h h' (f :: * -&gt; *).
Functor f =&gt;
(h -&gt; f h') -&gt; Id' h -&gt; f (Id' h')
</span><span class="hs-identifier hs-var">UReference.idH</span></span><span>
</span><span id="line-817"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680538853"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538853"><span class="hs-identifier hs-var">newObjId</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HashId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">New Hash
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538854"><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538854"><span class="hs-identifier hs-var">oldHash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-818"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ObjectId
-&gt; Map ObjectId (ObjectId, HashId, New Hash, New Hash)
-&gt; Maybe (ObjectId, HashId, New Hash, New Hash)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538849"><span class="hs-identifier hs-var">oldObjId</span></a></span><span> </span><span class="annot"><span class="annottext">Map ObjectId (ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538845"><span class="hs-identifier hs-var">objMapping</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-819"></span><span>        </span><span class="annot"><span class="annottext">Maybe (ObjectId, HashId, New Hash, New Hash)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; (ObjectId, HashId, New Hash, New Hash)
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; (ObjectId, HashId, New Hash, New Hash))
-&gt; [Char] -&gt; (ObjectId, HashId, New Hash, New Hash)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Expected object mapping for ID: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538849"><span class="hs-identifier hs-var">oldObjId</span></a></span><span>
</span><span id="line-820"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680538855"><span class="annot"><span class="annottext">(ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538855"><span class="hs-identifier hs-var">found</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ObjectId, HashId, New Hash, New Hash)
</span><a href="#local-6989586621680538855"><span class="hs-identifier hs-var">found</span></a></span><span>
</span><span id="line-821"></span><span>    </span><span class="annot"><a href="#local-6989586621680538856"><span class="hs-identifier hs-type">oldSomeRefId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span>
</span><span id="line-822"></span><span>    </span><span id="local-6989586621680538856"><span class="annot"><span class="annottext">oldSomeRefId :: SomeReferenceId
</span><a href="#local-6989586621680538856"><span class="hs-identifier hs-var hs-var">oldSomeRefId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeReference (Id' ObjectId)
</span><a href="#local-6989586621680538847"><span class="hs-identifier hs-var">someObjIdRef</span></a></span><span> </span><span class="annot"><span class="annottext">SomeReference (Id' ObjectId)
-&gt; (SomeReference (Id' ObjectId) -&gt; SomeReferenceId)
-&gt; SomeReferenceId
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Id' ObjectId -&gt; Identity (Old Id))
-&gt; SomeReference (Id' ObjectId) -&gt; Identity SomeReferenceId
forall ref ref' (f :: * -&gt; *).
Functor f =&gt;
(ref -&gt; f ref') -&gt; SomeReference ref -&gt; f (SomeReference ref')
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someRef_"><span class="hs-identifier hs-var">someRef_</span></a></span><span> </span><span class="annot"><span class="annottext">((Id' ObjectId -&gt; Identity (Old Id))
 -&gt; SomeReference (Id' ObjectId) -&gt; Identity SomeReferenceId)
-&gt; ((ObjectId -&gt; Identity (New Hash))
    -&gt; Id' ObjectId -&gt; Identity (Old Id))
-&gt; (ObjectId -&gt; Identity (New Hash))
-&gt; SomeReference (Id' ObjectId)
-&gt; Identity SomeReferenceId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ObjectId -&gt; Identity (New Hash))
-&gt; Id' ObjectId -&gt; Identity (Old Id)
forall h h' (f :: * -&gt; *).
Functor f =&gt;
(h -&gt; f h') -&gt; Id' h -&gt; f (Id' h')
</span><span class="hs-identifier hs-var">UReference.idH</span></span><span> </span><span class="annot"><span class="annottext">((ObjectId -&gt; Identity (New Hash))
 -&gt; SomeReference (Id' ObjectId) -&gt; Identity SomeReferenceId)
-&gt; New Hash -&gt; SomeReference (Id' ObjectId) -&gt; SomeReferenceId
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">New Hash
</span><a href="#local-6989586621680538854"><span class="hs-identifier hs-var">oldHash</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
-&gt; Getting SomeReferenceId SomeReferenceId SomeReferenceId
-&gt; SomeReferenceId
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting SomeReferenceId SomeReferenceId SomeReferenceId
Iso' SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#uRefIdAsRefId_"><span class="hs-identifier hs-var">uRefIdAsRefId_</span></a></span><span>
</span><span id="line-823"></span><span>    </span><span class="annot"><a href="#local-6989586621680538858"><span class="hs-identifier hs-type">newSomeRefId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span>
</span><span id="line-824"></span><span>    </span><span id="local-6989586621680538858"><span class="annot"><span class="annottext">newSomeRefId :: SomeReferenceId
</span><a href="#local-6989586621680538858"><span class="hs-identifier hs-var hs-var">newSomeRefId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
-&gt; Map SomeReferenceId SomeReferenceId -&gt; Maybe SomeReferenceId
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538856"><span class="hs-identifier hs-var">oldSomeRefId</span></a></span><span> </span><span class="annot"><span class="annottext">Map SomeReferenceId SomeReferenceId
</span><a href="#local-6989586621680538846"><span class="hs-identifier hs-var">refMapping</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-825"></span><span>      </span><span class="annot"><span class="annottext">Maybe SomeReferenceId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; SomeReferenceId
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; SomeReferenceId) -&gt; [Char] -&gt; SomeReferenceId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Expected reference mapping for ID: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538856"><span class="hs-identifier hs-var">oldSomeRefId</span></a></span><span>
</span><span id="line-826"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680538859"><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538859"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538859"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-827"></span><span>    </span><span class="annot"><a href="#local-6989586621680538848"><span class="hs-identifier hs-type">newSomeObjId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">UReference.Id'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#New"><span class="hs-identifier hs-type">New</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-828"></span><span>    </span><span id="local-6989586621680538848"><span class="annot"><span class="annottext">newSomeObjId :: SomeReference (Id' ObjectId)
</span><a href="#local-6989586621680538848"><span class="hs-identifier hs-var hs-var">newSomeObjId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeReferenceId
</span><a href="#local-6989586621680538858"><span class="hs-identifier hs-var">newSomeRefId</span></a></span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
-&gt; Getting SomeReferenceId SomeReferenceId SomeReferenceId
-&gt; SomeReferenceId
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">AnIso
  SomeReferenceId SomeReferenceId SomeReferenceId SomeReferenceId
-&gt; Iso' SomeReferenceId SomeReferenceId
forall s t a b. AnIso s t a b -&gt; Iso b a t s
</span><span class="hs-identifier hs-var">Lens.from</span></span><span> </span><span class="annot"><span class="annottext">AnIso
  SomeReferenceId SomeReferenceId SomeReferenceId SomeReferenceId
Iso' SomeReferenceId SomeReferenceId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#uRefIdAsRefId_"><span class="hs-identifier hs-var">uRefIdAsRefId_</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SomeReferenceId
-&gt; (SomeReferenceId -&gt; SomeReference (Id' ObjectId))
-&gt; SomeReference (Id' ObjectId)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Old Id -&gt; Identity (Id' ObjectId))
-&gt; SomeReferenceId -&gt; Identity (SomeReference (Id' ObjectId))
forall ref ref' (f :: * -&gt; *).
Functor f =&gt;
(ref -&gt; f ref') -&gt; SomeReference ref -&gt; f (SomeReference ref')
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someRef_"><span class="hs-identifier hs-var">someRef_</span></a></span><span> </span><span class="annot"><span class="annottext">((Old Id -&gt; Identity (Id' ObjectId))
 -&gt; SomeReferenceId -&gt; Identity (SomeReference (Id' ObjectId)))
-&gt; ((New Hash -&gt; Identity ObjectId)
    -&gt; Old Id -&gt; Identity (Id' ObjectId))
-&gt; (New Hash -&gt; Identity ObjectId)
-&gt; SomeReferenceId
-&gt; Identity (SomeReference (Id' ObjectId))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(New Hash -&gt; Identity ObjectId)
-&gt; Old Id -&gt; Identity (Id' ObjectId)
forall h h' (f :: * -&gt; *).
Functor f =&gt;
(h -&gt; f h') -&gt; Id' h -&gt; f (Id' h')
</span><span class="hs-identifier hs-var">UReference.idH</span></span><span> </span><span class="annot"><span class="annottext">((New Hash -&gt; Identity ObjectId)
 -&gt; SomeReferenceId -&gt; Identity (SomeReference (Id' ObjectId)))
-&gt; ObjectId -&gt; SomeReferenceId -&gt; SomeReference (Id' ObjectId)
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><span class="hs-operator hs-var">.~</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680538853"><span class="hs-identifier hs-var">newObjId</span></a></span><span>
</span><span id="line-829"></span><span>
</span><span id="line-830"></span><span class="hs-keyword">data</span><span> </span><span id="SomeReference"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-var">SomeReference</span></a></span></span><span> </span><span id="local-6989586621680536257"><span class="annot"><a href="#local-6989586621680536257"><span class="hs-identifier hs-type">ref</span></a></span></span><span>
</span><span id="line-831"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="TermReference"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermReference"><span class="hs-identifier hs-var">TermReference</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621680536257"><span class="hs-identifier hs-type">ref</span></a></span><span>
</span><span id="line-832"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="TypeReference"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TypeReference"><span class="hs-identifier hs-var">TypeReference</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621680536257"><span class="hs-identifier hs-type">ref</span></a></span><span>
</span><span id="line-833"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ConstructorReference"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#ConstructorReference"><span class="hs-identifier hs-var">ConstructorReference</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621680536257"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ConstructorId</span></span><span>
</span><span id="line-834"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680538862"><span id="local-6989586621680538869"><span class="annot"><span class="annottext">SomeReference ref -&gt; SomeReference ref -&gt; Bool
(SomeReference ref -&gt; SomeReference ref -&gt; Bool)
-&gt; (SomeReference ref -&gt; SomeReference ref -&gt; Bool)
-&gt; Eq (SomeReference ref)
forall ref.
Eq ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: forall ref.
Eq ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; Bool
== :: SomeReference ref -&gt; SomeReference ref -&gt; Bool
$c/= :: forall ref.
Eq ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; Bool
/= :: SomeReference ref -&gt; SomeReference ref -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538873"><span id="local-6989586621680538875"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; SomeReference a -&gt; SomeReference b)
-&gt; (forall a b. a -&gt; SomeReference b -&gt; SomeReference a)
-&gt; Functor SomeReference
forall a b. a -&gt; SomeReference b -&gt; SomeReference a
forall a b. (a -&gt; b) -&gt; SomeReference a -&gt; SomeReference b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
$cfmap :: forall a b. (a -&gt; b) -&gt; SomeReference a -&gt; SomeReference b
fmap :: forall a b. (a -&gt; b) -&gt; SomeReference a -&gt; SomeReference b
$c&lt;$ :: forall a b. a -&gt; SomeReference b -&gt; SomeReference a
&lt;$ :: forall a b. a -&gt; SomeReference b -&gt; SomeReference a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538878"><span id="local-6989586621680538880"><span class="annot"><span class="annottext">(forall x. SomeReference ref -&gt; Rep (SomeReference ref) x)
-&gt; (forall x. Rep (SomeReference ref) x -&gt; SomeReference ref)
-&gt; Generic (SomeReference ref)
forall x. Rep (SomeReference ref) x -&gt; SomeReference ref
forall x. SomeReference ref -&gt; Rep (SomeReference ref) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall ref x. Rep (SomeReference ref) x -&gt; SomeReference ref
forall ref x. SomeReference ref -&gt; Rep (SomeReference ref) x
$cfrom :: forall ref x. SomeReference ref -&gt; Rep (SomeReference ref) x
from :: forall x. SomeReference ref -&gt; Rep (SomeReference ref) x
$cto :: forall ref x. Rep (SomeReference ref) x -&gt; SomeReference ref
to :: forall x. Rep (SomeReference ref) x -&gt; SomeReference ref
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538887"><span id="local-6989586621680538894"><span id="local-6989586621680538900"><span id="local-6989586621680538903"><span id="local-6989586621680538906"><span id="local-6989586621680538909"><span id="local-6989586621680538912"><span class="annot"><span class="annottext">Eq (SomeReference ref)
Eq (SomeReference ref) =&gt;
(SomeReference ref -&gt; SomeReference ref -&gt; Ordering)
-&gt; (SomeReference ref -&gt; SomeReference ref -&gt; Bool)
-&gt; (SomeReference ref -&gt; SomeReference ref -&gt; Bool)
-&gt; (SomeReference ref -&gt; SomeReference ref -&gt; Bool)
-&gt; (SomeReference ref -&gt; SomeReference ref -&gt; Bool)
-&gt; (SomeReference ref -&gt; SomeReference ref -&gt; SomeReference ref)
-&gt; (SomeReference ref -&gt; SomeReference ref -&gt; SomeReference ref)
-&gt; Ord (SomeReference ref)
SomeReference ref -&gt; SomeReference ref -&gt; Bool
SomeReference ref -&gt; SomeReference ref -&gt; Ordering
SomeReference ref -&gt; SomeReference ref -&gt; SomeReference ref
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
forall ref. Ord ref =&gt; Eq (SomeReference ref)
forall ref.
Ord ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; Bool
forall ref.
Ord ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; Ordering
forall ref.
Ord ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; SomeReference ref
$ccompare :: forall ref.
Ord ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; Ordering
compare :: SomeReference ref -&gt; SomeReference ref -&gt; Ordering
$c&lt; :: forall ref.
Ord ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; Bool
&lt; :: SomeReference ref -&gt; SomeReference ref -&gt; Bool
$c&lt;= :: forall ref.
Ord ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; Bool
&lt;= :: SomeReference ref -&gt; SomeReference ref -&gt; Bool
$c&gt; :: forall ref.
Ord ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; Bool
&gt; :: SomeReference ref -&gt; SomeReference ref -&gt; Bool
$c&gt;= :: forall ref.
Ord ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; Bool
&gt;= :: SomeReference ref -&gt; SomeReference ref -&gt; Bool
$cmax :: forall ref.
Ord ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; SomeReference ref
max :: SomeReference ref -&gt; SomeReference ref -&gt; SomeReference ref
$cmin :: forall ref.
Ord ref =&gt;
SomeReference ref -&gt; SomeReference ref -&gt; SomeReference ref
min :: SomeReference ref -&gt; SomeReference ref -&gt; SomeReference ref
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538916"><span id="local-6989586621680538926"><span id="local-6989586621680538929"><span class="annot"><span class="annottext">Int -&gt; SomeReference ref -&gt; [Char] -&gt; [Char]
[SomeReference ref] -&gt; [Char] -&gt; [Char]
SomeReference ref -&gt; [Char]
(Int -&gt; SomeReference ref -&gt; [Char] -&gt; [Char])
-&gt; (SomeReference ref -&gt; [Char])
-&gt; ([SomeReference ref] -&gt; [Char] -&gt; [Char])
-&gt; Show (SomeReference ref)
forall ref.
Show ref =&gt;
Int -&gt; SomeReference ref -&gt; [Char] -&gt; [Char]
forall ref. Show ref =&gt; [SomeReference ref] -&gt; [Char] -&gt; [Char]
forall ref. Show ref =&gt; SomeReference ref -&gt; [Char]
forall a.
(Int -&gt; a -&gt; [Char] -&gt; [Char])
-&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; [Char] -&gt; [Char]) -&gt; Show a
$cshowsPrec :: forall ref.
Show ref =&gt;
Int -&gt; SomeReference ref -&gt; [Char] -&gt; [Char]
showsPrec :: Int -&gt; SomeReference ref -&gt; [Char] -&gt; [Char]
$cshow :: forall ref. Show ref =&gt; SomeReference ref -&gt; [Char]
show :: SomeReference ref -&gt; [Char]
$cshowList :: forall ref. Show ref =&gt; [SomeReference ref] -&gt; [Char] -&gt; [Char]
showList :: [SomeReference ref] -&gt; [Char] -&gt; [Char]
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680538932"><span id="local-6989586621680538938"><span id="local-6989586621680538941"><span id="local-6989586621680538946"><span id="local-6989586621680538948"><span id="local-6989586621680538951"><span id="local-6989586621680538954"><span id="local-6989586621680538957"><span id="local-6989586621680538960"><span id="local-6989586621680538963"><span id="local-6989586621680538966"><span id="local-6989586621680538968"><span id="local-6989586621680538971"><span id="local-6989586621680538976"><span id="local-6989586621680538981"><span id="local-6989586621680538986"><span id="local-6989586621680538991"><span class="annot"><span class="annottext">(forall m. Monoid m =&gt; SomeReference m -&gt; m)
-&gt; (forall m a. Monoid m =&gt; (a -&gt; m) -&gt; SomeReference a -&gt; m)
-&gt; (forall m a. Monoid m =&gt; (a -&gt; m) -&gt; SomeReference a -&gt; m)
-&gt; (forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b)
-&gt; (forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b)
-&gt; (forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b)
-&gt; (forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b)
-&gt; (forall a. (a -&gt; a -&gt; a) -&gt; SomeReference a -&gt; a)
-&gt; (forall a. (a -&gt; a -&gt; a) -&gt; SomeReference a -&gt; a)
-&gt; (forall a. SomeReference a -&gt; [a])
-&gt; (forall a. SomeReference a -&gt; Bool)
-&gt; (forall a. SomeReference a -&gt; Int)
-&gt; (forall a. Eq a =&gt; a -&gt; SomeReference a -&gt; Bool)
-&gt; (forall a. Ord a =&gt; SomeReference a -&gt; a)
-&gt; (forall a. Ord a =&gt; SomeReference a -&gt; a)
-&gt; (forall a. Num a =&gt; SomeReference a -&gt; a)
-&gt; (forall a. Num a =&gt; SomeReference a -&gt; a)
-&gt; Foldable SomeReference
forall a. Eq a =&gt; a -&gt; SomeReference a -&gt; Bool
forall a. Num a =&gt; SomeReference a -&gt; a
forall a. Ord a =&gt; SomeReference a -&gt; a
forall m. Monoid m =&gt; SomeReference m -&gt; m
forall a. SomeReference a -&gt; Bool
forall a. SomeReference a -&gt; Int
forall a. SomeReference a -&gt; [a]
forall a. (a -&gt; a -&gt; a) -&gt; SomeReference a -&gt; a
forall m a. Monoid m =&gt; (a -&gt; m) -&gt; SomeReference a -&gt; m
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b
forall (t :: * -&gt; *).
(forall m. Monoid m =&gt; t m -&gt; m)
-&gt; (forall m a. Monoid m =&gt; (a -&gt; m) -&gt; t a -&gt; m)
-&gt; (forall m a. Monoid m =&gt; (a -&gt; m) -&gt; t a -&gt; m)
-&gt; (forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b)
-&gt; (forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b)
-&gt; (forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b)
-&gt; (forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b)
-&gt; (forall a. (a -&gt; a -&gt; a) -&gt; t a -&gt; a)
-&gt; (forall a. (a -&gt; a -&gt; a) -&gt; t a -&gt; a)
-&gt; (forall a. t a -&gt; [a])
-&gt; (forall a. t a -&gt; Bool)
-&gt; (forall a. t a -&gt; Int)
-&gt; (forall a. Eq a =&gt; a -&gt; t a -&gt; Bool)
-&gt; (forall a. Ord a =&gt; t a -&gt; a)
-&gt; (forall a. Ord a =&gt; t a -&gt; a)
-&gt; (forall a. Num a =&gt; t a -&gt; a)
-&gt; (forall a. Num a =&gt; t a -&gt; a)
-&gt; Foldable t
$cfold :: forall m. Monoid m =&gt; SomeReference m -&gt; m
fold :: forall m. Monoid m =&gt; SomeReference m -&gt; m
$cfoldMap :: forall m a. Monoid m =&gt; (a -&gt; m) -&gt; SomeReference a -&gt; m
foldMap :: forall m a. Monoid m =&gt; (a -&gt; m) -&gt; SomeReference a -&gt; m
$cfoldMap' :: forall m a. Monoid m =&gt; (a -&gt; m) -&gt; SomeReference a -&gt; m
foldMap' :: forall m a. Monoid m =&gt; (a -&gt; m) -&gt; SomeReference a -&gt; m
$cfoldr :: forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b
foldr :: forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b
$cfoldr' :: forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b
foldr' :: forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b
$cfoldl :: forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b
foldl :: forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b
$cfoldl' :: forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b
foldl' :: forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; SomeReference a -&gt; b
$cfoldr1 :: forall a. (a -&gt; a -&gt; a) -&gt; SomeReference a -&gt; a
foldr1 :: forall a. (a -&gt; a -&gt; a) -&gt; SomeReference a -&gt; a
$cfoldl1 :: forall a. (a -&gt; a -&gt; a) -&gt; SomeReference a -&gt; a
foldl1 :: forall a. (a -&gt; a -&gt; a) -&gt; SomeReference a -&gt; a
$ctoList :: forall a. SomeReference a -&gt; [a]
toList :: forall a. SomeReference a -&gt; [a]
$cnull :: forall a. SomeReference a -&gt; Bool
null :: forall a. SomeReference a -&gt; Bool
$clength :: forall a. SomeReference a -&gt; Int
length :: forall a. SomeReference a -&gt; Int
$celem :: forall a. Eq a =&gt; a -&gt; SomeReference a -&gt; Bool
elem :: forall a. Eq a =&gt; a -&gt; SomeReference a -&gt; Bool
$cmaximum :: forall a. Ord a =&gt; SomeReference a -&gt; a
maximum :: forall a. Ord a =&gt; SomeReference a -&gt; a
$cminimum :: forall a. Ord a =&gt; SomeReference a -&gt; a
minimum :: forall a. Ord a =&gt; SomeReference a -&gt; a
$csum :: forall a. Num a =&gt; SomeReference a -&gt; a
sum :: forall a. Num a =&gt; SomeReference a -&gt; a
$cproduct :: forall a. Num a =&gt; SomeReference a -&gt; a
product :: forall a. Num a =&gt; SomeReference a -&gt; a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Foldable</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680539001"><span id="local-6989586621680539008"><span id="local-6989586621680539014"><span id="local-6989586621680539019"><span class="annot"><span class="annottext">Functor SomeReference
Foldable SomeReference
(Functor SomeReference, Foldable SomeReference) =&gt;
(forall (f :: * -&gt; *) a b.
 Applicative f =&gt;
 (a -&gt; f b) -&gt; SomeReference a -&gt; f (SomeReference b))
-&gt; (forall (f :: * -&gt; *) a.
    Applicative f =&gt;
    SomeReference (f a) -&gt; f (SomeReference a))
-&gt; (forall (m :: * -&gt; *) a b.
    Monad m =&gt;
    (a -&gt; m b) -&gt; SomeReference a -&gt; m (SomeReference b))
-&gt; (forall (m :: * -&gt; *) a.
    Monad m =&gt;
    SomeReference (m a) -&gt; m (SomeReference a))
-&gt; Traversable SomeReference
forall (t :: * -&gt; *).
(Functor t, Foldable t) =&gt;
(forall (f :: * -&gt; *) a b.
 Applicative f =&gt;
 (a -&gt; f b) -&gt; t a -&gt; f (t b))
-&gt; (forall (f :: * -&gt; *) a. Applicative f =&gt; t (f a) -&gt; f (t a))
-&gt; (forall (m :: * -&gt; *) a b.
    Monad m =&gt;
    (a -&gt; m b) -&gt; t a -&gt; m (t b))
-&gt; (forall (m :: * -&gt; *) a. Monad m =&gt; t (m a) -&gt; m (t a))
-&gt; Traversable t
forall (m :: * -&gt; *) a.
Monad m =&gt;
SomeReference (m a) -&gt; m (SomeReference a)
forall (f :: * -&gt; *) a.
Applicative f =&gt;
SomeReference (f a) -&gt; f (SomeReference a)
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; SomeReference a -&gt; m (SomeReference b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; SomeReference a -&gt; f (SomeReference b)
$ctraverse :: forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; SomeReference a -&gt; f (SomeReference b)
traverse :: forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; SomeReference a -&gt; f (SomeReference b)
$csequenceA :: forall (f :: * -&gt; *) a.
Applicative f =&gt;
SomeReference (f a) -&gt; f (SomeReference a)
sequenceA :: forall (f :: * -&gt; *) a.
Applicative f =&gt;
SomeReference (f a) -&gt; f (SomeReference a)
$cmapM :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; SomeReference a -&gt; m (SomeReference b)
mapM :: forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m b) -&gt; SomeReference a -&gt; m (SomeReference b)
$csequence :: forall (m :: * -&gt; *) a.
Monad m =&gt;
SomeReference (m a) -&gt; m (SomeReference a)
sequence :: forall (m :: * -&gt; *) a.
Monad m =&gt;
SomeReference (m a) -&gt; m (SomeReference a)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Traversable</span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-835"></span><span>
</span><span id="line-836"></span><span id="local-6989586621680536625"><span id="local-6989586621680536626"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someRef_"><span class="hs-identifier hs-type">someRef_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Lens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536625"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536626"><span class="hs-identifier hs-type">ref'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680536625"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536626"><span class="hs-identifier hs-type">ref'</span></a></span></span></span><span>
</span><span id="line-837"></span><span id="someRef_"><span class="annot"><span class="annottext">someRef_ :: forall ref ref' (f :: * -&gt; *).
Functor f =&gt;
(ref -&gt; f ref') -&gt; SomeReference ref -&gt; f (SomeReference ref')
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someRef_"><span class="hs-identifier hs-var hs-var">someRef_</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SomeReference ref -&gt; ref)
-&gt; (SomeReference ref -&gt; ref' -&gt; SomeReference ref')
-&gt; Lens (SomeReference ref) (SomeReference ref') ref ref'
forall s a b t. (s -&gt; a) -&gt; (s -&gt; b -&gt; t) -&gt; Lens s t a b
</span><span class="hs-identifier hs-var">lens</span></span><span> </span><span class="annot"><span class="annottext">SomeReference ref -&gt; ref
forall {ref}. SomeReference ref -&gt; ref
</span><a href="#local-6989586621680539027"><span class="hs-identifier hs-var">getter</span></a></span><span> </span><span class="annot"><span class="annottext">SomeReference ref -&gt; ref' -&gt; SomeReference ref'
forall {ref} {ref}. SomeReference ref -&gt; ref -&gt; SomeReference ref
</span><a href="#local-6989586621680539028"><span class="hs-identifier hs-var">setter</span></a></span><span>
</span><span id="line-838"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-839"></span><span>    </span><span id="local-6989586621680539028"><span class="annot"><span class="annottext">setter :: SomeReference ref -&gt; ref -&gt; SomeReference ref
</span><a href="#local-6989586621680539028"><span class="hs-identifier hs-var hs-var">setter</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermReference"><span class="hs-identifier hs-type">TermReference</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680539029"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539029"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ref -&gt; SomeReference ref
forall ref. ref -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermReference"><span class="hs-identifier hs-var">TermReference</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539029"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-840"></span><span>    </span><span class="annot"><a href="#local-6989586621680539028"><span class="hs-identifier hs-var">setter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TypeReference"><span class="hs-identifier hs-type">TypeReference</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680539030"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539030"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ref -&gt; SomeReference ref
forall ref. ref -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TypeReference"><span class="hs-identifier hs-var">TypeReference</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539030"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-841"></span><span>    </span><span class="annot"><a href="#local-6989586621680539028"><span class="hs-identifier hs-var">setter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#ConstructorReference"><span class="hs-identifier hs-type">ConstructorReference</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680539031"><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680539031"><span class="hs-identifier hs-var">conId</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680539032"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539032"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ref -&gt; Old ConstructorId -&gt; SomeReference ref
forall ref. ref -&gt; Old ConstructorId -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#ConstructorReference"><span class="hs-identifier hs-var">ConstructorReference</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539032"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680539031"><span class="hs-identifier hs-var">conId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-842"></span><span>    </span><span id="local-6989586621680539027"><span class="annot"><span class="annottext">getter :: SomeReference ref -&gt; ref
</span><a href="#local-6989586621680539027"><span class="hs-identifier hs-var hs-var">getter</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-843"></span><span>      </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermReference"><span class="hs-identifier hs-type">TermReference</span></a></span><span> </span><span id="local-6989586621680539033"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539033"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539033"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-844"></span><span>      </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TypeReference"><span class="hs-identifier hs-type">TypeReference</span></a></span><span> </span><span id="local-6989586621680539034"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539034"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539034"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-845"></span><span>      </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#ConstructorReference"><span class="hs-identifier hs-type">ConstructorReference</span></a></span><span> </span><span id="local-6989586621680539035"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539035"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539035"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-846"></span><span>
</span><span id="line-847"></span><span id="local-6989586621680536689"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#_TermReference"><span class="hs-identifier hs-type">_TermReference</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Prism'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536689"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680536689"><span class="hs-identifier hs-type">ref</span></a></span></span><span>
</span><span id="line-848"></span><span id="_TermReference"><span class="annot"><span class="annottext">_TermReference :: forall ref (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p ref (f ref) -&gt; p (SomeReference ref) (f (SomeReference ref))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#_TermReference"><span class="hs-identifier hs-var hs-var">_TermReference</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (ctor :: Symbol) s t a b.
AsConstructor ctor s t a b =&gt;
Prism s t a b
</span><span class="hs-identifier hs-var">_Ctor</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;TermReference&quot;</span></span><span>
</span><span id="line-849"></span><span>
</span><span id="line-850"></span><span class="annot"><span class="hs-comment">-- | This is only safe as long as you don't change the constructor of your SomeReference</span></span><span>
</span><span id="line-851"></span><span id="local-6989586621680539091"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTermReference_"><span class="hs-identifier hs-type">asTermReference_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="annot"><a href="#local-6989586621680539091"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680539091"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-852"></span><span id="asTermReference_"><span class="annot"><span class="annottext">asTermReference_ :: forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTermReference_"><span class="hs-identifier hs-var hs-var">asTermReference_</span></a></span></span><span> </span><span id="local-6989586621680539097"><span class="annot"><span class="annottext">SomeReference ref -&gt; f (SomeReference ref)
</span><a href="#local-6989586621680539097"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621680539098"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539098"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-853"></span><span>  </span><span class="annot"><span class="annottext">SomeReference ref -&gt; f (SomeReference ref)
</span><a href="#local-6989586621680539097"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ref -&gt; SomeReference ref
forall ref. ref -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermReference"><span class="hs-identifier hs-var">TermReference</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539098"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f (SomeReference ref) -&gt; (SomeReference ref -&gt; ref) -&gt; f ref
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-854"></span><span>    </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermReference"><span class="hs-identifier hs-type">TermReference</span></a></span><span> </span><span id="local-6989586621680539099"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539099"><span class="hs-identifier hs-var">ref'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539099"><span class="hs-identifier hs-var">ref'</span></a></span><span>
</span><span id="line-855"></span><span>    </span><span class="annot"><span class="annottext">SomeReference ref
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ref
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;asTermReference_: SomeReferenceId constructor was changed.&quot;</span></span><span>
</span><span id="line-856"></span><span>
</span><span id="line-857"></span><span class="annot"><span class="hs-comment">-- | This is only safe as long as you don't change the constructor of your SomeReference</span></span><span>
</span><span id="line-858"></span><span id="local-6989586621680539100"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTypeReference_"><span class="hs-identifier hs-type">asTypeReference_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="annot"><a href="#local-6989586621680539100"><span class="hs-identifier hs-type">ref</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680539100"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-859"></span><span id="asTypeReference_"><span class="annot"><span class="annottext">asTypeReference_ :: forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref)) -&gt; ref -&gt; f ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asTypeReference_"><span class="hs-identifier hs-var hs-var">asTypeReference_</span></a></span></span><span> </span><span id="local-6989586621680539106"><span class="annot"><span class="annottext">SomeReference ref -&gt; f (SomeReference ref)
</span><a href="#local-6989586621680539106"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621680539107"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539107"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-860"></span><span>  </span><span class="annot"><span class="annottext">SomeReference ref -&gt; f (SomeReference ref)
</span><a href="#local-6989586621680539106"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ref -&gt; SomeReference ref
forall ref. ref -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TypeReference"><span class="hs-identifier hs-var">TypeReference</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539107"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f (SomeReference ref) -&gt; (SomeReference ref -&gt; ref) -&gt; f ref
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-861"></span><span>    </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TypeReference"><span class="hs-identifier hs-type">TypeReference</span></a></span><span> </span><span id="local-6989586621680539108"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539108"><span class="hs-identifier hs-var">ref'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539108"><span class="hs-identifier hs-var">ref'</span></a></span><span>
</span><span id="line-862"></span><span>    </span><span class="annot"><span class="annottext">SomeReference ref
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ref
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;asTypeReference_: SomeReferenceId constructor was changed.&quot;</span></span><span>
</span><span id="line-863"></span><span>
</span><span id="line-864"></span><span class="annot"><span class="hs-comment">-- | This is only safe as long as you don't change the constructor of your SomeReference</span></span><span>
</span><span id="line-865"></span><span id="local-6989586621680536325"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asConstructorReference_"><span class="hs-identifier hs-type">asConstructorReference_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversal'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference.GConstructorReference</span></span><span> </span><span class="annot"><a href="#local-6989586621680536325"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReference"><span class="hs-identifier hs-type">SomeReference</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536325"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-866"></span><span id="asConstructorReference_"><span class="annot"><span class="annottext">asConstructorReference_ :: forall ref (f :: * -&gt; *).
Applicative f =&gt;
(SomeReference ref -&gt; f (SomeReference ref))
-&gt; GConstructorReference ref -&gt; f (GConstructorReference ref)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#asConstructorReference_"><span class="hs-identifier hs-var hs-var">asConstructorReference_</span></a></span></span><span> </span><span id="local-6989586621680539114"><span class="annot"><span class="annottext">SomeReference ref -&gt; f (SomeReference ref)
</span><a href="#local-6989586621680539114"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ConstructorReference.ConstructorReference</span></span><span> </span><span id="local-6989586621680539115"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539115"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621680539116"><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680539116"><span class="hs-identifier hs-var">cId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-867"></span><span>  </span><span class="annot"><span class="annottext">SomeReference ref -&gt; f (SomeReference ref)
</span><a href="#local-6989586621680539114"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ref -&gt; Old ConstructorId -&gt; SomeReference ref
forall ref. ref -&gt; Old ConstructorId -&gt; SomeReference ref
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#ConstructorReference"><span class="hs-identifier hs-var">ConstructorReference</span></a></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539115"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680539116"><span class="hs-identifier hs-var">cId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f (SomeReference ref)
-&gt; (SomeReference ref -&gt; GConstructorReference ref)
-&gt; f (GConstructorReference ref)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-868"></span><span>    </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#ConstructorReference"><span class="hs-identifier hs-type">ConstructorReference</span></a></span><span> </span><span id="local-6989586621680539117"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539117"><span class="hs-identifier hs-var">ref'</span></a></span></span><span> </span><span id="local-6989586621680539118"><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680539118"><span class="hs-identifier hs-var">cId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ref -&gt; Old ConstructorId -&gt; GConstructorReference ref
forall r. r -&gt; Old ConstructorId -&gt; GConstructorReference r
</span><span class="hs-identifier hs-var">ConstructorReference.ConstructorReference</span></span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680539117"><span class="hs-identifier hs-var">ref'</span></a></span><span> </span><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680539118"><span class="hs-identifier hs-var">cId</span></a></span><span>
</span><span id="line-869"></span><span>    </span><span class="annot"><span class="annottext">SomeReference ref
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; GConstructorReference ref
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;asConstructorReference_: SomeReferenceId constructor was changed.&quot;</span></span><span>
</span><span id="line-870"></span><span>
</span><span id="line-871"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferenceIdToEntity"><span class="hs-identifier hs-type">someReferenceIdToEntity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#SomeReferenceId"><span class="hs-identifier hs-type">SomeReferenceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#Entity"><span class="hs-identifier hs-type">Entity</span></a></span><span>
</span><span id="line-872"></span><span id="someReferenceIdToEntity"><span class="annot"><span class="annottext">someReferenceIdToEntity :: SomeReferenceId -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#someReferenceIdToEntity"><span class="hs-identifier hs-var hs-var">someReferenceIdToEntity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-873"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermReference"><span class="hs-identifier hs-type">TermReference</span></a></span><span> </span><span id="local-6989586621680539119"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680539119"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TermComponent"><span class="hs-identifier hs-var">TermComponent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; New Hash
</span><span class="hs-identifier hs-var">Reference.idToHash</span></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680539119"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-874"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#TypeReference"><span class="hs-identifier hs-type">TypeReference</span></a></span><span> </span><span id="local-6989586621680539120"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680539120"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#DeclComponent"><span class="hs-identifier hs-var">DeclComponent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; New Hash
</span><span class="hs-identifier hs-var">Reference.idToHash</span></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680539120"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-875"></span><span>  </span><span class="hs-comment">-- Constructors are migrated by their decl component.</span><span>
</span><span id="line-876"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#ConstructorReference"><span class="hs-identifier hs-type">ConstructorReference</span></a></span><span> </span><span id="local-6989586621680539121"><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680539121"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621680539122"><span class="annot"><span class="annottext">Old ConstructorId
</span><a href="#local-6989586621680539122"><span class="hs-identifier hs-var">_conId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">New Hash -&gt; Entity
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#DeclComponent"><span class="hs-identifier hs-var">DeclComponent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Old Id -&gt; New Hash
</span><span class="hs-identifier hs-var">Reference.idToHash</span></span><span> </span><span class="annot"><span class="annottext">Old Id
</span><a href="#local-6989586621680539121"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-877"></span><span>
</span><span id="line-878"></span><span id="local-6989586621680536477"><span id="local-6989586621680536479"><span id="local-6989586621680536480"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#foldSetter"><span class="hs-identifier hs-type">foldSetter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LensLike</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Writer</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621680536477"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680536479"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536480"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536477"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680536477"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680536479"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621680536477"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-879"></span><span id="foldSetter"><span class="annot"><span class="annottext">foldSetter :: forall a s t. LensLike (Writer [a]) s t a a -&gt; s -&gt; [a]
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#foldSetter"><span class="hs-identifier hs-var hs-var">foldSetter</span></a></span></span><span> </span><span id="local-6989586621680539128"><span class="annot"><span class="annottext">LensLike (WriterT [a] Identity) s t a a
</span><a href="#local-6989586621680539128"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621680539129"><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621680539129"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Writer [a] t -&gt; [a]
forall w a. Monoid w =&gt; Writer w a -&gt; w
</span><span class="hs-identifier hs-var">execWriter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">s
</span><a href="#local-6989586621680539129"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">s -&gt; (s -&gt; Writer [a] t) -&gt; Writer [a] t
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">LensLike (WriterT [a] Identity) s t a a
</span><a href="#local-6989586621680539128"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">LensLike (WriterT [a] Identity) s t a a
-&gt; LensLike (WriterT [a] Identity) s t a a
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680539130"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680539130"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; WriterT [a] Identity ()
forall w (m :: * -&gt; *). (Monoid w, Monad m) =&gt; w -&gt; WriterT w m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680539130"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">WriterT [a] Identity ()
-&gt; WriterT [a] Identity a -&gt; WriterT [a] Identity a
forall a b.
WriterT [a] Identity a
-&gt; WriterT [a] Identity b -&gt; WriterT [a] Identity b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; WriterT [a] Identity a
forall a. a -&gt; WriterT [a] Identity a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680539130"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-880"></span><span>
</span><span id="line-881"></span><span class="hs-comment">-- | Save an empty branch and get its new hash to use when replacing</span><span>
</span><span id="line-882"></span><span class="hs-comment">-- branches which are missing due to database corruption.</span><span>
</span><span id="line-883"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#saveV2EmptyBranch"><span class="hs-identifier hs-type">saveV2EmptyBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BranchHashId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">BranchHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-884"></span><span id="saveV2EmptyBranch"><span class="annot"><span class="annottext">saveV2EmptyBranch :: Transaction (BranchHashId, BranchHash)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.html#saveV2EmptyBranch"><span class="hs-identifier hs-var hs-var">saveV2EmptyBranch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-885"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680539131"><span class="annot"><span class="annottext">branch :: Branch' t h p c
</span><a href="#local-6989586621680539131"><span class="hs-identifier hs-var hs-var">branch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Branch' t h p c
forall t h p c. Branch' t h p c
</span><span class="hs-identifier hs-var">S.emptyBranch</span></span><span>
</span><span id="line-886"></span><span>  </span><span id="local-6989586621680539133"><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680539133"><span class="hs-identifier hs-var">newHash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DbBranch -&gt; Transaction BranchHash
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.DbHelpers.html#dbBranchHash"><span class="hs-identifier hs-var">Hashing.dbBranchHash</span></a></span><span> </span><span class="annot"><span class="annottext">DbBranch
forall t h p c. Branch' t h p c
</span><a href="#local-6989586621680539131"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-887"></span><span>  </span><span id="local-6989586621680539134"><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680539134"><span class="hs-identifier hs-var">newHashId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BranchHash -&gt; Transaction BranchHashId
</span><span class="hs-identifier hs-var">Q.saveBranchHash</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680539133"><span class="hs-identifier hs-var">newHash</span></a></span><span>
</span><span id="line-888"></span><span>  </span><span class="hs-comment">-- Stats are empty for the empty branch.</span><span>
</span><span id="line-889"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680539135"><span class="annot"><span class="annottext">emptyStats :: NamespaceStats
</span><a href="#local-6989586621680539135"><span class="hs-identifier hs-var hs-var">emptyStats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; NamespaceStats
</span><span class="hs-identifier hs-var">NamespaceStats</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-890"></span><span>  </span><span class="annot"><span class="annottext">BranchObjectId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HashHandle
-&gt; BranchHashId
-&gt; NamespaceStats
-&gt; DbBranchV
-&gt; Transaction BranchObjectId
</span><span class="hs-identifier hs-var">Ops.saveDbBranchUnderHashId</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680539134"><span class="hs-identifier hs-var">newHashId</span></a></span><span> </span><span class="annot"><span class="annottext">NamespaceStats
</span><a href="#local-6989586621680539135"><span class="hs-identifier hs-var">emptyStats</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DbBranch -&gt; DbBranchV
</span><span class="hs-identifier hs-var">Ops.DbBranchV2</span></span><span> </span><span class="annot"><span class="annottext">DbBranch
forall t h p c. Branch' t h p c
</span><a href="#local-6989586621680539131"><span class="hs-identifier hs-var">branch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-891"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680539134"><span class="hs-identifier hs-var">newHashId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680539133"><span class="hs-identifier hs-var">newHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-892"></span></pre></body></html>