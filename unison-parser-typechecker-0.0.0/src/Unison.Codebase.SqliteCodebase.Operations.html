<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">-- | This module contains sqlite-specific operations on high-level &quot;parser-typechecker&quot; types all in the Transaction</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- monad.</span><span>
</span><span id="line-7"></span><span class="hs-comment">--</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- The Codebase record-of-functions wraps this functionality, and runs each transaction to IO, so that the operations'</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- are unified with non-sqlite operations in the Codebase interface, like 'appendReflog'.</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Operations</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Comonad.Cofree</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cofree</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bitraversable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bitraverse</span></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Either.Extra</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Functor.Compose</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Compose</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty.Extra</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(:|)</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">maximum1</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromJust</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.UUID.V4</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UUID</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Branch</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V2Branch</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="U.Codebase.Branch.Diff.html"><span class="hs-identifier">U.Codebase.Branch.Diff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="U.Codebase.Branch.Diff.html#TreeDiff"><span class="hs-identifier">TreeDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="U.Codebase.Branch.Diff.html#TreeDiff"><span class="hs-identifier">TreeDiff</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="U.Codebase.Branch.Diff.html"><span class="hs-identifier">U.Codebase.Branch.Diff</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BranchDiff</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.HashTags</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">BranchHash</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">CausalHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unCausalHash</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">PatchHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="U.Codebase.Projects.html"><span class="hs-identifier">U.Codebase.Projects</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Projects</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Reference</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C.Reference</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Referent</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C.Referent</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.DbId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ObjectId</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.DbId</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Db</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.NameLookups</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PathSegments</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ReversedName</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.NamedRef</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.ObjectType</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OT</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Operations</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NamesInPerspective</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Operations</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ops</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Project</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Project</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Project</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Project</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.ProjectBranch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ProjectBranch</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Queries</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.V2.HashHandle</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">v2HashHandle</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Builtin.html"><span class="hs-identifier">Unison.Builtin</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Builtins</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.html"><span class="hs-identifier">Unison.Codebase.Branch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier">Branch</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.html"><span class="hs-identifier">Unison.Codebase.Branch</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Branch</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Patch.html"><span class="hs-identifier">Unison.Codebase.Patch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Patch.html#Patch"><span class="hs-identifier">Patch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Path.html"><span class="hs-identifier">Unison.Codebase.Path</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Path.html#Path"><span class="hs-identifier">Path</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Path.html"><span class="hs-identifier">Unison.Codebase.Path</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Path</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.ShortCausalHash.html"><span class="hs-identifier">Unison.Codebase.ShortCausalHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.ShortCausalHash.html#ShortCausalHash"><span class="hs-identifier">ShortCausalHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Branch.Cache.html"><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Branch.Cache</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Branch.Cache.html#BranchCache"><span class="hs-identifier">BranchCache</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Conversions.html"><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Conversions</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cv</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">GConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ConstructorType</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">CT</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Core.Project</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ProjectBranchName</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ProjectName</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Decl</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Decl</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Hash</span></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Hashing.V2.Convert.html"><span class="hs-identifier">Unison.Hashing.V2.Convert</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Hashing</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Name</span></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Name</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Name</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.NameSegment.Internal</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NameSegment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NameSegment</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Names</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Names</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Names</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Names</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Names</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Parser.Ann</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Reference</span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Reference</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Referent</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ShortHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ShortHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.ShortHash</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ShortHash</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Transaction</span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sqlite</span></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite.Transaction</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sqlite</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Symbol</span></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Term</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Term</span></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Term</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Term</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Type</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Type</span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Type</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Cache</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cache</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Relation</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Rel</span></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.WatchKind</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UF</span></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO.STM</span></span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#createSchema"><span class="hs-identifier hs-type">createSchema</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span id="createSchema"><span class="annot"><span class="annottext">createSchema :: Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#createSchema"><span class="hs-identifier hs-var hs-var">createSchema</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-85"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.runCreateSql</span></span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.addTempEntityTables</span></span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.addNamespaceStatsTables</span></span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.addReflogTable</span></span><span>
</span><span id="line-89"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.fixScopedNameLookupTables</span></span><span>
</span><span id="line-90"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.addProjectTables</span></span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.addMostRecentBranchTable</span></span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.addNameLookupMountTables</span></span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.addMostRecentNamespaceTable</span></span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span> </span><span class="annot"><span class="annottext">Sql
</span><a href="#local-6989586621680535066"><span class="hs-identifier hs-var">insertSchemaVersionSql</span></a></span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.addSquashResultTable</span></span><span>
</span><span id="line-96"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.addCurrentProjectPathTable</span></span><span>
</span><span id="line-97"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.addProjectBranchReflogTable</span></span><span>
</span><span id="line-98"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><span class="hs-identifier hs-var">Q.addProjectBranchCausalHashIdColumn</span></span><span>
</span><span id="line-99"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535071"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680535071"><span class="hs-identifier hs-var">emptyCausalHashId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction (CausalHash, CausalHashId)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#emptyCausalHash"><span class="hs-identifier hs-var">emptyCausalHash</span></a></span><span>
</span><span id="line-100"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Project
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ProjectBranch</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680535074"><span class="annot"><span class="annottext">ProjectId
projectId :: ProjectId
$sel:projectId:ProjectBranch :: ProjectBranch -&gt; ProjectId
</span><a href="#local-6989586621680535074"><span class="hs-identifier hs-var hs-var">projectId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535076"><span class="annot"><span class="annottext">ProjectBranchId
branchId :: ProjectBranchId
$sel:branchId:ProjectBranch :: ProjectBranch -&gt; ProjectBranchId
</span><a href="#local-6989586621680535076"><span class="hs-identifier hs-var hs-var">branchId</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ProjectName
-&gt; ProjectBranchName
-&gt; CausalHashId
-&gt; Transaction (Project, ProjectBranch)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#insertProjectAndBranch"><span class="hs-identifier hs-var">insertProjectAndBranch</span></a></span><span> </span><span class="annot"><span class="annottext">ProjectName
</span><a href="#local-6989586621680535079"><span class="hs-identifier hs-var">scratchProjectName</span></a></span><span> </span><span class="annot"><span class="annottext">ProjectBranchName
</span><a href="#local-6989586621680535080"><span class="hs-identifier hs-var">scratchBranchName</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680535071"><span class="hs-identifier hs-var">emptyCausalHashId</span></a></span><span>
</span><span id="line-101"></span><span>  </span><span class="annot"><span class="annottext">ProjectId -&gt; ProjectBranchId -&gt; [NameSegment] -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Q.setCurrentProjectPath</span></span><span> </span><span class="annot"><span class="annottext">ProjectId
</span><a href="#local-6989586621680535074"><span class="hs-identifier hs-var">projectId</span></a></span><span> </span><span class="annot"><span class="annottext">ProjectBranchId
</span><a href="#local-6989586621680535076"><span class="hs-identifier hs-var">branchId</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-103"></span><span>    </span><span id="local-6989586621680535079"><span class="annot"><span class="annottext">scratchProjectName :: ProjectName
</span><a href="#local-6989586621680535079"><span class="hs-identifier hs-var hs-var">scratchProjectName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; ProjectName
</span><span class="hs-identifier hs-var">UnsafeProjectName</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;scratch&quot;</span></span><span>
</span><span id="line-104"></span><span>    </span><span id="local-6989586621680535080"><span class="annot"><span class="annottext">scratchBranchName :: ProjectBranchName
</span><a href="#local-6989586621680535080"><span class="hs-identifier hs-var hs-var">scratchBranchName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; ProjectBranchName
</span><span class="hs-identifier hs-var">UnsafeProjectBranchName</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;main&quot;</span></span><span>
</span><span id="line-105"></span><span>    </span><span id="local-6989586621680535086"><span class="annot"><span class="annottext">currentSchemaVersion :: SchemaVersion
</span><a href="#local-6989586621680535086"><span class="hs-identifier hs-var hs-var">currentSchemaVersion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SchemaVersion
</span><span class="hs-identifier hs-var">Q.currentSchemaVersion</span></span><span>
</span><span id="line-106"></span><span>    </span><span id="local-6989586621680535066"><span class="annot"><span class="annottext">insertSchemaVersionSql :: Sql
</span><a href="#local-6989586621680535066"><span class="hs-identifier hs-var hs-var">insertSchemaVersionSql</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-107"></span><span>      </span><span class="annot"><span class="">[Sqlite.sql|
        INSERT INTO schema_version (version)
        VALUES (:currentSchemaVersion)
      |]</span></span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- Buffer entry</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-comment">-- 1) buffer up the component</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- 2) in the event that the component is complete, then what?</span><span>
</span><span id="line-117"></span><span class="hs-comment">--  * can write component provided all of its dependency components are complete.</span><span>
</span><span id="line-118"></span><span class="hs-comment">--    if dependency not complete,</span><span>
</span><span id="line-119"></span><span class="hs-comment">--    register yourself to be written when that dependency is complete</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- an entry for a single hash</span><span>
</span><span id="line-122"></span><span class="hs-keyword">data</span><span> </span><span id="BufferEntry"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-var">BufferEntry</span></a></span></span><span> </span><span id="local-6989586621680534379"><span class="annot"><a href="#local-6989586621680534379"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BufferEntry"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-var">BufferEntry</span></a></span></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- First, you are waiting for the cycle to fill up with all elements</span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-comment">-- Then, you check: are all dependencies of the cycle in the db?</span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-comment">--   If yes: write yourself to database and trigger check of dependents</span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-comment">--   If no: just wait, do nothing</span><span>
</span><span id="line-127"></span><span>    </span><span id="%24sel%3AbeComponentTargetSize%3ABufferEntry"><span class="annot"><span class="annottext">forall a. BufferEntry a -&gt; Maybe ConstructorId
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeComponentTargetSize%3ABufferEntry"><span class="hs-identifier hs-var hs-var">beComponentTargetSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span class="hs-special">,</span><span>
</span><span id="line-128"></span><span>    </span><span id="%24sel%3AbeComponent%3ABufferEntry"><span class="annot"><span class="annottext">forall a. BufferEntry a -&gt; Map ConstructorId a
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeComponent%3ABufferEntry"><span class="hs-identifier hs-var hs-var">beComponent</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Pos</span></span><span> </span><span class="annot"><a href="#local-6989586621680534379"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-129"></span><span>    </span><span id="%24sel%3AbeMissingDependencies%3ABufferEntry"><span class="annot"><span class="annottext">forall a. BufferEntry a -&gt; Set Hash
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeMissingDependencies%3ABufferEntry"><span class="hs-identifier hs-var hs-var">beMissingDependencies</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">,</span><span>
</span><span id="line-130"></span><span>    </span><span id="%24sel%3AbeWaitingDependents%3ABufferEntry"><span class="annot"><span class="annottext">forall a. BufferEntry a -&gt; Set Hash
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeWaitingDependents%3ABufferEntry"><span class="hs-identifier hs-var hs-var">beWaitingDependents</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680535106"><span id="local-6989586621680535116"><span class="annot"><span class="annottext">BufferEntry a -&gt; BufferEntry a -&gt; Bool
(BufferEntry a -&gt; BufferEntry a -&gt; Bool)
-&gt; (BufferEntry a -&gt; BufferEntry a -&gt; Bool) -&gt; Eq (BufferEntry a)
forall a. Eq a =&gt; BufferEntry a -&gt; BufferEntry a -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: forall a. Eq a =&gt; BufferEntry a -&gt; BufferEntry a -&gt; Bool
== :: BufferEntry a -&gt; BufferEntry a -&gt; Bool
$c/= :: forall a. Eq a =&gt; BufferEntry a -&gt; BufferEntry a -&gt; Bool
/= :: BufferEntry a -&gt; BufferEntry a -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535123"><span id="local-6989586621680535136"><span id="local-6989586621680535140"><span class="annot"><span class="annottext">Int -&gt; BufferEntry a -&gt; ShowS
[BufferEntry a] -&gt; ShowS
BufferEntry a -&gt; WatchKind
(Int -&gt; BufferEntry a -&gt; ShowS)
-&gt; (BufferEntry a -&gt; WatchKind)
-&gt; ([BufferEntry a] -&gt; ShowS)
-&gt; Show (BufferEntry a)
forall a. Show a =&gt; Int -&gt; BufferEntry a -&gt; ShowS
forall a. Show a =&gt; [BufferEntry a] -&gt; ShowS
forall a. Show a =&gt; BufferEntry a -&gt; WatchKind
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; WatchKind) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: forall a. Show a =&gt; Int -&gt; BufferEntry a -&gt; ShowS
showsPrec :: Int -&gt; BufferEntry a -&gt; ShowS
$cshow :: forall a. Show a =&gt; BufferEntry a -&gt; WatchKind
show :: BufferEntry a -&gt; WatchKind
$cshowList :: forall a. Show a =&gt; [BufferEntry a] -&gt; ShowS
showList :: [BufferEntry a] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span id="local-6989586621680534401"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#prettyBufferEntry"><span class="hs-identifier hs-type">prettyBufferEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621680534401"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534401"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span></span><span>
</span><span id="line-135"></span><span id="prettyBufferEntry"><span class="annot"><span class="annottext">prettyBufferEntry :: forall a. Show a =&gt; Hash -&gt; BufferEntry a -&gt; WatchKind
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#prettyBufferEntry"><span class="hs-identifier hs-var hs-var">prettyBufferEntry</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680535181"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535181"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680535182"><span id="local-6989586621680535183"><span id="local-6989586621680535184"><span id="local-6989586621680535185"><span class="annot"><span class="annottext">Maybe ConstructorId
Map ConstructorId a
Set Hash
$sel:beComponentTargetSize:BufferEntry :: forall a. BufferEntry a -&gt; Maybe ConstructorId
$sel:beComponent:BufferEntry :: forall a. BufferEntry a -&gt; Map ConstructorId a
$sel:beMissingDependencies:BufferEntry :: forall a. BufferEntry a -&gt; Set Hash
$sel:beWaitingDependents:BufferEntry :: forall a. BufferEntry a -&gt; Set Hash
beComponentTargetSize :: Maybe ConstructorId
beComponent :: Map ConstructorId a
beMissingDependencies :: Set Hash
beWaitingDependents :: Set Hash
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeComponentTargetSize%3ABufferEntry"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;BufferEntry &quot;</span></span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; WatchKind
forall a. Show a =&gt; a -&gt; WatchKind
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535181"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;\n&quot;</span></span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;  { beComponentTargetSize = &quot;</span></span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId -&gt; WatchKind
forall a. Show a =&gt; a -&gt; WatchKind
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535182"><span class="hs-identifier hs-var">beComponentTargetSize</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;\n&quot;</span></span><span>
</span><span id="line-142"></span><span>    </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;  , beComponent = &quot;</span></span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Map ConstructorId a -&gt; Int
forall k a. Map k a -&gt; Int
</span><span class="hs-identifier hs-var">Map.size</span></span><span> </span><span class="annot"><span class="annottext">Map ConstructorId a
</span><a href="#local-6989586621680535183"><span class="hs-identifier hs-var">beComponent</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[(ConstructorId, a)] -&gt; WatchKind
forall a. Show a =&gt; a -&gt; WatchKind
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">([(ConstructorId, a)] -&gt; WatchKind)
-&gt; [(ConstructorId, a)] -&gt; WatchKind
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map ConstructorId a -&gt; [(ConstructorId, a)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map ConstructorId a
</span><a href="#local-6989586621680535183"><span class="hs-identifier hs-var">beComponent</span></a></span><span>
</span><span id="line-145"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-146"></span><span>        </span><span class="annot"><span class="annottext">[(ConstructorId, a)]
-&gt; Maybe WatchKind -&gt; WatchKind -&gt; Maybe WatchKind -&gt; WatchKind
forall (f :: * -&gt; *) a.
(Foldable f, Show a) =&gt;
f a -&gt; Maybe WatchKind -&gt; WatchKind -&gt; Maybe WatchKind -&gt; WatchKind
</span><a href="#local-6989586621680535190"><span class="hs-identifier hs-var">mkString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map ConstructorId a -&gt; [(ConstructorId, a)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">Map ConstructorId a
</span><a href="#local-6989586621680535183"><span class="hs-identifier hs-var">beComponent</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; Maybe WatchKind
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;\n      [ &quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;      , &quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; Maybe WatchKind
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;]\n&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>          </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;  , beMissingDependencies =&quot;</span></span><span>
</span><span id="line-148"></span><span>          </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; Int
forall a. Set a -&gt; Int
</span><span class="hs-identifier hs-var">Set.size</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535184"><span class="hs-identifier hs-var">beMissingDependencies</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-149"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; WatchKind
forall a. Show a =&gt; a -&gt; WatchKind
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">([Hash] -&gt; WatchKind) -&gt; [Hash] -&gt; WatchKind
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; [Hash]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535184"><span class="hs-identifier hs-var">beMissingDependencies</span></a></span><span>
</span><span id="line-150"></span><span>            </span><span class="hs-keyword">else</span><span>
</span><span id="line-151"></span><span>              </span><span class="annot"><span class="annottext">[Hash]
-&gt; Maybe WatchKind -&gt; WatchKind -&gt; Maybe WatchKind -&gt; WatchKind
forall (f :: * -&gt; *) a.
(Foldable f, Show a) =&gt;
f a -&gt; Maybe WatchKind -&gt; WatchKind -&gt; Maybe WatchKind -&gt; WatchKind
</span><a href="#local-6989586621680535190"><span class="hs-identifier hs-var">mkString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Hash -&gt; [Hash]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535184"><span class="hs-identifier hs-var">beMissingDependencies</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; Maybe WatchKind
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;\n      [ &quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;      , &quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; Maybe WatchKind
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;]\n&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>                </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;  , beWaitingDependents =&quot;</span></span><span>
</span><span id="line-153"></span><span>                </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; Int
forall a. Set a -&gt; Int
</span><span class="hs-identifier hs-var">Set.size</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535185"><span class="hs-identifier hs-var">beWaitingDependents</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-154"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; WatchKind
forall a. Show a =&gt; a -&gt; WatchKind
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">([Hash] -&gt; WatchKind) -&gt; [Hash] -&gt; WatchKind
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; [Hash]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535185"><span class="hs-identifier hs-var">beWaitingDependents</span></a></span><span>
</span><span id="line-155"></span><span>                  </span><span class="hs-keyword">else</span><span>
</span><span id="line-156"></span><span>                    </span><span class="annot"><span class="annottext">[Hash]
-&gt; Maybe WatchKind -&gt; WatchKind -&gt; Maybe WatchKind -&gt; WatchKind
forall (f :: * -&gt; *) a.
(Foldable f, Show a) =&gt;
f a -&gt; Maybe WatchKind -&gt; WatchKind -&gt; Maybe WatchKind -&gt; WatchKind
</span><a href="#local-6989586621680535190"><span class="hs-identifier hs-var">mkString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Hash -&gt; [Hash]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535185"><span class="hs-identifier hs-var">beWaitingDependents</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; Maybe WatchKind
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;\n      [ &quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;      , &quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; Maybe WatchKind
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;]\n&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>                      </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;  }&quot;</span></span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-159"></span><span>    </span><span id="local-6989586621680534413"><span id="local-6989586621680534414"><span class="annot"><a href="#local-6989586621680535190"><span class="hs-identifier hs-type">mkString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Foldable</span></span><span> </span><span class="annot"><a href="#local-6989586621680534413"><span class="hs-identifier hs-type">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621680534414"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680534413"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534414"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span></span></span><span>
</span><span id="line-160"></span><span>    </span><span id="local-6989586621680535190"><span class="annot"><span class="annottext">mkString :: forall (f :: * -&gt; *) a.
(Foldable f, Show a) =&gt;
f a -&gt; Maybe WatchKind -&gt; WatchKind -&gt; Maybe WatchKind -&gt; WatchKind
</span><a href="#local-6989586621680535190"><span class="hs-identifier hs-var hs-var">mkString</span></a></span></span><span> </span><span id="local-6989586621680535200"><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621680535200"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621680535201"><span class="annot"><span class="annottext">Maybe WatchKind
</span><a href="#local-6989586621680535201"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621680535202"><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680535202"><span class="hs-identifier hs-var">middle</span></a></span></span><span> </span><span id="local-6989586621680535203"><span class="annot"><span class="annottext">Maybe WatchKind
</span><a href="#local-6989586621680535203"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-161"></span><span>      </span><span class="annot"><span class="annottext">WatchKind -&gt; Maybe WatchKind -&gt; WatchKind
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe WatchKind
</span><a href="#local-6989586621680535201"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">WatchKind -&gt; [WatchKind] -&gt; WatchKind
forall a. [a] -&gt; [[a]] -&gt; [a]
</span><span class="hs-identifier hs-var">List.intercalate</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680535202"><span class="hs-identifier hs-var">middle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; WatchKind
forall a. Show a =&gt; a -&gt; WatchKind
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; WatchKind) -&gt; [a] -&gt; [WatchKind]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">f a -&gt; [a]
forall a. f a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">f a
</span><a href="#local-6989586621680535200"><span class="hs-keyword hs-var">as</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">WatchKind -&gt; Maybe WatchKind -&gt; WatchKind
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe WatchKind
</span><a href="#local-6989586621680535203"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-keyword">type</span><span> </span><span id="TermBufferEntry"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-var">TermBufferEntry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span class="hs-keyword">type</span><span> </span><span id="DeclBufferEntry"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-var">DeclBufferEntry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span id="local-6989586621680534426"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBuffer"><span class="hs-identifier hs-type">getBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534426"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534426"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-168"></span><span id="getBuffer"><span class="annot"><span class="annottext">getBuffer :: forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBuffer"><span class="hs-identifier hs-var hs-var">getBuffer</span></a></span></span><span> </span><span id="local-6989586621680535214"><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535214"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621680535215"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535215"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Map Hash (BufferEntry a) -&gt; Maybe (BufferEntry a)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535215"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Hash (BufferEntry a) -&gt; Maybe (BufferEntry a))
-&gt; IO (Map Hash (BufferEntry a)) -&gt; IO (Maybe (BufferEntry a))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a)) -&gt; IO (Map Hash (BufferEntry a))
forall (m :: * -&gt; *) a. MonadIO m =&gt; TVar a -&gt; m a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535214"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO (Maybe (BufferEntry a))
-&gt; (Maybe (BufferEntry a) -&gt; BufferEntry a) -&gt; IO (BufferEntry a)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-170"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680535219"><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680535219"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680535219"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><span class="annottext">Maybe (BufferEntry a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId
-&gt; Map ConstructorId a -&gt; Set Hash -&gt; Set Hash -&gt; BufferEntry a
forall a.
Maybe ConstructorId
-&gt; Map ConstructorId a -&gt; Set Hash -&gt; Set Hash -&gt; BufferEntry a
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-var">BufferEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Map ConstructorId a
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span id="local-6989586621680534440"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBuffer"><span class="hs-identifier hs-type">putBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534440"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534440"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-174"></span><span id="putBuffer"><span class="annot"><span class="annottext">putBuffer :: forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBuffer"><span class="hs-identifier hs-var hs-var">putBuffer</span></a></span></span><span> </span><span id="local-6989586621680535225"><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535225"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621680535226"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535226"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535227"><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680535227"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
-&gt; (Map Hash (BufferEntry a) -&gt; Map Hash (BufferEntry a)) -&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><span class="hs-identifier hs-var">modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535225"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash
-&gt; BufferEntry a
-&gt; Map Hash (BufferEntry a)
-&gt; Map Hash (BufferEntry a)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535226"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680535227"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span id="local-6989586621680534448"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#removeBuffer"><span class="hs-identifier hs-type">removeBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534448"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-178"></span><span id="removeBuffer"><span class="annot"><span class="annottext">removeBuffer :: forall a. TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#removeBuffer"><span class="hs-identifier hs-var hs-var">removeBuffer</span></a></span></span><span> </span><span id="local-6989586621680535234"><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535234"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621680535235"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535235"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
-&gt; (Map Hash (BufferEntry a) -&gt; Map Hash (BufferEntry a)) -&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><span class="hs-identifier hs-var">modifyTVar'</span></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535234"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Map Hash (BufferEntry a) -&gt; Map Hash (BufferEntry a)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.delete</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535235"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span id="local-6989586621680534452"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#addBufferDependent"><span class="hs-identifier hs-type">addBufferDependent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534452"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-182"></span><span id="addBufferDependent"><span class="annot"><span class="annottext">addBufferDependent :: forall a. Hash -&gt; TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#addBufferDependent"><span class="hs-identifier hs-var hs-var">addBufferDependent</span></a></span></span><span> </span><span id="local-6989586621680535240"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535240"><span class="hs-identifier hs-var">dependent</span></a></span></span><span> </span><span id="local-6989586621680535241"><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535241"><span class="hs-identifier hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621680535242"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535242"><span class="hs-keyword hs-var">dependency</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-183"></span><span>  </span><span id="local-6989586621680535243"><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680535243"><span class="hs-identifier hs-var">be</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBuffer"><span class="hs-identifier hs-var">getBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535241"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535242"><span class="hs-keyword hs-var">dependency</span></a></span><span>
</span><span id="line-184"></span><span>  </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBuffer"><span class="hs-identifier hs-var">putBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535241"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535242"><span class="hs-keyword hs-var">dependency</span></a></span><span> </span><span class="annot"><span class="annottext">BufferEntry a
</span><a href="#local-6989586621680535243"><span class="hs-identifier hs-var">be</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeWaitingDependents%3ABufferEntry"><span class="hs-identifier hs-var">beWaitingDependents</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set.insert</span></span><span> </span><span class="annot"><a href="#local-6989586621680535240"><span class="hs-identifier hs-type">dependent</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#%24sel%3AbeWaitingDependents%3ABufferEntry"><span class="hs-identifier hs-var">beWaitingDependents</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680535243"><span class="hs-identifier hs-type">be</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushBuffer"><span class="hs-identifier hs-type">tryFlushBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680534455"><span class="annot"><a href="#local-6989586621680534455"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="#local-6989586621680534455"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534455"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621680534455"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-192"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span id="tryFlushBuffer"><span class="annot"><span class="annottext">tryFlushBuffer :: forall a.
Show a =&gt;
TVar (Map Hash (BufferEntry a))
-&gt; (Hash -&gt; [a] -&gt; Transaction ())
-&gt; (Hash -&gt; Transaction ())
-&gt; Hash
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushBuffer"><span class="hs-identifier hs-var hs-var">tryFlushBuffer</span></a></span></span><span> </span><span id="local-6989586621680535275"><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535275"><span class="hs-identifier hs-var">buf</span></a></span></span><span> </span><span id="local-6989586621680535276"><span class="annot"><span class="annottext">Hash -&gt; [a] -&gt; Transaction ()
</span><a href="#local-6989586621680535276"><span class="hs-identifier hs-var">saveComponent</span></a></span></span><span> </span><span id="local-6989586621680535277"><span class="annot"><span class="annottext">Hash -&gt; Transaction ()
</span><a href="#local-6989586621680535277"><span class="hs-identifier hs-var">tryWaiting</span></a></span></span><span> </span><span id="local-6989586621680535278"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535278"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-195"></span><span>  </span><span class="hs-comment">-- skip if it has already been flushed</span><span>
</span><span id="line-196"></span><span>  </span><span class="annot"><span class="annottext">Transaction Bool -&gt; Transaction () -&gt; Transaction ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">unlessM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535278"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span id="local-6989586621680535281"><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535281"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621680535282"><span class="annot"><span class="annottext">Map ConstructorId a
</span><a href="#local-6989586621680535282"><span class="hs-identifier hs-var">comp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Set Hash -&gt; Set Hash
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.delete</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535278"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621680535284"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535284"><span class="hs-identifier hs-var">missing</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680535285"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535285"><span class="hs-identifier hs-var">waiting</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (BufferEntry a) -&gt; Transaction (BufferEntry a)
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBuffer"><span class="hs-identifier hs-var">getBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535275"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535278"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535281"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-199"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680535287"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535287"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-200"></span><span>        </span><span id="local-6989586621680535288"><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680535288"><span class="hs-identifier hs-var">missing'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction Bool) -&gt; [Hash] -&gt; Transaction [Hash]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><span class="hs-identifier hs-var">filterM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Transaction Bool -&gt; Transaction Bool
forall a b. (a -&gt; b) -&gt; Transaction a -&gt; Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Transaction Bool -&gt; Transaction Bool)
-&gt; (Hash -&gt; Transaction Bool) -&gt; Hash -&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Hash -&gt; [Hash]
forall a. Set a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535284"><span class="hs-identifier hs-var">missing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680535288"><span class="hs-identifier hs-var">missing'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535287"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorId -&gt; ConstructorId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ConstructorId
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map ConstructorId a -&gt; Int
forall a. Map ConstructorId a -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Map ConstructorId a
</span><a href="#local-6989586621680535282"><span class="hs-identifier hs-var">comp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-203"></span><span>            </span><span class="annot"><span class="annottext">Hash -&gt; [a] -&gt; Transaction ()
</span><a href="#local-6989586621680535276"><span class="hs-identifier hs-var">saveComponent</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535278"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map ConstructorId a -&gt; [a]
forall a. Map ConstructorId a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">Map ConstructorId a
</span><a href="#local-6989586621680535282"><span class="hs-identifier hs-var">comp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
forall a. TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#removeBuffer"><span class="hs-identifier hs-var">removeBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535275"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535278"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>            </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction ()) -&gt; Set Hash -&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction ()
</span><a href="#local-6989586621680535277"><span class="hs-identifier hs-var">tryWaiting</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535285"><span class="hs-identifier hs-var">waiting</span></a></span><span>
</span><span id="line-206"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-207"></span><span>            </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBuffer"><span class="hs-identifier hs-var">putBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash (BufferEntry a))
</span><a href="#local-6989586621680535275"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535278"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">(BufferEntry a -&gt; IO ()) -&gt; BufferEntry a -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-208"></span><span>              </span><span class="annot"><span class="annottext">Maybe ConstructorId
-&gt; Map ConstructorId a -&gt; Set Hash -&gt; Set Hash -&gt; BufferEntry a
forall a.
Maybe ConstructorId
-&gt; Map ConstructorId a -&gt; Set Hash -&gt; Set Hash -&gt; BufferEntry a
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-var">BufferEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstructorId -&gt; Maybe ConstructorId
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535287"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map ConstructorId a
</span><a href="#local-6989586621680535282"><span class="hs-identifier hs-var">comp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Hash] -&gt; Set Hash
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680535288"><span class="hs-identifier hs-var">missing'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535285"><span class="hs-identifier hs-var">waiting</span></a></span><span>
</span><span id="line-209"></span><span>      </span><span class="annot"><span class="annottext">Maybe ConstructorId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-210"></span><span>        </span><span class="hs-comment">-- it's never even been added, so there's nothing to do.</span><span>
</span><span id="line-211"></span><span>        </span><span class="annot"><span class="annottext">() -&gt; Transaction ()
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- Operations</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTerm"><span class="hs-identifier hs-type">getTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-217"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span></span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-219"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-220"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span id="getTerm"><span class="annot"><span class="annottext">getTerm :: (TypeReference -&gt; Transaction ConstructorType)
-&gt; Id -&gt; Transaction (Maybe (Term Symbol Ann))
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTerm"><span class="hs-identifier hs-var hs-var">getTerm</span></a></span></span><span> </span><span id="local-6989586621680535299"><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535299"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680535301"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535301"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535302"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535302"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-222"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Transaction (Term Symbol Ann)
-&gt; Transaction (Maybe (Term Symbol Ann))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-223"></span><span>    </span><span id="local-6989586621680535304"><span class="annot"><span class="annottext">Term Symbol
</span><a href="#local-6989586621680535304"><span class="hs-identifier hs-var">term2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; MaybeT Transaction (Term Symbol)
</span><span class="hs-identifier hs-var">Ops.loadTermByReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; ConstructorId -&gt; Id
forall h. h -&gt; ConstructorId -&gt; Id' h
</span><span class="hs-identifier hs-var">C.Reference.Id</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535301"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535302"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><span class="annottext">Transaction (Term Symbol Ann)
-&gt; MaybeT Transaction (Term Symbol Ann)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; MaybeT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash
-&gt; (TypeReference -&gt; Transaction ConstructorType)
-&gt; Term Symbol
-&gt; Transaction (Term Symbol Ann)
forall (m :: * -&gt; *).
Monad m =&gt;
Hash
-&gt; (TypeReference -&gt; m ConstructorType)
-&gt; Term Symbol
-&gt; m (Term Symbol Ann)
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#term2to1"><span class="hs-identifier hs-var">Cv.term2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535301"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535299"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol
</span><a href="#local-6989586621680535304"><span class="hs-identifier hs-var">term2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getDeclType"><span class="hs-identifier hs-type">getDeclType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span>
</span><span id="line-227"></span><span id="getDeclType"><span class="annot"><span class="annottext">getDeclType :: TypeReference -&gt; Transaction ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getDeclType"><span class="hs-identifier hs-var hs-var">getDeclType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-228"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">C.Reference.ReferenceBuiltin</span></span><span> </span><span id="local-6989586621680535309"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680535309"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535310"><span class="annot"><span class="annottext">err :: ConstructorType
</span><a href="#local-6989586621680535310"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-230"></span><span>          </span><span class="annot"><span class="annottext">WatchKind -&gt; ConstructorType
forall a. HasCallStack =&gt; WatchKind -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(WatchKind -&gt; ConstructorType) -&gt; WatchKind -&gt; ConstructorType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-231"></span><span>            </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;I don't know about the builtin type ##&quot;</span></span><span>
</span><span id="line-232"></span><span>              </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; WatchKind
forall a. Show a =&gt; a -&gt; WatchKind
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680535309"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-233"></span><span>              </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;, but I've been asked for it's ConstructorType.&quot;</span></span><span>
</span><span id="line-234"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; Transaction ConstructorType
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ConstructorType -&gt; Transaction ConstructorType)
-&gt; (Maybe ConstructorType -&gt; ConstructorType)
-&gt; Maybe ConstructorType
-&gt; Transaction ConstructorType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; Maybe ConstructorType -&gt; ConstructorType
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">ConstructorType
</span><a href="#local-6989586621680535310"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe ConstructorType -&gt; Transaction ConstructorType)
-&gt; Maybe ConstructorType -&gt; Transaction ConstructorType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-235"></span><span>          </span><span class="annot"><span class="annottext">TypeReference
-&gt; Map TypeReference ConstructorType -&gt; Maybe ConstructorType
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; TypeReference
forall t h. t -&gt; Reference' t h
</span><span class="hs-identifier hs-var">Reference.Builtin</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680535309"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map TypeReference ConstructorType
</span><a href="Unison.Builtin.html#builtinConstructorType"><span class="hs-identifier hs-var">Builtins.builtinConstructorType</span></a></span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">C.Reference.ReferenceDerived</span></span><span> </span><span id="local-6989586621680535315"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680535315"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Id -&gt; Transaction ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#expectDeclTypeById"><span class="hs-identifier hs-var">expectDeclTypeById</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680535315"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#expectDeclTypeById"><span class="hs-identifier hs-type">expectDeclTypeById</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span>
</span><span id="line-239"></span><span id="expectDeclTypeById"><span class="annot"><span class="annottext">expectDeclTypeById :: Id -&gt; Transaction ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#expectDeclTypeById"><span class="hs-identifier hs-var hs-var">expectDeclTypeById</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DeclType -&gt; ConstructorType)
-&gt; Transaction DeclType -&gt; Transaction ConstructorType
forall a b. (a -&gt; b) -&gt; Transaction a -&gt; Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">DeclType -&gt; ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#decltype2to1"><span class="hs-identifier hs-var">Cv.decltype2to1</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction DeclType -&gt; Transaction ConstructorType)
-&gt; (Id -&gt; Transaction DeclType)
-&gt; Id
-&gt; Transaction ConstructorType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Transaction DeclType
</span><span class="hs-identifier hs-var">Ops.expectDeclTypeById</span></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTypeOfTermImpl"><span class="hs-identifier hs-type">getTypeOfTermImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span id="getTypeOfTermImpl"><span class="annot"><span class="annottext">getTypeOfTermImpl :: Id -&gt; Transaction (Maybe (Type Symbol Ann))
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTypeOfTermImpl"><span class="hs-identifier hs-var hs-var">getTypeOfTermImpl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680535320"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535320"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535321"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535321"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-243"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Transaction (Type Symbol Ann)
-&gt; Transaction (Maybe (Type Symbol Ann))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>    </span><span id="local-6989586621680535322"><span class="annot"><span class="annottext">Type Symbol
</span><a href="#local-6989586621680535322"><span class="hs-identifier hs-var">type2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; MaybeT Transaction (Type Symbol)
</span><span class="hs-identifier hs-var">Ops.loadTypeOfTermByTermReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; ConstructorId -&gt; Id
forall h. h -&gt; ConstructorId -&gt; Id' h
</span><span class="hs-identifier hs-var">C.Reference.Id</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535320"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535321"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type Symbol -&gt; Type Symbol Ann
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#ttype2to1"><span class="hs-identifier hs-var">Cv.ttype2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol
</span><a href="#local-6989586621680535322"><span class="hs-identifier hs-var">type2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTermComponentWithTypes"><span class="hs-identifier hs-type">getTermComponentWithTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-248"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span id="getTermComponentWithTypes"><span class="annot"><span class="annottext">getTermComponentWithTypes :: (TypeReference -&gt; Transaction ConstructorType)
-&gt; Hash -&gt; Transaction (Maybe [(Term Symbol Ann, Type Symbol Ann)])
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTermComponentWithTypes"><span class="hs-identifier hs-var hs-var">getTermComponentWithTypes</span></a></span></span><span> </span><span id="local-6989586621680535326"><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535326"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span id="local-6989586621680535327"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535327"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Transaction [(Term Symbol Ann, Type Symbol Ann)]
-&gt; Transaction (Maybe [(Term Symbol Ann, Type Symbol Ann)])
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-254"></span><span>    </span><span id="local-6989586621680535328"><span class="annot"><span class="annottext">[(Term Symbol, Type Symbol)]
</span><a href="#local-6989586621680535328"><span class="hs-identifier hs-var">tms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; MaybeT Transaction [(Term Symbol, Type Symbol)]
</span><span class="hs-identifier hs-var">Ops.loadTermComponent</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535327"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><span class="annottext">[(Term Symbol, Type Symbol)]
-&gt; ((Term Symbol, Type Symbol)
    -&gt; MaybeT Transaction (Term Symbol Ann, Type Symbol Ann))
-&gt; MaybeT Transaction [(Term Symbol Ann, Type Symbol Ann)]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">[(Term Symbol, Type Symbol)]
</span><a href="#local-6989586621680535328"><span class="hs-identifier hs-var">tms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Term Symbol -&gt; MaybeT Transaction (Term Symbol Ann))
-&gt; (Type Symbol -&gt; MaybeT Transaction (Type Symbol Ann))
-&gt; (Term Symbol, Type Symbol)
-&gt; MaybeT Transaction (Term Symbol Ann, Type Symbol Ann)
forall (f :: * -&gt; *) a c b d.
Applicative f =&gt;
(a -&gt; f c) -&gt; (b -&gt; f d) -&gt; (a, b) -&gt; f (c, d)
forall (t :: * -&gt; * -&gt; *) (f :: * -&gt; *) a c b d.
(Bitraversable t, Applicative f) =&gt;
(a -&gt; f c) -&gt; (b -&gt; f d) -&gt; t a b -&gt; f (t c d)
</span><span class="hs-identifier hs-var">bitraverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Transaction (Term Symbol Ann)
-&gt; MaybeT Transaction (Term Symbol Ann)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; MaybeT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (Term Symbol Ann)
 -&gt; MaybeT Transaction (Term Symbol Ann))
-&gt; (Term Symbol -&gt; Transaction (Term Symbol Ann))
-&gt; Term Symbol
-&gt; MaybeT Transaction (Term Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash
-&gt; (TypeReference -&gt; Transaction ConstructorType)
-&gt; Term Symbol
-&gt; Transaction (Term Symbol Ann)
forall (m :: * -&gt; *).
Monad m =&gt;
Hash
-&gt; (TypeReference -&gt; m ConstructorType)
-&gt; Term Symbol
-&gt; m (Term Symbol Ann)
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#term2to1"><span class="hs-identifier hs-var">Cv.term2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535327"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535326"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; MaybeT Transaction (Type Symbol Ann)
forall a. a -&gt; MaybeT Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Type Symbol Ann -&gt; MaybeT Transaction (Type Symbol Ann))
-&gt; (Type Symbol -&gt; Type Symbol Ann)
-&gt; Type Symbol
-&gt; MaybeT Transaction (Type Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol -&gt; Type Symbol Ann
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#ttype2to1"><span class="hs-identifier hs-var">Cv.ttype2to1</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTypeDeclaration"><span class="hs-identifier hs-type">getTypeDeclaration</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span id="getTypeDeclaration"><span class="annot"><span class="annottext">getTypeDeclaration :: Id -&gt; Transaction (Maybe (Decl Symbol Ann))
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getTypeDeclaration"><span class="hs-identifier hs-var hs-var">getTypeDeclaration</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680535332"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535332"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535333"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535333"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Transaction (Decl Symbol Ann)
-&gt; Transaction (Maybe (Decl Symbol Ann))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-260"></span><span>    </span><span id="local-6989586621680535334"><span class="annot"><span class="annottext">Decl Symbol
</span><a href="#local-6989586621680535334"><span class="hs-identifier hs-var">decl2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id -&gt; MaybeT Transaction (Decl Symbol)
</span><span class="hs-identifier hs-var">Ops.loadDeclByReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; ConstructorId -&gt; Id
forall h. h -&gt; ConstructorId -&gt; Id' h
</span><span class="hs-identifier hs-var">C.Reference.Id</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535332"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535333"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Decl Symbol -&gt; Decl Symbol Ann
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#decl2to1"><span class="hs-identifier hs-var">Cv.decl2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535332"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Decl Symbol
</span><a href="#local-6989586621680535334"><span class="hs-identifier hs-var">decl2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getDeclComponent"><span class="hs-identifier hs-type">getDeclComponent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span id="getDeclComponent"><span class="annot"><span class="annottext">getDeclComponent :: Hash -&gt; Transaction (Maybe [Decl Symbol Ann])
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getDeclComponent"><span class="hs-identifier hs-var hs-var">getDeclComponent</span></a></span></span><span> </span><span id="local-6989586621680535338"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535338"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-265"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Transaction [Decl Symbol Ann]
-&gt; Transaction (Maybe [Decl Symbol Ann])
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-266"></span><span>    </span><span id="local-6989586621680535339"><span class="annot"><span class="annottext">[Decl Symbol]
</span><a href="#local-6989586621680535339"><span class="hs-identifier hs-var">decl2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; MaybeT Transaction [Decl Symbol]
</span><span class="hs-identifier hs-var">Ops.loadDeclComponent</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535338"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-267"></span><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Decl Symbol -&gt; Decl Symbol Ann)
-&gt; [Decl Symbol] -&gt; [Decl Symbol Ann]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Decl Symbol -&gt; Decl Symbol Ann
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#decl2to1"><span class="hs-identifier hs-var">Cv.decl2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535338"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Decl Symbol]
</span><a href="#local-6989586621680535339"><span class="hs-identifier hs-var">decl2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="annot"><span class="hs-comment">-- | Like 'getDeclComponent', for when the decl component is known to exist in the codebase.</span></span><span>
</span><span id="line-270"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#expectDeclComponent"><span class="hs-identifier hs-type">expectDeclComponent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HasCallStack</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">]</span><span>
</span><span id="line-271"></span><span id="expectDeclComponent"><span class="annot"><span class="annottext">expectDeclComponent :: HasCallStack =&gt; Hash -&gt; Transaction [Decl Symbol Ann]
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#expectDeclComponent"><span class="hs-identifier hs-var hs-var">expectDeclComponent</span></a></span></span><span> </span><span id="local-6989586621680535349"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535349"><span class="hs-identifier hs-var">hash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-272"></span><span>  </span><span class="annot"><span class="annottext">Hash -&gt; Transaction (Maybe [Decl Symbol Ann])
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getDeclComponent"><span class="hs-identifier hs-var">getDeclComponent</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535349"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe [Decl Symbol Ann])
-&gt; (Maybe [Decl Symbol Ann] -&gt; [Decl Symbol Ann])
-&gt; Transaction [Decl Symbol Ann]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-273"></span><span>    </span><span class="annot"><span class="annottext">Maybe [Decl Symbol Ann]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WatchKind -&gt; [Decl Symbol Ann]
forall a. HasCallStack =&gt; WatchKind -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
</span><span class="hs-identifier hs-var">reportBug</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;E101611&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;decl component &quot;</span></span><span> </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; WatchKind
forall a. Show a =&gt; a -&gt; WatchKind
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535349"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">WatchKind -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot; not found&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680535351"><span class="annot"><span class="annottext">[Decl Symbol Ann]
</span><a href="#local-6989586621680535351"><span class="hs-identifier hs-var">decls</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Decl Symbol Ann]
</span><a href="#local-6989586621680535351"><span class="hs-identifier hs-var">decls</span></a></span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTermComponent"><span class="hs-identifier hs-type">putTermComponent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-277"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-278"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-279"></span><span>  </span><span class="annot"><span class="hs-comment">-- | The hash of the term component.</span></span><span>
</span><span id="line-280"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span id="putTermComponent"><span class="annot"><span class="annottext">putTermComponent :: TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry)
-&gt; Hash
-&gt; [(Term Symbol Ann, Type Symbol Ann)]
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTermComponent"><span class="hs-identifier hs-var hs-var">putTermComponent</span></a></span></span><span> </span><span id="local-6989586621680535353"><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535353"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680535354"><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535354"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span id="local-6989586621680535355"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535355"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535356"><span class="annot"><span class="annottext">[(Term Symbol Ann, Type Symbol Ann)]
</span><a href="#local-6989586621680535356"><span class="hs-identifier hs-var">component</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-284"></span><span>  </span><span class="annot"><span class="annottext">Transaction Bool -&gt; Transaction () -&gt; Transaction ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">unlessM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535355"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-285"></span><span>    </span><span class="annot"><span class="annottext">[(Id, (Term Symbol Ann, Type Symbol Ann))]
-&gt; ((Id, (Term Symbol Ann, Type Symbol Ann)) -&gt; Transaction ())
-&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash
-&gt; [(Term Symbol Ann, Type Symbol Ann)]
-&gt; [(Id, (Term Symbol Ann, Type Symbol Ann))]
forall a. Hash -&gt; [a] -&gt; [(Id, a)]
</span><span class="hs-identifier hs-var">Reference.componentFor</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535355"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">[(Term Symbol Ann, Type Symbol Ann)]
</span><a href="#local-6989586621680535356"><span class="hs-identifier hs-var">component</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680535359"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680535359"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680535360"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680535360"><span class="hs-identifier hs-var">tm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535361"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680535361"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-286"></span><span>      </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry)
-&gt; Id
-&gt; Term Symbol Ann
-&gt; Type Symbol Ann
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTerm_"><span class="hs-identifier hs-var">putTerm_</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535353"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535354"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680535359"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680535360"><span class="hs-identifier hs-var">tm</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680535361"><span class="hs-identifier hs-var">tp</span></a></span><span>
</span><span id="line-287"></span><span>      </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushTermBuffer"><span class="hs-identifier hs-var">tryFlushTermBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535353"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535355"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTerm"><span class="hs-identifier hs-type">putTerm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-290"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-291"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-292"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-293"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-294"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-295"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span id="putTerm"><span class="annot"><span class="annottext">putTerm :: TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry)
-&gt; Id
-&gt; Term Symbol Ann
-&gt; Type Symbol Ann
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTerm"><span class="hs-identifier hs-var hs-var">putTerm</span></a></span></span><span> </span><span id="local-6989586621680535365"><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535365"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680535366"><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535366"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span id="local-6989586621680535367"><span class="annot"><span class="annottext">ref :: Id
</span><a href="#local-6989586621680535367"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680535368"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535368"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680535369"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680535369"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span id="local-6989586621680535370"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680535370"><span class="hs-identifier hs-var">tp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><span class="annottext">Transaction Bool -&gt; Transaction () -&gt; Transaction ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">unlessM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535368"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry)
-&gt; Id
-&gt; Term Symbol Ann
-&gt; Type Symbol Ann
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTerm_"><span class="hs-identifier hs-var">putTerm_</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535365"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535366"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680535367"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680535369"><span class="hs-identifier hs-var">tm</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680535370"><span class="hs-identifier hs-var">tp</span></a></span><span>
</span><span id="line-299"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushTermBuffer"><span class="hs-identifier hs-var">tryFlushTermBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535365"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535368"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTerm_"><span class="hs-identifier hs-type">putTerm_</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-302"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-303"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-304"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-306"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span id="putTerm_"><span class="annot"><span class="annottext">putTerm_ :: TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry)
-&gt; Id
-&gt; Term Symbol Ann
-&gt; Type Symbol Ann
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTerm_"><span class="hs-identifier hs-var hs-var">putTerm_</span></a></span></span><span> </span><span id="local-6989586621680535371"><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535371"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680535372"><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535372"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680535373"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535373"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535374"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535374"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680535375"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680535375"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span id="local-6989586621680535376"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680535376"><span class="hs-identifier hs-var">tp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span id="local-6989586621680535377"><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535377"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621680535378"><span class="annot"><span class="annottext">Map ConstructorId (Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621680535378"><span class="hs-identifier hs-var">comp</span></a></span></span><span> </span><span id="local-6989586621680535379"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535379"><span class="hs-identifier hs-var">missing</span></a></span></span><span> </span><span id="local-6989586621680535380"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535380"><span class="hs-identifier hs-var">waiting</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO TermBufferEntry -&gt; Transaction TermBufferEntry
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; IO TermBufferEntry
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBuffer"><span class="hs-identifier hs-var">getBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535371"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535373"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535381"><span class="annot"><span class="annottext">termDependencies :: [TypeReference]
</span><a href="#local-6989586621680535381"><span class="hs-identifier hs-var hs-var">termDependencies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set TypeReference -&gt; [TypeReference]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set TypeReference -&gt; [TypeReference])
-&gt; Set TypeReference -&gt; [TypeReference]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Set TypeReference
forall v vt at ap a.
(Ord v, Ord vt) =&gt;
Term2 vt at ap v a -&gt; Set TypeReference
</span><span class="hs-identifier hs-var">Term.termDependencies</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680535375"><span class="hs-identifier hs-var">tm</span></a></span><span>
</span><span id="line-311"></span><span>  </span><span class="hs-comment">-- update the component target size if we encounter any higher self-references</span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535383"><span class="annot"><span class="annottext">size' :: Maybe ConstructorId
</span><a href="#local-6989586621680535383"><span class="hs-identifier hs-var hs-var">size'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId -&gt; Maybe ConstructorId -&gt; Maybe ConstructorId
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535377"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstructorId -&gt; Maybe ConstructorId
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ConstructorId -&gt; Maybe ConstructorId)
-&gt; ConstructorId -&gt; Maybe ConstructorId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535385"><span class="hs-identifier hs-var">biggestSelfReference</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorId -&gt; ConstructorId -&gt; ConstructorId
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-314"></span><span>          </span><span id="local-6989586621680535385"><span class="annot"><span class="annottext">biggestSelfReference :: ConstructorId
</span><a href="#local-6989586621680535385"><span class="hs-identifier hs-var hs-var">biggestSelfReference</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-315"></span><span>            </span><span class="annot"><span class="annottext">NonEmpty ConstructorId -&gt; ConstructorId
forall a. Ord a =&gt; NonEmpty a -&gt; a
</span><span class="hs-identifier hs-var">maximum1</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty ConstructorId -&gt; ConstructorId)
-&gt; NonEmpty ConstructorId -&gt; ConstructorId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-316"></span><span>              </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535374"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorId -&gt; [ConstructorId] -&gt; NonEmpty ConstructorId
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535387"><span class="hs-identifier hs-var">i'</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Derived</span></span><span> </span><span id="local-6989586621680535389"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535389"><span class="hs-identifier hs-var">h'</span></a></span></span><span> </span><span id="local-6989586621680535387"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535387"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TypeReference]
</span><a href="#local-6989586621680535381"><span class="hs-identifier hs-var">termDependencies</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535373"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Hash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535389"><span class="hs-identifier hs-var">h'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-317"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535390"><span class="annot"><span class="annottext">comp' :: Map ConstructorId (Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621680535390"><span class="hs-identifier hs-var hs-var">comp'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstructorId
-&gt; (Term Symbol Ann, Type Symbol Ann)
-&gt; Map ConstructorId (Term Symbol Ann, Type Symbol Ann)
-&gt; Map ConstructorId (Term Symbol Ann, Type Symbol Ann)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535374"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680535375"><span class="hs-identifier hs-var">tm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680535376"><span class="hs-identifier hs-var">tp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map ConstructorId (Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621680535378"><span class="hs-identifier hs-var">comp</span></a></span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-comment">-- for the component element that's been passed in, add its dependencies to missing'</span><span>
</span><span id="line-319"></span><span>  </span><span id="local-6989586621680535391"><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680535391"><span class="hs-identifier hs-var">missingTerms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction Bool) -&gt; [Hash] -&gt; Transaction [Hash]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><span class="hs-identifier hs-var">filterM</span></span><span>
</span><span id="line-321"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Transaction Bool -&gt; Transaction Bool
forall a b. (a -&gt; b) -&gt; Transaction a -&gt; Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Transaction Bool -&gt; Transaction Bool)
-&gt; (Hash -&gt; Transaction Bool) -&gt; Hash -&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span>      </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535392"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Derived</span></span><span> </span><span id="local-6989586621680535392"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535392"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535393"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535393"><span class="hs-identifier hs-var">_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TypeReference]
</span><a href="#local-6989586621680535381"><span class="hs-identifier hs-var">termDependencies</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-323"></span><span>  </span><span id="local-6989586621680535394"><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680535394"><span class="hs-identifier hs-var">missingTypes'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-324"></span><span>    </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction Bool) -&gt; [Hash] -&gt; Transaction [Hash]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><span class="hs-identifier hs-var">filterM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Transaction Bool -&gt; Transaction Bool
forall a b. (a -&gt; b) -&gt; Transaction a -&gt; Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Transaction Bool -&gt; Transaction Bool)
-&gt; (Hash -&gt; Transaction Bool) -&gt; Hash -&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Hash] -&gt; Transaction [Hash]) -&gt; [Hash] -&gt; Transaction [Hash]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-325"></span><span>      </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535395"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Derived</span></span><span> </span><span id="local-6989586621680535395"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535395"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535396"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535396"><span class="hs-identifier hs-var">_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set TypeReference -&gt; [TypeReference]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set TypeReference -&gt; [TypeReference])
-&gt; Set TypeReference -&gt; [TypeReference]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann -&gt; Set TypeReference
forall v vt at ap a.
(Ord v, Ord vt) =&gt;
Term2 vt at ap v a -&gt; Set TypeReference
</span><span class="hs-identifier hs-var">Term.typeDependencies</span></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680535375"><span class="hs-identifier hs-var">tm</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-326"></span><span>        </span><span class="annot"><span class="annottext">[Hash] -&gt; [Hash] -&gt; [Hash]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535398"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Derived</span></span><span> </span><span id="local-6989586621680535398"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535398"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535399"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535399"><span class="hs-identifier hs-var">_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set TypeReference -&gt; [TypeReference]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set TypeReference -&gt; [TypeReference])
-&gt; Set TypeReference -&gt; [TypeReference]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Set TypeReference
forall v a. Ord v =&gt; Type v a -&gt; Set TypeReference
</span><span class="hs-identifier hs-var">Type.dependencies</span></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680535376"><span class="hs-identifier hs-var">tp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-327"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535401"><span class="annot"><span class="annottext">missing' :: Set Hash
</span><a href="#local-6989586621680535401"><span class="hs-identifier hs-var hs-var">missing'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535379"><span class="hs-identifier hs-var">missing</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; Set Hash -&gt; Set Hash
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; Set Hash
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680535391"><span class="hs-identifier hs-var">missingTerms'</span></a></span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; [Hash] -&gt; [Hash]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680535394"><span class="hs-identifier hs-var">missingTypes'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-comment">-- notify each of the dependencies that h depends on them.</span><span>
</span><span id="line-330"></span><span>    </span><span class="annot"><span class="annottext">(Hash -&gt; IO ()) -&gt; [Hash] -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; IO ()
forall a. Hash -&gt; TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#addBufferDependent"><span class="hs-identifier hs-var">addBufferDependent</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535373"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535371"><span class="hs-identifier hs-var">termBuffer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680535391"><span class="hs-identifier hs-var">missingTerms'</span></a></span><span>
</span><span id="line-331"></span><span>    </span><span class="annot"><span class="annottext">(Hash -&gt; IO ()) -&gt; [Hash] -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; IO ()
forall a. Hash -&gt; TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#addBufferDependent"><span class="hs-identifier hs-var">addBufferDependent</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535373"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535372"><span class="hs-identifier hs-var">declBuffer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680535394"><span class="hs-identifier hs-var">missingTypes'</span></a></span><span>
</span><span id="line-332"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; TermBufferEntry -&gt; IO ()
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBuffer"><span class="hs-identifier hs-var">putBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535371"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535373"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ConstructorId
-&gt; Map ConstructorId (Term Symbol Ann, Type Symbol Ann)
-&gt; Set Hash
-&gt; Set Hash
-&gt; TermBufferEntry
forall a.
Maybe ConstructorId
-&gt; Map ConstructorId a -&gt; Set Hash -&gt; Set Hash -&gt; BufferEntry a
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-var">BufferEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535383"><span class="hs-identifier hs-var">size'</span></a></span><span> </span><span class="annot"><span class="annottext">Map ConstructorId (Term Symbol Ann, Type Symbol Ann)
</span><a href="#local-6989586621680535390"><span class="hs-identifier hs-var">comp'</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535401"><span class="hs-identifier hs-var">missing'</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535380"><span class="hs-identifier hs-var">waiting</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushTermBuffer"><span class="hs-identifier hs-type">tryFlushTermBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-335"></span><span id="tryFlushTermBuffer"><span class="annot"><span class="annottext">tryFlushTermBuffer :: TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushTermBuffer"><span class="hs-identifier hs-var hs-var">tryFlushTermBuffer</span></a></span></span><span> </span><span id="local-6989586621680535402"><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535402"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535403"><span class="annot"><span class="annottext">loop :: Hash -&gt; Transaction ()
</span><a href="#local-6989586621680535403"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621680535404"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535404"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-337"></span><span>        </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
-&gt; (Hash -&gt; [(Term Symbol Ann, Type Symbol Ann)] -&gt; Transaction ())
-&gt; (Hash -&gt; Transaction ())
-&gt; Hash
-&gt; Transaction ()
forall a.
Show a =&gt;
TVar (Map Hash (BufferEntry a))
-&gt; (Hash -&gt; [a] -&gt; Transaction ())
-&gt; (Hash -&gt; Transaction ())
-&gt; Hash
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushBuffer"><span class="hs-identifier hs-var">tryFlushBuffer</span></a></span><span>
</span><span id="line-338"></span><span>          </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535402"><span class="hs-identifier hs-var">termBuffer</span></a></span><span>
</span><span id="line-339"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680535405"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535405"><span class="hs-identifier hs-var">h2</span></a></span></span><span> </span><span id="local-6989586621680535406"><span class="annot"><span class="annottext">[(Term Symbol Ann, Type Symbol Ann)]
</span><a href="#local-6989586621680535406"><span class="hs-identifier hs-var">component</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Transaction ObjectId -&gt; Transaction ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(Transaction ObjectId -&gt; Transaction ())
-&gt; Transaction ObjectId -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
-&gt; Maybe ByteString
-&gt; Hash
-&gt; [(Term Symbol, Type Symbol)]
-&gt; Transaction ObjectId
</span><span class="hs-identifier hs-var">Q.saveTermComponent</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535405"><span class="hs-identifier hs-var">h2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash
-&gt; [(Term Symbol Ann, Type Symbol Ann)]
-&gt; [(Term Symbol, Type Symbol)]
forall a.
Hash
-&gt; [(Term Symbol Ann, Type Symbol a)]
-&gt; [(Term Symbol, Type Symbol)]
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#termComponent1to2"><span class="hs-identifier hs-var">Cv.termComponent1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535404"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">[(Term Symbol Ann, Type Symbol Ann)]
</span><a href="#local-6989586621680535406"><span class="hs-identifier hs-var">component</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>          </span><span class="annot"><span class="annottext">Hash -&gt; Transaction ()
</span><a href="#local-6989586621680535403"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-341"></span><span>          </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535404"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-342"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction ()
</span><a href="#local-6989586621680535403"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#addDeclComponentTypeIndex"><span class="hs-identifier hs-type">addDeclComponentTypeIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ObjectId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-345"></span><span id="addDeclComponentTypeIndex"><span class="annot"><span class="annottext">addDeclComponentTypeIndex :: ObjectId -&gt; [[Type Symbol Ann]] -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#addDeclComponentTypeIndex"><span class="hs-identifier hs-var hs-var">addDeclComponentTypeIndex</span></a></span></span><span> </span><span id="local-6989586621680535411"><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680535411"><span class="hs-identifier hs-var">oId</span></a></span></span><span> </span><span id="local-6989586621680535412"><span class="annot"><span class="annottext">[[Type Symbol Ann]]
</span><a href="#local-6989586621680535412"><span class="hs-identifier hs-var">ctorss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-346"></span><span>  </span><span class="annot"><span class="annottext">[([Type Symbol Ann], ConstructorId)]
-&gt; (([Type Symbol Ann], ConstructorId) -&gt; Transaction ())
-&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[Type Symbol Ann]]
</span><a href="#local-6989586621680535412"><span class="hs-identifier hs-var">ctorss</span></a></span><span> </span><span class="annot"><span class="annottext">[[Type Symbol Ann]]
-&gt; [ConstructorId] -&gt; [([Type Symbol Ann], ConstructorId)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ConstructorId
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680535413"><span class="annot"><span class="annottext">[Type Symbol Ann]
</span><a href="#local-6989586621680535413"><span class="hs-identifier hs-var">ctors</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535414"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535414"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><span class="annottext">[(Type Symbol Ann, ConstructorId)]
-&gt; ((Type Symbol Ann, ConstructorId) -&gt; Transaction ())
-&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type Symbol Ann]
</span><a href="#local-6989586621680535413"><span class="hs-identifier hs-var">ctors</span></a></span><span> </span><span class="annot"><span class="annottext">[Type Symbol Ann]
-&gt; [ConstructorId] -&gt; [(Type Symbol Ann, ConstructorId)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-operator hs-var">`zip`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ConstructorId
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680535415"><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680535415"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535416"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535416"><span class="hs-identifier hs-var">j</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-348"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535417"><span class="annot"><span class="annottext">self :: Id' ObjectId ObjectId
</span><a href="#local-6989586621680535417"><span class="hs-identifier hs-var hs-var">self</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Id' ObjectId -&gt; ConstructorId -&gt; Id' ObjectId ObjectId
forall hTm hTp. Id' hTp -&gt; ConstructorId -&gt; Id' hTm hTp
</span><span class="hs-identifier hs-var">C.Referent.ConId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ObjectId -&gt; ConstructorId -&gt; Id' ObjectId
forall h. h -&gt; ConstructorId -&gt; Id' h
</span><span class="hs-identifier hs-var">C.Reference.Id</span></span><span> </span><span class="annot"><span class="annottext">ObjectId
</span><a href="#local-6989586621680535411"><span class="hs-identifier hs-var">oId</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535414"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535416"><span class="hs-identifier hs-var">j</span></a></span><span>
</span><span id="line-349"></span><span>          </span><span id="local-6989586621680535419"><span class="annot"><span class="annottext">typeForIndexing :: TypeReference
</span><a href="#local-6989586621680535419"><span class="hs-identifier hs-var hs-var">typeForIndexing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; TypeReference
forall v a. Var v =&gt; Type v a -&gt; TypeReference
</span><a href="Unison.Hashing.V2.Convert.html#typeToReference"><span class="hs-identifier hs-var">Hashing.typeToReference</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680535415"><span class="hs-identifier hs-var">tp</span></a></span><span>
</span><span id="line-350"></span><span>          </span><span id="local-6989586621680535421"><span class="annot"><span class="annottext">typeMentionsForIndexing :: Set TypeReference
</span><a href="#local-6989586621680535421"><span class="hs-identifier hs-var hs-var">typeMentionsForIndexing</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann -&gt; Set TypeReference
forall v a. Var v =&gt; Type v a -&gt; Set TypeReference
</span><a href="Unison.Hashing.V2.Convert.html#typeToReferenceMentions"><span class="hs-identifier hs-var">Hashing.typeToReferenceMentions</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><a href="#local-6989586621680535415"><span class="hs-identifier hs-var">tp</span></a></span><span>
</span><span id="line-351"></span><span>      </span><span class="annot"><span class="annottext">Id' ObjectId ObjectId -&gt; TypeReference -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Ops.addTypeToIndexForTerm</span></span><span> </span><span class="annot"><span class="annottext">Id' ObjectId ObjectId
</span><a href="#local-6989586621680535417"><span class="hs-identifier hs-var">self</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeReference -&gt; TypeReference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535419"><span class="hs-identifier hs-var">typeForIndexing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>      </span><span class="annot"><span class="annottext">Id' ObjectId ObjectId -&gt; Set TypeReference -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Ops.addTypeMentionsToIndexForTerm</span></span><span> </span><span class="annot"><span class="annottext">Id' ObjectId ObjectId
</span><a href="#local-6989586621680535417"><span class="hs-identifier hs-var">self</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeReference -&gt; TypeReference)
-&gt; Set TypeReference -&gt; Set TypeReference
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; TypeReference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Set TypeReference
</span><a href="#local-6989586621680535421"><span class="hs-identifier hs-var">typeMentionsForIndexing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>
</span><span id="line-354"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTypeDeclarationComponent"><span class="hs-identifier hs-type">putTypeDeclarationComponent</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-355"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-356"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-357"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-359"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span id="putTypeDeclarationComponent"><span class="annot"><span class="annottext">putTypeDeclarationComponent :: TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry)
-&gt; Hash
-&gt; [Decl Symbol Ann]
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTypeDeclarationComponent"><span class="hs-identifier hs-var hs-var">putTypeDeclarationComponent</span></a></span></span><span> </span><span id="local-6989586621680535428"><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535428"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680535429"><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535429"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span id="local-6989586621680535430"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535430"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535431"><span class="annot"><span class="annottext">[Decl Symbol Ann]
</span><a href="#local-6989586621680535431"><span class="hs-identifier hs-var">decls</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-361"></span><span>  </span><span class="annot"><span class="annottext">Transaction Bool -&gt; Transaction () -&gt; Transaction ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">unlessM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535430"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-362"></span><span>    </span><span class="annot"><span class="annottext">[(Id, Decl Symbol Ann)]
-&gt; ((Id, Decl Symbol Ann) -&gt; Transaction ()) -&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; [Decl Symbol Ann] -&gt; [(Id, Decl Symbol Ann)]
forall a. Hash -&gt; [a] -&gt; [(Id, a)]
</span><span class="hs-identifier hs-var">Reference.componentFor</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535430"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">[Decl Symbol Ann]
</span><a href="#local-6989586621680535431"><span class="hs-identifier hs-var">decls</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680535432"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680535432"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535433"><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680535433"><span class="hs-identifier hs-var">decl</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-363"></span><span>      </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
-&gt; Id -&gt; Decl Symbol Ann -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTypeDeclaration_"><span class="hs-identifier hs-var">putTypeDeclaration_</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535429"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680535432"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680535433"><span class="hs-identifier hs-var">decl</span></a></span><span>
</span><span id="line-364"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushDeclBuffer"><span class="hs-identifier hs-var">tryFlushDeclBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535428"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535429"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535430"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTypeDeclaration"><span class="hs-identifier hs-type">putTypeDeclaration</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-367"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-368"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-369"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-370"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-371"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-372"></span><span id="putTypeDeclaration"><span class="annot"><span class="annottext">putTypeDeclaration :: TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry)
-&gt; Id
-&gt; Decl Symbol Ann
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTypeDeclaration"><span class="hs-identifier hs-var hs-var">putTypeDeclaration</span></a></span></span><span> </span><span id="local-6989586621680535437"><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535437"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680535438"><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535438"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span id="local-6989586621680535439"><span class="annot"><span class="annottext">ref :: Id
</span><a href="#local-6989586621680535439"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680535440"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535440"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680535441"><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680535441"><span class="hs-identifier hs-var">decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-373"></span><span>  </span><span class="annot"><span class="annottext">Transaction Bool -&gt; Transaction () -&gt; Transaction ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">unlessM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535440"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-374"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
-&gt; Id -&gt; Decl Symbol Ann -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTypeDeclaration_"><span class="hs-identifier hs-var">putTypeDeclaration_</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535438"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680535439"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680535441"><span class="hs-identifier hs-var">decl</span></a></span><span>
</span><span id="line-375"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushDeclBuffer"><span class="hs-identifier hs-var">tryFlushDeclBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535437"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535438"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535440"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTypeDeclaration_"><span class="hs-identifier hs-type">putTypeDeclaration_</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-378"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-379"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-380"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-381"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span id="putTypeDeclaration_"><span class="annot"><span class="annottext">putTypeDeclaration_ :: TVar (Map Hash DeclBufferEntry)
-&gt; Id -&gt; Decl Symbol Ann -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putTypeDeclaration_"><span class="hs-identifier hs-var hs-var">putTypeDeclaration_</span></a></span></span><span> </span><span id="local-6989586621680535442"><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535442"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680535443"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535443"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535444"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535444"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680535445"><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680535445"><span class="hs-identifier hs-var">decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-383"></span><span>  </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-type">BufferEntry</span></a></span><span> </span><span id="local-6989586621680535446"><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535446"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621680535447"><span class="annot"><span class="annottext">Map ConstructorId (Decl Symbol Ann)
</span><a href="#local-6989586621680535447"><span class="hs-identifier hs-var">comp</span></a></span></span><span> </span><span id="local-6989586621680535448"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535448"><span class="hs-identifier hs-var">missing</span></a></span></span><span> </span><span id="local-6989586621680535449"><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535449"><span class="hs-identifier hs-var">waiting</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO DeclBufferEntry -&gt; Transaction DeclBufferEntry
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; IO DeclBufferEntry
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO (BufferEntry a)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBuffer"><span class="hs-identifier hs-var">getBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535442"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535443"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535450"><span class="annot"><span class="annottext">declDependencies :: [TypeReference]
</span><a href="#local-6989586621680535450"><span class="hs-identifier hs-var hs-var">declDependencies</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set TypeReference -&gt; [TypeReference]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set TypeReference -&gt; [TypeReference])
-&gt; Set TypeReference -&gt; [TypeReference]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann -&gt; Set TypeReference
forall v a. Ord v =&gt; Decl v a -&gt; Set TypeReference
</span><span class="hs-identifier hs-var">Decl.declTypeDependencies</span></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680535445"><span class="hs-identifier hs-var">decl</span></a></span><span>
</span><span id="line-385"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535452"><span class="annot"><span class="annottext">size' :: Maybe ConstructorId
</span><a href="#local-6989586621680535452"><span class="hs-identifier hs-var hs-var">size'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId -&gt; Maybe ConstructorId -&gt; Maybe ConstructorId
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535446"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstructorId -&gt; Maybe ConstructorId
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ConstructorId -&gt; Maybe ConstructorId)
-&gt; ConstructorId -&gt; Maybe ConstructorId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535453"><span class="hs-identifier hs-var">biggestSelfReference</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorId -&gt; ConstructorId -&gt; ConstructorId
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-387"></span><span>          </span><span id="local-6989586621680535453"><span class="annot"><span class="annottext">biggestSelfReference :: ConstructorId
</span><a href="#local-6989586621680535453"><span class="hs-identifier hs-var hs-var">biggestSelfReference</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-388"></span><span>            </span><span class="annot"><span class="annottext">NonEmpty ConstructorId -&gt; ConstructorId
forall a. Ord a =&gt; NonEmpty a -&gt; a
</span><span class="hs-identifier hs-var">maximum1</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty ConstructorId -&gt; ConstructorId)
-&gt; NonEmpty ConstructorId -&gt; ConstructorId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-389"></span><span>              </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535444"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorId -&gt; [ConstructorId] -&gt; NonEmpty ConstructorId
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535454"><span class="hs-identifier hs-var">i'</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Derived</span></span><span> </span><span id="local-6989586621680535455"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535455"><span class="hs-identifier hs-var">h'</span></a></span></span><span> </span><span id="local-6989586621680535454"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535454"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TypeReference]
</span><a href="#local-6989586621680535450"><span class="hs-identifier hs-var">declDependencies</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535443"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Hash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535455"><span class="hs-identifier hs-var">h'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535456"><span class="annot"><span class="annottext">comp' :: Map ConstructorId (Decl Symbol Ann)
</span><a href="#local-6989586621680535456"><span class="hs-identifier hs-var hs-var">comp'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstructorId
-&gt; Decl Symbol Ann
-&gt; Map ConstructorId (Decl Symbol Ann)
-&gt; Map ConstructorId (Decl Symbol Ann)
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535444"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680535445"><span class="hs-identifier hs-var">decl</span></a></span><span> </span><span class="annot"><span class="annottext">Map ConstructorId (Decl Symbol Ann)
</span><a href="#local-6989586621680535447"><span class="hs-identifier hs-var">comp</span></a></span><span>
</span><span id="line-391"></span><span>  </span><span id="local-6989586621680535457"><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680535457"><span class="hs-identifier hs-var">moreMissing</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-392"></span><span>    </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction Bool) -&gt; [Hash] -&gt; Transaction [Hash]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><span class="hs-identifier hs-var">filterM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Transaction Bool -&gt; Transaction Bool
forall a b. (a -&gt; b) -&gt; Transaction a -&gt; Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Transaction Bool -&gt; Transaction Bool)
-&gt; (Hash -&gt; Transaction Bool) -&gt; Hash -&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.objectExistsForHash</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Hash] -&gt; Transaction [Hash]) -&gt; [Hash] -&gt; Transaction [Hash]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-393"></span><span>      </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535458"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Derived</span></span><span> </span><span id="local-6989586621680535458"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535458"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535459"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535459"><span class="hs-identifier hs-var">_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TypeReference]
</span><a href="#local-6989586621680535450"><span class="hs-identifier hs-var">declDependencies</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-394"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535460"><span class="annot"><span class="annottext">missing' :: Set Hash
</span><a href="#local-6989586621680535460"><span class="hs-identifier hs-var hs-var">missing'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535448"><span class="hs-identifier hs-var">missing</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash -&gt; Set Hash -&gt; Set Hash
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Hash] -&gt; Set Hash
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680535457"><span class="hs-identifier hs-var">moreMissing</span></a></span><span>
</span><span id="line-395"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-396"></span><span>    </span><span class="annot"><span class="annottext">(Hash -&gt; IO ()) -&gt; [Hash] -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; IO ()
forall a. Hash -&gt; TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#addBufferDependent"><span class="hs-identifier hs-var">addBufferDependent</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535443"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535442"><span class="hs-identifier hs-var">declBuffer</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Hash]
</span><a href="#local-6989586621680535457"><span class="hs-identifier hs-var">moreMissing</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; DeclBufferEntry -&gt; IO ()
forall a.
TVar (Map Hash (BufferEntry a)) -&gt; Hash -&gt; BufferEntry a -&gt; IO ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBuffer"><span class="hs-identifier hs-var">putBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535442"><span class="hs-identifier hs-var">declBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535443"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ConstructorId
-&gt; Map ConstructorId (Decl Symbol Ann)
-&gt; Set Hash
-&gt; Set Hash
-&gt; DeclBufferEntry
forall a.
Maybe ConstructorId
-&gt; Map ConstructorId a -&gt; Set Hash -&gt; Set Hash -&gt; BufferEntry a
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#BufferEntry"><span class="hs-identifier hs-var">BufferEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535452"><span class="hs-identifier hs-var">size'</span></a></span><span> </span><span class="annot"><span class="annottext">Map ConstructorId (Decl Symbol Ann)
</span><a href="#local-6989586621680535456"><span class="hs-identifier hs-var">comp'</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535460"><span class="hs-identifier hs-var">missing'</span></a></span><span> </span><span class="annot"><span class="annottext">Set Hash
</span><a href="#local-6989586621680535449"><span class="hs-identifier hs-var">waiting</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushDeclBuffer"><span class="hs-identifier hs-type">tryFlushDeclBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-400"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#TermBufferEntry"><span class="hs-identifier hs-type">TermBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-401"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#DeclBufferEntry"><span class="hs-identifier hs-type">DeclBufferEntry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-402"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-403"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-404"></span><span id="tryFlushDeclBuffer"><span class="annot"><span class="annottext">tryFlushDeclBuffer :: TVar (Map Hash TermBufferEntry)
-&gt; TVar (Map Hash DeclBufferEntry) -&gt; Hash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushDeclBuffer"><span class="hs-identifier hs-var hs-var">tryFlushDeclBuffer</span></a></span></span><span> </span><span id="local-6989586621680535461"><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535461"><span class="hs-identifier hs-var">termBuffer</span></a></span></span><span> </span><span id="local-6989586621680535462"><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535462"><span class="hs-identifier hs-var">declBuffer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535463"><span class="annot"><span class="annottext">loop :: Hash -&gt; Transaction ()
</span><a href="#local-6989586621680535463"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621680535464"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535464"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-406"></span><span>        </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
-&gt; (Hash -&gt; [Decl Symbol Ann] -&gt; Transaction ())
-&gt; (Hash -&gt; Transaction ())
-&gt; Hash
-&gt; Transaction ()
forall a.
Show a =&gt;
TVar (Map Hash (BufferEntry a))
-&gt; (Hash -&gt; [a] -&gt; Transaction ())
-&gt; (Hash -&gt; Transaction ())
-&gt; Hash
-&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushBuffer"><span class="hs-identifier hs-var">tryFlushBuffer</span></a></span><span>
</span><span id="line-407"></span><span>          </span><span class="annot"><span class="annottext">TVar (Map Hash DeclBufferEntry)
</span><a href="#local-6989586621680535462"><span class="hs-identifier hs-var">declBuffer</span></a></span><span>
</span><span id="line-408"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680535465"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535465"><span class="hs-identifier hs-var">h2</span></a></span></span><span> </span><span id="local-6989586621680535466"><span class="annot"><span class="annottext">[Decl Symbol Ann]
</span><a href="#local-6989586621680535466"><span class="hs-identifier hs-var">component</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-409"></span><span>              </span><span class="annot"><span class="annottext">Transaction ObjectId -&gt; Transaction ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(Transaction ObjectId -&gt; Transaction ())
-&gt; Transaction ObjectId -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-410"></span><span>                </span><span class="annot"><span class="annottext">HashHandle
-&gt; Maybe ByteString
-&gt; Hash
-&gt; [Decl Symbol]
-&gt; Transaction ObjectId
</span><span class="hs-identifier hs-var">Q.saveDeclComponent</span></span><span>
</span><span id="line-411"></span><span>                  </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span>
</span><span id="line-412"></span><span>                  </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-413"></span><span>                  </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535465"><span class="hs-identifier hs-var">h2</span></a></span><span>
</span><span id="line-414"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Decl Symbol Ann -&gt; Decl Symbol)
-&gt; [Decl Symbol Ann] -&gt; [Decl Symbol]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Decl Symbol Ann -&gt; Decl Symbol
forall a. Hash -&gt; Decl Symbol a -&gt; Decl Symbol
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#decl1to2"><span class="hs-identifier hs-var">Cv.decl1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535464"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Decl Symbol Ann]
</span><a href="#local-6989586621680535466"><span class="hs-identifier hs-var">component</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-416"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680535469"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535469"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry) -&gt; Hash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#tryFlushTermBuffer"><span class="hs-identifier hs-var">tryFlushTermBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map Hash TermBufferEntry)
</span><a href="#local-6989586621680535461"><span class="hs-identifier hs-var">termBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535469"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction () -&gt; Transaction () -&gt; Transaction ()
forall a b. Transaction a -&gt; Transaction b -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction ()
</span><a href="#local-6989586621680535463"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535469"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>          </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535464"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-418"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction ()
</span><a href="#local-6989586621680535463"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span class="hs-comment">-- if this blows up on cromulent hashes, then switch from `hashToHashId`</span><span>
</span><span id="line-421"></span><span class="hs-comment">-- to one that returns Maybe.</span><span>
</span><span id="line-422"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBranchForHash"><span class="hs-identifier hs-type">getBranchForHash</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-423"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span></span><span>
</span><span id="line-424"></span><span>  </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Branch.Cache.html#BranchCache"><span class="hs-identifier hs-type">BranchCache</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-425"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-426"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-427"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier hs-type">Branch</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span id="getBranchForHash"><span class="annot"><span class="annottext">getBranchForHash :: BranchCache Transaction
-&gt; (TypeReference -&gt; Transaction ConstructorType)
-&gt; CausalHash
-&gt; Transaction (Maybe (Branch Transaction))
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getBranchForHash"><span class="hs-identifier hs-var hs-var">getBranchForHash</span></a></span></span><span> </span><span id="local-6989586621680535471"><span class="annot"><span class="annottext">BranchCache Transaction
</span><a href="#local-6989586621680535471"><span class="hs-identifier hs-var">branchCache</span></a></span></span><span> </span><span id="local-6989586621680535472"><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535472"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span id="local-6989586621680535473"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680535473"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-429"></span><span>  </span><span class="annot"><span class="annottext">CausalHash -&gt; Transaction (Maybe (CausalBranch Transaction))
</span><span class="hs-identifier hs-var">Ops.loadCausalBranchByCausalHash</span></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680535473"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe (CausalBranch Transaction))
-&gt; (Maybe (CausalBranch Transaction)
    -&gt; Transaction (Maybe (Branch Transaction)))
-&gt; Transaction (Maybe (Branch Transaction))
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-430"></span><span>    </span><span class="annot"><span class="annottext">Maybe (CausalBranch Transaction)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Branch Transaction)
-&gt; Transaction (Maybe (Branch Transaction))
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Branch Transaction)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-431"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680535475"><span class="annot"><span class="annottext">CausalBranch Transaction
</span><a href="#local-6989586621680535475"><span class="hs-identifier hs-var">causal2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-432"></span><span>      </span><span id="local-6989586621680535476"><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680535476"><span class="hs-identifier hs-var">branch1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BranchCache Transaction
-&gt; (TypeReference -&gt; Transaction ConstructorType)
-&gt; CausalBranch Transaction
-&gt; Transaction (Branch Transaction)
forall (m :: * -&gt; *).
Monad m =&gt;
BranchCache m
-&gt; (TypeReference -&gt; m ConstructorType)
-&gt; CausalBranch m
-&gt; m (Branch m)
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalbranch2to1"><span class="hs-identifier hs-var">Cv.causalbranch2to1</span></a></span><span> </span><span class="annot"><span class="annottext">BranchCache Transaction
</span><a href="#local-6989586621680535471"><span class="hs-identifier hs-var">branchCache</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535472"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">CausalBranch Transaction
</span><a href="#local-6989586621680535475"><span class="hs-identifier hs-var">causal2</span></a></span><span>
</span><span id="line-433"></span><span>      </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Branch Transaction -&gt; Maybe (Branch Transaction)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680535476"><span class="hs-identifier hs-var">branch1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBranch"><span class="hs-identifier hs-type">putBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.Branch.Type.html#Branch"><span class="hs-identifier hs-type">Branch</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span id="putBranch"><span class="annot"><span class="annottext">putBranch :: Branch Transaction -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBranch"><span class="hs-identifier hs-var hs-var">putBranch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-437"></span><span>  </span><span class="annot"><span class="annottext">Transaction (BranchObjectId, CausalHashId) -&gt; Transaction ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (BranchObjectId, CausalHashId) -&gt; Transaction ())
-&gt; (Branch Transaction
    -&gt; Transaction (BranchObjectId, CausalHashId))
-&gt; Branch Transaction
-&gt; Transaction ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
-&gt; CausalBranch Transaction
-&gt; Transaction (BranchObjectId, CausalHashId)
</span><span class="hs-identifier hs-var">Ops.saveBranch</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span> </span><span class="annot"><span class="annottext">(CausalBranch Transaction
 -&gt; Transaction (BranchObjectId, CausalHashId))
-&gt; (Branch Transaction -&gt; CausalBranch Transaction)
-&gt; Branch Transaction
-&gt; Transaction (BranchObjectId, CausalHashId)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Branch Transaction -&gt; CausalBranch Transaction
forall (m :: * -&gt; *). Monad m =&gt; Branch m -&gt; CausalBranch m
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#causalbranch1to2"><span class="hs-identifier hs-var">Cv.causalbranch1to2</span></a></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span class="annot"><span class="hs-comment">-- | Check whether the given branch exists in the codebase.</span></span><span>
</span><span id="line-440"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#branchExists"><span class="hs-identifier hs-type">branchExists</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-441"></span><span id="branchExists"><span class="annot"><span class="annottext">branchExists :: CausalHash -&gt; Transaction Bool
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#branchExists"><span class="hs-identifier hs-var hs-var">branchExists</span></a></span></span><span> </span><span id="local-6989586621680535482"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680535482"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-442"></span><span>  </span><span class="annot"><span class="annottext">Hash -&gt; Transaction (Maybe HashId)
</span><span class="hs-identifier hs-var">Q.loadHashIdByHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash -&gt; Hash
</span><span class="hs-identifier hs-var">unCausalHash</span></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680535482"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe HashId)
-&gt; (Maybe HashId -&gt; Transaction Bool) -&gt; Transaction Bool
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-443"></span><span>    </span><span class="annot"><span class="annottext">Maybe HashId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Transaction Bool
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-444"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680535484"><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680535484"><span class="hs-identifier hs-var">hId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HashId -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Q.isCausalHash</span></span><span> </span><span class="annot"><span class="annottext">HashId
</span><a href="#local-6989586621680535484"><span class="hs-identifier hs-var">hId</span></a></span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getPatch"><span class="hs-identifier hs-type">getPatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PatchHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Unison.Codebase.Patch.html#Patch"><span class="hs-identifier hs-type">Patch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span id="getPatch"><span class="annot"><span class="annottext">getPatch :: PatchHash -&gt; Transaction (Maybe Patch)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getPatch"><span class="hs-identifier hs-var hs-var">getPatch</span></a></span></span><span> </span><span id="local-6989586621680535487"><span class="annot"><span class="annottext">PatchHash
</span><a href="#local-6989586621680535487"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-448"></span><span>  </span><span class="annot"><span class="annottext">MaybeT Transaction Patch -&gt; Transaction (Maybe Patch)
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-449"></span><span>    </span><span id="local-6989586621680535488"><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680535488"><span class="hs-identifier hs-var">patchId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe PatchObjectId)
-&gt; MaybeT Transaction PatchObjectId
forall (m :: * -&gt; *) a. m (Maybe a) -&gt; MaybeT m a
</span><span class="hs-identifier hs-var">MaybeT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatchHash -&gt; Transaction (Maybe PatchObjectId)
</span><span class="hs-identifier hs-var">Q.loadPatchObjectIdForPrimaryHash</span></span><span> </span><span class="annot"><span class="annottext">PatchHash
</span><a href="#local-6989586621680535487"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-450"></span><span>    </span><span id="local-6989586621680535491"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680535491"><span class="hs-identifier hs-var">patch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction Patch -&gt; MaybeT Transaction Patch
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; MaybeT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatchObjectId -&gt; Transaction Patch
</span><span class="hs-identifier hs-var">Ops.expectPatch</span></span><span> </span><span class="annot"><span class="annottext">PatchObjectId
</span><a href="#local-6989586621680535488"><span class="hs-identifier hs-var">patchId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Patch -&gt; Patch
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#patch2to1"><span class="hs-identifier hs-var">Cv.patch2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680535491"><span class="hs-identifier hs-var">patch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span class="hs-comment">-- | Put a patch into the codebase.</span><span>
</span><span id="line-454"></span><span class="hs-comment">--</span><span>
</span><span id="line-455"></span><span class="hs-comment">-- Note that 'putBranch' may also put patches.</span><span>
</span><span id="line-456"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putPatch"><span class="hs-identifier hs-type">putPatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PatchHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.Patch.html#Patch"><span class="hs-identifier hs-type">Patch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-457"></span><span id="putPatch"><span class="annot"><span class="annottext">putPatch :: PatchHash -&gt; Patch -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putPatch"><span class="hs-identifier hs-var hs-var">putPatch</span></a></span></span><span> </span><span id="local-6989586621680535495"><span class="annot"><span class="annottext">PatchHash
</span><a href="#local-6989586621680535495"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535496"><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680535496"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-458"></span><span>  </span><span class="annot"><span class="annottext">Transaction PatchObjectId -&gt; Transaction ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(Transaction PatchObjectId -&gt; Transaction ())
-&gt; Transaction PatchObjectId -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashHandle -&gt; PatchHash -&gt; Patch -&gt; Transaction PatchObjectId
</span><span class="hs-identifier hs-var">Ops.savePatch</span></span><span> </span><span class="annot"><span class="annottext">HashHandle
</span><span class="hs-identifier hs-var">v2HashHandle</span></span><span> </span><span class="annot"><span class="annottext">PatchHash
</span><a href="#local-6989586621680535495"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Patch -&gt; Patch
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#patch1to2"><span class="hs-identifier hs-var">Cv.patch1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Patch
</span><a href="#local-6989586621680535496"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span class="annot"><span class="hs-comment">-- | Check whether the given patch exists in the codebase.</span></span><span>
</span><span id="line-461"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#patchExists"><span class="hs-identifier hs-type">patchExists</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PatchHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-462"></span><span id="patchExists"><span class="annot"><span class="annottext">patchExists :: PatchHash -&gt; Transaction Bool
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#patchExists"><span class="hs-identifier hs-var hs-var">patchExists</span></a></span></span><span> </span><span id="local-6989586621680535500"><span class="annot"><span class="annottext">PatchHash
</span><a href="#local-6989586621680535500"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe PatchObjectId -&gt; Bool)
-&gt; Transaction (Maybe PatchObjectId) -&gt; Transaction Bool
forall a b. (a -&gt; b) -&gt; Transaction a -&gt; Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Maybe PatchObjectId -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (Maybe PatchObjectId) -&gt; Transaction Bool)
-&gt; Transaction (Maybe PatchObjectId) -&gt; Transaction Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatchHash -&gt; Transaction (Maybe PatchObjectId)
</span><span class="hs-identifier hs-var">Q.loadPatchObjectIdForPrimaryHash</span></span><span> </span><span class="annot"><span class="annottext">PatchHash
</span><a href="#local-6989586621680535500"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#dependentsImpl"><span class="hs-identifier hs-type">dependentsImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Q.DependentsSelector</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span id="dependentsImpl"><span class="annot"><span class="annottext">dependentsImpl :: DependentsSelector -&gt; TypeReference -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#dependentsImpl"><span class="hs-identifier hs-var hs-var">dependentsImpl</span></a></span></span><span> </span><span id="local-6989586621680535503"><span class="annot"><span class="annottext">DependentsSelector
</span><a href="#local-6989586621680535503"><span class="hs-identifier hs-var">selector</span></a></span></span><span> </span><span id="local-6989586621680535504"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535504"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-466"></span><span>  </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; Set Id -&gt; Set Id
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid2to1"><span class="hs-identifier hs-var">Cv.referenceid2to1</span></a></span><span>
</span><span id="line-467"></span><span>    </span><span class="annot"><span class="annottext">(Set Id -&gt; Set Id) -&gt; Transaction (Set Id) -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">DependentsSelector -&gt; TypeReference -&gt; Transaction (Set Id)
</span><span class="hs-identifier hs-var">Ops.dependents</span></span><span> </span><span class="annot"><span class="annottext">DependentsSelector
</span><a href="#local-6989586621680535503"><span class="hs-identifier hs-var">selector</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeReference -&gt; TypeReference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535504"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#dependentsOfComponentImpl"><span class="hs-identifier hs-type">dependentsOfComponentImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span id="dependentsOfComponentImpl"><span class="annot"><span class="annottext">dependentsOfComponentImpl :: Hash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#dependentsOfComponentImpl"><span class="hs-identifier hs-var hs-var">dependentsOfComponentImpl</span></a></span></span><span> </span><span id="local-6989586621680535508"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535508"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-471"></span><span>  </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; Set Id -&gt; Set Id
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid2to1"><span class="hs-identifier hs-var">Cv.referenceid2to1</span></a></span><span> </span><span class="annot"><span class="annottext">(Set Id -&gt; Set Id) -&gt; Transaction (Set Id) -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction (Set Id)
</span><span class="hs-identifier hs-var">Ops.dependentsOfComponent</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535508"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span class="hs-comment">-- | @watches k@ returns all of the references @r@ that were previously put by a @putWatch k r t@. @t@ can be</span><span>
</span><span id="line-474"></span><span class="hs-comment">-- retrieved by @getWatch k r@.</span><span>
</span><span id="line-475"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#watches"><span class="hs-identifier hs-type">watches</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UF.WatchKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">]</span><span>
</span><span id="line-476"></span><span id="watches"><span class="annot"><span class="annottext">watches :: WatchKind -&gt; Transaction [Id]
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#watches"><span class="hs-identifier hs-var hs-var">watches</span></a></span></span><span> </span><span id="local-6989586621680535511"><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680535511"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-477"></span><span>  </span><span class="annot"><span class="annottext">WatchKind -&gt; Transaction [Id]
</span><span class="hs-identifier hs-var">Ops.listWatches</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; WatchKind
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#watchKind1to2"><span class="hs-identifier hs-var">Cv.watchKind1to2</span></a></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680535511"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Transaction [Id] -&gt; ([Id] -&gt; [Id]) -&gt; Transaction [Id]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid2to1"><span class="hs-identifier hs-var">Cv.referenceid2to1</span></a></span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#getWatch"><span class="hs-identifier hs-type">getWatch</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-480"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span></span><span>
</span><span id="line-481"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-482"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">UF.WatchKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-483"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-484"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span id="getWatch"><span class="annot"><span class="annottext">getWatch :: (TypeReference -&gt; Transaction ConstructorType)
-&gt; WatchKind -&gt; Id -&gt; Transaction (Maybe (Term Symbol Ann))
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#getWatch"><span class="hs-identifier hs-var hs-var">getWatch</span></a></span></span><span> </span><span id="local-6989586621680535515"><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535515"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span id="local-6989586621680535516"><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680535516"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621680535517"><span class="annot"><span class="annottext">r :: Id
</span><a href="#local-6989586621680535517"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680535518"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535518"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535519"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535519"><span class="hs-identifier hs-var">_i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-486"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">WatchKind -&gt; [WatchKind] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">elem</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680535516"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">[WatchKind]
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#standardWatchKinds"><span class="hs-identifier hs-var">standardWatchKinds</span></a></span><span>
</span><span id="line-487"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">MaybeT Transaction (Term Symbol Ann)
-&gt; Transaction (Maybe (Term Symbol Ann))
forall (m :: * -&gt; *) a. MaybeT m a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">runMaybeT</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-488"></span><span>      </span><span id="local-6989586621680535522"><span class="annot"><span class="annottext">Term Symbol
</span><a href="#local-6989586621680535522"><span class="hs-identifier hs-var">watch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WatchKind -&gt; Id -&gt; MaybeT Transaction (Term Symbol)
</span><span class="hs-identifier hs-var">Ops.loadWatch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; WatchKind
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#watchKind1to2"><span class="hs-identifier hs-var">Cv.watchKind1to2</span></a></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680535516"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid1to2"><span class="hs-identifier hs-var">Cv.referenceid1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680535517"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-489"></span><span>      </span><span class="annot"><span class="annottext">Transaction (Term Symbol Ann)
-&gt; MaybeT Transaction (Term Symbol Ann)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; MaybeT m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash
-&gt; (TypeReference -&gt; Transaction ConstructorType)
-&gt; Term Symbol
-&gt; Transaction (Term Symbol Ann)
forall (m :: * -&gt; *).
Monad m =&gt;
Hash
-&gt; (TypeReference -&gt; m ConstructorType)
-&gt; Term Symbol
-&gt; m (Term Symbol Ann)
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#term2to1"><span class="hs-identifier hs-var">Cv.term2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535518"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535515"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol
</span><a href="#local-6989586621680535522"><span class="hs-identifier hs-var">watch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (Term Symbol Ann) -&gt; Transaction (Maybe (Term Symbol Ann))
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Term Symbol Ann)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-491"></span><span>
</span><span id="line-492"></span><span class="hs-comment">-- | @putWatch k r t@ puts a watch of kind @k@, with hash-of-expression @r@ and decompiled result @t@ into the</span><span>
</span><span id="line-493"></span><span class="hs-comment">-- codebase.</span><span>
</span><span id="line-494"></span><span class="hs-comment">--</span><span>
</span><span id="line-495"></span><span class="hs-comment">-- For example, in the watch expression below, @k@ is 'WK.Regular', @r@ is the hash of @x@, and @t@ is @7@.</span><span>
</span><span id="line-496"></span><span class="hs-comment">--</span><span>
</span><span id="line-497"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-498"></span><span class="hs-comment">-- &gt; x = 3 + 4</span><span>
</span><span id="line-499"></span><span class="hs-comment">--   &#10729;</span><span>
</span><span id="line-500"></span><span class="hs-comment">--   7</span><span>
</span><span id="line-501"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-502"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#putWatch"><span class="hs-identifier hs-type">putWatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UF.WatchKind</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-503"></span><span id="putWatch"><span class="annot"><span class="annottext">putWatch :: WatchKind -&gt; Id -&gt; Term Symbol Ann -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putWatch"><span class="hs-identifier hs-var hs-var">putWatch</span></a></span></span><span> </span><span id="local-6989586621680535526"><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680535526"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621680535527"><span class="annot"><span class="annottext">r :: Id
</span><a href="#local-6989586621680535527"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span id="local-6989586621680535528"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535528"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621680535529"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535529"><span class="hs-identifier hs-var">_i</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680535530"><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680535530"><span class="hs-identifier hs-var">tm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-504"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Transaction () -&gt; Transaction ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; [WatchKind] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">elem</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680535526"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">[WatchKind]
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#standardWatchKinds"><span class="hs-identifier hs-var">standardWatchKinds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-505"></span><span>    </span><span class="annot"><span class="annottext">WatchKind -&gt; Id -&gt; Term Symbol -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Ops.saveWatch</span></span><span>
</span><span id="line-506"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; WatchKind
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#watchKind1to2"><span class="hs-identifier hs-var">Cv.watchKind1to2</span></a></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><a href="#local-6989586621680535526"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid1to2"><span class="hs-identifier hs-var">Cv.referenceid1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680535527"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-508"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Term Symbol Ann -&gt; Term Symbol
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#term1to2"><span class="hs-identifier hs-var">Cv.term1to2</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535528"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><a href="#local-6989586621680535530"><span class="hs-identifier hs-var">tm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span>
</span><span id="line-510"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#standardWatchKinds"><span class="hs-identifier hs-type">standardWatchKinds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">UF.WatchKind</span></span><span class="hs-special">]</span><span>
</span><span id="line-511"></span><span id="standardWatchKinds"><span class="annot"><span class="annottext">standardWatchKinds :: [WatchKind]
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#standardWatchKinds"><span class="hs-identifier hs-var hs-var">standardWatchKinds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">WatchKind
forall a. (Eq a, IsString a) =&gt; a
</span><span class="hs-identifier hs-var">UF.RegularWatch</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">WatchKind
forall a. (Eq a, IsString a) =&gt; a
</span><span class="hs-identifier hs-var">UF.TestWatch</span></span><span class="hs-special">]</span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#termsOfTypeImpl"><span class="hs-identifier hs-type">termsOfTypeImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-514"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span></span><span>
</span><span id="line-515"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-516"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-517"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span id="termsOfTypeImpl"><span class="annot"><span class="annottext">termsOfTypeImpl :: (TypeReference -&gt; Transaction ConstructorType)
-&gt; TypeReference -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#termsOfTypeImpl"><span class="hs-identifier hs-var hs-var">termsOfTypeImpl</span></a></span></span><span> </span><span id="local-6989586621680535537"><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535537"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span id="local-6989586621680535538"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535538"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-519"></span><span>  </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction (Set Id)
</span><span class="hs-identifier hs-var">Ops.termsHavingType</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeReference -&gt; TypeReference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535538"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-520"></span><span>    </span><span class="annot"><span class="annottext">Transaction (Set Id)
-&gt; (Set Id -&gt; Transaction (Set Id)) -&gt; Transaction (Set Id)
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Transaction Id) -&gt; Set Id -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) b a.
(Applicative f, Ord b) =&gt;
(a -&gt; f b) -&gt; Set a -&gt; f (Set b)
</span><span class="hs-identifier hs-var">Set.traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeReference -&gt; Transaction ConstructorType)
-&gt; Id -&gt; Transaction Id
forall (m :: * -&gt; *).
Applicative m =&gt;
(TypeReference -&gt; m ConstructorType) -&gt; Id -&gt; m Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referentid2to1"><span class="hs-identifier hs-var">Cv.referentid2to1</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535537"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span>
</span><span id="line-522"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#termsMentioningTypeImpl"><span class="hs-identifier hs-type">termsMentioningTypeImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-523"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span></span><span>
</span><span id="line-524"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-525"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-526"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-527"></span><span id="termsMentioningTypeImpl"><span class="annot"><span class="annottext">termsMentioningTypeImpl :: (TypeReference -&gt; Transaction ConstructorType)
-&gt; TypeReference -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#termsMentioningTypeImpl"><span class="hs-identifier hs-var hs-var">termsMentioningTypeImpl</span></a></span></span><span> </span><span id="local-6989586621680535543"><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535543"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span id="local-6989586621680535544"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535544"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-528"></span><span>  </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction (Set Id)
</span><span class="hs-identifier hs-var">Ops.termsMentioningType</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeReference -&gt; TypeReference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535544"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>    </span><span class="annot"><span class="annottext">Transaction (Set Id)
-&gt; (Set Id -&gt; Transaction (Set Id)) -&gt; Transaction (Set Id)
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Transaction Id) -&gt; Set Id -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) b a.
(Applicative f, Ord b) =&gt;
(a -&gt; f b) -&gt; Set a -&gt; f (Set b)
</span><span class="hs-identifier hs-var">Set.traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeReference -&gt; Transaction ConstructorType)
-&gt; Id -&gt; Transaction Id
forall (m :: * -&gt; *).
Applicative m =&gt;
(TypeReference -&gt; m ConstructorType) -&gt; Id -&gt; m Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referentid2to1"><span class="hs-identifier hs-var">Cv.referentid2to1</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535543"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-530"></span><span>
</span><span id="line-531"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#filterReferencesHavingTypeImpl"><span class="hs-identifier hs-type">filterReferencesHavingTypeImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-532"></span><span id="filterReferencesHavingTypeImpl"><span class="annot"><span class="annottext">filterReferencesHavingTypeImpl :: TypeReference -&gt; Set Id -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#filterReferencesHavingTypeImpl"><span class="hs-identifier hs-var hs-var">filterReferencesHavingTypeImpl</span></a></span></span><span> </span><span id="local-6989586621680535547"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535547"><span class="hs-identifier hs-var">typRef</span></a></span></span><span> </span><span id="local-6989586621680535548"><span class="annot"><span class="annottext">Set Id
</span><a href="#local-6989586621680535548"><span class="hs-identifier hs-var">termRefs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-533"></span><span>  </span><span class="annot"><span class="annottext">TypeReference -&gt; [Id] -&gt; Transaction [Id]
</span><span class="hs-identifier hs-var">Ops.filterTermsByReferenceHavingType</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeReference -&gt; TypeReference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535547"><span class="hs-identifier hs-var">typRef</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid1to2"><span class="hs-identifier hs-var">Cv.referenceid1to2</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [Id] -&gt; [Id]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set Id -&gt; [Id]
forall a. Set a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">Set Id
</span><a href="#local-6989586621680535548"><span class="hs-identifier hs-var">termRefs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>    </span><span class="annot"><span class="annottext">Transaction [Id] -&gt; ([Id] -&gt; [Id]) -&gt; Transaction [Id]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [Id] -&gt; [Id]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid2to1"><span class="hs-identifier hs-var">Cv.referenceid2to1</span></a></span><span>
</span><span id="line-535"></span><span>    </span><span class="annot"><span class="annottext">Transaction [Id] -&gt; ([Id] -&gt; Set Id) -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Set Id
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#filterReferentsHavingTypeImpl"><span class="hs-identifier hs-type">filterReferentsHavingTypeImpl</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-538"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span></span><span>
</span><span id="line-539"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-540"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-541"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent.Id</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-542"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-543"></span><span id="filterReferentsHavingTypeImpl"><span class="annot"><span class="annottext">filterReferentsHavingTypeImpl :: (TypeReference -&gt; Transaction ConstructorType)
-&gt; TypeReference -&gt; Set Id -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#filterReferentsHavingTypeImpl"><span class="hs-identifier hs-var hs-var">filterReferentsHavingTypeImpl</span></a></span></span><span> </span><span id="local-6989586621680535551"><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535551"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span id="local-6989586621680535552"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535552"><span class="hs-identifier hs-var">typRef</span></a></span></span><span> </span><span id="local-6989586621680535553"><span class="annot"><span class="annottext">Set Id
</span><a href="#local-6989586621680535553"><span class="hs-identifier hs-var">termRefs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-544"></span><span>  </span><span class="annot"><span class="annottext">TypeReference -&gt; [Id] -&gt; Transaction [Id]
</span><span class="hs-identifier hs-var">Ops.filterTermsByReferentHavingType</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeReference -&gt; TypeReference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference1to2"><span class="hs-identifier hs-var">Cv.reference1to2</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535552"><span class="hs-identifier hs-var">typRef</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referentid1to2"><span class="hs-identifier hs-var">Cv.referentid1to2</span></a></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; [Id] -&gt; [Id]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set Id -&gt; [Id]
forall a. Set a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">Set Id
</span><a href="#local-6989586621680535553"><span class="hs-identifier hs-var">termRefs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>    </span><span class="annot"><span class="annottext">Transaction [Id] -&gt; ([Id] -&gt; Transaction [Id]) -&gt; Transaction [Id]
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Transaction Id) -&gt; [Id] -&gt; Transaction [Id]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeReference -&gt; Transaction ConstructorType)
-&gt; Id -&gt; Transaction Id
forall (m :: * -&gt; *).
Applicative m =&gt;
(TypeReference -&gt; m ConstructorType) -&gt; Id -&gt; m Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referentid2to1"><span class="hs-identifier hs-var">Cv.referentid2to1</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535551"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-546"></span><span>    </span><span class="annot"><span class="annottext">Transaction [Id] -&gt; ([Id] -&gt; Set Id) -&gt; Transaction (Set Id)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Set Id
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span>
</span><span id="line-547"></span><span>
</span><span id="line-548"></span><span class="annot"><span class="hs-comment">-- | The number of base32 characters needed to distinguish any two references in the codebase.</span></span><span>
</span><span id="line-549"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#hashLength"><span class="hs-identifier hs-type">hashLength</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-550"></span><span id="hashLength"><span class="annot"><span class="annottext">hashLength :: Transaction Int
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#hashLength"><span class="hs-identifier hs-var hs-var">hashLength</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Transaction Int
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>
</span><span id="line-551"></span><span>
</span><span id="line-552"></span><span class="annot"><span class="hs-comment">-- | The number of base32 characters needed to distinguish any two branch in the codebase.</span></span><span>
</span><span id="line-553"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#branchHashLength"><span class="hs-identifier hs-type">branchHashLength</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-554"></span><span id="branchHashLength"><span class="annot"><span class="annottext">branchHashLength :: Transaction Int
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#branchHashLength"><span class="hs-identifier hs-var hs-var">branchHashLength</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Transaction Int
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span>
</span><span id="line-555"></span><span>
</span><span id="line-556"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#defnReferencesByPrefix"><span class="hs-identifier hs-type">defnReferencesByPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">OT.ObjectType</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ShortHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span id="defnReferencesByPrefix"><span class="annot"><span class="annottext">defnReferencesByPrefix :: ObjectType -&gt; ShortHash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#defnReferencesByPrefix"><span class="hs-identifier hs-var hs-var">defnReferencesByPrefix</span></a></span></span><span> </span><span class="annot"><span class="annottext">ObjectType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ShortHash.Builtin</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set Id -&gt; Transaction (Set Id)
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Set Id
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-558"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#defnReferencesByPrefix"><span class="hs-identifier hs-var">defnReferencesByPrefix</span></a></span><span> </span><span id="local-6989586621680535561"><span class="annot"><span class="annottext">ObjectType
</span><a href="#local-6989586621680535561"><span class="hs-identifier hs-var">ot</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ShortHash.ShortHash</span></span><span> </span><span id="local-6989586621680535563"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680535563"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span id="local-6989586621680535564"><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535564"><span class="hs-identifier hs-var">cycle</span></a></span></span><span> </span><span id="local-6989586621680535565"><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535565"><span class="hs-identifier hs-var">_cid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-559"></span><span>  </span><span id="local-6989586621680535566"><span class="annot"><span class="annottext">Set Id
</span><a href="#local-6989586621680535566"><span class="hs-identifier hs-var">refs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-560"></span><span>    </span><span class="annot"><span class="annottext">ObjectType
-&gt; Text -&gt; Maybe ConstructorId -&gt; Transaction [Id' ObjectId]
</span><span class="hs-identifier hs-var">Ops.componentReferencesByPrefix</span></span><span> </span><span class="annot"><span class="annottext">ObjectType
</span><a href="#local-6989586621680535561"><span class="hs-identifier hs-var">ot</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680535563"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535564"><span class="hs-identifier hs-var">cycle</span></a></span><span>
</span><span id="line-561"></span><span>      </span><span class="annot"><span class="annottext">Transaction [Id' ObjectId]
-&gt; ([Id' ObjectId] -&gt; Transaction [Id]) -&gt; Transaction [Id]
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Id' ObjectId -&gt; Transaction Id)
-&gt; [Id' ObjectId] -&gt; Transaction [Id]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ObjectId -&gt; Transaction Hash) -&gt; Id' ObjectId -&gt; Transaction Id
forall h h' (f :: * -&gt; *).
Functor f =&gt;
(h -&gt; f h') -&gt; Id' h -&gt; f (Id' h')
</span><span class="hs-identifier hs-var">C.Reference.idH</span></span><span> </span><span class="annot"><span class="annottext">ObjectId -&gt; Transaction Hash
</span><span class="hs-identifier hs-var">Q.expectPrimaryHashByObjectId</span></span><span class="hs-special">)</span><span>
</span><span id="line-562"></span><span>      </span><span class="annot"><span class="annottext">Transaction [Id]
-&gt; ([Id] -&gt; Transaction (Set Id)) -&gt; Transaction (Set Id)
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Set Id -&gt; Transaction (Set Id)
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Set Id -&gt; Transaction (Set Id))
-&gt; ([Id] -&gt; Set Id) -&gt; [Id] -&gt; Transaction (Set Id)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Set Id
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span>
</span><span id="line-563"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Id) -&gt; Set Id -&gt; Set Id
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referenceid2to1"><span class="hs-identifier hs-var">Cv.referenceid2to1</span></a></span><span> </span><span class="annot"><span class="annottext">Set Id
</span><a href="#local-6989586621680535566"><span class="hs-identifier hs-var">refs</span></a></span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#termReferencesByPrefix"><span class="hs-identifier hs-type">termReferencesByPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ShortHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-566"></span><span id="termReferencesByPrefix"><span class="annot"><span class="annottext">termReferencesByPrefix :: ShortHash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#termReferencesByPrefix"><span class="hs-identifier hs-var hs-var">termReferencesByPrefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ObjectType -&gt; ShortHash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#defnReferencesByPrefix"><span class="hs-identifier hs-var">defnReferencesByPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">ObjectType
</span><span class="hs-identifier hs-var">OT.TermComponent</span></span><span>
</span><span id="line-567"></span><span>
</span><span id="line-568"></span><span class="annot"><span class="hs-comment">-- | Get the set of type declarations whose hash matches the given prefix.</span></span><span>
</span><span id="line-569"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#typeReferencesByPrefix"><span class="hs-identifier hs-type">typeReferencesByPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ShortHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span id="typeReferencesByPrefix"><span class="annot"><span class="annottext">typeReferencesByPrefix :: ShortHash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#typeReferencesByPrefix"><span class="hs-identifier hs-var hs-var">typeReferencesByPrefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ObjectType -&gt; ShortHash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#defnReferencesByPrefix"><span class="hs-identifier hs-var">defnReferencesByPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">ObjectType
</span><span class="hs-identifier hs-var">OT.DeclComponent</span></span><span>
</span><span id="line-571"></span><span>
</span><span id="line-572"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#referentsByPrefix"><span class="hs-identifier hs-type">referentsByPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-573"></span><span>  </span><span class="annot"><span class="hs-comment">-- | A 'getDeclType'-like lookup, possibly backed by a cache.</span></span><span>
</span><span id="line-574"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-575"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ShortHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-576"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent.Id</span></span><span class="hs-special">)</span><span>
</span><span id="line-577"></span><span id="referentsByPrefix"><span class="annot"><span class="annottext">referentsByPrefix :: (TypeReference -&gt; Transaction ConstructorType)
-&gt; ShortHash -&gt; Transaction (Set Id)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#referentsByPrefix"><span class="hs-identifier hs-var hs-var">referentsByPrefix</span></a></span></span><span> </span><span id="local-6989586621680535575"><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535575"><span class="hs-identifier hs-var">_doGetDeclType</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ShortHash.Builtin</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set Id -&gt; Transaction (Set Id)
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Set Id
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-578"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#referentsByPrefix"><span class="hs-identifier hs-var">referentsByPrefix</span></a></span><span> </span><span id="local-6989586621680535576"><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535576"><span class="hs-identifier hs-var">doGetDeclType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ShortHash.ShortHash</span></span><span> </span><span id="local-6989586621680535577"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680535577"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span id="local-6989586621680535578"><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535578"><span class="hs-identifier hs-var">cycle</span></a></span></span><span> </span><span id="local-6989586621680535579"><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535579"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-579"></span><span>  </span><span id="local-6989586621680535580"><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621680535580"><span class="hs-identifier hs-var">termReferents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-580"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; Maybe ConstructorId -&gt; Transaction [Id]
</span><span class="hs-identifier hs-var">Ops.termReferentsByPrefix</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680535577"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535578"><span class="hs-identifier hs-var">cycle</span></a></span><span>
</span><span id="line-581"></span><span>      </span><span class="annot"><span class="annottext">Transaction [Id] -&gt; ([Id] -&gt; Transaction [Id]) -&gt; Transaction [Id]
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(Id -&gt; Transaction Id) -&gt; [Id] -&gt; Transaction [Id]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; [a] -&gt; f [b]
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeReference -&gt; Transaction ConstructorType)
-&gt; Id -&gt; Transaction Id
forall (m :: * -&gt; *).
Applicative m =&gt;
(TypeReference -&gt; m ConstructorType) -&gt; Id -&gt; m Id
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referentid2to1"><span class="hs-identifier hs-var">Cv.referentid2to1</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535576"><span class="hs-identifier hs-var">doGetDeclType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-582"></span><span>  </span><span id="local-6989586621680535582"><span class="annot"><span class="annottext">[(Hash, ConstructorId, DeclType, [ConstructorId])]
</span><a href="#local-6989586621680535582"><span class="hs-identifier hs-var">declReferents'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; Maybe ConstructorId
-&gt; Maybe ConstructorId
-&gt; Transaction [(Hash, ConstructorId, DeclType, [ConstructorId])]
</span><span class="hs-identifier hs-var">Ops.declReferentsByPrefix</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680535577"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535578"><span class="hs-identifier hs-var">cycle</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorId
</span><a href="#local-6989586621680535579"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-583"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535584"><span class="annot"><span class="annottext">declReferents :: [Id]
</span><a href="#local-6989586621680535584"><span class="hs-identifier hs-var hs-var">declReferents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-584"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ConstructorReferenceId -&gt; ConstructorType -&gt; Id
</span><span class="hs-identifier hs-var">Referent.ConId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id -&gt; ConstructorId -&gt; ConstructorReferenceId
forall r. r -&gt; ConstructorId -&gt; GConstructorReference r
</span><span class="hs-identifier hs-var">ConstructorReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; ConstructorId -&gt; Id
forall h. h -&gt; ConstructorId -&gt; Id' h
</span><span class="hs-identifier hs-var">Reference.Id</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535587"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535588"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstructorId -&gt; ConstructorId
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535589"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DeclType -&gt; ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#decltype2to1"><span class="hs-identifier hs-var">Cv.decltype2to1</span></a></span><span> </span><span class="annot"><span class="annottext">DeclType
</span><a href="#local-6989586621680535590"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680535587"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621680535587"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535588"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535588"><span class="hs-identifier hs-var">pos</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535590"><span class="annot"><span class="annottext">DeclType
</span><a href="#local-6989586621680535590"><span class="hs-identifier hs-var">ct</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535591"><span class="annot"><span class="annottext">[ConstructorId]
</span><a href="#local-6989586621680535591"><span class="hs-identifier hs-var">cids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Hash, ConstructorId, DeclType, [ConstructorId])]
</span><a href="#local-6989586621680535582"><span class="hs-identifier hs-var">declReferents'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-586"></span><span>            </span><span id="local-6989586621680535589"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535589"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ConstructorId]
</span><a href="#local-6989586621680535591"><span class="hs-identifier hs-var">cids</span></a></span><span>
</span><span id="line-587"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-588"></span><span>  </span><span class="annot"><span class="annottext">Set Id -&gt; Transaction (Set Id)
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Set Id -&gt; Transaction (Set Id))
-&gt; ([Id] -&gt; Set Id) -&gt; [Id] -&gt; Transaction (Set Id)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; Set Id
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Id] -&gt; Transaction (Set Id)) -&gt; [Id] -&gt; Transaction (Set Id)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621680535580"><span class="hs-identifier hs-var">termReferents</span></a></span><span> </span><span class="annot"><span class="annottext">[Id] -&gt; [Id] -&gt; [Id]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Id]
</span><a href="#local-6989586621680535584"><span class="hs-identifier hs-var">declReferents</span></a></span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span class="annot"><span class="hs-comment">-- | Get the set of branches whose hash matches the given prefix.</span></span><span>
</span><span id="line-591"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#causalHashesByPrefix"><span class="hs-identifier hs-type">causalHashesByPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Codebase.ShortCausalHash.html#ShortCausalHash"><span class="hs-identifier hs-type">ShortCausalHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span class="hs-special">)</span><span>
</span><span id="line-592"></span><span id="causalHashesByPrefix"><span class="annot"><span class="annottext">causalHashesByPrefix :: ShortCausalHash -&gt; Transaction (Set CausalHash)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#causalHashesByPrefix"><span class="hs-identifier hs-var hs-var">causalHashesByPrefix</span></a></span></span><span> </span><span id="local-6989586621680535593"><span class="annot"><span class="annottext">ShortCausalHash
</span><a href="#local-6989586621680535593"><span class="hs-identifier hs-var">sh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-593"></span><span>  </span><span class="hs-comment">-- given that a Branch is shallow, it's really `CausalHash` that you'd</span><span>
</span><span id="line-594"></span><span>  </span><span class="hs-comment">-- refer to to specify a full namespace w/ history.</span><span>
</span><span id="line-595"></span><span>  </span><span class="hs-comment">-- but do we want to be able to refer to a namespace without its history?</span><span>
</span><span id="line-596"></span><span>  </span><span class="annot"><span class="annottext">ShortCausalHash -&gt; Transaction (Set CausalHash)
</span><span class="hs-identifier hs-var">Ops.causalHashesByPrefix</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShortCausalHash -&gt; ShortCausalHash
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#sch1to2"><span class="hs-identifier hs-var">Cv.sch1to2</span></a></span><span> </span><span class="annot"><span class="annottext">ShortCausalHash
</span><a href="#local-6989586621680535593"><span class="hs-identifier hs-var">sh</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-597"></span><span>
</span><span id="line-598"></span><span class="hs-comment">-- well one or the other. :zany_face: the thinking being that they wouldn't hash-collide</span><span>
</span><span id="line-599"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#termExists"><span class="hs-identifier hs-type">termExists</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#declExists"><span class="hs-identifier hs-type">declExists</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-600"></span><span id="termExists"><span class="annot"><span class="annottext">termExists :: Hash -&gt; Transaction Bool
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#termExists"><span class="hs-identifier hs-var hs-var">termExists</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe ObjectId -&gt; Bool)
-&gt; Transaction (Maybe ObjectId) -&gt; Transaction Bool
forall a b. (a -&gt; b) -&gt; Transaction a -&gt; Transaction b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Maybe ObjectId -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Transaction (Maybe ObjectId) -&gt; Transaction Bool)
-&gt; (Hash -&gt; Transaction (Maybe ObjectId))
-&gt; Hash
-&gt; Transaction Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction (Maybe ObjectId)
</span><span class="hs-identifier hs-var">Q.loadObjectIdForPrimaryHash</span></span><span>
</span><span id="line-601"></span><span id="declExists"><span class="annot"><span class="annottext">declExists :: Hash -&gt; Transaction Bool
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#declExists"><span class="hs-identifier hs-var hs-var">declExists</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Transaction Bool
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#termExists"><span class="hs-identifier hs-var">termExists</span></a></span><span>
</span><span id="line-602"></span><span>
</span><span id="line-603"></span><span class="hs-comment">-- `before b1 b2` is undefined if `b2` not in the codebase</span><span>
</span><span id="line-604"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#before"><span class="hs-identifier hs-type">before</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-605"></span><span id="before"><span class="annot"><span class="annottext">before :: CausalHash -&gt; CausalHash -&gt; Transaction Bool
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#before"><span class="hs-identifier hs-var hs-var">before</span></a></span></span><span> </span><span id="local-6989586621680535600"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680535600"><span class="hs-identifier hs-var">h1</span></a></span></span><span> </span><span id="local-6989586621680535601"><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680535601"><span class="hs-identifier hs-var">h2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-606"></span><span>  </span><span class="annot"><span class="annottext">Maybe Bool -&gt; Bool
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Bool -&gt; Bool)
-&gt; Transaction (Maybe Bool) -&gt; Transaction Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">CausalHash -&gt; CausalHash -&gt; Transaction (Maybe Bool)
</span><span class="hs-identifier hs-var">Ops.before</span></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680535600"><span class="hs-identifier hs-var">h1</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680535601"><span class="hs-identifier hs-var">h2</span></a></span><span>
</span><span id="line-607"></span><span>
</span><span id="line-608"></span><span class="hs-comment">-- | Construct a 'ScopedNames' which can produce names which are relative to the provided</span><span>
</span><span id="line-609"></span><span class="hs-comment">-- Path.</span><span>
</span><span id="line-610"></span><span class="hs-comment">--</span><span>
</span><span id="line-611"></span><span class="hs-comment">-- NOTE: this method requires an up-to-date name lookup index</span><span>
</span><span id="line-612"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#namesAtPath"><span class="hs-identifier hs-type">namesAtPath</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-613"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">BranchHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-614"></span><span>  </span><span class="hs-comment">-- Include names from the project which contains this path.</span><span>
</span><span id="line-615"></span><span>  </span><span class="annot"><a href="Unison.Codebase.Path.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-616"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Names</span></span><span>
</span><span id="line-617"></span><span id="namesAtPath"><span class="annot"><span class="annottext">namesAtPath :: BranchHash -&gt; Path -&gt; Transaction Names
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#namesAtPath"><span class="hs-identifier hs-var hs-var">namesAtPath</span></a></span></span><span> </span><span id="local-6989586621680535604"><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535604"><span class="hs-identifier hs-var">bh</span></a></span></span><span> </span><span id="local-6989586621680535605"><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680535605"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-618"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535606"><span class="annot"><span class="annottext">namesRoot :: PathSegments
</span><a href="#local-6989586621680535606"><span class="hs-identifier hs-var hs-var">namesRoot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; PathSegments
</span><span class="hs-identifier hs-var">PathSegments</span></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; PathSegments)
-&gt; (Path -&gt; [Text]) -&gt; Path -&gt; PathSegments
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[NameSegment] -&gt; [Text]
forall a b. Coercible a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">([NameSegment] -&gt; [Text])
-&gt; (Path -&gt; [NameSegment]) -&gt; Path -&gt; [Text]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Path -&gt; [NameSegment]
</span><a href="Unison.Codebase.Path.html#toList"><span class="hs-identifier hs-var">Path.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(Path -&gt; PathSegments) -&gt; Path -&gt; PathSegments
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680535605"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-619"></span><span>  </span><span id="local-6989586621680535609"><span class="annot"><span class="annottext">namesPerspective :: NamesPerspective
</span><a href="#local-6989586621680535609"><span class="hs-identifier hs-var">namesPerspective</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">Ops.NamesPerspective</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680535611"><span class="annot"><span class="annottext">PathSegments
relativePerspective :: PathSegments
$sel:relativePerspective:NamesPerspective :: NamesPerspective -&gt; PathSegments
</span><a href="#local-6989586621680535611"><span class="hs-identifier hs-var hs-var">relativePerspective</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BranchHash -&gt; PathSegments -&gt; Transaction NamesPerspective
</span><span class="hs-identifier hs-var">Ops.namesPerspectiveForRootAndPath</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535604"><span class="hs-identifier hs-var">bh</span></a></span><span> </span><span class="annot"><span class="annottext">PathSegments
</span><a href="#local-6989586621680535606"><span class="hs-identifier hs-var">namesRoot</span></a></span><span>
</span><span id="line-620"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535614"><span class="annot"><span class="annottext">relativePath :: Path
</span><a href="#local-6989586621680535614"><span class="hs-identifier hs-var hs-var">relativePath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[NameSegment] -&gt; Path
</span><a href="Unison.Codebase.Path.html#fromList"><span class="hs-identifier hs-var">Path.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([NameSegment] -&gt; Path) -&gt; [NameSegment] -&gt; Path
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PathSegments -&gt; [NameSegment]
forall a b. Coercible a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">PathSegments
</span><a href="#local-6989586621680535611"><span class="hs-identifier hs-var">relativePerspective</span></a></span><span>
</span><span id="line-621"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">NamesInPerspective</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680535617"><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)]
termNamesInPerspective :: [NamedRef (Referent, Maybe ConstructorType)]
$sel:termNamesInPerspective:NamesInPerspective :: NamesInPerspective -&gt; [NamedRef (Referent, Maybe ConstructorType)]
</span><a href="#local-6989586621680535617"><span class="hs-identifier hs-var hs-var">termNamesInPerspective</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535619"><span class="annot"><span class="annottext">[NamedRef TypeReference]
typeNamesInPerspective :: [NamedRef TypeReference]
$sel:typeNamesInPerspective:NamesInPerspective :: NamesInPerspective -&gt; [NamedRef TypeReference]
</span><a href="#local-6989586621680535619"><span class="hs-identifier hs-var hs-var">typeNamesInPerspective</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NamesPerspective -&gt; Transaction NamesInPerspective
</span><span class="hs-identifier hs-var">Ops.allNamesInPerspective</span></span><span> </span><span class="annot"><span class="annottext">NamesPerspective
</span><a href="#local-6989586621680535609"><span class="hs-identifier hs-var">namesPerspective</span></a></span><span>
</span><span id="line-622"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535622"><span class="annot"><span class="annottext">termsInPath :: [(Name, Referent)]
</span><a href="#local-6989586621680535622"><span class="hs-identifier hs-var hs-var">termsInPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)] -&gt; [(Name, Referent)]
forall {f :: * -&gt; *}.
Functor f =&gt;
f (NamedRef (Referent, Maybe ConstructorType))
-&gt; f (Name, Referent)
</span><a href="#local-6989586621680535623"><span class="hs-identifier hs-var">convertTerms</span></a></span><span> </span><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)]
</span><a href="#local-6989586621680535617"><span class="hs-identifier hs-var">termNamesInPerspective</span></a></span><span>
</span><span id="line-623"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535624"><span class="annot"><span class="annottext">typesInPath :: [(Name, TypeReference)]
</span><a href="#local-6989586621680535624"><span class="hs-identifier hs-var hs-var">typesInPath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[NamedRef TypeReference] -&gt; [(Name, TypeReference)]
forall {f :: * -&gt; *}.
Functor f =&gt;
f (NamedRef TypeReference) -&gt; f (Name, TypeReference)
</span><a href="#local-6989586621680535625"><span class="hs-identifier hs-var">convertTypes</span></a></span><span> </span><span class="annot"><span class="annottext">[NamedRef TypeReference]
</span><a href="#local-6989586621680535619"><span class="hs-identifier hs-var">typeNamesInPerspective</span></a></span><span>
</span><span id="line-624"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535626"><span class="annot"><span class="annottext">relativeScopedNames :: Names
</span><a href="#local-6989586621680535626"><span class="hs-identifier hs-var hs-var">relativeScopedNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-625"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680535614"><span class="hs-identifier hs-var">relativePath</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-626"></span><span>          </span><span class="annot"><span class="annottext">Path
</span><a href="Unison.Codebase.Path.html#Empty"><span class="hs-identifier hs-var">Path.Empty</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:terms:Names :: Relation Name Referent
</span><span class="hs-identifier hs-var">terms</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)] -&gt; Relation Name Referent
forall a b. (Ord a, Ord b) =&gt; [(a, b)] -&gt; Relation a b
</span><span class="hs-identifier hs-var">Rel.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621680535622"><span class="hs-identifier hs-var">termsInPath</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:types:Names :: Relation Name TypeReference
</span><span class="hs-identifier hs-var">types</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, TypeReference)] -&gt; Relation Name TypeReference
forall a b. (Ord a, Ord b) =&gt; [(a, b)] -&gt; Relation a b
</span><span class="hs-identifier hs-var">Rel.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, TypeReference)]
</span><a href="#local-6989586621680535624"><span class="hs-identifier hs-var">typesInPath</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-627"></span><span>          </span><span id="local-6989586621680535631"><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680535631"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-628"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535632"><span class="annot"><span class="annottext">reversedPathSegments :: [NameSegment]
</span><a href="#local-6989586621680535632"><span class="hs-identifier hs-var hs-var">reversedPathSegments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[NameSegment] -&gt; [NameSegment]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([NameSegment] -&gt; [NameSegment])
-&gt; (Path -&gt; [NameSegment]) -&gt; Path -&gt; [NameSegment]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Path -&gt; [NameSegment]
</span><a href="Unison.Codebase.Path.html#toList"><span class="hs-identifier hs-var">Path.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(Path -&gt; [NameSegment]) -&gt; Path -&gt; [NameSegment]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680535631"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-629"></span><span>                </span><span id="local-6989586621680535634"><span class="annot"><span class="annottext">relativeTerms :: [(Name, Referent)]
</span><a href="#local-6989586621680535634"><span class="hs-identifier hs-var hs-var">relativeTerms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, Referent) -&gt; Maybe (Name, Referent))
-&gt; [(Name, Referent)] -&gt; [(Name, Referent)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b.
Filterable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[NameSegment] -&gt; (Name, Referent) -&gt; Maybe (Name, Referent)
forall r. [NameSegment] -&gt; (Name, r) -&gt; Maybe (Name, r)
</span><a href="#local-6989586621680535636"><span class="hs-identifier hs-var">stripPathPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">[NameSegment]
</span><a href="#local-6989586621680535632"><span class="hs-identifier hs-var">reversedPathSegments</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621680535622"><span class="hs-identifier hs-var">termsInPath</span></a></span><span>
</span><span id="line-630"></span><span>                </span><span id="local-6989586621680535637"><span class="annot"><span class="annottext">relativeTypes :: [(Name, TypeReference)]
</span><a href="#local-6989586621680535637"><span class="hs-identifier hs-var hs-var">relativeTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, TypeReference) -&gt; Maybe (Name, TypeReference))
-&gt; [(Name, TypeReference)] -&gt; [(Name, TypeReference)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b.
Filterable f =&gt;
(a -&gt; Maybe b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[NameSegment]
-&gt; (Name, TypeReference) -&gt; Maybe (Name, TypeReference)
forall r. [NameSegment] -&gt; (Name, r) -&gt; Maybe (Name, r)
</span><a href="#local-6989586621680535636"><span class="hs-identifier hs-var">stripPathPrefix</span></a></span><span> </span><span class="annot"><span class="annottext">[NameSegment]
</span><a href="#local-6989586621680535632"><span class="hs-identifier hs-var">reversedPathSegments</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, TypeReference)]
</span><a href="#local-6989586621680535624"><span class="hs-identifier hs-var">typesInPath</span></a></span><span>
</span><span id="line-631"></span><span>             </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:terms:Names :: Relation Name Referent
</span><span class="hs-identifier hs-var">terms</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)] -&gt; Relation Name Referent
forall a b. (Ord a, Ord b) =&gt; [(a, b)] -&gt; Relation a b
</span><span class="hs-identifier hs-var">Rel.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621680535634"><span class="hs-identifier hs-var">relativeTerms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:types:Names :: Relation Name TypeReference
</span><span class="hs-identifier hs-var">types</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, TypeReference)] -&gt; Relation Name TypeReference
forall a b. (Ord a, Ord b) =&gt; [(a, b)] -&gt; Relation a b
</span><span class="hs-identifier hs-var">Rel.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, TypeReference)]
</span><a href="#local-6989586621680535637"><span class="hs-identifier hs-var">relativeTypes</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span>  </span><span class="annot"><span class="annottext">Names -&gt; Transaction Names
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; Transaction Names) -&gt; Names -&gt; Transaction Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680535626"><span class="hs-identifier hs-var">relativeScopedNames</span></a></span><span>
</span><span id="line-633"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-634"></span><span>    </span><span id="local-6989586621680535625"><span class="annot"><span class="annottext">convertTypes :: f (NamedRef TypeReference) -&gt; f (Name, TypeReference)
</span><a href="#local-6989586621680535625"><span class="hs-identifier hs-var hs-var">convertTypes</span></a></span></span><span> </span><span id="local-6989586621680535641"><span class="annot"><span class="annottext">f (NamedRef TypeReference)
</span><a href="#local-6989586621680535641"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-635"></span><span>      </span><span class="annot"><span class="annottext">f (NamedRef TypeReference)
</span><a href="#local-6989586621680535641"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">f (NamedRef TypeReference)
-&gt; (NamedRef TypeReference -&gt; (Name, TypeReference))
-&gt; f (Name, TypeReference)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.NamedRef</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680535643"><span class="annot"><span class="annottext">ReversedName
reversedSegments :: ReversedName
$sel:reversedSegments:NamedRef :: forall ref. NamedRef ref -&gt; ReversedName
</span><a href="#local-6989586621680535643"><span class="hs-identifier hs-var hs-var">reversedSegments</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535645"><span class="annot"><span class="annottext">TypeReference
ref :: TypeReference
$sel:ref:NamedRef :: forall ref. NamedRef ref -&gt; ref
</span><a href="#local-6989586621680535645"><span class="hs-identifier hs-var hs-var">ref</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-636"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty NameSegment -&gt; Name
</span><span class="hs-identifier hs-var">Name.fromReverseSegments</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReversedName -&gt; NonEmpty NameSegment
forall a b. Coercible a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">ReversedName
</span><a href="#local-6989586621680535643"><span class="hs-identifier hs-var">reversedSegments</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; TypeReference
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#reference2to1"><span class="hs-identifier hs-var">Cv.reference2to1</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535645"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-637"></span><span>    </span><span id="local-6989586621680535623"><span class="annot"><span class="annottext">convertTerms :: f (NamedRef (Referent, Maybe ConstructorType))
-&gt; f (Name, Referent)
</span><a href="#local-6989586621680535623"><span class="hs-identifier hs-var hs-var">convertTerms</span></a></span></span><span> </span><span id="local-6989586621680535654"><span class="annot"><span class="annottext">f (NamedRef (Referent, Maybe ConstructorType))
</span><a href="#local-6989586621680535654"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-638"></span><span>      </span><span class="annot"><span class="annottext">f (NamedRef (Referent, Maybe ConstructorType))
</span><a href="#local-6989586621680535654"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">f (NamedRef (Referent, Maybe ConstructorType))
-&gt; (NamedRef (Referent, Maybe ConstructorType) -&gt; (Name, Referent))
-&gt; f (Name, Referent)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.NamedRef</span></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680535655"><span class="annot"><span class="annottext">ReversedName
$sel:reversedSegments:NamedRef :: forall ref. NamedRef ref -&gt; ReversedName
reversedSegments :: ReversedName
</span><span class="hs-identifier hs-var hs-var">reversedSegments</span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:ref:NamedRef :: forall ref. NamedRef ref -&gt; ref
</span><span class="hs-identifier hs-var">ref</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680535656"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680535656"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535657"><span class="annot"><span class="annottext">Maybe ConstructorType
</span><a href="#local-6989586621680535657"><span class="hs-identifier hs-var">ct</span></a></span></span><span class="hs-special">)</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-639"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535658"><span class="annot"><span class="annottext">v1ref :: Referent
</span><a href="#local-6989586621680535658"><span class="hs-identifier hs-var hs-var">v1ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; Referent -&gt; Referent
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#referent2to1UsingCT"><span class="hs-identifier hs-var">Cv.referent2to1UsingCT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConstructorType -&gt; Maybe ConstructorType -&gt; ConstructorType
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchKind -&gt; ConstructorType
forall a. HasCallStack =&gt; WatchKind -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">WatchKind
</span><span class="hs-string">&quot;Required constructor type for constructor but it was null&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorType
</span><a href="#local-6989586621680535657"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680535656"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-640"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty NameSegment -&gt; Name
</span><span class="hs-identifier hs-var">Name.fromReverseSegments</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReversedName -&gt; NonEmpty NameSegment
forall a b. Coercible a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">ReversedName
</span><a href="#local-6989586621680535655"><span class="hs-identifier hs-var">reversedSegments</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680535658"><span class="hs-identifier hs-var">v1ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-641"></span><span>
</span><span id="line-642"></span><span>    </span><span class="hs-comment">-- If the given prefix matches the given name, the prefix is stripped and it's collected</span><span>
</span><span id="line-643"></span><span>    </span><span class="hs-comment">-- on the left, otherwise it's left as-is and collected on the right.</span><span>
</span><span id="line-644"></span><span>    </span><span class="hs-comment">-- &gt;&gt;&gt; stripPathPrefix [&quot;b&quot;, &quot;a&quot;] (&quot;a.b.c&quot;, ())</span><span>
</span><span id="line-645"></span><span>    </span><span class="hs-comment">-- ([(c,())])</span><span>
</span><span id="line-646"></span><span>    </span><span id="local-6989586621680534608"><span class="annot"><a href="#local-6989586621680535636"><span class="hs-identifier hs-type">stripPathPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">NameSegment</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680534608"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680534608"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-647"></span><span>    </span><span id="local-6989586621680535636"><span class="annot"><span class="annottext">stripPathPrefix :: forall r. [NameSegment] -&gt; (Name, r) -&gt; Maybe (Name, r)
</span><a href="#local-6989586621680535636"><span class="hs-identifier hs-var hs-var">stripPathPrefix</span></a></span></span><span> </span><span id="local-6989586621680535660"><span class="annot"><span class="annottext">[NameSegment]
</span><a href="#local-6989586621680535660"><span class="hs-identifier hs-var">reversedPathSegments</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680535661"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680535661"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535662"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621680535662"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-648"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [NameSegment] -&gt; Maybe Name
</span><span class="hs-identifier hs-var">Name.stripReversedPrefix</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680535661"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[NameSegment]
</span><a href="#local-6989586621680535660"><span class="hs-identifier hs-var">reversedPathSegments</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-649"></span><span>        </span><span class="annot"><span class="annottext">Maybe Name
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Name, r)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-650"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680535664"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680535664"><span class="hs-identifier hs-var">stripped</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Name, r) -&gt; Maybe (Name, r)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name
</span><span class="hs-identifier hs-var">Name.makeRelative</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680535664"><span class="hs-identifier hs-var">stripped</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621680535662"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-651"></span><span>
</span><span id="line-652"></span><span class="annot"><span class="hs-comment">-- | Add an index for the provided branch hash if one doesn't already exist.</span></span><span>
</span><span id="line-653"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#ensureNameLookupForBranchHash"><span class="hs-identifier hs-type">ensureNameLookupForBranchHash</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-654"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-655"></span><span>  </span><span class="hs-comment">-- | An optional branch which we may already have an index for.</span><span>
</span><span id="line-656"></span><span>  </span><span class="hs-comment">-- This should be a branch which is relatively similar to the branch we're creating a name</span><span>
</span><span id="line-657"></span><span>  </span><span class="hs-comment">-- lookup for, e.g. a recent ancestor of the new branch. The more similar it is, the faster</span><span>
</span><span id="line-658"></span><span>  </span><span class="hs-comment">-- the less work we'll need to do.</span><span>
</span><span id="line-659"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">BranchHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-660"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">BranchHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-661"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-662"></span><span id="ensureNameLookupForBranchHash"><span class="annot"><span class="annottext">ensureNameLookupForBranchHash :: (TypeReference -&gt; Transaction ConstructorType)
-&gt; Maybe BranchHash -&gt; BranchHash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#ensureNameLookupForBranchHash"><span class="hs-identifier hs-var hs-var">ensureNameLookupForBranchHash</span></a></span></span><span> </span><span id="local-6989586621680535667"><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535667"><span class="hs-identifier hs-var">getDeclType</span></a></span></span><span> </span><span id="local-6989586621680535668"><span class="annot"><span class="annottext">Maybe BranchHash
</span><a href="#local-6989586621680535668"><span class="hs-identifier hs-var">mayFromBranchHash</span></a></span></span><span> </span><span id="local-6989586621680535669"><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535669"><span class="hs-identifier hs-var">toBranchHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-663"></span><span>  </span><span class="annot"><span class="annottext">BranchHash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.checkBranchHashNameLookupExists</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535669"><span class="hs-identifier hs-var">toBranchHash</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction Bool -&gt; (Bool -&gt; Transaction ()) -&gt; Transaction ()
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-664"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; Transaction ()
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-665"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-666"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621680535671"><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680535671"><span class="hs-identifier hs-var">fromBranch</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535672"><span class="annot"><span class="annottext">Maybe BranchHash
</span><a href="#local-6989586621680535672"><span class="hs-identifier hs-var">mayExistingLookupBH</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe BranchHash
</span><a href="#local-6989586621680535668"><span class="hs-identifier hs-var">mayFromBranchHash</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-667"></span><span>        </span><span class="annot"><span class="annottext">Maybe BranchHash
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Branch Transaction, Maybe BranchHash)
-&gt; Transaction (Branch Transaction, Maybe BranchHash)
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Branch Transaction
forall (m :: * -&gt; *). Branch m
</span><span class="hs-identifier hs-var">V2Branch.empty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe BranchHash
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-668"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680535674"><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535674"><span class="hs-identifier hs-var">fromBH</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-669"></span><span>          </span><span class="annot"><span class="annottext">BranchHash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.checkBranchHashNameLookupExists</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535674"><span class="hs-identifier hs-var">fromBH</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction Bool
-&gt; (Bool -&gt; Transaction (Branch Transaction, Maybe BranchHash))
-&gt; Transaction (Branch Transaction, Maybe BranchHash)
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-670"></span><span>            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="annot"><span class="annottext">BranchHash -&gt; Maybe BranchHash
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535674"><span class="hs-identifier hs-var">fromBH</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Branch Transaction -&gt; (Branch Transaction, Maybe BranchHash))
-&gt; Transaction (Branch Transaction)
-&gt; Transaction (Branch Transaction, Maybe BranchHash)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">BranchHash -&gt; Transaction (Branch Transaction)
</span><span class="hs-identifier hs-var">Ops.expectBranchByBranchHash</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535674"><span class="hs-identifier hs-var">fromBH</span></a></span><span>
</span><span id="line-671"></span><span>            </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-672"></span><span>              </span><span class="hs-comment">-- TODO: We can probably infer a good starting branch by crawling through</span><span>
</span><span id="line-673"></span><span>              </span><span class="hs-comment">-- history looking for a Branch Hash we already have an index for.</span><span>
</span><span id="line-674"></span><span>              </span><span class="annot"><span class="annottext">(Branch Transaction, Maybe BranchHash)
-&gt; Transaction (Branch Transaction, Maybe BranchHash)
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Branch Transaction
forall (m :: * -&gt; *). Branch m
</span><span class="hs-identifier hs-var">V2Branch.empty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe BranchHash
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-675"></span><span>      </span><span id="local-6989586621680535676"><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680535676"><span class="hs-identifier hs-var">toBranch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BranchHash -&gt; Transaction (Branch Transaction)
</span><span class="hs-identifier hs-var">Ops.expectBranchByBranchHash</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535669"><span class="hs-identifier hs-var">toBranchHash</span></a></span><span>
</span><span id="line-676"></span><span>      </span><span id="local-6989586621680535677"><span class="annot"><span class="annottext">[(PathSegments, BranchHash)]
</span><a href="#local-6989586621680535677"><span class="hs-identifier hs-var">depMounts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Branch Transaction -&gt; Transaction [(Path, BranchHash)]
</span><a href="U.Codebase.Projects.html#inferDependencyMounts"><span class="hs-identifier hs-var">Projects.inferDependencyMounts</span></a></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680535676"><span class="hs-identifier hs-var">toBranch</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction [(Path, BranchHash)]
-&gt; ([(Path, BranchHash)] -&gt; [(PathSegments, BranchHash)])
-&gt; Transaction [(PathSegments, BranchHash)]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><span class="hs-operator hs-var">&lt;&amp;&gt;</span></span><span> </span><span class="annot"><span class="annottext">((Path, BranchHash) -&gt; (PathSegments, BranchHash))
-&gt; [(Path, BranchHash)] -&gt; [(PathSegments, BranchHash)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Path -&gt; PathSegments)
-&gt; (Path, BranchHash) -&gt; (PathSegments, BranchHash)
forall a b c. (a -&gt; b) -&gt; (a, c) -&gt; (b, c)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b. Coercible a b =&gt; a -&gt; b
forall a b. Coercible a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-identifier hs-type">PathSegments</span></span><span> </span><span class="annot"><span class="annottext">([NameSegment] -&gt; PathSegments)
-&gt; (Path -&gt; [NameSegment]) -&gt; Path -&gt; PathSegments
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Path -&gt; [NameSegment]
</span><a href="Unison.Codebase.Path.html#toList"><span class="hs-identifier hs-var">Path.toList</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535680"><span class="annot"><span class="annottext">depMountPaths :: [Path]
</span><a href="#local-6989586621680535680"><span class="hs-identifier hs-var hs-var">depMountPaths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[NameSegment] -&gt; Path
</span><a href="Unison.Codebase.Path.html#fromList"><span class="hs-identifier hs-var">Path.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([NameSegment] -&gt; Path)
-&gt; (PathSegments -&gt; [NameSegment]) -&gt; PathSegments -&gt; Path
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PathSegments -&gt; [NameSegment]
forall a b. Coercible a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">coerce</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PathSegments -&gt; Path)
-&gt; ((PathSegments, BranchHash) -&gt; PathSegments)
-&gt; (PathSegments, BranchHash)
-&gt; Path
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PathSegments, BranchHash) -&gt; PathSegments
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((PathSegments, BranchHash) -&gt; Path)
-&gt; [(PathSegments, BranchHash)] -&gt; [Path]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(PathSegments, BranchHash)]
</span><a href="#local-6989586621680535677"><span class="hs-identifier hs-var">depMounts</span></a></span><span>
</span><span id="line-678"></span><span>      </span><span id="local-6989586621680535682"><span class="annot"><span class="annottext">TreeDiff Transaction
</span><a href="#local-6989586621680535682"><span class="hs-identifier hs-var">treeDiff</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Path] -&gt; TreeDiff Transaction -&gt; TreeDiff Transaction
forall (m :: * -&gt; *).
Applicative m =&gt;
[Path] -&gt; TreeDiff m -&gt; TreeDiff m
</span><a href="#local-6989586621680535683"><span class="hs-identifier hs-var">ignoreDepMounts</span></a></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621680535680"><span class="hs-identifier hs-var">depMountPaths</span></a></span><span> </span><span class="annot"><span class="annottext">(TreeDiff Transaction -&gt; TreeDiff Transaction)
-&gt; Transaction (TreeDiff Transaction)
-&gt; Transaction (TreeDiff Transaction)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
-&gt; Branch Transaction -&gt; Transaction (TreeDiff Transaction)
</span><a href="U.Codebase.Branch.Diff.html#diffBranches"><span class="hs-identifier hs-var">BranchDiff.diffBranches</span></a></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680535671"><span class="hs-identifier hs-var">fromBranch</span></a></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
</span><a href="#local-6989586621680535676"><span class="hs-identifier hs-var">toBranch</span></a></span><span>
</span><span id="line-679"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535685"><span class="annot"><span class="annottext">namePrefix :: Maybe a
</span><a href="#local-6989586621680535685"><span class="hs-identifier hs-var hs-var">namePrefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-680"></span><span>      </span><span class="annot"><span class="annottext">Maybe BranchHash
-&gt; BranchHash
-&gt; ((([NamedRef (Referent, Maybe ConstructorType)],
      [NamedRef Referent])
     -&gt; ([NamedRef TypeReference], [NamedRef TypeReference])
     -&gt; Transaction ())
    -&gt; Transaction ())
-&gt; Transaction ()
</span><span class="hs-identifier hs-var">Ops.buildNameLookupForBranchHash</span></span><span>
</span><span id="line-681"></span><span>        </span><span class="annot"><span class="annottext">Maybe BranchHash
</span><a href="#local-6989586621680535672"><span class="hs-identifier hs-var">mayExistingLookupBH</span></a></span><span>
</span><span id="line-682"></span><span>        </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535669"><span class="hs-identifier hs-var">toBranchHash</span></a></span><span>
</span><span id="line-683"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680535687"><span class="annot"><span class="annottext">([NamedRef (Referent, Maybe ConstructorType)], [NamedRef Referent])
-&gt; ([NamedRef TypeReference], [NamedRef TypeReference])
-&gt; Transaction ()
</span><a href="#local-6989586621680535687"><span class="hs-identifier hs-var">save</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-684"></span><span>            </span><span class="annot"><span class="annottext">Maybe Name
-&gt; TreeDiff Transaction
-&gt; (Maybe Name -&gt; NameChanges -&gt; Transaction ())
-&gt; Transaction ()
forall (m :: * -&gt; *) r.
(Monad m, Monoid r) =&gt;
Maybe Name
-&gt; TreeDiff m -&gt; (Maybe Name -&gt; NameChanges -&gt; m r) -&gt; m r
</span><a href="U.Codebase.Branch.Diff.html#streamNameChanges"><span class="hs-identifier hs-var">BranchDiff.streamNameChanges</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><a href="#local-6989586621680535685"><span class="hs-identifier hs-var">namePrefix</span></a></span><span> </span><span class="annot"><span class="annottext">TreeDiff Transaction
</span><a href="#local-6989586621680535682"><span class="hs-identifier hs-var">treeDiff</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680535689"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621680535689"><span class="hs-identifier hs-var">_prefix</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="U.Codebase.Branch.Diff.html#NameChanges"><span class="hs-identifier hs-type">BranchDiff.NameChanges</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680535691"><span class="annot"><span class="annottext">[(Name, Referent)]
termNameAdds :: [(Name, Referent)]
$sel:termNameAdds:NameChanges :: NameChanges -&gt; [(Name, Referent)]
</span><a href="#local-6989586621680535691"><span class="hs-identifier hs-var hs-var">termNameAdds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535693"><span class="annot"><span class="annottext">[(Name, Referent)]
termNameRemovals :: [(Name, Referent)]
$sel:termNameRemovals:NameChanges :: NameChanges -&gt; [(Name, Referent)]
</span><a href="#local-6989586621680535693"><span class="hs-identifier hs-var hs-var">termNameRemovals</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535695"><span class="annot"><span class="annottext">[(Name, TypeReference)]
typeNameAdds :: [(Name, TypeReference)]
$sel:typeNameAdds:NameChanges :: NameChanges -&gt; [(Name, TypeReference)]
</span><a href="#local-6989586621680535695"><span class="hs-identifier hs-var hs-var">typeNameAdds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535697"><span class="annot"><span class="annottext">[(Name, TypeReference)]
typeNameRemovals :: [(Name, TypeReference)]
$sel:typeNameRemovals:NameChanges :: NameChanges -&gt; [(Name, TypeReference)]
</span><a href="#local-6989586621680535697"><span class="hs-identifier hs-var hs-var">typeNameRemovals</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-685"></span><span>              </span><span id="local-6989586621680535699"><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)]
</span><a href="#local-6989586621680535699"><span class="hs-identifier hs-var">termNameAddsWithCT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-686"></span><span>                </span><span class="annot"><span class="annottext">[(Name, Referent)]
-&gt; ((Name, Referent)
    -&gt; Transaction (NamedRef (Referent, Maybe ConstructorType)))
-&gt; Transaction [NamedRef (Referent, Maybe ConstructorType)]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621680535691"><span class="hs-identifier hs-var">termNameAdds</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680535700"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680535700"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535701"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680535701"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-687"></span><span>                  </span><span id="local-6989586621680535702"><span class="annot"><span class="annottext">(Referent, Maybe ConstructorType)
</span><a href="#local-6989586621680535702"><span class="hs-identifier hs-var">refWithCT</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Referent -&gt; Transaction (Referent, Maybe ConstructorType)
</span><a href="#local-6989586621680535703"><span class="hs-identifier hs-var">addReferentCT</span></a></span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680535701"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-688"></span><span>                  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="annot"><span class="annottext">(Name, (Referent, Maybe ConstructorType))
-&gt; NamedRef (Referent, Maybe ConstructorType)
forall ref. (Name, ref) -&gt; NamedRef ref
</span><a href="#local-6989586621680535704"><span class="hs-identifier hs-var">toNamedRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680535700"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Referent, Maybe ConstructorType)
</span><a href="#local-6989586621680535702"><span class="hs-identifier hs-var">refWithCT</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-689"></span><span>              </span><span class="annot"><span class="annottext">([NamedRef (Referent, Maybe ConstructorType)], [NamedRef Referent])
-&gt; ([NamedRef TypeReference], [NamedRef TypeReference])
-&gt; Transaction ()
</span><a href="#local-6989586621680535687"><span class="hs-identifier hs-var">save</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[NamedRef (Referent, Maybe ConstructorType)]
</span><a href="#local-6989586621680535699"><span class="hs-identifier hs-var">termNameAddsWithCT</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Name, Referent) -&gt; NamedRef Referent
forall ref. (Name, ref) -&gt; NamedRef ref
</span><a href="#local-6989586621680535704"><span class="hs-identifier hs-var">toNamedRef</span></a></span><span> </span><span class="annot"><span class="annottext">((Name, Referent) -&gt; NamedRef Referent)
-&gt; [(Name, Referent)] -&gt; [NamedRef Referent]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Referent)]
</span><a href="#local-6989586621680535693"><span class="hs-identifier hs-var">termNameRemovals</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name, TypeReference) -&gt; NamedRef TypeReference
forall ref. (Name, ref) -&gt; NamedRef ref
</span><a href="#local-6989586621680535704"><span class="hs-identifier hs-var">toNamedRef</span></a></span><span> </span><span class="annot"><span class="annottext">((Name, TypeReference) -&gt; NamedRef TypeReference)
-&gt; [(Name, TypeReference)] -&gt; [NamedRef TypeReference]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Name, TypeReference)]
</span><a href="#local-6989586621680535695"><span class="hs-identifier hs-var">typeNameAdds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Name, TypeReference) -&gt; NamedRef TypeReference
forall ref. (Name, ref) -&gt; NamedRef ref
</span><a href="#local-6989586621680535704"><span class="hs-identifier hs-var">toNamedRef</span></a></span><span> </span><span class="annot"><span class="annottext">((Name, TypeReference) -&gt; NamedRef TypeReference)
-&gt; [(Name, TypeReference)] -&gt; [NamedRef TypeReference]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Name, TypeReference)]
</span><a href="#local-6989586621680535697"><span class="hs-identifier hs-var">typeNameRemovals</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-691"></span><span>      </span><span class="hs-comment">-- Ensure all of our dependencies have name lookups too.</span><span>
</span><span id="line-692"></span><span>      </span><span class="annot"><span class="annottext">[(PathSegments, BranchHash)]
-&gt; ((PathSegments, BranchHash) -&gt; Transaction ()) -&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="annot"><span class="annottext">[(PathSegments, BranchHash)]
</span><a href="#local-6989586621680535677"><span class="hs-identifier hs-var">depMounts</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680535705"><span class="annot"><span class="annottext">PathSegments
</span><a href="#local-6989586621680535705"><span class="hs-identifier hs-var">_path</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535706"><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535706"><span class="hs-identifier hs-var">depBranchHash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-693"></span><span>        </span><span class="hs-comment">-- TODO: see if we can find a way to infer a good fromHash for dependencies</span><span>
</span><span id="line-694"></span><span>        </span><span class="annot"><span class="annottext">(TypeReference -&gt; Transaction ConstructorType)
-&gt; Maybe BranchHash -&gt; BranchHash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#ensureNameLookupForBranchHash"><span class="hs-identifier hs-var">ensureNameLookupForBranchHash</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535667"><span class="hs-identifier hs-var">getDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe BranchHash
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535706"><span class="hs-identifier hs-var">depBranchHash</span></a></span><span>
</span><span id="line-695"></span><span>      </span><span class="annot"><span class="annottext">BranchHash -&gt; [(PathSegments, BranchHash)] -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Ops.associateNameLookupMounts</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535669"><span class="hs-identifier hs-var">toBranchHash</span></a></span><span> </span><span class="annot"><span class="annottext">[(PathSegments, BranchHash)]
</span><a href="#local-6989586621680535677"><span class="hs-identifier hs-var">depMounts</span></a></span><span>
</span><span id="line-696"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-697"></span><span>    </span><span id="local-6989586621680534628"><span class="annot"><a href="#local-6989586621680535708"><span class="hs-identifier hs-type">alterTreeDiffAtPath</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="#local-6989586621680534628"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Unison.Codebase.Path.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="U.Codebase.Branch.Diff.html#TreeDiff"><span class="hs-identifier hs-type">TreeDiff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534628"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="U.Codebase.Branch.Diff.html#TreeDiff"><span class="hs-identifier hs-type">TreeDiff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534628"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="U.Codebase.Branch.Diff.html#TreeDiff"><span class="hs-identifier hs-type">TreeDiff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534628"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="U.Codebase.Branch.Diff.html#TreeDiff"><span class="hs-identifier hs-type">TreeDiff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534628"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-698"></span><span>    </span><span id="local-6989586621680535708"><span class="annot"><span class="annottext">alterTreeDiffAtPath :: forall (m :: * -&gt; *).
Functor m =&gt;
Path -&gt; (TreeDiff m -&gt; TreeDiff m) -&gt; TreeDiff m -&gt; TreeDiff m
</span><a href="#local-6989586621680535708"><span class="hs-identifier hs-var hs-var">alterTreeDiffAtPath</span></a></span></span><span> </span><span id="local-6989586621680535717"><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680535717"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621680535718"><span class="annot"><span class="annottext">TreeDiff m -&gt; TreeDiff m
</span><a href="#local-6989586621680535718"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="U.Codebase.Branch.Diff.html#TreeDiff"><span class="hs-identifier hs-type">TreeDiff</span></a></span><span> </span><span id="local-6989586621680535719"><span class="annot"><span class="annottext">Cofree (Compose (Map NameSegment) m) DefinitionDiffs
</span><a href="#local-6989586621680535719"><span class="hs-identifier hs-var">cfr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-699"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680535717"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-700"></span><span>        </span><span class="annot"><span class="annottext">Path
</span><a href="Unison.Codebase.Path.html#Empty"><span class="hs-identifier hs-var">Path.Empty</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TreeDiff m -&gt; TreeDiff m
</span><a href="#local-6989586621680535718"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cofree (Compose (Map NameSegment) m) DefinitionDiffs -&gt; TreeDiff m
forall (m :: * -&gt; *).
Cofree (Compose (Map NameSegment) m) DefinitionDiffs -&gt; TreeDiff m
</span><a href="U.Codebase.Branch.Diff.html#TreeDiff"><span class="hs-identifier hs-var">TreeDiff</span></a></span><span> </span><span class="annot"><span class="annottext">Cofree (Compose (Map NameSegment) m) DefinitionDiffs
</span><a href="#local-6989586621680535719"><span class="hs-identifier hs-var">cfr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-701"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621680535720"><span class="annot"><span class="annottext">NameSegment
</span><a href="#local-6989586621680535720"><span class="hs-identifier hs-var">segment</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">Path.:&lt;</span></span><span> </span><span id="local-6989586621680535722"><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680535722"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-702"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680535723"><span class="annot"><span class="annottext">DefinitionDiffs
</span><a href="#local-6989586621680535723"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">Cofree.:&lt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Compose</span></span><span> </span><span id="local-6989586621680535726"><span class="annot"><span class="annottext">Map
  NameSegment
  (m (Cofree (Compose (Map NameSegment) m) DefinitionDiffs))
</span><a href="#local-6989586621680535726"><span class="hs-identifier hs-var">rest'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cofree (Compose (Map NameSegment) m) DefinitionDiffs
</span><a href="#local-6989586621680535719"><span class="hs-identifier hs-var">cfr</span></a></span><span>
</span><span id="line-703"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Cofree (Compose (Map NameSegment) m) DefinitionDiffs -&gt; TreeDiff m
forall (m :: * -&gt; *).
Cofree (Compose (Map NameSegment) m) DefinitionDiffs -&gt; TreeDiff m
</span><a href="U.Codebase.Branch.Diff.html#TreeDiff"><span class="hs-identifier hs-var">TreeDiff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DefinitionDiffs
</span><a href="#local-6989586621680535723"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">DefinitionDiffs
-&gt; Compose
     (Map NameSegment)
     m
     (Cofree (Compose (Map NameSegment) m) DefinitionDiffs)
-&gt; Cofree (Compose (Map NameSegment) m) DefinitionDiffs
forall (f :: * -&gt; *) a. a -&gt; f (Cofree f a) -&gt; Cofree f a
</span><span class="hs-operator hs-var">Cofree.:&lt;</span></span><span> </span><span class="annot"><span class="annottext">Map
  NameSegment
  (m (Cofree (Compose (Map NameSegment) m) DefinitionDiffs))
-&gt; Compose
     (Map NameSegment)
     m
     (Cofree (Compose (Map NameSegment) m) DefinitionDiffs)
forall {k} {k1} (f :: k -&gt; *) (g :: k1 -&gt; k) (a :: k1).
f (g a) -&gt; Compose f g a
</span><span class="hs-identifier hs-var">Compose</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(m (Cofree (Compose (Map NameSegment) m) DefinitionDiffs)
 -&gt; m (Cofree (Compose (Map NameSegment) m) DefinitionDiffs))
-&gt; NameSegment
-&gt; Map
     NameSegment
     (m (Cofree (Compose (Map NameSegment) m) DefinitionDiffs))
-&gt; Map
     NameSegment
     (m (Cofree (Compose (Map NameSegment) m) DefinitionDiffs))
forall k a. Ord k =&gt; (a -&gt; a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.adjust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Cofree (Compose (Map NameSegment) m) DefinitionDiffs
 -&gt; Cofree (Compose (Map NameSegment) m) DefinitionDiffs)
-&gt; m (Cofree (Compose (Map NameSegment) m) DefinitionDiffs)
-&gt; m (Cofree (Compose (Map NameSegment) m) DefinitionDiffs)
forall a b. (a -&gt; b) -&gt; m a -&gt; m b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TreeDiff m -&gt; TreeDiff m)
-&gt; Cofree (Compose (Map NameSegment) m) DefinitionDiffs
-&gt; Cofree (Compose (Map NameSegment) m) DefinitionDiffs
forall a b. Coercible a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">((TreeDiff m -&gt; TreeDiff m)
 -&gt; Cofree (Compose (Map NameSegment) m) DefinitionDiffs
 -&gt; Cofree (Compose (Map NameSegment) m) DefinitionDiffs)
-&gt; (TreeDiff m -&gt; TreeDiff m)
-&gt; Cofree (Compose (Map NameSegment) m) DefinitionDiffs
-&gt; Cofree (Compose (Map NameSegment) m) DefinitionDiffs
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Path -&gt; (TreeDiff m -&gt; TreeDiff m) -&gt; TreeDiff m -&gt; TreeDiff m
forall (m :: * -&gt; *).
Functor m =&gt;
Path -&gt; (TreeDiff m -&gt; TreeDiff m) -&gt; TreeDiff m -&gt; TreeDiff m
</span><a href="#local-6989586621680535708"><span class="hs-identifier hs-var">alterTreeDiffAtPath</span></a></span><span> </span><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680535722"><span class="hs-identifier hs-var">rest</span></a></span><span> </span><span class="annot"><span class="annottext">TreeDiff m -&gt; TreeDiff m
</span><a href="#local-6989586621680535718"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NameSegment
</span><a href="#local-6989586621680535720"><span class="hs-identifier hs-var">segment</span></a></span><span> </span><span class="annot"><span class="annottext">Map
  NameSegment
  (m (Cofree (Compose (Map NameSegment) m) DefinitionDiffs))
</span><a href="#local-6989586621680535726"><span class="hs-identifier hs-var">rest'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-704"></span><span>    </span><span class="hs-comment">-- Delete portions of the diff which are covered by dependency mounts.</span><span>
</span><span id="line-705"></span><span>    </span><span id="local-6989586621680534622"><span class="annot"><a href="#local-6989586621680535683"><span class="hs-identifier hs-type">ignoreDepMounts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621680534622"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Unison.Codebase.Path.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="U.Codebase.Branch.Diff.html#TreeDiff"><span class="hs-identifier hs-type">TreeDiff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534622"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="U.Codebase.Branch.Diff.html#TreeDiff"><span class="hs-identifier hs-type">TreeDiff</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680534622"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-706"></span><span>    </span><span id="local-6989586621680535683"><span class="annot"><span class="annottext">ignoreDepMounts :: forall (m :: * -&gt; *).
Applicative m =&gt;
[Path] -&gt; TreeDiff m -&gt; TreeDiff m
</span><a href="#local-6989586621680535683"><span class="hs-identifier hs-var hs-var">ignoreDepMounts</span></a></span></span><span> </span><span id="local-6989586621680535735"><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621680535735"><span class="hs-identifier hs-var">depMounts</span></a></span></span><span> </span><span id="local-6989586621680535736"><span class="annot"><span class="annottext">TreeDiff m
</span><a href="#local-6989586621680535736"><span class="hs-identifier hs-var">treeDiff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-707"></span><span>      </span><span class="annot"><span class="annottext">(TreeDiff m -&gt; Path -&gt; TreeDiff m)
-&gt; TreeDiff m -&gt; [Path] -&gt; TreeDiff m
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680535738"><span class="annot"><span class="annottext">TreeDiff m
</span><a href="#local-6989586621680535738"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621680535739"><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680535739"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Path -&gt; (TreeDiff m -&gt; TreeDiff m) -&gt; TreeDiff m -&gt; TreeDiff m
forall (m :: * -&gt; *).
Functor m =&gt;
Path -&gt; (TreeDiff m -&gt; TreeDiff m) -&gt; TreeDiff m -&gt; TreeDiff m
</span><a href="#local-6989586621680535708"><span class="hs-identifier hs-var">alterTreeDiffAtPath</span></a></span><span> </span><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621680535739"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TreeDiff m -&gt; TreeDiff m -&gt; TreeDiff m
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">TreeDiff m
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TreeDiff m
</span><a href="#local-6989586621680535738"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TreeDiff m
</span><a href="#local-6989586621680535736"><span class="hs-identifier hs-var">treeDiff</span></a></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621680535735"><span class="hs-identifier hs-var">depMounts</span></a></span><span>
</span><span id="line-708"></span><span>    </span><span id="local-6989586621680534627"><span class="annot"><a href="#local-6989586621680535704"><span class="hs-identifier hs-type">toNamedRef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680534627"><span class="hs-identifier hs-type">ref</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.NamedRef</span></span><span> </span><span class="annot"><a href="#local-6989586621680534627"><span class="hs-identifier hs-type">ref</span></a></span></span><span>
</span><span id="line-709"></span><span>    </span><span id="local-6989586621680535704"><span class="annot"><span class="annottext">toNamedRef :: forall ref. (Name, ref) -&gt; NamedRef ref
</span><a href="#local-6989586621680535704"><span class="hs-identifier hs-var hs-var">toNamedRef</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680535742"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680535742"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680535743"><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680535743"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.NamedRef</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:reversedSegments:NamedRef :: ReversedName
</span><span class="hs-identifier hs-var">reversedSegments</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty NameSegment -&gt; ReversedName
forall a b. Coercible a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">coerce</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty NameSegment -&gt; ReversedName)
-&gt; NonEmpty NameSegment -&gt; ReversedName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; NonEmpty NameSegment
</span><span class="hs-identifier hs-var">Name.reverseSegments</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680535742"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:ref:NamedRef :: ref
</span><span class="hs-identifier hs-var">ref</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ref
</span><a href="#local-6989586621680535743"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-710"></span><span>    </span><span class="annot"><a href="#local-6989586621680535703"><span class="hs-identifier hs-type">addReferentCT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Referent.Referent</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Referent.Referent</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Referent.ConstructorType</span></span><span class="hs-special">)</span><span>
</span><span id="line-711"></span><span>    </span><span id="local-6989586621680535703"><span class="annot"><span class="annottext">addReferentCT :: Referent -&gt; Transaction (Referent, Maybe ConstructorType)
</span><a href="#local-6989586621680535703"><span class="hs-identifier hs-var hs-var">addReferentCT</span></a></span></span><span> </span><span id="local-6989586621680535745"><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680535745"><span class="hs-identifier hs-var">referent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680535745"><span class="hs-identifier hs-var">referent</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-712"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">C.Referent.Ref</span></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Referent, Maybe ConstructorType)
-&gt; Transaction (Referent, Maybe ConstructorType)
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680535745"><span class="hs-identifier hs-var">referent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ConstructorType
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-713"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">C.Referent.Con</span></span><span> </span><span id="local-6989586621680535748"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535748"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621680535749"><span class="annot"><span class="annottext">ConstructorId
</span><a href="#local-6989586621680535749"><span class="hs-identifier hs-var">_conId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-714"></span><span>        </span><span id="local-6989586621680535750"><span class="annot"><span class="annottext">ConstructorType
</span><a href="#local-6989586621680535750"><span class="hs-identifier hs-var">ct</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535667"><span class="hs-identifier hs-var">getDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680535748"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-715"></span><span>        </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Referent
</span><a href="#local-6989586621680535745"><span class="hs-identifier hs-var">referent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; Maybe ConstructorType
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ConstructorType -&gt; Maybe ConstructorType)
-&gt; ConstructorType -&gt; Maybe ConstructorType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConstructorType -&gt; ConstructorType
</span><a href="Unison.Codebase.SqliteCodebase.Conversions.html#constructorType1to2"><span class="hs-identifier hs-var">Cv.constructorType1to2</span></a></span><span> </span><span class="annot"><span class="annottext">ConstructorType
</span><a href="#local-6989586621680535750"><span class="hs-identifier hs-var">ct</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span class="hs-comment">-- | Regenerate the name lookup index for the given branch hash from scratch.</span><span>
</span><span id="line-718"></span><span class="hs-comment">-- This shouldn't be necessary in normal operation, but it's useful to fix name lookups if</span><span>
</span><span id="line-719"></span><span class="hs-comment">-- they somehow get corrupt, or during local testing and debugging.</span><span>
</span><span id="line-720"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#regenerateNameLookup"><span class="hs-identifier hs-type">regenerateNameLookup</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-721"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Reference.Reference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CT.ConstructorType</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-722"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">BranchHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-723"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-724"></span><span id="regenerateNameLookup"><span class="annot"><span class="annottext">regenerateNameLookup :: (TypeReference -&gt; Transaction ConstructorType)
-&gt; BranchHash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#regenerateNameLookup"><span class="hs-identifier hs-var hs-var">regenerateNameLookup</span></a></span></span><span> </span><span id="local-6989586621680535753"><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535753"><span class="hs-identifier hs-var">getDeclType</span></a></span></span><span> </span><span id="local-6989586621680535754"><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535754"><span class="hs-identifier hs-var">bh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-725"></span><span>  </span><span class="annot"><span class="annottext">BranchHash -&gt; Transaction Bool
</span><span class="hs-identifier hs-var">Ops.checkBranchHashNameLookupExists</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535754"><span class="hs-identifier hs-var">bh</span></a></span><span> </span><span class="annot"><span class="annottext">Transaction Bool -&gt; (Bool -&gt; Transaction ()) -&gt; Transaction ()
forall a b. Transaction a -&gt; (a -&gt; Transaction b) -&gt; Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-726"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-727"></span><span>      </span><span id="local-6989586621680535755"><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680535755"><span class="hs-identifier hs-var">bhId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BranchHash -&gt; Transaction BranchHashId
</span><span class="hs-identifier hs-var">Q.expectBranchHashId</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535754"><span class="hs-identifier hs-var">bh</span></a></span><span>
</span><span id="line-728"></span><span>      </span><span class="annot"><span class="annottext">BranchHashId -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Q.deleteNameLookup</span></span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680535755"><span class="hs-identifier hs-var">bhId</span></a></span><span>
</span><span id="line-729"></span><span>      </span><span class="annot"><span class="annottext">(TypeReference -&gt; Transaction ConstructorType)
-&gt; Maybe BranchHash -&gt; BranchHash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#ensureNameLookupForBranchHash"><span class="hs-identifier hs-var">ensureNameLookupForBranchHash</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535753"><span class="hs-identifier hs-var">getDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe BranchHash
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535754"><span class="hs-identifier hs-var">bh</span></a></span><span>
</span><span id="line-730"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(TypeReference -&gt; Transaction ConstructorType)
-&gt; Maybe BranchHash -&gt; BranchHash -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#ensureNameLookupForBranchHash"><span class="hs-identifier hs-var">ensureNameLookupForBranchHash</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference -&gt; Transaction ConstructorType
</span><a href="#local-6989586621680535753"><span class="hs-identifier hs-var">getDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe BranchHash
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680535754"><span class="hs-identifier hs-var">bh</span></a></span><span>
</span><span id="line-731"></span><span>
</span><span id="line-732"></span><span class="hs-comment">-- | Given a transaction, return a transaction that first checks a semispace cache of the given size.</span><span>
</span><span id="line-733"></span><span class="hs-comment">--</span><span>
</span><span id="line-734"></span><span class="hs-comment">-- The transaction should probably be read-only, as we (of course) don't hit SQLite on a cache hit.</span><span>
</span><span id="line-735"></span><span id="local-6989586621680534652"><span id="local-6989586621680534653"><span id="local-6989586621680534654"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#makeCachedTransaction"><span class="hs-identifier hs-type">makeCachedTransaction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680534652"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621680534653"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680534652"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><a href="#local-6989586621680534654"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680534653"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680534652"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><a href="#local-6989586621680534654"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-736"></span><span id="makeCachedTransaction"><span class="annot"><span class="annottext">makeCachedTransaction :: forall a (m :: * -&gt; *) b.
(Ord a, MonadIO m) =&gt;
Word -&gt; (a -&gt; Transaction b) -&gt; m (a -&gt; Transaction b)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#makeCachedTransaction"><span class="hs-identifier hs-var hs-var">makeCachedTransaction</span></a></span></span><span> </span><span id="local-6989586621680535773"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621680535773"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621680535774"><span class="annot"><span class="annottext">a -&gt; Transaction b
</span><a href="#local-6989586621680535774"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-737"></span><span>  </span><span id="local-6989586621680535775"><span class="annot"><span class="annottext">Cache a b
</span><a href="#local-6989586621680535775"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Word -&gt; m (Cache a b)
forall (m :: * -&gt; *) k v.
(MonadIO m, Ord k) =&gt;
Word -&gt; m (Cache k v)
</span><span class="hs-identifier hs-var">Cache.semispaceCache</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621680535773"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-738"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680535777"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680535777"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-739"></span><span>    </span><span id="local-6989586621680535778"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680535778"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction Connection
</span><span class="hs-identifier hs-var">Sqlite.unsafeGetConnection</span></span><span>
</span><span id="line-740"></span><span>    </span><span class="annot"><span class="annottext">IO b -&gt; Transaction b
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cache a b -&gt; (a -&gt; IO b) -&gt; a -&gt; IO b
forall (m :: * -&gt; *) k v.
MonadIO m =&gt;
Cache k v -&gt; (k -&gt; m v) -&gt; k -&gt; m v
</span><span class="hs-identifier hs-var">Cache.apply</span></span><span> </span><span class="annot"><span class="annottext">Cache a b
</span><a href="#local-6989586621680535775"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680535781"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680535781"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Transaction b -&gt; Connection -&gt; IO b
forall a. Transaction a -&gt; Connection -&gt; IO a
</span><span class="hs-identifier hs-var">Sqlite.unsafeUnTransaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Transaction b
</span><a href="#local-6989586621680535774"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680535781"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680535778"><span class="hs-identifier hs-var">conn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680535777"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span class="annot"><span class="hs-comment">-- | Like 'makeCachedTransaction', but for when the transaction returns a Maybe; only cache the Justs.</span></span><span>
</span><span id="line-743"></span><span id="local-6989586621680534668"><span id="local-6989586621680534669"><span id="local-6989586621680534670"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#makeMaybeCachedTransaction"><span class="hs-identifier hs-type">makeMaybeCachedTransaction</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-744"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621680534668"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621680534669"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-745"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-746"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680534668"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621680534670"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-747"></span><span>  </span><span class="annot"><a href="#local-6989586621680534669"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680534668"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621680534670"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-748"></span><span id="makeMaybeCachedTransaction"><span class="annot"><span class="annottext">makeMaybeCachedTransaction :: forall a (m :: * -&gt; *) b.
(Ord a, MonadIO m) =&gt;
Word
-&gt; (a -&gt; Transaction (Maybe b)) -&gt; m (a -&gt; Transaction (Maybe b))
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#makeMaybeCachedTransaction"><span class="hs-identifier hs-var hs-var">makeMaybeCachedTransaction</span></a></span></span><span> </span><span id="local-6989586621680535800"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621680535800"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621680535801"><span class="annot"><span class="annottext">a -&gt; Transaction (Maybe b)
</span><a href="#local-6989586621680535801"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-749"></span><span>  </span><span id="local-6989586621680535802"><span class="annot"><span class="annottext">Cache a b
</span><a href="#local-6989586621680535802"><span class="hs-identifier hs-var">cache</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Word -&gt; m (Cache a b)
forall (m :: * -&gt; *) k v.
(MonadIO m, Ord k) =&gt;
Word -&gt; m (Cache k v)
</span><span class="hs-identifier hs-var">Cache.semispaceCache</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621680535800"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-750"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680535803"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680535803"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-751"></span><span>    </span><span id="local-6989586621680535804"><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680535804"><span class="hs-identifier hs-var">conn</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction Connection
</span><span class="hs-identifier hs-var">Sqlite.unsafeGetConnection</span></span><span>
</span><span id="line-752"></span><span>    </span><span class="annot"><span class="annottext">IO (Maybe b) -&gt; Transaction (Maybe b)
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cache a b -&gt; (a -&gt; IO (Maybe b)) -&gt; a -&gt; IO (Maybe b)
forall (m :: * -&gt; *) (g :: * -&gt; *) k v.
(MonadIO m, Applicative g, Traversable g) =&gt;
Cache k v -&gt; (k -&gt; m (g v)) -&gt; k -&gt; m (g v)
</span><span class="hs-identifier hs-var">Cache.applyDefined</span></span><span> </span><span class="annot"><span class="annottext">Cache a b
</span><a href="#local-6989586621680535802"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680535806"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680535806"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe b) -&gt; Connection -&gt; IO (Maybe b)
forall a. Transaction a -&gt; Connection -&gt; IO a
</span><span class="hs-identifier hs-var">Sqlite.unsafeUnTransaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Transaction (Maybe b)
</span><a href="#local-6989586621680535801"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680535806"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Connection
</span><a href="#local-6989586621680535804"><span class="hs-identifier hs-var">conn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680535803"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-753"></span><span>
</span><span id="line-754"></span><span class="annot"><span class="hs-comment">-- | Creates a project by name if one doesn't already exist, creates a branch in that project, then returns the project and branch ids. Fails if a branch by that name already exists in the project.</span></span><span>
</span><span id="line-755"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#insertProjectAndBranch"><span class="hs-identifier hs-type">insertProjectAndBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ProjectName</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ProjectBranchName</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Db.CausalHashId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Project</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ProjectBranch</span></span><span class="hs-special">)</span><span>
</span><span id="line-756"></span><span id="insertProjectAndBranch"><span class="annot"><span class="annottext">insertProjectAndBranch :: ProjectName
-&gt; ProjectBranchName
-&gt; CausalHashId
-&gt; Transaction (Project, ProjectBranch)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#insertProjectAndBranch"><span class="hs-identifier hs-var hs-var">insertProjectAndBranch</span></a></span></span><span> </span><span id="local-6989586621680535807"><span class="annot"><span class="annottext">ProjectName
</span><a href="#local-6989586621680535807"><span class="hs-identifier hs-var">projectName</span></a></span></span><span> </span><span id="local-6989586621680535808"><span class="annot"><span class="annottext">ProjectBranchName
</span><a href="#local-6989586621680535808"><span class="hs-identifier hs-var">branchName</span></a></span></span><span> </span><span id="local-6989586621680535809"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680535809"><span class="hs-identifier hs-var">chId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-757"></span><span>  </span><span id="local-6989586621680535810"><span class="annot"><span class="annottext">ProjectId
</span><a href="#local-6989586621680535810"><span class="hs-identifier hs-var">projectId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction (Maybe ProjectId)
-&gt; Transaction ProjectId -&gt; Transaction ProjectId
forall (m :: * -&gt; *) a. Monad m =&gt; m (Maybe a) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">whenNothingM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Project -&gt; ProjectId) -&gt; Maybe Project -&gt; Maybe ProjectId
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Project -&gt; ProjectId
</span><span class="hs-identifier hs-var">Project.projectId</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Project -&gt; Maybe ProjectId)
-&gt; Transaction (Maybe Project) -&gt; Transaction (Maybe ProjectId)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ProjectName -&gt; Transaction (Maybe Project)
</span><span class="hs-identifier hs-var">Q.loadProjectByName</span></span><span> </span><span class="annot"><span class="annottext">ProjectName
</span><a href="#local-6989586621680535807"><span class="hs-identifier hs-var">projectName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-758"></span><span>    </span><span id="local-6989586621680535814"><span class="annot"><span class="annottext">ProjectId
</span><a href="#local-6989586621680535814"><span class="hs-identifier hs-var">projectId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ProjectId -&gt; Transaction ProjectId
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UUID -&gt; ProjectId
</span><span class="hs-identifier hs-var">Db.ProjectId</span></span><span> </span><span class="annot"><span class="annottext">(UUID -&gt; ProjectId) -&gt; IO UUID -&gt; IO ProjectId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO UUID
</span><span class="hs-identifier hs-var">UUID.nextRandom</span></span><span class="hs-special">)</span><span>
</span><span id="line-759"></span><span>    </span><span class="annot"><span class="annottext">ProjectId -&gt; ProjectName -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Q.insertProject</span></span><span> </span><span class="annot"><span class="annottext">ProjectId
</span><a href="#local-6989586621680535814"><span class="hs-identifier hs-var">projectId</span></a></span><span> </span><span class="annot"><span class="annottext">ProjectName
</span><a href="#local-6989586621680535807"><span class="hs-identifier hs-var">projectName</span></a></span><span>
</span><span id="line-760"></span><span>    </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">ProjectId
</span><a href="#local-6989586621680535814"><span class="hs-identifier hs-var">projectId</span></a></span><span>
</span><span id="line-761"></span><span>  </span><span id="local-6989586621680535818"><span class="annot"><span class="annottext">ProjectBranchId
</span><a href="#local-6989586621680535818"><span class="hs-identifier hs-var">branchId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ProjectBranchId -&gt; Transaction ProjectBranchId
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UUID -&gt; ProjectBranchId
</span><span class="hs-identifier hs-var">Db.ProjectBranchId</span></span><span> </span><span class="annot"><span class="annottext">(UUID -&gt; ProjectBranchId) -&gt; IO UUID -&gt; IO ProjectBranchId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO UUID
</span><span class="hs-identifier hs-var">UUID.nextRandom</span></span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535820"><span class="annot"><span class="annottext">projectBranch :: ProjectBranch
</span><a href="#local-6989586621680535820"><span class="hs-identifier hs-var hs-var">projectBranch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-763"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">ProjectBranch</span></span><span>
</span><span id="line-764"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ProjectId
$sel:projectId:ProjectBranch :: ProjectId
projectId :: ProjectId
</span><span class="hs-identifier hs-var hs-var">projectId</span></span><span class="hs-special">,</span><span>
</span><span id="line-765"></span><span>            </span><span class="annot"><span class="annottext">ProjectBranchId
$sel:branchId:ProjectBranch :: ProjectBranchId
branchId :: ProjectBranchId
</span><span class="hs-identifier hs-var hs-var">branchId</span></span><span class="hs-special">,</span><span>
</span><span id="line-766"></span><span>            </span><span class="annot"><span class="annottext">$sel:name:ProjectBranch :: ProjectBranchName
</span><span class="hs-identifier hs-var">name</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProjectBranchName
</span><a href="#local-6989586621680535808"><span class="hs-identifier hs-var">branchName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-767"></span><span>            </span><span class="annot"><span class="annottext">$sel:parentBranchId:ProjectBranch :: Maybe ProjectBranchId
</span><span class="hs-identifier hs-var">parentBranchId</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ProjectBranchId
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-768"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-769"></span><span>  </span><span class="annot"><span class="annottext">HasCallStack =&gt;
Text -&gt; CausalHashId -&gt; ProjectBranch -&gt; Transaction ()
Text -&gt; CausalHashId -&gt; ProjectBranch -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Q.insertProjectBranch</span></span><span>
</span><span id="line-770"></span><span>    </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Project Created&quot;</span></span><span>
</span><span id="line-771"></span><span>    </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680535809"><span class="hs-identifier hs-var">chId</span></a></span><span>
</span><span id="line-772"></span><span>    </span><span class="annot"><span class="annottext">ProjectBranch
</span><a href="#local-6989586621680535820"><span class="hs-identifier hs-var">projectBranch</span></a></span><span>
</span><span id="line-773"></span><span>  </span><span class="annot"><span class="annottext">ProjectId -&gt; ProjectBranchId -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Q.setMostRecentBranch</span></span><span> </span><span class="annot"><span class="annottext">ProjectId
</span><a href="#local-6989586621680535810"><span class="hs-identifier hs-var">projectId</span></a></span><span> </span><span class="annot"><span class="annottext">ProjectBranchId
</span><a href="#local-6989586621680535818"><span class="hs-identifier hs-var">branchId</span></a></span><span>
</span><span id="line-774"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Project</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:name:Project :: ProjectName
</span><span class="hs-identifier hs-var">name</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProjectName
</span><a href="#local-6989586621680535807"><span class="hs-identifier hs-var">projectName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ProjectId
projectId :: ProjectId
$sel:projectId:Project :: ProjectId
</span><a href="#local-6989586621680535810"><span class="hs-identifier hs-var hs-var">projectId</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ProjectBranch</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ProjectId
$sel:projectId:ProjectBranch :: ProjectId
projectId :: ProjectId
</span><span class="hs-identifier hs-var hs-var">projectId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:name:ProjectBranch :: ProjectBranchName
</span><span class="hs-identifier hs-var">name</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProjectBranchName
</span><a href="#local-6989586621680535808"><span class="hs-identifier hs-var">branchName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ProjectBranchId
$sel:branchId:ProjectBranch :: ProjectBranchId
branchId :: ProjectBranchId
</span><span class="hs-identifier hs-var hs-var">branchId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:parentBranchId:ProjectBranch :: Maybe ProjectBranchId
</span><span class="hs-identifier hs-var">parentBranchId</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ProjectBranchId
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-775"></span><span>
</span><span id="line-776"></span><span class="hs-comment">-- | Often we need to assign something to an empty causal, this ensures the empty causal</span><span>
</span><span id="line-777"></span><span class="hs-comment">-- exists in the codebase and returns its hash.</span><span>
</span><span id="line-778"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Operations.html#emptyCausalHash"><span class="hs-identifier hs-type">emptyCausalHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CausalHash</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Db.CausalHashId</span></span><span class="hs-special">)</span><span>
</span><span id="line-779"></span><span id="emptyCausalHash"><span class="annot"><span class="annottext">emptyCausalHash :: Transaction (CausalHash, CausalHashId)
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#emptyCausalHash"><span class="hs-identifier hs-var hs-var">emptyCausalHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-780"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535827"><span class="annot"><span class="annottext">emptyBranch :: Branch m
</span><a href="#local-6989586621680535827"><span class="hs-identifier hs-var hs-var">emptyBranch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Branch m
forall (m :: * -&gt; *). Branch m
</span><a href="Unison.Codebase.Branch.html#empty"><span class="hs-identifier hs-var">Branch.empty</span></a></span><span>
</span><span id="line-781"></span><span>  </span><span class="annot"><span class="annottext">Branch Transaction -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Operations.html#putBranch"><span class="hs-identifier hs-var">putBranch</span></a></span><span> </span><span class="annot"><span class="annottext">Branch Transaction
forall (m :: * -&gt; *). Branch m
</span><a href="#local-6989586621680535827"><span class="hs-identifier hs-var">emptyBranch</span></a></span><span>
</span><span id="line-782"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680535829"><span class="annot"><span class="annottext">causalHash :: CausalHash
</span><a href="#local-6989586621680535829"><span class="hs-identifier hs-var hs-var">causalHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Branch Any -&gt; CausalHash
forall (m :: * -&gt; *). Branch m -&gt; CausalHash
</span><a href="Unison.Codebase.Branch.Type.html#headHash"><span class="hs-identifier hs-var">Branch.headHash</span></a></span><span> </span><span class="annot"><span class="annottext">Branch Any
forall (m :: * -&gt; *). Branch m
</span><a href="#local-6989586621680535827"><span class="hs-identifier hs-var">emptyBranch</span></a></span><span>
</span><span id="line-783"></span><span>  </span><span id="local-6989586621680535831"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680535831"><span class="hs-identifier hs-var">causalHashId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CausalHash -&gt; Transaction CausalHashId
</span><span class="hs-identifier hs-var">Q.expectCausalHashIdByCausalHash</span></span><span> </span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680535829"><span class="hs-identifier hs-var">causalHash</span></a></span><span>
</span><span id="line-784"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHash
</span><a href="#local-6989586621680535829"><span class="hs-identifier hs-var">causalHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680535831"><span class="hs-identifier hs-var">causalHashId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-785"></span></pre></body></html>