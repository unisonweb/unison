<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE QuasiQuotes #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrateSchema3To4"><span class="hs-identifier">migrateSchema3To4</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Generics.Product</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Semigroup</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set.Lens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">setOf</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Branch.Format</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S.BranchFormat</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Branch.Full</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DBBranch</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.DbId</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DB</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.LocalizeObject</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S.LocalizeObject</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Operations</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ops</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Queries</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Serialization</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sync</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sync</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Util.Serialization</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.Helpers.html"><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Migrations.Helpers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.Helpers.html#abortMigration"><span class="hs-identifier">abortMigration</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.DbHelpers.html"><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.DbHelpers</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Helpers</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Debug</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Debug</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Sqlite</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">log</span></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">data</span><span> </span><span id="MigrationState"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-var">MigrationState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MigrationState"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-var">MigrationState</span></a></span></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- A mapping from a causal hash to the _corrected_ and _canonicalized_ branch hash and</span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-comment">-- object.</span><span>
</span><span id="line-32"></span><span>    </span><span id="%24sel%3A_canonicalBranchForCausalHashId%3AMigrationState"><span class="annot"><span class="annottext">MigrationState -&gt; Map CausalHashId (BranchHashId, BranchObjectId)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#%24sel%3A_canonicalBranchForCausalHashId%3AMigrationState"><span class="hs-identifier hs-var hs-var">_canonicalBranchForCausalHashId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.CausalHashId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DB.BranchHashId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchObjectId</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-comment">-- A mapping of branch hashes which were found to be correct and don't need to be</span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-comment">-- re-hashed/re-canonicalized, it allows us to skip some redundant work.</span><span>
</span><span id="line-35"></span><span>    </span><span id="%24sel%3A_validBranchHashIds%3AMigrationState"><span class="annot"><span class="annottext">MigrationState -&gt; Map BranchHashId BranchObjectId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#%24sel%3A_validBranchHashIds%3AMigrationState"><span class="hs-identifier hs-var hs-var">_validBranchHashIds</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchHashId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchObjectId</span></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span id="%24sel%3A_numMigrated%3AMigrationState"><span class="annot"><span class="annottext">MigrationState -&gt; Int
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#%24sel%3A_numMigrated%3AMigrationState"><span class="hs-identifier hs-var hs-var">_numMigrated</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680477007"><span id="local-6989586621680477009"><span class="annot"><span class="annottext">(forall x. MigrationState -&gt; Rep MigrationState x)
-&gt; (forall x. Rep MigrationState x -&gt; MigrationState)
-&gt; Generic MigrationState
forall x. Rep MigrationState x -&gt; MigrationState
forall x. MigrationState -&gt; Rep MigrationState x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cfrom :: forall x. MigrationState -&gt; Rep MigrationState x
from :: forall x. MigrationState -&gt; Rep MigrationState x
$cto :: forall x. Rep MigrationState x -&gt; MigrationState
to :: forall x. Rep MigrationState x -&gt; MigrationState
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#canonicalBranchForCausalHashId"><span class="hs-identifier hs-type">canonicalBranchForCausalHashId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Lens'</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.CausalHashId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DB.BranchHashId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchObjectId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span id="canonicalBranchForCausalHashId"><span class="annot"><span class="annottext">canonicalBranchForCausalHashId :: Lens'
  MigrationState (Map CausalHashId (BranchHashId, BranchObjectId))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#canonicalBranchForCausalHashId"><span class="hs-identifier hs-var hs-var">canonicalBranchForCausalHashId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_canonicalBranchForCausalHashId&quot;</span></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#validBranchHashIds"><span class="hs-identifier hs-type">validBranchHashIds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Lens'</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchHashId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchObjectId</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span id="validBranchHashIds"><span class="annot"><span class="annottext">validBranchHashIds :: Lens' MigrationState (Map BranchHashId BranchObjectId)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#validBranchHashIds"><span class="hs-identifier hs-var hs-var">validBranchHashIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_validBranchHashIds&quot;</span></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#numMigrated"><span class="hs-identifier hs-type">numMigrated</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Lens'</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-49"></span><span id="numMigrated"><span class="annot"><span class="annottext">numMigrated :: Lens' MigrationState Int
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#numMigrated"><span class="hs-identifier hs-var hs-var">numMigrated</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-50"></span><span>  </span><span class="annot"><span class="annottext">forall (field :: Symbol) s t a b.
HasField field s t a b =&gt;
Lens s t a b
</span><span class="hs-identifier hs-var">field</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;_numMigrated&quot;</span></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-comment">-- | There was a bug in previous versions of UCM which incorrectly used causal hashes as branch hashes.</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- This remained undetected because there was never a need for this hash to be verifiable,</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- and the hashes were still unique because the namespace hash was PART of the causal hash.</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- It did however result in many identical branches being stored multiple times under</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- different `primary_hash_id`s.</span><span>
</span><span id="line-57"></span><span class="hs-comment">--</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- However, with the advent of Share and Sync, we now need to correctly verify these namespace</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- hashes.</span><span>
</span><span id="line-60"></span><span class="hs-comment">--</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- This migration fixes the issue by re-hashing namespace objects where the value_hash_id of a</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- causal matches the self_hash_id.</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- Luckily this doesn't change any causal hashes.</span><span>
</span><span id="line-64"></span><span class="hs-comment">--</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- However, due to the possibility of multiple identical objects stored under different</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- `primary_hash_id`s, we may now have multiple objects with the same `primary_hash_id`, which</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- our DB schema doesn't allow.</span><span>
</span><span id="line-68"></span><span class="hs-comment">--</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- To address this, we keep exactly one 'canonical' object for each hash, then remap all</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- references to old objects into this canonical object instead. Unfortunately this requires</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- mapping over every branch object and traversing the child references.</span><span>
</span><span id="line-72"></span><span class="hs-comment">--</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- It was also discovered that some developers had many branches which referenced objects</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- which weren't in their codebase. We're not yet sure how this happened, but it's unlikely</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- to be the case for most end users, and it turned out that these references were in causals</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- and branches which were unreachable from the root namespace. As a fix, this migration also</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- tracks every causal and branch which is reachable from the root namespace and deletes all</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- causals and namespaces which are unreachable. Note that this may orphan some definitions,</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- patches, etc. which were previously referenced in an 'unreachable' branch, but they were</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- already floating around in an unreachable state.</span><span>
</span><span id="line-81"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrateSchema3To4"><span class="hs-identifier hs-type">migrateSchema3To4</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span id="migrateSchema3To4"><span class="annot"><span class="annottext">migrateSchema3To4 :: Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrateSchema3To4"><span class="hs-identifier hs-var hs-var">migrateSchema3To4</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-83"></span><span>  </span><span class="annot"><span class="annottext">SchemaVersion -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Q.expectSchemaVersion</span></span><span> </span><span class="annot"><span class="annottext">SchemaVersion
</span><span class="hs-number">3</span></span><span>
</span><span id="line-84"></span><span>  </span><span id="local-6989586621680477121"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477121"><span class="hs-identifier hs-var">rootCausalHashId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction CausalHashId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#expectNamespaceRoot"><span class="hs-identifier hs-var">expectNamespaceRoot</span></a></span><span>
</span><span id="line-85"></span><span>  </span><span id="local-6989586621680477123"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680477123"><span class="hs-identifier hs-var">totalCausals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction Int
</span><a href="#local-6989586621680477124"><span class="hs-identifier hs-var">causalCount</span></a></span><span>
</span><span id="line-86"></span><span>  </span><span id="local-6989586621680477125"><span class="annot"><span class="annottext">MigrationState
</span><a href="#local-6989586621680477125"><span class="hs-identifier hs-var">migrationState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction ()
 -&gt; MigrationState -&gt; Transaction MigrationState)
-&gt; MigrationState
-&gt; StateT MigrationState Transaction ()
-&gt; Transaction MigrationState
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction ()
-&gt; MigrationState -&gt; Transaction MigrationState
forall (m :: * -&gt; *) s a. Monad m =&gt; StateT s m a -&gt; s -&gt; m s
</span><span class="hs-identifier hs-var">execStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map CausalHashId (BranchHashId, BranchObjectId)
-&gt; Map BranchHashId BranchObjectId -&gt; Int -&gt; MigrationState
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-var">MigrationState</span></a></span><span> </span><span class="annot"><span class="annottext">Map CausalHashId (BranchHashId, BranchObjectId)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Map BranchHashId BranchObjectId
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction ()
 -&gt; Transaction MigrationState)
-&gt; StateT MigrationState Transaction ()
-&gt; Transaction MigrationState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Sync (StateT MigrationState Transaction) CausalHashId
-&gt; Progress (StateT MigrationState Transaction) CausalHashId
-&gt; [CausalHashId]
-&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) h.
(Monad m, Show h) =&gt;
Sync m h -&gt; Progress m h -&gt; [h] -&gt; m ()
</span><span class="hs-identifier hs-var">Sync.sync</span></span><span> </span><span class="annot"><span class="annottext">Sync (StateT MigrationState Transaction) CausalHashId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrationSync"><span class="hs-identifier hs-var">migrationSync</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Progress (StateT MigrationState Transaction) CausalHashId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrationProgress"><span class="hs-identifier hs-var">migrationProgress</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680477123"><span class="hs-identifier hs-var">totalCausals</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477121"><span class="hs-identifier hs-var">rootCausalHashId</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:_canonicalBranchForCausalHashId:MigrationState :: MigrationState -&gt; Map CausalHashId (BranchHashId, BranchObjectId)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#%24sel%3A_canonicalBranchForCausalHashId%3AMigrationState"><span class="hs-identifier hs-var">_canonicalBranchForCausalHashId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621680477131"><span class="annot"><span class="annottext">Map CausalHashId (BranchHashId, BranchObjectId)
</span><a href="#local-6989586621680477131"><span class="hs-identifier hs-var">mapping</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MigrationState
</span><a href="#local-6989586621680477125"><span class="hs-identifier hs-var">migrationState</span></a></span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680477132"><span class="annot"><span class="annottext">reachableCausalHashes :: Set CausalHashId
</span><a href="#local-6989586621680477132"><span class="hs-identifier hs-var hs-var">reachableCausalHashes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map CausalHashId (BranchHashId, BranchObjectId) -&gt; Set CausalHashId
forall k a. Map k a -&gt; Set k
</span><span class="hs-identifier hs-var">Map.keysSet</span></span><span> </span><span class="annot"><span class="annottext">Map CausalHashId (BranchHashId, BranchObjectId)
</span><a href="#local-6989586621680477131"><span class="hs-identifier hs-var">mapping</span></a></span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680477134"><span class="annot"><span class="annottext">reachableBranchObjIds :: Set BranchObjectId
</span><a href="#local-6989586621680477134"><span class="hs-identifier hs-var hs-var">reachableBranchObjIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Getting
  (Set BranchObjectId)
  (Map CausalHashId (BranchHashId, BranchObjectId))
  BranchObjectId
-&gt; Map CausalHashId (BranchHashId, BranchObjectId)
-&gt; Set BranchObjectId
forall a s. Getting (Set a) s a -&gt; s -&gt; Set a
</span><span class="hs-identifier hs-var">setOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((BranchHashId, BranchObjectId)
 -&gt; Const (Set BranchObjectId) (BranchHashId, BranchObjectId))
-&gt; Map CausalHashId (BranchHashId, BranchObjectId)
-&gt; Const
     (Set BranchObjectId)
     (Map CausalHashId (BranchHashId, BranchObjectId))
forall (f :: * -&gt; *) a b.
Traversable f =&gt;
IndexedTraversal Int (f a) (f b) a b
IndexedTraversal
  Int
  (Map CausalHashId (BranchHashId, BranchObjectId))
  (Map CausalHashId (BranchHashId, BranchObjectId))
  (BranchHashId, BranchObjectId)
  (BranchHashId, BranchObjectId)
</span><span class="hs-identifier hs-var">traversed</span></span><span> </span><span class="annot"><span class="annottext">(((BranchHashId, BranchObjectId)
  -&gt; Const (Set BranchObjectId) (BranchHashId, BranchObjectId))
 -&gt; Map CausalHashId (BranchHashId, BranchObjectId)
 -&gt; Const
      (Set BranchObjectId)
      (Map CausalHashId (BranchHashId, BranchObjectId)))
-&gt; ((BranchObjectId -&gt; Const (Set BranchObjectId) BranchObjectId)
    -&gt; (BranchHashId, BranchObjectId)
    -&gt; Const (Set BranchObjectId) (BranchHashId, BranchObjectId))
-&gt; Getting
     (Set BranchObjectId)
     (Map CausalHashId (BranchHashId, BranchObjectId))
     BranchObjectId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(BranchObjectId -&gt; Const (Set BranchObjectId) BranchObjectId)
-&gt; (BranchHashId, BranchObjectId)
-&gt; Const (Set BranchObjectId) (BranchHashId, BranchObjectId)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
Lens
  (BranchHashId, BranchObjectId)
  (BranchHashId, BranchObjectId)
  BranchObjectId
  BranchObjectId
</span><span class="hs-identifier hs-var">_2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map CausalHashId (BranchHashId, BranchObjectId)
</span><a href="#local-6989586621680477131"><span class="hs-identifier hs-var">mapping</span></a></span><span>
</span><span id="line-90"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Transaction ()) -&gt; String -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&#128736;  Cleaning up unreachable branches and causals...&quot;</span></span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><span class="annottext">Set CausalHashId -&gt; Set BranchObjectId -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#dropUnreachableCausalsAndBranches"><span class="hs-identifier hs-var">dropUnreachableCausalsAndBranches</span></a></span><span> </span><span class="annot"><span class="annottext">Set CausalHashId
</span><a href="#local-6989586621680477132"><span class="hs-identifier hs-var">reachableCausalHashes</span></a></span><span> </span><span class="annot"><span class="annottext">Set BranchObjectId
</span><a href="#local-6989586621680477134"><span class="hs-identifier hs-var">reachableBranchObjIds</span></a></span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><span class="annottext">SchemaVersion -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Q.setSchemaVersion</span></span><span> </span><span class="annot"><span class="annottext">SchemaVersion
</span><span class="hs-number">4</span></span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><a href="#local-6989586621680477124"><span class="hs-identifier hs-type">causalCount</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-95"></span><span>    </span><span id="local-6989586621680477124"><span class="annot"><span class="annottext">causalCount :: Transaction Int
</span><a href="#local-6989586621680477124"><span class="hs-identifier hs-var hs-var">causalCount</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-96"></span><span>      </span><span class="annot"><span class="annottext">Sql -&gt; Transaction Int
forall a. (FromField a, HasCallStack) =&gt; Sql -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.queryOneCol</span></span><span>
</span><span id="line-97"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
          SELECT count(*) FROM causal;
        |]</span></span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#expectNamespaceRoot"><span class="hs-identifier hs-type">expectNamespaceRoot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.CausalHashId</span></span><span>
</span><span id="line-102"></span><span id="expectNamespaceRoot"><span class="annot"><span class="annottext">expectNamespaceRoot :: Transaction CausalHashId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#expectNamespaceRoot"><span class="hs-identifier hs-var hs-var">expectNamespaceRoot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="annottext">Sql -&gt; Transaction CausalHashId
forall a. (FromField a, HasCallStack) =&gt; Sql -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.queryOneCol</span></span><span> </span><span class="annot"><span class="annottext">Sql
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#loadNamespaceRootSql"><span class="hs-identifier hs-var">loadNamespaceRootSql</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#loadNamespaceRootSql"><span class="hs-identifier hs-type">loadNamespaceRootSql</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Sql</span></span><span>
</span><span id="line-106"></span><span id="loadNamespaceRootSql"><span class="annot"><span class="annottext">loadNamespaceRootSql :: Sql
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#loadNamespaceRootSql"><span class="hs-identifier hs-var hs-var">loadNamespaceRootSql</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><span class="">[Sqlite.sql|
    SELECT causal_id
    FROM namespace_root
  |]</span></span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrationProgress"><span class="hs-identifier hs-type">migrationProgress</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sync.Progress</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.CausalHashId</span></span><span>
</span><span id="line-113"></span><span id="migrationProgress"><span class="annot"><span class="annottext">migrationProgress :: Int -&gt; Progress (StateT MigrationState Transaction) CausalHashId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrationProgress"><span class="hs-identifier hs-var hs-var">migrationProgress</span></a></span></span><span> </span><span id="local-6989586621680477145"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680477145"><span class="hs-identifier hs-var">totalCausals</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Sync.Progress</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">CausalHashId -&gt; StateT MigrationState Transaction ()
forall {t :: (* -&gt; *) -&gt; * -&gt; *} {a}.
(MonadTrans t, Show a) =&gt;
a -&gt; t Transaction ()
need :: forall {t :: (* -&gt; *) -&gt; * -&gt; *} {a}.
(MonadTrans t, Show a) =&gt;
a -&gt; t Transaction ()
need :: CausalHashId -&gt; StateT MigrationState Transaction ()
</span><a href="#local-6989586621680477147"><span class="hs-identifier hs-var hs-var">Sync.need</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CausalHashId -&gt; StateT MigrationState Transaction ()
done :: CausalHashId -&gt; StateT MigrationState Transaction ()
done :: CausalHashId -&gt; StateT MigrationState Transaction ()
</span><a href="#local-6989586621680477149"><span class="hs-identifier hs-var hs-var">Sync.done</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CausalHashId -&gt; StateT MigrationState Transaction ()
forall {t :: (* -&gt; *) -&gt; * -&gt; *} {a}.
(MonadTrans t, Show a) =&gt;
a -&gt; t Transaction ()
error :: forall {t :: (* -&gt; *) -&gt; * -&gt; *} {a}.
(MonadTrans t, Show a) =&gt;
a -&gt; t Transaction ()
error :: CausalHashId -&gt; StateT MigrationState Transaction ()
</span><a href="#local-6989586621680477151"><span class="hs-identifier hs-var hs-var">Sync.error</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction ()
allDone :: StateT MigrationState Transaction ()
allDone :: StateT MigrationState Transaction ()
</span><a href="#local-6989586621680477153"><span class="hs-identifier hs-var hs-var">Sync.allDone</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-116"></span><span>    </span><span id="local-6989586621680477147"><span class="annot"><span class="annottext">need :: a -&gt; t Transaction ()
</span><a href="#local-6989586621680477147"><span class="hs-identifier hs-var hs-var">need</span></a></span></span><span> </span><span id="local-6989586621680477170"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680477170"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Transaction () -&gt; t Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction () -&gt; t Transaction ())
-&gt; Transaction () -&gt; t Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#debugLog"><span class="hs-identifier hs-var">debugLog</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Transaction ()) -&gt; String -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Need &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680477170"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span id="local-6989586621680477149"><span class="annot"><span class="annottext">done :: CausalHashId -&gt; StateT MigrationState Transaction ()
</span><a href="#local-6989586621680477149"><span class="hs-identifier hs-var hs-var">done</span></a></span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-118"></span><span>      </span><span class="hs-keyword">do</span><span>
</span><span id="line-119"></span><span>        </span><span id="local-6989586621680477174"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680477174"><span class="hs-identifier hs-var">numDone</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; (Int, Int)) -&gt; MigrationState -&gt; (Int, MigrationState)
Lens' MigrationState Int
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#numMigrated"><span class="hs-identifier hs-var">numMigrated</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; (Int, Int)) -&gt; MigrationState -&gt; (Int, MigrationState))
-&gt; Int -&gt; StateT MigrationState Transaction Int
forall s (m :: * -&gt; *) a.
(MonadState s m, Num a) =&gt;
LensLike' ((,) a) s a -&gt; a -&gt; m a
</span><span class="hs-operator hs-var">&lt;+=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-120"></span><span>        </span><span class="annot"><span class="annottext">Transaction () -&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction () -&gt; StateT MigrationState Transaction ())
-&gt; Transaction () -&gt; StateT MigrationState Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Transaction ()) -&gt; IO () -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStr</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\r&#127959;  &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680477174"><span class="hs-identifier hs-var">numDone</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; / ~&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680477145"><span class="hs-identifier hs-var">totalCausals</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; entities migrated. &#128679;&quot;</span></span><span>
</span><span id="line-121"></span><span>    </span><span id="local-6989586621680477151"><span class="annot"><span class="annottext">error :: a -&gt; t Transaction ()
</span><a href="#local-6989586621680477151"><span class="hs-identifier hs-var hs-var">error</span></a></span></span><span> </span><span id="local-6989586621680477190"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680477190"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Transaction () -&gt; t Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; t m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction () -&gt; t Transaction ())
-&gt; (String -&gt; Transaction ()) -&gt; String -&gt; t Transaction ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#log"><span class="hs-identifier hs-var">log</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; t Transaction ()) -&gt; String -&gt; t Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Error &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680477190"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span id="local-6989586621680477153"><span class="annot"><span class="annottext">allDone :: StateT MigrationState Transaction ()
</span><a href="#local-6989586621680477153"><span class="hs-identifier hs-var hs-var">allDone</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-123"></span><span>      </span><span class="hs-comment">-- In some corrupted codebases we don't necessarily process every causal, or there may</span><span>
</span><span id="line-124"></span><span>      </span><span class="hs-comment">-- be unreachable causals. We'll show the final number here just so everything looks</span><span>
</span><span id="line-125"></span><span>      </span><span class="hs-comment">-- good to users. It's okay since we'll process the other branches and clean them up in</span><span>
</span><span id="line-126"></span><span>      </span><span class="hs-comment">-- a batch step.</span><span>
</span><span id="line-127"></span><span>      </span><span class="annot"><span class="annottext">Transaction () -&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction () -&gt; StateT MigrationState Transaction ())
-&gt; Transaction () -&gt; StateT MigrationState Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Transaction ()) -&gt; IO () -&gt; Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\r&#127959;  &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680477145"><span class="hs-identifier hs-var">totalCausals</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; / ~&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680477145"><span class="hs-identifier hs-var">totalCausals</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; entities migrated. &#128679;&quot;</span></span><span>
</span><span id="line-128"></span><span>      </span><span class="annot"><span class="annottext">Transaction () -&gt; StateT MigrationState Transaction ()
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(Transaction () -&gt; StateT MigrationState Transaction ())
-&gt; (String -&gt; Transaction ())
-&gt; String
-&gt; StateT MigrationState Transaction ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Transaction ())
-&gt; (String -&gt; IO ()) -&gt; String -&gt; Transaction ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; StateT MigrationState Transaction ())
-&gt; String -&gt; StateT MigrationState Transaction ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Finished.&quot;</span></span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrationSync"><span class="hs-identifier hs-type">migrationSync</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sync.Sync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.CausalHashId</span></span><span>
</span><span id="line-131"></span><span id="migrationSync"><span class="annot"><span class="annottext">migrationSync :: Sync (StateT MigrationState Transaction) CausalHashId
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrationSync"><span class="hs-identifier hs-var hs-var">migrationSync</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-132"></span><span>  </span><span class="annot"><span class="annottext">(CausalHashId
 -&gt; StateT MigrationState Transaction (TrySyncResult CausalHashId))
-&gt; Sync (StateT MigrationState Transaction) CausalHashId
forall (m :: * -&gt; *) entity.
(entity -&gt; m (TrySyncResult entity)) -&gt; Sync m entity
</span><span class="hs-identifier hs-var">Sync.Sync</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680477193"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477193"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
-&gt; StateT
     MigrationState Transaction (Either (TrySyncResult CausalHashId) ())
forall e (m :: * -&gt; *) a. ExceptT e m a -&gt; m (Either e a)
</span><span class="hs-identifier hs-var">runExceptT</span></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
 -&gt; StateT
      MigrationState
      Transaction
      (Either (TrySyncResult CausalHashId) ()))
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
-&gt; StateT
     MigrationState Transaction (Either (TrySyncResult CausalHashId) ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrateCausal"><span class="hs-identifier hs-var">migrateCausal</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477193"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StateT
  MigrationState Transaction (Either (TrySyncResult CausalHashId) ())
-&gt; (Either (TrySyncResult CausalHashId) ()
    -&gt; StateT MigrationState Transaction (TrySyncResult CausalHashId))
-&gt; StateT MigrationState Transaction (TrySyncResult CausalHashId)
forall a b.
StateT MigrationState Transaction a
-&gt; (a -&gt; StateT MigrationState Transaction b)
-&gt; StateT MigrationState Transaction b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-134"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680477196"><span class="annot"><span class="annottext">TrySyncResult CausalHashId
</span><a href="#local-6989586621680477196"><span class="hs-identifier hs-var">syncResult</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TrySyncResult CausalHashId
-&gt; StateT MigrationState Transaction (TrySyncResult CausalHashId)
forall a. a -&gt; StateT MigrationState Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult CausalHashId
</span><a href="#local-6989586621680477196"><span class="hs-identifier hs-var">syncResult</span></a></span><span>
</span><span id="line-135"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TrySyncResult CausalHashId
-&gt; StateT MigrationState Transaction (TrySyncResult CausalHashId)
forall a. a -&gt; StateT MigrationState Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult CausalHashId
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Done</span></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span id="local-6989586621680476600"><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-type">liftT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="annot"><a href="#local-6989586621680476600"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sync.TrySyncResult</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.CausalHashId</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680476600"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-138"></span><span id="liftT"><span class="annot"><span class="annottext">liftT :: forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var hs-var">liftT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateT MigrationState Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
forall (m :: * -&gt; *) a.
Monad m =&gt;
m a -&gt; ExceptT (TrySyncResult CausalHashId) m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(StateT MigrationState Transaction a
 -&gt; ExceptT
      (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a)
-&gt; (Transaction a -&gt; StateT MigrationState Transaction a)
-&gt; Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Transaction a -&gt; StateT MigrationState Transaction a
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; StateT MigrationState m a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#dropUnreachableCausalsAndBranches"><span class="hs-identifier hs-type">dropUnreachableCausalsAndBranches</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.CausalHashId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchObjectId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span id="dropUnreachableCausalsAndBranches"><span class="annot"><span class="annottext">dropUnreachableCausalsAndBranches :: Set CausalHashId -&gt; Set BranchObjectId -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#dropUnreachableCausalsAndBranches"><span class="hs-identifier hs-var hs-var">dropUnreachableCausalsAndBranches</span></a></span></span><span> </span><span id="local-6989586621680477204"><span class="annot"><span class="annottext">Set CausalHashId
</span><a href="#local-6989586621680477204"><span class="hs-identifier hs-var">reachableCausals</span></a></span></span><span> </span><span id="local-6989586621680477205"><span class="annot"><span class="annottext">Set BranchObjectId
</span><a href="#local-6989586621680477205"><span class="hs-identifier hs-var">reachableBranchObjs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><a href="#local-6989586621680477206"><span class="hs-identifier hs-var">createReachabilityTables</span></a></span><span>
</span><span id="line-143"></span><span>  </span><span class="annot"><span class="annottext">(CausalHashId -&gt; Transaction ())
-&gt; Set CausalHashId -&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId -&gt; Transaction ()
forall {a}. ToField a =&gt; a -&gt; Transaction ()
</span><a href="#local-6989586621680477208"><span class="hs-identifier hs-var">insertReachableCausalSql</span></a></span><span> </span><span class="annot"><span class="annottext">Set CausalHashId
</span><a href="#local-6989586621680477204"><span class="hs-identifier hs-var">reachableCausals</span></a></span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><span class="annottext">(BranchObjectId -&gt; Transaction ())
-&gt; Set BranchObjectId -&gt; Transaction ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; Transaction ()
forall {a}. ToField a =&gt; a -&gt; Transaction ()
</span><a href="#local-6989586621680477209"><span class="hs-identifier hs-var">insertReachableBranchObjectSql</span></a></span><span> </span><span class="annot"><span class="annottext">Set BranchObjectId
</span><a href="#local-6989586621680477205"><span class="hs-identifier hs-var">reachableBranchObjs</span></a></span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><a href="#local-6989586621680477210"><span class="hs-identifier hs-var">deleteUnreachableHashObjects</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><a href="#local-6989586621680477211"><span class="hs-identifier hs-var">deleteUnreachableBranchObjects</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><a href="#local-6989586621680477212"><span class="hs-identifier hs-var">deleteUnreachableCausalParents</span></a></span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
</span><a href="#local-6989586621680477213"><span class="hs-identifier hs-var">deleteUnreachableCausals</span></a></span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-150"></span><span>    </span><span id="local-6989586621680477210"><span class="annot"><span class="annottext">deleteUnreachableHashObjects :: Transaction ()
</span><a href="#local-6989586621680477210"><span class="hs-identifier hs-var hs-var">deleteUnreachableHashObjects</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-152"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
        DELETE FROM hash_object AS ho
          WHERE
            NOT EXISTS (SELECT 1 FROM reachable_branch_objects AS ro WHERE ho.object_id = ro.object_id)
            -- Ensure hash objects we're deleting are for branch objects.
            AND EXISTS (SELECT 1 FROM object AS o WHERE o.id = ho.object_id AND type_id = 2)
      |]</span></span><span>
</span><span id="line-159"></span><span>    </span><span id="local-6989586621680477211"><span class="annot"><span class="annottext">deleteUnreachableBranchObjects :: Transaction ()
</span><a href="#local-6989586621680477211"><span class="hs-identifier hs-var hs-var">deleteUnreachableBranchObjects</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-160"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-161"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
        DELETE FROM object AS o
          WHERE
            o.type_id = 2 -- Filter for only branches
            AND NOT EXISTS (SELECT 1 FROM reachable_branch_objects AS ro WHERE o.id = ro.object_id)
      |]</span></span><span>
</span><span id="line-167"></span><span>    </span><span id="local-6989586621680477213"><span class="annot"><span class="annottext">deleteUnreachableCausals :: Transaction ()
</span><a href="#local-6989586621680477213"><span class="hs-identifier hs-var hs-var">deleteUnreachableCausals</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-168"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-169"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
        DELETE FROM causal AS c
          WHERE NOT EXISTS (SELECT 1 FROM reachable_causals AS rc WHERE c.self_hash_id = rc.self_hash_id)
      |]</span></span><span>
</span><span id="line-173"></span><span>    </span><span id="local-6989586621680477212"><span class="annot"><span class="annottext">deleteUnreachableCausalParents :: Transaction ()
</span><a href="#local-6989586621680477212"><span class="hs-identifier hs-var hs-var">deleteUnreachableCausalParents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-174"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-175"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
        DELETE FROM causal_parent AS cp
          WHERE
            -- We only need to check the children, because if it's impossible for a parent to be
            -- unreachable if the child is reachable. A.k.a. reachable(child) =implies&gt; reachable(parent)
            NOT EXISTS (SELECT 1 FROM reachable_causals AS rc WHERE cp.causal_id = rc.self_hash_id)
      |]</span></span><span>
</span><span id="line-182"></span><span>    </span><span id="local-6989586621680477208"><span class="annot"><span class="annottext">insertReachableCausalSql :: a -&gt; Transaction ()
</span><a href="#local-6989586621680477208"><span class="hs-identifier hs-var hs-var">insertReachableCausalSql</span></a></span></span><span> </span><span id="local-6989586621680477242"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680477242"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-183"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-184"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
          INSERT INTO reachable_causals (self_hash_id) VALUES (:h)
            ON CONFLICT DO NOTHING
        |]</span></span><span>
</span><span id="line-188"></span><span>    </span><span id="local-6989586621680477209"><span class="annot"><span class="annottext">insertReachableBranchObjectSql :: a -&gt; Transaction ()
</span><a href="#local-6989586621680477209"><span class="hs-identifier hs-var hs-var">insertReachableBranchObjectSql</span></a></span></span><span> </span><span id="local-6989586621680477251"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680477251"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-189"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-190"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
          INSERT INTO reachable_branch_objects (object_id) VALUES (:o)
            ON CONFLICT DO NOTHING
        |]</span></span><span>
</span><span id="line-194"></span><span>    </span><span id="local-6989586621680477206"><span class="annot"><span class="annottext">createReachabilityTables :: Transaction ()
</span><a href="#local-6989586621680477206"><span class="hs-identifier hs-var hs-var">createReachabilityTables</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-195"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-196"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
           CREATE TEMP TABLE IF NOT EXISTS reachable_branch_objects (
            object_id INTEGER PRIMARY KEY NOT NULL
           )
          |]</span></span><span>
</span><span id="line-201"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-202"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
           CREATE TEMP TABLE IF NOT EXISTS reachable_causals (
            self_hash_id INTEGER PRIMARY KEY NOT NULL
           )
          |]</span></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrateCausal"><span class="hs-identifier hs-type">migrateCausal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.CausalHashId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sync.TrySyncResult</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.CausalHashId</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span id="migrateCausal"><span class="annot"><span class="annottext">migrateCausal :: CausalHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#migrateCausal"><span class="hs-identifier hs-var hs-var">migrateCausal</span></a></span></span><span> </span><span id="local-6989586621680477263"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477263"><span class="hs-identifier hs-var">causalHashId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><span class="annottext">Getting
  (First (BranchHashId, BranchObjectId))
  MigrationState
  (BranchHashId, BranchObjectId)
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     (Maybe (BranchHashId, BranchObjectId))
forall s (m :: * -&gt; *) a.
MonadState s m =&gt;
Getting (First a) s a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">preuse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map CausalHashId (BranchHashId, BranchObjectId)
 -&gt; Const
      (First (BranchHashId, BranchObjectId))
      (Map CausalHashId (BranchHashId, BranchObjectId)))
-&gt; MigrationState
-&gt; Const (First (BranchHashId, BranchObjectId)) MigrationState
Lens'
  MigrationState (Map CausalHashId (BranchHashId, BranchObjectId))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#canonicalBranchForCausalHashId"><span class="hs-identifier hs-var">canonicalBranchForCausalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">((Map CausalHashId (BranchHashId, BranchObjectId)
  -&gt; Const
       (First (BranchHashId, BranchObjectId))
       (Map CausalHashId (BranchHashId, BranchObjectId)))
 -&gt; MigrationState
 -&gt; Const (First (BranchHashId, BranchObjectId)) MigrationState)
-&gt; (((BranchHashId, BranchObjectId)
     -&gt; Const
          (First (BranchHashId, BranchObjectId))
          (BranchHashId, BranchObjectId))
    -&gt; Map CausalHashId (BranchHashId, BranchObjectId)
    -&gt; Const
         (First (BranchHashId, BranchObjectId))
         (Map CausalHashId (BranchHashId, BranchObjectId)))
-&gt; Getting
     (First (BranchHashId, BranchObjectId))
     MigrationState
     (BranchHashId, BranchObjectId)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map CausalHashId (BranchHashId, BranchObjectId))
-&gt; Traversal'
     (Map CausalHashId (BranchHashId, BranchObjectId))
     (IxValue (Map CausalHashId (BranchHashId, BranchObjectId)))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (Map CausalHashId (BranchHashId, BranchObjectId))
CausalHashId
</span><a href="#local-6989586621680477263"><span class="hs-identifier hs-var">causalHashId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult CausalHashId)
  (StateT MigrationState Transaction)
  (Maybe (BranchHashId, BranchObjectId))
-&gt; (Maybe (BranchHashId, BranchObjectId)
    -&gt; ExceptT
         (TrySyncResult CausalHashId)
         (StateT MigrationState Transaction)
         ())
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b.
ExceptT
  (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
-&gt; (a
    -&gt; ExceptT
         (TrySyncResult CausalHashId) (StateT MigrationState Transaction) b)
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">(BranchHashId, BranchObjectId)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TrySyncResult CausalHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
TrySyncResult CausalHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult CausalHashId
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.PreviouslyDone</span></span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><span class="annottext">Maybe (BranchHashId, BranchObjectId)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-213"></span><span>      </span><span id="local-6989586621680477268"><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680477268"><span class="hs-identifier hs-var">causalParents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction [CausalHashId]
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     [CausalHashId]
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction [CausalHashId]
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      [CausalHashId])
-&gt; Transaction [CausalHashId]
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     [CausalHashId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId -&gt; Transaction [CausalHashId]
</span><span class="hs-identifier hs-var">Q.loadCausalParents</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477263"><span class="hs-identifier hs-var">causalHashId</span></a></span><span>
</span><span id="line-214"></span><span>      </span><span id="local-6989586621680477270"><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680477270"><span class="hs-identifier hs-var">unmigratedParents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((CausalHashId
  -&gt; ExceptT
       (TrySyncResult CausalHashId)
       (StateT MigrationState Transaction)
       Bool)
 -&gt; [CausalHashId]
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      [CausalHashId])
-&gt; [CausalHashId]
-&gt; (CausalHashId
    -&gt; ExceptT
         (TrySyncResult CausalHashId)
         (StateT MigrationState Transaction)
         Bool)
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     [CausalHashId]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">(CausalHashId
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      Bool)
-&gt; [CausalHashId]
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     [CausalHashId]
forall (m :: * -&gt; *) a.
Applicative m =&gt;
(a -&gt; m Bool) -&gt; [a] -&gt; m [a]
</span><span class="hs-identifier hs-var">filterM</span></span><span> </span><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680477268"><span class="hs-identifier hs-var">causalParents</span></a></span><span> </span><span class="annot"><span class="annottext">((CausalHashId
  -&gt; ExceptT
       (TrySyncResult CausalHashId)
       (StateT MigrationState Transaction)
       Bool)
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      [CausalHashId])
-&gt; (CausalHashId
    -&gt; ExceptT
         (TrySyncResult CausalHashId)
         (StateT MigrationState Transaction)
         Bool)
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     [CausalHashId]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680477272"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477272"><span class="hs-identifier hs-var">parentHashId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LensLike'
  (Const Bool)
  MigrationState
  (Map CausalHashId (BranchHashId, BranchObjectId))
-&gt; (Map CausalHashId (BranchHashId, BranchObjectId) -&gt; Bool)
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     Bool
forall s (m :: * -&gt; *) r a.
MonadState s m =&gt;
LensLike' (Const r) s a -&gt; (a -&gt; r) -&gt; m r
</span><span class="hs-identifier hs-var">uses</span></span><span> </span><span class="annot"><span class="annottext">LensLike'
  (Const Bool)
  MigrationState
  (Map CausalHashId (BranchHashId, BranchObjectId))
Lens'
  MigrationState (Map CausalHashId (BranchHashId, BranchObjectId))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#canonicalBranchForCausalHashId"><span class="hs-identifier hs-var">canonicalBranchForCausalHashId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHashId
-&gt; Map CausalHashId (BranchHashId, BranchObjectId) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">Map.notMember</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477272"><span class="hs-identifier hs-var">parentHashId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>      </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; ([CausalHashId] -&gt; Bool) -&gt; [CausalHashId] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[CausalHashId] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([CausalHashId] -&gt; Bool) -&gt; [CausalHashId] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680477270"><span class="hs-identifier hs-var">unmigratedParents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult CausalHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
TrySyncResult CausalHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CausalHashId] -&gt; TrySyncResult CausalHashId
forall entity. [entity] -&gt; TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Missing</span></span><span> </span><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680477270"><span class="hs-identifier hs-var">unmigratedParents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>      </span><span id="local-6989586621680477279"><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477279"><span class="hs-identifier hs-var">valueHashId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction BranchHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     BranchHashId
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction BranchHashId
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      BranchHashId)
-&gt; Transaction BranchHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     BranchHashId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId -&gt; Transaction BranchHashId
</span><span class="hs-identifier hs-var">Q.expectCausalValueHashId</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477263"><span class="hs-identifier hs-var">causalHashId</span></a></span><span>
</span><span id="line-217"></span><span>      </span><span class="annot"><span class="annottext">Getting (First BranchObjectId) MigrationState BranchObjectId
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     (Maybe BranchObjectId)
forall s (m :: * -&gt; *) a.
MonadState s m =&gt;
Getting (First a) s a -&gt; m (Maybe a)
</span><span class="hs-identifier hs-var">preuse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map BranchHashId BranchObjectId
 -&gt; Const (First BranchObjectId) (Map BranchHashId BranchObjectId))
-&gt; MigrationState -&gt; Const (First BranchObjectId) MigrationState
Lens' MigrationState (Map BranchHashId BranchObjectId)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#validBranchHashIds"><span class="hs-identifier hs-var">validBranchHashIds</span></a></span><span> </span><span class="annot"><span class="annottext">((Map BranchHashId BranchObjectId
  -&gt; Const (First BranchObjectId) (Map BranchHashId BranchObjectId))
 -&gt; MigrationState -&gt; Const (First BranchObjectId) MigrationState)
-&gt; ((BranchObjectId -&gt; Const (First BranchObjectId) BranchObjectId)
    -&gt; Map BranchHashId BranchObjectId
    -&gt; Const (First BranchObjectId) (Map BranchHashId BranchObjectId))
-&gt; Getting (First BranchObjectId) MigrationState BranchObjectId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map BranchHashId BranchObjectId)
-&gt; Traversal'
     (Map BranchHashId BranchObjectId)
     (IxValue (Map BranchHashId BranchObjectId))
forall m. Ixed m =&gt; Index m -&gt; Traversal' m (IxValue m)
</span><span class="hs-identifier hs-var">ix</span></span><span> </span><span class="annot"><span class="annottext">Index (Map BranchHashId BranchObjectId)
BranchHashId
</span><a href="#local-6989586621680477279"><span class="hs-identifier hs-var">valueHashId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult CausalHashId)
  (StateT MigrationState Transaction)
  (Maybe BranchObjectId)
-&gt; (Maybe BranchObjectId
    -&gt; ExceptT
         (TrySyncResult CausalHashId)
         (StateT MigrationState Transaction)
         ())
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b.
ExceptT
  (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
-&gt; (a
    -&gt; ExceptT
         (TrySyncResult CausalHashId) (StateT MigrationState Transaction) b)
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-218"></span><span>        </span><span class="annot"><span class="annottext">Maybe BranchObjectId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680477281"><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477281"><span class="hs-identifier hs-var">objId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>          </span><span class="annot"><span class="annottext">(Map CausalHashId (BranchHashId, BranchObjectId)
 -&gt; Identity (Map CausalHashId (BranchHashId, BranchObjectId)))
-&gt; MigrationState -&gt; Identity MigrationState
Lens'
  MigrationState (Map CausalHashId (BranchHashId, BranchObjectId))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#canonicalBranchForCausalHashId"><span class="hs-identifier hs-var">canonicalBranchForCausalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">((Map CausalHashId (BranchHashId, BranchObjectId)
  -&gt; Identity (Map CausalHashId (BranchHashId, BranchObjectId)))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; ((Maybe (BranchHashId, BranchObjectId)
     -&gt; Identity (Maybe (BranchHashId, BranchObjectId)))
    -&gt; Map CausalHashId (BranchHashId, BranchObjectId)
    -&gt; Identity (Map CausalHashId (BranchHashId, BranchObjectId)))
-&gt; (Maybe (BranchHashId, BranchObjectId)
    -&gt; Identity (Maybe (BranchHashId, BranchObjectId)))
-&gt; MigrationState
-&gt; Identity MigrationState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map CausalHashId (BranchHashId, BranchObjectId))
-&gt; Lens'
     (Map CausalHashId (BranchHashId, BranchObjectId))
     (Maybe (IxValue (Map CausalHashId (BranchHashId, BranchObjectId))))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map CausalHashId (BranchHashId, BranchObjectId))
CausalHashId
</span><a href="#local-6989586621680477263"><span class="hs-identifier hs-var">causalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (BranchHashId, BranchObjectId)
  -&gt; Identity (Maybe (BranchHashId, BranchObjectId)))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; (BranchHashId, BranchObjectId)
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a (Maybe b) -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">?=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477279"><span class="hs-identifier hs-var">valueHashId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477281"><span class="hs-identifier hs-var">objId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>          </span><span class="annot"><span class="annottext">TrySyncResult CausalHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
TrySyncResult CausalHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult CausalHashId
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Done</span></span><span>
</span><span id="line-222"></span><span>      </span><span class="annot"><span class="annottext">Transaction (Maybe BranchObjectId)
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     (Maybe BranchObjectId)
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CausalHashId -&gt; Transaction (Maybe BranchObjectId)
</span><span class="hs-identifier hs-var">Q.loadBranchObjectIdByCausalHashId</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477263"><span class="hs-identifier hs-var">causalHashId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExceptT
  (TrySyncResult CausalHashId)
  (StateT MigrationState Transaction)
  (Maybe BranchObjectId)
-&gt; (Maybe BranchObjectId
    -&gt; ExceptT
         (TrySyncResult CausalHashId)
         (StateT MigrationState Transaction)
         ())
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b.
ExceptT
  (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
-&gt; (a
    -&gt; ExceptT
         (TrySyncResult CausalHashId) (StateT MigrationState Transaction) b)
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-223"></span><span>        </span><span class="annot"><span class="annottext">Maybe BranchObjectId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-224"></span><span>          </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; (String -&gt; Transaction ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Transaction ()
forall a. String -&gt; Transaction a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.Helpers.html#abortMigration"><span class="hs-identifier hs-var">abortMigration</span></a></span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Missing object for child branch of causal: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477263"><span class="hs-identifier hs-var">causalHashId</span></a></span><span>
</span><span id="line-225"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680477285"><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477285"><span class="hs-identifier hs-var">branchObjId</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-226"></span><span>          </span><span class="annot"><span class="annottext">CausalHashId
-&gt; BranchHashId
-&gt; BranchObjectId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#rehashAndCanonicalizeNamespace"><span class="hs-identifier hs-var">rehashAndCanonicalizeNamespace</span></a></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477263"><span class="hs-identifier hs-var">causalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477279"><span class="hs-identifier hs-var">valueHashId</span></a></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477285"><span class="hs-identifier hs-var">branchObjId</span></a></span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#rehashAndCanonicalizeNamespace"><span class="hs-identifier hs-type">rehashAndCanonicalizeNamespace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.CausalHashId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchHashId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchObjectId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sync.TrySyncResult</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.CausalHashId</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span id="rehashAndCanonicalizeNamespace"><span class="annot"><span class="annottext">rehashAndCanonicalizeNamespace :: CausalHashId
-&gt; BranchHashId
-&gt; BranchObjectId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#rehashAndCanonicalizeNamespace"><span class="hs-identifier hs-var hs-var">rehashAndCanonicalizeNamespace</span></a></span></span><span> </span><span id="local-6989586621680477287"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477287"><span class="hs-identifier hs-var">causalHashId</span></a></span></span><span> </span><span id="local-6989586621680477288"><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477288"><span class="hs-identifier hs-var">possiblyIncorrectNamespaceHashId</span></a></span></span><span> </span><span id="local-6989586621680477289"><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>  </span><span id="local-6989586621680477290"><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680477290"><span class="hs-identifier hs-var">dbBranch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction DbBranch
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     DbBranch
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction DbBranch
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      DbBranch)
-&gt; Transaction DbBranch
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     DbBranch
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; Transaction DbBranch
</span><span class="hs-identifier hs-var">Ops.expectDbBranch</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span>
</span><span id="line-231"></span><span>  </span><span id="local-6989586621680477292"><span class="annot"><span class="annottext">Map CausalHashId (BranchHashId, BranchObjectId)
</span><a href="#local-6989586621680477292"><span class="hs-identifier hs-var">canonicalBranchForCausalMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Getting
  (Map CausalHashId (BranchHashId, BranchObjectId))
  MigrationState
  (Map CausalHashId (BranchHashId, BranchObjectId))
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     (Map CausalHashId (BranchHashId, BranchObjectId))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; Getting a s a -&gt; m a
</span><span class="hs-identifier hs-var">use</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Map CausalHashId (BranchHashId, BranchObjectId))
  MigrationState
  (Map CausalHashId (BranchHashId, BranchObjectId))
Lens'
  MigrationState (Map CausalHashId (BranchHashId, BranchObjectId))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#canonicalBranchForCausalHashId"><span class="hs-identifier hs-var">canonicalBranchForCausalHashId</span></a></span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-comment">-- remap all of the object ID's of the child branches to the correct and canonical objects,</span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-comment">-- get a list of any unmigrated children, and also track whether any re-mappings actually</span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-comment">-- occurred, so we don't do extra work when nothing changed.</span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621680477294"><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680477294"><span class="hs-identifier hs-var">unmigratedChildren</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Any</span></span><span> </span><span id="local-6989586621680477296"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680477296"><span class="hs-identifier hs-var">changes</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621680477297"><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680477297"><span class="hs-identifier hs-var">remappedBranch</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-236"></span><span>        </span><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680477290"><span class="hs-identifier hs-var">dbBranch</span></a></span><span>
</span><span id="line-237"></span><span>          </span><span class="annot"><span class="annottext">DbBranch
-&gt; (DbBranch -&gt; (([CausalHashId], Any), DbBranch))
-&gt; (([CausalHashId], Any), DbBranch)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((BranchObjectId, CausalHashId)
 -&gt; (([CausalHashId], Any), (BranchObjectId, CausalHashId)))
-&gt; DbBranch -&gt; (([CausalHashId], Any), DbBranch)
forall t h p c c' (f :: * -&gt; *).
Applicative f =&gt;
(c -&gt; f c') -&gt; Branch' t h p c -&gt; f (Branch' t h p c')
</span><span class="hs-identifier hs-var">DBBranch.childrenHashes_</span></span><span> </span><span class="annot"><span class="annottext">(((BranchObjectId, CausalHashId)
  -&gt; (([CausalHashId], Any), (BranchObjectId, CausalHashId)))
 -&gt; DbBranch -&gt; (([CausalHashId], Any), DbBranch))
-&gt; ((BranchObjectId, CausalHashId)
    -&gt; (([CausalHashId], Any), (BranchObjectId, CausalHashId)))
-&gt; DbBranch
-&gt; (([CausalHashId], Any), DbBranch)
forall {k} (f :: k -&gt; *) s (t :: k) a (b :: k).
LensLike f s t a b -&gt; LensLike f s t a b
</span><span class="hs-operator hs-var">%%~</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680477301"><span class="annot"><span class="annottext">ids :: (BranchObjectId, CausalHashId)
</span><a href="#local-6989586621680477301"><span class="hs-identifier hs-var">ids</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621680477302"><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477302"><span class="hs-identifier hs-var">childBranchObjId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680477303"><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477303"><span class="hs-identifier hs-var">childCausalHashId</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-238"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CausalHashId
-&gt; Map CausalHashId (BranchHashId, BranchObjectId)
-&gt; Maybe (BranchHashId, BranchObjectId)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477303"><span class="hs-identifier hs-var">childCausalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">Map CausalHashId (BranchHashId, BranchObjectId)
</span><a href="#local-6989586621680477292"><span class="hs-identifier hs-var">canonicalBranchForCausalMap</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-239"></span><span>              </span><span class="annot"><span class="annottext">Maybe (BranchHashId, BranchObjectId)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477303"><span class="hs-identifier hs-var">childCausalHashId</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Any
</span><span class="hs-identifier hs-var">Any</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(BranchObjectId, CausalHashId)
</span><a href="#local-6989586621680477301"><span class="hs-identifier hs-var">ids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchHashId
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680477305"><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477305"><span class="hs-identifier hs-var">canonicalObjId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680477306"><span class="annot"><span class="annottext">changed :: Bool
</span><a href="#local-6989586621680477306"><span class="hs-identifier hs-var hs-var">changed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477305"><span class="hs-identifier hs-var">canonicalObjId</span></a></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; BranchObjectId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477302"><span class="hs-identifier hs-var">childBranchObjId</span></a></span><span>
</span><span id="line-242"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Any
</span><span class="hs-identifier hs-var">Any</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680477306"><span class="hs-identifier hs-var">changed</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477305"><span class="hs-identifier hs-var">canonicalObjId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CausalHashId
</span><a href="#local-6989586621680477303"><span class="hs-identifier hs-var">childCausalHashId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; ([CausalHashId] -&gt; Bool) -&gt; [CausalHashId] -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[CausalHashId] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">([CausalHashId] -&gt; Bool) -&gt; [CausalHashId] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680477294"><span class="hs-identifier hs-var">unmigratedChildren</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult CausalHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
TrySyncResult CausalHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CausalHashId] -&gt; TrySyncResult CausalHashId
forall entity. [entity] -&gt; TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Missing</span></span><span> </span><span class="annot"><span class="annottext">[CausalHashId]
</span><a href="#local-6989586621680477294"><span class="hs-identifier hs-var">unmigratedChildren</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680477296"><span class="hs-identifier hs-var">changes</span></a></span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-245"></span><span>    </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; DbBranch -&gt; Transaction ()
</span><a href="#local-6989586621680477308"><span class="hs-identifier hs-var">replaceBranch</span></a></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span> </span><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680477297"><span class="hs-identifier hs-var">remappedBranch</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span id="local-6989586621680477309"><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680477309"><span class="hs-identifier hs-var">correctNamespaceHash</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction BranchHash
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     BranchHash
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction BranchHash
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      BranchHash)
-&gt; Transaction BranchHash
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     BranchHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">DbBranch -&gt; Transaction BranchHash
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema1To2.DbHelpers.html#dbBranchHash"><span class="hs-identifier hs-var">Helpers.dbBranchHash</span></a></span><span> </span><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680477297"><span class="hs-identifier hs-var">remappedBranch</span></a></span><span>
</span><span id="line-247"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; (String -&gt; Transaction ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#debugLog"><span class="hs-identifier hs-var">debugLog</span></a></span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Correct namespace hash: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BranchHash -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680477309"><span class="hs-identifier hs-var">correctNamespaceHash</span></a></span><span>
</span><span id="line-248"></span><span>  </span><span id="local-6989586621680477311"><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477311"><span class="hs-identifier hs-var">correctNamespaceHashId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Transaction BranchHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     BranchHashId
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction BranchHashId
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      BranchHashId)
-&gt; Transaction BranchHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     BranchHashId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BranchHash -&gt; Transaction BranchHashId
</span><span class="hs-identifier hs-var">Q.saveBranchHash</span></span><span> </span><span class="annot"><span class="annottext">BranchHash
</span><a href="#local-6989586621680477309"><span class="hs-identifier hs-var">correctNamespaceHash</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477311"><span class="hs-identifier hs-var">correctNamespaceHashId</span></a></span><span> </span><span class="annot"><span class="annottext">BranchHashId -&gt; BranchHashId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477288"><span class="hs-identifier hs-var">possiblyIncorrectNamespaceHashId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExceptT
   (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-comment">-- If the existing hash for this namespace was already correct, we don't need to</span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-comment">-- canonicalize the branch or worry about deleting/updating bad objects.</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-comment">-- We just record the mapping and move on.</span><span>
</span><span id="line-254"></span><span>    </span><span class="annot"><span class="annottext">(Map CausalHashId (BranchHashId, BranchObjectId)
 -&gt; Identity (Map CausalHashId (BranchHashId, BranchObjectId)))
-&gt; MigrationState -&gt; Identity MigrationState
Lens'
  MigrationState (Map CausalHashId (BranchHashId, BranchObjectId))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#canonicalBranchForCausalHashId"><span class="hs-identifier hs-var">canonicalBranchForCausalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">((Map CausalHashId (BranchHashId, BranchObjectId)
  -&gt; Identity (Map CausalHashId (BranchHashId, BranchObjectId)))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; ((Maybe (BranchHashId, BranchObjectId)
     -&gt; Identity (Maybe (BranchHashId, BranchObjectId)))
    -&gt; Map CausalHashId (BranchHashId, BranchObjectId)
    -&gt; Identity (Map CausalHashId (BranchHashId, BranchObjectId)))
-&gt; (Maybe (BranchHashId, BranchObjectId)
    -&gt; Identity (Maybe (BranchHashId, BranchObjectId)))
-&gt; MigrationState
-&gt; Identity MigrationState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map CausalHashId (BranchHashId, BranchObjectId))
-&gt; Lens'
     (Map CausalHashId (BranchHashId, BranchObjectId))
     (Maybe (IxValue (Map CausalHashId (BranchHashId, BranchObjectId))))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map CausalHashId (BranchHashId, BranchObjectId))
CausalHashId
</span><a href="#local-6989586621680477287"><span class="hs-identifier hs-var">causalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (BranchHashId, BranchObjectId)
  -&gt; Identity (Maybe (BranchHashId, BranchObjectId)))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; (BranchHashId, BranchObjectId)
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a (Maybe b) -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">?=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477311"><span class="hs-identifier hs-var">correctNamespaceHashId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><span class="annottext">(Map BranchHashId BranchObjectId
 -&gt; Identity (Map BranchHashId BranchObjectId))
-&gt; MigrationState -&gt; Identity MigrationState
Lens' MigrationState (Map BranchHashId BranchObjectId)
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#validBranchHashIds"><span class="hs-identifier hs-var">validBranchHashIds</span></a></span><span> </span><span class="annot"><span class="annottext">((Map BranchHashId BranchObjectId
  -&gt; Identity (Map BranchHashId BranchObjectId))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; ((Maybe BranchObjectId -&gt; Identity (Maybe BranchObjectId))
    -&gt; Map BranchHashId BranchObjectId
    -&gt; Identity (Map BranchHashId BranchObjectId))
-&gt; (Maybe BranchObjectId -&gt; Identity (Maybe BranchObjectId))
-&gt; MigrationState
-&gt; Identity MigrationState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map BranchHashId BranchObjectId)
-&gt; Lens'
     (Map BranchHashId BranchObjectId)
     (Maybe (IxValue (Map BranchHashId BranchObjectId)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map BranchHashId BranchObjectId)
BranchHashId
</span><a href="#local-6989586621680477288"><span class="hs-identifier hs-var">possiblyIncorrectNamespaceHashId</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe BranchObjectId -&gt; Identity (Maybe BranchObjectId))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; BranchObjectId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a (Maybe b) -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">?=</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><span class="annottext">TrySyncResult CausalHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
TrySyncResult CausalHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">TrySyncResult CausalHashId
forall entity. TrySyncResult entity
</span><span class="hs-identifier hs-var">Sync.Done</span></span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-comment">-- Update the value_hash_id on the causal to the correct hash for the branch</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BranchHashId -&gt; BranchHashId -&gt; Transaction ()
</span><a href="#local-6989586621680477313"><span class="hs-identifier hs-var">updateCausalValueHash</span></a></span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477311"><span class="hs-identifier hs-var">correctNamespaceHashId</span></a></span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477288"><span class="hs-identifier hs-var">possiblyIncorrectNamespaceHashId</span></a></span><span>
</span><span id="line-260"></span><span>  </span><span class="hs-comment">-- It's possible that an object already exists for this new hash</span><span>
</span><span id="line-261"></span><span>  </span><span id="local-6989586621680477314"><span class="annot"><span class="annottext">Maybe BranchObjectId
</span><a href="#local-6989586621680477314"><span class="hs-identifier hs-var">mayCanonical</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BranchHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     (Maybe BranchObjectId)
</span><a href="#local-6989586621680477315"><span class="hs-identifier hs-var">getCanonicalObjectForHash</span></a></span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477311"><span class="hs-identifier hs-var">correctNamespaceHashId</span></a></span><span>
</span><span id="line-262"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; (String -&gt; Transaction ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#debugLog"><span class="hs-identifier hs-var">debugLog</span></a></span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;(objId, Canonical object ID):&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(BranchObjectId, Maybe BranchObjectId) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe BranchObjectId
</span><a href="#local-6989586621680477314"><span class="hs-identifier hs-var">mayCanonical</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>  </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; (String -&gt; Transaction ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#debugLog"><span class="hs-identifier hs-var">debugLog</span></a></span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Updating causal value hash (from, to)&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(BranchHashId, BranchHashId) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477288"><span class="hs-identifier hs-var">possiblyIncorrectNamespaceHashId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477311"><span class="hs-identifier hs-var">correctNamespaceHashId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>  </span><span id="local-6989586621680477316"><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477316"><span class="hs-identifier hs-var">canonicalObjId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe BranchObjectId
</span><a href="#local-6989586621680477314"><span class="hs-identifier hs-var">mayCanonical</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-265"></span><span>    </span><span class="hs-comment">-- If there's an existing canonical object, record the mapping from this object id to</span><span>
</span><span id="line-266"></span><span>    </span><span class="hs-comment">-- that one.</span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680477317"><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477317"><span class="hs-identifier hs-var">canonicalObjectId</span></a></span></span><span>
</span><span id="line-268"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477317"><span class="hs-identifier hs-var">canonicalObjectId</span></a></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; BranchObjectId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-269"></span><span>          </span><span class="hs-comment">-- Found an existing but different object with this hash, so the current object is a duplicate and</span><span>
</span><span id="line-270"></span><span>          </span><span class="hs-comment">-- needs to be deleted.</span><span>
</span><span id="line-271"></span><span>          </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; (String -&gt; Transaction ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#debugLog"><span class="hs-identifier hs-var">debugLog</span></a></span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Mapping objID: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; to canonical: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477317"><span class="hs-identifier hs-var">canonicalObjectId</span></a></span><span>
</span><span id="line-272"></span><span>          </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; (String -&gt; Transaction ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#debugLog"><span class="hs-identifier hs-var">debugLog</span></a></span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unilaterally deleting: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span>
</span><span id="line-273"></span><span>          </span><span class="hs-comment">-- Remove possible foreign-key references before deleting the objects themselves</span><span>
</span><span id="line-274"></span><span>          </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; Transaction ()
forall {a}. ToField a =&gt; a -&gt; Transaction ()
</span><a href="#local-6989586621680477318"><span class="hs-identifier hs-var">deleteHashObjectsByObjectId</span></a></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span>
</span><span id="line-275"></span><span>          </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; Transaction ()
forall {a}. ToField a =&gt; a -&gt; Transaction ()
</span><a href="#local-6989586621680477319"><span class="hs-identifier hs-var">deleteObjectById</span></a></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span>
</span><span id="line-276"></span><span>          </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477317"><span class="hs-identifier hs-var">canonicalObjectId</span></a></span><span>
</span><span id="line-277"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-278"></span><span>          </span><span class="hs-comment">-- This should be impossible.</span><span>
</span><span id="line-279"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     BranchObjectId
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      BranchObjectId)
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     BranchObjectId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;We proved that the new hash is different from the existing one, but somehow found the same object for each hash. Please report this as a bug.&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(BranchObjectId, BranchObjectId) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477317"><span class="hs-identifier hs-var">canonicalObjectId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><span class="annottext">Maybe BranchObjectId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-281"></span><span>      </span><span class="hs-comment">-- There's no existing canonical object, this object BECOMES the canonical one by</span><span>
</span><span id="line-282"></span><span>      </span><span class="hs-comment">-- reassigning its primary hash.</span><span>
</span><span id="line-283"></span><span>      </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; (String -&gt; Transaction ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#debugLog"><span class="hs-identifier hs-var">debugLog</span></a></span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; String
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Updating in place: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span>
</span><span id="line-284"></span><span>      </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId -&gt; Transaction ()
forall {a}. ToField a =&gt; a -&gt; Transaction ()
</span><a href="#local-6989586621680477318"><span class="hs-identifier hs-var">deleteHashObjectsByObjectId</span></a></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span>
</span><span id="line-285"></span><span>      </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BranchHashId -&gt; BranchObjectId -&gt; Transaction ()
forall {a} {a}. (ToField a, ToField a) =&gt; a -&gt; a -&gt; Transaction ()
</span><a href="#local-6989586621680477321"><span class="hs-identifier hs-var">updateHashIdForObject</span></a></span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477311"><span class="hs-identifier hs-var">correctNamespaceHashId</span></a></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span>
</span><span id="line-286"></span><span>      </span><span class="annot"><span class="annottext">Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction ()
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      ())
-&gt; Transaction ()
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HashId -&gt; ObjectId -&gt; HashVersion -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Q.saveHashObject</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchHashId -&gt; HashId
</span><span class="hs-identifier hs-var">DB.unBranchHashId</span></span><span> </span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477311"><span class="hs-identifier hs-var">correctNamespaceHashId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchObjectId -&gt; ObjectId
</span><span class="hs-identifier hs-var">DB.unBranchObjectId</span></span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashVersion
</span><span class="hs-number">2</span></span><span>
</span><span id="line-287"></span><span>      </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477289"><span class="hs-identifier hs-var">objId</span></a></span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-comment">-- Save the canonical branch info for the causal for use in remappings.</span><span>
</span><span id="line-289"></span><span>  </span><span class="annot"><span class="annottext">(Map CausalHashId (BranchHashId, BranchObjectId)
 -&gt; Identity (Map CausalHashId (BranchHashId, BranchObjectId)))
-&gt; MigrationState -&gt; Identity MigrationState
Lens'
  MigrationState (Map CausalHashId (BranchHashId, BranchObjectId))
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#canonicalBranchForCausalHashId"><span class="hs-identifier hs-var">canonicalBranchForCausalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">((Map CausalHashId (BranchHashId, BranchObjectId)
  -&gt; Identity (Map CausalHashId (BranchHashId, BranchObjectId)))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; ((Maybe (BranchHashId, BranchObjectId)
     -&gt; Identity (Maybe (BranchHashId, BranchObjectId)))
    -&gt; Map CausalHashId (BranchHashId, BranchObjectId)
    -&gt; Identity (Map CausalHashId (BranchHashId, BranchObjectId)))
-&gt; (Maybe (BranchHashId, BranchObjectId)
    -&gt; Identity (Maybe (BranchHashId, BranchObjectId)))
-&gt; MigrationState
-&gt; Identity MigrationState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map CausalHashId (BranchHashId, BranchObjectId))
-&gt; Lens'
     (Map CausalHashId (BranchHashId, BranchObjectId))
     (Maybe (IxValue (Map CausalHashId (BranchHashId, BranchObjectId))))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map CausalHashId (BranchHashId, BranchObjectId))
CausalHashId
</span><a href="#local-6989586621680477287"><span class="hs-identifier hs-var">causalHashId</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (BranchHashId, BranchObjectId)
  -&gt; Identity (Maybe (BranchHashId, BranchObjectId)))
 -&gt; MigrationState -&gt; Identity MigrationState)
-&gt; (BranchHashId, BranchObjectId)
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a (Maybe b) -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">?=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477311"><span class="hs-identifier hs-var">correctNamespaceHashId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477316"><span class="hs-identifier hs-var">canonicalObjId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-291"></span><span>    </span><span class="annot"><a href="#local-6989586621680477313"><span class="hs-identifier hs-type">updateCausalValueHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchHashId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchHashId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span>    </span><span id="local-6989586621680477313"><span class="annot"><span class="annottext">updateCausalValueHash :: BranchHashId -&gt; BranchHashId -&gt; Transaction ()
</span><a href="#local-6989586621680477313"><span class="hs-identifier hs-var hs-var">updateCausalValueHash</span></a></span></span><span> </span><span id="local-6989586621680477325"><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477325"><span class="hs-identifier hs-var">correctNamespaceHashId</span></a></span></span><span> </span><span id="local-6989586621680477326"><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477326"><span class="hs-identifier hs-var">possiblyIncorrectNamespaceHashId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-293"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
          UPDATE causal
            SET value_hash_id = :correctNamespaceHashId
            WHERE value_hash_id = :possiblyIncorrectNamespaceHashId
        |]</span></span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><a href="#local-6989586621680477315"><span class="hs-identifier hs-type">getCanonicalObjectForHash</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-301"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchHashId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-302"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ExceptT</span></span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Sync.TrySyncResult</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.CausalHashId</span></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#MigrationState"><span class="hs-identifier hs-type">MigrationState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchObjectId</span></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621680477315"><span class="annot"><span class="annottext">getCanonicalObjectForHash :: BranchHashId
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     (Maybe BranchObjectId)
</span><a href="#local-6989586621680477315"><span class="hs-identifier hs-var hs-var">getCanonicalObjectForHash</span></a></span></span><span> </span><span id="local-6989586621680477327"><span class="annot"><span class="annottext">BranchHashId
</span><a href="#local-6989586621680477327"><span class="hs-identifier hs-var">namespaceHashId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-307"></span><span>      </span><span class="annot"><span class="annottext">Transaction (Maybe BranchObjectId)
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     (Maybe BranchObjectId)
forall a.
Transaction a
-&gt; ExceptT
     (TrySyncResult CausalHashId) (StateT MigrationState Transaction) a
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#liftT"><span class="hs-identifier hs-var">liftT</span></a></span><span> </span><span class="annot"><span class="annottext">(Transaction (Maybe BranchObjectId)
 -&gt; ExceptT
      (TrySyncResult CausalHashId)
      (StateT MigrationState Transaction)
      (Maybe BranchObjectId))
-&gt; Transaction (Maybe BranchObjectId)
-&gt; ExceptT
     (TrySyncResult CausalHashId)
     (StateT MigrationState Transaction)
     (Maybe BranchObjectId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-308"></span><span>        </span><span class="annot"><span class="annottext">Sql -&gt; Transaction (Maybe BranchObjectId)
forall a.
(FromField a, HasCallStack) =&gt;
Sql -&gt; Transaction (Maybe a)
</span><span class="hs-identifier hs-var">Sqlite.queryMaybeCol</span></span><span>
</span><span id="line-309"></span><span>          </span><span class="annot"><span class="">[Sqlite.sql|
            SELECT id
              FROM object
              WHERE primary_hash_id = :namespaceHashId
          |]</span></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span>    </span><span id="local-6989586621680477321"><span class="annot"><span class="annottext">updateHashIdForObject :: a -&gt; a -&gt; Transaction ()
</span><a href="#local-6989586621680477321"><span class="hs-identifier hs-var hs-var">updateHashIdForObject</span></a></span></span><span> </span><span id="local-6989586621680477338"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680477338"><span class="hs-identifier hs-var">hashId</span></a></span></span><span> </span><span id="local-6989586621680477339"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680477339"><span class="hs-identifier hs-var">objId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-316"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-317"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
          UPDATE object
            SET primary_hash_id = :hashId
            WHERE id = :objId
        |]</span></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-comment">-- Replace the bytes payload of a given branch in-place.</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-comment">-- This does NOT update the hash of the object.</span><span>
</span><span id="line-325"></span><span>    </span><span class="annot"><a href="#local-6989586621680477308"><span class="hs-identifier hs-type">replaceBranch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DB.BranchObjectId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DBBranch.DbBranch</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621680477308"><span class="annot"><span class="annottext">replaceBranch :: BranchObjectId -&gt; DbBranch -&gt; Transaction ()
</span><a href="#local-6989586621680477308"><span class="hs-identifier hs-var hs-var">replaceBranch</span></a></span></span><span> </span><span id="local-6989586621680477340"><span class="annot"><span class="annottext">BranchObjectId
</span><a href="#local-6989586621680477340"><span class="hs-identifier hs-var">objId</span></a></span></span><span> </span><span id="local-6989586621680477341"><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680477341"><span class="hs-identifier hs-var">branch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-327"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680477342"><span class="annot"><span class="annottext">BranchLocalIds
</span><a href="#local-6989586621680477342"><span class="hs-identifier hs-var">localBranchIds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680477343"><span class="annot"><span class="annottext">LocalBranch
</span><a href="#local-6989586621680477343"><span class="hs-identifier hs-var">localBranch</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DbBranch -&gt; (BranchLocalIds, LocalBranch)
</span><span class="hs-identifier hs-var">S.LocalizeObject.localizeBranch</span></span><span> </span><span class="annot"><span class="annottext">DbBranch
</span><a href="#local-6989586621680477341"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-328"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680477345"><span class="annot"><span class="annottext">bytes :: ByteString
</span><a href="#local-6989586621680477345"><span class="hs-identifier hs-var hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Put
  (BranchFormat'
     TextId
     ObjectId
     PatchObjectId
     (BranchObjectId, CausalHashId)
     BranchObjectId)
-&gt; BranchFormat'
     TextId
     ObjectId
     PatchObjectId
     (BranchObjectId, CausalHashId)
     BranchObjectId
-&gt; ByteString
forall a. Put a -&gt; a -&gt; ByteString
</span><span class="hs-identifier hs-var">S.putBytes</span></span><span> </span><span class="annot"><span class="annottext">BranchFormat'
  TextId
  ObjectId
  PatchObjectId
  (BranchObjectId, CausalHashId)
  BranchObjectId
-&gt; m ()
Put
  (BranchFormat'
     TextId
     ObjectId
     PatchObjectId
     (BranchObjectId, CausalHashId)
     BranchObjectId)
</span><span class="hs-identifier hs-var">S.putBranchFormat</span></span><span> </span><span class="annot"><span class="annottext">(BranchFormat'
   TextId
   ObjectId
   PatchObjectId
   (BranchObjectId, CausalHashId)
   BranchObjectId
 -&gt; ByteString)
-&gt; BranchFormat'
     TextId
     ObjectId
     PatchObjectId
     (BranchObjectId, CausalHashId)
     BranchObjectId
-&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BranchLocalIds
-&gt; LocalBranch
-&gt; BranchFormat'
     TextId
     ObjectId
     PatchObjectId
     (BranchObjectId, CausalHashId)
     BranchObjectId
forall text defRef patchRef childRef branchRef.
BranchLocalIds' text defRef patchRef childRef
-&gt; LocalBranch
-&gt; BranchFormat' text defRef patchRef childRef branchRef
</span><span class="hs-identifier hs-var">S.BranchFormat.Full</span></span><span> </span><span class="annot"><span class="annottext">BranchLocalIds
</span><a href="#local-6989586621680477342"><span class="hs-identifier hs-var">localBranchIds</span></a></span><span> </span><span class="annot"><span class="annottext">LocalBranch
</span><a href="#local-6989586621680477343"><span class="hs-identifier hs-var">localBranch</span></a></span><span>
</span><span id="line-329"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-330"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
          UPDATE object
          SET bytes = :bytes
          WHERE id = :objId
        |]</span></span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span>    </span><span id="local-6989586621680477318"><span class="annot"><span class="annottext">deleteHashObjectsByObjectId :: a -&gt; Transaction ()
</span><a href="#local-6989586621680477318"><span class="hs-identifier hs-var hs-var">deleteHashObjectsByObjectId</span></a></span></span><span> </span><span id="local-6989586621680477358"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680477358"><span class="hs-identifier hs-var">objId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-337"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-338"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
          DELETE FROM hash_object
            WHERE object_id = :objId
        |]</span></span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span>    </span><span id="local-6989586621680477319"><span class="annot"><span class="annottext">deleteObjectById :: a -&gt; Transaction ()
</span><a href="#local-6989586621680477319"><span class="hs-identifier hs-var hs-var">deleteObjectById</span></a></span></span><span> </span><span id="local-6989586621680477366"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680477366"><span class="hs-identifier hs-var">objId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-344"></span><span>      </span><span class="annot"><span class="annottext">HasCallStack =&gt; Sql -&gt; Transaction ()
Sql -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Sqlite.execute</span></span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><span class="">[Sqlite.sql|
          DELETE FROM object
            WHERE id = :objId
        |]</span></span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#log"><span class="hs-identifier hs-type">log</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span id="log"><span class="annot"><span class="annottext">log :: String -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#log"><span class="hs-identifier hs-var hs-var">log</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Transaction ())
-&gt; (String -&gt; IO ()) -&gt; String -&gt; Transaction ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span class="annot"><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#debugLog"><span class="hs-identifier hs-type">debugLog</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Sqlite.Transaction</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span id="debugLog"><span class="annot"><span class="annottext">debugLog :: String -&gt; Transaction ()
</span><a href="Unison.Codebase.SqliteCodebase.Migrations.MigrateSchema3To4.html#debugLog"><span class="hs-identifier hs-var hs-var">debugLog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DebugFlag -&gt; Transaction () -&gt; Transaction ()
forall (m :: * -&gt; *). Monad m =&gt; DebugFlag -&gt; m () -&gt; m ()
</span><span class="hs-identifier hs-var">Debug.whenDebug</span></span><span> </span><span class="annot"><span class="annottext">DebugFlag
</span><span class="hs-identifier hs-var">Debug.Migration</span></span><span> </span><span class="annot"><span class="annottext">(Transaction () -&gt; Transaction ())
-&gt; (String -&gt; Transaction ()) -&gt; String -&gt; Transaction ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Transaction ()
forall a. HasCallStack =&gt; IO a -&gt; Transaction a
</span><span class="hs-identifier hs-var">Sqlite.unsafeIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Transaction ())
-&gt; (String -&gt; IO ()) -&gt; String -&gt; Transaction ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span>
</span><span id="line-355"></span></pre></body></html>