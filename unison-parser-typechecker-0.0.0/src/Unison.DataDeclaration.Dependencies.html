<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.DataDeclaration.Dependencies</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-comment">-- Too many variants of decl dependencies. Read carefully to choose the right one.</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><span class="hs-identifier">DD.declTypeDependencies</span></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><span class="hs-identifier">DD.typeDependencies</span></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><span class="hs-identifier">DD.labeledTypeDependencies</span></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><span class="hs-identifier">DD.labeledDeclTypeDependencies</span></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><span class="hs-identifier">DD.labeledDeclDependenciesIncludingSelf</span></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Unison.DataDeclaration.Dependencies.html#labeledDeclDependenciesIncludingSelfAndFieldAccessors"><span class="hs-identifier">labeledDeclDependenciesIncludingSelfAndFieldAccessors</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Unison.DataDeclaration.Dependencies.html#hashFieldAccessors"><span class="hs-identifier">hashFieldAccessors</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">where</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set.Lens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">setOf</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DD</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration.Records</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">generateRecordAccessors</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Hashing.V2.Convert.html"><span class="hs-identifier">Unison.Hashing.V2.Convert</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Hashing</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.LabeledDependency</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LD</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.PrettyPrintEnv.html"><span class="hs-identifier">Unison.PrettyPrintEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.PrettyPrintEnv.html#PrettyPrintEnv"><span class="hs-identifier">PrettyPrintEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.PrettyPrintEnv.html"><span class="hs-identifier">Unison.PrettyPrintEnv</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PPE</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TermReferenceId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TypeReference</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Referent</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Referent</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Result.html"><span class="hs-identifier">Unison.Result</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Result</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Syntax.Var</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Var</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">namespaced</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Term</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Term</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Type</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Type</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Type</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Type</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Typechecker.html"><span class="hs-identifier">Unison.Typechecker</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Typechecker</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Typechecker.TypeLookup.html"><span class="hs-identifier">Unison.Typechecker.TypeLookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Typechecker.TypeLookup.html#TypeLookup"><span class="hs-identifier">TypeLookup</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Tuple</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tuple</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Var</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Var</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Var</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Var</span></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-comment">-- | Generate the LabeledDependencies for everything in a Decl, including the Decl itself, all</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- its constructors, all referenced types, and all possible record accessors.</span><span>
</span><span id="line-40"></span><span class="hs-comment">--</span><span>
</span><span id="line-41"></span><span class="hs-comment">-- Note that we can't actually tell whether the Decl was originally a record or not, so we</span><span>
</span><span id="line-42"></span><span class="hs-comment">-- include all possible accessors, but they may or may not exist in the codebase.</span><span>
</span><span id="line-43"></span><span id="local-6989586621680525846"><span id="local-6989586621680525849"><span class="annot"><a href="Unison.DataDeclaration.Dependencies.html#labeledDeclDependenciesIncludingSelfAndFieldAccessors"><span class="hs-identifier hs-type">labeledDeclDependenciesIncludingSelfAndFieldAccessors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Var</span></span><span> </span><span class="annot"><a href="#local-6989586621680525846"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DD.Decl</span></span><span> </span><span class="annot"><a href="#local-6989586621680525846"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680525849"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LD.LabeledDependency</span></span></span></span><span>
</span><span id="line-44"></span><span id="labeledDeclDependenciesIncludingSelfAndFieldAccessors"><span class="annot"><span class="annottext">labeledDeclDependenciesIncludingSelfAndFieldAccessors :: forall v a.
Var v =&gt;
TypeReference -&gt; Decl v a -&gt; Set LabeledDependency
</span><a href="Unison.DataDeclaration.Dependencies.html#labeledDeclDependenciesIncludingSelfAndFieldAccessors"><span class="hs-identifier hs-var hs-var">labeledDeclDependenciesIncludingSelfAndFieldAccessors</span></a></span></span><span> </span><span id="local-6989586621680526017"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680526017"><span class="hs-identifier hs-var">selfRef</span></a></span></span><span> </span><span id="local-6989586621680526018"><span class="annot"><span class="annottext">Decl v a
</span><a href="#local-6989586621680526018"><span class="hs-identifier hs-var">decl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-45"></span><span>  </span><span class="annot"><span class="annottext">TypeReference -&gt; Decl v a -&gt; Set LabeledDependency
forall v a.
Ord v =&gt;
TypeReference -&gt; Decl v a -&gt; Set LabeledDependency
</span><span class="hs-identifier hs-var">DD.labeledDeclDependenciesIncludingSelf</span></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680526017"><span class="hs-identifier hs-var">selfRef</span></a></span><span> </span><span class="annot"><span class="annottext">Decl v a
</span><a href="#local-6989586621680526018"><span class="hs-identifier hs-var">decl</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><span class="annottext">Set LabeledDependency
-&gt; Set LabeledDependency -&gt; Set LabeledDependency
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Decl v a
</span><a href="#local-6989586621680526018"><span class="hs-identifier hs-var">decl</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-47"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621680526019"><span class="annot"><span class="annottext">EffectDeclaration v a
</span><a href="#local-6989586621680526019"><span class="hs-identifier hs-var">_effect</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Set LabeledDependency
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-48"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621680526020"><span class="annot"><span class="annottext">DataDeclaration v a
</span><a href="#local-6989586621680526020"><span class="hs-identifier hs-var">dataDecl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-49"></span><span>        </span><span class="annot"><span class="annottext">TypeReference -&gt; DataDeclaration v a -&gt; Maybe (Set Referent)
forall v a.
Var v =&gt;
TypeReference -&gt; DataDeclaration v a -&gt; Maybe (Set Referent)
</span><a href="Unison.DataDeclaration.Dependencies.html#fieldAccessorRefs"><span class="hs-identifier hs-var">fieldAccessorRefs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680526017"><span class="hs-identifier hs-var">selfRef</span></a></span><span> </span><span class="annot"><span class="annottext">DataDeclaration v a
</span><a href="#local-6989586621680526020"><span class="hs-identifier hs-var">dataDecl</span></a></span><span>
</span><span id="line-50"></span><span>          </span><span class="annot"><span class="annottext">Maybe (Set Referent)
-&gt; (Maybe (Set Referent) -&gt; Set LabeledDependency)
-&gt; Set LabeledDependency
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Set LabeledDependency
-&gt; (Set Referent -&gt; Set LabeledDependency)
-&gt; Maybe (Set Referent)
-&gt; Set LabeledDependency
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Set LabeledDependency
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Referent -&gt; LabeledDependency)
-&gt; Set Referent -&gt; Set LabeledDependency
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Referent -&gt; LabeledDependency
</span><span class="hs-identifier hs-var">LD.TermReferent</span></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-comment">-- | Generate Referents for all possible field accessors of a Decl.</span><span>
</span><span id="line-53"></span><span class="hs-comment">--</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- Returns @Nothing@ if this couldn't be a record because it doesn't contain exactly one constructor, or because the</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- record contains a field with a higher rank type (and thus fails type inference).</span><span>
</span><span id="line-56"></span><span class="annot"><a href="Unison.DataDeclaration.Dependencies.html#fieldAccessorRefs"><span class="hs-identifier hs-type">fieldAccessorRefs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680525867"><span class="annot"><a href="#local-6989586621680525867"><span class="hs-identifier hs-type">v</span></a></span></span><span> </span><span id="local-6989586621680525868"><span class="annot"><a href="#local-6989586621680525868"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Var</span></span><span> </span><span class="annot"><a href="#local-6989586621680525867"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DD.DataDeclaration</span></span><span> </span><span class="annot"><a href="#local-6989586621680525867"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680525868"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span id="fieldAccessorRefs"><span class="annot"><span class="annottext">fieldAccessorRefs :: forall v a.
Var v =&gt;
TypeReference -&gt; DataDeclaration v a -&gt; Maybe (Set Referent)
</span><a href="Unison.DataDeclaration.Dependencies.html#fieldAccessorRefs"><span class="hs-identifier hs-var hs-var">fieldAccessorRefs</span></a></span></span><span> </span><span id="local-6989586621680526082"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680526082"><span class="hs-identifier hs-var">declRef</span></a></span></span><span> </span><span id="local-6989586621680526083"><span class="annot"><span class="annottext">DataDeclaration v a
</span><a href="#local-6989586621680526083"><span class="hs-identifier hs-var">dd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">v
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680526084"><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680526084"><span class="hs-identifier hs-var">typ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(v, Type v a)] -&gt; Maybe [(v, Type v a)]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataDeclaration v a -&gt; [(v, Type v a)]
forall v a. DataDeclaration v a -&gt; [(v, Type v a)]
</span><span class="hs-identifier hs-var">DD.constructors</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration v a
</span><a href="#local-6989586621680526083"><span class="hs-identifier hs-var">dd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-comment">-- This name isn't important, we just need a name to generate field names from.</span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-comment">-- The field names are thrown away afterwards.</span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680526092"><span class="annot"><span class="annottext">typeName :: v
</span><a href="#local-6989586621680526092"><span class="hs-identifier hs-var hs-var">typeName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; v
forall v. Var v =&gt; Text -&gt; v
</span><span class="hs-identifier hs-var">Var.named</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Type&quot;</span></span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-comment">-- These names are arbitrary and don't show up anywhere.</span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680526094"><span class="hs-identifier hs-type">vars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621680525867"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-65"></span><span>      </span><span class="hs-comment">-- We add `n` to the end of the variable name as a quick fix to #4752, but we suspect there's a more</span><span>
</span><span id="line-66"></span><span>      </span><span class="hs-comment">-- fundamental fix to be made somewhere in the term printer to automatically suffix a var name with its</span><span>
</span><span id="line-67"></span><span>      </span><span class="hs-comment">-- freshened id if it would be ambiguous otherwise.</span><span>
</span><span id="line-68"></span><span>      </span><span id="local-6989586621680526094"><span class="annot"><span class="annottext">vars :: [v]
</span><a href="#local-6989586621680526094"><span class="hs-identifier hs-var hs-var">vars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64 -&gt; v -&gt; v
forall v. Var v =&gt; Word64 -&gt; v -&gt; v
</span><span class="hs-identifier hs-var">Var.freshenId</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680526096"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; v
forall v. Var v =&gt; Text -&gt; v
</span><span class="hs-identifier hs-var">Var.named</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">tShow</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680526096"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621680526096"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680526096"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Type v a -&gt; Int
forall v a. Type v a -&gt; Int
</span><span class="hs-identifier hs-var">Type.arity</span></span><span> </span><span class="annot"><span class="annottext">Type v a
</span><a href="#local-6989586621680526084"><span class="hs-identifier hs-var">typ</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span>  </span><span id="local-6989586621680526099"><span class="annot"><span class="annottext">Map v (TermReferenceId, Term v (), Type v ())
</span><a href="#local-6989586621680526099"><span class="hs-identifier hs-var">accessors</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
-&gt; v
-&gt; [v]
-&gt; TypeReference
-&gt; DataDeclaration v a
-&gt; Maybe (Map v (TermReferenceId, Term v (), Type v ()))
forall v a.
Var v =&gt;
PrettyPrintEnv
-&gt; v
-&gt; [v]
-&gt; TypeReference
-&gt; DataDeclaration v a
-&gt; Maybe (Map v (TermReferenceId, Term v (), Type v ()))
</span><a href="Unison.DataDeclaration.Dependencies.html#hashFieldAccessors"><span class="hs-identifier hs-var">hashFieldAccessors</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="Unison.PrettyPrintEnv.html#empty"><span class="hs-identifier hs-var">PPE.empty</span></a></span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680526092"><span class="hs-identifier hs-var">typeName</span></a></span><span> </span><span class="annot"><span class="annottext">[v]
</span><a href="#local-6989586621680526094"><span class="hs-identifier hs-var">vars</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680526082"><span class="hs-identifier hs-var">declRef</span></a></span><span> </span><span class="annot"><span class="annottext">DataDeclaration v a
</span><a href="#local-6989586621680526083"><span class="hs-identifier hs-var">dd</span></a></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span>  </span><span class="annot"><span class="annottext">Set Referent -&gt; Maybe (Set Referent)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Getting
  (Set Referent)
  (Map v (TermReferenceId, Term v (), Type v ()))
  Referent
-&gt; Map v (TermReferenceId, Term v (), Type v ()) -&gt; Set Referent
forall a s. Getting (Set a) s a -&gt; s -&gt; Set a
</span><span class="hs-identifier hs-var">setOf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((TermReferenceId, Term v (), Type v ())
 -&gt; Const (Set Referent) (TermReferenceId, Term v (), Type v ()))
-&gt; Map v (TermReferenceId, Term v (), Type v ())
-&gt; Const
     (Set Referent) (Map v (TermReferenceId, Term v (), Type v ()))
forall (f :: * -&gt; *) a. Foldable f =&gt; IndexedFold Int (f a) a
IndexedFold
  Int
  (Map v (TermReferenceId, Term v (), Type v ()))
  (TermReferenceId, Term v (), Type v ())
</span><span class="hs-identifier hs-var">folded</span></span><span> </span><span class="annot"><span class="annottext">(((TermReferenceId, Term v (), Type v ())
  -&gt; Const (Set Referent) (TermReferenceId, Term v (), Type v ()))
 -&gt; Map v (TermReferenceId, Term v (), Type v ())
 -&gt; Const
      (Set Referent) (Map v (TermReferenceId, Term v (), Type v ())))
-&gt; ((Referent -&gt; Const (Set Referent) Referent)
    -&gt; (TermReferenceId, Term v (), Type v ())
    -&gt; Const (Set Referent) (TermReferenceId, Term v (), Type v ()))
-&gt; Getting
     (Set Referent)
     (Map v (TermReferenceId, Term v (), Type v ()))
     Referent
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TermReferenceId -&gt; Const (Set Referent) TermReferenceId)
-&gt; (TermReferenceId, Term v (), Type v ())
-&gt; Const (Set Referent) (TermReferenceId, Term v (), Type v ())
forall s t a b. Field1 s t a b =&gt; Lens s t a b
Lens
  (TermReferenceId, Term v (), Type v ())
  (TermReferenceId, Term v (), Type v ())
  TermReferenceId
  TermReferenceId
</span><span class="hs-identifier hs-var">_1</span></span><span> </span><span class="annot"><span class="annottext">((TermReferenceId -&gt; Const (Set Referent) TermReferenceId)
 -&gt; (TermReferenceId, Term v (), Type v ())
 -&gt; Const (Set Referent) (TermReferenceId, Term v (), Type v ()))
-&gt; ((Referent -&gt; Const (Set Referent) Referent)
    -&gt; TermReferenceId -&gt; Const (Set Referent) TermReferenceId)
-&gt; (Referent -&gt; Const (Set Referent) Referent)
-&gt; (TermReferenceId, Term v (), Type v ())
-&gt; Const (Set Referent) (TermReferenceId, Term v (), Type v ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TermReferenceId -&gt; Referent)
-&gt; (Referent -&gt; Const (Set Referent) Referent)
-&gt; TermReferenceId
-&gt; Const (Set Referent) TermReferenceId
forall (p :: * -&gt; * -&gt; *) (f :: * -&gt; *) s a.
(Profunctor p, Contravariant f) =&gt;
(s -&gt; a) -&gt; Optic' p f s a
</span><span class="hs-identifier hs-var">to</span></span><span> </span><span class="annot"><span class="annottext">TermReferenceId -&gt; Referent
</span><span class="hs-identifier hs-var">Referent.fromTermReferenceId</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map v (TermReferenceId, Term v (), Type v ())
</span><a href="#local-6989586621680526099"><span class="hs-identifier hs-var">accessors</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-comment">-- | Generate Referents for all possible field accessors of a Decl.</span><span>
</span><span id="line-75"></span><span class="hs-comment">--</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- Returns @Nothing@ if inferring/typechecking of any accessor fails, which shouldn't normally happen, but does when</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- record fields are higher rank, because the higher rank types can't be inferred.</span><span>
</span><span id="line-78"></span><span class="hs-comment">--</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- See https://github.com/unisonweb/unison/issues/498</span><span>
</span><span id="line-80"></span><span class="annot"><a href="Unison.DataDeclaration.Dependencies.html#hashFieldAccessors"><span class="hs-identifier hs-type">hashFieldAccessors</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680525915"><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span></span><span> </span><span id="local-6989586621680525916"><span class="annot"><a href="#local-6989586621680525916"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Var.Var</span></span><span> </span><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-83"></span><span>  </span><span class="annot"><a href="Unison.PrettyPrintEnv.html#PrettyPrintEnv"><span class="hs-identifier hs-type">PrettyPrintEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-84"></span><span>  </span><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">DD.DataDeclaration</span></span><span> </span><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680525916"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span id="hashFieldAccessors"><span class="annot"><span class="annottext">hashFieldAccessors :: forall v a.
Var v =&gt;
PrettyPrintEnv
-&gt; v
-&gt; [v]
-&gt; TypeReference
-&gt; DataDeclaration v a
-&gt; Maybe (Map v (TermReferenceId, Term v (), Type v ()))
</span><a href="Unison.DataDeclaration.Dependencies.html#hashFieldAccessors"><span class="hs-identifier hs-var hs-var">hashFieldAccessors</span></a></span></span><span> </span><span id="local-6989586621680526148"><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621680526148"><span class="hs-identifier hs-var">ppe</span></a></span></span><span> </span><span id="local-6989586621680526149"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680526149"><span class="hs-identifier hs-var">declName</span></a></span></span><span> </span><span id="local-6989586621680526150"><span class="annot"><span class="annottext">[v]
</span><a href="#local-6989586621680526150"><span class="hs-identifier hs-var">vars</span></a></span></span><span> </span><span id="local-6989586621680526151"><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680526151"><span class="hs-identifier hs-var">declRef</span></a></span></span><span> </span><span id="local-6989586621680526152"><span class="annot"><span class="annottext">DataDeclaration v a
</span><a href="#local-6989586621680526152"><span class="hs-identifier hs-var">dd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680526153"><span class="hs-identifier hs-type">accessors</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-91"></span><span>      </span><span id="local-6989586621680526153"><span class="annot"><span class="annottext">accessors :: [(v, (), Term v ())]
</span><a href="#local-6989586621680526153"><span class="hs-identifier hs-var hs-var">accessors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-92"></span><span>        </span><span class="annot"><span class="annottext">(NonEmpty v -&gt; v)
-&gt; (() -&gt; ())
-&gt; [(v, ())]
-&gt; v
-&gt; TypeReference
-&gt; [(v, (), Term v ())]
forall a v.
(Semigroup a, Var v) =&gt;
(NonEmpty v -&gt; v)
-&gt; (a -&gt; a) -&gt; [(v, a)] -&gt; v -&gt; TypeReference -&gt; [(v, a, Term v a)]
</span><span class="hs-identifier hs-var">generateRecordAccessors</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty v -&gt; v
forall v. Var v =&gt; NonEmpty v -&gt; v
</span><span class="hs-identifier hs-var">Var.namespaced</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; ()
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(v -&gt; (v, ())) -&gt; [v] -&gt; [(v, ())]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[v]
</span><a href="#local-6989586621680526150"><span class="hs-identifier hs-var">vars</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680526149"><span class="hs-identifier hs-var">declName</span></a></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680526151"><span class="hs-identifier hs-var">declRef</span></a></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span>  </span><span id="local-6989586621680526155"><span class="annot"><span class="annottext">[(v, (Term v (), Type v (), ()))]
</span><a href="#local-6989586621680526155"><span class="hs-identifier hs-var">typecheckedAccessors</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><span class="annottext">[(v, (), Term v ())]
-&gt; ((v, (), Term v ()) -&gt; Maybe (v, (Term v (), Type v (), ())))
-&gt; Maybe [(v, (Term v (), Type v (), ()))]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f (t b)
</span><span class="hs-identifier hs-var">for</span></span><span> </span><span class="annot"><span class="annottext">[(v, (), Term v ())]
</span><a href="#local-6989586621680526153"><span class="hs-identifier hs-var">accessors</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680526157"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680526157"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680526158"><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621680526158"><span class="hs-identifier hs-var">_a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680526159"><span class="annot"><span class="annottext">Term v ()
</span><a href="#local-6989586621680526159"><span class="hs-identifier hs-var">term</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-96"></span><span>      </span><span id="local-6989586621680526160"><span class="annot"><span class="annottext">Type v ()
</span><a href="#local-6989586621680526160"><span class="hs-identifier hs-var">typ</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Term v () -&gt; Maybe (Type v ())
</span><a href="#local-6989586621680526161"><span class="hs-identifier hs-var">typecheck</span></a></span><span> </span><span class="annot"><span class="annottext">Term v ()
</span><a href="#local-6989586621680526159"><span class="hs-identifier hs-var">term</span></a></span><span>
</span><span id="line-97"></span><span>      </span><span class="annot"><span class="annottext">(v, (Term v (), Type v (), ()))
-&gt; Maybe (v, (Term v (), Type v (), ()))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680526157"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term v ()
</span><a href="#local-6989586621680526159"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type v ()
</span><a href="#local-6989586621680526160"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><span class="annottext">[(v, (Term v (), Type v (), ()))]
</span><a href="#local-6989586621680526155"><span class="hs-identifier hs-var">typecheckedAccessors</span></a></span><span>
</span><span id="line-100"></span><span>    </span><span class="annot"><span class="annottext">[(v, (Term v (), Type v (), ()))]
-&gt; ([(v, (Term v (), Type v (), ()))]
    -&gt; Map v (Term v (), Type v (), ()))
-&gt; Map v (Term v (), Type v (), ())
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(v, (Term v (), Type v (), ()))]
-&gt; Map v (Term v (), Type v (), ())
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><span class="annottext">Map v (Term v (), Type v (), ())
-&gt; (Map v (Term v (), Type v (), ())
    -&gt; Map v (TermReferenceId, Term v (), Type v (), ()))
-&gt; Map v (TermReferenceId, Term v (), Type v (), ())
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map v (Term v (), Type v (), ())
-&gt; Map v (TermReferenceId, Term v (), Type v (), ())
forall v a extra.
Var v =&gt;
Map v (Term v a, Type v a, extra)
-&gt; Map v (TermReferenceId, Term v a, Type v a, extra)
</span><a href="Unison.Hashing.V2.Convert.html#hashTermComponents"><span class="hs-identifier hs-var">Hashing.hashTermComponents</span></a></span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><span class="annottext">Map v (TermReferenceId, Term v (), Type v (), ())
-&gt; (Map v (TermReferenceId, Term v (), Type v (), ())
    -&gt; Map v (TermReferenceId, Term v (), Type v ()))
-&gt; Map v (TermReferenceId, Term v (), Type v ())
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((TermReferenceId, Term v (), Type v (), ())
 -&gt; (TermReferenceId, Term v (), Type v ()))
-&gt; Map v (TermReferenceId, Term v (), Type v (), ())
-&gt; Map v (TermReferenceId, Term v (), Type v ())
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">Map.map</span></span><span> </span><span class="annot"><span class="annottext">(TermReferenceId, Term v (), Type v (), ())
-&gt; (TermReferenceId, Term v (), Type v ())
forall a b. Drop4th a b =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">Tuple.drop4th</span></span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><span class="annottext">Map v (TermReferenceId, Term v (), Type v ())
-&gt; (Map v (TermReferenceId, Term v (), Type v ())
    -&gt; Maybe (Map v (TermReferenceId, Term v (), Type v ())))
-&gt; Maybe (Map v (TermReferenceId, Term v (), Type v ()))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map v (TermReferenceId, Term v (), Type v ())
-&gt; Maybe (Map v (TermReferenceId, Term v (), Type v ()))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><a href="#local-6989586621680526161"><span class="hs-identifier hs-type">typecheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Term</span></span><span> </span><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span> </span><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>    </span><span id="local-6989586621680526161"><span class="annot"><span class="annottext">typecheck :: Term v () -&gt; Maybe (Type v ())
</span><a href="#local-6989586621680526161"><span class="hs-identifier hs-var hs-var">typecheck</span></a></span></span><span> </span><span id="local-6989586621680526166"><span class="annot"><span class="annottext">Term v ()
</span><a href="#local-6989586621680526166"><span class="hs-identifier hs-var">term</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-107"></span><span>      </span><span id="local-6989586621680526167"><span class="annot"><span class="annottext">Type v ()
</span><a href="#local-6989586621680526167"><span class="hs-identifier hs-var">typ</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Result (Notes v ()) (Type v ()) -&gt; Maybe (Type v ())
forall notes a. Result notes a -&gt; Maybe a
</span><a href="Unison.Result.html#result"><span class="hs-identifier hs-var">Result.result</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrettyPrintEnv
-&gt; PatternMatchCoverageCheckAndKindInferenceSwitch
-&gt; Env v ()
-&gt; Term v ()
-&gt; Result (Notes v ()) (Type v ())
forall (f :: * -&gt; *) v loc.
(Monad f, Var v, BuiltinAnnotation loc, Ord loc, Show loc) =&gt;
PrettyPrintEnv
-&gt; PatternMatchCoverageCheckAndKindInferenceSwitch
-&gt; Env v loc
-&gt; Term v loc
-&gt; ResultT (Notes v loc) f (Type v loc)
</span><a href="Unison.Typechecker.html#synthesize"><span class="hs-identifier hs-var">Typechecker.synthesize</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnv
</span><a href="#local-6989586621680526148"><span class="hs-identifier hs-var">ppe</span></a></span><span> </span><span class="annot"><span class="annottext">PatternMatchCoverageCheckAndKindInferenceSwitch
</span><a href="Unison.Typechecker.Context.html#PatternMatchCoverageCheckAndKindInferenceSwitch%27Disabled"><span class="hs-identifier hs-var">Typechecker.PatternMatchCoverageCheckAndKindInferenceSwitch'Disabled</span></a></span><span> </span><span class="annot"><span class="annottext">Env v ()
</span><a href="#local-6989586621680526171"><span class="hs-identifier hs-var">typecheckingEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Term v ()
</span><a href="#local-6989586621680526166"><span class="hs-identifier hs-var">term</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-comment">-- Note: Typechecker.synthesize doesn't normalize the output</span><span>
</span><span id="line-109"></span><span>      </span><span class="hs-comment">-- type. We do so here using `Type.cleanup`, mirroring what's</span><span>
</span><span id="line-110"></span><span>      </span><span class="hs-comment">-- done when typechecking a whole file and ensuring we get the</span><span>
</span><span id="line-111"></span><span>      </span><span class="hs-comment">-- same inferred type.</span><span>
</span><span id="line-112"></span><span>      </span><span class="annot"><span class="annottext">Type v () -&gt; Maybe (Type v ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type v () -&gt; Type v ()
forall v a. Var v =&gt; Type v a -&gt; Type v a
</span><span class="hs-identifier hs-var">Type.cleanup</span></span><span> </span><span class="annot"><span class="annottext">Type v ()
</span><a href="#local-6989586621680526167"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span>    </span><span class="annot"><a href="#local-6989586621680526171"><span class="hs-identifier hs-type">typecheckingEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Typechecker.html#Env"><span class="hs-identifier hs-type">Typechecker.Env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680525915"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>    </span><span id="local-6989586621680526171"><span class="annot"><span class="annottext">typecheckingEnv :: Env v ()
</span><a href="#local-6989586621680526171"><span class="hs-identifier hs-var hs-var">typecheckingEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-116"></span><span>      </span><span class="annot"><a href="Unison.Typechecker.html#Env"><span class="hs-identifier hs-type">Typechecker.Env</span></a></span><span>
</span><span id="line-117"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:ambientAbilities:Env :: [Type v ()]
</span><a href="Unison.Typechecker.html#%24sel%3AambientAbilities%3AEnv"><span class="hs-identifier hs-var">ambientAbilities</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type v ()]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-118"></span><span>          </span><span class="annot"><span class="annottext">$sel:typeLookup:Env :: TypeLookup v ()
</span><a href="Unison.Typechecker.html#%24sel%3AtypeLookup%3AEnv"><span class="hs-identifier hs-var">typeLookup</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-119"></span><span>            </span><span class="annot"><a href="Unison.Typechecker.TypeLookup.html#TypeLookup"><span class="hs-identifier hs-type">TypeLookup</span></a></span><span>
</span><span id="line-120"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:typeOfTerms:TypeLookup :: Map TypeReference (Type v ())
</span><a href="Unison.Typechecker.TypeLookup.html#%24sel%3AtypeOfTerms%3ATypeLookup"><span class="hs-identifier hs-var">typeOfTerms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map TypeReference (Type v ())
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-121"></span><span>                </span><span class="annot"><span class="annottext">$sel:dataDecls:TypeLookup :: Map TypeReference (DataDeclaration v ())
</span><a href="Unison.Typechecker.TypeLookup.html#%24sel%3AdataDecls%3ATypeLookup"><span class="hs-identifier hs-var">dataDecls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeReference
-&gt; DataDeclaration v () -&gt; Map TypeReference (DataDeclaration v ())
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.singleton</span></span><span> </span><span class="annot"><span class="annottext">TypeReference
</span><a href="#local-6989586621680526151"><span class="hs-identifier hs-var">declRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataDeclaration v a -&gt; DataDeclaration v ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration v a
</span><a href="#local-6989586621680526152"><span class="hs-identifier hs-var">dd</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-122"></span><span>                </span><span class="annot"><span class="annottext">$sel:effectDecls:TypeLookup :: Map TypeReference (EffectDeclaration v ())
</span><a href="Unison.Typechecker.TypeLookup.html#%24sel%3AeffectDecls%3ATypeLookup"><span class="hs-identifier hs-var">effectDecls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map TypeReference (EffectDeclaration v ())
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-123"></span><span>              </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-124"></span><span>          </span><span class="annot"><span class="annottext">$sel:termsByShortname:Env :: Map Name [Either Name (NamedReference v ())]
</span><a href="Unison.Typechecker.html#%24sel%3AtermsByShortname%3AEnv"><span class="hs-identifier hs-var">termsByShortname</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Name [Either Name (NamedReference v ())]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-125"></span><span>          </span><span class="annot"><span class="annottext">$sel:topLevelComponents:Env :: Map Name (NamedReference v ())
</span><a href="Unison.Typechecker.html#%24sel%3AtopLevelComponents%3AEnv"><span class="hs-identifier hs-var">topLevelComponents</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Name (NamedReference v ())
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span>
</span><span id="line-126"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-127"></span></pre></body></html>