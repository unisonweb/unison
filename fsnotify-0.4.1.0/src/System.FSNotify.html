<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">--</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- Copyright (c) 2012 Mark Dittmer - http://www.markdittmer.org</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- Developed for a Google Summer of Code project - http://gsoc2012.markdittmer.org</span><span>
</span><span id="line-4"></span><span class="hs-comment">--</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE ExistentialQuantification #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-comment">-- | This library does not currently report changes made to directories,</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- only files within watched directories.</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- Minimal example:</span><span>
</span><span id="line-19"></span><span class="hs-comment">--</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- &gt;{-# LANGUAGE OverloadedStrings #-} -- for FilePath literals</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- &gt;</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- &gt;import System.FSNotify</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- &gt;import Control.Concurrent (threadDelay)</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- &gt;import Control.Monad (forever)</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- &gt;</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- &gt;main =</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- &gt;  withManager $ \mgr -&gt; do</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- &gt;    -- start a watching job (in the background)</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- &gt;    watchDir</span><span>
</span><span id="line-30"></span><span class="hs-comment">-- &gt;      mgr          -- manager</span><span>
</span><span id="line-31"></span><span class="hs-comment">-- &gt;      &quot;.&quot;          -- directory to watch</span><span>
</span><span id="line-32"></span><span class="hs-comment">-- &gt;      (const True) -- predicate</span><span>
</span><span id="line-33"></span><span class="hs-comment">-- &gt;      print        -- action</span><span>
</span><span id="line-34"></span><span class="hs-comment">-- &gt;</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- &gt;    -- sleep forever (until interrupted)</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- &gt;    forever $ threadDelay 1000000</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">System.FSNotify</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Events</span></span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="System.FSNotify.Types.html#Event"><span class="hs-identifier">Event</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#EventIsDirectory"><span class="hs-identifier">EventIsDirectory</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#EventChannel"><span class="hs-identifier">EventChannel</span></a></span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#Action"><span class="hs-identifier">Action</span></a></span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#ActionPredicate"><span class="hs-identifier">ActionPredicate</span></a></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Starting/Stopping</span></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier">WatchManager</span></a></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.html#withManager"><span class="hs-identifier">withManager</span></a></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.html#startManager"><span class="hs-identifier">startManager</span></a></span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.html#stopManager"><span class="hs-identifier">stopManager</span></a></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Configuration</span></span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.html#defaultConfig"><span class="hs-identifier">defaultConfig</span></a></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#WatchConfig"><span class="hs-identifier">WatchConfig</span></a></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#confWatchMode"><span class="hs-identifier">confWatchMode</span></a></span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#confThreadingMode"><span class="hs-identifier">confThreadingMode</span></a></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#confOnHandlerException"><span class="hs-identifier">confOnHandlerException</span></a></span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#WatchMode"><span class="hs-identifier">WatchMode</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#ThreadingMode"><span class="hs-identifier">ThreadingMode</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Lower level</span></span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.html#withManagerConf"><span class="hs-identifier">withManagerConf</span></a></span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.html#startManagerConf"><span class="hs-identifier">startManagerConf</span></a></span><span>
</span><span id="line-64"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.Listener.html#StopListening"><span class="hs-identifier">StopListening</span></a></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Watching</span></span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.html#watchDir"><span class="hs-identifier">watchDir</span></a></span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.html#watchDirChan"><span class="hs-identifier">watchDirChan</span></a></span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.html#watchTree"><span class="hs-identifier">watchTree</span></a></span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.html#watchTreeChan"><span class="hs-identifier">watchTreeChan</span></a></span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">FilePath</span></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async</span></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception.Safe</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="System.FSNotify.Polling.html"><span class="hs-identifier">System.FSNotify.Polling</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html"><span class="hs-identifier">System.FSNotify.Types</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.FilePath</span></span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="System.FSNotify.Listener.html"><span class="hs-identifier">System.FSNotify.Listener</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.FSNotify.Listener.html#ListenFn"><span class="hs-identifier">ListenFn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.FSNotify.Listener.html#StopListening"><span class="hs-identifier">StopListening</span></a></span><span class="hs-special">)</span><span class="hs-cpp">

#if !MIN_VERSION_base(4,11,0)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Data.Monoid</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#ifdef OS_Linux
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="System.FSNotify.Linux.html"><span class="hs-identifier">System.FSNotify.Linux</span></a></span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#ifdef OS_Win32
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FSNotify.Win32</span><span class="hs-cpp">
#endif
</span><span class="hs-cpp">
#ifdef OS_Mac
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">System.FSNotify.OSX</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="annot"><span class="hs-comment">-- | Watch manager. You need one in order to create watching jobs.</span></span><span>
</span><span id="line-105"></span><span class="hs-keyword">data</span><span> </span><span id="WatchManager"><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-var">WatchManager</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679064526"><span class="annot"><a href="#local-6989586621679064526"><span class="hs-identifier hs-type">manager</span></a></span></span><span> </span><span id="local-6989586621679064527"><span class="annot"><a href="#local-6989586621679064527"><span class="hs-identifier hs-type">argType</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="System.FSNotify.Listener.html#FileListener"><span class="hs-identifier hs-type">FileListener</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679064526"><span class="hs-identifier hs-type">manager</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679064527"><span class="hs-identifier hs-type">argType</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-106"></span><span>  </span><span id="WatchManager"><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-var">WatchManager</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="watchManagerConfig"><span class="annot"><span class="annottext">WatchManager -&gt; WatchConfig
</span><a href="System.FSNotify.html#watchManagerConfig"><span class="hs-identifier hs-var hs-var">watchManagerConfig</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#WatchConfig"><span class="hs-identifier hs-type">WatchConfig</span></a></span><span>
</span><span id="line-107"></span><span>               </span><span class="hs-special">,</span><span> </span><span id="watchManagerManager"><span class="annot"><span class="annottext">()
</span><a href="System.FSNotify.html#watchManagerManager"><span class="hs-identifier hs-var hs-var">watchManagerManager</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679064526"><span class="hs-identifier hs-type">manager</span></a></span><span>
</span><span id="line-108"></span><span>               </span><span class="hs-special">,</span><span> </span><span id="watchManagerCleanupVar"><span class="annot"><span class="annottext">WatchManager -&gt; MVar (Maybe (IO ()))
</span><a href="System.FSNotify.html#watchManagerCleanupVar"><span class="hs-identifier hs-var hs-var">watchManagerCleanupVar</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- cleanup action, or Nothing if the manager is stopped</span><span>
</span><span id="line-109"></span><span>               </span><span class="hs-special">,</span><span> </span><span id="watchManagerGlobalChan"><span class="annot"><span class="annottext">WatchManager -&gt; Maybe (EventAndActionChannel, Async ())
</span><a href="System.FSNotify.html#watchManagerGlobalChan"><span class="hs-identifier hs-var hs-var">watchManagerGlobalChan</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.FSNotify.Types.html#EventAndActionChannel"><span class="hs-identifier hs-type">EventAndActionChannel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Async</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>               </span><span class="hs-special">}</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-comment">-- | Default configuration</span><span>
</span><span id="line-113"></span><span class="hs-comment">--</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- * Uses OS watch mode and single thread.</span><span>
</span><span id="line-115"></span><span class="annot"><a href="System.FSNotify.html#defaultConfig"><span class="hs-identifier hs-type">defaultConfig</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#WatchConfig"><span class="hs-identifier hs-type">WatchConfig</span></a></span><span>
</span><span id="line-116"></span><span id="defaultConfig"><span class="annot"><span class="annottext">defaultConfig :: WatchConfig
</span><a href="System.FSNotify.html#defaultConfig"><span class="hs-identifier hs-var hs-var">defaultConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#WatchConfig"><span class="hs-identifier hs-type">WatchConfig</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-cpp">
#ifdef OS_BSD
</span><span>  </span><span class="hs-identifier">confWatchMode</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">WatchModePoll</span><span> </span><span class="hs-number">500000</span><span class="hs-cpp">
#else
</span><span>  </span><span class="annot"><span class="annottext">confWatchMode :: WatchMode
</span><a href="System.FSNotify.Types.html#confWatchMode"><span class="hs-identifier hs-var">confWatchMode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WatchMode
</span><a href="System.FSNotify.Types.html#WatchModeOS"><span class="hs-identifier hs-var">WatchModeOS</span></a></span><span class="hs-cpp">
#endif
</span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">confThreadingMode :: ThreadingMode
</span><a href="System.FSNotify.Types.html#confThreadingMode"><span class="hs-identifier hs-var">confThreadingMode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ThreadingMode
</span><a href="System.FSNotify.Types.html#SingleThread"><span class="hs-identifier hs-var">SingleThread</span></a></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">confOnHandlerException :: SomeException -&gt; IO ()
</span><a href="System.FSNotify.Types.html#confOnHandlerException"><span class="hs-identifier hs-var">confOnHandlerException</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; IO ()
</span><a href="System.FSNotify.html#defaultOnHandlerException"><span class="hs-identifier hs-var">defaultOnHandlerException</span></a></span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="annot"><a href="System.FSNotify.html#defaultOnHandlerException"><span class="hs-identifier hs-type">defaultOnHandlerException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span id="defaultOnHandlerException"><span class="annot"><span class="annottext">defaultOnHandlerException :: SomeException -&gt; IO ()
</span><a href="System.FSNotify.html#defaultOnHandlerException"><span class="hs-identifier hs-var hs-var">defaultOnHandlerException</span></a></span></span><span> </span><span id="local-6989586621679064540"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679064540"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;fsnotify: handler threw exception: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679064540"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="hs-comment">-- | Perform an IO action with a WatchManager in place.</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- Tear down the WatchManager after the action is complete.</span><span>
</span><span id="line-131"></span><span id="local-6989586621679064389"><span class="annot"><a href="System.FSNotify.html#withManager"><span class="hs-identifier hs-type">withManager</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679064389"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679064389"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-132"></span><span id="withManager"><span class="annot"><span class="annottext">withManager :: forall a. (WatchManager -&gt; IO a) -&gt; IO a
</span><a href="System.FSNotify.html#withManager"><span class="hs-identifier hs-var hs-var">withManager</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WatchConfig -&gt; (WatchManager -&gt; IO a) -&gt; IO a
forall a. WatchConfig -&gt; (WatchManager -&gt; IO a) -&gt; IO a
</span><a href="System.FSNotify.html#withManagerConf"><span class="hs-identifier hs-var">withManagerConf</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="System.FSNotify.html#defaultConfig"><span class="hs-identifier hs-var">defaultConfig</span></a></span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="hs-comment">-- | Start a file watch manager.</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- Directories can only be watched when they are managed by a started</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- watch manager.</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- When finished watching. you must release resources via 'stopManager'.</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- It is preferrable if possible to use 'withManager' to handle this</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- automatically.</span><span>
</span><span id="line-140"></span><span class="annot"><a href="System.FSNotify.html#startManager"><span class="hs-identifier hs-type">startManager</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span>
</span><span id="line-141"></span><span id="startManager"><span class="annot"><span class="annottext">startManager :: IO WatchManager
</span><a href="System.FSNotify.html#startManager"><span class="hs-identifier hs-var hs-var">startManager</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WatchConfig -&gt; IO WatchManager
</span><a href="System.FSNotify.html#startManagerConf"><span class="hs-identifier hs-var">startManagerConf</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="System.FSNotify.html#defaultConfig"><span class="hs-identifier hs-var">defaultConfig</span></a></span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="hs-comment">-- | Stop a file watch manager.</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- Stopping a watch manager will immediately stop</span><span>
</span><span id="line-145"></span><span class="hs-comment">-- watching for files and free resources.</span><span>
</span><span id="line-146"></span><span class="annot"><a href="System.FSNotify.html#stopManager"><span class="hs-identifier hs-type">stopManager</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span id="stopManager"><span class="annot"><span class="annottext">stopManager :: WatchManager -&gt; IO ()
</span><a href="System.FSNotify.html#stopManager"><span class="hs-identifier hs-var hs-var">stopManager</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679064552"><span id="local-6989586621679064553"><span id="local-6989586621679064554"><span id="local-6989586621679064555"><span class="annot"><span class="annottext">manager
Maybe (EventAndActionChannel, Async ())
MVar (Maybe (IO ()))
WatchConfig
watchManagerConfig :: WatchManager -&gt; WatchConfig
watchManagerManager :: ()
watchManagerCleanupVar :: WatchManager -&gt; MVar (Maybe (IO ()))
watchManagerGlobalChan :: WatchManager -&gt; Maybe (EventAndActionChannel, Async ())
watchManagerConfig :: WatchConfig
watchManagerManager :: manager
watchManagerCleanupVar :: MVar (Maybe (IO ()))
watchManagerGlobalChan :: Maybe (EventAndActionChannel, Async ())
</span><a href="System.FSNotify.html#watchManagerConfig"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-148"></span><span>  </span><span id="local-6989586621679064556"><span class="annot"><span class="annottext">Maybe (IO ())
</span><a href="#local-6989586621679064556"><span class="hs-identifier hs-var">mbCleanup</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar (Maybe (IO ())) -&gt; Maybe (IO ()) -&gt; IO (Maybe (IO ()))
forall a. MVar a -&gt; a -&gt; IO a
</span><span class="hs-identifier hs-var">swapMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe (IO ()))
</span><a href="#local-6989586621679064554"><span class="hs-identifier hs-var">watchManagerCleanupVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (IO ())
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-149"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; (IO () -&gt; IO ()) -&gt; Maybe (IO ()) -&gt; IO ()
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IO ())
</span><a href="#local-6989586621679064556"><span class="hs-identifier hs-var">mbCleanup</span></a></span><span>
</span><span id="line-150"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">manager -&gt; IO ()
forall sessionType argType.
FileListener sessionType argType =&gt;
sessionType -&gt; IO ()
</span><a href="System.FSNotify.Listener.html#killSession"><span class="hs-identifier hs-var">killSession</span></a></span><span> </span><span class="annot"><span class="annottext">manager
</span><a href="#local-6989586621679064553"><span class="hs-identifier hs-var">watchManagerManager</span></a></span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (EventAndActionChannel, Async ())
</span><a href="#local-6989586621679064555"><span class="hs-identifier hs-var">watchManagerGlobalChan</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><span class="annottext">Maybe (EventAndActionChannel, Async ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventAndActionChannel
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679064561"><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621679064561"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Async () -&gt; IO ()
forall a. Async a -&gt; IO ()
</span><span class="hs-identifier hs-var">cancel</span></span><span> </span><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621679064561"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="annot"><span class="hs-comment">-- | Like 'withManager', but configurable.</span></span><span>
</span><span id="line-156"></span><span id="local-6989586621679064391"><span class="annot"><a href="System.FSNotify.html#withManagerConf"><span class="hs-identifier hs-type">withManagerConf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#WatchConfig"><span class="hs-identifier hs-type">WatchConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679064391"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679064391"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-157"></span><span id="withManagerConf"><span class="annot"><span class="annottext">withManagerConf :: forall a. WatchConfig -&gt; (WatchManager -&gt; IO a) -&gt; IO a
</span><a href="System.FSNotify.html#withManagerConf"><span class="hs-identifier hs-var hs-var">withManagerConf</span></a></span></span><span> </span><span id="local-6989586621679064567"><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064567"><span class="hs-identifier hs-var">conf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO WatchManager
-&gt; (WatchManager -&gt; IO ()) -&gt; (WatchManager -&gt; IO a) -&gt; IO a
forall (m :: * -&gt; *) a b c.
(HasCallStack, MonadMask m) =&gt;
m a -&gt; (a -&gt; m b) -&gt; (a -&gt; m c) -&gt; m c
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchConfig -&gt; IO WatchManager
</span><a href="System.FSNotify.html#startManagerConf"><span class="hs-identifier hs-var">startManagerConf</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064567"><span class="hs-identifier hs-var">conf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WatchManager -&gt; IO ()
</span><a href="System.FSNotify.html#stopManager"><span class="hs-identifier hs-var">stopManager</span></a></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="annot"><span class="hs-comment">-- | Like 'startManager', but configurable.</span></span><span>
</span><span id="line-160"></span><span class="annot"><a href="System.FSNotify.html#startManagerConf"><span class="hs-identifier hs-type">startManagerConf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#WatchConfig"><span class="hs-identifier hs-type">WatchConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span>
</span><span id="line-161"></span><span id="startManagerConf"><span class="annot"><span class="annottext">startManagerConf :: WatchConfig -&gt; IO WatchManager
</span><a href="System.FSNotify.html#startManagerConf"><span class="hs-identifier hs-var hs-var">startManagerConf</span></a></span></span><span> </span><span id="local-6989586621679064569"><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064569"><span class="hs-identifier hs-var">conf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span class="hs-cpp">
# ifdef OS_Win32
</span><span>  </span><span class="hs-comment">-- See https://github.com/haskell-fswatch/hfsnotify/issues/50</span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-identifier">unless</span><span> </span><span class="hs-identifier">rtsSupportsBoundThreads</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">throwIO</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">userError</span><span> </span><span class="hs-string">&quot;startManagerConf must be called with -threaded on Windows&quot;</span><span class="hs-cpp">
# endif
</span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WatchConfig -&gt; WatchMode
</span><a href="System.FSNotify.Types.html#confWatchMode"><span class="hs-identifier hs-var">confWatchMode</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064569"><span class="hs-identifier hs-var">conf</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-168"></span><span>    </span><span class="annot"><a href="System.FSNotify.Types.html#WatchModePoll"><span class="hs-identifier hs-type">WatchModePoll</span></a></span><span> </span><span id="local-6989586621679064571"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679064571"><span class="hs-identifier hs-var">interval</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WatchConfig
-&gt; PollManager
-&gt; MVar (Maybe (IO ()))
-&gt; Maybe (EventAndActionChannel, Async ())
-&gt; WatchManager
forall manager argType.
FileListener manager argType =&gt;
WatchConfig
-&gt; manager
-&gt; MVar (Maybe (IO ()))
-&gt; Maybe (EventAndActionChannel, Async ())
-&gt; WatchManager
</span><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-var">WatchManager</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064569"><span class="hs-identifier hs-var">conf</span></a></span><span> </span><span class="annot"><span class="annottext">(PollManager
 -&gt; MVar (Maybe (IO ()))
 -&gt; Maybe (EventAndActionChannel, Async ())
 -&gt; WatchManager)
-&gt; IO PollManager
-&gt; IO
     (MVar (Maybe (IO ()))
      -&gt; Maybe (EventAndActionChannel, Async ()) -&gt; WatchManager)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO PollManager -&gt; IO PollManager
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; IO PollManager
</span><a href="System.FSNotify.Polling.html#createPollManager"><span class="hs-identifier hs-var">createPollManager</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679064571"><span class="hs-identifier hs-var">interval</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO
  (MVar (Maybe (IO ()))
   -&gt; Maybe (EventAndActionChannel, Async ()) -&gt; WatchManager)
-&gt; IO (MVar (Maybe (IO ())))
-&gt; IO (Maybe (EventAndActionChannel, Async ()) -&gt; WatchManager)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO (MVar (Maybe (IO ())))
</span><a href="#local-6989586621679064574"><span class="hs-identifier hs-var">cleanupVar</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe (EventAndActionChannel, Async ()) -&gt; WatchManager)
-&gt; IO (Maybe (EventAndActionChannel, Async ())) -&gt; IO WatchManager
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO (Maybe (EventAndActionChannel, Async ()))
forall {t} {a}. IO (Maybe (Chan (t, t -&gt; IO ()), Async a))
</span><a href="#local-6989586621679064575"><span class="hs-identifier hs-var">globalWatchChan</span></a></span><span class="hs-cpp">
#ifndef OS_BSD
</span><span>    </span><span class="annot"><span class="annottext">WatchMode
</span><a href="System.FSNotify.Types.html#WatchModeOS"><span class="hs-identifier hs-var">WatchModeOS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO (Either Text NativeManager) -&gt; IO (Either Text NativeManager)
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; IO (Either Text NativeManager)
forall sessionType argType.
FileListener sessionType argType =&gt;
argType -&gt; IO (Either Text sessionType)
</span><a href="System.FSNotify.Listener.html#initSession"><span class="hs-identifier hs-var">initSession</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO (Either Text NativeManager)
-&gt; (Either Text NativeManager -&gt; IO WatchManager)
-&gt; IO WatchManager
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Either Text NativeManager -&gt; IO WatchManager
</span><a href="#local-6989586621679064577"><span class="hs-identifier hs-var">createManager</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-keyword">where</span><span class="hs-cpp">
#ifndef OS_BSD
</span><span>    </span><span class="annot"><a href="#local-6989586621679064577"><span class="hs-identifier hs-type">createManager</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><a href="System.FSNotify.Linux.html#NativeManager"><span class="hs-identifier hs-type">NativeManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span>
</span><span id="line-176"></span><span>    </span><span id="local-6989586621679064577"><span class="annot"><span class="annottext">createManager :: Either Text NativeManager -&gt; IO WatchManager
</span><a href="#local-6989586621679064577"><span class="hs-identifier hs-var hs-var">createManager</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679064578"><span class="annot"><span class="annottext">NativeManager
</span><a href="#local-6989586621679064578"><span class="hs-identifier hs-var">nativeManager</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WatchConfig
-&gt; NativeManager
-&gt; MVar (Maybe (IO ()))
-&gt; Maybe (EventAndActionChannel, Async ())
-&gt; WatchManager
forall manager argType.
FileListener manager argType =&gt;
WatchConfig
-&gt; manager
-&gt; MVar (Maybe (IO ()))
-&gt; Maybe (EventAndActionChannel, Async ())
-&gt; WatchManager
</span><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-var">WatchManager</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064569"><span class="hs-identifier hs-var">conf</span></a></span><span> </span><span class="annot"><span class="annottext">NativeManager
</span><a href="#local-6989586621679064578"><span class="hs-identifier hs-var">nativeManager</span></a></span><span> </span><span class="annot"><span class="annottext">(MVar (Maybe (IO ()))
 -&gt; Maybe (EventAndActionChannel, Async ()) -&gt; WatchManager)
-&gt; IO (MVar (Maybe (IO ())))
-&gt; IO (Maybe (EventAndActionChannel, Async ()) -&gt; WatchManager)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO (MVar (Maybe (IO ())))
</span><a href="#local-6989586621679064574"><span class="hs-identifier hs-var">cleanupVar</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe (EventAndActionChannel, Async ()) -&gt; WatchManager)
-&gt; IO (Maybe (EventAndActionChannel, Async ())) -&gt; IO WatchManager
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO (Maybe (EventAndActionChannel, Async ()))
forall {t} {a}. IO (Maybe (Chan (t, t -&gt; IO ()), Async a))
</span><a href="#local-6989586621679064575"><span class="hs-identifier hs-var">globalWatchChan</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><a href="#local-6989586621679064577"><span class="hs-identifier hs-var">createManager</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679064579"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679064579"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IOError -&gt; IO WatchManager
forall (m :: * -&gt; *) e a.
(HasCallStack, MonadThrow m, Exception e) =&gt;
e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">(IOError -&gt; IO WatchManager) -&gt; IOError -&gt; IO WatchManager
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IOError
</span><span class="hs-identifier hs-var">userError</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IOError) -&gt; String -&gt; IOError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; String) -&gt; Text -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Error: couldn't start native file manager: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679064579"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-180"></span><span>    </span><span id="local-6989586621679064575"><span class="annot"><span class="annottext">globalWatchChan :: IO (Maybe (Chan (t, t -&gt; IO ()), Async a))
</span><a href="#local-6989586621679064575"><span class="hs-identifier hs-var hs-var">globalWatchChan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WatchConfig -&gt; ThreadingMode
</span><a href="System.FSNotify.Types.html#confThreadingMode"><span class="hs-identifier hs-var">confThreadingMode</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064569"><span class="hs-identifier hs-var">conf</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-181"></span><span>      </span><span class="annot"><span class="annottext">ThreadingMode
</span><a href="System.FSNotify.Types.html#SingleThread"><span class="hs-identifier hs-var">SingleThread</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-182"></span><span>        </span><span id="local-6989586621679064596"><span class="annot"><span class="annottext">Chan (t, t -&gt; IO ())
</span><a href="#local-6989586621679064596"><span class="hs-identifier hs-var">globalChan</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Chan (t, t -&gt; IO ()))
forall a. IO (Chan a)
</span><span class="hs-identifier hs-var">newChan</span></span><span>
</span><span id="line-183"></span><span>        </span><span id="local-6989586621679064598"><span class="annot"><span class="annottext">Async a
</span><a href="#local-6989586621679064598"><span class="hs-identifier hs-var">globalReaderThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO (Async a)
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO a -&gt; IO (Async a)) -&gt; IO a -&gt; IO (Async a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO a
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO a) -&gt; IO () -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-184"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679064601"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679064601"><span class="hs-identifier hs-var">event</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679064602"><span class="annot"><span class="annottext">t -&gt; IO ()
</span><a href="#local-6989586621679064602"><span class="hs-identifier hs-var">action</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Chan (t, t -&gt; IO ()) -&gt; IO (t, t -&gt; IO ())
forall a. Chan a -&gt; IO a
</span><span class="hs-identifier hs-var">readChan</span></span><span> </span><span class="annot"><span class="annottext">Chan (t, t -&gt; IO ())
</span><a href="#local-6989586621679064596"><span class="hs-identifier hs-var">globalChan</span></a></span><span>
</span><span id="line-185"></span><span>          </span><span class="annot"><span class="annottext">IO () -&gt; IO (Either SomeException ())
forall (m :: * -&gt; *) a.
(HasCallStack, MonadCatch m) =&gt;
m a -&gt; m (Either SomeException a)
</span><span class="hs-identifier hs-var">tryAny</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; IO ()
</span><a href="#local-6989586621679064602"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679064601"><span class="hs-identifier hs-var">event</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO (Either SomeException ())
-&gt; (Either SomeException () -&gt; IO ()) -&gt; IO ()
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-186"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- TODO: surface the exception somehow?</span><span>
</span><span id="line-187"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Chan (t, t -&gt; IO ()), Async a)
-&gt; IO (Maybe (Chan (t, t -&gt; IO ()), Async a))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Chan (t, t -&gt; IO ()), Async a)
 -&gt; IO (Maybe (Chan (t, t -&gt; IO ()), Async a)))
-&gt; Maybe (Chan (t, t -&gt; IO ()), Async a)
-&gt; IO (Maybe (Chan (t, t -&gt; IO ()), Async a))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Chan (t, t -&gt; IO ()), Async a)
-&gt; Maybe (Chan (t, t -&gt; IO ()), Async a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Chan (t, t -&gt; IO ())
</span><a href="#local-6989586621679064596"><span class="hs-identifier hs-var">globalChan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async a
</span><a href="#local-6989586621679064598"><span class="hs-identifier hs-var">globalReaderThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>      </span><span class="annot"><span class="annottext">ThreadingMode
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (Chan (t, t -&gt; IO ()), Async a)
-&gt; IO (Maybe (Chan (t, t -&gt; IO ()), Async a))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Chan (t, t -&gt; IO ()), Async a)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621679064574"><span class="annot"><span class="annottext">cleanupVar :: IO (MVar (Maybe (IO ())))
</span><a href="#local-6989586621679064574"><span class="hs-identifier hs-var hs-var">cleanupVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (IO ()) -&gt; IO (MVar (Maybe (IO ())))
forall a. a -&gt; IO (MVar a)
</span><span class="hs-identifier hs-var">newMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; Maybe (IO ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span class="hs-comment">-- | Watch the immediate contents of a directory by streaming events to a Chan.</span><span>
</span><span id="line-194"></span><span class="hs-comment">-- Watching the immediate contents of a directory will only report events</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- associated with files within the specified directory, and not files</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- within its subdirectories.</span><span>
</span><span id="line-197"></span><span class="annot"><a href="System.FSNotify.html#watchDirChan"><span class="hs-identifier hs-type">watchDirChan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#ActionPredicate"><span class="hs-identifier hs-type">ActionPredicate</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#EventChannel"><span class="hs-identifier hs-type">EventChannel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="System.FSNotify.Listener.html#StopListening"><span class="hs-identifier hs-type">StopListening</span></a></span><span>
</span><span id="line-198"></span><span id="watchDirChan"><span class="annot"><span class="annottext">watchDirChan :: WatchManager
-&gt; String -&gt; ActionPredicate -&gt; EventChannel -&gt; IO (IO ())
</span><a href="System.FSNotify.html#watchDirChan"><span class="hs-identifier hs-var hs-var">watchDirChan</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679064612"><span id="local-6989586621679064613"><span id="local-6989586621679064614"><span id="local-6989586621679064615"><span class="annot"><span class="annottext">manager
Maybe (EventAndActionChannel, Async ())
MVar (Maybe (IO ()))
WatchConfig
watchManagerConfig :: WatchManager -&gt; WatchConfig
watchManagerManager :: ()
watchManagerCleanupVar :: WatchManager -&gt; MVar (Maybe (IO ()))
watchManagerGlobalChan :: WatchManager -&gt; Maybe (EventAndActionChannel, Async ())
watchManagerConfig :: WatchConfig
watchManagerManager :: manager
watchManagerCleanupVar :: MVar (Maybe (IO ()))
watchManagerGlobalChan :: Maybe (EventAndActionChannel, Async ())
</span><a href="System.FSNotify.html#watchManagerConfig"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679064616"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679064616"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621679064617"><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679064617"><span class="hs-identifier hs-var">actionPredicate</span></a></span></span><span> </span><span id="local-6989586621679064618"><span class="annot"><span class="annottext">EventChannel
</span><a href="#local-6989586621679064618"><span class="hs-identifier hs-var">chan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WatchConfig
-&gt; manager
-&gt; String
-&gt; ActionPredicate
-&gt; EventCallback
-&gt; IO (IO ())
forall sessionType argType.
FileListener sessionType argType =&gt;
ListenFn sessionType argType
</span><a href="System.FSNotify.Listener.html#listen"><span class="hs-identifier hs-var">listen</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064612"><span class="hs-identifier hs-var">watchManagerConfig</span></a></span><span> </span><span class="annot"><span class="annottext">manager
</span><a href="#local-6989586621679064613"><span class="hs-identifier hs-var">watchManagerManager</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679064616"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679064617"><span class="hs-identifier hs-var">actionPredicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventChannel -&gt; EventCallback
forall a. Chan a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeChan</span></span><span> </span><span class="annot"><span class="annottext">EventChannel
</span><a href="#local-6989586621679064618"><span class="hs-identifier hs-var">chan</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span class="hs-comment">-- | Watch all the contents of a directory by streaming events to a Chan.</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- Watching all the contents of a directory will report events associated with</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- files within the specified directory and its subdirectories.</span><span>
</span><span id="line-203"></span><span class="annot"><a href="System.FSNotify.html#watchTreeChan"><span class="hs-identifier hs-type">watchTreeChan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#ActionPredicate"><span class="hs-identifier hs-type">ActionPredicate</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#EventChannel"><span class="hs-identifier hs-type">EventChannel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="System.FSNotify.Listener.html#StopListening"><span class="hs-identifier hs-type">StopListening</span></a></span><span>
</span><span id="line-204"></span><span id="watchTreeChan"><span class="annot"><span class="annottext">watchTreeChan :: WatchManager
-&gt; String -&gt; ActionPredicate -&gt; EventChannel -&gt; IO (IO ())
</span><a href="System.FSNotify.html#watchTreeChan"><span class="hs-identifier hs-var hs-var">watchTreeChan</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679064624"><span id="local-6989586621679064625"><span id="local-6989586621679064626"><span id="local-6989586621679064627"><span class="annot"><span class="annottext">manager
Maybe (EventAndActionChannel, Async ())
MVar (Maybe (IO ()))
WatchConfig
watchManagerConfig :: WatchManager -&gt; WatchConfig
watchManagerManager :: ()
watchManagerCleanupVar :: WatchManager -&gt; MVar (Maybe (IO ()))
watchManagerGlobalChan :: WatchManager -&gt; Maybe (EventAndActionChannel, Async ())
watchManagerConfig :: WatchConfig
watchManagerManager :: manager
watchManagerCleanupVar :: MVar (Maybe (IO ()))
watchManagerGlobalChan :: Maybe (EventAndActionChannel, Async ())
</span><a href="System.FSNotify.html#watchManagerConfig"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679064628"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679064628"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621679064629"><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679064629"><span class="hs-identifier hs-var">actionPredicate</span></a></span></span><span> </span><span id="local-6989586621679064630"><span class="annot"><span class="annottext">EventChannel
</span><a href="#local-6989586621679064630"><span class="hs-identifier hs-var">chan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WatchConfig
-&gt; manager
-&gt; String
-&gt; ActionPredicate
-&gt; EventCallback
-&gt; IO (IO ())
forall sessionType argType.
FileListener sessionType argType =&gt;
ListenFn sessionType argType
</span><a href="System.FSNotify.Listener.html#listenRecursive"><span class="hs-identifier hs-var">listenRecursive</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064624"><span class="hs-identifier hs-var">watchManagerConfig</span></a></span><span> </span><span class="annot"><span class="annottext">manager
</span><a href="#local-6989586621679064625"><span class="hs-identifier hs-var">watchManagerManager</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679064628"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679064629"><span class="hs-identifier hs-var">actionPredicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventChannel -&gt; EventCallback
forall a. Chan a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeChan</span></span><span> </span><span class="annot"><span class="annottext">EventChannel
</span><a href="#local-6989586621679064630"><span class="hs-identifier hs-var">chan</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span class="hs-comment">-- | Watch the immediate contents of a directory by committing an Action for each event.</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- Watching the immediate contents of a directory will only report events</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- associated with files within the specified directory, and not files</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- within its subdirectories.</span><span>
</span><span id="line-210"></span><span class="annot"><a href="System.FSNotify.html#watchDir"><span class="hs-identifier hs-type">watchDir</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#ActionPredicate"><span class="hs-identifier hs-type">ActionPredicate</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#Action"><span class="hs-identifier hs-type">Action</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="System.FSNotify.Listener.html#StopListening"><span class="hs-identifier hs-type">StopListening</span></a></span><span>
</span><span id="line-211"></span><span id="watchDir"><span class="annot"><span class="annottext">watchDir :: WatchManager
-&gt; String -&gt; ActionPredicate -&gt; EventCallback -&gt; IO (IO ())
</span><a href="System.FSNotify.html#watchDir"><span class="hs-identifier hs-var hs-var">watchDir</span></a></span></span><span> </span><span id="local-6989586621679064632"><span class="annot"><span class="annottext">wm :: WatchManager
</span><a href="#local-6989586621679064632"><span class="hs-identifier hs-var">wm</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679064634"><span class="annot"><span class="annottext">WatchConfig
watchManagerConfig :: WatchManager -&gt; WatchConfig
watchManagerConfig :: WatchConfig
</span><a href="System.FSNotify.html#watchManagerConfig"><span class="hs-identifier hs-var hs-var">watchManagerConfig</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679064635"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679064635"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span id="local-6989586621679064636"><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679064636"><span class="hs-identifier hs-var">actionPredicate</span></a></span></span><span> </span><span id="local-6989586621679064637"><span class="annot"><span class="annottext">EventCallback
</span><a href="#local-6989586621679064637"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall a b. ListenFn a b)
-&gt; WatchManager
-&gt; String
-&gt; ActionPredicate
-&gt; EventCallback
-&gt; IO (IO ())
</span><a href="System.FSNotify.html#threadChan"><span class="hs-identifier hs-var">threadChan</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
-&gt; a -&gt; String -&gt; ActionPredicate -&gt; EventCallback -&gt; IO (IO ())
forall a b. ListenFn a b
forall sessionType argType.
FileListener sessionType argType =&gt;
ListenFn sessionType argType
</span><a href="System.FSNotify.Listener.html#listen"><span class="hs-identifier hs-var">listen</span></a></span><span> </span><span class="annot"><span class="annottext">WatchManager
</span><a href="#local-6989586621679064632"><span class="hs-identifier hs-var">wm</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679064635"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679064636"><span class="hs-identifier hs-var">actionPredicate</span></a></span><span> </span><span class="annot"><span class="annottext">EventCallback
</span><a href="#local-6989586621679064642"><span class="hs-identifier hs-var">wrappedAction</span></a></span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679064642"><span class="annot"><span class="annottext">wrappedAction :: EventCallback
</span><a href="#local-6989586621679064642"><span class="hs-identifier hs-var hs-var">wrappedAction</span></a></span></span><span> </span><span id="local-6989586621679064648"><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679064648"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) e a.
(HasCallStack, MonadCatch m, Exception e) =&gt;
(e -&gt; m a) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">handle</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchConfig -&gt; SomeException -&gt; IO ()
</span><a href="System.FSNotify.Types.html#confOnHandlerException"><span class="hs-identifier hs-var">confOnHandlerException</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064634"><span class="hs-identifier hs-var">watchManagerConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventCallback
</span><a href="#local-6989586621679064637"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679064648"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span class="hs-comment">-- | Watch all the contents of a directory by committing an Action for each event.</span><span>
</span><span id="line-215"></span><span class="hs-comment">-- Watching all the contents of a directory will report events associated with</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- files within the specified directory and its subdirectories.</span><span>
</span><span id="line-217"></span><span class="annot"><a href="System.FSNotify.html#watchTree"><span class="hs-identifier hs-type">watchTree</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#ActionPredicate"><span class="hs-identifier hs-type">ActionPredicate</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#Action"><span class="hs-identifier hs-type">Action</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="System.FSNotify.Listener.html#StopListening"><span class="hs-identifier hs-type">StopListening</span></a></span><span>
</span><span id="line-218"></span><span id="watchTree"><span class="annot"><span class="annottext">watchTree :: WatchManager
-&gt; String -&gt; ActionPredicate -&gt; EventCallback -&gt; IO (IO ())
</span><a href="System.FSNotify.html#watchTree"><span class="hs-identifier hs-var hs-var">watchTree</span></a></span></span><span> </span><span id="local-6989586621679064650"><span class="annot"><span class="annottext">wm :: WatchManager
</span><a href="#local-6989586621679064650"><span class="hs-identifier hs-var">wm</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679064652"><span class="annot"><span class="annottext">WatchConfig
watchManagerConfig :: WatchManager -&gt; WatchConfig
watchManagerConfig :: WatchConfig
</span><a href="System.FSNotify.html#watchManagerConfig"><span class="hs-identifier hs-var hs-var">watchManagerConfig</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679064653"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679064653"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span id="local-6989586621679064654"><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679064654"><span class="hs-identifier hs-var">actionPredicate</span></a></span></span><span> </span><span id="local-6989586621679064655"><span class="annot"><span class="annottext">EventCallback
</span><a href="#local-6989586621679064655"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall a b. ListenFn a b)
-&gt; WatchManager
-&gt; String
-&gt; ActionPredicate
-&gt; EventCallback
-&gt; IO (IO ())
</span><a href="System.FSNotify.html#threadChan"><span class="hs-identifier hs-var">threadChan</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
-&gt; a -&gt; String -&gt; ActionPredicate -&gt; EventCallback -&gt; IO (IO ())
forall a b. ListenFn a b
forall sessionType argType.
FileListener sessionType argType =&gt;
ListenFn sessionType argType
</span><a href="System.FSNotify.Listener.html#listenRecursive"><span class="hs-identifier hs-var">listenRecursive</span></a></span><span> </span><span class="annot"><span class="annottext">WatchManager
</span><a href="#local-6989586621679064650"><span class="hs-identifier hs-var">wm</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679064653"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679064654"><span class="hs-identifier hs-var">actionPredicate</span></a></span><span> </span><span class="annot"><span class="annottext">EventCallback
</span><a href="#local-6989586621679064659"><span class="hs-identifier hs-var">wrappedAction</span></a></span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679064659"><span class="annot"><span class="annottext">wrappedAction :: EventCallback
</span><a href="#local-6989586621679064659"><span class="hs-identifier hs-var hs-var">wrappedAction</span></a></span></span><span> </span><span id="local-6989586621679064664"><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679064664"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) e a.
(HasCallStack, MonadCatch m, Exception e) =&gt;
(e -&gt; m a) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">handle</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WatchConfig -&gt; SomeException -&gt; IO ()
</span><a href="System.FSNotify.Types.html#confOnHandlerException"><span class="hs-identifier hs-var">confOnHandlerException</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064652"><span class="hs-identifier hs-var">watchManagerConfig</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventCallback
</span><a href="#local-6989586621679064655"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679064664"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span class="annot"><span class="hs-comment">-- * Main threading logic</span></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="annot"><a href="System.FSNotify.html#threadChan"><span class="hs-identifier hs-type">threadChan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679064450"><span class="annot"><a href="#local-6989586621679064450"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621679064451"><span class="annot"><a href="#local-6989586621679064451"><span class="hs-identifier hs-type">b</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="System.FSNotify.Listener.html#ListenFn"><span class="hs-identifier hs-type">ListenFn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679064450"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679064451"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#ActionPredicate"><span class="hs-identifier hs-type">ActionPredicate</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#Action"><span class="hs-identifier hs-type">Action</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="System.FSNotify.Listener.html#StopListening"><span class="hs-identifier hs-type">StopListening</span></a></span><span>
</span><span id="line-224"></span><span id="threadChan"><span class="annot"><span class="annottext">threadChan :: (forall a b. ListenFn a b)
-&gt; WatchManager
-&gt; String
-&gt; ActionPredicate
-&gt; EventCallback
-&gt; IO (IO ())
</span><a href="System.FSNotify.html#threadChan"><span class="hs-identifier hs-var hs-var">threadChan</span></a></span></span><span> </span><span id="local-6989586621679064665"><span class="annot"><span class="annottext">forall a b. ListenFn a b
</span><a href="#local-6989586621679064665"><span class="hs-identifier hs-var">listenFn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">watchManagerGlobalChan :: WatchManager -&gt; Maybe (EventAndActionChannel, Async ())
</span><a href="System.FSNotify.html#watchManagerGlobalChan"><span class="hs-identifier hs-var">watchManagerGlobalChan</span></a></span><span class="hs-glyph">=</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679064674"><span class="annot"><span class="annottext">EventAndActionChannel
</span><a href="#local-6989586621679064674"><span class="hs-identifier hs-var">globalChan</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Async ()
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679064675"><span id="local-6989586621679064676"><span id="local-6989586621679064677"><span class="annot"><span class="annottext">manager
MVar (Maybe (IO ()))
WatchConfig
watchManagerConfig :: WatchManager -&gt; WatchConfig
watchManagerManager :: ()
watchManagerCleanupVar :: WatchManager -&gt; MVar (Maybe (IO ()))
watchManagerConfig :: WatchConfig
watchManagerManager :: manager
watchManagerCleanupVar :: MVar (Maybe (IO ()))
</span><a href="System.FSNotify.html#watchManagerConfig"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679064678"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679064678"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621679064679"><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679064679"><span class="hs-identifier hs-var">actPred</span></a></span></span><span> </span><span id="local-6989586621679064680"><span class="annot"><span class="annottext">EventCallback
</span><a href="#local-6989586621679064680"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><span class="annottext">MVar (Maybe (IO ()))
-&gt; (Maybe (IO ()) -&gt; IO (Maybe (IO ()), IO ())) -&gt; IO (IO ())
forall a b. MVar a -&gt; (a -&gt; IO (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">modifyMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe (IO ()))
</span><a href="#local-6989586621679064677"><span class="hs-identifier hs-var">watchManagerCleanupVar</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (IO ()) -&gt; IO (Maybe (IO ()), IO ())) -&gt; IO (IO ()))
-&gt; (Maybe (IO ()) -&gt; IO (Maybe (IO ()), IO ())) -&gt; IO (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-226"></span><span>    </span><span class="annot"><span class="annottext">Maybe (IO ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe (IO ()), IO ()) -&gt; IO (Maybe (IO ()), IO ())
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (IO ())
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- we've been stopped. Throw an exception?</span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679064682"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679064682"><span class="hs-identifier hs-var">cleanup</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-228"></span><span>      </span><span id="local-6989586621679064683"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679064683"><span class="hs-identifier hs-var">stopListener</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IO ()) -&gt; IO (IO ())
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IO ()) -&gt; IO (IO ())) -&gt; IO (IO ()) -&gt; IO (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WatchConfig
-&gt; manager
-&gt; String
-&gt; ActionPredicate
-&gt; EventCallback
-&gt; IO (IO ())
forall a b. ListenFn a b
</span><a href="#local-6989586621679064665"><span class="hs-identifier hs-var">listenFn</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064675"><span class="hs-identifier hs-var">watchManagerConfig</span></a></span><span> </span><span class="annot"><span class="annottext">manager
</span><a href="#local-6989586621679064676"><span class="hs-identifier hs-var">watchManagerManager</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679064678"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679064679"><span class="hs-identifier hs-var">actPred</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679064684"><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679064684"><span class="hs-identifier hs-var">event</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EventAndActionChannel -&gt; (Event, EventCallback) -&gt; IO ()
forall a. Chan a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeChan</span></span><span> </span><span class="annot"><span class="annottext">EventAndActionChannel
</span><a href="#local-6989586621679064674"><span class="hs-identifier hs-var">globalChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Event
</span><a href="#local-6989586621679064684"><span class="hs-identifier hs-var">event</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EventCallback
</span><a href="#local-6989586621679064680"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>      </span><span class="annot"><span class="annottext">(Maybe (IO ()), IO ()) -&gt; IO (Maybe (IO ()), IO ())
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; Maybe (IO ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679064682"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679064683"><span class="hs-identifier hs-var">stopListener</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679064683"><span class="hs-identifier hs-var">stopListener</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span class="annot"><a href="System.FSNotify.html#threadChan"><span class="hs-identifier hs-var">threadChan</span></a></span><span> </span><span id="local-6989586621679064685"><span class="annot"><span class="annottext">forall a b. ListenFn a b
</span><a href="#local-6989586621679064685"><span class="hs-identifier hs-var">listenFn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.FSNotify.html#WatchManager"><span class="hs-identifier hs-type">WatchManager</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">watchManagerGlobalChan :: WatchManager -&gt; Maybe (EventAndActionChannel, Async ())
</span><a href="System.FSNotify.html#watchManagerGlobalChan"><span class="hs-identifier hs-var">watchManagerGlobalChan</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">Maybe (EventAndActionChannel, Async ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679064702"><span id="local-6989586621679064703"><span id="local-6989586621679064704"><span class="annot"><span class="annottext">manager
MVar (Maybe (IO ()))
WatchConfig
watchManagerConfig :: WatchManager -&gt; WatchConfig
watchManagerManager :: ()
watchManagerCleanupVar :: WatchManager -&gt; MVar (Maybe (IO ()))
watchManagerConfig :: WatchConfig
watchManagerManager :: manager
watchManagerCleanupVar :: MVar (Maybe (IO ()))
</span><a href="System.FSNotify.html#watchManagerConfig"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679064705"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679064705"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621679064706"><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679064706"><span class="hs-identifier hs-var">actPred</span></a></span></span><span> </span><span id="local-6989586621679064707"><span class="annot"><span class="annottext">EventCallback
</span><a href="#local-6989586621679064707"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-231"></span><span>  </span><span class="annot"><span class="annottext">MVar (Maybe (IO ()))
-&gt; (Maybe (IO ()) -&gt; IO (Maybe (IO ()), IO ())) -&gt; IO (IO ())
forall a b. MVar a -&gt; (a -&gt; IO (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">modifyMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar (Maybe (IO ()))
</span><a href="#local-6989586621679064704"><span class="hs-identifier hs-var">watchManagerCleanupVar</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (IO ()) -&gt; IO (Maybe (IO ()), IO ())) -&gt; IO (IO ()))
-&gt; (Maybe (IO ()) -&gt; IO (Maybe (IO ()), IO ())) -&gt; IO (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><span class="annottext">Maybe (IO ())
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Maybe (IO ()), IO ()) -&gt; IO (Maybe (IO ()), IO ())
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (IO ())
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- we've been stopped. Throw an exception?</span><span>
</span><span id="line-233"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679064708"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679064708"><span class="hs-identifier hs-var">cleanup</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>      </span><span id="local-6989586621679064709"><span class="annot"><span class="annottext">EventChannel
</span><a href="#local-6989586621679064709"><span class="hs-identifier hs-var">chan</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO EventChannel
forall a. IO (Chan a)
</span><span class="hs-identifier hs-var">newChan</span></span><span>
</span><span id="line-235"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679064712"><span class="annot"><span class="annottext">forkThreadPerEvent :: Bool
</span><a href="#local-6989586621679064712"><span class="hs-identifier hs-var hs-var">forkThreadPerEvent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WatchConfig -&gt; ThreadingMode
</span><a href="System.FSNotify.Types.html#confThreadingMode"><span class="hs-identifier hs-var">confThreadingMode</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064702"><span class="hs-identifier hs-var">watchManagerConfig</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-236"></span><span>            </span><span class="annot"><span class="annottext">ThreadingMode
</span><a href="System.FSNotify.Types.html#SingleThread"><span class="hs-identifier hs-var">SingleThread</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Bool
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Should never happen&quot;</span></span><span>
</span><span id="line-237"></span><span>            </span><span class="annot"><span class="annottext">ThreadingMode
</span><a href="System.FSNotify.Types.html#ThreadPerWatch"><span class="hs-identifier hs-var">ThreadPerWatch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-238"></span><span>            </span><span class="annot"><span class="annottext">ThreadingMode
</span><a href="System.FSNotify.Types.html#ThreadPerEvent"><span class="hs-identifier hs-var">ThreadPerEvent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-239"></span><span>      </span><span id="local-6989586621679064716"><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621679064716"><span class="hs-identifier hs-var">readerThread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; IO () -&gt; IO (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; EventChannel -&gt; IO ()
</span><a href="#local-6989586621679064717"><span class="hs-identifier hs-var">readEvents</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679064712"><span class="hs-identifier hs-var">forkThreadPerEvent</span></a></span><span> </span><span class="annot"><span class="annottext">EventChannel
</span><a href="#local-6989586621679064709"><span class="hs-identifier hs-var">chan</span></a></span><span>
</span><span id="line-240"></span><span>      </span><span id="local-6989586621679064718"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679064718"><span class="hs-identifier hs-var">stopListener</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IO ()) -&gt; IO (IO ())
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IO ()) -&gt; IO (IO ())) -&gt; IO (IO ()) -&gt; IO (IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">WatchConfig
-&gt; manager
-&gt; String
-&gt; ActionPredicate
-&gt; EventCallback
-&gt; IO (IO ())
forall a b. ListenFn a b
</span><a href="#local-6989586621679064685"><span class="hs-identifier hs-var">listenFn</span></a></span><span> </span><span class="annot"><span class="annottext">WatchConfig
</span><a href="#local-6989586621679064702"><span class="hs-identifier hs-var">watchManagerConfig</span></a></span><span> </span><span class="annot"><span class="annottext">manager
</span><a href="#local-6989586621679064703"><span class="hs-identifier hs-var">watchManagerManager</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679064705"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">ActionPredicate
</span><a href="#local-6989586621679064706"><span class="hs-identifier hs-var">actPred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EventChannel -&gt; EventCallback
forall a. Chan a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeChan</span></span><span> </span><span class="annot"><span class="annottext">EventChannel
</span><a href="#local-6989586621679064709"><span class="hs-identifier hs-var">chan</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>      </span><span class="annot"><span class="annottext">(Maybe (IO ()), IO ()) -&gt; IO (Maybe (IO ()), IO ())
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; Maybe (IO ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679064708"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679064718"><span class="hs-identifier hs-var">stopListener</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Async () -&gt; IO ()
forall a. Async a -&gt; IO ()
</span><span class="hs-identifier hs-var">cancel</span></span><span> </span><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621679064716"><span class="hs-identifier hs-var">readerThread</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679064718"><span class="hs-identifier hs-var">stopListener</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Async () -&gt; IO ()
forall a. Async a -&gt; IO ()
</span><span class="hs-identifier hs-var">cancel</span></span><span> </span><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621679064716"><span class="hs-identifier hs-var">readerThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><a href="#local-6989586621679064717"><span class="hs-identifier hs-type">readEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.FSNotify.Types.html#EventChannel"><span class="hs-identifier hs-type">EventChannel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>    </span><span id="local-6989586621679064717"><span class="annot"><span class="annottext">readEvents :: Bool -&gt; EventChannel -&gt; IO ()
</span><a href="#local-6989586621679064717"><span class="hs-identifier hs-var hs-var">readEvents</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span id="local-6989586621679064719"><span class="annot"><span class="annottext">EventChannel
</span><a href="#local-6989586621679064719"><span class="hs-identifier hs-var">chan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Async ()) -&gt; IO ()
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span> </span><span class="annot"><span class="annottext">(IO (Async ()) -&gt; IO ()) -&gt; IO (Async ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventChannel -&gt; IO Event
forall a. Chan a -&gt; IO a
</span><span class="hs-identifier hs-var">readChan</span></span><span> </span><span class="annot"><span class="annottext">EventChannel
</span><a href="#local-6989586621679064719"><span class="hs-identifier hs-var">chan</span></a></span><span> </span><span class="annot"><span class="annottext">IO Event -&gt; (Event -&gt; IO (Async ())) -&gt; IO (Async ())
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; EventCallback -&gt; Event -&gt; IO (Async ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EventCallback
</span><a href="#local-6989586621679064707"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>    </span><span class="annot"><a href="#local-6989586621679064717"><span class="hs-identifier hs-var">readEvents</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span id="local-6989586621679064721"><span class="annot"><span class="annottext">EventChannel
</span><a href="#local-6989586621679064721"><span class="hs-identifier hs-var">chan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">forever</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EventChannel -&gt; IO Event
forall a. Chan a -&gt; IO a
</span><span class="hs-identifier hs-var">readChan</span></span><span> </span><span class="annot"><span class="annottext">EventChannel
</span><a href="#local-6989586621679064721"><span class="hs-identifier hs-var">chan</span></a></span><span> </span><span class="annot"><span class="annottext">IO Event -&gt; EventCallback -&gt; IO ()
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">EventCallback
</span><a href="#local-6989586621679064707"><span class="hs-identifier hs-var">action</span></a></span><span>
</span><span id="line-247"></span></pre></body></html>