<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.Wai.Middleware.Rewrite</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><span class="hs-comment">-- * How to use this module</span></span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><span class="hs-comment">-- $howto</span></span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** A note on semantics</span></span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><span class="hs-comment">-- $semantics</span></span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Paths and Queries</span></span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><span class="hs-comment">-- $pathsandqueries</span></span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier">PathsAndQueries</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** An example rewriting paths with queries</span></span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><span class="hs-comment">-- $takeover</span></span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Upgrading from wai-extra &#8804; 3.0.16.1</span></span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><span class="hs-comment">-- $upgrading</span></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><span class="hs-comment">-- * 'Middleware'</span></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Recommended functions</span></span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewriteWithQueries"><span class="hs-identifier">rewriteWithQueries</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewritePureWithQueries"><span class="hs-identifier">rewritePureWithQueries</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewriteRoot"><span class="hs-identifier">rewriteRoot</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><span class="hs-comment">-- ** Deprecated</span></span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewrite"><span class="hs-identifier">rewrite</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewritePure"><span class="hs-identifier">rewritePure</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Operating on 'Request's</span></span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequest"><span class="hs-identifier">rewriteRequest</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestPure"><span class="hs-identifier">rewriteRequestPure</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-comment">-- GHC &#8804; 7.10 does not export Applicative functions from the prelude.</span><span class="hs-cpp">
#if __GLASGOW_HASKELL__ &lt;= 710
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Control.Applicative</span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">liftIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Functor.Identity</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Identity</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Encoding</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TE</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.HTTP.Types</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">H</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai</span></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-comment">-- $howto</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- This module provides 'Middleware' to rewrite URL paths. It also provides</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- functions that will convert a 'Request' to a modified 'Request'.</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- Both operations require a function that takes URL parameters and</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- headers, and returns new URL parameters. Parameters are pieces of URL</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- paths and query parameters.</span><span>
</span><span id="line-55"></span><span class="hs-comment">--</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- If you are a new user of the library, use 'rewriteWithQueries' or</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- 'rewritePureWithQueries' for middleware. For modifying 'Request's</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- directly, use 'rewriteRequest' or 'rewriteRequestPure'.</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-comment">-- $semantics</span><span>
</span><span id="line-61"></span><span class="hs-comment">--</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- Versions of this library in wai-extra &#8804; 3.0.16.1 exported only</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- 'rewrite' and 'rewritePure' and both modified 'rawPathInfo' of the</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- underlying requests. Such modification has been proscribed. The</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- semantics of these functions have not changed; instead the recommended</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- approach is to use 'rewriteWithQueries' and 'rewritePureWithQueries'.</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- The new functions are slightly different, as described in the section</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- on upgrading; code for previous library versions can be upgraded with</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- a single change, and as the type of the new function is different the</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- compiler will indicate where this change must be made.</span><span>
</span><span id="line-71"></span><span class="hs-comment">--</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- The 'rewriteRequest' and 'rewriteRequestPure' functions use the new</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- semantics, too.</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-comment">-- $pathsandqueries</span><span>
</span><span id="line-76"></span><span class="hs-comment">--</span><span>
</span><span id="line-77"></span><span class="hs-comment">-- This library defines the type synonym `PathsAndQueries` to make code</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- handling paths and queries easier to read.</span><span>
</span><span id="line-79"></span><span class="hs-comment">--</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- /e.g./ /\/foo\/bar/ would look like</span><span>
</span><span id="line-81"></span><span class="hs-comment">--</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- &gt; [&quot;foo&quot;, &quot;bar&quot;] :: Text</span><span>
</span><span id="line-83"></span><span class="hs-comment">--</span><span>
</span><span id="line-84"></span><span class="hs-comment">-- /?bar=baz/ would look like</span><span>
</span><span id="line-85"></span><span class="hs-comment">--</span><span>
</span><span id="line-86"></span><span class="hs-comment">-- &gt; [(&quot;bar&quot;, Just &quot;baz&quot;)] :: QueryText</span><span>
</span><span id="line-87"></span><span class="hs-comment">--</span><span>
</span><span id="line-88"></span><span class="hs-comment">-- Together,</span><span>
</span><span id="line-89"></span><span class="hs-comment">--</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- /\/foo?bar=baz/ would look like</span><span>
</span><span id="line-91"></span><span class="hs-comment">--</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- &gt; ([&quot;foo&quot;],[(&quot;bar&quot;, Just &quot;baz&quot;)]) :: PathsAndQueries</span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="hs-comment">-- $takeover</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- Let&#8217;s say we want to replace a website written in PHP with one written</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- using WAI. We&#8217;ll use the</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- &lt;https://hackage.haskell.org/package/http-reverse-proxy http-reverse-proxy&gt;</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- package to serve the old</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- site from the new site, but there&#8217;s a problem. The old site uses pages like</span><span>
</span><span id="line-100"></span><span class="hs-comment">--</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- index.php?page=/page/</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-104"></span><span class="hs-comment">--</span><span>
</span><span id="line-105"></span><span class="hs-comment">-- whereas the new site would look like</span><span>
</span><span id="line-106"></span><span class="hs-comment">--</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- index\//page/</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-110"></span><span class="hs-comment">--</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- In doing this, we want to separate the migration code from our new</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- website. So we&#8217;d like to handle links internally using the path</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- formulation, but externally have the old links still work.</span><span>
</span><span id="line-114"></span><span class="hs-comment">--</span><span>
</span><span id="line-115"></span><span class="hs-comment">-- Therefore, we will use middleware ('rewritePureWithQueries') from this</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- module to rewrite incoming requests from the query formulation to the</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- paths formulation.</span><span>
</span><span id="line-118"></span><span class="hs-comment">--</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- &gt; {-# LANGUAGE ViewPatterns #-}</span><span>
</span><span id="line-120"></span><span class="hs-comment">-- &gt;</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- &gt; rewritePathFromPhp :: Middleware</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- &gt; rewritePathFromPhp = rewritePureWithQueries pathFromPhp</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- &gt;</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- &gt; pathFromPhp :: PathsAndQueries -&gt; H.RequestHeaders -&gt; PathsAndQueries</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- &gt; pathFromPhp (pieces, queries) _ = piecesConvert pieces queries</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- &gt;     where</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- &gt;         piecesConvert :: [Text] -&gt; H.Query -&gt; PathsAndQueries</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- &gt;         piecesConvert [&quot;index.php&quot;] qs@(join . lookup &quot;page&quot; -&gt; Just page) =</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- &gt;             ( [&quot;index&quot;, TE.decodeUtf8With TE.lenientDecode page]</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- &gt;             , delete (&quot;page&quot;, pure page) qs</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- &gt;             )</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- &gt;         piecesConvert ps qs = (ps, qs)</span><span>
</span><span id="line-133"></span><span class="hs-comment">--</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- On the other side, we will use 'rewriteRequestPure' to rewrite outgoing</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- requests to the original website from the reverse proxy code (using the</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- 'Network.HTTP.ReverseProxy.WPRModifiedRequest' or</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- 'Network.HTTP.ReverseProxy.WPRModifiedRequestSecure' constructors. Note,</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- these links will only work if the haddock documentation for</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- &lt;https://hackage.haskell.org/package/http-reverse-proxy http-reverse-proxy&gt;</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- is installed).</span><span>
</span><span id="line-141"></span><span class="hs-comment">--</span><span>
</span><span id="line-142"></span><span class="hs-comment">-- &gt; rewritePhpFromPath :: Request -&gt; Request</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- &gt; rewritePhpFromPath = rewriteRequestPure phpFromPath</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- &gt;</span><span>
</span><span id="line-145"></span><span class="hs-comment">-- &gt; phpFromPath :: PathsAndQueries -&gt; H.RequestHeaders -&gt; PathsAndQueries</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- &gt; phpFromPath (pieces, queries) _ = piecesConvert pieces queries</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- &gt;     where</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- &gt;         piecesConvert :: [Text] -&gt; H.Query -&gt; PathsAndQueries</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- &gt;         piecesConvert [&quot;index&quot;, page] qs = ( [&quot;index.php&quot;], (&quot;page&quot;, pure . TE.encodeUtf8 $ page) : qs )</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- &gt;         piecesConvert ps qs = (ps, qs)</span><span>
</span><span id="line-151"></span><span class="hs-comment">--</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- For the whole example, see</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- &lt;https://gist.github.com/dbaynard/c844d0df124f68ec8b6da152c581ce6d&gt;.</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-comment">-- $upgrading</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- It is quite simple to upgrade from 'rewrite' and 'rewritePure', to</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- 'rewriteWithQueries' and 'rewritePureWithQueries'.</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- Insert 'Data.Bifunctor.first', which specialises to</span><span>
</span><span id="line-159"></span><span class="hs-comment">--</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- 'Data.Bifunctor.first' :: (['Text'] -&gt; ['Text']) -&gt; 'PathsAndQueries' -&gt; 'PathsAndQueries'</span><span>
</span><span id="line-162"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-163"></span><span class="hs-comment">--</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- as the following example demonstrates.</span><span>
</span><span id="line-165"></span><span class="hs-comment">--</span><span>
</span><span id="line-166"></span><span class="hs-comment">-- Old versions of the library could only handle path pieces, not queries.</span><span>
</span><span id="line-167"></span><span class="hs-comment">-- This could have been supplied to 'rewritePure'.</span><span>
</span><span id="line-168"></span><span class="hs-comment">--</span><span>
</span><span id="line-169"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-170"></span><span class="hs-comment">-- staticConvert' :: [Text] -&gt; H.RequestHeaders -&gt; [Text]</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- staticConvert' pieces _ = piecesConvert pieces</span><span>
</span><span id="line-172"></span><span class="hs-comment">--   where</span><span>
</span><span id="line-173"></span><span class="hs-comment">--    piecesConvert [] = [&quot;static&quot;, &quot;html&quot;, &quot;pages.html&quot;]</span><span>
</span><span id="line-174"></span><span class="hs-comment">--    piecesConvert route@(&quot;pages&quot;:_) = &quot;static&quot;:&quot;html&quot;:route</span><span>
</span><span id="line-175"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-176"></span><span class="hs-comment">--</span><span>
</span><span id="line-177"></span><span class="hs-comment">-- Instead, use this function, supplied to 'rewritePureWithQueries'.</span><span>
</span><span id="line-178"></span><span class="hs-comment">--</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- staticConvert :: 'PathsAndQueries' -&gt; H.RequestHeaders -&gt; 'PathsAndQueries'</span><span>
</span><span id="line-181"></span><span class="hs-comment">-- staticConvert pathsAndQueries _ = 'Data.Bifunctor.first' piecesConvert pathsAndQueries</span><span>
</span><span id="line-182"></span><span class="hs-comment">--   where</span><span>
</span><span id="line-183"></span><span class="hs-comment">--    piecesConvert [] = [&quot;static&quot;, &quot;html&quot;, &quot;pages.html&quot;]</span><span>
</span><span id="line-184"></span><span class="hs-comment">--    piecesConvert route@(&quot;pages&quot;:_) = &quot;static&quot;:&quot;html&quot;:route</span><span>
</span><span id="line-185"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-186"></span><span class="hs-comment">--</span><span>
</span><span id="line-187"></span><span class="hs-comment">-- The former formulation is deprecated for two reasons:</span><span>
</span><span id="line-188"></span><span class="hs-comment">--</span><span>
</span><span id="line-189"></span><span class="hs-comment">--   1. The original formulation of 'rewrite' modified 'rawPathInfo', which</span><span>
</span><span id="line-190"></span><span class="hs-comment">--   is deprecated behaviour.</span><span>
</span><span id="line-191"></span><span class="hs-comment">--</span><span>
</span><span id="line-192"></span><span class="hs-comment">--   2. The original formulation did not allow query parameters to</span><span>
</span><span id="line-193"></span><span class="hs-comment">--   influence the path.</span><span>
</span><span id="line-194"></span><span class="hs-comment">--</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- Concerning the first point, take care with semantics of your program when</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- upgrading as the upgraded functions no longer modify 'rawPathInfo'.</span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span class="annot"><span class="hs-comment">-- * Types</span></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span class="hs-comment">-- | A tuple of the path sections as ['Text'] and query parameters as</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- 'H.Query'. This makes writing type signatures for the conversion</span><span>
</span><span id="line-206"></span><span class="hs-comment">-- function far more pleasant.</span><span>
</span><span id="line-207"></span><span class="hs-comment">--</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- Note that this uses 'H.Query' not 'H.QueryText' to more accurately</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- reflect the paramaters that can be supplied in URLs. It may be safe to</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- treat parameters as text; use the 'H.queryToQueryText' and</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- 'H.queryTextToQuery' functions to interconvert.</span><span>
</span><span id="line-212"></span><span class="hs-keyword">type</span><span> </span><span id="PathsAndQueries"><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-var">PathsAndQueries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.Query</span></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>
</span><span id="line-214"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-215"></span><span>
</span><span id="line-216"></span><span class="annot"><span class="hs-comment">-- * Rewriting 'Middleware'</span></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="hs-comment">-- | Rewrite based on your own conversion function for paths only, to be</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- supplied by users of this library (with the conversion operating in 'IO').</span><span>
</span><span id="line-222"></span><span class="hs-comment">--</span><span>
</span><span id="line-223"></span><span class="hs-comment">-- For new code, use 'rewriteWithQueries' instead.</span><span>
</span><span id="line-224"></span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewrite"><span class="hs-identifier hs-type">rewrite</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.RequestHeaders</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Middleware</span></span><span>
</span><span id="line-225"></span><span id="rewrite"><span class="annot"><span class="annottext">rewrite :: ([Text] -&gt; RequestHeaders -&gt; IO [Text]) -&gt; Middleware
</span><a href="Network.Wai.Middleware.Rewrite.html#rewrite"><span class="hs-identifier hs-var hs-var">rewrite</span></a></span></span><span> </span><span id="local-6989586621679127220"><span class="annot"><span class="annottext">[Text] -&gt; RequestHeaders -&gt; IO [Text]
</span><a href="#local-6989586621679127220"><span class="hs-identifier hs-var">convert</span></a></span></span><span> </span><span id="local-6989586621679127221"><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621679127221"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621679127222"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127222"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621679127223"><span class="annot"><span class="annottext">Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621679127223"><span class="hs-identifier hs-var">sendResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679127235"><span class="annot"><span class="annottext">convertIO :: PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries
</span><a href="#local-6989586621679127235"><span class="hs-identifier hs-var hs-var">convertIO</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; RequestHeaders -&gt; IO [Text])
-&gt; PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries
forall (m :: * -&gt; *).
(Applicative m, Monad m) =&gt;
([Text] -&gt; RequestHeaders -&gt; m [Text])
-&gt; PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries
</span><a href="Network.Wai.Middleware.Rewrite.html#pathsOnly"><span class="hs-identifier hs-var">pathsOnly</span></a></span><span> </span><span class="annot"><span class="annottext">(([Text] -&gt; RequestHeaders -&gt; IO [Text])
 -&gt; PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries)
-&gt; ((([Text], RequestHeaders) -&gt; IO [Text])
    -&gt; [Text] -&gt; RequestHeaders -&gt; IO [Text])
-&gt; (([Text], RequestHeaders) -&gt; IO [Text])
-&gt; PathsAndQueries
-&gt; RequestHeaders
-&gt; IO PathsAndQueries
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(([Text], RequestHeaders) -&gt; IO [Text])
-&gt; [Text] -&gt; RequestHeaders -&gt; IO [Text]
forall a b c. ((a, b) -&gt; c) -&gt; a -&gt; b -&gt; c
</span><span class="hs-identifier hs-var">curry</span></span><span> </span><span class="annot"><span class="annottext">((([Text], RequestHeaders) -&gt; IO [Text])
 -&gt; PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries)
-&gt; (([Text], RequestHeaders) -&gt; IO [Text])
-&gt; PathsAndQueries
-&gt; RequestHeaders
-&gt; IO PathsAndQueries
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO [Text] -&gt; IO [Text]
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO [Text] -&gt; IO [Text])
-&gt; (([Text], RequestHeaders) -&gt; IO [Text])
-&gt; ([Text], RequestHeaders)
-&gt; IO [Text]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; RequestHeaders -&gt; IO [Text])
-&gt; ([Text], RequestHeaders) -&gt; IO [Text]
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; RequestHeaders -&gt; IO [Text]
</span><a href="#local-6989586621679127220"><span class="hs-identifier hs-var">convert</span></a></span><span>
</span><span id="line-227"></span><span>    </span><span id="local-6989586621679127240"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127240"><span class="hs-identifier hs-var">newReq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries)
-&gt; Request -&gt; IO Request
forall (m :: * -&gt; *).
(Applicative m, Monad m) =&gt;
(PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries)
-&gt; Request -&gt; m Request
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestRawM"><span class="hs-identifier hs-var">rewriteRequestRawM</span></a></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries
</span><a href="#local-6989586621679127235"><span class="hs-identifier hs-var">convertIO</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127222"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621679127221"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127240"><span class="hs-identifier hs-var">newReq</span></a></span><span> </span><span class="annot"><span class="annottext">Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621679127223"><span class="hs-identifier hs-var">sendResponse</span></a></span><span>
</span><span id="line-229"></span><span class="hs-pragma">{-# WARNING</span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-pragma">rewrite</span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-pragma">[</span><span> </span><span class="hs-pragma">&quot;This modifies the 'rawPathInfo' field of a 'Request'.&quot;</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-pragma">,</span><span> </span><span class="hs-pragma">&quot; This is not recommended behaviour; it is however how&quot;</span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-pragma">,</span><span> </span><span class="hs-pragma">&quot; this function has worked in the past.&quot;</span><span>
</span><span id="line-234"></span><span>    </span><span class="hs-pragma">,</span><span> </span><span class="hs-pragma">&quot; Use 'rewriteWithQueries' instead&quot;</span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-pragma">]</span><span>
</span><span id="line-236"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span class="hs-comment">-- | Rewrite based on pure conversion function for paths only, to be</span><span>
</span><span id="line-239"></span><span class="hs-comment">-- supplied by users of this library.</span><span>
</span><span id="line-240"></span><span class="hs-comment">--</span><span>
</span><span id="line-241"></span><span class="hs-comment">-- For new code, use 'rewritePureWithQueries' instead.</span><span>
</span><span id="line-242"></span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewritePure"><span class="hs-identifier hs-type">rewritePure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.RequestHeaders</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Middleware</span></span><span>
</span><span id="line-243"></span><span id="rewritePure"><span class="annot"><span class="annottext">rewritePure :: ([Text] -&gt; RequestHeaders -&gt; [Text]) -&gt; Middleware
</span><a href="Network.Wai.Middleware.Rewrite.html#rewritePure"><span class="hs-identifier hs-var hs-var">rewritePure</span></a></span></span><span> </span><span id="local-6989586621679127242"><span class="annot"><span class="annottext">[Text] -&gt; RequestHeaders -&gt; [Text]
</span><a href="#local-6989586621679127242"><span class="hs-identifier hs-var">convert</span></a></span></span><span> </span><span id="local-6989586621679127243"><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621679127243"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621679127244"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127244"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679127247"><span class="annot"><span class="annottext">convertPure :: PathsAndQueries -&gt; RequestHeaders -&gt; Identity PathsAndQueries
</span><a href="#local-6989586621679127247"><span class="hs-identifier hs-var hs-var">convertPure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; RequestHeaders -&gt; Identity [Text])
-&gt; PathsAndQueries -&gt; RequestHeaders -&gt; Identity PathsAndQueries
forall (m :: * -&gt; *).
(Applicative m, Monad m) =&gt;
([Text] -&gt; RequestHeaders -&gt; m [Text])
-&gt; PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries
</span><a href="Network.Wai.Middleware.Rewrite.html#pathsOnly"><span class="hs-identifier hs-var">pathsOnly</span></a></span><span> </span><span class="annot"><span class="annottext">(([Text] -&gt; RequestHeaders -&gt; Identity [Text])
 -&gt; PathsAndQueries -&gt; RequestHeaders -&gt; Identity PathsAndQueries)
-&gt; ((([Text], RequestHeaders) -&gt; Identity [Text])
    -&gt; [Text] -&gt; RequestHeaders -&gt; Identity [Text])
-&gt; (([Text], RequestHeaders) -&gt; Identity [Text])
-&gt; PathsAndQueries
-&gt; RequestHeaders
-&gt; Identity PathsAndQueries
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(([Text], RequestHeaders) -&gt; Identity [Text])
-&gt; [Text] -&gt; RequestHeaders -&gt; Identity [Text]
forall a b c. ((a, b) -&gt; c) -&gt; a -&gt; b -&gt; c
</span><span class="hs-identifier hs-var">curry</span></span><span> </span><span class="annot"><span class="annottext">((([Text], RequestHeaders) -&gt; Identity [Text])
 -&gt; PathsAndQueries -&gt; RequestHeaders -&gt; Identity PathsAndQueries)
-&gt; (([Text], RequestHeaders) -&gt; Identity [Text])
-&gt; PathsAndQueries
-&gt; RequestHeaders
-&gt; Identity PathsAndQueries
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Identity [Text]
forall a. a -&gt; Identity a
</span><span class="hs-identifier hs-var">Identity</span></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Identity [Text])
-&gt; (([Text], RequestHeaders) -&gt; [Text])
-&gt; ([Text], RequestHeaders)
-&gt; Identity [Text]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; RequestHeaders -&gt; [Text])
-&gt; ([Text], RequestHeaders) -&gt; [Text]
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; RequestHeaders -&gt; [Text]
</span><a href="#local-6989586621679127242"><span class="hs-identifier hs-var">convert</span></a></span><span>
</span><span id="line-245"></span><span>        </span><span id="local-6989586621679127251"><span class="annot"><span class="annottext">newReq :: Request
</span><a href="#local-6989586621679127251"><span class="hs-identifier hs-var hs-var">newReq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity Request -&gt; Request
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity Request -&gt; Request) -&gt; Identity Request -&gt; Request
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PathsAndQueries -&gt; RequestHeaders -&gt; Identity PathsAndQueries)
-&gt; Request -&gt; Identity Request
forall (m :: * -&gt; *).
(Applicative m, Monad m) =&gt;
(PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries)
-&gt; Request -&gt; m Request
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestRawM"><span class="hs-identifier hs-var">rewriteRequestRawM</span></a></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; Identity PathsAndQueries
</span><a href="#local-6989586621679127247"><span class="hs-identifier hs-var">convertPure</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127244"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-246"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621679127243"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127251"><span class="hs-identifier hs-var">newReq</span></a></span><span>
</span><span id="line-247"></span><span class="hs-pragma">{-# WARNING</span><span>
</span><span id="line-248"></span><span>    </span><span class="hs-pragma">rewritePure</span><span>
</span><span id="line-249"></span><span>    </span><span class="hs-pragma">[</span><span> </span><span class="hs-pragma">&quot;This modifies the 'rawPathInfo' field of a 'Request'.&quot;</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-pragma">,</span><span> </span><span class="hs-pragma">&quot; This is not recommended behaviour; it is however how&quot;</span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-pragma">,</span><span> </span><span class="hs-pragma">&quot; this function has worked in the past.&quot;</span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-pragma">,</span><span> </span><span class="hs-pragma">&quot; Use 'rewritePureWithQueries' instead&quot;</span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-pragma">]</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span class="hs-comment">-- | Rewrite based on your own conversion function for paths and queries.</span><span>
</span><span id="line-257"></span><span class="hs-comment">-- This function is to be supplied by users of this library, and operates</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- in 'IO'.</span><span>
</span><span id="line-259"></span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewriteWithQueries"><span class="hs-identifier hs-type">rewriteWithQueries</span></a></span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.RequestHeaders</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Middleware</span></span><span>
</span><span id="line-262"></span><span id="rewriteWithQueries"><span class="annot"><span class="annottext">rewriteWithQueries :: (PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries)
-&gt; Middleware
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteWithQueries"><span class="hs-identifier hs-var hs-var">rewriteWithQueries</span></a></span></span><span> </span><span id="local-6989586621679127253"><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries
</span><a href="#local-6989586621679127253"><span class="hs-identifier hs-var">convert</span></a></span></span><span> </span><span id="local-6989586621679127254"><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621679127254"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621679127255"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127255"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span id="local-6989586621679127256"><span class="annot"><span class="annottext">Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621679127256"><span class="hs-identifier hs-var">sendResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>    </span><span id="local-6989586621679127257"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127257"><span class="hs-identifier hs-var">newReq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries)
-&gt; Request -&gt; IO Request
forall (m :: * -&gt; *).
(Applicative m, Monad m) =&gt;
(PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries)
-&gt; Request -&gt; m Request
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestM"><span class="hs-identifier hs-var">rewriteRequestM</span></a></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries
</span><a href="#local-6989586621679127253"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127255"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621679127254"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127257"><span class="hs-identifier hs-var">newReq</span></a></span><span> </span><span class="annot"><span class="annottext">Response -&gt; IO ResponseReceived
</span><a href="#local-6989586621679127256"><span class="hs-identifier hs-var">sendResponse</span></a></span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span class="hs-comment">-- | Rewrite based on pure conversion function for paths and queries. This</span><span>
</span><span id="line-267"></span><span class="hs-comment">-- function is to be supplied by users of this library.</span><span>
</span><span id="line-268"></span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewritePureWithQueries"><span class="hs-identifier hs-type">rewritePureWithQueries</span></a></span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.RequestHeaders</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Middleware</span></span><span>
</span><span id="line-271"></span><span id="rewritePureWithQueries"><span class="annot"><span class="annottext">rewritePureWithQueries :: (PathsAndQueries -&gt; RequestHeaders -&gt; PathsAndQueries)
-&gt; Middleware
</span><a href="Network.Wai.Middleware.Rewrite.html#rewritePureWithQueries"><span class="hs-identifier hs-var hs-var">rewritePureWithQueries</span></a></span></span><span> </span><span id="local-6989586621679127259"><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; PathsAndQueries
</span><a href="#local-6989586621679127259"><span class="hs-identifier hs-var">convert</span></a></span></span><span> </span><span id="local-6989586621679127260"><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621679127260"><span class="hs-identifier hs-var">app</span></a></span></span><span> </span><span id="local-6989586621679127261"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127261"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Application
</span><a href="#local-6989586621679127260"><span class="hs-identifier hs-var">app</span></a></span><span> </span><span class="annot"><span class="annottext">Middleware
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PathsAndQueries -&gt; RequestHeaders -&gt; PathsAndQueries)
-&gt; Request -&gt; Request
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestPure"><span class="hs-identifier hs-var">rewriteRequestPure</span></a></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; PathsAndQueries
</span><a href="#local-6989586621679127259"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127261"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span class="hs-comment">-- | Rewrite root requests (/) to a specified path</span><span>
</span><span id="line-274"></span><span class="hs-comment">--</span><span>
</span><span id="line-275"></span><span class="hs-comment">-- Note that /index.html/ in example below should already be a valid route.</span><span>
</span><span id="line-276"></span><span class="hs-comment">--</span><span>
</span><span id="line-277"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-278"></span><span class="hs-comment">--     rewriteRoot &quot;index.html&quot; :: Middleware</span><span>
</span><span id="line-279"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-280"></span><span class="hs-comment">--</span><span>
</span><span id="line-281"></span><span class="hs-comment">-- @since 3.0.23.0</span><span>
</span><span id="line-282"></span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewriteRoot"><span class="hs-identifier hs-type">rewriteRoot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Middleware</span></span><span>
</span><span id="line-283"></span><span id="rewriteRoot"><span class="annot"><span class="annottext">rewriteRoot :: Text -&gt; Middleware
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteRoot"><span class="hs-identifier hs-var hs-var">rewriteRoot</span></a></span></span><span> </span><span id="local-6989586621679127262"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679127262"><span class="hs-identifier hs-var">root</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PathsAndQueries -&gt; RequestHeaders -&gt; PathsAndQueries)
-&gt; Middleware
</span><a href="Network.Wai.Middleware.Rewrite.html#rewritePureWithQueries"><span class="hs-identifier hs-var">rewritePureWithQueries</span></a></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; PathsAndQueries
forall {b} {p}. ([Text], b) -&gt; p -&gt; ([Text], b)
</span><a href="#local-6989586621679127263"><span class="hs-identifier hs-var">onlyRoot</span></a></span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-285"></span><span>    </span><span id="local-6989586621679127263"><span class="annot"><span class="annottext">onlyRoot :: ([Text], b) -&gt; p -&gt; ([Text], b)
</span><a href="#local-6989586621679127263"><span class="hs-identifier hs-var hs-var">onlyRoot</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679127264"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679127264"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679127262"><span class="hs-identifier hs-var">root</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679127264"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>    </span><span class="annot"><a href="#local-6989586621679127263"><span class="hs-identifier hs-var">onlyRoot</span></a></span><span> </span><span id="local-6989586621679127265"><span class="annot"><span class="annottext">([Text], b)
</span><a href="#local-6989586621679127265"><span class="hs-identifier hs-var">paths</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Text], b)
</span><a href="#local-6989586621679127265"><span class="hs-identifier hs-var">paths</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-289"></span><span>
</span><span id="line-290"></span><span class="annot"><span class="hs-comment">-- * Modifying 'Request's directly</span></span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-293"></span><span>
</span><span id="line-294"></span><span class="hs-comment">-- | Modify a 'Request' using the supplied function in 'IO'. This is suitable for</span><span>
</span><span id="line-295"></span><span class="hs-comment">-- the reverse proxy example.</span><span>
</span><span id="line-296"></span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequest"><span class="hs-identifier hs-type">rewriteRequest</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.RequestHeaders</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span>
</span><span id="line-300"></span><span id="rewriteRequest"><span class="annot"><span class="annottext">rewriteRequest :: (PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries)
-&gt; Request -&gt; IO Request
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequest"><span class="hs-identifier hs-var hs-var">rewriteRequest</span></a></span></span><span> </span><span id="local-6989586621679127266"><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries
</span><a href="#local-6989586621679127266"><span class="hs-identifier hs-var">convert</span></a></span></span><span> </span><span id="local-6989586621679127267"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127267"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679127272"><span class="annot"><span class="annottext">convertIO :: PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries
</span><a href="#local-6989586621679127272"><span class="hs-identifier hs-var hs-var">convertIO</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((PathsAndQueries, RequestHeaders) -&gt; IO PathsAndQueries)
-&gt; PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries
forall a b c. ((a, b) -&gt; c) -&gt; a -&gt; b -&gt; c
</span><span class="hs-identifier hs-var">curry</span></span><span> </span><span class="annot"><span class="annottext">(((PathsAndQueries, RequestHeaders) -&gt; IO PathsAndQueries)
 -&gt; PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries)
-&gt; ((PathsAndQueries, RequestHeaders) -&gt; IO PathsAndQueries)
-&gt; PathsAndQueries
-&gt; RequestHeaders
-&gt; IO PathsAndQueries
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO PathsAndQueries -&gt; IO PathsAndQueries
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO PathsAndQueries -&gt; IO PathsAndQueries)
-&gt; ((PathsAndQueries, RequestHeaders) -&gt; IO PathsAndQueries)
-&gt; (PathsAndQueries, RequestHeaders)
-&gt; IO PathsAndQueries
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries)
-&gt; (PathsAndQueries, RequestHeaders) -&gt; IO PathsAndQueries
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries
</span><a href="#local-6989586621679127266"><span class="hs-identifier hs-var">convert</span></a></span><span>
</span><span id="line-302"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries)
-&gt; Request -&gt; IO Request
forall (m :: * -&gt; *).
(Applicative m, Monad m) =&gt;
(PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries)
-&gt; Request -&gt; m Request
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestRawM"><span class="hs-identifier hs-var">rewriteRequestRawM</span></a></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; IO PathsAndQueries
</span><a href="#local-6989586621679127272"><span class="hs-identifier hs-var">convertIO</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127267"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span class="hs-comment">-- | Modify a 'Request' using the pure supplied function. This is suitable for</span><span>
</span><span id="line-305"></span><span class="hs-comment">-- the reverse proxy example.</span><span>
</span><span id="line-306"></span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestPure"><span class="hs-identifier hs-type">rewriteRequestPure</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.RequestHeaders</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span>
</span><span id="line-310"></span><span id="rewriteRequestPure"><span class="annot"><span class="annottext">rewriteRequestPure :: (PathsAndQueries -&gt; RequestHeaders -&gt; PathsAndQueries)
-&gt; Request -&gt; Request
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestPure"><span class="hs-identifier hs-var hs-var">rewriteRequestPure</span></a></span></span><span> </span><span id="local-6989586621679127273"><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; PathsAndQueries
</span><a href="#local-6989586621679127273"><span class="hs-identifier hs-var">convert</span></a></span></span><span> </span><span id="local-6989586621679127274"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127274"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679127275"><span class="annot"><span class="annottext">convertPure :: PathsAndQueries -&gt; RequestHeaders -&gt; Identity PathsAndQueries
</span><a href="#local-6989586621679127275"><span class="hs-identifier hs-var hs-var">convertPure</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((PathsAndQueries, RequestHeaders) -&gt; Identity PathsAndQueries)
-&gt; PathsAndQueries -&gt; RequestHeaders -&gt; Identity PathsAndQueries
forall a b c. ((a, b) -&gt; c) -&gt; a -&gt; b -&gt; c
</span><span class="hs-identifier hs-var">curry</span></span><span> </span><span class="annot"><span class="annottext">(((PathsAndQueries, RequestHeaders) -&gt; Identity PathsAndQueries)
 -&gt; PathsAndQueries -&gt; RequestHeaders -&gt; Identity PathsAndQueries)
-&gt; ((PathsAndQueries, RequestHeaders) -&gt; Identity PathsAndQueries)
-&gt; PathsAndQueries
-&gt; RequestHeaders
-&gt; Identity PathsAndQueries
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries -&gt; Identity PathsAndQueries
forall a. a -&gt; Identity a
</span><span class="hs-identifier hs-var">Identity</span></span><span> </span><span class="annot"><span class="annottext">(PathsAndQueries -&gt; Identity PathsAndQueries)
-&gt; ((PathsAndQueries, RequestHeaders) -&gt; PathsAndQueries)
-&gt; (PathsAndQueries, RequestHeaders)
-&gt; Identity PathsAndQueries
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PathsAndQueries -&gt; RequestHeaders -&gt; PathsAndQueries)
-&gt; (PathsAndQueries, RequestHeaders) -&gt; PathsAndQueries
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; PathsAndQueries
</span><a href="#local-6989586621679127273"><span class="hs-identifier hs-var">convert</span></a></span><span>
</span><span id="line-312"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Identity Request -&gt; Request
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity Request -&gt; Request) -&gt; Identity Request -&gt; Request
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PathsAndQueries -&gt; RequestHeaders -&gt; Identity PathsAndQueries)
-&gt; Request -&gt; Identity Request
forall (m :: * -&gt; *).
(Applicative m, Monad m) =&gt;
(PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries)
-&gt; Request -&gt; m Request
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestRawM"><span class="hs-identifier hs-var">rewriteRequestRawM</span></a></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; Identity PathsAndQueries
</span><a href="#local-6989586621679127275"><span class="hs-identifier hs-var">convertPure</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127274"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span class="annot"><span class="hs-comment">-- * Helper functions</span></span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span class="hs-comment">--------------------------------------------------</span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="annot"><span class="hs-comment">-- | This helper function factors out the common behaviour of rewriting requests.</span></span><span>
</span><span id="line-321"></span><span id="local-6989586621679127276"><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestM"><span class="hs-identifier hs-type">rewriteRequestM</span></a></span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621679127276"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679127276"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.RequestHeaders</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679127276"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679127276"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span></span><span>
</span><span id="line-326"></span><span id="rewriteRequestM"><span class="annot"><span class="annottext">rewriteRequestM :: forall (m :: * -&gt; *).
(Applicative m, Monad m) =&gt;
(PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries)
-&gt; Request -&gt; m Request
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestM"><span class="hs-identifier hs-var hs-var">rewriteRequestM</span></a></span></span><span> </span><span id="local-6989586621679127281"><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries
</span><a href="#local-6989586621679127281"><span class="hs-identifier hs-var">convert</span></a></span></span><span> </span><span id="local-6989586621679127282"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127282"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679127283"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679127283"><span class="hs-identifier hs-var">pInfo</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679127284"><span class="annot"><span class="annottext">Query
</span><a href="#local-6989586621679127284"><span class="hs-identifier hs-var">qByteStrings</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-328"></span><span>        </span><span class="annot"><span class="annottext">(PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries)
-&gt; [Text] -&gt; Query -&gt; RequestHeaders -&gt; m PathsAndQueries
forall a b c. ((a, b) -&gt; c) -&gt; a -&gt; b -&gt; c
</span><span class="hs-identifier hs-var">curry</span></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries
</span><a href="#local-6989586621679127281"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request -&gt; [Text]
</span><span class="hs-identifier hs-var">pathInfo</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127282"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request -&gt; Query
</span><span class="hs-identifier hs-var">queryString</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127282"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Request -&gt; RequestHeaders
</span><span class="hs-identifier hs-var">requestHeaders</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127282"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>    </span><span class="annot"><span class="annottext">Request -&gt; m Request
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127282"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">{</span><span class="annot"><span class="hs-identifier hs-var">pathInfo</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679127283"><span class="hs-identifier hs-type">pInfo</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">queryString</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679127284"><span class="hs-identifier hs-type">qByteStrings</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span class="hs-comment">-- | This helper function preserves the semantics of wai-extra &#8804; 3.0, in</span><span>
</span><span id="line-332"></span><span class="hs-comment">-- which the rewrite functions modify the 'rawPathInfo' parameter. Note</span><span>
</span><span id="line-333"></span><span class="hs-comment">-- that this has not been extended to modify the 'rawQueryInfo' as</span><span>
</span><span id="line-334"></span><span class="hs-comment">-- modifying either of these values has been deprecated.</span><span>
</span><span id="line-335"></span><span id="local-6989586621679127176"><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestRawM"><span class="hs-identifier hs-type">rewriteRequestRawM</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621679127176"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679127176"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.RequestHeaders</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679127176"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679127176"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Request</span></span></span><span>
</span><span id="line-340"></span><span id="rewriteRequestRawM"><span class="annot"><span class="annottext">rewriteRequestRawM :: forall (m :: * -&gt; *).
(Applicative m, Monad m) =&gt;
(PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries)
-&gt; Request -&gt; m Request
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestRawM"><span class="hs-identifier hs-var hs-var">rewriteRequestRawM</span></a></span></span><span> </span><span id="local-6989586621679127294"><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries
</span><a href="#local-6989586621679127294"><span class="hs-identifier hs-var">convert</span></a></span></span><span> </span><span id="local-6989586621679127295"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127295"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>    </span><span id="local-6989586621679127296"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127296"><span class="hs-identifier hs-var">newReq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries)
-&gt; Request -&gt; m Request
forall (m :: * -&gt; *).
(Applicative m, Monad m) =&gt;
(PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries)
-&gt; Request -&gt; m Request
</span><a href="Network.Wai.Middleware.Rewrite.html#rewriteRequestM"><span class="hs-identifier hs-var">rewriteRequestM</span></a></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries
</span><a href="#local-6989586621679127294"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127295"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679127299"><span class="annot"><span class="annottext">rawPInfo :: ByteString
</span><a href="#local-6989586621679127299"><span class="hs-identifier hs-var hs-var">rawPInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; ByteString
</span><span class="hs-identifier hs-var">TE.encodeUtf8</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ByteString) -&gt; (Request -&gt; Text) -&gt; Request -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Text] -&gt; Text
</span><span class="hs-identifier hs-var">T.intercalate</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;/&quot;</span></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; Text) -&gt; (Request -&gt; [Text]) -&gt; Request -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Request -&gt; [Text]
</span><span class="hs-identifier hs-var">pathInfo</span></span><span> </span><span class="annot"><span class="annottext">(Request -&gt; ByteString) -&gt; Request -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127296"><span class="hs-identifier hs-var">newReq</span></a></span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><span class="annottext">Request -&gt; m Request
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679127296"><span class="hs-identifier hs-var">newReq</span></a></span><span class="hs-special">{</span><span class="annot"><span class="hs-identifier hs-var">rawPathInfo</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679127299"><span class="hs-identifier hs-type">rawPInfo</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-344"></span><span class="hs-pragma">{-# WARNING</span><span>
</span><span id="line-345"></span><span>    </span><span class="hs-pragma">rewriteRequestRawM</span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-pragma">[</span><span> </span><span class="hs-pragma">&quot;This modifies the 'rawPathInfo' field of a 'Request'.&quot;</span><span>
</span><span id="line-347"></span><span>    </span><span class="hs-pragma">,</span><span> </span><span class="hs-pragma">&quot; This is not recommended behaviour; it is however how&quot;</span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-pragma">,</span><span> </span><span class="hs-pragma">&quot; this function has worked in the past.&quot;</span><span>
</span><span id="line-349"></span><span>    </span><span class="hs-pragma">,</span><span> </span><span class="hs-pragma">&quot; Use 'rewriteRequestM' instead&quot;</span><span>
</span><span id="line-350"></span><span>    </span><span class="hs-pragma">]</span><span>
</span><span id="line-351"></span><span>    </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span class="hs-comment">-- | Produce a function that works on 'PathsAndQueries' from one working</span><span>
</span><span id="line-354"></span><span class="hs-comment">-- only on paths. This is not exported, as it is only needed to handle</span><span>
</span><span id="line-355"></span><span class="hs-comment">-- code written for versions &#8804; 3.0 of the library; see the</span><span>
</span><span id="line-356"></span><span class="hs-comment">-- example above using 'Data.Bifunctor.first' to do something similar.</span><span>
</span><span id="line-357"></span><span id="local-6989586621679127161"><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#pathsOnly"><span class="hs-identifier hs-type">pathsOnly</span></a></span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Applicative</span></span><span> </span><span class="annot"><a href="#local-6989586621679127161"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679127161"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.RequestHeaders</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679127161"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span><span>
</span><span id="line-361"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">H.RequestHeaders</span></span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679127161"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#PathsAndQueries"><span class="hs-identifier hs-type">PathsAndQueries</span></a></span></span><span>
</span><span id="line-363"></span><span id="pathsOnly"><span class="annot"><span class="annottext">pathsOnly :: forall (m :: * -&gt; *).
(Applicative m, Monad m) =&gt;
([Text] -&gt; RequestHeaders -&gt; m [Text])
-&gt; PathsAndQueries -&gt; RequestHeaders -&gt; m PathsAndQueries
</span><a href="Network.Wai.Middleware.Rewrite.html#pathsOnly"><span class="hs-identifier hs-var hs-var">pathsOnly</span></a></span></span><span> </span><span id="local-6989586621679127307"><span class="annot"><span class="annottext">[Text] -&gt; RequestHeaders -&gt; m [Text]
</span><a href="#local-6989586621679127307"><span class="hs-identifier hs-var">convert</span></a></span></span><span> </span><span id="local-6989586621679127308"><span class="annot"><span class="annottext">PathsAndQueries
</span><a href="#local-6989586621679127308"><span class="hs-identifier hs-var">psAndQs</span></a></span></span><span> </span><span id="local-6989586621679127309"><span class="annot"><span class="annottext">RequestHeaders
</span><a href="#local-6989586621679127309"><span class="hs-identifier hs-var">headers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; PathsAndQueries) -&gt; m [Text] -&gt; m PathsAndQueries
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; RequestHeaders -&gt; m [Text]
</span><a href="#local-6989586621679127307"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PathsAndQueries -&gt; [Text]
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">PathsAndQueries
</span><a href="#local-6989586621679127308"><span class="hs-identifier hs-var">psAndQs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RequestHeaders
</span><a href="#local-6989586621679127309"><span class="hs-identifier hs-var">headers</span></a></span><span>
</span><span id="line-364"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Network.Wai.Middleware.Rewrite.html#pathsOnly"><span class="hs-pragma hs-type">pathsOnly</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-365"></span></pre></body></html>