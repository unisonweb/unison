<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DuplicateRecordFields #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FunctionalDependencies #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE TypeInType #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE ViewPatterns #-}</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- So we can keep using the old prettyprinter modules (which have a better</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- compatibility range) for now.</span><span>
</span><span id="line-17"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-deprecations #-}</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="annot"><span class="hs-comment">{- |
Handles the &quot;Language.LSP.Types.TextDocumentDidChange&quot; \/
&quot;Language.LSP.Types.TextDocumentDidOpen&quot; \/
&quot;Language.LSP.Types.TextDocumentDidClose&quot; messages to keep an in-memory
`filesystem` of the current client workspace.  The server can access and edit
files in the client workspace by operating on the &quot;VFS&quot; in &quot;LspFuncs&quot;.
-}</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Language.LSP.VFS</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-27"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier">VFS</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier">vfsMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier">VirtualFile</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#lsp_version"><span class="hs-identifier">lsp_version</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#file_version"><span class="hs-identifier">file_version</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#file_text"><span class="hs-identifier">file_text</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#virtualFileText"><span class="hs-identifier">virtualFileText</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#virtualFileVersion"><span class="hs-identifier">virtualFileVersion</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier">VfsLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Managing the VFS</span></span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#emptyVFS"><span class="hs-identifier">emptyVFS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#openVFS"><span class="hs-identifier">openVFS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#changeFromClientVFS"><span class="hs-identifier">changeFromClientVFS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#changeFromServerVFS"><span class="hs-identifier">changeFromServerVFS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#persistFileVFS"><span class="hs-identifier">persistFileVFS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#closeVFS"><span class="hs-identifier">closeVFS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Positions and transformations</span></span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier">CodePointPosition</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#line"><span class="hs-identifier">line</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#character"><span class="hs-identifier">character</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#codePointPositionToPosition"><span class="hs-identifier">codePointPositionToPosition</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#positionToCodePointPosition"><span class="hs-identifier">positionToCodePointPosition</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier">CodePointRange</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#start"><span class="hs-identifier">start</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#end"><span class="hs-identifier">end</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-54"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#codePointRangeToRange"><span class="hs-identifier">codePointRangeToRange</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#rangeToCodePointRange"><span class="hs-identifier">rangeToCodePointRange</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span>  </span><span class="annot"><span class="hs-comment">-- * manipulating the file contents</span></span><span>
</span><span id="line-58"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#rangeLinesFromVfs"><span class="hs-identifier">rangeLinesFromVfs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-59"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#PosPrefixInfo"><span class="hs-identifier">PosPrefixInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#getCompletionPrefix"><span class="hs-identifier">getCompletionPrefix</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span>  </span><span class="annot"><span class="hs-comment">-- * for tests</span></span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#applyChanges"><span class="hs-identifier">applyChanges</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#applyChange"><span class="hs-identifier">applyChange</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><a href="Language.LSP.VFS.html#changeChars"><span class="hs-identifier">changeChars</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-66"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Colog.Core</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LogAction</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Severity</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">WithSeverity</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&lt;&amp;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">parts</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&lt;.&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Char</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isAlphaNum</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">isUpper</span></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">traverse_</span></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Hashable</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Int</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Int32</span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Ord</span></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Row</span></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Text</span></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.IO</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Prettyprint.Doc</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">line</span></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Rope</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">URope</span></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Utf16.Rope</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Rope</span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Utf16.Rope</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Rope</span></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Lens</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Message</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Types</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">J</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Directory</span></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.FilePath</span></span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO</span></span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-96"></span><span class="hs-pragma">{-# ANN</span><span> </span><span class="hs-pragma">module</span><span> </span><span class="hs-pragma">(</span><span class="annot"><span class="hs-pragma">&quot;hlint: ignore Eta reduce&quot;</span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="annot"><span class="hs-pragma hs-type">String</span></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-97"></span><span class="hs-pragma">{-# ANN</span><span> </span><span class="hs-pragma">module</span><span> </span><span class="hs-pragma">(</span><span class="annot"><span class="hs-pragma">&quot;hlint: ignore Redundant do&quot;</span></span><span> </span><span class="hs-pragma">::</span><span> </span><span class="annot"><span class="hs-pragma hs-type">String</span></span><span class="hs-pragma">)</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="hs-keyword">data</span><span> </span><span id="VirtualFile"><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-var">VirtualFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="VirtualFile"><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-var">VirtualFile</span></a></span></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="%24sel%3A_lsp_version%3AVirtualFile"><span class="annot"><span class="annottext">VirtualFile -&gt; Int32
</span><a href="Language.LSP.VFS.html#%24sel%3A_lsp_version%3AVirtualFile"><span class="hs-identifier hs-var hs-var">_lsp_version</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The LSP version of the document</span></span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3A_file_version%3AVirtualFile"><span class="annot"><span class="annottext">VirtualFile -&gt; Int
</span><a href="Language.LSP.VFS.html#%24sel%3A_file_version%3AVirtualFile"><span class="hs-identifier hs-var hs-var">_file_version</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-comment">-- ^ This number is only incremented whilst the file</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-comment">-- remains in the map.</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3A_file_text%3AVirtualFile"><span class="annot"><span class="annottext">VirtualFile -&gt; Rope
</span><a href="Language.LSP.VFS.html#%24sel%3A_file_text%3AVirtualFile"><span class="hs-identifier hs-var hs-var">_file_text</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The full contents of the document</span></span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679186467"><span id="local-6989586621679186476"><span id="local-6989586621679186480"><span class="annot"><span class="annottext">Int -&gt; VirtualFile -&gt; ShowS
[VirtualFile] -&gt; ShowS
VirtualFile -&gt; [Char]
(Int -&gt; VirtualFile -&gt; ShowS)
-&gt; (VirtualFile -&gt; [Char])
-&gt; ([VirtualFile] -&gt; ShowS)
-&gt; Show VirtualFile
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; VirtualFile -&gt; ShowS
showsPrec :: Int -&gt; VirtualFile -&gt; ShowS
$cshow :: VirtualFile -&gt; [Char]
show :: VirtualFile -&gt; [Char]
$cshowList :: [VirtualFile] -&gt; ShowS
showList :: [VirtualFile] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-keyword">data</span><span> </span><span id="VFS"><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-var">VFS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="VFS"><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-var">VFS</span></a></span></span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="%24sel%3A_vfsMap%3AVFS"><span class="annot"><span class="annottext">VFS -&gt; Map NormalizedUri VirtualFile
</span><a href="Language.LSP.VFS.html#%24sel%3A_vfsMap%3AVFS"><span class="hs-identifier hs-var hs-var">_vfsMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map.Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679186486"><span id="local-6989586621679186493"><span id="local-6989586621679186497"><span class="annot"><span class="annottext">Int -&gt; VFS -&gt; ShowS
[VFS] -&gt; ShowS
VFS -&gt; [Char]
(Int -&gt; VFS -&gt; ShowS)
-&gt; (VFS -&gt; [Char]) -&gt; ([VFS] -&gt; ShowS) -&gt; Show VFS
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; VFS -&gt; ShowS
showsPrec :: Int -&gt; VFS -&gt; ShowS
$cshow :: VFS -&gt; [Char]
show :: VFS -&gt; [Char]
$cshowList :: [VFS] -&gt; ShowS
showList :: [VFS] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span class="hs-keyword">data</span><span> </span><span id="VfsLog"><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-var">VfsLog</span></a></span></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="SplitInsideCodePoint"><span class="annot"><a href="Language.LSP.VFS.html#SplitInsideCodePoint"><span class="hs-identifier hs-var">SplitInsideCodePoint</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope.Position</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="URINotFound"><span class="annot"><a href="Language.LSP.VFS.html#URINotFound"><span class="hs-identifier hs-var">URINotFound</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Opening"><span class="annot"><a href="Language.LSP.VFS.html#Opening"><span class="hs-identifier hs-var">Opening</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Closing"><span class="annot"><a href="Language.LSP.VFS.html#Closing"><span class="hs-identifier hs-var">Closing</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="PersistingFile"><span class="annot"><a href="Language.LSP.VFS.html#PersistingFile"><span class="hs-identifier hs-var">PersistingFile</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="CantRecursiveDelete"><span class="annot"><a href="Language.LSP.VFS.html#CantRecursiveDelete"><span class="hs-identifier hs-var">CantRecursiveDelete</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DeleteNonExistent"><span class="annot"><a href="Language.LSP.VFS.html#DeleteNonExistent"><span class="hs-identifier hs-var">DeleteNonExistent</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679186509"><span id="local-6989586621679186530"><span id="local-6989586621679186534"><span class="annot"><span class="annottext">Int -&gt; VfsLog -&gt; ShowS
[VfsLog] -&gt; ShowS
VfsLog -&gt; [Char]
(Int -&gt; VfsLog -&gt; ShowS)
-&gt; (VfsLog -&gt; [Char]) -&gt; ([VfsLog] -&gt; ShowS) -&gt; Show VfsLog
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; VfsLog -&gt; ShowS
showsPrec :: Int -&gt; VfsLog -&gt; ShowS
$cshow :: VfsLog -&gt; [Char]
show :: VfsLog -&gt; [Char]
$cshowList :: [VfsLog] -&gt; ShowS
showList :: [VfsLog] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679186539"><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-128"></span><span>  </span><span id="local-6989586621679186565"><span class="annot"><span class="annottext">pretty :: forall ann. VfsLog -&gt; Doc ann
</span><a href="#local-6989586621679186565"><span class="hs-identifier hs-var hs-var hs-var hs-var">pretty</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#SplitInsideCodePoint"><span class="hs-identifier hs-type">SplitInsideCodePoint</span></a></span><span> </span><span id="local-6989586621679186567"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679186567"><span class="hs-identifier hs-var">pos</span></a></span></span><span> </span><span id="local-6989586621679186568"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679186568"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-129"></span><span>    </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: asked to make change inside code point. Position&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; Doc ann -&gt; Doc ann
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Position -&gt; Doc ann
forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679186567"><span class="hs-identifier hs-var">pos</span></a></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; Doc ann -&gt; Doc ann
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;in&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; Doc ann -&gt; Doc ann
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Doc ann
forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679186568"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-130"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#URINotFound"><span class="hs-identifier hs-type">URINotFound</span></a></span><span> </span><span id="local-6989586621679186571"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186571"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: don't know about URI&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; Doc ann -&gt; Doc ann
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; Doc ann
forall a ann. Pretty a =&gt; a -&gt; Doc ann
forall ann. NormalizedUri -&gt; Doc ann
</span><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186571"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#Opening"><span class="hs-identifier hs-type">Opening</span></a></span><span> </span><span id="local-6989586621679186572"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186572"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: opening&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; Doc ann -&gt; Doc ann
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; Doc ann
forall a ann. Pretty a =&gt; a -&gt; Doc ann
forall ann. NormalizedUri -&gt; Doc ann
</span><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186572"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-132"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#Closing"><span class="hs-identifier hs-type">Closing</span></a></span><span> </span><span id="local-6989586621679186573"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186573"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: closing&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; Doc ann -&gt; Doc ann
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; Doc ann
forall a ann. Pretty a =&gt; a -&gt; Doc ann
forall ann. NormalizedUri -&gt; Doc ann
</span><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186573"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#PersistingFile"><span class="hs-identifier hs-type">PersistingFile</span></a></span><span> </span><span id="local-6989586621679186574"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186574"><span class="hs-identifier hs-var">uri</span></a></span></span><span> </span><span id="local-6989586621679186575"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679186575"><span class="hs-identifier hs-var">fp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: Writing virtual file for&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; Doc ann -&gt; Doc ann
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; Doc ann
forall a ann. Pretty a =&gt; a -&gt; Doc ann
forall ann. NormalizedUri -&gt; Doc ann
</span><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186574"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; Doc ann -&gt; Doc ann
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;to&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; Doc ann -&gt; Doc ann
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Doc ann
forall a ann. Show a =&gt; a -&gt; Doc ann
</span><span class="hs-identifier hs-var">viaShow</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679186575"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#CantRecursiveDelete"><span class="hs-identifier hs-type">CantRecursiveDelete</span></a></span><span> </span><span id="local-6989586621679186576"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186576"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-135"></span><span>    </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: can't recursively delete&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; Doc ann -&gt; Doc ann
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; Doc ann
forall a ann. Pretty a =&gt; a -&gt; Doc ann
forall ann. NormalizedUri -&gt; Doc ann
</span><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186576"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; Doc ann -&gt; Doc ann
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;because we don't track directory status&quot;</span></span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#DeleteNonExistent"><span class="hs-identifier hs-type">DeleteNonExistent</span></a></span><span> </span><span id="local-6989586621679186577"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186577"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc ann
</span><span class="hs-string">&quot;VFS: asked to delete non-existent file&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc ann -&gt; Doc ann -&gt; Doc ann
forall ann. Doc ann -&gt; Doc ann -&gt; Doc ann
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; Doc ann
forall a ann. Pretty a =&gt; a -&gt; Doc ann
forall ann. NormalizedUri -&gt; Doc ann
</span><span class="hs-identifier hs-var">pretty</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186577"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span id="HasFile_version"><span id="HasLsp_version"><span id="HasFile_text"><span id="local-6989586621679186061"><span id="local-6989586621679186062"><span id="local-6989586621679186063"><span id="local-6989586621679186064"><span id="local-6989586621679186065"><span id="local-6989586621679186066"><span id="lsp_version"><span id="file_version"><span id="file_text"><span id="local-6989586621679186579"><span id="local-6989586621679186583"><span id="local-6989586621679186587"><span class="hs-identifier">makeFieldsNoPrefix</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">VirtualFile</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-139"></span><span id="HasVfsMap"><span id="local-6989586621679186074"><span id="local-6989586621679186075"><span id="vfsMap"><span id="local-6989586621679186612"><span class="hs-identifier">makeFieldsNoPrefix</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">VFS</span></span></span></span></span></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-comment">---</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="annot"><a href="Language.LSP.VFS.html#virtualFileText"><span class="hs-identifier hs-type">virtualFileText</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-144"></span><span id="virtualFileText"><span class="annot"><span class="annottext">virtualFileText :: VirtualFile -&gt; Text
</span><a href="Language.LSP.VFS.html#virtualFileText"><span class="hs-identifier hs-var hs-var">virtualFileText</span></a></span></span><span> </span><span id="local-6989586621679186621"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679186621"><span class="hs-identifier hs-var">vf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VirtualFile -&gt; Rope
</span><a href="Language.LSP.VFS.html#%24sel%3A_file_text%3AVirtualFile"><span class="hs-identifier hs-var">_file_text</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679186621"><span class="hs-identifier hs-var">vf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="annot"><a href="Language.LSP.VFS.html#virtualFileVersion"><span class="hs-identifier hs-type">virtualFileVersion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span>
</span><span id="line-147"></span><span id="virtualFileVersion"><span class="annot"><span class="annottext">virtualFileVersion :: VirtualFile -&gt; Int32
</span><a href="Language.LSP.VFS.html#virtualFileVersion"><span class="hs-identifier hs-var hs-var">virtualFileVersion</span></a></span></span><span> </span><span id="local-6989586621679186623"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679186623"><span class="hs-identifier hs-var">vf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Int32
</span><a href="Language.LSP.VFS.html#%24sel%3A_lsp_version%3AVirtualFile"><span class="hs-identifier hs-var">_lsp_version</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679186623"><span class="hs-identifier hs-var">vf</span></a></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="hs-comment">---</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="annot"><a href="Language.LSP.VFS.html#emptyVFS"><span class="hs-identifier hs-type">emptyVFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span>
</span><span id="line-152"></span><span id="emptyVFS"><span class="annot"><span class="annottext">emptyVFS :: VFS
</span><a href="Language.LSP.VFS.html#emptyVFS"><span class="hs-identifier hs-var hs-var">emptyVFS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map NormalizedUri VirtualFile -&gt; VFS
</span><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-var">VFS</span></a></span><span> </span><span class="annot"><span class="annottext">Map NormalizedUri VirtualFile
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="annot"><span class="hs-comment">-- | Applies the changes from a 'J.DidOpenTextDocument' to the 'VFS'</span></span><span>
</span><span id="line-157"></span><span id="local-6989586621679186085"><span class="annot"><a href="Language.LSP.VFS.html#openVFS"><span class="hs-identifier hs-type">openVFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679186085"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679186085"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TMessage</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">J.Method_TextDocumentDidOpen</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186085"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-158"></span><span id="openVFS"><span class="annot"><span class="annottext">openVFS :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; TMessage
     @'ClientToServer @'Notification 'Method_TextDocumentDidOpen
-&gt; m ()
</span><a href="Language.LSP.VFS.html#openVFS"><span class="hs-identifier hs-var hs-var">openVFS</span></a></span></span><span> </span><span id="local-6989586621679186635"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186635"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679186636"><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidOpen
</span><a href="#local-6989586621679186636"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentItem</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679186648"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186648"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679186649"><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679186649"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span id="local-6989586621679186650"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679186650"><span class="hs-identifier hs-var">text</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidOpen
TNotificationMessage @'ClientToServer 'Method_TextDocumentDidOpen
</span><a href="#local-6989586621679186636"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">TNotificationMessage @'ClientToServer 'Method_TextDocumentDidOpen
-&gt; Getting
     TextDocumentItem
     (TNotificationMessage @'ClientToServer 'Method_TextDocumentDidOpen)
     TextDocumentItem
-&gt; TextDocumentItem
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(DidOpenTextDocumentParams
 -&gt; Const @(*) TextDocumentItem DidOpenTextDocumentParams)
-&gt; TNotificationMessage
     @'ClientToServer 'Method_TextDocumentDidOpen
-&gt; Const
     @(*)
     TextDocumentItem
     (TNotificationMessage @'ClientToServer 'Method_TextDocumentDidOpen)
forall s a. HasParams s a =&gt; Lens' s a
Lens'
  (TNotificationMessage @'ClientToServer 'Method_TextDocumentDidOpen)
  DidOpenTextDocumentParams
</span><span class="hs-identifier hs-var">J.params</span></span><span> </span><span class="annot"><span class="annottext">((DidOpenTextDocumentParams
  -&gt; Const @(*) TextDocumentItem DidOpenTextDocumentParams)
 -&gt; TNotificationMessage
      @'ClientToServer 'Method_TextDocumentDidOpen
 -&gt; Const
      @(*)
      TextDocumentItem
      (TNotificationMessage
         @'ClientToServer 'Method_TextDocumentDidOpen))
-&gt; ((TextDocumentItem
     -&gt; Const @(*) TextDocumentItem TextDocumentItem)
    -&gt; DidOpenTextDocumentParams
    -&gt; Const @(*) TextDocumentItem DidOpenTextDocumentParams)
-&gt; Getting
     TextDocumentItem
     (TNotificationMessage @'ClientToServer 'Method_TextDocumentDidOpen)
     TextDocumentItem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TextDocumentItem -&gt; Const @(*) TextDocumentItem TextDocumentItem)
-&gt; DidOpenTextDocumentParams
-&gt; Const @(*) TextDocumentItem DidOpenTextDocumentParams
forall s a. HasTextDocument s a =&gt; Lens' s a
Lens' DidOpenTextDocumentParams TextDocumentItem
</span><span class="hs-identifier hs-var">J.textDocument</span></span><span>
</span><span id="line-160"></span><span>      </span><span id="local-6989586621679186655"><span class="annot"><span class="annottext">vfile :: VirtualFile
</span><a href="#local-6989586621679186655"><span class="hs-identifier hs-var hs-var">vfile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; Int -&gt; Rope -&gt; VirtualFile
</span><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-var">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679186649"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Rope
</span><span class="hs-identifier hs-var">Rope.fromText</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679186650"><span class="hs-identifier hs-var">text</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>  </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186635"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog) -&gt; WithSeverity VfsLog -&gt; m ()
forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#Opening"><span class="hs-identifier hs-var">Opening</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186648"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">VfsLog -&gt; Severity -&gt; WithSeverity VfsLog
forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Debug</span></span><span>
</span><span id="line-162"></span><span>  </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; VFS -&gt; Identity VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Identity (Map NormalizedUri VirtualFile))
 -&gt; VFS -&gt; Identity VFS)
-&gt; ((Maybe (IxValue (Map NormalizedUri VirtualFile))
     -&gt; Identity (Maybe VirtualFile))
    -&gt; Map NormalizedUri VirtualFile
    -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; (Maybe (IxValue (Map NormalizedUri VirtualFile))
    -&gt; Identity (Maybe VirtualFile))
-&gt; VFS
-&gt; Identity VFS
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
-&gt; Lens'
     (Map NormalizedUri VirtualFile)
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
NormalizedUri
</span><a href="#local-6989586621679186648"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (IxValue (Map NormalizedUri VirtualFile))
  -&gt; Identity (Maybe VirtualFile))
 -&gt; VFS -&gt; Identity VFS)
-&gt; Maybe VirtualFile -&gt; m ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Maybe VirtualFile
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679186655"><span class="hs-identifier hs-var">vfile</span></a></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="annot"><span class="hs-comment">-- | Applies a 'DidChangeTextDocumentNotification' to the 'VFS'</span></span><span>
</span><span id="line-167"></span><span id="local-6989586621679186135"><span class="annot"><a href="Language.LSP.VFS.html#changeFromClientVFS"><span class="hs-identifier hs-type">changeFromClientVFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679186135"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679186135"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TMessage</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">J.Method_TextDocumentDidChange</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186135"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-168"></span><span id="changeFromClientVFS"><span class="annot"><span class="annottext">changeFromClientVFS :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; TMessage
     @'ClientToServer @'Notification 'Method_TextDocumentDidChange
-&gt; m ()
</span><a href="Language.LSP.VFS.html#changeFromClientVFS"><span class="hs-identifier hs-var hs-var">changeFromClientVFS</span></a></span></span><span> </span><span id="local-6989586621679186678"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186678"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679186679"><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidChange
</span><a href="#local-6989586621679186679"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-keyword">let</span><span>
</span><span id="line-170"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">J.DidChangeTextDocumentParams</span></span><span> </span><span id="local-6989586621679186685"><span class="annot"><span class="annottext">VersionedTextDocumentIdentifier
</span><a href="#local-6989586621679186685"><span class="hs-identifier hs-var">vid</span></a></span></span><span> </span><span id="local-6989586621679186686"><span class="annot"><span class="annottext">[TextDocumentContentChangeEvent]
</span><a href="#local-6989586621679186686"><span class="hs-identifier hs-var">changes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidChange
TNotificationMessage @'ClientToServer 'Method_TextDocumentDidChange
</span><a href="#local-6989586621679186679"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">TNotificationMessage @'ClientToServer 'Method_TextDocumentDidChange
-&gt; Getting
     DidChangeTextDocumentParams
     (TNotificationMessage
        @'ClientToServer 'Method_TextDocumentDidChange)
     DidChangeTextDocumentParams
-&gt; DidChangeTextDocumentParams
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  DidChangeTextDocumentParams
  (TNotificationMessage
     @'ClientToServer 'Method_TextDocumentDidChange)
  DidChangeTextDocumentParams
forall s a. HasParams s a =&gt; Lens' s a
Lens'
  (TNotificationMessage
     @'ClientToServer 'Method_TextDocumentDidChange)
  DidChangeTextDocumentParams
</span><span class="hs-identifier hs-var">J.params</span></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-comment">-- the client shouldn't be sending over a null version, only the server, but we just use 0 if that happens</span><span>
</span><span id="line-172"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">J.VersionedTextDocumentIdentifier</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679186688"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186688"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679186689"><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679186689"><span class="hs-identifier hs-var">version</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VersionedTextDocumentIdentifier
</span><a href="#local-6989586621679186685"><span class="hs-identifier hs-var">vid</span></a></span><span>
</span><span id="line-173"></span><span>  </span><span id="local-6989586621679186690"><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679186690"><span class="hs-identifier hs-var">vfs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m VFS
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679186690"><span class="hs-identifier hs-var">vfs</span></a></span><span> </span><span class="annot"><span class="annottext">VFS
-&gt; Getting (Maybe VirtualFile) VFS (Maybe VirtualFile)
-&gt; Maybe VirtualFile
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Const @(*) (Maybe VirtualFile) (Map NormalizedUri VirtualFile))
-&gt; VFS -&gt; Const @(*) (Maybe VirtualFile) VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Const @(*) (Maybe VirtualFile) (Map NormalizedUri VirtualFile))
 -&gt; VFS -&gt; Const @(*) (Maybe VirtualFile) VFS)
-&gt; ((Maybe VirtualFile
     -&gt; Const @(*) (Maybe VirtualFile) (Maybe VirtualFile))
    -&gt; Map NormalizedUri VirtualFile
    -&gt; Const @(*) (Maybe VirtualFile) (Map NormalizedUri VirtualFile))
-&gt; Getting (Maybe VirtualFile) VFS (Maybe VirtualFile)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
-&gt; Lens'
     (Map NormalizedUri VirtualFile)
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
NormalizedUri
</span><a href="#local-6989586621679186688"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679186692"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679186692"><span class="hs-identifier hs-var">file_ver</span></a></span></span><span> </span><span id="local-6989586621679186693"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679186693"><span class="hs-identifier hs-var">contents</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-176"></span><span>      </span><span id="local-6989586621679186694"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679186694"><span class="hs-identifier hs-var">contents'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; [TextDocumentContentChangeEvent] -&gt; m Rope
forall (m :: * -&gt; *).
Monad m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; [TextDocumentContentChangeEvent] -&gt; m Rope
</span><a href="Language.LSP.VFS.html#applyChanges"><span class="hs-identifier hs-var">applyChanges</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186678"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679186693"><span class="hs-identifier hs-var">contents</span></a></span><span> </span><span class="annot"><span class="annottext">[TextDocumentContentChangeEvent]
</span><a href="#local-6989586621679186686"><span class="hs-identifier hs-var">changes</span></a></span><span>
</span><span id="line-177"></span><span>      </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; VFS -&gt; Identity VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Identity (Map NormalizedUri VirtualFile))
 -&gt; VFS -&gt; Identity VFS)
-&gt; ((Maybe (IxValue (Map NormalizedUri VirtualFile))
     -&gt; Identity (Maybe VirtualFile))
    -&gt; Map NormalizedUri VirtualFile
    -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; (Maybe (IxValue (Map NormalizedUri VirtualFile))
    -&gt; Identity (Maybe VirtualFile))
-&gt; VFS
-&gt; Identity VFS
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
-&gt; Lens'
     (Map NormalizedUri VirtualFile)
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
NormalizedUri
</span><a href="#local-6989586621679186688"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (IxValue (Map NormalizedUri VirtualFile))
  -&gt; Identity (Maybe VirtualFile))
 -&gt; VFS -&gt; Identity VFS)
-&gt; Maybe VirtualFile -&gt; m ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Maybe VirtualFile
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int32 -&gt; Int -&gt; Rope -&gt; VirtualFile
</span><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-var">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679186689"><span class="hs-identifier hs-var">version</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679186692"><span class="hs-identifier hs-var">file_ver</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679186694"><span class="hs-identifier hs-var">contents'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><span class="annottext">Maybe VirtualFile
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186678"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog) -&gt; WithSeverity VfsLog -&gt; m ()
forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#URINotFound"><span class="hs-identifier hs-var">URINotFound</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186688"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">VfsLog -&gt; Severity -&gt; WithSeverity VfsLog
forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Warning</span></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span id="local-6989586621679186143"><span class="annot"><a href="Language.LSP.VFS.html#applyCreateFile"><span class="hs-identifier hs-type">applyCreateFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679186143"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.CreateFile</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186143"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-183"></span><span id="applyCreateFile"><span class="annot"><span class="annottext">applyCreateFile :: forall (m :: * -&gt; *). MonadState VFS m =&gt; CreateFile -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyCreateFile"><span class="hs-identifier hs-var hs-var">applyCreateFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFile</span></span><span> </span><span id="local-6989586621679186708"><span class="annot"><span class="annottext">Maybe ChangeAnnotationIdentifier
</span><a href="#local-6989586621679186708"><span class="hs-identifier hs-var">_ann</span></a></span></span><span> </span><span id="local-6989586621679186709"><span class="annot"><span class="annottext">AString &quot;create&quot;
</span><a href="#local-6989586621679186709"><span class="hs-identifier hs-var">_kind</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679186710"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186710"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679186711"><span class="annot"><span class="annottext">Maybe CreateFileOptions
</span><a href="#local-6989586621679186711"><span class="hs-identifier hs-var">options</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-184"></span><span>  </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; VFS -&gt; Identity VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span>
</span><span id="line-185"></span><span>    </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Identity (Map NormalizedUri VirtualFile))
 -&gt; VFS -&gt; Identity VFS)
-&gt; (Map NormalizedUri VirtualFile -&gt; Map NormalizedUri VirtualFile)
-&gt; m ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; (a -&gt; b) -&gt; m ()
</span><span class="hs-operator hs-var">%=</span></span><span> </span><span class="annot"><span class="annottext">(VirtualFile -&gt; VirtualFile -&gt; VirtualFile)
-&gt; NormalizedUri
-&gt; VirtualFile
-&gt; Map NormalizedUri VirtualFile
-&gt; Map NormalizedUri VirtualFile
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insertWith</span></span><span>
</span><span id="line-186"></span><span>      </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679186714"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679186714"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span id="local-6989586621679186715"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679186715"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679186716"><span class="hs-identifier hs-var">shouldOverwrite</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679186714"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679186715"><span class="hs-identifier hs-var">old</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>      </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186710"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int32 -&gt; Int -&gt; Rope -&gt; VirtualFile
</span><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-var">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Rope
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-190"></span><span>  </span><span class="annot"><a href="#local-6989586621679186716"><span class="hs-identifier hs-type">shouldOverwrite</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-191"></span><span>  </span><span id="local-6989586621679186716"><span class="annot"><span class="annottext">shouldOverwrite :: Bool
</span><a href="#local-6989586621679186716"><span class="hs-identifier hs-var hs-var">shouldOverwrite</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CreateFileOptions
</span><a href="#local-6989586621679186711"><span class="hs-identifier hs-var">options</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><span class="annottext">Maybe CreateFileOptions
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- default</span><span>
</span><span id="line-193"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- default</span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- `ignoreIfExists` is True</span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- `ignoreIfExists` is False</span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- `overwrite` is True</span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- `overwrite` wins over `ignoreIfExists`</span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- `overwrite` is True</span><span>
</span><span id="line-199"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- `overwrite` is False</span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- `overwrite` is False</span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.CreateFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- `overwrite` wins over `ignoreIfExists`</span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span id="local-6989586621679186155"><span class="annot"><a href="Language.LSP.VFS.html#applyRenameFile"><span class="hs-identifier hs-type">applyRenameFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679186155"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.RenameFile</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186155"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-204"></span><span id="applyRenameFile"><span class="annot"><span class="annottext">applyRenameFile :: forall (m :: * -&gt; *). MonadState VFS m =&gt; RenameFile -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyRenameFile"><span class="hs-identifier hs-var hs-var">applyRenameFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFile</span></span><span> </span><span id="local-6989586621679186759"><span class="annot"><span class="annottext">Maybe ChangeAnnotationIdentifier
</span><a href="#local-6989586621679186759"><span class="hs-identifier hs-var">_ann</span></a></span></span><span> </span><span id="local-6989586621679186760"><span class="annot"><span class="annottext">AString &quot;rename&quot;
</span><a href="#local-6989586621679186760"><span class="hs-identifier hs-var">_kind</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679186761"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186761"><span class="hs-identifier hs-var">oldUri</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679186762"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186762"><span class="hs-identifier hs-var">newUri</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679186763"><span class="annot"><span class="annottext">Maybe RenameFileOptions
</span><a href="#local-6989586621679186763"><span class="hs-identifier hs-var">options</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-205"></span><span>  </span><span id="local-6989586621679186764"><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679186764"><span class="hs-identifier hs-var">vfs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m VFS
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679186764"><span class="hs-identifier hs-var">vfs</span></a></span><span> </span><span class="annot"><span class="annottext">VFS
-&gt; Getting
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
     VFS
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
-&gt; Maybe (IxValue (Map NormalizedUri VirtualFile))
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Const
      @(*)
      (Maybe (IxValue (Map NormalizedUri VirtualFile)))
      (Map NormalizedUri VirtualFile))
-&gt; VFS
-&gt; Const @(*) (Maybe (IxValue (Map NormalizedUri VirtualFile))) VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Const
       @(*)
       (Maybe (IxValue (Map NormalizedUri VirtualFile)))
       (Map NormalizedUri VirtualFile))
 -&gt; VFS
 -&gt; Const
      @(*) (Maybe (IxValue (Map NormalizedUri VirtualFile))) VFS)
-&gt; ((Maybe (IxValue (Map NormalizedUri VirtualFile))
     -&gt; Const
          @(*)
          (Maybe (IxValue (Map NormalizedUri VirtualFile)))
          (Maybe (IxValue (Map NormalizedUri VirtualFile))))
    -&gt; Map NormalizedUri VirtualFile
    -&gt; Const
         @(*)
         (Maybe (IxValue (Map NormalizedUri VirtualFile)))
         (Map NormalizedUri VirtualFile))
-&gt; Getting
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
     VFS
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
-&gt; Lens'
     (Map NormalizedUri VirtualFile)
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
NormalizedUri
</span><a href="#local-6989586621679186761"><span class="hs-identifier hs-var">oldUri</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-comment">-- nothing to rename</span><span>
</span><span id="line-208"></span><span>    </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679186765"><span class="annot"><span class="annottext">IxValue (Map NormalizedUri VirtualFile)
</span><a href="#local-6989586621679186765"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679186764"><span class="hs-identifier hs-var">vfs</span></a></span><span> </span><span class="annot"><span class="annottext">VFS
-&gt; Getting
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
     VFS
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
-&gt; Maybe (IxValue (Map NormalizedUri VirtualFile))
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Const
      @(*)
      (Maybe (IxValue (Map NormalizedUri VirtualFile)))
      (Map NormalizedUri VirtualFile))
-&gt; VFS
-&gt; Const @(*) (Maybe (IxValue (Map NormalizedUri VirtualFile))) VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Const
       @(*)
       (Maybe (IxValue (Map NormalizedUri VirtualFile)))
       (Map NormalizedUri VirtualFile))
 -&gt; VFS
 -&gt; Const
      @(*) (Maybe (IxValue (Map NormalizedUri VirtualFile))) VFS)
-&gt; ((Maybe (IxValue (Map NormalizedUri VirtualFile))
     -&gt; Const
          @(*)
          (Maybe (IxValue (Map NormalizedUri VirtualFile)))
          (Maybe (IxValue (Map NormalizedUri VirtualFile))))
    -&gt; Map NormalizedUri VirtualFile
    -&gt; Const
         @(*)
         (Maybe (IxValue (Map NormalizedUri VirtualFile)))
         (Map NormalizedUri VirtualFile))
-&gt; Getting
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
     VFS
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
-&gt; Lens'
     (Map NormalizedUri VirtualFile)
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
NormalizedUri
</span><a href="#local-6989586621679186762"><span class="hs-identifier hs-var">newUri</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-comment">-- the target does not exist, just move over</span><span>
</span><span id="line-211"></span><span>      </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-212"></span><span>        </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; VFS -&gt; Identity VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Identity (Map NormalizedUri VirtualFile))
 -&gt; VFS -&gt; Identity VFS)
-&gt; ((Maybe (IxValue (Map NormalizedUri VirtualFile))
     -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
    -&gt; Map NormalizedUri VirtualFile
    -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; (Maybe (IxValue (Map NormalizedUri VirtualFile))
    -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
-&gt; VFS
-&gt; Identity VFS
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
-&gt; Lens'
     (Map NormalizedUri VirtualFile)
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
NormalizedUri
</span><a href="#local-6989586621679186761"><span class="hs-identifier hs-var">oldUri</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (IxValue (Map NormalizedUri VirtualFile))
  -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
 -&gt; VFS -&gt; Identity VFS)
-&gt; Maybe (IxValue (Map NormalizedUri VirtualFile)) -&gt; m ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-213"></span><span>        </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; VFS -&gt; Identity VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Identity (Map NormalizedUri VirtualFile))
 -&gt; VFS -&gt; Identity VFS)
-&gt; ((Maybe (IxValue (Map NormalizedUri VirtualFile))
     -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
    -&gt; Map NormalizedUri VirtualFile
    -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; (Maybe (IxValue (Map NormalizedUri VirtualFile))
    -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
-&gt; VFS
-&gt; Identity VFS
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
-&gt; Lens'
     (Map NormalizedUri VirtualFile)
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
NormalizedUri
</span><a href="#local-6989586621679186762"><span class="hs-identifier hs-var">newUri</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (IxValue (Map NormalizedUri VirtualFile))
  -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
 -&gt; VFS -&gt; Identity VFS)
-&gt; Maybe (IxValue (Map NormalizedUri VirtualFile)) -&gt; m ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">IxValue (Map NormalizedUri VirtualFile)
-&gt; Maybe (IxValue (Map NormalizedUri VirtualFile))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">IxValue (Map NormalizedUri VirtualFile)
</span><a href="#local-6989586621679186765"><span class="hs-identifier hs-var">file</span></a></span><span>
</span><span id="line-214"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">IxValue (Map NormalizedUri VirtualFile)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679186767"><span class="hs-identifier hs-var">shouldOverwrite</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>        </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; VFS -&gt; Identity VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Identity (Map NormalizedUri VirtualFile))
 -&gt; VFS -&gt; Identity VFS)
-&gt; ((Maybe (IxValue (Map NormalizedUri VirtualFile))
     -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
    -&gt; Map NormalizedUri VirtualFile
    -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; (Maybe (IxValue (Map NormalizedUri VirtualFile))
    -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
-&gt; VFS
-&gt; Identity VFS
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
-&gt; Lens'
     (Map NormalizedUri VirtualFile)
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
NormalizedUri
</span><a href="#local-6989586621679186761"><span class="hs-identifier hs-var">oldUri</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (IxValue (Map NormalizedUri VirtualFile))
  -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
 -&gt; VFS -&gt; Identity VFS)
-&gt; Maybe (IxValue (Map NormalizedUri VirtualFile)) -&gt; m ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-216"></span><span>        </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; VFS -&gt; Identity VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Identity (Map NormalizedUri VirtualFile))
 -&gt; VFS -&gt; Identity VFS)
-&gt; ((Maybe (IxValue (Map NormalizedUri VirtualFile))
     -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
    -&gt; Map NormalizedUri VirtualFile
    -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; (Maybe (IxValue (Map NormalizedUri VirtualFile))
    -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
-&gt; VFS
-&gt; Identity VFS
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
-&gt; Lens'
     (Map NormalizedUri VirtualFile)
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
NormalizedUri
</span><a href="#local-6989586621679186762"><span class="hs-identifier hs-var">newUri</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (IxValue (Map NormalizedUri VirtualFile))
  -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
 -&gt; VFS -&gt; Identity VFS)
-&gt; Maybe (IxValue (Map NormalizedUri VirtualFile)) -&gt; m ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">IxValue (Map NormalizedUri VirtualFile)
-&gt; Maybe (IxValue (Map NormalizedUri VirtualFile))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">IxValue (Map NormalizedUri VirtualFile)
</span><a href="#local-6989586621679186765"><span class="hs-identifier hs-var">file</span></a></span><span>
</span><span id="line-217"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><a href="#local-6989586621679186767"><span class="hs-identifier hs-type">shouldOverwrite</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-219"></span><span>  </span><span id="local-6989586621679186767"><span class="annot"><span class="annottext">shouldOverwrite :: Bool
</span><a href="#local-6989586621679186767"><span class="hs-identifier hs-var hs-var">shouldOverwrite</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe RenameFileOptions
</span><a href="#local-6989586621679186763"><span class="hs-identifier hs-var">options</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-220"></span><span>    </span><span class="annot"><span class="annottext">Maybe RenameFileOptions
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- default</span><span>
</span><span id="line-221"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- default</span><span>
</span><span id="line-222"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- `ignoreIfExists` is True</span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- `ignoreIfExists` is False</span><span>
</span><span id="line-224"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- `overwrite` is True</span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- `overwrite` wins over `ignoreIfExists`</span><span>
</span><span id="line-226"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- `overwrite` is True</span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- `overwrite` is False</span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- `overwrite` is False</span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.RenameFileOptions</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- `overwrite` wins over `ignoreIfExists`</span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span id="local-6989586621679186166"><span class="annot"><a href="Language.LSP.VFS.html#applyDeleteFile"><span class="hs-identifier hs-type">applyDeleteFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679186166"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679186166"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.DeleteFile</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186166"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-232"></span><span id="applyDeleteFile"><span class="annot"><span class="annottext">applyDeleteFile :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog) -&gt; DeleteFile -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyDeleteFile"><span class="hs-identifier hs-var hs-var">applyDeleteFile</span></a></span></span><span> </span><span id="local-6989586621679186805"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186805"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.DeleteFile</span></span><span> </span><span id="local-6989586621679186807"><span class="annot"><span class="annottext">Maybe ChangeAnnotationIdentifier
</span><a href="#local-6989586621679186807"><span class="hs-identifier hs-var">_ann</span></a></span></span><span> </span><span id="local-6989586621679186808"><span class="annot"><span class="annottext">AString &quot;delete&quot;
</span><a href="#local-6989586621679186808"><span class="hs-identifier hs-var">_kind</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679186809"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186809"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679186810"><span class="annot"><span class="annottext">Maybe DeleteFileOptions
</span><a href="#local-6989586621679186810"><span class="hs-identifier hs-var">options</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-comment">-- NOTE: we are ignoring the `recursive` option here because we don't know which file is a directory</span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe DeleteFileOptions
</span><a href="#local-6989586621679186810"><span class="hs-identifier hs-var">options</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DeleteFileOptions
-&gt; Getting (First Bool) (Maybe DeleteFileOptions) Bool
-&gt; Maybe Bool
forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><span class="hs-operator hs-var">^?</span></span><span> </span><span class="annot"><span class="annottext">(DeleteFileOptions -&gt; Const @(*) (First Bool) DeleteFileOptions)
-&gt; Maybe DeleteFileOptions
-&gt; Const @(*) (First Bool) (Maybe DeleteFileOptions)
forall a b (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p a (f b) -&gt; p (Maybe a) (f (Maybe b))
</span><span class="hs-identifier hs-var">_Just</span></span><span> </span><span class="annot"><span class="annottext">((DeleteFileOptions -&gt; Const @(*) (First Bool) DeleteFileOptions)
 -&gt; Maybe DeleteFileOptions
 -&gt; Const @(*) (First Bool) (Maybe DeleteFileOptions))
-&gt; ((Bool -&gt; Const @(*) (First Bool) Bool)
    -&gt; DeleteFileOptions -&gt; Const @(*) (First Bool) DeleteFileOptions)
-&gt; Getting (First Bool) (Maybe DeleteFileOptions) Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Bool -&gt; Const @(*) (First Bool) (Maybe Bool))
-&gt; DeleteFileOptions -&gt; Const @(*) (First Bool) DeleteFileOptions
forall s a. HasRecursive s a =&gt; Lens' s a
Lens' DeleteFileOptions (Maybe Bool)
</span><span class="hs-identifier hs-var">J.recursive</span></span><span> </span><span class="annot"><span class="annottext">((Maybe Bool -&gt; Const @(*) (First Bool) (Maybe Bool))
 -&gt; DeleteFileOptions -&gt; Const @(*) (First Bool) DeleteFileOptions)
-&gt; ((Bool -&gt; Const @(*) (First Bool) Bool)
    -&gt; Maybe Bool -&gt; Const @(*) (First Bool) (Maybe Bool))
-&gt; (Bool -&gt; Const @(*) (First Bool) Bool)
-&gt; DeleteFileOptions
-&gt; Const @(*) (First Bool) DeleteFileOptions
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Const @(*) (First Bool) Bool)
-&gt; Maybe Bool -&gt; Const @(*) (First Bool) (Maybe Bool)
forall a b (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p a (f b) -&gt; p (Maybe a) (f (Maybe b))
</span><span class="hs-identifier hs-var">_Just</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool -&gt; Maybe Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-235"></span><span>    </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186805"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog) -&gt; WithSeverity VfsLog -&gt; m ()
forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#CantRecursiveDelete"><span class="hs-identifier hs-var">CantRecursiveDelete</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186809"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">VfsLog -&gt; Severity -&gt; WithSeverity VfsLog
forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Warning</span></span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-comment">-- Remove and get the old value so we can check if it was missing</span><span>
</span><span id="line-237"></span><span>  </span><span id="local-6989586621679186814"><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
</span><a href="#local-6989586621679186814"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; VFS -&gt; Identity VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Identity (Map NormalizedUri VirtualFile))
 -&gt; VFS -&gt; Identity VFS)
-&gt; ((Maybe (IxValue (Map NormalizedUri VirtualFile))
     -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
    -&gt; Map NormalizedUri VirtualFile
    -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; (Maybe (IxValue (Map NormalizedUri VirtualFile))
    -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
-&gt; VFS
-&gt; Identity VFS
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
-&gt; Lens'
     (Map NormalizedUri VirtualFile)
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
NormalizedUri
</span><a href="#local-6989586621679186809"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (IxValue (Map NormalizedUri VirtualFile))
  -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
 -&gt; VFS -&gt; Identity VFS)
-&gt; Maybe (IxValue (Map NormalizedUri VirtualFile))
-&gt; m (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m b
</span><span class="hs-operator hs-var">&lt;.=</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
</span><a href="#local-6989586621679186814"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-comment">-- It's not entirely clear what the semantics of 'ignoreIfNotExists' are, but if it</span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-comment">-- doesn't exist and we're not ignoring it, let's at least log it.</span><span>
</span><span id="line-241"></span><span>    </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-242"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Maybe DeleteFileOptions
</span><a href="#local-6989586621679186810"><span class="hs-identifier hs-var">options</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DeleteFileOptions
-&gt; Getting (First Bool) (Maybe DeleteFileOptions) Bool
-&gt; Maybe Bool
forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><span class="hs-operator hs-var">^?</span></span><span> </span><span class="annot"><span class="annottext">(DeleteFileOptions -&gt; Const @(*) (First Bool) DeleteFileOptions)
-&gt; Maybe DeleteFileOptions
-&gt; Const @(*) (First Bool) (Maybe DeleteFileOptions)
forall a b (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p a (f b) -&gt; p (Maybe a) (f (Maybe b))
</span><span class="hs-identifier hs-var">_Just</span></span><span> </span><span class="annot"><span class="annottext">((DeleteFileOptions -&gt; Const @(*) (First Bool) DeleteFileOptions)
 -&gt; Maybe DeleteFileOptions
 -&gt; Const @(*) (First Bool) (Maybe DeleteFileOptions))
-&gt; ((Bool -&gt; Const @(*) (First Bool) Bool)
    -&gt; DeleteFileOptions -&gt; Const @(*) (First Bool) DeleteFileOptions)
-&gt; Getting (First Bool) (Maybe DeleteFileOptions) Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Bool -&gt; Const @(*) (First Bool) (Maybe Bool))
-&gt; DeleteFileOptions -&gt; Const @(*) (First Bool) DeleteFileOptions
forall s a. HasIgnoreIfNotExists s a =&gt; Lens' s a
Lens' DeleteFileOptions (Maybe Bool)
</span><span class="hs-identifier hs-var">J.ignoreIfNotExists</span></span><span> </span><span class="annot"><span class="annottext">((Maybe Bool -&gt; Const @(*) (First Bool) (Maybe Bool))
 -&gt; DeleteFileOptions -&gt; Const @(*) (First Bool) DeleteFileOptions)
-&gt; ((Bool -&gt; Const @(*) (First Bool) Bool)
    -&gt; Maybe Bool -&gt; Const @(*) (First Bool) (Maybe Bool))
-&gt; (Bool -&gt; Const @(*) (First Bool) Bool)
-&gt; DeleteFileOptions
-&gt; Const @(*) (First Bool) DeleteFileOptions
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Const @(*) (First Bool) Bool)
-&gt; Maybe Bool -&gt; Const @(*) (First Bool) (Maybe Bool)
forall a b (p :: * -&gt; * -&gt; *) (f :: * -&gt; *).
(Choice p, Applicative f) =&gt;
p a (f b) -&gt; p (Maybe a) (f (Maybe b))
</span><span class="hs-identifier hs-var">_Just</span></span><span> </span><span class="annot"><span class="annottext">Maybe Bool -&gt; Maybe Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-243"></span><span>          </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186805"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog) -&gt; WithSeverity VfsLog -&gt; m ()
forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#CantRecursiveDelete"><span class="hs-identifier hs-var">CantRecursiveDelete</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679186809"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">VfsLog -&gt; Severity -&gt; WithSeverity VfsLog
forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Warning</span></span><span>
</span><span id="line-244"></span><span>    </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span id="local-6989586621679186192"><span class="annot"><a href="Language.LSP.VFS.html#applyTextDocumentEdit"><span class="hs-identifier hs-type">applyTextDocumentEdit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679186192"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679186192"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentEdit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186192"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-247"></span><span id="applyTextDocumentEdit"><span class="annot"><span class="annottext">applyTextDocumentEdit :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog) -&gt; TextDocumentEdit -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyTextDocumentEdit"><span class="hs-identifier hs-var hs-var">applyTextDocumentEdit</span></a></span></span><span> </span><span id="local-6989586621679186917"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186917"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentEdit</span></span><span> </span><span id="local-6989586621679186919"><span class="annot"><span class="annottext">OptionalVersionedTextDocumentIdentifier
</span><a href="#local-6989586621679186919"><span class="hs-identifier hs-var">vid</span></a></span></span><span> </span><span id="local-6989586621679186920"><span class="annot"><span class="annottext">[TextEdit |? AnnotatedTextEdit]
</span><a href="#local-6989586621679186920"><span class="hs-identifier hs-var">edits</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-comment">-- all edits are supposed to be applied at once</span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-comment">-- so apply from bottom up so they don't affect others</span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679186925"><span class="annot"><span class="annottext">sortedEdits :: [TextEdit |? AnnotatedTextEdit]
</span><a href="#local-6989586621679186925"><span class="hs-identifier hs-var hs-var">sortedEdits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TextEdit |? AnnotatedTextEdit) -&gt; Down Range)
-&gt; [TextEdit |? AnnotatedTextEdit]
-&gt; [TextEdit |? AnnotatedTextEdit]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Range -&gt; Down Range
forall a. a -&gt; Down a
</span><span class="hs-identifier hs-var">Down</span></span><span> </span><span class="annot"><span class="annottext">(Range -&gt; Down Range)
-&gt; ((TextEdit |? AnnotatedTextEdit) -&gt; Range)
-&gt; (TextEdit |? AnnotatedTextEdit)
-&gt; Down Range
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TextEdit |? AnnotatedTextEdit) -&gt; Range
</span><a href="#local-6989586621679186928"><span class="hs-identifier hs-var">editRange</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TextEdit |? AnnotatedTextEdit]
</span><a href="#local-6989586621679186920"><span class="hs-identifier hs-var">edits</span></a></span><span>
</span><span id="line-251"></span><span>      </span><span id="local-6989586621679186929"><span class="annot"><span class="annottext">changeEvents :: [TextDocumentContentChangeEvent]
</span><a href="#local-6989586621679186929"><span class="hs-identifier hs-var hs-var">changeEvents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TextEdit |? AnnotatedTextEdit) -&gt; TextDocumentContentChangeEvent)
-&gt; [TextEdit |? AnnotatedTextEdit]
-&gt; [TextDocumentContentChangeEvent]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(TextEdit |? AnnotatedTextEdit) -&gt; TextDocumentContentChangeEvent
</span><a href="#local-6989586621679186930"><span class="hs-identifier hs-var">editToChangeEvent</span></a></span><span> </span><span class="annot"><span class="annottext">[TextEdit |? AnnotatedTextEdit]
</span><a href="#local-6989586621679186925"><span class="hs-identifier hs-var">sortedEdits</span></a></span><span>
</span><span id="line-252"></span><span>      </span><span class="hs-comment">-- TODO: is this right?</span><span>
</span><span id="line-253"></span><span>      </span><span id="local-6989586621679186938"><span class="annot"><span class="annottext">vid' :: VersionedTextDocumentIdentifier
</span><a href="#local-6989586621679186938"><span class="hs-identifier hs-var hs-var">vid'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Uri -&gt; Int32 -&gt; VersionedTextDocumentIdentifier
</span><span class="hs-identifier hs-var">J.VersionedTextDocumentIdentifier</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OptionalVersionedTextDocumentIdentifier
</span><a href="#local-6989586621679186919"><span class="hs-identifier hs-var">vid</span></a></span><span> </span><span class="annot"><span class="annottext">OptionalVersionedTextDocumentIdentifier
-&gt; Getting Uri OptionalVersionedTextDocumentIdentifier Uri -&gt; Uri
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Uri OptionalVersionedTextDocumentIdentifier Uri
forall s a. HasUri s a =&gt; Lens' s a
Lens' OptionalVersionedTextDocumentIdentifier Uri
</span><span class="hs-identifier hs-var">J.uri</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OptionalVersionedTextDocumentIdentifier
</span><a href="#local-6989586621679186919"><span class="hs-identifier hs-var">vid</span></a></span><span> </span><span class="annot"><span class="annottext">OptionalVersionedTextDocumentIdentifier
-&gt; Getting
     (Int32 |? Null)
     OptionalVersionedTextDocumentIdentifier
     (Int32 |? Null)
-&gt; Int32 |? Null
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Int32 |? Null)
  OptionalVersionedTextDocumentIdentifier
  (Int32 |? Null)
forall s a. HasVersion s a =&gt; Lens' s a
Lens' OptionalVersionedTextDocumentIdentifier (Int32 |? Null)
</span><span class="hs-identifier hs-var">J.version</span></span><span> </span><span class="hs-keyword">of</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679186942"><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679186942"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679186942"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span class="annot"><span class="annottext">Null
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>      </span><span id="local-6989586621679186944"><span class="annot"><span class="annottext">ps :: DidChangeTextDocumentParams
</span><a href="#local-6989586621679186944"><span class="hs-identifier hs-var hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VersionedTextDocumentIdentifier
-&gt; [TextDocumentContentChangeEvent] -&gt; DidChangeTextDocumentParams
</span><span class="hs-identifier hs-var">J.DidChangeTextDocumentParams</span></span><span> </span><span class="annot"><span class="annottext">VersionedTextDocumentIdentifier
</span><a href="#local-6989586621679186938"><span class="hs-identifier hs-var">vid'</span></a></span><span> </span><span class="annot"><span class="annottext">[TextDocumentContentChangeEvent]
</span><a href="#local-6989586621679186929"><span class="hs-identifier hs-var">changeEvents</span></a></span><span>
</span><span id="line-255"></span><span>      </span><span id="local-6989586621679186947"><span class="annot"><span class="annottext">notif :: TNotificationMessage @'ClientToServer 'Method_TextDocumentDidChange
</span><a href="#local-6989586621679186947"><span class="hs-identifier hs-var hs-var">notif</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
-&gt; SMethod
     @'ClientToServer @'Notification 'Method_TextDocumentDidChange
-&gt; MessageParams
     @'ClientToServer @'Notification 'Method_TextDocumentDidChange
-&gt; TNotificationMessage
     @'ClientToServer 'Method_TextDocumentDidChange
forall (f :: MessageDirection) (m :: Method f 'Notification).
Text
-&gt; SMethod @f @'Notification m
-&gt; MessageParams @f @'Notification m
-&gt; TNotificationMessage @f m
</span><span class="hs-identifier hs-var">J.TNotificationMessage</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">SMethod
  @'ClientToServer @'Notification 'Method_TextDocumentDidChange
</span><span class="hs-identifier hs-var">J.SMethod_TextDocumentDidChange</span></span><span> </span><span class="annot"><span class="annottext">DidChangeTextDocumentParams
MessageParams
  @'ClientToServer @'Notification 'Method_TextDocumentDidChange
</span><a href="#local-6989586621679186944"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
-&gt; TMessage
     @'ClientToServer @'Notification 'Method_TextDocumentDidChange
-&gt; m ()
forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; TMessage
     @'ClientToServer @'Notification 'Method_TextDocumentDidChange
-&gt; m ()
</span><a href="Language.LSP.VFS.html#changeFromClientVFS"><span class="hs-identifier hs-var">changeFromClientVFS</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186917"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidChange
TNotificationMessage @'ClientToServer 'Method_TextDocumentDidChange
</span><a href="#local-6989586621679186947"><span class="hs-identifier hs-var">notif</span></a></span><span>
</span><span id="line-257"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><a href="#local-6989586621679186928"><span class="hs-identifier hs-type">editRange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TextEdit</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">J.|?</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.AnnotatedTextEdit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span>
</span><span id="line-259"></span><span>  </span><span id="local-6989586621679186928"><span class="annot"><span class="annottext">editRange :: (TextEdit |? AnnotatedTextEdit) -&gt; Range
</span><a href="#local-6989586621679186928"><span class="hs-identifier hs-var hs-var">editRange</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span id="local-6989586621679186950"><span class="annot"><span class="annottext">AnnotatedTextEdit
</span><a href="#local-6989586621679186950"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AnnotatedTextEdit
</span><a href="#local-6989586621679186950"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">AnnotatedTextEdit -&gt; Getting Range AnnotatedTextEdit Range -&gt; Range
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Range AnnotatedTextEdit Range
forall s a. HasRange s a =&gt; Lens' s a
Lens' AnnotatedTextEdit Range
</span><span class="hs-identifier hs-var">J.range</span></span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><a href="#local-6989586621679186928"><span class="hs-identifier hs-var">editRange</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679186952"><span class="annot"><span class="annottext">TextEdit
</span><a href="#local-6989586621679186952"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TextEdit
</span><a href="#local-6989586621679186952"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">TextEdit -&gt; Getting Range TextEdit Range -&gt; Range
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Range TextEdit Range
forall s a. HasRange s a =&gt; Lens' s a
Lens' TextEdit Range
</span><span class="hs-identifier hs-var">J.range</span></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>  </span><span class="annot"><a href="#local-6989586621679186930"><span class="hs-identifier hs-type">editToChangeEvent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TextEdit</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">J.|?</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.AnnotatedTextEdit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentContentChangeEvent</span></span><span>
</span><span id="line-263"></span><span>  </span><span id="local-6989586621679186930"><span class="annot"><span class="annottext">editToChangeEvent :: (TextEdit |? AnnotatedTextEdit) -&gt; TextDocumentContentChangeEvent
</span><a href="#local-6989586621679186930"><span class="hs-identifier hs-var hs-var">editToChangeEvent</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span id="local-6989586621679186953"><span class="annot"><span class="annottext">AnnotatedTextEdit
</span><a href="#local-6989586621679186953"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Rec
   ((.+)
      @(*)
      (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
      ((.+)
         @(*)
         (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
         ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
 |? Rec
      ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*))))))
-&gt; TextDocumentContentChangeEvent
</span><span class="hs-identifier hs-var">J.TextDocumentContentChangeEvent</span></span><span> </span><span class="annot"><span class="annottext">((Rec
    ((.+)
       @(*)
       (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
       ((.+)
          @(*)
          (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
          ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
  |? Rec
       ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*))))))
 -&gt; TextDocumentContentChangeEvent)
-&gt; (Rec
      ((.+)
         @(*)
         (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
         ((.+)
            @(*)
            (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
            ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
    |? Rec
         ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*))))))
-&gt; TextDocumentContentChangeEvent
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec
  ((.+)
     @(*)
     (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
     ((.+)
        @(*)
        (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
        ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
-&gt; Rec
     ((.+)
        @(*)
        (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
        ((.+)
           @(*)
           (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
           ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
   |? Rec
        ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))
forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">J.InL</span></span><span> </span><span class="annot"><span class="annottext">(Rec
   ((.+)
      @(*)
      (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
      ((.+)
         @(*)
         (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
         ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
 -&gt; Rec
      ((.+)
         @(*)
         (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
         ((.+)
            @(*)
            (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
            ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
    |? Rec
         ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*))))))
-&gt; Rec
     ((.+)
        @(*)
        (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
        ((.+)
           @(*)
           (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
           ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
-&gt; Rec
     ((.+)
        @(*)
        (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
        ((.+)
           @(*)
           (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
           ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
   |? Rec
        ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;range&quot;
</span><span class="">#range</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;range&quot;
-&gt; Range
-&gt; Rec (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec ((.==) @(*) l a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">AnnotatedTextEdit
</span><a href="#local-6989586621679186953"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">AnnotatedTextEdit -&gt; Getting Range AnnotatedTextEdit Range -&gt; Range
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Range AnnotatedTextEdit Range
forall s a. HasRange s a =&gt; Lens' s a
Lens' AnnotatedTextEdit Range
</span><span class="hs-identifier hs-var">J.range</span></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;range&quot; Range) ('[] @(LT (*)))))
-&gt; Rec
     ('R
        @(*)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
           ('[] @(LT (*)))))
-&gt; Rec
     ((.+)
        @(*)
        ('R
           @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;range&quot; Range) ('[] @(LT (*)))))
        ('R
           @(*)
           ((':)
              @(LT (*))
              ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
              ('[] @(LT (*))))))
forall (l :: Row (*)) (r :: Row (*)).
FreeForall @(*) l =&gt;
Rec l -&gt; Rec r -&gt; Rec ((.+) @(*) l r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;rangeLength&quot;
</span><span class="">#rangeLength</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;rangeLength&quot;
-&gt; Maybe UInt
-&gt; Rec
     (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec ((.==) @(*) l a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Maybe UInt
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Rec
  ((.+)
     @(*)
     ('R
        @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;range&quot; Range) ('[] @(LT (*)))))
     ('R
        @(*)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
           ('[] @(LT (*))))))
-&gt; Rec
     ('R
        @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))
-&gt; Rec
     ((.+)
        @(*)
        ((.+)
           @(*)
           ('R
              @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;range&quot; Range) ('[] @(LT (*)))))
           ('R
              @(*)
              ((':)
                 @(LT (*))
                 ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
                 ('[] @(LT (*))))))
        ('R
           @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*))))))
forall (l :: Row (*)) (r :: Row (*)).
FreeForall @(*) l =&gt;
Rec l -&gt; Rec r -&gt; Rec ((.+) @(*) l r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;text&quot;
</span><span class="">#text</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;text&quot; -&gt; Text -&gt; Rec ((.==) @(*) &quot;text&quot; Text)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec ((.==) @(*) l a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">AnnotatedTextEdit
</span><a href="#local-6989586621679186953"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">AnnotatedTextEdit -&gt; Getting Text AnnotatedTextEdit Text -&gt; Text
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Text AnnotatedTextEdit Text
forall s a. HasNewText s a =&gt; Lens' s a
Lens' AnnotatedTextEdit Text
</span><span class="hs-identifier hs-var">J.newText</span></span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><a href="#local-6989586621679186930"><span class="hs-identifier hs-var">editToChangeEvent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679186958"><span class="annot"><span class="annottext">TextEdit
</span><a href="#local-6989586621679186958"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Rec
   ((.+)
      @(*)
      (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
      ((.+)
         @(*)
         (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
         ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
 |? Rec
      ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*))))))
-&gt; TextDocumentContentChangeEvent
</span><span class="hs-identifier hs-var">J.TextDocumentContentChangeEvent</span></span><span> </span><span class="annot"><span class="annottext">((Rec
    ((.+)
       @(*)
       (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
       ((.+)
          @(*)
          (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
          ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
  |? Rec
       ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*))))))
 -&gt; TextDocumentContentChangeEvent)
-&gt; (Rec
      ((.+)
         @(*)
         (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
         ((.+)
            @(*)
            (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
            ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
    |? Rec
         ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*))))))
-&gt; TextDocumentContentChangeEvent
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec
  ((.+)
     @(*)
     (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
     ((.+)
        @(*)
        (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
        ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
-&gt; Rec
     ((.+)
        @(*)
        (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
        ((.+)
           @(*)
           (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
           ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
   |? Rec
        ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))
forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">J.InL</span></span><span> </span><span class="annot"><span class="annottext">(Rec
   ((.+)
      @(*)
      (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
      ((.+)
         @(*)
         (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
         ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
 -&gt; Rec
      ((.+)
         @(*)
         (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
         ((.+)
            @(*)
            (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
            ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
    |? Rec
         ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*))))))
-&gt; Rec
     ((.+)
        @(*)
        (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
        ((.+)
           @(*)
           (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
           ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
-&gt; Rec
     ((.+)
        @(*)
        (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
        ((.+)
           @(*)
           (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
           ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
   |? Rec
        ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;range&quot;
</span><span class="">#range</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;range&quot;
-&gt; Range
-&gt; Rec (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec ((.==) @(*) l a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">TextEdit
</span><a href="#local-6989586621679186958"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">TextEdit -&gt; Getting Range TextEdit Range -&gt; Range
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Range TextEdit Range
forall s a. HasRange s a =&gt; Lens' s a
Lens' TextEdit Range
</span><span class="hs-identifier hs-var">J.range</span></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;range&quot; Range) ('[] @(LT (*)))))
-&gt; Rec
     ('R
        @(*)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
           ('[] @(LT (*)))))
-&gt; Rec
     ((.+)
        @(*)
        ('R
           @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;range&quot; Range) ('[] @(LT (*)))))
        ('R
           @(*)
           ((':)
              @(LT (*))
              ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
              ('[] @(LT (*))))))
forall (l :: Row (*)) (r :: Row (*)).
FreeForall @(*) l =&gt;
Rec l -&gt; Rec r -&gt; Rec ((.+) @(*) l r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;rangeLength&quot;
</span><span class="">#rangeLength</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;rangeLength&quot;
-&gt; Maybe UInt
-&gt; Rec
     (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec ((.==) @(*) l a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">Maybe UInt
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Rec
  ((.+)
     @(*)
     ('R
        @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;range&quot; Range) ('[] @(LT (*)))))
     ('R
        @(*)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
           ('[] @(LT (*))))))
-&gt; Rec
     ('R
        @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))
-&gt; Rec
     ((.+)
        @(*)
        ((.+)
           @(*)
           ('R
              @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;range&quot; Range) ('[] @(LT (*)))))
           ('R
              @(*)
              ((':)
                 @(LT (*))
                 ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
                 ('[] @(LT (*))))))
        ('R
           @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*))))))
forall (l :: Row (*)) (r :: Row (*)).
FreeForall @(*) l =&gt;
Rec l -&gt; Rec r -&gt; Rec ((.+) @(*) l r)
</span><span class="hs-operator hs-var">.+</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;text&quot;
</span><span class="">#text</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;text&quot; -&gt; Text -&gt; Rec ((.==) @(*) &quot;text&quot; Text)
forall (l :: Symbol) a.
KnownSymbol l =&gt;
Label l -&gt; a -&gt; Rec ((.==) @(*) l a)
</span><span class="hs-operator hs-var">.==</span></span><span> </span><span class="annot"><span class="annottext">TextEdit
</span><a href="#local-6989586621679186958"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">TextEdit -&gt; Getting Text TextEdit Text -&gt; Text
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting Text TextEdit Text
forall s a. HasNewText s a =&gt; Lens' s a
Lens' TextEdit Text
</span><span class="hs-identifier hs-var">J.newText</span></span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span id="local-6989586621679186264"><span class="annot"><a href="Language.LSP.VFS.html#applyDocumentChange"><span class="hs-identifier hs-type">applyDocumentChange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679186264"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679186264"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.DocumentChange</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186264"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-267"></span><span id="applyDocumentChange"><span class="annot"><span class="annottext">applyDocumentChange :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog) -&gt; DocumentChange -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyDocumentChange"><span class="hs-identifier hs-var hs-var">applyDocumentChange</span></a></span></span><span> </span><span id="local-6989586621679186965"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186965"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679186966"><span class="annot"><span class="annottext">TextDocumentEdit
</span><a href="#local-6989586621679186966"><span class="hs-identifier hs-var">change</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog) -&gt; TextDocumentEdit -&gt; m ()
forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog) -&gt; TextDocumentEdit -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyTextDocumentEdit"><span class="hs-identifier hs-var">applyTextDocumentEdit</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186965"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">TextDocumentEdit
</span><a href="#local-6989586621679186966"><span class="hs-identifier hs-var">change</span></a></span><span>
</span><span id="line-268"></span><span class="annot"><a href="Language.LSP.VFS.html#applyDocumentChange"><span class="hs-identifier hs-var">applyDocumentChange</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679186967"><span class="annot"><span class="annottext">CreateFile
</span><a href="#local-6989586621679186967"><span class="hs-identifier hs-var">change</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CreateFile -&gt; m ()
forall (m :: * -&gt; *). MonadState VFS m =&gt; CreateFile -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyCreateFile"><span class="hs-identifier hs-var">applyCreateFile</span></a></span><span> </span><span class="annot"><span class="annottext">CreateFile
</span><a href="#local-6989586621679186967"><span class="hs-identifier hs-var">change</span></a></span><span>
</span><span id="line-269"></span><span class="annot"><a href="Language.LSP.VFS.html#applyDocumentChange"><span class="hs-identifier hs-var">applyDocumentChange</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679186968"><span class="annot"><span class="annottext">RenameFile
</span><a href="#local-6989586621679186968"><span class="hs-identifier hs-var">change</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RenameFile -&gt; m ()
forall (m :: * -&gt; *). MonadState VFS m =&gt; RenameFile -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyRenameFile"><span class="hs-identifier hs-var">applyRenameFile</span></a></span><span> </span><span class="annot"><span class="annottext">RenameFile
</span><a href="#local-6989586621679186968"><span class="hs-identifier hs-var">change</span></a></span><span>
</span><span id="line-270"></span><span class="annot"><a href="Language.LSP.VFS.html#applyDocumentChange"><span class="hs-identifier hs-var">applyDocumentChange</span></a></span><span> </span><span id="local-6989586621679186969"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186969"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span id="local-6989586621679186970"><span class="annot"><span class="annottext">DeleteFile
</span><a href="#local-6989586621679186970"><span class="hs-identifier hs-var">change</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog) -&gt; DeleteFile -&gt; m ()
forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog) -&gt; DeleteFile -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyDeleteFile"><span class="hs-identifier hs-var">applyDeleteFile</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186969"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">DeleteFile
</span><a href="#local-6989586621679186970"><span class="hs-identifier hs-var">change</span></a></span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span class="annot"><span class="hs-comment">-- | Applies the changes from a 'ApplyWorkspaceEditRequest' to the 'VFS'</span></span><span>
</span><span id="line-273"></span><span class="annot"><a href="Language.LSP.VFS.html#changeFromServerVFS"><span class="hs-identifier hs-type">changeFromServerVFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679186267"><span class="annot"><a href="#local-6989586621679186267"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679186267"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679186267"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TMessage</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">J.Method_WorkspaceApplyEdit</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186267"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span id="changeFromServerVFS"><span class="annot"><span class="annottext">changeFromServerVFS :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; TMessage @'ServerToClient @'Request 'Method_WorkspaceApplyEdit
-&gt; m ()
</span><a href="Language.LSP.VFS.html#changeFromServerVFS"><span class="hs-identifier hs-var hs-var">changeFromServerVFS</span></a></span></span><span> </span><span id="local-6989586621679186987"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186987"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679186988"><span class="annot"><span class="annottext">TMessage @'ServerToClient @'Request 'Method_WorkspaceApplyEdit
</span><a href="#local-6989586621679186988"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.ApplyWorkspaceEditParams</span></span><span> </span><span id="local-6989586621679186995"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621679186995"><span class="hs-identifier hs-var">_label</span></a></span></span><span> </span><span id="local-6989586621679186996"><span class="annot"><span class="annottext">WorkspaceEdit
</span><a href="#local-6989586621679186996"><span class="hs-identifier hs-var">edit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMessage @'ServerToClient @'Request 'Method_WorkspaceApplyEdit
TRequestMessage @'ServerToClient 'Method_WorkspaceApplyEdit
</span><a href="#local-6989586621679186988"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage @'ServerToClient 'Method_WorkspaceApplyEdit
-&gt; Getting
     ApplyWorkspaceEditParams
     (TRequestMessage @'ServerToClient 'Method_WorkspaceApplyEdit)
     ApplyWorkspaceEditParams
-&gt; ApplyWorkspaceEditParams
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  ApplyWorkspaceEditParams
  (TRequestMessage @'ServerToClient 'Method_WorkspaceApplyEdit)
  ApplyWorkspaceEditParams
forall s a. HasParams s a =&gt; Lens' s a
Lens'
  (TRequestMessage @'ServerToClient 'Method_WorkspaceApplyEdit)
  ApplyWorkspaceEditParams
</span><span class="hs-identifier hs-var">J.params</span></span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">J.WorkspaceEdit</span></span><span> </span><span id="local-6989586621679186998"><span class="annot"><span class="annottext">Maybe (Map Uri [TextEdit])
</span><a href="#local-6989586621679186998"><span class="hs-identifier hs-var">mChanges</span></a></span></span><span> </span><span id="local-6989586621679186999"><span class="annot"><span class="annottext">Maybe [DocumentChange]
</span><a href="#local-6989586621679186999"><span class="hs-identifier hs-var">mDocChanges</span></a></span></span><span> </span><span id="local-6989586621679187000"><span class="annot"><span class="annottext">Maybe (Map ChangeAnnotationIdentifier ChangeAnnotation)
</span><a href="#local-6989586621679187000"><span class="hs-identifier hs-var">_anns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">WorkspaceEdit
</span><a href="#local-6989586621679186996"><span class="hs-identifier hs-var">edit</span></a></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [DocumentChange]
</span><a href="#local-6989586621679186999"><span class="hs-identifier hs-var">mDocChanges</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-278"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679187001"><span class="annot"><span class="annottext">[DocumentChange]
</span><a href="#local-6989586621679187001"><span class="hs-identifier hs-var">docChanges</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[DocumentChange] -&gt; m ()
</span><a href="#local-6989586621679187002"><span class="hs-identifier hs-var">applyDocumentChanges</span></a></span><span> </span><span class="annot"><span class="annottext">[DocumentChange]
</span><a href="#local-6989586621679187001"><span class="hs-identifier hs-var">docChanges</span></a></span><span>
</span><span id="line-279"></span><span>    </span><span class="annot"><span class="annottext">Maybe [DocumentChange]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Map Uri [TextEdit])
</span><a href="#local-6989586621679186998"><span class="hs-identifier hs-var">mChanges</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-280"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679187003"><span class="annot"><span class="annottext">Map Uri [TextEdit]
</span><a href="#local-6989586621679187003"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[DocumentChange] -&gt; m ()
</span><a href="#local-6989586621679187002"><span class="hs-identifier hs-var">applyDocumentChanges</span></a></span><span> </span><span class="annot"><span class="annottext">([DocumentChange] -&gt; m ()) -&gt; [DocumentChange] -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TextDocumentEdit -&gt; DocumentChange)
-&gt; [TextDocumentEdit] -&gt; [DocumentChange]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TextDocumentEdit -&gt; DocumentChange
forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">J.InL</span></span><span> </span><span class="annot"><span class="annottext">([TextDocumentEdit] -&gt; [DocumentChange])
-&gt; [TextDocumentEdit] -&gt; [DocumentChange]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([TextDocumentEdit] -&gt; Uri -&gt; [TextEdit] -&gt; [TextDocumentEdit])
-&gt; [TextDocumentEdit] -&gt; Map Uri [TextEdit] -&gt; [TextDocumentEdit]
forall a k b. (a -&gt; k -&gt; b -&gt; a) -&gt; a -&gt; Map k b -&gt; a
</span><span class="hs-identifier hs-var">Map.foldlWithKey'</span></span><span> </span><span class="annot"><span class="annottext">[TextDocumentEdit] -&gt; Uri -&gt; [TextEdit] -&gt; [TextDocumentEdit]
</span><a href="#local-6989586621679187005"><span class="hs-identifier hs-var">changeToTextDocumentEdit</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Map Uri [TextEdit]
</span><a href="#local-6989586621679187003"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-281"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Map Uri [TextEdit])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-283"></span><span>  </span><span id="local-6989586621679187005"><span class="annot"><span class="annottext">changeToTextDocumentEdit :: [TextDocumentEdit] -&gt; Uri -&gt; [TextEdit] -&gt; [TextDocumentEdit]
</span><a href="#local-6989586621679187005"><span class="hs-identifier hs-var hs-var">changeToTextDocumentEdit</span></a></span></span><span> </span><span id="local-6989586621679187009"><span class="annot"><span class="annottext">[TextDocumentEdit]
</span><a href="#local-6989586621679187009"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621679187010"><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621679187010"><span class="hs-identifier hs-var">uri</span></a></span></span><span> </span><span id="local-6989586621679187011"><span class="annot"><span class="annottext">[TextEdit]
</span><a href="#local-6989586621679187011"><span class="hs-identifier hs-var">edits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-284"></span><span>    </span><span class="annot"><span class="annottext">[TextDocumentEdit]
</span><a href="#local-6989586621679187009"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[TextDocumentEdit] -&gt; [TextDocumentEdit] -&gt; [TextDocumentEdit]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">OptionalVersionedTextDocumentIdentifier
-&gt; [TextEdit |? AnnotatedTextEdit] -&gt; TextDocumentEdit
</span><span class="hs-identifier hs-var">J.TextDocumentEdit</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; (Int32 |? Null) -&gt; OptionalVersionedTextDocumentIdentifier
</span><span class="hs-identifier hs-var">J.OptionalVersionedTextDocumentIdentifier</span></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621679187010"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int32 -&gt; Int32 |? Null
forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">J.InL</span></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TextEdit -&gt; TextEdit |? AnnotatedTextEdit)
-&gt; [TextEdit] -&gt; [TextEdit |? AnnotatedTextEdit]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TextEdit -&gt; TextEdit |? AnnotatedTextEdit
forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">J.InL</span></span><span> </span><span class="annot"><span class="annottext">[TextEdit]
</span><a href="#local-6989586621679187011"><span class="hs-identifier hs-var">edits</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span>  </span><span class="annot"><a href="#local-6989586621679187002"><span class="hs-identifier hs-type">applyDocumentChanges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">J.DocumentChange</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186267"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>  </span><span id="local-6989586621679187002"><span class="annot"><span class="annottext">applyDocumentChanges :: [DocumentChange] -&gt; m ()
</span><a href="#local-6989586621679187002"><span class="hs-identifier hs-var hs-var">applyDocumentChanges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DocumentChange -&gt; m ()) -&gt; [DocumentChange] -&gt; m ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog) -&gt; DocumentChange -&gt; m ()
forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog) -&gt; DocumentChange -&gt; m ()
</span><a href="Language.LSP.VFS.html#applyDocumentChange"><span class="hs-identifier hs-var">applyDocumentChange</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679186987"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([DocumentChange] -&gt; m ())
-&gt; ([DocumentChange] -&gt; [DocumentChange])
-&gt; [DocumentChange]
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(DocumentChange -&gt; Maybe Int32)
-&gt; [DocumentChange] -&gt; [DocumentChange]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="annot"><span class="annottext">DocumentChange -&gt; Maybe Int32
</span><a href="#local-6989586621679187013"><span class="hs-identifier hs-var">project</span></a></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-comment">-- for sorting [DocumentChange]</span><span>
</span><span id="line-290"></span><span>  </span><span class="annot"><a href="#local-6989586621679187013"><span class="hs-identifier hs-type">project</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.DocumentChange</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Int32</span></span><span>
</span><span id="line-291"></span><span>  </span><span id="local-6989586621679187013"><span class="annot"><span class="annottext">project :: DocumentChange -&gt; Maybe Int32
</span><a href="#local-6989586621679187013"><span class="hs-identifier hs-var hs-var">project</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679187014"><span class="annot"><span class="annottext">TextDocumentEdit
</span><a href="#local-6989586621679187014"><span class="hs-identifier hs-var">textDocumentEdit</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TextDocumentEdit
</span><a href="#local-6989586621679187014"><span class="hs-identifier hs-var">textDocumentEdit</span></a></span><span> </span><span class="annot"><span class="annottext">TextDocumentEdit
-&gt; Getting (Int32 |? Null) TextDocumentEdit (Int32 |? Null)
-&gt; Int32 |? Null
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(OptionalVersionedTextDocumentIdentifier
 -&gt; Const
      @(*) (Int32 |? Null) OptionalVersionedTextDocumentIdentifier)
-&gt; TextDocumentEdit -&gt; Const @(*) (Int32 |? Null) TextDocumentEdit
forall s a. HasTextDocument s a =&gt; Lens' s a
Lens' TextDocumentEdit OptionalVersionedTextDocumentIdentifier
</span><span class="hs-identifier hs-var">J.textDocument</span></span><span> </span><span class="annot"><span class="annottext">((OptionalVersionedTextDocumentIdentifier
  -&gt; Const
       @(*) (Int32 |? Null) OptionalVersionedTextDocumentIdentifier)
 -&gt; TextDocumentEdit -&gt; Const @(*) (Int32 |? Null) TextDocumentEdit)
-&gt; Getting
     (Int32 |? Null)
     OptionalVersionedTextDocumentIdentifier
     (Int32 |? Null)
-&gt; Getting (Int32 |? Null) TextDocumentEdit (Int32 |? Null)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  (Int32 |? Null)
  OptionalVersionedTextDocumentIdentifier
  (Int32 |? Null)
forall s a. HasVersion s a =&gt; Lens' s a
Lens' OptionalVersionedTextDocumentIdentifier (Int32 |? Null)
</span><span class="hs-identifier hs-var">J.version</span></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-292"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679187015"><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679187015"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; Maybe Int32
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="#local-6989586621679187015"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><span class="annottext">Int32 |? Null
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Int32
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-294"></span><span>  </span><span class="annot"><a href="#local-6989586621679187013"><span class="hs-identifier hs-var">project</span></a></span><span> </span><span class="annot"><span class="annottext">DocumentChange
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Int32
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-297"></span><span class="annot"><a href="Language.LSP.VFS.html#virtualFileName"><span class="hs-identifier hs-type">virtualFileName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-298"></span><span id="virtualFileName"><span class="annot"><span class="annottext">virtualFileName :: [Char] -&gt; NormalizedUri -&gt; VirtualFile -&gt; [Char]
</span><a href="Language.LSP.VFS.html#virtualFileName"><span class="hs-identifier hs-var hs-var">virtualFileName</span></a></span></span><span> </span><span id="local-6989586621679187017"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679187017"><span class="hs-identifier hs-var">prefix</span></a></span></span><span> </span><span id="local-6989586621679187018"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679187018"><span class="hs-identifier hs-var">uri</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679187019"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679187019"><span class="hs-identifier hs-var">file_ver</span></a></span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187020"><span class="annot"><span class="annottext">uri_raw :: Uri
</span><a href="#local-6989586621679187020"><span class="hs-identifier hs-var hs-var">uri_raw</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; Uri
</span><span class="hs-identifier hs-var">J.fromNormalizedUri</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679187018"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-300"></span><span>      </span><span id="local-6989586621679187024"><span class="annot"><span class="annottext">basename :: [Char]
</span><a href="#local-6989586621679187024"><span class="hs-identifier hs-var hs-var">basename</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS -&gt; Maybe [Char] -&gt; [Char]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">ShowS
</span><span class="hs-identifier hs-var">takeFileName</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; Maybe [Char]
</span><span class="hs-identifier hs-var">J.uriToFilePath</span></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621679187020"><span class="hs-identifier hs-var">uri_raw</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>      </span><span class="hs-comment">-- Given a length and a version number, pad the version number to</span><span>
</span><span id="line-302"></span><span>      </span><span class="hs-comment">-- the given n. Does nothing if the version number string is longer</span><span>
</span><span id="line-303"></span><span>      </span><span class="hs-comment">-- than the given length.</span><span>
</span><span id="line-304"></span><span>      </span><span class="annot"><a href="#local-6989586621679187028"><span class="hs-identifier hs-type">padLeft</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-305"></span><span>      </span><span id="local-6989586621679187028"><span class="annot"><span class="annottext">padLeft :: Int -&gt; Int -&gt; [Char]
</span><a href="#local-6989586621679187028"><span class="hs-identifier hs-var hs-var">padLeft</span></a></span></span><span> </span><span id="local-6989586621679187029"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679187029"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679187030"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679187030"><span class="hs-identifier hs-var">num</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-306"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187032"><span class="annot"><span class="annottext">numString :: [Char]
</span><a href="#local-6989586621679187032"><span class="hs-identifier hs-var hs-var">numString</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679187030"><span class="hs-identifier hs-var">num</span></a></span><span>
</span><span id="line-307"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Char -&gt; [Char]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679187029"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679187032"><span class="hs-identifier hs-var">numString</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'0'</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679187032"><span class="hs-identifier hs-var">numString</span></a></span><span>
</span><span id="line-308"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679187017"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
</span><span class="hs-operator hs-var">&lt;/&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679187024"><span class="hs-identifier hs-var">basename</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;-&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; [Char]
</span><a href="#local-6989586621679187028"><span class="hs-identifier hs-var">padLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">5</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679187019"><span class="hs-identifier hs-var">file_ver</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;-&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; Int
forall a. Hashable a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">hash</span></span><span> </span><span class="annot"><span class="annottext">Uri
</span><a href="#local-6989586621679187020"><span class="hs-identifier hs-var">uri_raw</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
</span><span class="hs-operator hs-var">&lt;.&gt;</span></span><span> </span><span class="annot"><span class="annottext">ShowS
</span><span class="hs-identifier hs-var">takeExtensions</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679187024"><span class="hs-identifier hs-var">basename</span></a></span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span class="annot"><span class="hs-comment">-- | Write a virtual file to a file in the given directory if it exists in the VFS.</span></span><span>
</span><span id="line-311"></span><span id="local-6989586621679186294"><span class="annot"><a href="Language.LSP.VFS.html#persistFileVFS"><span class="hs-identifier hs-type">persistFileVFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679186294"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679186294"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.NormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679186294"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-312"></span><span id="persistFileVFS"><span class="annot"><span class="annottext">persistFileVFS :: forall (m :: * -&gt; *).
MonadIO m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; [Char] -&gt; VFS -&gt; NormalizedUri -&gt; Maybe ([Char], m ())
</span><a href="Language.LSP.VFS.html#persistFileVFS"><span class="hs-identifier hs-var hs-var">persistFileVFS</span></a></span></span><span> </span><span id="local-6989586621679187050"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679187050"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679187051"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679187051"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span id="local-6989586621679187052"><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679187052"><span class="hs-identifier hs-var">vfs</span></a></span></span><span> </span><span id="local-6989586621679187053"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679187053"><span class="hs-identifier hs-var">uri</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-313"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VFS
</span><a href="#local-6989586621679187052"><span class="hs-identifier hs-var">vfs</span></a></span><span> </span><span class="annot"><span class="annottext">VFS
-&gt; Getting (Maybe VirtualFile) VFS (Maybe VirtualFile)
-&gt; Maybe VirtualFile
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Const @(*) (Maybe VirtualFile) (Map NormalizedUri VirtualFile))
-&gt; VFS -&gt; Const @(*) (Maybe VirtualFile) VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Const @(*) (Maybe VirtualFile) (Map NormalizedUri VirtualFile))
 -&gt; VFS -&gt; Const @(*) (Maybe VirtualFile) VFS)
-&gt; ((Maybe VirtualFile
     -&gt; Const @(*) (Maybe VirtualFile) (Maybe VirtualFile))
    -&gt; Map NormalizedUri VirtualFile
    -&gt; Const @(*) (Maybe VirtualFile) (Map NormalizedUri VirtualFile))
-&gt; Getting (Maybe VirtualFile) VFS (Maybe VirtualFile)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
-&gt; Lens'
     (Map NormalizedUri VirtualFile)
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
NormalizedUri
</span><a href="#local-6989586621679187053"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><span class="annottext">Maybe VirtualFile
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ([Char], m ())
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-315"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679187054"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187054"><span class="hs-identifier hs-var">vf</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-316"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187055"><span class="annot"><span class="annottext">tfn :: [Char]
</span><a href="#local-6989586621679187055"><span class="hs-identifier hs-var hs-var">tfn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; NormalizedUri -&gt; VirtualFile -&gt; [Char]
</span><a href="Language.LSP.VFS.html#virtualFileName"><span class="hs-identifier hs-var">virtualFileName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679187051"><span class="hs-identifier hs-var">dir</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679187053"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187054"><span class="hs-identifier hs-var">vf</span></a></span><span>
</span><span id="line-317"></span><span>          </span><span id="local-6989586621679187067"><span class="annot"><span class="annottext">action :: m ()
</span><a href="#local-6989586621679187067"><span class="hs-identifier hs-var hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>            </span><span id="local-6989586621679187068"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679187068"><span class="hs-identifier hs-var">exists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; m Bool
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; m Bool) -&gt; IO Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IO Bool
</span><span class="hs-identifier hs-var">doesFileExist</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679187055"><span class="hs-identifier hs-var">tfn</span></a></span><span>
</span><span id="line-319"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679187068"><span class="hs-identifier hs-var">exists</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-320"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187072"><span class="annot"><span class="annottext">contents :: Text
</span><a href="#local-6989586621679187072"><span class="hs-identifier hs-var hs-var">contents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VirtualFile -&gt; Rope
</span><a href="Language.LSP.VFS.html#%24sel%3A_file_text%3AVirtualFile"><span class="hs-identifier hs-var">_file_text</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187054"><span class="hs-identifier hs-var">vf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>                  </span><span id="local-6989586621679187076"><span class="annot"><span class="annottext">writeRaw :: Handle -&gt; IO ()
</span><a href="#local-6989586621679187076"><span class="hs-identifier hs-var hs-var">writeRaw</span></a></span></span><span> </span><span id="local-6989586621679187077"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679187077"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-322"></span><span>                    </span><span class="hs-comment">-- We honour original file line endings</span><span>
</span><span id="line-323"></span><span>                    </span><span class="annot"><span class="annottext">Handle -&gt; NewlineMode -&gt; IO ()
</span><span class="hs-identifier hs-var">hSetNewlineMode</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679187077"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">NewlineMode
</span><span class="hs-identifier hs-var">noNewlineTranslation</span></span><span>
</span><span id="line-324"></span><span>                    </span><span class="annot"><span class="annottext">Handle -&gt; TextEncoding -&gt; IO ()
</span><span class="hs-identifier hs-var">hSetEncoding</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679187077"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">TextEncoding
</span><span class="hs-identifier hs-var">utf8</span></span><span>
</span><span id="line-325"></span><span>                    </span><span class="annot"><span class="annottext">Handle -&gt; Text -&gt; IO ()
</span><span class="hs-identifier hs-var">T.hPutStr</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679187077"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187072"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-326"></span><span>              </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679187050"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog) -&gt; WithSeverity VfsLog -&gt; m ()
forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; [Char] -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#PersistingFile"><span class="hs-identifier hs-var">PersistingFile</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679187053"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679187055"><span class="hs-identifier hs-var">tfn</span></a></span><span> </span><span class="annot"><span class="annottext">VfsLog -&gt; Severity -&gt; WithSeverity VfsLog
forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Debug</span></span><span>
</span><span id="line-327"></span><span>              </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IOMode -&gt; (Handle -&gt; IO ()) -&gt; IO ()
forall r. [Char] -&gt; IOMode -&gt; (Handle -&gt; IO r) -&gt; IO r
</span><span class="hs-identifier hs-var">withFile</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679187055"><span class="hs-identifier hs-var">tfn</span></a></span><span> </span><span class="annot"><span class="annottext">IOMode
</span><span class="hs-identifier hs-var">WriteMode</span></span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><a href="#local-6989586621679187076"><span class="hs-identifier hs-var">writeRaw</span></a></span><span>
</span><span id="line-328"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">([Char], m ()) -&gt; Maybe ([Char], m ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621679187055"><span class="hs-identifier hs-var">tfn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621679187067"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span id="local-6989586621679186304"><span class="annot"><a href="Language.LSP.VFS.html#closeVFS"><span class="hs-identifier hs-type">closeVFS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VFS"><span class="hs-identifier hs-type">VFS</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679186304"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679186304"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TMessage</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">J.Method_TextDocumentDidClose</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186304"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-333"></span><span id="closeVFS"><span class="annot"><span class="annottext">closeVFS :: forall (m :: * -&gt; *).
MonadState VFS m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; TMessage
     @'ClientToServer @'Notification 'Method_TextDocumentDidClose
-&gt; m ()
</span><a href="Language.LSP.VFS.html#closeVFS"><span class="hs-identifier hs-var hs-var">closeVFS</span></a></span></span><span> </span><span id="local-6989586621679187093"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679187093"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679187094"><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidClose
</span><a href="#local-6989586621679187094"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-334"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.DidCloseTextDocumentParams</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentIdentifier</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uri -&gt; NormalizedUri
</span><span class="hs-identifier hs-var">J.toNormalizedUri</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679187101"><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679187101"><span class="hs-identifier hs-var">uri</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMessage
  @'ClientToServer @'Notification 'Method_TextDocumentDidClose
TNotificationMessage @'ClientToServer 'Method_TextDocumentDidClose
</span><a href="#local-6989586621679187094"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">TNotificationMessage @'ClientToServer 'Method_TextDocumentDidClose
-&gt; Getting
     DidCloseTextDocumentParams
     (TNotificationMessage
        @'ClientToServer 'Method_TextDocumentDidClose)
     DidCloseTextDocumentParams
-&gt; DidCloseTextDocumentParams
forall s a. s -&gt; Getting a s a -&gt; a
</span><span class="hs-operator hs-var">^.</span></span><span> </span><span class="annot"><span class="annottext">Getting
  DidCloseTextDocumentParams
  (TNotificationMessage
     @'ClientToServer 'Method_TextDocumentDidClose)
  DidCloseTextDocumentParams
forall s a. HasParams s a =&gt; Lens' s a
Lens'
  (TNotificationMessage
     @'ClientToServer 'Method_TextDocumentDidClose)
  DidCloseTextDocumentParams
</span><span class="hs-identifier hs-var">J.params</span></span><span>
</span><span id="line-335"></span><span>  </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679187093"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog) -&gt; WithSeverity VfsLog -&gt; m ()
forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">NormalizedUri -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#Closing"><span class="hs-identifier hs-var">Closing</span></a></span><span> </span><span class="annot"><span class="annottext">NormalizedUri
</span><a href="#local-6989586621679187101"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">VfsLog -&gt; Severity -&gt; WithSeverity VfsLog
forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Debug</span></span><span>
</span><span id="line-336"></span><span>  </span><span class="annot"><span class="annottext">(Map NormalizedUri VirtualFile
 -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; VFS -&gt; Identity VFS
forall s a. HasVfsMap s a =&gt; Lens' s a
Lens' VFS (Map NormalizedUri VirtualFile)
</span><a href="Language.LSP.VFS.html#vfsMap"><span class="hs-identifier hs-var">vfsMap</span></a></span><span> </span><span class="annot"><span class="annottext">((Map NormalizedUri VirtualFile
  -&gt; Identity (Map NormalizedUri VirtualFile))
 -&gt; VFS -&gt; Identity VFS)
-&gt; ((Maybe (IxValue (Map NormalizedUri VirtualFile))
     -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
    -&gt; Map NormalizedUri VirtualFile
    -&gt; Identity (Map NormalizedUri VirtualFile))
-&gt; (Maybe (IxValue (Map NormalizedUri VirtualFile))
    -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
-&gt; VFS
-&gt; Identity VFS
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
-&gt; Lens'
     (Map NormalizedUri VirtualFile)
     (Maybe (IxValue (Map NormalizedUri VirtualFile)))
forall m. At m =&gt; Index m -&gt; Lens' m (Maybe (IxValue m))
</span><span class="hs-identifier hs-var">at</span></span><span> </span><span class="annot"><span class="annottext">Index (Map NormalizedUri VirtualFile)
NormalizedUri
</span><a href="#local-6989586621679187101"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe (IxValue (Map NormalizedUri VirtualFile))
  -&gt; Identity (Maybe (IxValue (Map NormalizedUri VirtualFile))))
 -&gt; VFS -&gt; Identity VFS)
-&gt; Maybe (IxValue (Map NormalizedUri VirtualFile)) -&gt; m ()
forall s (m :: * -&gt; *) a b.
MonadState s m =&gt;
ASetter s s a b -&gt; b -&gt; m ()
</span><span class="hs-operator hs-var">.=</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IxValue (Map NormalizedUri VirtualFile))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span class="annot"><span class="hs-comment">{- | Apply the list of changes.
 Changes should be applied in the order that they are
 received from the client.
-}</span></span><span>
</span><span id="line-344"></span><span id="local-6989586621679186141"><span class="annot"><a href="Language.LSP.VFS.html#applyChanges"><span class="hs-identifier hs-type">applyChanges</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679186141"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679186141"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentContentChangeEvent</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186141"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span></span><span>
</span><span id="line-345"></span><span id="applyChanges"><span class="annot"><span class="annottext">applyChanges :: forall (m :: * -&gt; *).
Monad m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; [TextDocumentContentChangeEvent] -&gt; m Rope
</span><a href="Language.LSP.VFS.html#applyChanges"><span class="hs-identifier hs-var hs-var">applyChanges</span></a></span></span><span> </span><span id="local-6989586621679187106"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679187106"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Rope -&gt; TextDocumentContentChangeEvent -&gt; m Rope)
-&gt; Rope -&gt; [TextDocumentContentChangeEvent] -&gt; m Rope
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; TextDocumentContentChangeEvent -&gt; m Rope
forall (m :: * -&gt; *).
Monad m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; TextDocumentContentChangeEvent -&gt; m Rope
</span><a href="Language.LSP.VFS.html#applyChange"><span class="hs-identifier hs-var">applyChange</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679187106"><span class="hs-identifier hs-var">logger</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span id="local-6989586621679186314"><span class="annot"><a href="Language.LSP.VFS.html#applyChange"><span class="hs-identifier hs-type">applyChange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679186314"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679186314"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentContentChangeEvent</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186314"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span></span><span>
</span><span id="line-350"></span><span id="applyChange"><span class="annot"><span class="annottext">applyChange :: forall (m :: * -&gt; *).
Monad m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; TextDocumentContentChangeEvent -&gt; m Rope
</span><a href="Language.LSP.VFS.html#applyChange"><span class="hs-identifier hs-var hs-var">applyChange</span></a></span></span><span> </span><span id="local-6989586621679187129"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679187129"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679187130"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187130"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentContentChangeEvent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InL</span></span><span> </span><span id="local-6989586621679187131"><span class="annot"><span class="annottext">Rec
  ((.+)
     @(*)
     (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
     ((.+)
        @(*)
        (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
        ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
</span><a href="#local-6989586621679187131"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span id="local-6989586621679187134"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187134"><span class="hs-identifier hs-var">sl</span></a></span></span><span> </span><span id="local-6989586621679187135"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187135"><span class="hs-identifier hs-var">sc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span id="local-6989586621679187136"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187136"><span class="hs-identifier hs-var">fl</span></a></span></span><span> </span><span id="local-6989586621679187137"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187137"><span class="hs-identifier hs-var">fc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rec
  ((.+)
     @(*)
     (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
     ((.+)
        @(*)
        (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
        ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
Rec
  ('R
     @(*)
     ((':)
        @(LT (*))
        ((':-&gt;) @(*) &quot;range&quot; Range)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
           ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))))
</span><a href="#local-6989586621679187131"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     @(*)
     ((':)
        @(LT (*))
        ((':-&gt;) @(*) &quot;range&quot; Range)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
           ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))))
-&gt; Label &quot;range&quot;
-&gt; (.!)
     @(*)
     ('R
        @(*)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;range&quot; Range)
           ((':)
              @(LT (*))
              ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
              ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))))
     &quot;range&quot;
forall (l :: Symbol) (r :: Row (*)).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; (.!) @(*) r l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;range&quot;
</span><span class="">#range</span></span><span>
</span><span id="line-352"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679187139"><span class="annot"><span class="annottext">(.!)
  @(*)
  ('R
     @(*)
     ((':)
        @(LT (*))
        ((':-&gt;) @(*) &quot;range&quot; Range)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
           ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))))
  &quot;text&quot;
</span><a href="#local-6989586621679187139"><span class="hs-identifier hs-var">txt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rec
  ((.+)
     @(*)
     (Extend @(*) &quot;range&quot; Range ('R @(*) ('[] @(LT (*)))))
     ((.+)
        @(*)
        (Extend @(*) &quot;rangeLength&quot; (Maybe UInt) ('R @(*) ('[] @(LT (*)))))
        ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))))
Rec
  ('R
     @(*)
     ((':)
        @(LT (*))
        ((':-&gt;) @(*) &quot;range&quot; Range)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
           ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))))
</span><a href="#local-6989586621679187131"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     @(*)
     ((':)
        @(LT (*))
        ((':-&gt;) @(*) &quot;range&quot; Range)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
           ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))))
-&gt; Label &quot;text&quot;
-&gt; (.!)
     @(*)
     ('R
        @(*)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;range&quot; Range)
           ((':)
              @(LT (*))
              ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
              ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))))
     &quot;text&quot;
forall (l :: Symbol) (r :: Row (*)).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; (.!) @(*) r l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;text&quot;
</span><span class="">#text</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-353"></span><span>      </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; Position -&gt; Position -&gt; Text -&gt; m Rope
forall (m :: * -&gt; *).
Monad m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; Position -&gt; Position -&gt; Text -&gt; m Rope
</span><a href="Language.LSP.VFS.html#changeChars"><span class="hs-identifier hs-var">changeChars</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679187129"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187130"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Position
</span><span class="hs-identifier hs-var">Rope.Position</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187134"><span class="hs-identifier hs-var">sl</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187135"><span class="hs-identifier hs-var">sc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Position
</span><span class="hs-identifier hs-var">Rope.Position</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187136"><span class="hs-identifier hs-var">fl</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187137"><span class="hs-identifier hs-var">fc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
(.!)
  @(*)
  ('R
     @(*)
     ((':)
        @(LT (*))
        ((':-&gt;) @(*) &quot;range&quot; Range)
        ((':)
           @(LT (*))
           ((':-&gt;) @(*) &quot;rangeLength&quot; (Maybe UInt))
           ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))))
  &quot;text&quot;
</span><a href="#local-6989586621679187139"><span class="hs-identifier hs-var">txt</span></a></span><span>
</span><span id="line-354"></span><span class="annot"><a href="Language.LSP.VFS.html#applyChange"><span class="hs-identifier hs-var">applyChange</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.TextDocumentContentChangeEvent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.InR</span></span><span> </span><span id="local-6989586621679187141"><span class="annot"><span class="annottext">Rec ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))
</span><a href="#local-6989586621679187141"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-355"></span><span>  </span><span class="annot"><span class="annottext">Rope -&gt; m Rope
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Rope -&gt; m Rope) -&gt; Rope -&gt; m Rope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Rope
</span><span class="hs-identifier hs-var">Rope.fromText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Rope) -&gt; Text -&gt; Rope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rec ((.+) @(*) ((.==) @(*) &quot;text&quot; Text) ('R @(*) ('[] @(LT (*)))))
Rec
  ('R
     @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))
</span><a href="#local-6989586621679187141"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Rec
  ('R
     @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))
-&gt; Label &quot;text&quot;
-&gt; (.!)
     @(*)
     ('R
        @(*) ((':) @(LT (*)) ((':-&gt;) @(*) &quot;text&quot; Text) ('[] @(LT (*)))))
     &quot;text&quot;
forall (l :: Symbol) (r :: Row (*)).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; (.!) @(*) r l
</span><span class="hs-operator hs-var">.!</span></span><span> </span><span class="annot"><span class="annottext">Label &quot;text&quot;
</span><span class="">#text</span></span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span class="annot"><span class="hs-comment">{- | Given a 'Rope', start and end positions, and some new text, replace
 the given range with the new text. If the given positions lie within
 a code point then this does nothing (returns the original 'Rope') and logs.
-}</span></span><span>
</span><span id="line-363"></span><span id="local-6989586621679186320"><span class="annot"><a href="Language.LSP.VFS.html#changeChars"><span class="hs-identifier hs-type">changeChars</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679186320"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">LogAction</span></span><span> </span><span class="annot"><a href="#local-6989586621679186320"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">WithSeverity</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VfsLog"><span class="hs-identifier hs-type">VfsLog</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope.Position</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope.Position</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186320"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope</span></span></span><span>
</span><span id="line-364"></span><span id="changeChars"><span class="annot"><span class="annottext">changeChars :: forall (m :: * -&gt; *).
Monad m =&gt;
LogAction m (WithSeverity VfsLog)
-&gt; Rope -&gt; Position -&gt; Position -&gt; Text -&gt; m Rope
</span><a href="Language.LSP.VFS.html#changeChars"><span class="hs-identifier hs-var hs-var">changeChars</span></a></span></span><span> </span><span id="local-6989586621679187150"><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679187150"><span class="hs-identifier hs-var">logger</span></a></span></span><span> </span><span id="local-6989586621679187151"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187151"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span id="local-6989586621679187152"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679187152"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679187153"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679187153"><span class="hs-identifier hs-var">finish</span></a></span></span><span> </span><span id="local-6989586621679187154"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187154"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-365"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Position -&gt; Rope -&gt; Maybe (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtPosition</span></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679187153"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187151"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-366"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Rope, Rope)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679187150"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog) -&gt; WithSeverity VfsLog -&gt; m ()
forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Position -&gt; Rope -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#SplitInsideCodePoint"><span class="hs-identifier hs-var">SplitInsideCodePoint</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679187153"><span class="hs-identifier hs-var">finish</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187151"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">VfsLog -&gt; Severity -&gt; WithSeverity VfsLog
forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Warning</span></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m Rope -&gt; m Rope
forall a b. m a -&gt; m b -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; m Rope
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187151"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-367"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679187156"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187156"><span class="hs-identifier hs-var">before</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679187157"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187157"><span class="hs-identifier hs-var">after</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Position -&gt; Rope -&gt; Maybe (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtPosition</span></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679187152"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187156"><span class="hs-identifier hs-var">before</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-368"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Rope, Rope)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog)
</span><a href="#local-6989586621679187150"><span class="hs-identifier hs-var">logger</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction m (WithSeverity VfsLog) -&gt; WithSeverity VfsLog -&gt; m ()
forall (m :: * -&gt; *) msg. LogAction m msg -&gt; msg -&gt; m ()
</span><span class="hs-operator hs-var">&lt;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Position -&gt; Rope -&gt; VfsLog
</span><a href="Language.LSP.VFS.html#SplitInsideCodePoint"><span class="hs-identifier hs-var">SplitInsideCodePoint</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679187152"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187156"><span class="hs-identifier hs-var">before</span></a></span><span> </span><span class="annot"><span class="annottext">VfsLog -&gt; Severity -&gt; WithSeverity VfsLog
forall msg. msg -&gt; Severity -&gt; WithSeverity msg
</span><span class="hs-operator hs-var">`WithSeverity`</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Warning</span></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m Rope -&gt; m Rope
forall a b. m a -&gt; m b -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; m Rope
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187151"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-369"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679187158"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187158"><span class="hs-identifier hs-var">before'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; m Rope
forall a. a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Rope -&gt; m Rope) -&gt; Rope -&gt; m Rope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Rope] -&gt; Rope
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187158"><span class="hs-identifier hs-var">before'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Rope
</span><span class="hs-identifier hs-var">Rope.fromText</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187154"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187157"><span class="hs-identifier hs-var">after</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-370"></span><span>
</span><span id="line-371"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span class="annot"><span class="hs-comment">{- | A position, like a 'J.Position', but where the offsets in the line are measured in
 Unicode code points instead of UTF-16 code units.
-}</span></span><span>
</span><span id="line-376"></span><span class="hs-keyword">data</span><span> </span><span id="CodePointPosition"><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-var">CodePointPosition</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CodePointPosition"><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-var">CodePointPosition</span></a></span></span><span>
</span><span id="line-377"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="%24sel%3A_line%3ACodePointPosition"><span class="annot"><span class="annottext">CodePointPosition -&gt; UInt
</span><a href="Language.LSP.VFS.html#%24sel%3A_line%3ACodePointPosition"><span class="hs-identifier hs-var hs-var">_line</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.UInt</span></span><span>
</span><span id="line-378"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Line position in a document (zero-based).</span></span><span>
</span><span id="line-379"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3A_character%3ACodePointPosition"><span class="annot"><span class="annottext">CodePointPosition -&gt; UInt
</span><a href="Language.LSP.VFS.html#%24sel%3A_character%3ACodePointPosition"><span class="hs-identifier hs-var hs-var">_character</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.UInt</span></span><span>
</span><span id="line-380"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Character offset on a line in a document in *code points* (zero-based).</span></span><span>
</span><span id="line-381"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-382"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679187163"><span id="local-6989586621679187169"><span id="local-6989586621679187173"><span class="annot"><span class="annottext">Int -&gt; CodePointPosition -&gt; ShowS
[CodePointPosition] -&gt; ShowS
CodePointPosition -&gt; [Char]
(Int -&gt; CodePointPosition -&gt; ShowS)
-&gt; (CodePointPosition -&gt; [Char])
-&gt; ([CodePointPosition] -&gt; ShowS)
-&gt; Show CodePointPosition
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; CodePointPosition -&gt; ShowS
showsPrec :: Int -&gt; CodePointPosition -&gt; ShowS
$cshow :: CodePointPosition -&gt; [Char]
show :: CodePointPosition -&gt; [Char]
$cshowList :: [CodePointPosition] -&gt; ShowS
showList :: [CodePointPosition] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679187176"><span id="local-6989586621679187180"><span id="local-6989586621679187183"><span id="local-6989586621679187196"><span class="annot"><span class="annottext">ReadPrec [CodePointPosition]
ReadPrec CodePointPosition
Int -&gt; ReadS CodePointPosition
ReadS [CodePointPosition]
(Int -&gt; ReadS CodePointPosition)
-&gt; ReadS [CodePointPosition]
-&gt; ReadPrec CodePointPosition
-&gt; ReadPrec [CodePointPosition]
-&gt; Read CodePointPosition
forall a.
(Int -&gt; ReadS a)
-&gt; ReadS [a] -&gt; ReadPrec a -&gt; ReadPrec [a] -&gt; Read a
$creadsPrec :: Int -&gt; ReadS CodePointPosition
readsPrec :: Int -&gt; ReadS CodePointPosition
$creadList :: ReadS [CodePointPosition]
readList :: ReadS [CodePointPosition]
$creadPrec :: ReadPrec CodePointPosition
readPrec :: ReadPrec CodePointPosition
$creadListPrec :: ReadPrec [CodePointPosition]
readListPrec :: ReadPrec [CodePointPosition]
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Read</span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679187200"><span id="local-6989586621679187205"><span class="annot"><span class="annottext">CodePointPosition -&gt; CodePointPosition -&gt; Bool
(CodePointPosition -&gt; CodePointPosition -&gt; Bool)
-&gt; (CodePointPosition -&gt; CodePointPosition -&gt; Bool)
-&gt; Eq CodePointPosition
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
== :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
$c/= :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
/= :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679187212"><span id="local-6989586621679187217"><span id="local-6989586621679187221"><span id="local-6989586621679187225"><span id="local-6989586621679187228"><span id="local-6989586621679187231"><span id="local-6989586621679187234"><span class="annot"><span class="annottext">Eq CodePointPosition
Eq CodePointPosition =&gt;
(CodePointPosition -&gt; CodePointPosition -&gt; Ordering)
-&gt; (CodePointPosition -&gt; CodePointPosition -&gt; Bool)
-&gt; (CodePointPosition -&gt; CodePointPosition -&gt; Bool)
-&gt; (CodePointPosition -&gt; CodePointPosition -&gt; Bool)
-&gt; (CodePointPosition -&gt; CodePointPosition -&gt; Bool)
-&gt; (CodePointPosition -&gt; CodePointPosition -&gt; CodePointPosition)
-&gt; (CodePointPosition -&gt; CodePointPosition -&gt; CodePointPosition)
-&gt; Ord CodePointPosition
CodePointPosition -&gt; CodePointPosition -&gt; Bool
CodePointPosition -&gt; CodePointPosition -&gt; Ordering
CodePointPosition -&gt; CodePointPosition -&gt; CodePointPosition
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: CodePointPosition -&gt; CodePointPosition -&gt; Ordering
compare :: CodePointPosition -&gt; CodePointPosition -&gt; Ordering
$c&lt; :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
&lt; :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
$c&lt;= :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
&lt;= :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
$c&gt; :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
&gt; :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
$c&gt;= :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
&gt;= :: CodePointPosition -&gt; CodePointPosition -&gt; Bool
$cmax :: CodePointPosition -&gt; CodePointPosition -&gt; CodePointPosition
max :: CodePointPosition -&gt; CodePointPosition -&gt; CodePointPosition
$cmin :: CodePointPosition -&gt; CodePointPosition -&gt; CodePointPosition
min :: CodePointPosition -&gt; CodePointPosition -&gt; CodePointPosition
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span class="annot"><span class="hs-comment">{- | A range, like a 'J.Range', but where the offsets in the line are measured in
 Unicode code points instead of UTF-16 code units.
-}</span></span><span>
</span><span id="line-387"></span><span class="hs-keyword">data</span><span> </span><span id="CodePointRange"><span class="annot"><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier hs-var">CodePointRange</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CodePointRange"><span class="annot"><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier hs-var">CodePointRange</span></a></span></span><span>
</span><span id="line-388"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="%24sel%3A_start%3ACodePointRange"><span class="annot"><span class="annottext">CodePointRange -&gt; CodePointPosition
</span><a href="Language.LSP.VFS.html#%24sel%3A_start%3ACodePointRange"><span class="hs-identifier hs-var hs-var">_start</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-type">CodePointPosition</span></a></span><span>
</span><span id="line-389"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The range's start position.</span></span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3A_end%3ACodePointRange"><span class="annot"><span class="annottext">CodePointRange -&gt; CodePointPosition
</span><a href="Language.LSP.VFS.html#%24sel%3A_end%3ACodePointRange"><span class="hs-identifier hs-var hs-var">_end</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-type">CodePointPosition</span></a></span><span>
</span><span id="line-391"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The range's end position.</span></span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679187241"><span id="local-6989586621679187246"><span id="local-6989586621679187250"><span class="annot"><span class="annottext">Int -&gt; CodePointRange -&gt; ShowS
[CodePointRange] -&gt; ShowS
CodePointRange -&gt; [Char]
(Int -&gt; CodePointRange -&gt; ShowS)
-&gt; (CodePointRange -&gt; [Char])
-&gt; ([CodePointRange] -&gt; ShowS)
-&gt; Show CodePointRange
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; CodePointRange -&gt; ShowS
showsPrec :: Int -&gt; CodePointRange -&gt; ShowS
$cshow :: CodePointRange -&gt; [Char]
show :: CodePointRange -&gt; [Char]
$cshowList :: [CodePointRange] -&gt; ShowS
showList :: [CodePointRange] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679187253"><span id="local-6989586621679187257"><span id="local-6989586621679187260"><span id="local-6989586621679187271"><span class="annot"><span class="annottext">ReadPrec [CodePointRange]
ReadPrec CodePointRange
Int -&gt; ReadS CodePointRange
ReadS [CodePointRange]
(Int -&gt; ReadS CodePointRange)
-&gt; ReadS [CodePointRange]
-&gt; ReadPrec CodePointRange
-&gt; ReadPrec [CodePointRange]
-&gt; Read CodePointRange
forall a.
(Int -&gt; ReadS a)
-&gt; ReadS [a] -&gt; ReadPrec a -&gt; ReadPrec [a] -&gt; Read a
$creadsPrec :: Int -&gt; ReadS CodePointRange
readsPrec :: Int -&gt; ReadS CodePointRange
$creadList :: ReadS [CodePointRange]
readList :: ReadS [CodePointRange]
$creadPrec :: ReadPrec CodePointRange
readPrec :: ReadPrec CodePointRange
$creadListPrec :: ReadPrec [CodePointRange]
readListPrec :: ReadPrec [CodePointRange]
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Read</span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679187274"><span id="local-6989586621679187278"><span class="annot"><span class="annottext">CodePointRange -&gt; CodePointRange -&gt; Bool
(CodePointRange -&gt; CodePointRange -&gt; Bool)
-&gt; (CodePointRange -&gt; CodePointRange -&gt; Bool) -&gt; Eq CodePointRange
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: CodePointRange -&gt; CodePointRange -&gt; Bool
== :: CodePointRange -&gt; CodePointRange -&gt; Bool
$c/= :: CodePointRange -&gt; CodePointRange -&gt; Bool
/= :: CodePointRange -&gt; CodePointRange -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679187284"><span id="local-6989586621679187288"><span id="local-6989586621679187292"><span id="local-6989586621679187296"><span id="local-6989586621679187299"><span id="local-6989586621679187302"><span id="local-6989586621679187305"><span class="annot"><span class="annottext">Eq CodePointRange
Eq CodePointRange =&gt;
(CodePointRange -&gt; CodePointRange -&gt; Ordering)
-&gt; (CodePointRange -&gt; CodePointRange -&gt; Bool)
-&gt; (CodePointRange -&gt; CodePointRange -&gt; Bool)
-&gt; (CodePointRange -&gt; CodePointRange -&gt; Bool)
-&gt; (CodePointRange -&gt; CodePointRange -&gt; Bool)
-&gt; (CodePointRange -&gt; CodePointRange -&gt; CodePointRange)
-&gt; (CodePointRange -&gt; CodePointRange -&gt; CodePointRange)
-&gt; Ord CodePointRange
CodePointRange -&gt; CodePointRange -&gt; Bool
CodePointRange -&gt; CodePointRange -&gt; Ordering
CodePointRange -&gt; CodePointRange -&gt; CodePointRange
forall a.
Eq a =&gt;
(a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
$ccompare :: CodePointRange -&gt; CodePointRange -&gt; Ordering
compare :: CodePointRange -&gt; CodePointRange -&gt; Ordering
$c&lt; :: CodePointRange -&gt; CodePointRange -&gt; Bool
&lt; :: CodePointRange -&gt; CodePointRange -&gt; Bool
$c&lt;= :: CodePointRange -&gt; CodePointRange -&gt; Bool
&lt;= :: CodePointRange -&gt; CodePointRange -&gt; Bool
$c&gt; :: CodePointRange -&gt; CodePointRange -&gt; Bool
&gt; :: CodePointRange -&gt; CodePointRange -&gt; Bool
$c&gt;= :: CodePointRange -&gt; CodePointRange -&gt; Bool
&gt;= :: CodePointRange -&gt; CodePointRange -&gt; Bool
$cmax :: CodePointRange -&gt; CodePointRange -&gt; CodePointRange
max :: CodePointRange -&gt; CodePointRange -&gt; CodePointRange
$cmin :: CodePointRange -&gt; CodePointRange -&gt; CodePointRange
min :: CodePointRange -&gt; CodePointRange -&gt; CodePointRange
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span id="HasLine"><span id="HasCharacter"><span id="local-6989586621679186334"><span id="local-6989586621679186335"><span id="local-6989586621679186336"><span id="local-6989586621679186337"><span id="line"><span id="character"><span id="local-6989586621679187308"><span id="local-6989586621679187312"><span class="hs-identifier">makeFieldsNoPrefix</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">CodePointPosition</span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-396"></span><span id="HasStart"><span id="HasEnd"><span id="local-6989586621679186342"><span id="local-6989586621679186343"><span id="local-6989586621679186344"><span id="local-6989586621679186345"><span id="start"><span id="end"><span id="local-6989586621679187328"><span id="local-6989586621679187332"><span class="hs-identifier">makeFieldsNoPrefix</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">CodePointRange</span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span class="hs-comment">{- Note [Converting between code points and code units]
This is inherently a somewhat expensive operation, but we take some care to minimize the cost.
In particular, we use the good asymptotics of 'Rope' to our advantage:
- We extract the single line that we are interested in in time logarithmic in the number of lines.
- We then split the line at the given position, and check how long the prefix is, which takes
linear time in the length of the (single) line.

We also may need to convert the line back and forth between ropes with different indexing. Again
this is linear time in the length of the line.

So the overall process is logarithmic in the number of lines, and linear in the length of the specific
line. Which is okay-ish, so long as we don't have very long lines.
-}</span><span>
</span><span id="line-411"></span><span>
</span><span id="line-412"></span><span class="annot"><span class="hs-comment">{- | Extracts a specific line from a 'Rope.Rope'.
 Logarithmic in the number of lines.
-}</span></span><span>
</span><span id="line-415"></span><span class="annot"><a href="Language.LSP.VFS.html#extractLine"><span class="hs-identifier hs-type">extractLine</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope.Rope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope.Rope</span></span><span>
</span><span id="line-416"></span><span id="extractLine"><span class="annot"><span class="annottext">extractLine :: Rope -&gt; Word -&gt; Maybe Rope
</span><a href="Language.LSP.VFS.html#extractLine"><span class="hs-identifier hs-var hs-var">extractLine</span></a></span></span><span> </span><span id="local-6989586621679187348"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187348"><span class="hs-identifier hs-var">rope</span></a></span></span><span> </span><span id="local-6989586621679187349"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187349"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-417"></span><span>  </span><span class="hs-comment">-- Check for the line being out of bounds</span><span>
</span><span id="line-418"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187350"><span class="annot"><span class="annottext">lastLine :: Word
</span><a href="#local-6989586621679187350"><span class="hs-identifier hs-var hs-var">lastLine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Position -&gt; Word
</span><span class="hs-identifier hs-var">Rope.posLine</span></span><span> </span><span class="annot"><span class="annottext">(Position -&gt; Word) -&gt; Position -&gt; Word
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Position
</span><span class="hs-identifier hs-var">Rope.lengthAsPosition</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187348"><span class="hs-identifier hs-var">rope</span></a></span><span>
</span><span id="line-419"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187349"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187350"><span class="hs-identifier hs-var">lastLine</span></a></span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679187354"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187354"><span class="hs-identifier hs-var">suffix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtLine</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187349"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187348"><span class="hs-identifier hs-var">rope</span></a></span><span>
</span><span id="line-422"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679187356"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187356"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtLine</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187354"><span class="hs-identifier hs-var">suffix</span></a></span><span>
</span><span id="line-423"></span><span>  </span><span class="annot"><span class="annottext">Rope -&gt; Maybe Rope
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187356"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span class="annot"><span class="hs-comment">{- | Translate a code-point offset into a code-unit offset.
 Linear in the length of the rope.
-}</span></span><span>
</span><span id="line-428"></span><span class="annot"><a href="Language.LSP.VFS.html#codePointOffsetToCodeUnitOffset"><span class="hs-identifier hs-type">codePointOffsetToCodeUnitOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">URope.Rope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span>
</span><span id="line-429"></span><span id="codePointOffsetToCodeUnitOffset"><span class="annot"><span class="annottext">codePointOffsetToCodeUnitOffset :: Rope -&gt; Word -&gt; Maybe Word
</span><a href="Language.LSP.VFS.html#codePointOffsetToCodeUnitOffset"><span class="hs-identifier hs-var hs-var">codePointOffsetToCodeUnitOffset</span></a></span></span><span> </span><span id="local-6989586621679187358"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187358"><span class="hs-identifier hs-var">rope</span></a></span></span><span> </span><span id="local-6989586621679187359"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187359"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-comment">-- Check for the position being out of bounds</span><span>
</span><span id="line-431"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187359"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word
</span><span class="hs-identifier hs-var">URope.length</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187358"><span class="hs-identifier hs-var">rope</span></a></span><span>
</span><span id="line-432"></span><span>  </span><span class="hs-comment">-- Split at the given position in *code points*</span><span>
</span><span id="line-433"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679187361"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187361"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">URope.splitAt</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187359"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187358"><span class="hs-identifier hs-var">rope</span></a></span><span>
</span><span id="line-434"></span><span>      </span><span class="hs-comment">-- Convert the prefix to a rope using *code units*</span><span>
</span><span id="line-435"></span><span>      </span><span id="local-6989586621679187363"><span class="annot"><span class="annottext">utf16Prefix :: Rope
</span><a href="#local-6989586621679187363"><span class="hs-identifier hs-var hs-var">utf16Prefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Rope
</span><span class="hs-identifier hs-var">Rope.fromText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Rope) -&gt; Text -&gt; Rope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">URope.toText</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187361"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-comment">-- Get the length of the prefix in *code units*</span><span>
</span><span id="line-437"></span><span>  </span><span class="annot"><span class="annottext">Word -&gt; Maybe Word
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Word -&gt; Maybe Word) -&gt; Word -&gt; Maybe Word
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word
</span><span class="hs-identifier hs-var">Rope.length</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187363"><span class="hs-identifier hs-var">utf16Prefix</span></a></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span class="annot"><span class="hs-comment">{- | Translate a UTF-16 code-unit offset into a code-point offset.
 Linear in the length of the rope.
-}</span></span><span>
</span><span id="line-442"></span><span class="annot"><a href="Language.LSP.VFS.html#codeUnitOffsetToCodePointOffset"><span class="hs-identifier hs-type">codeUnitOffsetToCodePointOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rope.Rope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span>
</span><span id="line-443"></span><span id="codeUnitOffsetToCodePointOffset"><span class="annot"><span class="annottext">codeUnitOffsetToCodePointOffset :: Rope -&gt; Word -&gt; Maybe Word
</span><a href="Language.LSP.VFS.html#codeUnitOffsetToCodePointOffset"><span class="hs-identifier hs-var hs-var">codeUnitOffsetToCodePointOffset</span></a></span></span><span> </span><span id="local-6989586621679187367"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187367"><span class="hs-identifier hs-var">rope</span></a></span></span><span> </span><span id="local-6989586621679187368"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187368"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-444"></span><span>  </span><span class="hs-comment">-- Check for the position being out of bounds</span><span>
</span><span id="line-445"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187368"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Word -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word
</span><span class="hs-identifier hs-var">Rope.length</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187367"><span class="hs-identifier hs-var">rope</span></a></span><span>
</span><span id="line-446"></span><span>  </span><span class="hs-comment">-- Split at the given position in *code units*</span><span>
</span><span id="line-447"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679187369"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187369"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; Maybe (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAt</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187368"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187367"><span class="hs-identifier hs-var">rope</span></a></span><span>
</span><span id="line-448"></span><span>  </span><span class="hs-comment">-- Convert the prefix to a rope using *code points*</span><span>
</span><span id="line-449"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187371"><span class="annot"><span class="annottext">utfPrefix :: Rope
</span><a href="#local-6989586621679187371"><span class="hs-identifier hs-var hs-var">utfPrefix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Rope
</span><span class="hs-identifier hs-var">URope.fromText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Rope) -&gt; Text -&gt; Rope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187369"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-comment">-- Get the length of the prefix in *code points*</span><span>
</span><span id="line-451"></span><span>  </span><span class="annot"><span class="annottext">Word -&gt; Maybe Word
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Word -&gt; Maybe Word) -&gt; Word -&gt; Maybe Word
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word
</span><span class="hs-identifier hs-var">URope.length</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187371"><span class="hs-identifier hs-var">utfPrefix</span></a></span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span class="annot"><span class="hs-comment">{- | Given a virtual file, translate a 'CodePointPosition' in that file into a 'J.Position' in that file.

 Will return 'Nothing' if the requested position is out of bounds of the document.

 Logarithmic in the number of lines in the document, and linear in the length of the line containing
 the position.
-}</span></span><span>
</span><span id="line-460"></span><span class="annot"><a href="Language.LSP.VFS.html#codePointPositionToPosition"><span class="hs-identifier hs-type">codePointPositionToPosition</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-type">CodePointPosition</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span>
</span><span id="line-461"></span><span id="codePointPositionToPosition"><span class="annot"><span class="annottext">codePointPositionToPosition :: VirtualFile -&gt; CodePointPosition -&gt; Maybe Position
</span><a href="Language.LSP.VFS.html#codePointPositionToPosition"><span class="hs-identifier hs-var hs-var">codePointPositionToPosition</span></a></span></span><span> </span><span id="local-6989586621679187373"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187373"><span class="hs-identifier hs-var">vFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-type">CodePointPosition</span></a></span><span> </span><span id="local-6989586621679187374"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187374"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679187375"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187375"><span class="hs-identifier hs-var">cpc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-462"></span><span>  </span><span class="hs-comment">-- See Note [Converting between code points and code units]</span><span>
</span><span id="line-463"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187376"><span class="annot"><span class="annottext">text :: Rope
</span><a href="#local-6989586621679187376"><span class="hs-identifier hs-var hs-var">text</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Rope
</span><a href="Language.LSP.VFS.html#%24sel%3A_file_text%3AVirtualFile"><span class="hs-identifier hs-var">_file_text</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187373"><span class="hs-identifier hs-var">vFile</span></a></span><span>
</span><span id="line-464"></span><span>  </span><span id="local-6989586621679187377"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187377"><span class="hs-identifier hs-var">utf16Line</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word -&gt; Maybe Rope
</span><a href="Language.LSP.VFS.html#extractLine"><span class="hs-identifier hs-var">extractLine</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187376"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187374"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>  </span><span class="hs-comment">-- Convert the line a rope using *code points*</span><span>
</span><span id="line-466"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187378"><span class="annot"><span class="annottext">utfLine :: Rope
</span><a href="#local-6989586621679187378"><span class="hs-identifier hs-var hs-var">utfLine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Rope
</span><span class="hs-identifier hs-var">URope.fromText</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Rope) -&gt; Text -&gt; Rope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187377"><span class="hs-identifier hs-var">utf16Line</span></a></span><span>
</span><span id="line-467"></span><span>
</span><span id="line-468"></span><span>  </span><span id="local-6989586621679187379"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187379"><span class="hs-identifier hs-var">cuc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word -&gt; Maybe Word
</span><a href="Language.LSP.VFS.html#codePointOffsetToCodeUnitOffset"><span class="hs-identifier hs-var">codePointOffsetToCodeUnitOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187378"><span class="hs-identifier hs-var">utfLine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187375"><span class="hs-identifier hs-var">cpc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>  </span><span class="annot"><span class="annottext">Position -&gt; Maybe Position
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Position -&gt; Maybe Position) -&gt; Position -&gt; Maybe Position
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; Position
</span><span class="hs-identifier hs-var">J.Position</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187374"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; UInt
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187379"><span class="hs-identifier hs-var">cuc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span class="annot"><span class="hs-comment">{- | Given a virtual file, translate a 'CodePointRange' in that file into a 'J.Range' in that file.

 Will return 'Nothing' if any of the positions are out of bounds of the document.

 Logarithmic in the number of lines in the document, and linear in the length of the lines containing
 the positions.
-}</span></span><span>
</span><span id="line-478"></span><span class="annot"><a href="Language.LSP.VFS.html#codePointRangeToRange"><span class="hs-identifier hs-type">codePointRangeToRange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier hs-type">CodePointRange</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span>
</span><span id="line-479"></span><span id="codePointRangeToRange"><span class="annot"><span class="annottext">codePointRangeToRange :: VirtualFile -&gt; CodePointRange -&gt; Maybe Range
</span><a href="Language.LSP.VFS.html#codePointRangeToRange"><span class="hs-identifier hs-var hs-var">codePointRangeToRange</span></a></span></span><span> </span><span id="local-6989586621679187380"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187380"><span class="hs-identifier hs-var">vFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier hs-type">CodePointRange</span></a></span><span> </span><span id="local-6989586621679187381"><span class="annot"><span class="annottext">CodePointPosition
</span><a href="#local-6989586621679187381"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679187382"><span class="annot"><span class="annottext">CodePointPosition
</span><a href="#local-6989586621679187382"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-480"></span><span>  </span><span class="annot"><span class="annottext">Position -&gt; Position -&gt; Range
</span><span class="hs-identifier hs-var">J.Range</span></span><span> </span><span class="annot"><span class="annottext">(Position -&gt; Position -&gt; Range)
-&gt; Maybe Position -&gt; Maybe (Position -&gt; Range)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; CodePointPosition -&gt; Maybe Position
</span><a href="Language.LSP.VFS.html#codePointPositionToPosition"><span class="hs-identifier hs-var">codePointPositionToPosition</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187380"><span class="hs-identifier hs-var">vFile</span></a></span><span> </span><span class="annot"><span class="annottext">CodePointPosition
</span><a href="#local-6989586621679187381"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Position -&gt; Range) -&gt; Maybe Position -&gt; Maybe Range
forall a b. Maybe (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; CodePointPosition -&gt; Maybe Position
</span><a href="Language.LSP.VFS.html#codePointPositionToPosition"><span class="hs-identifier hs-var">codePointPositionToPosition</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187380"><span class="hs-identifier hs-var">vFile</span></a></span><span> </span><span class="annot"><span class="annottext">CodePointPosition
</span><a href="#local-6989586621679187382"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-481"></span><span>
</span><span id="line-482"></span><span class="annot"><span class="hs-comment">{- | Given a virtual file, translate a 'J.Position' in that file into a 'CodePointPosition' in that file.

 Will return 'Nothing' if the requested position lies inside a code point, or if it is out of bounds of the document.

 Logarithmic in the number of lines in the document, and linear in the length of the line containing
 the position.
-}</span></span><span>
</span><span id="line-489"></span><span class="annot"><a href="Language.LSP.VFS.html#positionToCodePointPosition"><span class="hs-identifier hs-type">positionToCodePointPosition</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-type">CodePointPosition</span></a></span><span>
</span><span id="line-490"></span><span id="positionToCodePointPosition"><span class="annot"><span class="annottext">positionToCodePointPosition :: VirtualFile -&gt; Position -&gt; Maybe CodePointPosition
</span><a href="Language.LSP.VFS.html#positionToCodePointPosition"><span class="hs-identifier hs-var hs-var">positionToCodePointPosition</span></a></span></span><span> </span><span id="local-6989586621679187384"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187384"><span class="hs-identifier hs-var">vFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span id="local-6989586621679187385"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187385"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679187386"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187386"><span class="hs-identifier hs-var">cuc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-491"></span><span>  </span><span class="hs-comment">-- See Note [Converting between code points and code units]</span><span>
</span><span id="line-492"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187387"><span class="annot"><span class="annottext">text :: Rope
</span><a href="#local-6989586621679187387"><span class="hs-identifier hs-var hs-var">text</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Rope
</span><a href="Language.LSP.VFS.html#%24sel%3A_file_text%3AVirtualFile"><span class="hs-identifier hs-var">_file_text</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187384"><span class="hs-identifier hs-var">vFile</span></a></span><span>
</span><span id="line-493"></span><span>  </span><span id="local-6989586621679187388"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187388"><span class="hs-identifier hs-var">utf16Line</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word -&gt; Maybe Rope
</span><a href="Language.LSP.VFS.html#extractLine"><span class="hs-identifier hs-var">extractLine</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187387"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187385"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span>  </span><span id="local-6989586621679187389"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187389"><span class="hs-identifier hs-var">cpc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Word -&gt; Maybe Word
</span><a href="Language.LSP.VFS.html#codeUnitOffsetToCodePointOffset"><span class="hs-identifier hs-var">codeUnitOffsetToCodePointOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187388"><span class="hs-identifier hs-var">utf16Line</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187386"><span class="hs-identifier hs-var">cuc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-496"></span><span>  </span><span class="annot"><span class="annottext">CodePointPosition -&gt; Maybe CodePointPosition
forall a. a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(CodePointPosition -&gt; Maybe CodePointPosition)
-&gt; CodePointPosition -&gt; Maybe CodePointPosition
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; CodePointPosition
</span><a href="Language.LSP.VFS.html#CodePointPosition"><span class="hs-identifier hs-var">CodePointPosition</span></a></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187385"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; UInt
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679187389"><span class="hs-identifier hs-var">cpc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>
</span><span id="line-498"></span><span class="annot"><span class="hs-comment">{- | Given a virtual file, translate a 'J.Range' in that file into a 'CodePointRange' in that file.

 Will return 'Nothing' if any of the positions are out of bounds of the document.

 Logarithmic in the number of lines in the document, and linear in the length of the lines containing
 the positions.
-}</span></span><span>
</span><span id="line-505"></span><span class="annot"><a href="Language.LSP.VFS.html#rangeToCodePointRange"><span class="hs-identifier hs-type">rangeToCodePointRange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier hs-type">CodePointRange</span></a></span><span>
</span><span id="line-506"></span><span id="rangeToCodePointRange"><span class="annot"><span class="annottext">rangeToCodePointRange :: VirtualFile -&gt; Range -&gt; Maybe CodePointRange
</span><a href="Language.LSP.VFS.html#rangeToCodePointRange"><span class="hs-identifier hs-var hs-var">rangeToCodePointRange</span></a></span></span><span> </span><span id="local-6989586621679187390"><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187390"><span class="hs-identifier hs-var">vFile</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span> </span><span id="local-6989586621679187391"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679187391"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621679187392"><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679187392"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-507"></span><span>  </span><span class="annot"><span class="annottext">CodePointPosition -&gt; CodePointPosition -&gt; CodePointRange
</span><a href="Language.LSP.VFS.html#CodePointRange"><span class="hs-identifier hs-var">CodePointRange</span></a></span><span> </span><span class="annot"><span class="annottext">(CodePointPosition -&gt; CodePointPosition -&gt; CodePointRange)
-&gt; Maybe CodePointPosition
-&gt; Maybe (CodePointPosition -&gt; CodePointRange)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Position -&gt; Maybe CodePointPosition
</span><a href="Language.LSP.VFS.html#positionToCodePointPosition"><span class="hs-identifier hs-var">positionToCodePointPosition</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187390"><span class="hs-identifier hs-var">vFile</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679187391"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (CodePointPosition -&gt; CodePointRange)
-&gt; Maybe CodePointPosition -&gt; Maybe CodePointRange
forall a b. Maybe (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">VirtualFile -&gt; Position -&gt; Maybe CodePointPosition
</span><a href="Language.LSP.VFS.html#positionToCodePointPosition"><span class="hs-identifier hs-var">positionToCodePointPosition</span></a></span><span> </span><span class="annot"><span class="annottext">VirtualFile
</span><a href="#local-6989586621679187390"><span class="hs-identifier hs-var">vFile</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679187392"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-508"></span><span>
</span><span id="line-509"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-510"></span><span>
</span><span id="line-511"></span><span class="hs-comment">-- TODO:AZ:move this to somewhere sane</span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span class="annot"><span class="hs-comment">-- | Describes the line at the current cursor position</span></span><span>
</span><span id="line-514"></span><span class="hs-keyword">data</span><span> </span><span id="PosPrefixInfo"><span class="annot"><a href="Language.LSP.VFS.html#PosPrefixInfo"><span class="hs-identifier hs-var">PosPrefixInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="PosPrefixInfo"><span class="annot"><a href="Language.LSP.VFS.html#PosPrefixInfo"><span class="hs-identifier hs-var">PosPrefixInfo</span></a></span></span><span>
</span><span id="line-515"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AfullLine%3APosPrefixInfo"><span class="annot"><span class="annottext">PosPrefixInfo -&gt; Text
</span><a href="Language.LSP.VFS.html#%24sel%3AfullLine%3APosPrefixInfo"><span class="hs-identifier hs-var hs-var">fullLine</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-516"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The full contents of the line the cursor is at</span></span><span>
</span><span id="line-517"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AprefixModule%3APosPrefixInfo"><span class="annot"><span class="annottext">PosPrefixInfo -&gt; Text
</span><a href="Language.LSP.VFS.html#%24sel%3AprefixModule%3APosPrefixInfo"><span class="hs-identifier hs-var hs-var">prefixModule</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-518"></span><span>  </span><span class="hs-comment">-- ^ If any, the module name that was typed right before the cursor position.</span><span>
</span><span id="line-519"></span><span>  </span><span class="hs-comment">--  For example, if the user has typed &quot;Data.Maybe.from&quot;, then this property</span><span>
</span><span id="line-520"></span><span>  </span><span class="hs-comment">--  will be &quot;Data.Maybe&quot;</span><span>
</span><span id="line-521"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AprefixText%3APosPrefixInfo"><span class="annot"><span class="annottext">PosPrefixInfo -&gt; Text
</span><a href="Language.LSP.VFS.html#%24sel%3AprefixText%3APosPrefixInfo"><span class="hs-identifier hs-var hs-var">prefixText</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-522"></span><span>  </span><span class="hs-comment">-- ^ The word right before the cursor position, after removing the module part.</span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-comment">-- For example if the user has typed &quot;Data.Maybe.from&quot;,</span><span>
</span><span id="line-524"></span><span>  </span><span class="hs-comment">-- then this property will be &quot;from&quot;</span><span>
</span><span id="line-525"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3AcursorPos%3APosPrefixInfo"><span class="annot"><span class="annottext">PosPrefixInfo -&gt; Position
</span><a href="Language.LSP.VFS.html#%24sel%3AcursorPos%3APosPrefixInfo"><span class="hs-identifier hs-var hs-var">cursorPos</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span>
</span><span id="line-526"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ The cursor position</span></span><span>
</span><span id="line-527"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-528"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679187399"><span id="local-6989586621679187408"><span id="local-6989586621679187412"><span class="annot"><span class="annottext">Int -&gt; PosPrefixInfo -&gt; ShowS
[PosPrefixInfo] -&gt; ShowS
PosPrefixInfo -&gt; [Char]
(Int -&gt; PosPrefixInfo -&gt; ShowS)
-&gt; (PosPrefixInfo -&gt; [Char])
-&gt; ([PosPrefixInfo] -&gt; ShowS)
-&gt; Show PosPrefixInfo
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; PosPrefixInfo -&gt; ShowS
showsPrec :: Int -&gt; PosPrefixInfo -&gt; ShowS
$cshow :: PosPrefixInfo -&gt; [Char]
show :: PosPrefixInfo -&gt; [Char]
$cshowList :: [PosPrefixInfo] -&gt; ShowS
showList :: [PosPrefixInfo] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679187415"><span id="local-6989586621679187423"><span class="annot"><span class="annottext">PosPrefixInfo -&gt; PosPrefixInfo -&gt; Bool
(PosPrefixInfo -&gt; PosPrefixInfo -&gt; Bool)
-&gt; (PosPrefixInfo -&gt; PosPrefixInfo -&gt; Bool) -&gt; Eq PosPrefixInfo
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: PosPrefixInfo -&gt; PosPrefixInfo -&gt; Bool
== :: PosPrefixInfo -&gt; PosPrefixInfo -&gt; Bool
$c/= :: PosPrefixInfo -&gt; PosPrefixInfo -&gt; Bool
/= :: PosPrefixInfo -&gt; PosPrefixInfo -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>
</span><span id="line-530"></span><span id="local-6989586621679186356"><span class="annot"><a href="Language.LSP.VFS.html#getCompletionPrefix"><span class="hs-identifier hs-type">getCompletionPrefix</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679186356"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679186356"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#PosPrefixInfo"><span class="hs-identifier hs-type">PosPrefixInfo</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-531"></span><span id="getCompletionPrefix"><span class="annot"><span class="annottext">getCompletionPrefix :: forall (m :: * -&gt; *).
Monad m =&gt;
Position -&gt; VirtualFile -&gt; m (Maybe PosPrefixInfo)
</span><a href="Language.LSP.VFS.html#getCompletionPrefix"><span class="hs-identifier hs-var hs-var">getCompletionPrefix</span></a></span></span><span> </span><span id="local-6989586621679187443"><span class="annot"><span class="annottext">pos :: Position
</span><a href="#local-6989586621679187443"><span class="hs-identifier hs-var">pos</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span id="local-6989586621679187444"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187444"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621679187445"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187445"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679187446"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187446"><span class="hs-identifier hs-var">ropetext</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-532"></span><span>  </span><span class="annot"><span class="annottext">Maybe PosPrefixInfo -&gt; m (Maybe PosPrefixInfo)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe PosPrefixInfo -&gt; m (Maybe PosPrefixInfo))
-&gt; Maybe PosPrefixInfo -&gt; m (Maybe PosPrefixInfo)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PosPrefixInfo -&gt; Maybe PosPrefixInfo
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(PosPrefixInfo -&gt; Maybe PosPrefixInfo)
-&gt; PosPrefixInfo -&gt; Maybe PosPrefixInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PosPrefixInfo -&gt; Maybe PosPrefixInfo -&gt; PosPrefixInfo
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text -&gt; Position -&gt; PosPrefixInfo
</span><a href="Language.LSP.VFS.html#PosPrefixInfo"><span class="hs-identifier hs-var">PosPrefixInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679187443"><span class="hs-identifier hs-var">pos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe PosPrefixInfo -&gt; PosPrefixInfo)
-&gt; Maybe PosPrefixInfo -&gt; PosPrefixInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-533"></span><span>    </span><span class="hs-comment">-- Maybe monad</span><span>
</span><span id="line-534"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187450"><span class="annot"><span class="annottext">lastMaybe :: [a] -&gt; Maybe a
</span><a href="#local-6989586621679187450"><span class="hs-identifier hs-var hs-var">lastMaybe</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-535"></span><span>        </span><span class="annot"><a href="#local-6989586621679187450"><span class="hs-identifier hs-var">lastMaybe</span></a></span><span> </span><span id="local-6989586621679187451"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679187451"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Maybe a) -&gt; a -&gt; Maybe a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; a
forall a. HasCallStack =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679187451"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187455"><span class="annot"><span class="annottext">curRope :: Rope
</span><a href="#local-6989586621679187455"><span class="hs-identifier hs-var hs-var">curRope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Rope, Rope) -&gt; Rope
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Rope, Rope) -&gt; Rope) -&gt; (Rope, Rope) -&gt; Rope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtLine</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">(Rope -&gt; (Rope, Rope)) -&gt; Rope -&gt; (Rope, Rope)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Rope, Rope) -&gt; Rope
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((Rope, Rope) -&gt; Rope) -&gt; (Rope, Rope) -&gt; Rope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtLine</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187444"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187446"><span class="hs-identifier hs-var">ropetext</span></a></span><span>
</span><span id="line-538"></span><span>    </span><span id="local-6989586621679187458"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187458"><span class="hs-identifier hs-var">beforePos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="annot"><span class="annottext">(Rope -&gt; Text) -&gt; ((Rope, Rope) -&gt; Rope) -&gt; (Rope, Rope) -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Rope, Rope) -&gt; Rope
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Rope, Rope) -&gt; Text) -&gt; Maybe (Rope, Rope) -&gt; Maybe Text
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; Maybe (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187445"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187455"><span class="hs-identifier hs-var">curRope</span></a></span><span>
</span><span id="line-539"></span><span>    </span><span id="local-6989586621679187459"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187459"><span class="hs-identifier hs-var">curWord</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-540"></span><span>      </span><span class="hs-keyword">if</span><span>
</span><span id="line-541"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><span class="hs-identifier hs-var">T.null</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187458"><span class="hs-identifier hs-var">beforePos</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-542"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Text -&gt; Char
Text -&gt; Char
</span><span class="hs-identifier hs-var">T.last</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187458"><span class="hs-identifier hs-var">beforePos</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">' '</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-comment">-- don't count abc as the curword in 'abc '</span><span>
</span><span id="line-543"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Maybe Text
forall {a}. [a] -&gt; Maybe a
</span><a href="#local-6989586621679187450"><span class="hs-identifier hs-var">lastMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; [Text]
</span><span class="hs-identifier hs-var">T.words</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187458"><span class="hs-identifier hs-var">beforePos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>
</span><span id="line-545"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187466"><span class="annot"><span class="annottext">parts :: [Text]
</span><a href="#local-6989586621679187466"><span class="hs-identifier hs-var hs-var">parts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-546"></span><span>          </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; Text -&gt; [Text]
</span><span class="hs-identifier hs-var">T.split</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'.'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; [Text]) -&gt; Text -&gt; [Text]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-547"></span><span>            </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; Text -&gt; Text
</span><span class="hs-identifier hs-var">T.takeWhileEnd</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679187469"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679187469"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><span class="hs-identifier hs-var">isAlphaNum</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679187469"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621679187469"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; [Char] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;._'&quot;</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187459"><span class="hs-identifier hs-var">curWord</span></a></span><span>
</span><span id="line-548"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; [Text]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679187466"><span class="hs-identifier hs-var">parts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-549"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe PosPrefixInfo
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-550"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679187473"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187473"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679187474"><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679187474"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-551"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187477"><span class="annot"><span class="annottext">modParts :: [Text]
</span><a href="#local-6989586621679187477"><span class="hs-identifier hs-var hs-var">modParts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-552"></span><span>              </span><span class="annot"><span class="annottext">(Text -&gt; Bool) -&gt; [Text] -&gt; [Text]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">dropWhile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Text -&gt; Bool) -&gt; Text -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><span class="hs-identifier hs-var">isUpper</span></span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; (Text -&gt; Char) -&gt; Text -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Text -&gt; Char
Text -&gt; Char
</span><span class="hs-identifier hs-var">T.head</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; [Text]) -&gt; [Text] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-553"></span><span>                </span><span class="annot"><span class="annottext">[Text] -&gt; [Text]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([Text] -&gt; [Text]) -&gt; [Text] -&gt; [Text]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-554"></span><span>                  </span><span class="annot"><span class="annottext">(Text -&gt; Bool) -&gt; [Text] -&gt; [Text]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Text -&gt; Bool) -&gt; Text -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><span class="hs-identifier hs-var">T.null</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679187474"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-555"></span><span>            </span><span id="local-6989586621679187482"><span class="annot"><span class="annottext">modName :: Text
</span><a href="#local-6989586621679187482"><span class="hs-identifier hs-var hs-var">modName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; [Text] -&gt; Text
</span><span class="hs-identifier hs-var">T.intercalate</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;.&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Text]
</span><a href="#local-6989586621679187477"><span class="hs-identifier hs-var">modParts</span></a></span><span>
</span><span id="line-556"></span><span>        </span><span class="hs-comment">-- curRope is already a single line, but it may include an enclosing '\n'</span><span>
</span><span id="line-557"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679187485"><span class="annot"><span class="annottext">curLine :: Text
</span><a href="#local-6989586621679187485"><span class="hs-identifier hs-var hs-var">curLine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; Text -&gt; Text
</span><span class="hs-identifier hs-var">T.dropWhileEnd</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\n'</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; Text -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187455"><span class="hs-identifier hs-var">curRope</span></a></span><span>
</span><span id="line-558"></span><span>        </span><span class="annot"><span class="annottext">PosPrefixInfo -&gt; Maybe PosPrefixInfo
forall a. a -&gt; Maybe a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PosPrefixInfo -&gt; Maybe PosPrefixInfo)
-&gt; PosPrefixInfo -&gt; Maybe PosPrefixInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text -&gt; Position -&gt; PosPrefixInfo
</span><a href="Language.LSP.VFS.html#PosPrefixInfo"><span class="hs-identifier hs-var">PosPrefixInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187485"><span class="hs-identifier hs-var">curLine</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187482"><span class="hs-identifier hs-var">modName</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187473"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Position
</span><a href="#local-6989586621679187443"><span class="hs-identifier hs-var">pos</span></a></span><span>
</span><span id="line-559"></span><span>
</span><span id="line-560"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-561"></span><span>
</span><span id="line-562"></span><span class="annot"><a href="Language.LSP.VFS.html#rangeLinesFromVfs"><span class="hs-identifier hs-type">rangeLinesFromVfs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-563"></span><span id="rangeLinesFromVfs"><span class="annot"><span class="annottext">rangeLinesFromVfs :: VirtualFile -&gt; Range -&gt; Text
</span><a href="Language.LSP.VFS.html#rangeLinesFromVfs"><span class="hs-identifier hs-var hs-var">rangeLinesFromVfs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.LSP.VFS.html#VirtualFile"><span class="hs-identifier hs-type">VirtualFile</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679187487"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187487"><span class="hs-identifier hs-var">ropetext</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Range</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span id="local-6989586621679187488"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187488"><span class="hs-identifier hs-var">lf</span></a></span></span><span> </span><span id="local-6989586621679187489"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187489"><span class="hs-identifier hs-var">_cf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">J.Position</span></span><span> </span><span id="local-6989586621679187490"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187490"><span class="hs-identifier hs-var">lt</span></a></span></span><span> </span><span id="local-6989586621679187491"><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187491"><span class="hs-identifier hs-var">_ct</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679187492"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-564"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-565"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679187495"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187495"><span class="hs-identifier hs-var">s1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtLine</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187488"><span class="hs-identifier hs-var">lf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187487"><span class="hs-identifier hs-var">ropetext</span></a></span><span>
</span><span id="line-566"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679187499"><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187499"><span class="hs-identifier hs-var">s2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Rope
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word -&gt; Rope -&gt; (Rope, Rope)
</span><span class="hs-identifier hs-var">Rope.splitAtLine</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187490"><span class="hs-identifier hs-var">lt</span></a></span><span> </span><span class="annot"><span class="annottext">UInt -&gt; UInt -&gt; UInt
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">UInt
</span><a href="#local-6989586621679187488"><span class="hs-identifier hs-var">lf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187495"><span class="hs-identifier hs-var">s1</span></a></span><span>
</span><span id="line-567"></span><span>  </span><span id="local-6989586621679187492"><span class="annot"><span class="annottext">r :: Text
</span><a href="#local-6989586621679187492"><span class="hs-identifier hs-var hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rope -&gt; Text
</span><span class="hs-identifier hs-var">Rope.toText</span></span><span> </span><span class="annot"><span class="annottext">Rope
</span><a href="#local-6989586621679187499"><span class="hs-identifier hs-var">s2</span></a></span><span>
</span><span id="line-568"></span><span>
</span><span id="line-569"></span><span class="hs-comment">-- ---------------------------------------------------------------------</span><span>
</span><span id="line-570"></span></pre></body></html>