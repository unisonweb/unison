<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span id="local-6989586621679236710"><span id="local-6989586621679236711"></span></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">-- | One-time password implementation as defined by the</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- &lt;http://tools.ietf.org/html/rfc4226 HOTP&gt; and &lt;http://tools.ietf.org/html/rfc6238 TOTP&gt;</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- specifications.</span><span>
</span><span id="line-6"></span><span class="hs-comment">--</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Both implementations use a shared key between the client and the server. HOTP passwords</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- are based on a synchronized counter. TOTP passwords use the same approach but calculate</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- the counter as a number of time steps from the Unix epoch to the current time, thus</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- requiring that both client and server have synchronized clocks.</span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- Probably the best-known use of TOTP is in Google's 2-factor authentication.</span><span>
</span><span id="line-13"></span><span class="hs-comment">--</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- The TOTP API doesn't depend on any particular time package, so the user needs to supply</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- the current @OTPTime@ value, based on the system time. For example, using the @hourglass@</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- package, you could create a @getOTPTime@ function:</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-comment">-- &gt;&gt;&gt; import Time.System</span><span>
</span><span id="line-19"></span><span class="hs-comment">-- &gt;&gt;&gt; import Time.Types</span><span>
</span><span id="line-20"></span><span class="hs-comment">-- &gt;&gt;&gt;</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- &gt;&gt;&gt; let getOTPTime = timeCurrent &gt;&gt;= \(Elapsed t) -&gt; return (fromIntegral t :: OTPTime)</span><span>
</span><span id="line-22"></span><span class="hs-comment">--</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- Or if you prefer, the @time@ package could be used:</span><span>
</span><span id="line-24"></span><span class="hs-comment">--</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- &gt;&gt;&gt; import Data.Time.Clock.POSIX</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- &gt;&gt;&gt;</span><span>
</span><span id="line-27"></span><span class="hs-comment">-- &gt;&gt;&gt; let getOTPTime = getPOSIXTime &gt;&gt;= \t -&gt; return (floor t :: OTPTime)</span><span>
</span><span id="line-28"></span><span class="hs-comment">--</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Crypto.OTP</span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTP"><span class="hs-identifier">OTP</span></a></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTPDigits"><span class="hs-identifier">OTPDigits</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTPTime"><span class="hs-identifier">OTPTime</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.OTP.html#hotp"><span class="hs-identifier">hotp</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.OTP.html#resynchronize"><span class="hs-identifier">resynchronize</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.OTP.html#totp"><span class="hs-identifier">totp</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.OTP.html#totpVerify"><span class="hs-identifier">totpVerify</span></a></span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.OTP.html#TOTPParams"><span class="hs-identifier">TOTPParams</span></a></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.OTP.html#ClockSkew"><span class="hs-identifier">ClockSkew</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.OTP.html#defaultTOTPParams"><span class="hs-identifier">defaultTOTPParams</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.OTP.html#mkTOTPParams"><span class="hs-identifier">mkTOTPParams</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">where</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Bits</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">shiftL</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(.&amp;.)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(.|.)</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.ByteArray.Mapping</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromW64BE</span></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">elemIndex</span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unless</span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Crypto.Hash.html"><span class="hs-identifier">Crypto.Hash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.Hash.Types.html#HashAlgorithm"><span class="hs-identifier">HashAlgorithm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.Hash.SHA1.html#SHA1"><span class="hs-identifier">SHA1</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Crypto.MAC.HMAC.html"><span class="hs-identifier">Crypto.MAC.HMAC</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Crypto.Internal.ByteArray.html"><span class="hs-identifier">Crypto.Internal.ByteArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ByteArrayAccess</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Bytes</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Crypto.Internal.ByteArray.html"><span class="hs-identifier">Crypto.Internal.ByteArray</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B</span></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="annot"><span class="hs-comment">-- | A one-time password which is a sequence of 4 to 9 digits.</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">type</span><span> </span><span id="OTP"><span class="annot"><a href="Crypto.OTP.html#OTP"><span class="hs-identifier hs-var">OTP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-comment">-- | The strength of the calculated HOTP value, namely</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- the number of digits (between 4 and 9) in the extracted value.</span><span>
</span><span id="line-61"></span><span class="hs-keyword">data</span><span> </span><span id="OTPDigits"><span class="annot"><a href="Crypto.OTP.html#OTPDigits"><span class="hs-identifier hs-var">OTPDigits</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="OTP4"><span class="annot"><a href="Crypto.OTP.html#OTP4"><span class="hs-identifier hs-var">OTP4</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="OTP5"><span class="annot"><a href="Crypto.OTP.html#OTP5"><span class="hs-identifier hs-var">OTP5</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="OTP6"><span class="annot"><a href="Crypto.OTP.html#OTP6"><span class="hs-identifier hs-var">OTP6</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="OTP7"><span class="annot"><a href="Crypto.OTP.html#OTP7"><span class="hs-identifier hs-var">OTP7</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="OTP8"><span class="annot"><a href="Crypto.OTP.html#OTP8"><span class="hs-identifier hs-var">OTP8</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="OTP9"><span class="annot"><a href="Crypto.OTP.html#OTP9"><span class="hs-identifier hs-var">OTP9</span></a></span></span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679236750"><span id="local-6989586621679236752"><span id="local-6989586621679236756"><span class="annot"><span class="annottext">Int -&gt; OTPDigits -&gt; ShowS
[OTPDigits] -&gt; ShowS
OTPDigits -&gt; String
(Int -&gt; OTPDigits -&gt; ShowS)
-&gt; (OTPDigits -&gt; String)
-&gt; ([OTPDigits] -&gt; ShowS)
-&gt; Show OTPDigits
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; OTPDigits -&gt; ShowS
showsPrec :: Int -&gt; OTPDigits -&gt; ShowS
$cshow :: OTPDigits -&gt; String
show :: OTPDigits -&gt; String
$cshowList :: [OTPDigits] -&gt; ShowS
showList :: [OTPDigits] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="annot"><span class="hs-comment">-- | An integral time value in seconds.</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">type</span><span> </span><span id="OTPTime"><span class="annot"><a href="Crypto.OTP.html#OTPTime"><span class="hs-identifier hs-var">OTPTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="annot"><a href="Crypto.OTP.html#hotp"><span class="hs-identifier hs-type">hotp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679236649"><span class="annot"><a href="#local-6989586621679236649"><span class="hs-identifier hs-type">hash</span></a></span></span><span> </span><span id="local-6989586621679236651"><span class="annot"><a href="#local-6989586621679236651"><span class="hs-identifier hs-type">key</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.Hash.Types.html#HashAlgorithm"><span class="hs-identifier hs-type">HashAlgorithm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679236649"><span class="hs-identifier hs-type">hash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteArrayAccess</span></span><span> </span><span class="annot"><a href="#local-6989586621679236651"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679236649"><span class="hs-identifier hs-type">hash</span></a></span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTPDigits"><span class="hs-identifier hs-type">OTPDigits</span></a></span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Number of digits in the HOTP value extracted from the calculated HMAC</span></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679236651"><span class="hs-identifier hs-type">key</span></a></span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Shared secret between the client and server</span></span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Counter value synchronized between the client and server</span></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTP"><span class="hs-identifier hs-type">OTP</span></a></span><span>
</span><span id="line-75"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The HOTP value</span></span><span>
</span><span id="line-76"></span><span id="hotp"><span class="annot"><span class="annottext">hotp :: forall hash key.
(HashAlgorithm hash, ByteArrayAccess key) =&gt;
hash -&gt; OTPDigits -&gt; key -&gt; Word64 -&gt; Word32
</span><a href="Crypto.OTP.html#hotp"><span class="hs-identifier hs-var hs-var">hotp</span></a></span></span><span> </span><span class="annot"><span class="annottext">hash
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679236763"><span class="annot"><span class="annottext">OTPDigits
</span><a href="#local-6989586621679236763"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621679236764"><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679236764"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679236765"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236765"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679236766"><span class="hs-identifier hs-var">dt</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="annot"><span class="annottext">OTPDigits -&gt; Word32
</span><a href="Crypto.OTP.html#digitsPower"><span class="hs-identifier hs-var">digitsPower</span></a></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="#local-6989586621679236763"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-78"></span><span>    </span><span id="local-6989586621679236775"><span class="annot"><span class="annottext">mac :: HMAC hash
</span><a href="#local-6989586621679236775"><span class="hs-identifier hs-var hs-var">mac</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">key -&gt; Bytes -&gt; HMAC hash
forall key message a.
(ByteArrayAccess key, ByteArrayAccess message, HashAlgorithm a) =&gt;
key -&gt; message -&gt; HMAC a
</span><a href="Crypto.MAC.HMAC.html#hmac"><span class="hs-identifier hs-var">hmac</span></a></span><span> </span><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679236764"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Bytes
forall ba. ByteArray ba =&gt; Word64 -&gt; ba
</span><span class="hs-identifier hs-var">fromW64BE</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236765"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bytes</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Crypto.MAC.HMAC.html#HMAC"><span class="hs-identifier hs-type">HMAC</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679236649"><span class="hs-identifier hs-type">hash</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span id="local-6989586621679236790"><span class="annot"><span class="annottext">offset :: Int
</span><a href="#local-6989586621679236790"><span class="hs-identifier hs-var hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HMAC hash -&gt; Int -&gt; Word8
forall a. ByteArrayAccess a =&gt; a -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">B.index</span></span><span> </span><span class="annot"><span class="annottext">HMAC hash
</span><a href="#local-6989586621679236775"><span class="hs-identifier hs-var">mac</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HMAC hash -&gt; Int
forall ba. ByteArrayAccess ba =&gt; ba -&gt; Int
</span><span class="hs-identifier hs-var">B.length</span></span><span> </span><span class="annot"><span class="annottext">HMAC hash
</span><a href="#local-6989586621679236775"><span class="hs-identifier hs-var">mac</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0xf</span></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>    </span><span id="local-6989586621679236766"><span class="annot"><span class="annottext">dt :: Word32
</span><a href="#local-6989586621679236766"><span class="hs-identifier hs-var hs-var">dt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HMAC hash -&gt; Int -&gt; Word8
forall a. ByteArrayAccess a =&gt; a -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">B.index</span></span><span> </span><span class="annot"><span class="annottext">HMAC hash
</span><a href="#local-6989586621679236775"><span class="hs-identifier hs-var">mac</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679236790"><span class="hs-identifier hs-var">offset</span></a></span><span>       </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0x7f</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">24</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span>
</span><span id="line-81"></span><span>         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HMAC hash -&gt; Int -&gt; Word8
forall a. ByteArrayAccess a =&gt; a -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">B.index</span></span><span> </span><span class="annot"><span class="annottext">HMAC hash
</span><a href="#local-6989586621679236775"><span class="hs-identifier hs-var">mac</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679236790"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0xff</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">16</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span>
</span><span id="line-82"></span><span>         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word8 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HMAC hash -&gt; Int -&gt; Word8
forall a. ByteArrayAccess a =&gt; a -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">B.index</span></span><span> </span><span class="annot"><span class="annottext">HMAC hash
</span><a href="#local-6989586621679236775"><span class="hs-identifier hs-var">mac</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679236790"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0xff</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Int -&gt; Word32
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftL`</span></span><span>  </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Word32
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.|.</span></span><span>
</span><span id="line-83"></span><span>         </span><span class="annot"><span class="annottext">Word8 -&gt; Word32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HMAC hash -&gt; Int -&gt; Word8
forall a. ByteArrayAccess a =&gt; a -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">B.index</span></span><span> </span><span class="annot"><span class="annottext">HMAC hash
</span><a href="#local-6989586621679236775"><span class="hs-identifier hs-var">mac</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679236790"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Word8
forall a. Bits a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">.&amp;.</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><span class="hs-number">0xff</span></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-comment">-- | Attempt to resynchronize the server's counter value</span><span>
</span><span id="line-86"></span><span class="hs-comment">-- with the client, given a sequence of HOTP values.</span><span>
</span><span id="line-87"></span><span id="local-6989586621679236671"><span id="local-6989586621679236672"><span class="annot"><a href="Crypto.OTP.html#resynchronize"><span class="hs-identifier hs-type">resynchronize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.Hash.Types.html#HashAlgorithm"><span class="hs-identifier hs-type">HashAlgorithm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679236671"><span class="hs-identifier hs-type">hash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteArrayAccess</span></span><span> </span><span class="annot"><a href="#local-6989586621679236672"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679236671"><span class="hs-identifier hs-type">hash</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTPDigits"><span class="hs-identifier hs-type">OTPDigits</span></a></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word16</span></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-comment">-- ^ The look-ahead window parameter. Up to this many values will</span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-comment">-- be calculated and checked against the value(s) submitted by the client</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679236672"><span class="hs-identifier hs-type">key</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The shared secret</span></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The current server counter value</span></span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.OTP.html#OTP"><span class="hs-identifier hs-type">OTP</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Crypto.OTP.html#OTP"><span class="hs-identifier hs-type">OTP</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-comment">-- ^ The first OTP submitted by the client and a list of additional</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-comment">-- sequential OTPs (which may be empty)</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span></span></span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">-- ^ The new counter value, synchronized with the client's current counter</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">-- or Nothing if the submitted OTP values didn't match anywhere within the window</span><span>
</span><span id="line-103"></span><span id="resynchronize"><span class="annot"><span class="annottext">resynchronize :: forall hash key.
(HashAlgorithm hash, ByteArrayAccess key) =&gt;
hash
-&gt; OTPDigits
-&gt; Word16
-&gt; key
-&gt; Word64
-&gt; (Word32, [Word32])
-&gt; Maybe Word64
</span><a href="Crypto.OTP.html#resynchronize"><span class="hs-identifier hs-var hs-var">resynchronize</span></a></span></span><span> </span><span id="local-6989586621679236842"><span class="annot"><span class="annottext">hash
</span><a href="#local-6989586621679236842"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679236843"><span class="annot"><span class="annottext">OTPDigits
</span><a href="#local-6989586621679236843"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621679236844"><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679236844"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679236845"><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679236845"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679236846"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236846"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679236847"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679236847"><span class="hs-identifier hs-var">p1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679236848"><span class="annot"><span class="annottext">[Word32]
</span><a href="#local-6989586621679236848"><span class="hs-identifier hs-var">extras</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-104"></span><span>    </span><span id="local-6989586621679236849"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236849"><span class="hs-identifier hs-var">offBy</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Word64) -&gt; Maybe Int -&gt; Maybe Word64
forall a b. (a -&gt; b) -&gt; Maybe a -&gt; Maybe b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; [Word32] -&gt; Maybe Int
forall a. Eq a =&gt; a -&gt; [a] -&gt; Maybe Int
</span><span class="hs-identifier hs-var">elemIndex</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679236847"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="annot"><span class="annottext">[Word32]
</span><a href="#local-6989586621679236850"><span class="hs-identifier hs-var">range</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><span class="annottext">Word64 -&gt; [Word32] -&gt; Maybe Word64
</span><a href="#local-6989586621679236851"><span class="hs-identifier hs-var">checkExtraOtps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236846"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236849"><span class="hs-identifier hs-var">offBy</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Word32]
</span><a href="#local-6989586621679236848"><span class="hs-identifier hs-var">extras</span></a></span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-107"></span><span>    </span><span id="local-6989586621679236851"><span class="annot"><span class="annottext">checkExtraOtps :: Word64 -&gt; [Word32] -&gt; Maybe Word64
</span><a href="#local-6989586621679236851"><span class="hs-identifier hs-var hs-var">checkExtraOtps</span></a></span></span><span> </span><span id="local-6989586621679236857"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236857"><span class="hs-identifier hs-var">ctr</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Maybe Word64
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236857"><span class="hs-identifier hs-var">ctr</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span class="annot"><a href="#local-6989586621679236851"><span class="hs-identifier hs-var">checkExtraOtps</span></a></span><span> </span><span id="local-6989586621679236858"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236858"><span class="hs-identifier hs-var">ctr</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679236859"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679236859"><span class="hs-identifier hs-var">p</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679236860"><span class="annot"><span class="annottext">[Word32]
</span><a href="#local-6989586621679236860"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">hash -&gt; OTPDigits -&gt; key -&gt; Word64 -&gt; Word32
forall hash key.
(HashAlgorithm hash, ByteArrayAccess key) =&gt;
hash -&gt; OTPDigits -&gt; key -&gt; Word64 -&gt; Word32
</span><a href="Crypto.OTP.html#hotp"><span class="hs-identifier hs-var">hotp</span></a></span><span> </span><span class="annot"><span class="annottext">hash
</span><a href="#local-6989586621679236842"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="#local-6989586621679236843"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679236845"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236858"><span class="hs-identifier hs-var">ctr</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679236859"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Word64
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-110"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; [Word32] -&gt; Maybe Word64
</span><a href="#local-6989586621679236851"><span class="hs-identifier hs-var">checkExtraOtps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236858"><span class="hs-identifier hs-var">ctr</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Word32]
</span><a href="#local-6989586621679236860"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span>    </span><span id="local-6989586621679236850"><span class="annot"><span class="annottext">range :: [Word32]
</span><a href="#local-6989586621679236850"><span class="hs-identifier hs-var hs-var">range</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Word32) -&gt; [Word64] -&gt; [Word32]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">hash -&gt; OTPDigits -&gt; key -&gt; Word64 -&gt; Word32
forall hash key.
(HashAlgorithm hash, ByteArrayAccess key) =&gt;
hash -&gt; OTPDigits -&gt; key -&gt; Word64 -&gt; Word32
</span><a href="Crypto.OTP.html#hotp"><span class="hs-identifier hs-var">hotp</span></a></span><span> </span><span class="annot"><span class="annottext">hash
</span><a href="#local-6989586621679236842"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="#local-6989586621679236843"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679236845"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236846"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-glyph">..</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236846"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679236844"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="annot"><a href="Crypto.OTP.html#digitsPower"><span class="hs-identifier hs-type">digitsPower</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTPDigits"><span class="hs-identifier hs-type">OTPDigits</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word32</span></span><span>
</span><span id="line-115"></span><span id="digitsPower"><span class="annot"><span class="annottext">digitsPower :: OTPDigits -&gt; Word32
</span><a href="Crypto.OTP.html#digitsPower"><span class="hs-identifier hs-var hs-var">digitsPower</span></a></span></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="Crypto.OTP.html#OTP4"><span class="hs-identifier hs-var">OTP4</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">10000</span></span><span>
</span><span id="line-116"></span><span class="annot"><a href="Crypto.OTP.html#digitsPower"><span class="hs-identifier hs-var">digitsPower</span></a></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="Crypto.OTP.html#OTP5"><span class="hs-identifier hs-var">OTP5</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">100000</span></span><span>
</span><span id="line-117"></span><span class="annot"><a href="Crypto.OTP.html#digitsPower"><span class="hs-identifier hs-var">digitsPower</span></a></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="Crypto.OTP.html#OTP6"><span class="hs-identifier hs-var">OTP6</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1000000</span></span><span>
</span><span id="line-118"></span><span class="annot"><a href="Crypto.OTP.html#digitsPower"><span class="hs-identifier hs-var">digitsPower</span></a></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="Crypto.OTP.html#OTP7"><span class="hs-identifier hs-var">OTP7</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">10000000</span></span><span>
</span><span id="line-119"></span><span class="annot"><a href="Crypto.OTP.html#digitsPower"><span class="hs-identifier hs-var">digitsPower</span></a></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="Crypto.OTP.html#OTP8"><span class="hs-identifier hs-var">OTP8</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">100000000</span></span><span>
</span><span id="line-120"></span><span class="annot"><a href="Crypto.OTP.html#digitsPower"><span class="hs-identifier hs-var">digitsPower</span></a></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="Crypto.OTP.html#OTP9"><span class="hs-identifier hs-var">OTP9</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><span class="hs-number">1000000000</span></span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="hs-keyword">data</span><span> </span><span id="TOTPParams"><span class="annot"><a href="Crypto.OTP.html#TOTPParams"><span class="hs-identifier hs-var">TOTPParams</span></a></span></span><span> </span><span id="local-6989586621679236689"><span class="annot"><a href="#local-6989586621679236689"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TP"><span class="annot"><a href="Crypto.OTP.html#TP"><span class="hs-identifier hs-var">TP</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679236689"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Crypto.OTP.html#OTPTime"><span class="hs-identifier hs-type">OTPTime</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Word16</span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Crypto.OTP.html#OTPDigits"><span class="hs-identifier hs-type">OTPDigits</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Crypto.OTP.html#ClockSkew"><span class="hs-identifier hs-type">ClockSkew</span></a></span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679236872"><span id="local-6989586621679236884"><span id="local-6989586621679236888"><span class="annot"><span class="annottext">Int -&gt; TOTPParams h -&gt; ShowS
[TOTPParams h] -&gt; ShowS
TOTPParams h -&gt; String
(Int -&gt; TOTPParams h -&gt; ShowS)
-&gt; (TOTPParams h -&gt; String)
-&gt; ([TOTPParams h] -&gt; ShowS)
-&gt; Show (TOTPParams h)
forall h. Show h =&gt; Int -&gt; TOTPParams h -&gt; ShowS
forall h. Show h =&gt; [TOTPParams h] -&gt; ShowS
forall h. Show h =&gt; TOTPParams h -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: forall h. Show h =&gt; Int -&gt; TOTPParams h -&gt; ShowS
showsPrec :: Int -&gt; TOTPParams h -&gt; ShowS
$cshow :: forall h. Show h =&gt; TOTPParams h -&gt; String
show :: TOTPParams h -&gt; String
$cshowList :: forall h. Show h =&gt; [TOTPParams h] -&gt; ShowS
showList :: [TOTPParams h] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span class="hs-keyword">data</span><span> </span><span id="ClockSkew"><span class="annot"><a href="Crypto.OTP.html#ClockSkew"><span class="hs-identifier hs-var">ClockSkew</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NoSkew"><span class="annot"><a href="Crypto.OTP.html#NoSkew"><span class="hs-identifier hs-var">NoSkew</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="OneStep"><span class="annot"><a href="Crypto.OTP.html#OneStep"><span class="hs-identifier hs-var">OneStep</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="TwoSteps"><span class="annot"><a href="Crypto.OTP.html#TwoSteps"><span class="hs-identifier hs-var">TwoSteps</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="ThreeSteps"><span class="annot"><a href="Crypto.OTP.html#ThreeSteps"><span class="hs-identifier hs-var">ThreeSteps</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="FourSteps"><span class="annot"><a href="Crypto.OTP.html#FourSteps"><span class="hs-identifier hs-var">FourSteps</span></a></span></span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679236896"><span id="local-6989586621679236903"><span id="local-6989586621679236909"><span id="local-6989586621679236918"><span id="local-6989586621679236920"><span id="local-6989586621679236924"><span id="local-6989586621679236928"><span id="local-6989586621679236932"><span class="annot"><span class="annottext">Int -&gt; ClockSkew
ClockSkew -&gt; Int
ClockSkew -&gt; [ClockSkew]
ClockSkew -&gt; ClockSkew
ClockSkew -&gt; ClockSkew -&gt; [ClockSkew]
ClockSkew -&gt; ClockSkew -&gt; ClockSkew -&gt; [ClockSkew]
(ClockSkew -&gt; ClockSkew)
-&gt; (ClockSkew -&gt; ClockSkew)
-&gt; (Int -&gt; ClockSkew)
-&gt; (ClockSkew -&gt; Int)
-&gt; (ClockSkew -&gt; [ClockSkew])
-&gt; (ClockSkew -&gt; ClockSkew -&gt; [ClockSkew])
-&gt; (ClockSkew -&gt; ClockSkew -&gt; [ClockSkew])
-&gt; (ClockSkew -&gt; ClockSkew -&gt; ClockSkew -&gt; [ClockSkew])
-&gt; Enum ClockSkew
forall a.
(a -&gt; a)
-&gt; (a -&gt; a)
-&gt; (Int -&gt; a)
-&gt; (a -&gt; Int)
-&gt; (a -&gt; [a])
-&gt; (a -&gt; a -&gt; [a])
-&gt; (a -&gt; a -&gt; [a])
-&gt; (a -&gt; a -&gt; a -&gt; [a])
-&gt; Enum a
$csucc :: ClockSkew -&gt; ClockSkew
succ :: ClockSkew -&gt; ClockSkew
$cpred :: ClockSkew -&gt; ClockSkew
pred :: ClockSkew -&gt; ClockSkew
$ctoEnum :: Int -&gt; ClockSkew
toEnum :: Int -&gt; ClockSkew
$cfromEnum :: ClockSkew -&gt; Int
fromEnum :: ClockSkew -&gt; Int
$cenumFrom :: ClockSkew -&gt; [ClockSkew]
enumFrom :: ClockSkew -&gt; [ClockSkew]
$cenumFromThen :: ClockSkew -&gt; ClockSkew -&gt; [ClockSkew]
enumFromThen :: ClockSkew -&gt; ClockSkew -&gt; [ClockSkew]
$cenumFromTo :: ClockSkew -&gt; ClockSkew -&gt; [ClockSkew]
enumFromTo :: ClockSkew -&gt; ClockSkew -&gt; [ClockSkew]
$cenumFromThenTo :: ClockSkew -&gt; ClockSkew -&gt; ClockSkew -&gt; [ClockSkew]
enumFromThenTo :: ClockSkew -&gt; ClockSkew -&gt; ClockSkew -&gt; [ClockSkew]
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Enum</span></span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679236936"><span id="local-6989586621679236938"><span id="local-6989586621679236941"><span class="annot"><span class="annottext">Int -&gt; ClockSkew -&gt; ShowS
[ClockSkew] -&gt; ShowS
ClockSkew -&gt; String
(Int -&gt; ClockSkew -&gt; ShowS)
-&gt; (ClockSkew -&gt; String)
-&gt; ([ClockSkew] -&gt; ShowS)
-&gt; Show ClockSkew
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; ClockSkew -&gt; ShowS
showsPrec :: Int -&gt; ClockSkew -&gt; ShowS
$cshow :: ClockSkew -&gt; String
show :: ClockSkew -&gt; String
$cshowList :: [ClockSkew] -&gt; ShowS
showList :: [ClockSkew] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="annot"><span class="hs-comment">-- | The default TOTP configuration.</span></span><span>
</span><span id="line-128"></span><span class="annot"><a href="Crypto.OTP.html#defaultTOTPParams"><span class="hs-identifier hs-type">defaultTOTPParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Crypto.OTP.html#TOTPParams"><span class="hs-identifier hs-type">TOTPParams</span></a></span><span> </span><span class="annot"><a href="Crypto.Hash.SHA1.html#SHA1"><span class="hs-identifier hs-type">SHA1</span></a></span><span>
</span><span id="line-129"></span><span id="defaultTOTPParams"><span class="annot"><span class="annottext">defaultTOTPParams :: TOTPParams SHA1
</span><a href="Crypto.OTP.html#defaultTOTPParams"><span class="hs-identifier hs-var hs-var">defaultTOTPParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SHA1
-&gt; Word64 -&gt; Word16 -&gt; OTPDigits -&gt; ClockSkew -&gt; TOTPParams SHA1
forall h.
h -&gt; Word64 -&gt; Word16 -&gt; OTPDigits -&gt; ClockSkew -&gt; TOTPParams h
</span><a href="Crypto.OTP.html#TP"><span class="hs-identifier hs-var">TP</span></a></span><span> </span><span class="annot"><span class="annottext">SHA1
</span><a href="Crypto.Hash.SHA1.html#SHA1"><span class="hs-identifier hs-var">SHA1</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">30</span></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="Crypto.OTP.html#OTP6"><span class="hs-identifier hs-var">OTP6</span></a></span><span> </span><span class="annot"><span class="annottext">ClockSkew
</span><a href="Crypto.OTP.html#TwoSteps"><span class="hs-identifier hs-var">TwoSteps</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="annot"><span class="hs-comment">-- | Create a TOTP configuration with customized parameters.</span></span><span>
</span><span id="line-132"></span><span id="local-6989586621679236690"><span class="annot"><a href="Crypto.OTP.html#mkTOTPParams"><span class="hs-identifier hs-type">mkTOTPParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.Hash.Types.html#HashAlgorithm"><span class="hs-identifier hs-type">HashAlgorithm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679236690"><span class="hs-identifier hs-type">hash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679236690"><span class="hs-identifier hs-type">hash</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTPTime"><span class="hs-identifier hs-type">OTPTime</span></a></span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-comment">-- ^ The T0 parameter in seconds. This is the Unix time from which to start</span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-comment">-- counting steps (default 0). Must be before the current time.</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word16</span></span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The time step parameter X in seconds (default 30, maximum allowed 300)</span></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTPDigits"><span class="hs-identifier hs-type">OTPDigits</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ Number of required digits in the OTP (default 6)</span></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Crypto.OTP.html#ClockSkew"><span class="hs-identifier hs-type">ClockSkew</span></a></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-comment">-- ^ The number of time steps to check either side of the current value</span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-comment">-- to allow for clock skew between client and server and or delay in</span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">-- submitting the value. The default is two time steps.</span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.OTP.html#TOTPParams"><span class="hs-identifier hs-type">TOTPParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679236690"><span class="hs-identifier hs-type">hash</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-146"></span><span id="mkTOTPParams"><span class="annot"><span class="annottext">mkTOTPParams :: forall hash.
HashAlgorithm hash =&gt;
hash
-&gt; Word64
-&gt; Word16
-&gt; OTPDigits
-&gt; ClockSkew
-&gt; Either String (TOTPParams hash)
</span><a href="Crypto.OTP.html#mkTOTPParams"><span class="hs-identifier hs-var hs-var">mkTOTPParams</span></a></span></span><span> </span><span id="local-6989586621679236957"><span class="annot"><span class="annottext">hash
</span><a href="#local-6989586621679236957"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679236958"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236958"><span class="hs-identifier hs-var">t0</span></a></span></span><span> </span><span id="local-6989586621679236959"><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679236959"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679236960"><span class="annot"><span class="annottext">OTPDigits
</span><a href="#local-6989586621679236960"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621679236961"><span class="annot"><span class="annottext">ClockSkew
</span><a href="#local-6989586621679236961"><span class="hs-identifier hs-var">skew</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Either String () -&gt; Either String ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679236959"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Time step must be greater than zero&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Either String () -&gt; Either String ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679236959"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Word16 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Word16
</span><span class="hs-number">300</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Either String ()
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Time step cannot be greater than 300 seconds&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><span class="annottext">TOTPParams hash -&gt; Either String (TOTPParams hash)
forall a. a -&gt; Either String a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">hash
-&gt; Word64 -&gt; Word16 -&gt; OTPDigits -&gt; ClockSkew -&gt; TOTPParams hash
forall h.
h -&gt; Word64 -&gt; Word16 -&gt; OTPDigits -&gt; ClockSkew -&gt; TOTPParams h
</span><a href="Crypto.OTP.html#TP"><span class="hs-identifier hs-var">TP</span></a></span><span> </span><span class="annot"><span class="annottext">hash
</span><a href="#local-6989586621679236957"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236958"><span class="hs-identifier hs-var">t0</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679236959"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="#local-6989586621679236960"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">ClockSkew
</span><a href="#local-6989586621679236961"><span class="hs-identifier hs-var">skew</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="annot"><span class="hs-comment">-- | Calculate a totp value for the given time.</span></span><span>
</span><span id="line-152"></span><span id="local-6989586621679236700"><span id="local-6989586621679236701"><span class="annot"><a href="Crypto.OTP.html#totp"><span class="hs-identifier hs-type">totp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.Hash.Types.html#HashAlgorithm"><span class="hs-identifier hs-type">HashAlgorithm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679236700"><span class="hs-identifier hs-type">hash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteArrayAccess</span></span><span> </span><span class="annot"><a href="#local-6989586621679236701"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Crypto.OTP.html#TOTPParams"><span class="hs-identifier hs-type">TOTPParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679236700"><span class="hs-identifier hs-type">hash</span></a></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679236701"><span class="hs-identifier hs-type">key</span></a></span><span>
</span><span id="line-155"></span><span>    </span><span class="annot"><span class="hs-comment">-- ^ The shared secret</span></span><span>
</span><span id="line-156"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTPTime"><span class="hs-identifier hs-type">OTPTime</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-comment">-- ^ The time for which the OTP should be calculated.</span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-comment">-- This is usually the current time as returned by @Data.Time.Clock.POSIX.getPOSIXTime@</span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTP"><span class="hs-identifier hs-type">OTP</span></a></span></span></span><span>
</span><span id="line-160"></span><span id="totp"><span class="annot"><span class="annottext">totp :: forall hash key.
(HashAlgorithm hash, ByteArrayAccess key) =&gt;
TOTPParams hash -&gt; key -&gt; Word64 -&gt; Word32
</span><a href="Crypto.OTP.html#totp"><span class="hs-identifier hs-var hs-var">totp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.OTP.html#TP"><span class="hs-identifier hs-type">TP</span></a></span><span> </span><span id="local-6989586621679236968"><span class="annot"><span class="annottext">hash
</span><a href="#local-6989586621679236968"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679236969"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236969"><span class="hs-identifier hs-var">t0</span></a></span></span><span> </span><span id="local-6989586621679236970"><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679236970"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679236971"><span class="annot"><span class="annottext">OTPDigits
</span><a href="#local-6989586621679236971"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="annot"><span class="annottext">ClockSkew
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679236972"><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679236972"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679236973"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236973"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">hash -&gt; OTPDigits -&gt; key -&gt; Word64 -&gt; Word32
forall hash key.
(HashAlgorithm hash, ByteArrayAccess key) =&gt;
hash -&gt; OTPDigits -&gt; key -&gt; Word64 -&gt; Word32
</span><a href="Crypto.OTP.html#hotp"><span class="hs-identifier hs-var">hotp</span></a></span><span> </span><span class="annot"><span class="annottext">hash
</span><a href="#local-6989586621679236968"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="#local-6989586621679236971"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679236972"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word16 -&gt; Word64
</span><a href="Crypto.OTP.html#timeToCounter"><span class="hs-identifier hs-var">timeToCounter</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236973"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236969"><span class="hs-identifier hs-var">t0</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679236970"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="hs-comment">-- | Check a supplied TOTP value is valid for the given time,</span><span>
</span><span id="line-163"></span><span class="hs-comment">-- within the window defined by the skew parameter.</span><span>
</span><span id="line-164"></span><span id="local-6989586621679236704"><span id="local-6989586621679236705"><span class="annot"><a href="Crypto.OTP.html#totpVerify"><span class="hs-identifier hs-type">totpVerify</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.Hash.Types.html#HashAlgorithm"><span class="hs-identifier hs-type">HashAlgorithm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679236704"><span class="hs-identifier hs-type">hash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteArrayAccess</span></span><span> </span><span class="annot"><a href="#local-6989586621679236705"><span class="hs-identifier hs-type">key</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Crypto.OTP.html#TOTPParams"><span class="hs-identifier hs-type">TOTPParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679236704"><span class="hs-identifier hs-type">hash</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679236705"><span class="hs-identifier hs-type">key</span></a></span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTPTime"><span class="hs-identifier hs-type">OTPTime</span></a></span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Crypto.OTP.html#OTP"><span class="hs-identifier hs-type">OTP</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span><span>
</span><span id="line-170"></span><span id="totpVerify"><span class="annot"><span class="annottext">totpVerify :: forall hash key.
(HashAlgorithm hash, ByteArrayAccess key) =&gt;
TOTPParams hash -&gt; key -&gt; Word64 -&gt; Word32 -&gt; Bool
</span><a href="Crypto.OTP.html#totpVerify"><span class="hs-identifier hs-var hs-var">totpVerify</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.OTP.html#TP"><span class="hs-identifier hs-type">TP</span></a></span><span> </span><span id="local-6989586621679236982"><span class="annot"><span class="annottext">hash
</span><a href="#local-6989586621679236982"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679236983"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236983"><span class="hs-identifier hs-var">t0</span></a></span></span><span> </span><span id="local-6989586621679236984"><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679236984"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679236985"><span class="annot"><span class="annottext">OTPDigits
</span><a href="#local-6989586621679236985"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621679236986"><span class="annot"><span class="annottext">ClockSkew
</span><a href="#local-6989586621679236986"><span class="hs-identifier hs-var">skew</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679236987"><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679236987"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621679236988"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236988"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span id="local-6989586621679236989"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679236989"><span class="hs-identifier hs-var">otp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679236989"><span class="hs-identifier hs-var">otp</span></a></span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; [Word32] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; Word32) -&gt; [Word64] -&gt; [Word32]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">hash -&gt; OTPDigits -&gt; key -&gt; Word64 -&gt; Word32
forall hash key.
(HashAlgorithm hash, ByteArrayAccess key) =&gt;
hash -&gt; OTPDigits -&gt; key -&gt; Word64 -&gt; Word32
</span><a href="Crypto.OTP.html#hotp"><span class="hs-identifier hs-var">hotp</span></a></span><span> </span><span class="annot"><span class="annottext">hash
</span><a href="#local-6989586621679236982"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">OTPDigits
</span><a href="#local-6989586621679236985"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">key
</span><a href="#local-6989586621679236987"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; [Word64] -&gt; [Word64]
</span><a href="#local-6989586621679236991"><span class="hs-identifier hs-var">range</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236992"><span class="hs-identifier hs-var">window</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-172"></span><span>    </span><span id="local-6989586621679236993"><span class="annot"><span class="annottext">t :: Word64
</span><a href="#local-6989586621679236993"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word16 -&gt; Word64
</span><a href="Crypto.OTP.html#timeToCounter"><span class="hs-identifier hs-var">timeToCounter</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236988"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236983"><span class="hs-identifier hs-var">t0</span></a></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679236984"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span id="local-6989586621679236992"><span class="annot"><span class="annottext">window :: Word64
</span><a href="#local-6989586621679236992"><span class="hs-identifier hs-var hs-var">window</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClockSkew -&gt; Int
forall a. Enum a =&gt; a -&gt; Int
</span><span class="hs-identifier hs-var">fromEnum</span></span><span> </span><span class="annot"><span class="annottext">ClockSkew
</span><a href="#local-6989586621679236986"><span class="hs-identifier hs-var">skew</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>    </span><span id="local-6989586621679236991"><span class="annot"><span class="annottext">range :: Word64 -&gt; [Word64] -&gt; [Word64]
</span><a href="#local-6989586621679236991"><span class="hs-identifier hs-var hs-var">range</span></a></span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span> </span><span id="local-6989586621679237005"><span class="annot"><span class="annottext">[Word64]
</span><a href="#local-6989586621679237005"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236993"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; [Word64] -&gt; [Word64]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Word64]
</span><a href="#local-6989586621679237005"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><a href="#local-6989586621679236991"><span class="hs-identifier hs-var">range</span></a></span><span> </span><span id="local-6989586621679237006"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679237006"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679237007"><span class="annot"><span class="annottext">[Word64]
</span><a href="#local-6989586621679237007"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; [Word64] -&gt; [Word64]
</span><a href="#local-6989586621679236991"><span class="hs-identifier hs-var">range</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679237006"><span class="hs-identifier hs-var">n</span></a></span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236993"><span class="hs-identifier hs-var">t</span></a></span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679237006"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; [Word64] -&gt; [Word64]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679236993"><span class="hs-identifier hs-var">t</span></a></span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679237006"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; [Word64] -&gt; [Word64]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Word64]
</span><a href="#local-6989586621679237007"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span class="annot"><a href="Crypto.OTP.html#timeToCounter"><span class="hs-identifier hs-type">timeToCounter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word16</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word64</span></span><span>
</span><span id="line-178"></span><span id="timeToCounter"><span class="annot"><span class="annottext">timeToCounter :: Word64 -&gt; Word64 -&gt; Word16 -&gt; Word64
</span><a href="Crypto.OTP.html#timeToCounter"><span class="hs-identifier hs-var hs-var">timeToCounter</span></a></span></span><span> </span><span id="local-6989586621679237008"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679237008"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span id="local-6989586621679237009"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679237009"><span class="hs-identifier hs-var">t0</span></a></span></span><span> </span><span id="local-6989586621679237010"><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679237010"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679237008"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679237009"><span class="hs-identifier hs-var">t0</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Word64 -&gt; Word64
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Word16 -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word16
</span><a href="#local-6989586621679237010"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-179"></span></pre></body></html>