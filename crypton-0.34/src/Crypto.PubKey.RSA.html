<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- |</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- Module      : Crypto.PubKey.RSA</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- License     : BSD-style</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- Maintainer  : Vincent Hanquez &lt;vincent@snarc.org&gt;</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- Stability   : experimental</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- Portability : Good</span><span>
</span><span id="line-7"></span><span class="hs-comment">--</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Crypto.PubKey.RSA</span><span>
</span><span id="line-9"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.Types.html#Error"><span class="hs-identifier">Error</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.Types.html#PublicKey"><span class="hs-identifier">PublicKey</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.Types.html#PrivateKey"><span class="hs-identifier">PrivateKey</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.Types.html#Blinder"><span class="hs-identifier">Blinder</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Generation function</span></span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.html#generateWith"><span class="hs-identifier">generateWith</span></a></span><span>
</span><span id="line-15"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.html#generate"><span class="hs-identifier">generate</span></a></span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.html#generateBlinder"><span class="hs-identifier">generateBlinder</span></a></span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Crypto.Random.Types.html"><span class="hs-identifier">Crypto.Random.Types</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Crypto.Number.ModArithmetic.html"><span class="hs-identifier">Crypto.Number.ModArithmetic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.Number.ModArithmetic.html#inverse"><span class="hs-identifier">inverse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.Number.ModArithmetic.html#inverseCoprimes"><span class="hs-identifier">inverseCoprimes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Crypto.Number.Generate.html"><span class="hs-identifier">Crypto.Number.Generate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.Number.Generate.html#generateMax"><span class="hs-identifier">generateMax</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Crypto.Number.Prime.html"><span class="hs-identifier">Crypto.Number.Prime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.Number.Prime.html#generatePrime"><span class="hs-identifier">generatePrime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.Types.html"><span class="hs-identifier">Crypto.PubKey.RSA.Types</span></a></span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-comment">{-
-- some bad implementation will not serialize ASN.1 integer properly, leading
-- to negative modulus.
-- TODO : Find a better place for this
toPositive :: Integer -&gt; Integer
toPositive int
    | int &lt; 0   = uintOfBytes $ bytesOfInt int
    | otherwise = int
  where uintOfBytes = foldl (\acc n -&gt; (acc `shiftL` 8) + fromIntegral n) 0
        bytesOfInt :: Integer -&gt; [Word8]
        bytesOfInt n = if testBit (head nints) 7 then nints else 0xff : nints
          where nints = reverse $ plusOne $ reverse $ map complement $ bytesOfUInt (abs n)
                plusOne []     = [1]
                plusOne (x:xs) = if x == 0xff then 0 : plusOne xs else (x+1) : xs
                bytesOfUInt x = reverse (list x)
                  where list i = if i &lt;= 0xff then [fromIntegral i] else (fromIntegral i .&amp;. 0xff) : list (i `shiftR` 8)
-}</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-comment">-- | Generate a key pair given p and q.</span><span>
</span><span id="line-44"></span><span class="hs-comment">--</span><span>
</span><span id="line-45"></span><span class="hs-comment">-- p and q need to be distinct prime numbers.</span><span>
</span><span id="line-46"></span><span class="hs-comment">--</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- e need to be coprime to phi=(p-1)*(q-1). If that's not the</span><span>
</span><span id="line-48"></span><span class="hs-comment">-- case, the function will not return a key pair.</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- A small hamming weight results in better performance.</span><span>
</span><span id="line-50"></span><span class="hs-comment">--</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- * e=0x10001 is a popular choice</span><span>
</span><span id="line-52"></span><span class="hs-comment">--</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- * e=3 is popular as well, but proven to not be as secure for some cases.</span><span>
</span><span id="line-54"></span><span class="hs-comment">--</span><span>
</span><span id="line-55"></span><span class="annot"><a href="Crypto.PubKey.RSA.html#generateWith"><span class="hs-identifier hs-type">generateWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-comment">-- ^ chosen distinct primes p and q</span></span><span>
</span><span id="line-56"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>                </span><span class="annot"><span class="hs-comment">-- ^ size in bytes</span></span><span>
</span><span id="line-57"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span>            </span><span class="annot"><span class="hs-comment">-- ^ RSA public exponent 'e'</span></span><span>
</span><span id="line-58"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.PubKey.RSA.Types.html#PublicKey"><span class="hs-identifier hs-type">PublicKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.Types.html#PrivateKey"><span class="hs-identifier hs-type">PrivateKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span id="generateWith"><span class="annot"><span class="annottext">generateWith :: (Integer, Integer)
-&gt; Int -&gt; Integer -&gt; Maybe (PublicKey, PrivateKey)
</span><a href="Crypto.PubKey.RSA.html#generateWith"><span class="hs-identifier hs-var hs-var">generateWith</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679248221"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248221"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679248222"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248222"><span class="hs-identifier hs-var">q</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679248223"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679248223"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621679248224"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248224"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Maybe Integer
</span><a href="Crypto.Number.ModArithmetic.html#inverse"><span class="hs-identifier hs-var">inverse</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248224"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248225"><span class="hs-identifier hs-var">phi</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-61"></span><span>        </span><span class="annot"><span class="annottext">Maybe Integer
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (PublicKey, PrivateKey)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-62"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679248226"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248226"><span class="hs-identifier hs-var">d</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(PublicKey, PrivateKey) -&gt; Maybe (PublicKey, PrivateKey)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PublicKey
</span><a href="#local-6989586621679248227"><span class="hs-identifier hs-var">pub</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Integer -&gt; PrivateKey
</span><a href="#local-6989586621679248228"><span class="hs-identifier hs-var">priv</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248226"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679248231"><span class="annot"><span class="annottext">n :: Integer
</span><a href="#local-6989586621679248231"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248221"><span class="hs-identifier hs-var">p</span></a></span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248222"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-64"></span><span>        </span><span id="local-6989586621679248225"><span class="annot"><span class="annottext">phi :: Integer
</span><a href="#local-6989586621679248225"><span class="hs-identifier hs-var hs-var">phi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248221"><span class="hs-identifier hs-var">p</span></a></span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248222"><span class="hs-identifier hs-var">q</span></a></span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>        </span><span class="hs-comment">-- q and p should be *distinct* *prime* numbers, hence always coprime</span><span>
</span><span id="line-66"></span><span>        </span><span id="local-6989586621679248238"><span class="annot"><span class="annottext">qinv :: Integer
</span><a href="#local-6989586621679248238"><span class="hs-identifier hs-var hs-var">qinv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
</span><a href="Crypto.Number.ModArithmetic.html#inverseCoprimes"><span class="hs-identifier hs-var">inverseCoprimes</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248222"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248221"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-67"></span><span>        </span><span id="local-6989586621679248227"><span class="annot"><span class="annottext">pub :: PublicKey
</span><a href="#local-6989586621679248227"><span class="hs-identifier hs-var hs-var">pub</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.Types.html#PublicKey"><span class="hs-identifier hs-type">PublicKey</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">public_size :: Int
</span><a href="Crypto.PubKey.RSA.Types.html#public_size"><span class="hs-identifier hs-var">public_size</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679248223"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-68"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">public_n :: Integer
</span><a href="Crypto.PubKey.RSA.Types.html#public_n"><span class="hs-identifier hs-var">public_n</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248231"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-69"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">public_e :: Integer
</span><a href="Crypto.PubKey.RSA.Types.html#public_e"><span class="hs-identifier hs-var">public_e</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248224"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-70"></span><span>                        </span><span class="hs-special">}</span><span>
</span><span id="line-71"></span><span>        </span><span id="local-6989586621679248228"><span class="annot"><span class="annottext">priv :: Integer -&gt; PrivateKey
</span><a href="#local-6989586621679248228"><span class="hs-identifier hs-var hs-var">priv</span></a></span></span><span> </span><span id="local-6989586621679248250"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248250"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.Types.html#PrivateKey"><span class="hs-identifier hs-type">PrivateKey</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">private_pub :: PublicKey
</span><a href="Crypto.PubKey.RSA.Types.html#private_pub"><span class="hs-identifier hs-var">private_pub</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PublicKey
</span><a href="#local-6989586621679248227"><span class="hs-identifier hs-var">pub</span></a></span><span>
</span><span id="line-72"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">private_d :: Integer
</span><a href="Crypto.PubKey.RSA.Types.html#private_d"><span class="hs-identifier hs-var">private_d</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248250"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-73"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">private_p :: Integer
</span><a href="Crypto.PubKey.RSA.Types.html#private_p"><span class="hs-identifier hs-var">private_p</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248221"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-74"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">private_q :: Integer
</span><a href="Crypto.PubKey.RSA.Types.html#private_q"><span class="hs-identifier hs-var">private_q</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248222"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-75"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">private_dP :: Integer
</span><a href="Crypto.PubKey.RSA.Types.html#private_dP"><span class="hs-identifier hs-var">private_dP</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248250"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248221"><span class="hs-identifier hs-var">p</span></a></span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">private_dQ :: Integer
</span><a href="Crypto.PubKey.RSA.Types.html#private_dQ"><span class="hs-identifier hs-var">private_dQ</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248250"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`mod`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248222"><span class="hs-identifier hs-var">q</span></a></span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">private_qinv :: Integer
</span><a href="Crypto.PubKey.RSA.Types.html#private_qinv"><span class="hs-identifier hs-var">private_qinv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248238"><span class="hs-identifier hs-var">qinv</span></a></span><span>
</span><span id="line-78"></span><span>                            </span><span class="hs-special">}</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="annot"><span class="hs-comment">-- | generate a pair of (private, public) key of size in bytes.</span></span><span>
</span><span id="line-81"></span><span id="local-6989586621679248197"><span class="annot"><a href="Crypto.PubKey.RSA.html#generate"><span class="hs-identifier hs-type">generate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Crypto.Random.Types.html#MonadRandom"><span class="hs-identifier hs-type">MonadRandom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679248197"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-82"></span><span>         </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>     </span><span class="annot"><span class="hs-comment">-- ^ size in bytes</span></span><span>
</span><span id="line-83"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ RSA public exponent 'e'</span></span><span>
</span><span id="line-84"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679248197"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Crypto.PubKey.RSA.Types.html#PublicKey"><span class="hs-identifier hs-type">PublicKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.Types.html#PrivateKey"><span class="hs-identifier hs-type">PrivateKey</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-85"></span><span id="generate"><span class="annot"><span class="annottext">generate :: forall (m :: * -&gt; *).
MonadRandom m =&gt;
Int -&gt; Integer -&gt; m (PublicKey, PrivateKey)
</span><a href="Crypto.PubKey.RSA.html#generate"><span class="hs-identifier hs-var hs-var">generate</span></a></span></span><span> </span><span id="local-6989586621679248267"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679248267"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621679248268"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248268"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (PublicKey, PrivateKey)
</span><a href="#local-6989586621679248269"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-87"></span><span>    </span><span id="local-6989586621679248269"><span class="annot"><span class="annottext">loop :: m (PublicKey, PrivateKey)
</span><a href="#local-6989586621679248269"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-comment">-- loop until we find a valid key pair given e</span><span>
</span><span id="line-88"></span><span>        </span><span id="local-6989586621679248274"><span class="annot"><span class="annottext">(Integer, Integer)
</span><a href="#local-6989586621679248274"><span class="hs-identifier hs-var">pq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Integer, Integer)
</span><a href="#local-6989586621679248275"><span class="hs-identifier hs-var">generatePQ</span></a></span><span>
</span><span id="line-89"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Integer, Integer)
-&gt; Int -&gt; Integer -&gt; Maybe (PublicKey, PrivateKey)
</span><a href="Crypto.PubKey.RSA.html#generateWith"><span class="hs-identifier hs-var">generateWith</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer, Integer)
</span><a href="#local-6989586621679248274"><span class="hs-identifier hs-var">pq</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679248267"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248268"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-90"></span><span>            </span><span class="annot"><span class="annottext">Maybe (PublicKey, PrivateKey)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m (PublicKey, PrivateKey)
</span><a href="#local-6989586621679248269"><span class="hs-identifier hs-var">loop</span></a></span><span>
</span><span id="line-91"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679248276"><span class="annot"><span class="annottext">(PublicKey, PrivateKey)
</span><a href="#local-6989586621679248276"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(PublicKey, PrivateKey) -&gt; m (PublicKey, PrivateKey)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PublicKey, PrivateKey)
</span><a href="#local-6989586621679248276"><span class="hs-identifier hs-var">pp</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span id="local-6989586621679248275"><span class="annot"><span class="annottext">generatePQ :: m (Integer, Integer)
</span><a href="#local-6989586621679248275"><span class="hs-identifier hs-var hs-var">generatePQ</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-93"></span><span>        </span><span id="local-6989586621679248293"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248293"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m Integer
forall (m :: * -&gt; *). MonadRandom m =&gt; Int -&gt; m Integer
</span><a href="Crypto.Number.Prime.html#generatePrime"><span class="hs-identifier hs-var">generatePrime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679248267"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>        </span><span id="local-6989586621679248295"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248295"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; m Integer
forall {m :: * -&gt; *}. MonadRandom m =&gt; Integer -&gt; m Integer
</span><a href="#local-6989586621679248296"><span class="hs-identifier hs-var">generateQ</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248293"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-95"></span><span>        </span><span class="annot"><span class="annottext">(Integer, Integer) -&gt; m (Integer, Integer)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248293"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248295"><span class="hs-identifier hs-var">q</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>    </span><span id="local-6989586621679248296"><span class="annot"><span class="annottext">generateQ :: Integer -&gt; m Integer
</span><a href="#local-6989586621679248296"><span class="hs-identifier hs-var hs-var">generateQ</span></a></span></span><span> </span><span id="local-6989586621679248316"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248316"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-97"></span><span>        </span><span id="local-6989586621679248317"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248317"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m Integer
forall (m :: * -&gt; *). MonadRandom m =&gt; Int -&gt; m Integer
</span><a href="Crypto.Number.Prime.html#generatePrime"><span class="hs-identifier hs-var">generatePrime</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679248267"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679248267"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248316"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248317"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; m Integer
</span><a href="#local-6989586621679248296"><span class="hs-identifier hs-var">generateQ</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248316"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; m Integer
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248317"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- | Generate a blinder to use with decryption and signing operation</span><span>
</span><span id="line-101"></span><span class="hs-comment">--</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- the unique parameter apart from the random number generator is the</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- public key value N.</span><span>
</span><span id="line-104"></span><span id="local-6989586621679248207"><span class="annot"><a href="Crypto.PubKey.RSA.html#generateBlinder"><span class="hs-identifier hs-type">generateBlinder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Crypto.Random.Types.html#MonadRandom"><span class="hs-identifier hs-type">MonadRandom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679248207"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-105"></span><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ RSA public N parameter.</span></span><span>
</span><span id="line-106"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679248207"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Crypto.PubKey.RSA.Types.html#Blinder"><span class="hs-identifier hs-type">Blinder</span></a></span></span><span>
</span><span id="line-107"></span><span id="generateBlinder"><span class="annot"><span class="annottext">generateBlinder :: forall (m :: * -&gt; *). MonadRandom m =&gt; Integer -&gt; m Blinder
</span><a href="Crypto.PubKey.RSA.html#generateBlinder"><span class="hs-identifier hs-var hs-var">generateBlinder</span></a></span></span><span> </span><span id="local-6989586621679248324"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248324"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679248325"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248325"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Blinder
</span><a href="Crypto.PubKey.RSA.Types.html#Blinder"><span class="hs-identifier hs-var">Blinder</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248325"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
</span><a href="Crypto.Number.ModArithmetic.html#inverseCoprimes"><span class="hs-identifier hs-var">inverseCoprimes</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248325"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248324"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Blinder) -&gt; m Integer -&gt; m Blinder
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; m Integer
forall {m :: * -&gt; *}. MonadRandom m =&gt; Integer -&gt; m Integer
</span><a href="Crypto.Number.Generate.html#generateMax"><span class="hs-identifier hs-var">generateMax</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679248324"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-109"></span></pre></body></html>