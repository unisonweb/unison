<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>WaiAppStatic.Storage.Embedded</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">wai-app-static-3.1.9: WAI application for static serving</span><ul class="links" id="page-menu"><li><a href="src/WaiAppStatic.Storage.Embedded.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>Safe-Inferred</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">WaiAppStatic.Storage.Embedded</p></div><div id="table-of-contents"><div id="contents-list"><p class="caption" onclick="window.scrollTo(0,0)">Contents</p><ul><li><a href="#g:1">Basic</a></li><li><a href="#g:2">Template Haskell</a></li></ul></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:embeddedSettings">embeddedSettings</a> :: [(<a href="../base-4.18.2.1/System-IO.html#t:FilePath" title="System.IO">FilePath</a>, <a href="../bytestring-0.11.5.3/Data-ByteString.html#t:ByteString" title="Data.ByteString">ByteString</a>)] -&gt; <a href="WaiAppStatic-Types.html#t:StaticSettings" title="WaiAppStatic.Types">StaticSettings</a></li><li class="src short"><span class="keyword">type</span> <a href="#t:Etag">Etag</a> = <a href="../text-2.0.2/Data-Text.html#t:Text" title="Data.Text">Text</a></li><li class="src short"><span class="keyword">data</span> <a href="#t:EmbeddableEntry">EmbeddableEntry</a> = <a href="#v:EmbeddableEntry">EmbeddableEntry</a> {<ul class="subs"><li><a href="#v:eLocation">eLocation</a> :: <a href="../text-2.0.2/Data-Text.html#t:Text" title="Data.Text">Text</a></li><li><a href="#v:eMimeType">eMimeType</a> :: <a href="../mime-types-0.1.2.0/Network-Mime.html#t:MimeType" title="Network.Mime">MimeType</a></li><li><a href="#v:eContent">eContent</a> :: <a href="../base-4.18.2.1/Data-Either.html#t:Either" title="Data.Either">Either</a> (<a href="WaiAppStatic-Storage-Embedded.html#t:Etag" title="WaiAppStatic.Storage.Embedded">Etag</a>, <a href="../bytestring-0.11.5.3/Data-ByteString-Lazy.html#t:ByteString" title="Data.ByteString.Lazy">ByteString</a>) <a href="../template-haskell-2.20.0.0/Language-Haskell-TH-Lib-Internal.html#t:ExpQ" title="Language.Haskell.TH.Lib.Internal">ExpQ</a></li></ul>}</li><li class="src short"><a href="#v:mkSettings">mkSettings</a> :: <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> [<a href="WaiAppStatic-Storage-Embedded.html#t:EmbeddableEntry" title="WaiAppStatic.Storage.Embedded">EmbeddableEntry</a>] -&gt; <a href="../template-haskell-2.20.0.0/Language-Haskell-TH-Lib-Internal.html#t:ExpQ" title="Language.Haskell.TH.Lib.Internal">ExpQ</a></li></ul></details></div><div id="interface"><a href="#g:1" id="g:1"><h1>Basic</h1></a><div class="top"><p class="src"><a id="v:embeddedSettings" class="def">embeddedSettings</a> :: [(<a href="../base-4.18.2.1/System-IO.html#t:FilePath" title="System.IO">FilePath</a>, <a href="../bytestring-0.11.5.3/Data-ByteString.html#t:ByteString" title="Data.ByteString">ByteString</a>)] -&gt; <a href="WaiAppStatic-Types.html#t:StaticSettings" title="WaiAppStatic.Types">StaticSettings</a> <a href="src/WaiAppStatic.Storage.Embedded.Runtime.html#embeddedSettings" class="link">Source</a> <a href="#v:embeddedSettings" class="selflink">#</a></p><div class="doc"><p>Serve the list of path/content pairs directly from memory.</p></div></div><a href="#g:2" id="g:2"><h1>Template Haskell</h1></a><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:Etag" class="def">Etag</a> = <a href="../text-2.0.2/Data-Text.html#t:Text" title="Data.Text">Text</a> <a href="src/WaiAppStatic.Storage.Embedded.TH.html#Etag" class="link">Source</a> <a href="#t:Etag" class="selflink">#</a></p><div class="doc"><p>An Etag is used to return 304 Not Modified responses so the client does not need
   to download resources a second time.  Usually the etag is built from a hash of
   the content.  To disable Etags, you can pass the empty string.  This will cause the
   content to be redownloaded on every request.</p></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:EmbeddableEntry" class="def">EmbeddableEntry</a> <a href="src/WaiAppStatic.Storage.Embedded.TH.html#EmbeddableEntry" class="link">Source</a> <a href="#t:EmbeddableEntry" class="selflink">#</a></p><div class="doc"><p>Used at compile time to hold data about an entry to embed into the compiled executable.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:EmbeddableEntry" class="def">EmbeddableEntry</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:eLocation" class="def">eLocation</a> :: <a href="../text-2.0.2/Data-Text.html#t:Text" title="Data.Text">Text</a></dfn><div class="doc"><p>The location where this resource should be served from.  The
   location can contain forward slashes (/) to simulate directories,
   but must not end with a forward slash.</p></div></li><li><dfn class="src"><a id="v:eMimeType" class="def">eMimeType</a> :: <a href="../mime-types-0.1.2.0/Network-Mime.html#t:MimeType" title="Network.Mime">MimeType</a></dfn><div class="doc"><p>The mime type.</p></div></li><li><dfn class="src"><a id="v:eContent" class="def">eContent</a> :: <a href="../base-4.18.2.1/Data-Either.html#t:Either" title="Data.Either">Either</a> (<a href="WaiAppStatic-Storage-Embedded.html#t:Etag" title="WaiAppStatic.Storage.Embedded">Etag</a>, <a href="../bytestring-0.11.5.3/Data-ByteString-Lazy.html#t:ByteString" title="Data.ByteString.Lazy">ByteString</a>) <a href="../template-haskell-2.20.0.0/Language-Haskell-TH-Lib-Internal.html#t:ExpQ" title="Language.Haskell.TH.Lib.Internal">ExpQ</a></dfn><div class="doc"><p>The content itself.  The content can be given as a tag and bytestring,
   in which case the content will be embedded directly into the execuatble.
   Alternatively, the content can be given as a template haskell expression
   returning <code>IO (<code><a href="WaiAppStatic-Storage-Embedded.html#t:Etag" title="WaiAppStatic.Storage.Embedded">Etag</a></code>, <code><a href="../bytestring-0.11.5.3/Data-ByteString-Lazy.html#t:ByteString" title="Data.ByteString.Lazy">ByteString</a></code>)</code> in which case this action will
   be executed on every request to reload the content (this is useful
   for a debugging mode).</p></div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><a id="v:mkSettings" class="def">mkSettings</a> :: <a href="../base-4.18.2.1/System-IO.html#t:IO" title="System.IO">IO</a> [<a href="WaiAppStatic-Storage-Embedded.html#t:EmbeddableEntry" title="WaiAppStatic.Storage.Embedded">EmbeddableEntry</a>] -&gt; <a href="../template-haskell-2.20.0.0/Language-Haskell-TH-Lib-Internal.html#t:ExpQ" title="Language.Haskell.TH.Lib.Internal">ExpQ</a> <a href="src/WaiAppStatic.Storage.Embedded.TH.html#mkSettings" class="link">Source</a> <a href="#v:mkSettings" class="selflink">#</a></p><div class="doc"><p>Create a <code><a href="WaiAppStatic-Types.html#t:StaticSettings" title="WaiAppStatic.Types">StaticSettings</a></code> at compile time that embeds resources directly into the compiled
   executable.  The embedded resources are precompressed (depending on mime type)
   so that during runtime the resource can be served very quickly.</p><p>Because of GHC Template Haskell stage restrictions, you must define
   the entries in a different module than where you create the <code><a href="WaiAppStatic-Types.html#t:StaticSettings" title="WaiAppStatic.Types">StaticSettings</a></code>.
   For example,</p><pre>{-# LANGUAGE TemplateHaskell, QuasiQuotes, OverloadedStrings #-}
module A (mkEmbedded) where

import WaiAppStatic.Storage.Embedded
import Crypto.Hash.MD5 (hashlazy)
import qualified Data.ByteString.Lazy as BL
import qualified Data.ByteString.Base64 as B64
import qualified Data.Text as T
import qualified Data.Text.Encoding as T

hash :: BL.ByteString -&gt; T.Text
hash = T.take 8 . T.decodeUtf8 . B64.encode . hashlazy

mkEmbedded :: IO [EmbeddableEntry]
mkEmbedded = do
    file &lt;- BL.readFile &quot;test.css&quot;
    let emb = EmbeddableEntry {
                  eLocation = &quot;somedir/test.css&quot;
                , eMimeType = &quot;text/css&quot;
                , eContent  = Left (hash file, file)
                }

    let reload = EmbeddableEntry {
                     eLocation = &quot;anotherdir/test2.txt&quot;
                   , eMimeType = &quot;text/plain&quot;
                   , eContent  = Right [| BL.readFile &quot;test2.txt&quot; &gt;&gt;= \c -&gt; return (hash c, c) |]
                   }

    return [emb, reload]</pre><p>The above <code>mkEmbedded</code> will be executed at compile time.  It loads the contents of test.css and
 computes the hash of test.css for the etag.  The content will be available at the URL somedir/test.css.
 Internally, <code>embedApp</code> below will attempt to compress the content at compile time. The compression will
 only happen if the compressed content is shorter than the original and the mime type is either text or
 javascript.  If the content is compressed, at runtime the precomputed compressed content will be served
 with the appropriate HTTP header. If <code>embedApp</code> decides not to compress the content, it will be
 served directly.</p><p>Secondly, <code>mkEmbedded</code> creates a reloadable entry.  This will be available at the URL anotherdir/test2.txt.
 Whenver a request comes in for anotherdir/test2.txt, the action inside the quasiquote in eContent will
 be executed.  This will re-read the test2.txt file and recompute its hash.</p><p>Finally, here is a module which uses the above action to create a <code><a href="../wai-3.2.4/Network-Wai.html#t:Application" title="Network.Wai">Application</a></code>.</p><pre>{-# LANGUAGE TemplateHaskell #-}
module B where

import A
import Network.Wai (Application)
import Network.Wai.Application.Static (staticApp)
import WaiAppStatic.Storage.Embedded
import Network.Wai.Handler.Warp (run)

myApp :: Application
myApp = staticApp $(mkSettings mkEmbedded)

main :: IO ()
main = run 3000 myApp</pre></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.29.2</p></div></body></html>