<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- |</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- Copyright:   (c) 2022 Andrew Lelechenko</span><span>
</span><span id="line-3"></span><span class="hs-comment">--              (c) 2023 Pierre Le Marre</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- Licence:     BSD3</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- Maintainer:  Andrew Lelechenko &lt;andrew.lelechenko@gmail.com&gt;</span><span>
</span><span id="line-6"></span><span class="hs-comment">--</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Low-level routines for 'Buffer' manipulations.</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.Text.Builder.Linear.Core</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-9"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Type</span></span><span>
</span><span id="line-10"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier">Buffer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Basic interface</span></span><span>
</span><span id="line-13"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#runBuffer"><span class="hs-identifier">runBuffer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#runBufferBS"><span class="hs-identifier">runBufferBS</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#dupBuffer"><span class="hs-identifier">dupBuffer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#consumeBuffer"><span class="hs-identifier">consumeBuffer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#eraseBuffer"><span class="hs-identifier">eraseBuffer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#byteSizeOfBuffer"><span class="hs-identifier">byteSizeOfBuffer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#lengthOfBuffer"><span class="hs-identifier">lengthOfBuffer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#dropBuffer"><span class="hs-identifier">dropBuffer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#takeBuffer"><span class="hs-identifier">takeBuffer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#newEmptyBuffer"><span class="hs-identifier">newEmptyBuffer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Text concatenation</span></span><span>
</span><span id="line-25"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#appendBounded"><span class="hs-identifier">appendBounded</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#appendExact"><span class="hs-identifier">appendExact</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#prependBounded"><span class="hs-identifier">prependBounded</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#prependExact"><span class="hs-identifier">prependExact</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#%3E%3C"><span class="hs-operator">(&gt;&lt;)</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Internal</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ByteString</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Array</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Internal</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Text</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Exts</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Int</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Levity</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">RuntimeRep</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TYPE</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">byteArrayContents#</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">plusAddr#</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unsafeCoerce#</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.ForeignPtr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ForeignPtr</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">ForeignPtrContents</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.ST</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ST</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">runST</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Array.html"><span class="hs-identifier">Data.Text.Builder.Linear.Array</span></a></span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-comment">-- | Internally 'Buffer' is a mutable buffer.</span><span>
</span><span id="line-43"></span><span class="hs-comment">-- If a client gets hold of a variable of type 'Buffer',</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- they'd be able to pass a mutable buffer to concurrent threads.</span><span>
</span><span id="line-45"></span><span class="hs-comment">-- That's why API below is carefully designed to prevent such possibility:</span><span>
</span><span id="line-46"></span><span class="hs-comment">-- clients always work with linear functions 'Buffer' &#8888; 'Buffer' instead</span><span>
</span><span id="line-47"></span><span class="hs-comment">-- and run them on an empty 'Buffer' to extract results.</span><span>
</span><span id="line-48"></span><span class="hs-comment">--</span><span>
</span><span id="line-49"></span><span class="hs-comment">-- In terms of [@linear-base@](https://hackage.haskell.org/package/linear-base)</span><span>
</span><span id="line-50"></span><span class="hs-comment">-- 'Buffer' is [@Consumable@](https://hackage.haskell.org/package/linear-base/docs/Prelude-Linear.html#t:Consumable)</span><span>
</span><span id="line-51"></span><span class="hs-comment">-- (see 'consumeBuffer')</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- and [@Dupable@](https://hackage.haskell.org/package/linear-base/docs/Prelude-Linear.html#t:Dupable)</span><span>
</span><span id="line-53"></span><span class="hs-comment">-- (see 'dupBuffer'),</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- but not [@Movable@](https://hackage.haskell.org/package/linear-base/docs/Prelude-Linear.html#t:Movable).</span><span>
</span><span id="line-55"></span><span class="hs-comment">--</span><span>
</span><span id="line-56"></span><span class="hs-comment">-- &gt;&gt;&gt; :set -XOverloadedStrings -XLinearTypes</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- &gt;&gt;&gt; import Data.Text.Builder.Linear.Buffer</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- &gt;&gt;&gt; runBuffer (\b -&gt; '!' .&lt;| &quot;foo&quot; &lt;| (b |&gt; &quot;bar&quot; |&gt;. '.'))</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- &quot;!foobar.&quot;</span><span>
</span><span id="line-60"></span><span class="hs-comment">--</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- Remember: this is a strict builder, so on contrary to &quot;Data.Text.Lazy.Builder&quot;</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- for optimal performance you should use strict left folds instead of lazy right ones.</span><span>
</span><span id="line-63"></span><span class="hs-comment">--</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- 'Buffer' is an unlifted datatype,</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- so you can put it into an unboxed tuple @(# ..., ... #)@,</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- but not into @(..., ...)@.</span><span>
</span><span id="line-67"></span><span class="hs-keyword">data</span><span> </span><span id="Buffer"><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TYPE</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">BoxedRep</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Unlifted</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-68"></span><span>  </span><span id="Buffer"><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-comment">-- | Unwrap 'Buffer', no-op.</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- Most likely, this is not the function you're looking for</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- and you need 'runBuffer' instead.</span><span>
</span><span id="line-73"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#unBuffer"><span class="hs-identifier hs-type">unBuffer</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-74"></span><span id="unBuffer"><span class="annot"><span class="annottext">unBuffer :: Buffer %1 -&gt; Text
</span><a href="Data.Text.Builder.Linear.Core.html#unBuffer"><span class="hs-identifier hs-var hs-var">unBuffer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span id="local-6989586621679055266"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055266"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055266"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-comment">-- | Run a linear function on an empty 'Buffer', producing a strict 'Text'.</span><span>
</span><span id="line-77"></span><span class="hs-comment">--</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- Be careful to write @runBuffer (\\b -&gt; ...)@ instead of @runBuffer $ \\b -&gt; ...@,</span><span>
</span><span id="line-79"></span><span class="hs-comment">-- because current implementation of linear types lacks special support for '($)'.</span><span>
</span><span id="line-80"></span><span class="hs-comment">-- Another option is to enable @{-# LANGUAGE BlockArguments #-}@</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- and write @runBuffer \\b -&gt; ...@.</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- Alternatively, you can import</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- [@($)@](https://hackage.haskell.org/package/linear-base/docs/Prelude-Linear.html#v:-36-)</span><span>
</span><span id="line-84"></span><span class="hs-comment">-- from [@linear-base@](https://hackage.haskell.org/package/linear-base).</span><span>
</span><span id="line-85"></span><span class="hs-comment">--</span><span>
</span><span id="line-86"></span><span class="hs-comment">-- 'runBuffer' is similar in spirit to mutable arrays API in</span><span>
</span><span id="line-87"></span><span class="hs-comment">-- [@Data.Array.Mutable.Linear@](https://hackage.haskell.org/package/linear-base/docs/Data-Array-Mutable-Linear.html),</span><span>
</span><span id="line-88"></span><span class="hs-comment">-- which provides functions like</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- [@fromList@](https://hackage.haskell.org/package/linear-base/docs/Data-Array-Mutable-Linear.html#v:fromList) &#8759; [@a@] &#8594; (@Vector@ @a@ &#8888; [@Ur@](https://hackage.haskell.org/package/linear-base-0.3.0/docs/Prelude-Linear.html#t:Ur) b) &#8888; [@Ur@](https://hackage.haskell.org/package/linear-base-0.3.0/docs/Prelude-Linear.html#t:Ur) @b@.</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- Here the initial buffer is always empty and @b@ is 'Text'. Since 'Text' is</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- [@Movable@](https://hackage.haskell.org/package/linear-base/docs/Prelude-Linear.html#t:Movable),</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- 'Text' and [@Ur@](https://hackage.haskell.org/package/linear-base-0.3.0/docs/Prelude-Linear.html#t:Ur) 'Text' are equivalent.</span><span>
</span><span id="line-93"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#runBuffer"><span class="hs-identifier hs-type">runBuffer</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-94"></span><span id="runBuffer"><span class="annot"><span class="annottext">runBuffer :: (Buffer %1 -&gt; Buffer) %1 -&gt; Text
</span><a href="Data.Text.Builder.Linear.Core.html#runBuffer"><span class="hs-identifier hs-var hs-var">runBuffer</span></a></span></span><span> </span><span id="local-6989586621679055268"><span class="annot"><span class="annottext">Buffer %1 -&gt; Buffer
</span><a href="#local-6989586621679055268"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Buffer %1 -&gt; Text
</span><a href="Data.Text.Builder.Linear.Core.html#unBuffer"><span class="hs-identifier hs-var">unBuffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Buffer %1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#shrinkBuffer"><span class="hs-identifier hs-var">shrinkBuffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Buffer %1 -&gt; Buffer
</span><a href="#local-6989586621679055268"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="annot"><span class="annottext">Text
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#runBuffer"><span class="hs-pragma hs-type">runBuffer</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-comment">{-
  See https://github.com/Bodigrim/linear-builder/issues/19
  and https://github.com/tweag/linear-base/pull/187#discussion_r489081926
  for the discussion why NOINLINE here and below in 'runBufferBS' is necessary.
  Without it CSE (common subexpression elimination) can pull out 'Buffer's from
  different 'runBuffer's and share them, which is absolutely not what we want.
-}</span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="annot"><span class="hs-comment">-- | Same as 'runBuffer', but returning a UTF-8 encoded strict 'ByteString'.</span></span><span>
</span><span id="line-106"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#runBufferBS"><span class="hs-identifier hs-type">runBufferBS</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-107"></span><span id="runBufferBS"><span class="annot"><span class="annottext">runBufferBS :: (Buffer %1 -&gt; Buffer) %1 -&gt; ByteString
</span><a href="Data.Text.Builder.Linear.Core.html#runBufferBS"><span class="hs-identifier hs-var hs-var">runBufferBS</span></a></span></span><span> </span><span id="local-6989586621679055270"><span class="annot"><span class="annottext">Buffer %1 -&gt; Buffer
</span><a href="#local-6989586621679055270"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Buffer %1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#shrinkBuffer"><span class="hs-identifier hs-var">shrinkBuffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Buffer %1 -&gt; Buffer
</span><a href="#local-6989586621679055270"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Data.Text.Builder.Linear.Core.html#memptyPinned"><span class="hs-identifier hs-var">memptyPinned</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">A.ByteArray</span></span><span> </span><span id="local-6989586621679055273"><span class="annot"><span class="annottext">ByteArray#
</span><a href="#local-6989586621679055273"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">I#</span></span><span> </span><span id="local-6989586621679055274"><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679055274"><span class="hs-identifier hs-var">from</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679055275"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055275"><span class="hs-identifier hs-var">len</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="annottext">ForeignPtr Word8 -&gt; Int -&gt; ByteString
</span><span class="hs-identifier hs-var">BS</span></span><span> </span><span class="annot"><span class="annottext">ForeignPtr Word8
forall {a}. ForeignPtr a
</span><a href="#local-6989586621679055277"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055275"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-110"></span><span>      </span><span id="local-6989586621679055278"><span class="annot"><span class="annottext">addr# :: Addr#
</span><a href="#local-6989586621679055278"><span class="hs-identifier hs-var hs-var">addr#</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteArray# -&gt; Addr#
</span><span class="hs-identifier hs-var">byteArrayContents#</span></span><span> </span><span class="annot"><span class="annottext">ByteArray#
</span><a href="#local-6989586621679055273"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Addr# -&gt; Int# -&gt; Addr#
</span><span class="hs-operator hs-var">`plusAddr#`</span></span><span> </span><span class="annot"><span class="annottext">Int#
</span><a href="#local-6989586621679055274"><span class="hs-identifier hs-var">from</span></a></span><span>
</span><span id="line-111"></span><span>      </span><span id="local-6989586621679055277"><span class="annot"><span class="annottext">fp :: ForeignPtr a
</span><a href="#local-6989586621679055277"><span class="hs-identifier hs-var hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
forall a. Addr# -&gt; ForeignPtrContents -&gt; ForeignPtr a
</span><span class="hs-identifier hs-var">ForeignPtr</span></span><span> </span><span class="annot"><span class="annottext">Addr#
</span><a href="#local-6989586621679055278"><span class="hs-identifier hs-var">addr#</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MutableByteArray# RealWorld -&gt; ForeignPtrContents
</span><span class="hs-identifier hs-var">PlainPtr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteArray# -&gt; MutableByteArray# RealWorld
forall a b. a -&gt; b
</span><span class="hs-identifier hs-var">unsafeCoerce#</span></span><span> </span><span class="annot"><span class="annottext">ByteArray#
</span><a href="#local-6989586621679055273"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#runBufferBS"><span class="hs-pragma hs-type">runBufferBS</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#shrinkBuffer"><span class="hs-identifier hs-type">shrinkBuffer</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-115"></span><span id="shrinkBuffer"><span class="annot"><span class="annottext">shrinkBuffer :: Buffer %1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#shrinkBuffer"><span class="hs-identifier hs-var hs-var">shrinkBuffer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span id="local-6989586621679055281"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055281"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621679055282"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055282"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621679055283"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055283"><span class="hs-identifier hs-var">len</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Buffer) -&gt; Text -&gt; Buffer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(forall s. ST s Text) -&gt; Text
forall a. (forall s. ST s a) -&gt; a
</span><span class="hs-identifier hs-var">runST</span></span><span> </span><span class="annot"><span class="annottext">((forall s. ST s Text) -&gt; Text) -&gt; (forall s. ST s Text) -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>  </span><span id="local-6989586621679055291"><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055291"><span class="hs-identifier hs-var">arrM</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">Array -&gt; ST s (MArray s)
forall s. Array -&gt; ST s (MArray s)
</span><a href="Data.Text.Builder.Linear.Array.html#unsafeThaw"><span class="hs-identifier hs-var">unsafeThaw</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055281"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><span class="annottext">MArray s -&gt; Int -&gt; ST s ()
forall s. MArray s -&gt; Int -&gt; ST s ()
</span><span class="hs-identifier hs-var">A.shrinkM</span></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055291"><span class="hs-identifier hs-var">arrM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055282"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055283"><span class="hs-identifier hs-var">len</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>  </span><span id="local-6989586621679055295"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055295"><span class="hs-identifier hs-var">arr'</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; ST s Array
forall s. MArray s -&gt; ST s Array
</span><span class="hs-identifier hs-var">A.unsafeFreeze</span></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055291"><span class="hs-identifier hs-var">arrM</span></a></span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; ST s Text
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ST s Text) -&gt; Text -&gt; ST s Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Array -&gt; Int -&gt; Int -&gt; Text
</span><span class="hs-identifier hs-var">Text</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055295"><span class="hs-identifier hs-var">arr'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055282"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055283"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#memptyPinned"><span class="hs-identifier hs-type">memptyPinned</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-122"></span><span id="memptyPinned"><span class="annot"><span class="annottext">memptyPinned :: Text
</span><a href="Data.Text.Builder.Linear.Core.html#memptyPinned"><span class="hs-identifier hs-var hs-var">memptyPinned</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall s. ST s Text) -&gt; Text
forall a. (forall s. ST s a) -&gt; a
</span><span class="hs-identifier hs-var">runST</span></span><span> </span><span class="annot"><span class="annottext">((forall s. ST s Text) -&gt; Text) -&gt; (forall s. ST s Text) -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-123"></span><span>  </span><span id="local-6989586621679055300"><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055300"><span class="hs-identifier hs-var">marr</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s (MArray s)
forall s. Int -&gt; ST s (MArray s)
</span><span class="hs-identifier hs-var">A.newPinned</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-124"></span><span>  </span><span id="local-6989586621679055302"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055302"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; ST s Array
forall s. MArray s -&gt; ST s Array
</span><span class="hs-identifier hs-var">A.unsafeFreeze</span></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055300"><span class="hs-identifier hs-var">marr</span></a></span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; ST s Text
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ST s Text) -&gt; Text -&gt; ST s Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Array -&gt; Int -&gt; Int -&gt; Text
</span><span class="hs-identifier hs-var">Text</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055302"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">-- | Create an empty 'Buffer'.</span><span>
</span><span id="line-128"></span><span class="hs-comment">--</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- The first 'Buffer' is the input and the second is a new empty 'Buffer'.</span><span>
</span><span id="line-130"></span><span class="hs-comment">--</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- This function is needed in some situations, e.g. with</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- 'Data.Text.Builder.Linear.Buffer.justifyRight'. The following example creates</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- a utility function that justify a text and then append it to a buffer.</span><span>
</span><span id="line-134"></span><span class="hs-comment">--</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- &gt;&gt;&gt; :set -XOverloadedStrings -XLinearTypes -XUnboxedTuples</span><span>
</span><span id="line-136"></span><span class="hs-comment">-- &gt;&gt;&gt; import Data.Text.Builder.Linear.Buffer</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- &gt;&gt;&gt; import Data.Text (Text)</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- &gt;&gt;&gt; :{</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- appendJustified :: Buffer %1 -&gt; Text -&gt; Buffer</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- appendJustified b t = case newEmptyBuffer b of</span><span>
</span><span id="line-141"></span><span class="hs-comment">--   -- Note that we need to create a new buffer from the text, in order</span><span>
</span><span id="line-142"></span><span class="hs-comment">--   -- to justify only the text and not the input buffer.</span><span>
</span><span id="line-143"></span><span class="hs-comment">--   (# b', empty #) -&gt; b' &gt;&lt; justifyRight 12 ' ' (empty |&gt; t)</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- :}</span><span>
</span><span id="line-145"></span><span class="hs-comment">--</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- &gt;&gt;&gt; runBuffer (\b -&gt; (b |&gt; &quot;Test:&quot;) `appendJustified` &quot;foo&quot; `appendJustified` &quot;bar&quot;)</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- &quot;Test:         foo         bar&quot;</span><span>
</span><span id="line-148"></span><span class="hs-comment">--</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- Note: a previous buffer is necessary in order to create an empty buffer with</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- the same characteristics.</span><span>
</span><span id="line-151"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#newEmptyBuffer"><span class="hs-identifier hs-type">newEmptyBuffer</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-152"></span><span id="newEmptyBuffer"><span class="annot"><span class="annottext">newEmptyBuffer :: Buffer %1 -&gt; (# Buffer, Buffer #)
</span><a href="Data.Text.Builder.Linear.Core.html#newEmptyBuffer"><span class="hs-identifier hs-var hs-var">newEmptyBuffer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span id="local-6989586621679055303"><span class="annot"><span class="annottext">t :: Text
</span><a href="#local-6989586621679055303"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span id="local-6989586621679055304"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055304"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055303"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Array -&gt; Bool
</span><a href="Data.Text.Builder.Linear.Array.html#isPinned"><span class="hs-identifier hs-var">isPinned</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055304"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Data.Text.Builder.Linear.Core.html#memptyPinned"><span class="hs-identifier hs-var">memptyPinned</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Text
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span class="hs-comment">-- | Duplicate builder. Feel free to process results in parallel threads.</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- Similar to</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- [@Dupable@](https://hackage.haskell.org/package/linear-base/docs/Prelude-Linear.html#t:Dupable)</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- from [@linear-base@](https://hackage.haskell.org/package/linear-base).</span><span>
</span><span id="line-159"></span><span class="hs-comment">--</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- It is a bit tricky to use because of</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- &lt;https://ghc.gitlab.haskell.org/ghc/doc/users_guide/exts/linear_types.html#limitations current limitations&gt;</span><span>
</span><span id="line-162"></span><span class="hs-comment">-- of linear types with regards to @let@ and @where@. E. g., one cannot write</span><span>
</span><span id="line-163"></span><span class="hs-comment">--</span><span>
</span><span id="line-164"></span><span class="hs-comment">-- &gt; let (# b1, b2 #) = dupBuffer b in (&quot;foo&quot; &lt;| b1) &gt;&lt; (b2 |&gt; &quot;bar&quot;)</span><span>
</span><span id="line-165"></span><span class="hs-comment">--</span><span>
</span><span id="line-166"></span><span class="hs-comment">-- Instead write:</span><span>
</span><span id="line-167"></span><span class="hs-comment">--</span><span>
</span><span id="line-168"></span><span class="hs-comment">-- &gt;&gt;&gt; :set -XOverloadedStrings -XLinearTypes -XUnboxedTuples</span><span>
</span><span id="line-169"></span><span class="hs-comment">-- &gt;&gt;&gt; import Data.Text.Builder.Linear.Buffer</span><span>
</span><span id="line-170"></span><span class="hs-comment">-- &gt;&gt;&gt; runBuffer (\b -&gt; case dupBuffer b of (# b1, b2 #) -&gt; (&quot;foo&quot; &lt;| b1) &gt;&lt; (b2 |&gt; &quot;bar&quot;))</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- &quot;foobar&quot;</span><span>
</span><span id="line-172"></span><span class="hs-comment">--</span><span>
</span><span id="line-173"></span><span class="hs-comment">-- Note the unboxed tuple: 'Buffer' is an unlifted datatype,</span><span>
</span><span id="line-174"></span><span class="hs-comment">-- so it cannot be put into @(..., ...)@.</span><span>
</span><span id="line-175"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#dupBuffer"><span class="hs-identifier hs-type">dupBuffer</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-176"></span><span id="dupBuffer"><span class="annot"><span class="annottext">dupBuffer :: Buffer %1 -&gt; (# Buffer, Buffer #)
</span><a href="Data.Text.Builder.Linear.Core.html#dupBuffer"><span class="hs-identifier hs-var hs-var">dupBuffer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span id="local-6989586621679055306"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055306"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055306"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">T.copy</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055306"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="hs-comment">-- | Consume buffer linearly,</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- similar to</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- [@Consumable@](https://hackage.haskell.org/package/linear-base/docs/Prelude-Linear.html#t:Consumable)</span><span>
</span><span id="line-181"></span><span class="hs-comment">-- from [@linear-base@](https://hackage.haskell.org/package/linear-base).</span><span>
</span><span id="line-182"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#consumeBuffer"><span class="hs-identifier hs-type">consumeBuffer</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span id="consumeBuffer"><span class="annot"><span class="annottext">consumeBuffer :: Buffer %1 -&gt; ()
</span><a href="Data.Text.Builder.Linear.Core.html#consumeBuffer"><span class="hs-identifier hs-var hs-var">consumeBuffer</span></a></span></span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span class="annot"><span class="hs-comment">-- | Erase buffer's content, replacing it with an empty 'Text'.</span></span><span>
</span><span id="line-186"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#eraseBuffer"><span class="hs-identifier hs-type">eraseBuffer</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-187"></span><span id="eraseBuffer"><span class="annot"><span class="annottext">eraseBuffer :: Buffer %1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#eraseBuffer"><span class="hs-identifier hs-var hs-var">eraseBuffer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span id="local-6989586621679055308"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055308"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Array -&gt; Bool
</span><a href="Data.Text.Builder.Linear.Array.html#isPinned"><span class="hs-identifier hs-var">isPinned</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055308"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="Data.Text.Builder.Linear.Core.html#memptyPinned"><span class="hs-identifier hs-var">memptyPinned</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Text
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-comment">-- | Return buffer's size in __bytes__ (not in 'Char's).</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- This could be useful to implement a lazy builder atop of a strict one.</span><span>
</span><span id="line-192"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#byteSizeOfBuffer"><span class="hs-identifier hs-type">byteSizeOfBuffer</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-193"></span><span id="byteSizeOfBuffer"><span class="annot"><span class="annottext">byteSizeOfBuffer :: Buffer %1 -&gt; (# Buffer, Word #)
</span><a href="Data.Text.Builder.Linear.Core.html#byteSizeOfBuffer"><span class="hs-identifier hs-var hs-var">byteSizeOfBuffer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span id="local-6989586621679055309"><span class="annot"><span class="annottext">t :: Text
</span><a href="#local-6989586621679055309"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679055310"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055310"><span class="hs-identifier hs-var">len</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055309"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055310"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">-- | Return buffer's length in 'Char's (not in bytes).</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- This could be useful to implement @dropEndBuffer@ and @takeEndBuffer@, e. g.,</span><span>
</span><span id="line-197"></span><span class="hs-comment">--</span><span>
</span><span id="line-198"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- import Data.Unrestricted.Linear</span><span>
</span><span id="line-200"></span><span class="hs-comment">--</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- dropEndBuffer :: Word -&gt; Buffer %1 -&gt; Buffer</span><span>
</span><span id="line-202"></span><span class="hs-comment">-- dropEndBuffer n buf = case lengthOfBuffer buf of</span><span>
</span><span id="line-203"></span><span class="hs-comment">--   (# buf', len #) -&gt; case move len of</span><span>
</span><span id="line-204"></span><span class="hs-comment">--     Ur len' -&gt; takeBuffer (len' - n) buf'</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-206"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#lengthOfBuffer"><span class="hs-identifier hs-type">lengthOfBuffer</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-207"></span><span id="lengthOfBuffer"><span class="annot"><span class="annottext">lengthOfBuffer :: Buffer %1 -&gt; (# Buffer, Word #)
</span><a href="Data.Text.Builder.Linear.Core.html#lengthOfBuffer"><span class="hs-identifier hs-var hs-var">lengthOfBuffer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span id="local-6989586621679055311"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055311"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(#</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055311"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Int
</span><span class="hs-identifier hs-var">T.length</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055311"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">#)</span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span class="annot"><span class="hs-comment">-- | Slice 'Buffer' by dropping given number of 'Char's.</span></span><span>
</span><span id="line-210"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#dropBuffer"><span class="hs-identifier hs-type">dropBuffer</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-211"></span><span id="dropBuffer"><span class="annot"><span class="annottext">dropBuffer :: Word -&gt; Buffer %1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#dropBuffer"><span class="hs-identifier hs-var hs-var">dropBuffer</span></a></span></span><span> </span><span id="local-6989586621679055313"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679055313"><span class="hs-identifier hs-var">nChar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span id="local-6989586621679055314"><span class="annot"><span class="annottext">t :: Text
</span><a href="#local-6989586621679055314"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span id="local-6989586621679055315"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055315"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621679055316"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055316"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621679055317"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055317"><span class="hs-identifier hs-var">len</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055318"><span class="hs-identifier hs-var">nByte</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Array -&gt; Int -&gt; Int -&gt; Text
</span><span class="hs-identifier hs-var">Text</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055315"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055316"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055317"><span class="hs-identifier hs-var">len</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Array -&gt; Int -&gt; Int -&gt; Text
</span><span class="hs-identifier hs-var">Text</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055315"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055316"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055318"><span class="hs-identifier hs-var">nByte</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055317"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055318"><span class="hs-identifier hs-var">nByte</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-215"></span><span>    </span><span id="local-6989586621679055318"><span class="annot"><span class="annottext">nByte :: Int
</span><a href="#local-6989586621679055318"><span class="hs-identifier hs-var hs-var">nByte</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text -&gt; Int
</span><span class="hs-identifier hs-var">T.measureOff</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679055313"><span class="hs-identifier hs-var">nChar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055314"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="annot"><span class="hs-comment">-- | Slice 'Buffer' by taking given number of 'Char's.</span></span><span>
</span><span id="line-218"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#takeBuffer"><span class="hs-identifier hs-type">takeBuffer</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word</span></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-219"></span><span id="takeBuffer"><span class="annot"><span class="annottext">takeBuffer :: Word -&gt; Buffer %1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#takeBuffer"><span class="hs-identifier hs-var hs-var">takeBuffer</span></a></span></span><span> </span><span id="local-6989586621679055324"><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679055324"><span class="hs-identifier hs-var">nChar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span id="local-6989586621679055325"><span class="annot"><span class="annottext">t :: Text
</span><a href="#local-6989586621679055325"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span id="local-6989586621679055326"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055326"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621679055327"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055327"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055328"><span class="hs-identifier hs-var">nByte</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055325"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Array -&gt; Int -&gt; Int -&gt; Text
</span><span class="hs-identifier hs-var">Text</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055326"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055327"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055328"><span class="hs-identifier hs-var">nByte</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-223"></span><span>    </span><span id="local-6989586621679055328"><span class="annot"><span class="annottext">nByte :: Int
</span><a href="#local-6989586621679055328"><span class="hs-identifier hs-var hs-var">nByte</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Text -&gt; Int
</span><span class="hs-identifier hs-var">T.measureOff</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Word
</span><a href="#local-6989586621679055324"><span class="hs-identifier hs-var">nChar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679055325"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="annot"><span class="hs-comment">-- | Low-level routine to append data of unknown size to a 'Buffer'.</span></span><span>
</span><span id="line-226"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#appendBounded"><span class="hs-identifier hs-type">appendBounded</span></a></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-228"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Upper bound for the number of bytes, written by an action</span></span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">&#8704;</span><span> </span><span id="local-6989586621679055215"><span class="annot"><a href="#local-6989586621679055215"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">A.MArray</span></span><span> </span><span class="annot"><a href="#local-6989586621679055215"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679055215"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-comment">-- ^ Action, which writes bytes __starting__ from the given offset</span><span>
</span><span id="line-231"></span><span>  </span><span class="hs-comment">-- and returns an actual number of bytes written.</span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-234"></span><span id="appendBounded"><span class="annot"><span class="annottext">appendBounded :: Int
-&gt; (forall s. MArray s -&gt; Int -&gt; ST s Int) -&gt; Buffer %1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#appendBounded"><span class="hs-identifier hs-var hs-var">appendBounded</span></a></span></span><span> </span><span id="local-6989586621679055331"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055331"><span class="hs-identifier hs-var">maxSrcLen</span></a></span></span><span> </span><span id="local-6989586621679055332"><span class="annot"><span class="annottext">forall s. MArray s -&gt; Int -&gt; ST s Int
</span><a href="#local-6989586621679055332"><span class="hs-identifier hs-var">appender</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span id="local-6989586621679055333"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055333"><span class="hs-identifier hs-var">dst</span></a></span></span><span> </span><span id="local-6989586621679055334"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055334"><span class="hs-identifier hs-var">dstOff</span></a></span></span><span> </span><span id="local-6989586621679055335"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055335"><span class="hs-identifier hs-var">dstLen</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Buffer) -&gt; Text -&gt; Buffer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(forall s. ST s Text) -&gt; Text
forall a. (forall s. ST s a) -&gt; a
</span><span class="hs-identifier hs-var">runST</span></span><span> </span><span class="annot"><span class="annottext">((forall s. ST s Text) -&gt; Text) -&gt; (forall s. ST s Text) -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679055348"><span class="annot"><span class="annottext">dstFullLen :: Int
</span><a href="#local-6989586621679055348"><span class="hs-identifier hs-var hs-var">dstFullLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Array -&gt; Int
</span><a href="Data.Text.Builder.Linear.Array.html#sizeofByteArray"><span class="hs-identifier hs-var">sizeofByteArray</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055333"><span class="hs-identifier hs-var">dst</span></a></span><span>
</span><span id="line-236"></span><span>      </span><span id="local-6989586621679055354"><span class="annot"><span class="annottext">newFullLen :: Int
</span><a href="#local-6989586621679055354"><span class="hs-identifier hs-var hs-var">newFullLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055334"><span class="hs-identifier hs-var">dstOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055335"><span class="hs-identifier hs-var">dstLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055331"><span class="hs-identifier hs-var">maxSrcLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>  </span><span id="local-6989586621679055356"><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055356"><span class="hs-identifier hs-var">newM</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055334"><span class="hs-identifier hs-var">dstOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055335"><span class="hs-identifier hs-var">dstLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055331"><span class="hs-identifier hs-var">maxSrcLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055348"><span class="hs-identifier hs-var">dstFullLen</span></a></span><span>
</span><span id="line-239"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Array -&gt; ST s (MArray s)
forall s. Array -&gt; ST s (MArray s)
</span><a href="Data.Text.Builder.Linear.Array.html#unsafeThaw"><span class="hs-identifier hs-var">unsafeThaw</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055333"><span class="hs-identifier hs-var">dst</span></a></span><span>
</span><span id="line-240"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-241"></span><span>        </span><span id="local-6989586621679055357"><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055357"><span class="hs-identifier hs-var">tmpM</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Array -&gt; Bool
</span><a href="Data.Text.Builder.Linear.Array.html#isPinned"><span class="hs-identifier hs-var">isPinned</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055333"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s (MArray s)
forall s. Int -&gt; ST s (MArray s)
</span><span class="hs-identifier hs-var">A.newPinned</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s (MArray s)
forall s. Int -&gt; ST s (MArray s)
</span><span class="hs-identifier hs-var">A.new</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055354"><span class="hs-identifier hs-var">newFullLen</span></a></span><span>
</span><span id="line-242"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; MArray s -&gt; Int -&gt; Array -&gt; Int -&gt; ST s ()
forall s. Int -&gt; MArray s -&gt; Int -&gt; Array -&gt; Int -&gt; ST s ()
</span><span class="hs-identifier hs-var">A.copyI</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055335"><span class="hs-identifier hs-var">dstLen</span></a></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055357"><span class="hs-identifier hs-var">tmpM</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055334"><span class="hs-identifier hs-var">dstOff</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055333"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055334"><span class="hs-identifier hs-var">dstOff</span></a></span><span>
</span><span id="line-243"></span><span>        </span><span class="annot"><span class="annottext">MArray s -&gt; ST s (MArray s)
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055357"><span class="hs-identifier hs-var">tmpM</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span id="local-6989586621679055360"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055360"><span class="hs-identifier hs-var">srcLen</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; Int -&gt; ST s Int
forall s. MArray s -&gt; Int -&gt; ST s Int
</span><a href="#local-6989586621679055332"><span class="hs-identifier hs-var">appender</span></a></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055356"><span class="hs-identifier hs-var">newM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055334"><span class="hs-identifier hs-var">dstOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055335"><span class="hs-identifier hs-var">dstLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>  </span><span id="local-6989586621679055361"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055361"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; ST s Array
forall s. MArray s -&gt; ST s Array
</span><span class="hs-identifier hs-var">A.unsafeFreeze</span></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055356"><span class="hs-identifier hs-var">newM</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; ST s Text
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ST s Text) -&gt; Text -&gt; ST s Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Array -&gt; Int -&gt; Int -&gt; Text
</span><span class="hs-identifier hs-var">Text</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055361"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055334"><span class="hs-identifier hs-var">dstOff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055335"><span class="hs-identifier hs-var">dstLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055360"><span class="hs-identifier hs-var">srcLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#appendBounded"><span class="hs-pragma hs-type">appendBounded</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span class="annot"><span class="hs-comment">-- | Low-level routine to append data of known size to a 'Buffer'.</span></span><span>
</span><span id="line-250"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#appendExact"><span class="hs-identifier hs-type">appendExact</span></a></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Exact number of bytes, written by an action</span></span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">&#8704;</span><span> </span><span id="local-6989586621679055362"><span class="annot"><a href="#local-6989586621679055362"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">A.MArray</span></span><span> </span><span class="annot"><a href="#local-6989586621679055362"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679055362"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Action, which writes bytes __starting__ from the given offset</span></span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-257"></span><span id="appendExact"><span class="annot"><span class="annottext">appendExact :: Int
-&gt; (forall s. MArray s -&gt; Int -&gt; ST s ()) -&gt; Buffer %1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#appendExact"><span class="hs-identifier hs-var hs-var">appendExact</span></a></span></span><span> </span><span id="local-6989586621679055363"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055363"><span class="hs-identifier hs-var">srcLen</span></a></span></span><span> </span><span id="local-6989586621679055364"><span class="annot"><span class="annottext">forall s. MArray s -&gt; Int -&gt; ST s ()
</span><a href="#local-6989586621679055364"><span class="hs-identifier hs-var">appender</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><span class="annottext">Int
-&gt; (forall s. MArray s -&gt; Int -&gt; ST s Int) -&gt; Buffer %1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#appendBounded"><span class="hs-identifier hs-var">appendBounded</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055363"><span class="hs-identifier hs-var">srcLen</span></a></span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679055367"><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055367"><span class="hs-identifier hs-var">dst</span></a></span></span><span> </span><span id="local-6989586621679055368"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055368"><span class="hs-identifier hs-var">dstOff</span></a></span></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; Int -&gt; ST s ()
forall s. MArray s -&gt; Int -&gt; ST s ()
</span><a href="#local-6989586621679055364"><span class="hs-identifier hs-var">appender</span></a></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055367"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055368"><span class="hs-identifier hs-var">dstOff</span></a></span><span> </span><span class="annot"><span class="annottext">ST s () -&gt; ST s Int -&gt; ST s Int
forall a b. ST s a -&gt; ST s b -&gt; ST s b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s Int
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055363"><span class="hs-identifier hs-var">srcLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#appendExact"><span class="hs-pragma hs-type">appendExact</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span class="annot"><span class="hs-comment">-- | Low-level routine to prepend data of unknown size to a 'Buffer'.</span></span><span>
</span><span id="line-264"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#prependBounded"><span class="hs-identifier hs-type">prependBounded</span></a></span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-266"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Upper bound for the number of bytes, written by an action</span></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">&#8704;</span><span> </span><span id="local-6989586621679055369"><span class="annot"><a href="#local-6989586621679055369"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">A.MArray</span></span><span> </span><span class="annot"><a href="#local-6989586621679055369"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679055369"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-comment">-- ^ Action, which writes bytes __finishing__ before the given offset</span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-comment">-- and returns an actual number of bytes written.</span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">&#8704;</span><span> </span><span id="local-6989586621679055370"><span class="annot"><a href="#local-6989586621679055370"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">A.MArray</span></span><span> </span><span class="annot"><a href="#local-6989586621679055370"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679055370"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-comment">-- ^ Action, which writes bytes __starting__ from the given offset</span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-comment">-- and returns an actual number of bytes written.</span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-275"></span><span id="prependBounded"><span class="annot"><span class="annottext">prependBounded :: Int
-&gt; (forall s. MArray s -&gt; Int -&gt; ST s Int)
-&gt; (forall s. MArray s -&gt; Int -&gt; ST s Int)
-&gt; Buffer
%1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#prependBounded"><span class="hs-identifier hs-var hs-var">prependBounded</span></a></span></span><span> </span><span id="local-6989586621679055371"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055371"><span class="hs-identifier hs-var">maxSrcLen</span></a></span></span><span> </span><span id="local-6989586621679055372"><span class="annot"><span class="annottext">forall s. MArray s -&gt; Int -&gt; ST s Int
</span><a href="#local-6989586621679055372"><span class="hs-identifier hs-var">prepender</span></a></span></span><span> </span><span id="local-6989586621679055373"><span class="annot"><span class="annottext">forall s. MArray s -&gt; Int -&gt; ST s Int
</span><a href="#local-6989586621679055373"><span class="hs-identifier hs-var">appender</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span id="local-6989586621679055374"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055374"><span class="hs-identifier hs-var">dst</span></a></span></span><span> </span><span id="local-6989586621679055375"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055375"><span class="hs-identifier hs-var">dstOff</span></a></span></span><span> </span><span id="local-6989586621679055376"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055376"><span class="hs-identifier hs-var">dstLen</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055371"><span class="hs-identifier hs-var">maxSrcLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055375"><span class="hs-identifier hs-var">dstOff</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Buffer) -&gt; Text -&gt; Buffer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(forall s. ST s Text) -&gt; Text
forall a. (forall s. ST s a) -&gt; a
</span><span class="hs-identifier hs-var">runST</span></span><span> </span><span class="annot"><span class="annottext">((forall s. ST s Text) -&gt; Text) -&gt; (forall s. ST s Text) -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-277"></span><span>      </span><span id="local-6989586621679055383"><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055383"><span class="hs-identifier hs-var">newM</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">Array -&gt; ST s (MArray s)
forall s. Array -&gt; ST s (MArray s)
</span><a href="Data.Text.Builder.Linear.Array.html#unsafeThaw"><span class="hs-identifier hs-var">unsafeThaw</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055374"><span class="hs-identifier hs-var">dst</span></a></span><span>
</span><span id="line-278"></span><span>      </span><span id="local-6989586621679055384"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055384"><span class="hs-identifier hs-var">srcLen</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; Int -&gt; ST s Int
forall s. MArray s -&gt; Int -&gt; ST s Int
</span><a href="#local-6989586621679055372"><span class="hs-identifier hs-var">prepender</span></a></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055383"><span class="hs-identifier hs-var">newM</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055375"><span class="hs-identifier hs-var">dstOff</span></a></span><span>
</span><span id="line-279"></span><span>      </span><span id="local-6989586621679055385"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055385"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; ST s Array
forall s. MArray s -&gt; ST s Array
</span><span class="hs-identifier hs-var">A.unsafeFreeze</span></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055383"><span class="hs-identifier hs-var">newM</span></a></span><span>
</span><span id="line-280"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; ST s Text
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ST s Text) -&gt; Text -&gt; ST s Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Array -&gt; Int -&gt; Int -&gt; Text
</span><span class="hs-identifier hs-var">Text</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055385"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055375"><span class="hs-identifier hs-var">dstOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055384"><span class="hs-identifier hs-var">srcLen</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055384"><span class="hs-identifier hs-var">srcLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055376"><span class="hs-identifier hs-var">dstLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Buffer) -&gt; Text -&gt; Buffer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(forall s. ST s Text) -&gt; Text
forall a. (forall s. ST s a) -&gt; a
</span><span class="hs-identifier hs-var">runST</span></span><span> </span><span class="annot"><span class="annottext">((forall s. ST s Text) -&gt; Text) -&gt; (forall s. ST s Text) -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679055393"><span class="annot"><span class="annottext">dstFullLen :: Int
</span><a href="#local-6989586621679055393"><span class="hs-identifier hs-var hs-var">dstFullLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Array -&gt; Int
</span><a href="Data.Text.Builder.Linear.Array.html#sizeofByteArray"><span class="hs-identifier hs-var">sizeofByteArray</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055374"><span class="hs-identifier hs-var">dst</span></a></span><span>
</span><span id="line-283"></span><span>          </span><span id="local-6989586621679055395"><span class="annot"><span class="annottext">newOff :: Int
</span><a href="#local-6989586621679055395"><span class="hs-identifier hs-var hs-var">newOff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055376"><span class="hs-identifier hs-var">dstLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055371"><span class="hs-identifier hs-var">maxSrcLen</span></a></span><span>
</span><span id="line-284"></span><span>          </span><span id="local-6989586621679055401"><span class="annot"><span class="annottext">newFullLen :: Int
</span><a href="#local-6989586621679055401"><span class="hs-identifier hs-var hs-var">newFullLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055395"><span class="hs-identifier hs-var">newOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055393"><span class="hs-identifier hs-var">dstFullLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055375"><span class="hs-identifier hs-var">dstOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055376"><span class="hs-identifier hs-var">dstLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>      </span><span id="local-6989586621679055402"><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055402"><span class="hs-identifier hs-var">newM</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Array -&gt; Bool
</span><a href="Data.Text.Builder.Linear.Array.html#isPinned"><span class="hs-identifier hs-var">isPinned</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055374"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s (MArray s)
forall s. Int -&gt; ST s (MArray s)
</span><span class="hs-identifier hs-var">A.newPinned</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s (MArray s)
forall s. Int -&gt; ST s (MArray s)
</span><span class="hs-identifier hs-var">A.new</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055401"><span class="hs-identifier hs-var">newFullLen</span></a></span><span>
</span><span id="line-286"></span><span>      </span><span id="local-6989586621679055403"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055403"><span class="hs-identifier hs-var">srcLen</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; Int -&gt; ST s Int
forall s. MArray s -&gt; Int -&gt; ST s Int
</span><a href="#local-6989586621679055373"><span class="hs-identifier hs-var">appender</span></a></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055402"><span class="hs-identifier hs-var">newM</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055395"><span class="hs-identifier hs-var">newOff</span></a></span><span>
</span><span id="line-287"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; MArray s -&gt; Int -&gt; Array -&gt; Int -&gt; ST s ()
forall s. Int -&gt; MArray s -&gt; Int -&gt; Array -&gt; Int -&gt; ST s ()
</span><span class="hs-identifier hs-var">A.copyI</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055376"><span class="hs-identifier hs-var">dstLen</span></a></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055402"><span class="hs-identifier hs-var">newM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055395"><span class="hs-identifier hs-var">newOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055403"><span class="hs-identifier hs-var">srcLen</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055374"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055375"><span class="hs-identifier hs-var">dstOff</span></a></span><span>
</span><span id="line-288"></span><span>      </span><span id="local-6989586621679055404"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055404"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; ST s Array
forall s. MArray s -&gt; ST s Array
</span><span class="hs-identifier hs-var">A.unsafeFreeze</span></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055402"><span class="hs-identifier hs-var">newM</span></a></span><span>
</span><span id="line-289"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; ST s Text
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ST s Text) -&gt; Text -&gt; ST s Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Array -&gt; Int -&gt; Int -&gt; Text
</span><span class="hs-identifier hs-var">Text</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055404"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055395"><span class="hs-identifier hs-var">newOff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055376"><span class="hs-identifier hs-var">dstLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055403"><span class="hs-identifier hs-var">srcLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#prependBounded"><span class="hs-pragma hs-type">prependBounded</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span class="annot"><span class="hs-comment">-- | Low-level routine to append data of known size to a 'Buffer'.</span></span><span>
</span><span id="line-293"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#prependExact"><span class="hs-identifier hs-type">prependExact</span></a></span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-295"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Exact number of bytes, written by an action</span></span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-glyph">&#8594;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">&#8704;</span><span> </span><span id="local-6989586621679055405"><span class="annot"><a href="#local-6989586621679055405"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">A.MArray</span></span><span> </span><span class="annot"><a href="#local-6989586621679055405"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ST</span></span><span> </span><span class="annot"><a href="#local-6989586621679055405"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Action, which writes bytes __starting__ from the given offset</span></span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-300"></span><span id="prependExact"><span class="annot"><span class="annottext">prependExact :: Int
-&gt; (forall s. MArray s -&gt; Int -&gt; ST s ()) -&gt; Buffer %1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#prependExact"><span class="hs-identifier hs-var hs-var">prependExact</span></a></span></span><span> </span><span id="local-6989586621679055406"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055406"><span class="hs-identifier hs-var">srcLen</span></a></span></span><span> </span><span id="local-6989586621679055407"><span class="annot"><span class="annottext">forall s. MArray s -&gt; Int -&gt; ST s ()
</span><a href="#local-6989586621679055407"><span class="hs-identifier hs-var">appender</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-301"></span><span>  </span><span class="annot"><span class="annottext">Int
-&gt; (forall s. MArray s -&gt; Int -&gt; ST s Int)
-&gt; (forall s. MArray s -&gt; Int -&gt; ST s Int)
-&gt; Buffer
%1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#prependBounded"><span class="hs-identifier hs-var">prependBounded</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055406"><span class="hs-identifier hs-var">srcLen</span></a></span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679055411"><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055411"><span class="hs-identifier hs-var">dst</span></a></span></span><span> </span><span id="local-6989586621679055412"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055412"><span class="hs-identifier hs-var">dstOff</span></a></span></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; Int -&gt; ST s ()
forall s. MArray s -&gt; Int -&gt; ST s ()
</span><a href="#local-6989586621679055407"><span class="hs-identifier hs-var">appender</span></a></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055411"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055412"><span class="hs-identifier hs-var">dstOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055406"><span class="hs-identifier hs-var">srcLen</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ST s () -&gt; ST s Int -&gt; ST s Int
forall a b. ST s a -&gt; ST s b -&gt; ST s b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s Int
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055406"><span class="hs-identifier hs-var">srcLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679055415"><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055415"><span class="hs-identifier hs-var">dst</span></a></span></span><span> </span><span id="local-6989586621679055416"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055416"><span class="hs-identifier hs-var">dstOff</span></a></span></span><span> </span><span class="hs-glyph">&#8594;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; Int -&gt; ST s ()
forall s. MArray s -&gt; Int -&gt; ST s ()
</span><a href="#local-6989586621679055407"><span class="hs-identifier hs-var">appender</span></a></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055415"><span class="hs-identifier hs-var">dst</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055416"><span class="hs-identifier hs-var">dstOff</span></a></span><span> </span><span class="annot"><span class="annottext">ST s () -&gt; ST s Int -&gt; ST s Int
forall a b. ST s a -&gt; ST s b -&gt; ST s b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s Int
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055406"><span class="hs-identifier hs-var">srcLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#prependExact"><span class="hs-pragma hs-type">prependExact</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span class="hs-comment">-- | Concatenate two 'Buffer's, potentially mutating both of them.</span><span>
</span><span id="line-308"></span><span class="hs-comment">--</span><span>
</span><span id="line-309"></span><span class="hs-comment">-- You likely need to use 'dupBuffer' to get hold on two builders at once:</span><span>
</span><span id="line-310"></span><span class="hs-comment">--</span><span>
</span><span id="line-311"></span><span class="hs-comment">-- &gt;&gt;&gt; :set -XOverloadedStrings -XLinearTypes -XUnboxedTuples</span><span>
</span><span id="line-312"></span><span class="hs-comment">-- &gt;&gt;&gt; import Data.Text.Builder.Linear.Buffer</span><span>
</span><span id="line-313"></span><span class="hs-comment">-- &gt;&gt;&gt; runBuffer (\b -&gt; case dupBuffer b of (# b1, b2 #) -&gt; (&quot;foo&quot; &lt;| b1) &gt;&lt; (b2 |&gt; &quot;bar&quot;))</span><span>
</span><span id="line-314"></span><span class="hs-comment">-- &quot;foobar&quot;</span><span>
</span><span id="line-315"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#%3E%3C"><span class="hs-operator hs-type">(&gt;&lt;)</span></a></span><span> </span><span class="hs-glyph">&#8759;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-glyph">&#8888;</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span class="hs-keyword">infix</span><span> </span><span class="hs-number">6</span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#%3E%3C"><span class="hs-operator hs-type">&gt;&lt;</span></a></span><span>
</span><span id="line-318"></span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span id="local-6989586621679055417"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055417"><span class="hs-identifier hs-var">left</span></a></span></span><span> </span><span id="local-6989586621679055418"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055418"><span class="hs-identifier hs-var">leftOff</span></a></span></span><span> </span><span id="local-6989586621679055419"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span></span><span class="hs-special">)</span><span> </span><span id="%3E%3C"><span class="annot"><span class="annottext">&gt;&lt; :: Buffer %1 -&gt; Buffer %1 -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#%3E%3C"><span class="hs-operator hs-var hs-var">&gt;&lt;</span></a></span></span><span> </span><span class="annot"><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-type">Buffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span id="local-6989586621679055420"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055420"><span class="hs-identifier hs-var">right</span></a></span></span><span> </span><span id="local-6989586621679055421"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055421"><span class="hs-identifier hs-var">rightOff</span></a></span></span><span> </span><span id="local-6989586621679055422"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055422"><span class="hs-identifier hs-var">rightLen</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Buffer
</span><a href="Data.Text.Builder.Linear.Core.html#Buffer"><span class="hs-identifier hs-var">Buffer</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Buffer) -&gt; Text -&gt; Buffer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(forall s. ST s Text) -&gt; Text
forall a. (forall s. ST s a) -&gt; a
</span><span class="hs-identifier hs-var">runST</span></span><span> </span><span class="annot"><span class="annottext">((forall s. ST s Text) -&gt; Text) -&gt; (forall s. ST s Text) -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679055443"><span class="annot"><span class="annottext">leftFullLen :: Int
</span><a href="#local-6989586621679055443"><span class="hs-identifier hs-var hs-var">leftFullLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Array -&gt; Int
</span><a href="Data.Text.Builder.Linear.Array.html#sizeofByteArray"><span class="hs-identifier hs-var">sizeofByteArray</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055417"><span class="hs-identifier hs-var">left</span></a></span><span>
</span><span id="line-320"></span><span>      </span><span id="local-6989586621679055444"><span class="annot"><span class="annottext">rightFullLen :: Int
</span><a href="#local-6989586621679055444"><span class="hs-identifier hs-var hs-var">rightFullLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Array -&gt; Int
</span><a href="Data.Text.Builder.Linear.Array.html#sizeofByteArray"><span class="hs-identifier hs-var">sizeofByteArray</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055420"><span class="hs-identifier hs-var">right</span></a></span><span>
</span><span id="line-321"></span><span>      </span><span id="local-6989586621679055448"><span class="annot"><span class="annottext">canCopyToLeft :: Bool
</span><a href="#local-6989586621679055448"><span class="hs-identifier hs-var hs-var">canCopyToLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055418"><span class="hs-identifier hs-var">leftOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055422"><span class="hs-identifier hs-var">rightLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055443"><span class="hs-identifier hs-var">leftFullLen</span></a></span><span>
</span><span id="line-322"></span><span>      </span><span id="local-6989586621679055450"><span class="annot"><span class="annottext">canCopyToRight :: Bool
</span><a href="#local-6989586621679055450"><span class="hs-identifier hs-var hs-var">canCopyToRight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055421"><span class="hs-identifier hs-var">rightOff</span></a></span><span>
</span><span id="line-323"></span><span>      </span><span id="local-6989586621679055452"><span class="annot"><span class="annottext">shouldCopyToLeft :: Bool
</span><a href="#local-6989586621679055452"><span class="hs-identifier hs-var hs-var">shouldCopyToLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679055448"><span class="hs-identifier hs-var">canCopyToLeft</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679055450"><span class="hs-identifier hs-var">canCopyToRight</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055422"><span class="hs-identifier hs-var">rightLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679055452"><span class="hs-identifier hs-var">shouldCopyToLeft</span></a></span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-326"></span><span>      </span><span id="local-6989586621679055456"><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055456"><span class="hs-identifier hs-var">newM</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">Array -&gt; ST s (MArray s)
forall s. Array -&gt; ST s (MArray s)
</span><a href="Data.Text.Builder.Linear.Array.html#unsafeThaw"><span class="hs-identifier hs-var">unsafeThaw</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055417"><span class="hs-identifier hs-var">left</span></a></span><span>
</span><span id="line-327"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; MArray s -&gt; Int -&gt; Array -&gt; Int -&gt; ST s ()
forall s. Int -&gt; MArray s -&gt; Int -&gt; Array -&gt; Int -&gt; ST s ()
</span><span class="hs-identifier hs-var">A.copyI</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055422"><span class="hs-identifier hs-var">rightLen</span></a></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055456"><span class="hs-identifier hs-var">newM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055418"><span class="hs-identifier hs-var">leftOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055420"><span class="hs-identifier hs-var">right</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055421"><span class="hs-identifier hs-var">rightOff</span></a></span><span>
</span><span id="line-328"></span><span>      </span><span id="local-6989586621679055457"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055457"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; ST s Array
forall s. MArray s -&gt; ST s Array
</span><span class="hs-identifier hs-var">A.unsafeFreeze</span></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055456"><span class="hs-identifier hs-var">newM</span></a></span><span>
</span><span id="line-329"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; ST s Text
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ST s Text) -&gt; Text -&gt; ST s Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Array -&gt; Int -&gt; Int -&gt; Text
</span><span class="hs-identifier hs-var">Text</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055457"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055418"><span class="hs-identifier hs-var">leftOff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055422"><span class="hs-identifier hs-var">rightLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-keyword">else</span><span>
</span><span id="line-331"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679055450"><span class="hs-identifier hs-var">canCopyToRight</span></a></span><span>
</span><span id="line-332"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-333"></span><span>          </span><span id="local-6989586621679055458"><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055458"><span class="hs-identifier hs-var">newM</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">Array -&gt; ST s (MArray s)
forall s. Array -&gt; ST s (MArray s)
</span><a href="Data.Text.Builder.Linear.Array.html#unsafeThaw"><span class="hs-identifier hs-var">unsafeThaw</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055420"><span class="hs-identifier hs-var">right</span></a></span><span>
</span><span id="line-334"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; MArray s -&gt; Int -&gt; Array -&gt; Int -&gt; ST s ()
forall s. Int -&gt; MArray s -&gt; Int -&gt; Array -&gt; Int -&gt; ST s ()
</span><span class="hs-identifier hs-var">A.copyI</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055458"><span class="hs-identifier hs-var">newM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055421"><span class="hs-identifier hs-var">rightOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055417"><span class="hs-identifier hs-var">left</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055418"><span class="hs-identifier hs-var">leftOff</span></a></span><span>
</span><span id="line-335"></span><span>          </span><span id="local-6989586621679055459"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055459"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; ST s Array
forall s. MArray s -&gt; ST s Array
</span><span class="hs-identifier hs-var">A.unsafeFreeze</span></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055458"><span class="hs-identifier hs-var">newM</span></a></span><span>
</span><span id="line-336"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; ST s Text
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ST s Text) -&gt; Text -&gt; ST s Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Array -&gt; Int -&gt; Int -&gt; Text
</span><span class="hs-identifier hs-var">Text</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055459"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055421"><span class="hs-identifier hs-var">rightOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055422"><span class="hs-identifier hs-var">rightLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-338"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679055465"><span class="annot"><span class="annottext">fullLen :: Int
</span><a href="#local-6989586621679055465"><span class="hs-identifier hs-var hs-var">fullLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055418"><span class="hs-identifier hs-var">leftOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055422"><span class="hs-identifier hs-var">rightLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055444"><span class="hs-identifier hs-var">rightFullLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055421"><span class="hs-identifier hs-var">rightOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055422"><span class="hs-identifier hs-var">rightLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>          </span><span id="local-6989586621679055466"><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055466"><span class="hs-identifier hs-var">newM</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Array -&gt; Bool
</span><a href="Data.Text.Builder.Linear.Array.html#isPinned"><span class="hs-identifier hs-var">isPinned</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055417"><span class="hs-identifier hs-var">left</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Array -&gt; Bool
</span><a href="Data.Text.Builder.Linear.Array.html#isPinned"><span class="hs-identifier hs-var">isPinned</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055420"><span class="hs-identifier hs-var">right</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s (MArray s)
forall s. Int -&gt; ST s (MArray s)
</span><span class="hs-identifier hs-var">A.newPinned</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ST s (MArray s)
forall s. Int -&gt; ST s (MArray s)
</span><span class="hs-identifier hs-var">A.new</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055465"><span class="hs-identifier hs-var">fullLen</span></a></span><span>
</span><span id="line-340"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; MArray s -&gt; Int -&gt; Array -&gt; Int -&gt; ST s ()
forall s. Int -&gt; MArray s -&gt; Int -&gt; Array -&gt; Int -&gt; ST s ()
</span><span class="hs-identifier hs-var">A.copyI</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055466"><span class="hs-identifier hs-var">newM</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055418"><span class="hs-identifier hs-var">leftOff</span></a></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055417"><span class="hs-identifier hs-var">left</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055418"><span class="hs-identifier hs-var">leftOff</span></a></span><span>
</span><span id="line-341"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; MArray s -&gt; Int -&gt; Array -&gt; Int -&gt; ST s ()
forall s. Int -&gt; MArray s -&gt; Int -&gt; Array -&gt; Int -&gt; ST s ()
</span><span class="hs-identifier hs-var">A.copyI</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055422"><span class="hs-identifier hs-var">rightLen</span></a></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055466"><span class="hs-identifier hs-var">newM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055418"><span class="hs-identifier hs-var">leftOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055420"><span class="hs-identifier hs-var">right</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055421"><span class="hs-identifier hs-var">rightOff</span></a></span><span>
</span><span id="line-342"></span><span>          </span><span id="local-6989586621679055467"><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055467"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">&#8592;</span><span> </span><span class="annot"><span class="annottext">MArray s -&gt; ST s Array
forall s. MArray s -&gt; ST s Array
</span><span class="hs-identifier hs-var">A.unsafeFreeze</span></span><span> </span><span class="annot"><span class="annottext">MArray s
</span><a href="#local-6989586621679055466"><span class="hs-identifier hs-var">newM</span></a></span><span>
</span><span id="line-343"></span><span>          </span><span class="annot"><span class="annottext">Text -&gt; ST s Text
forall a. a -&gt; ST s a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; ST s Text) -&gt; Text -&gt; ST s Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Array -&gt; Int -&gt; Int -&gt; Text
</span><span class="hs-identifier hs-var">Text</span></span><span> </span><span class="annot"><span class="annottext">Array
</span><a href="#local-6989586621679055467"><span class="hs-identifier hs-var">new</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055418"><span class="hs-identifier hs-var">leftOff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055419"><span class="hs-identifier hs-var">leftLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679055422"><span class="hs-identifier hs-var">rightLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span></pre></body></html>