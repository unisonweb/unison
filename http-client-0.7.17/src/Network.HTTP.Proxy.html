<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP               #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts  #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">{-
Copyright (c) 2002, Warrick Gray
Copyright (c) 2002-2005, Ian Lynagh
Copyright (c) 2003-2006, Bjorn Bringert
Copyright (c) 2004, Andre Furtado
Copyright (c) 2004-2005, Dominic Steinitz
Copyright (c) 2007, Robin Bate Boerop
Copyright (c) 2008-2010, Sigbjorn Finne
Copyright (c) 2009, Eric Kow
Copyright (c) 2010, Antoine Latter
Copyright (c) 2004, 2010-2011, Ganesh Sittampalam
Copyright (c) 2011, Duncan Coutts
Copyright (c) 2011, Matthew Gruen
Copyright (c) 2011, Jeremy Yallop
Copyright (c) 2011, Eric Hesselink
Copyright (c) 2011, Yi Huang
Copyright (c) 2011, Tom Lokhorst
Copyright (c) 2017, Vassil Keremidchiev

All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

    * Redistributions of source code must retain the above copyright
      notice, this list of conditions and the following disclaimer.

    * Redistributions in binary form must reproduce the above
      copyright notice, this list of conditions and the following
      disclaimer in the documentation and/or other materials provided
      with the distribution.

    * The names of contributors may not be used to endorse or promote
      products derived from this software without specific prior
      written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
&quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-}</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.HTTP.Proxy</span><span class="hs-special">(</span><span>  </span><span class="annot"><a href="Network.HTTP.Proxy.html#ProxyProtocol"><span class="hs-identifier">ProxyProtocol</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP.Proxy.html#EnvHelper"><span class="hs-identifier">EnvHelper</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>                            </span><span class="annot"><a href="Network.HTTP.Proxy.html#systemProxyHelper"><span class="hs-identifier">systemProxyHelper</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP.Proxy.html#envHelper"><span class="hs-identifier">envHelper</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>                            </span><span class="annot"><a href="Network.HTTP.Proxy.html#httpProtocol"><span class="hs-identifier">httpProtocol</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-58"></span><span>                            </span><span class="annot"><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier">ProxySettings</span></a></span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">A</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Arrow</span></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">first</span></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>               </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">guard</span></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Char8</span></span><span>       </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S8</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Char</span></span><span>                   </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">toLower</span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span>                    </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Text.Read</span></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">decimal</span></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Network.HTTP.Client.Request.html"><span class="hs-identifier">Network.HTTP.Client.Request</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP.Client.Request.html#applyBasicProxyAuth"><span class="hs-identifier">applyBasicProxyAuth</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>                                              </span><span class="annot"><a href="Network.HTTP.Client.Request.html#extractBasicAuthInfo"><span class="hs-identifier">extractBasicAuthInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Network.HTTP.Client.Types.html"><span class="hs-identifier">Network.HTTP.Client.Types</span></a></span><span>   </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP.Client.Types.html#HttpExceptionContent"><span class="hs-identifier">HttpExceptionContent</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>                                              </span><span class="annot"><a href="Network.HTTP.Client.Types.html#Proxy"><span class="hs-identifier">Proxy</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Types.html#Request"><span class="hs-identifier">Request</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>                                              </span><span class="annot"><a href="Network.HTTP.Client.Types.html#throwHttp"><span class="hs-identifier">throwHttp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Network.URI</span></span><span>                 </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">U</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">System.Environment</span></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">getEnvironment</span></span><span class="hs-special">)</span><span class="hs-cpp">

#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Exception</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier">IOException</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">bracket</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">catch</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">try</span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control.Monad</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier">join</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">liftM</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">mplus</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">when</span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.List</span><span>                   </span><span class="hs-special">(</span><span class="hs-identifier">isInfixOf</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">isPrefixOf</span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Foreign</span><span>                     </span><span class="hs-special">(</span><span class="hs-identifier">Storable</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">peek</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">sizeOf</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">alloca</span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>                                              </span><span class="hs-identifier">castPtr</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">toBool</span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Network.URI</span><span>                 </span><span class="hs-special">(</span><span class="hs-identifier">parseAbsoluteURI</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Safe</span><span>                        </span><span class="hs-special">(</span><span class="hs-identifier">readDef</span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System.IO</span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System.Win32.Registry</span><span>       </span><span class="hs-special">(</span><span class="hs-identifier">hKEY_CURRENT_USER</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rEG_DWORD</span><span class="hs-special">,</span><span>
</span><span id="line-86"></span><span>                                              </span><span class="hs-identifier">regCloseKey</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">regOpenKey</span><span class="hs-special">,</span><span>
</span><span id="line-87"></span><span>                                              </span><span class="hs-identifier">regQueryValue</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">regQueryValueEx</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">System.Win32.Types</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier">DWORD</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">HKEY</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-91"></span><span class="hs-keyword">type</span><span> </span><span id="EnvName"><span class="annot"><a href="Network.HTTP.Proxy.html#EnvName"><span class="hs-identifier hs-var">EnvName</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-92"></span><span class="hs-keyword">type</span><span> </span><span id="HostAddress"><span class="annot"><a href="Network.HTTP.Proxy.html#HostAddress"><span class="hs-identifier hs-var">HostAddress</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S8.ByteString</span></span><span>
</span><span id="line-93"></span><span class="hs-keyword">type</span><span> </span><span id="UserName"><span class="annot"><a href="Network.HTTP.Proxy.html#UserName"><span class="hs-identifier hs-var">UserName</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S8.ByteString</span></span><span>
</span><span id="line-94"></span><span class="hs-keyword">type</span><span> </span><span id="Password"><span class="annot"><a href="Network.HTTP.Proxy.html#Password"><span class="hs-identifier hs-var">Password</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S8.ByteString</span></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">-- There are other proxy protocols like SOCKS, FTP, etc.</span><span>
</span><span id="line-97"></span><span class="hs-keyword">data</span><span> </span><span id="ProxyProtocol"><span class="annot"><a href="Network.HTTP.Proxy.html#ProxyProtocol"><span class="hs-identifier hs-var">ProxyProtocol</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="HTTPProxy"><span class="annot"><a href="Network.HTTP.Proxy.html#HTTPProxy"><span class="hs-identifier hs-var">HTTPProxy</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="HTTPSProxy"><span class="annot"><a href="Network.HTTP.Proxy.html#HTTPSProxy"><span class="hs-identifier hs-var">HTTPSProxy</span></a></span></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679106913"><span id="local-6989586621679106917"><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="Network.HTTP.Proxy.html#ProxyProtocol"><span class="hs-identifier hs-type">ProxyProtocol</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-100"></span><span>    </span><span id="local-6989586621679106920"><span class="annot"><span class="annottext">show :: ProxyProtocol -&gt; String
</span><a href="#local-6989586621679106920"><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="annot"><span class="annottext">ProxyProtocol
</span><a href="Network.HTTP.Proxy.html#HTTPProxy"><span class="hs-identifier hs-var">HTTPProxy</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;http&quot;</span></span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ProxyProtocol
</span><a href="Network.HTTP.Proxy.html#HTTPSProxy"><span class="hs-identifier hs-var">HTTPSProxy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;https&quot;</span></span><span>
</span><span id="line-102"></span><span>
</span><span id="line-103"></span><span class="hs-keyword">data</span><span> </span><span id="ProxySettings"><span class="annot"><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier hs-var">ProxySettings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ProxySettings"><span class="annot"><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier hs-var">ProxySettings</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="_proxyHost"><span class="annot"><span class="annottext">ProxySettings -&gt; Proxy
</span><a href="Network.HTTP.Proxy.html#_proxyHost"><span class="hs-identifier hs-var hs-var">_proxyHost</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Types.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>                                     </span><span id="_proxyAuth"><span class="annot"><span class="annottext">ProxySettings -&gt; Maybe (UserName, UserName)
</span><a href="Network.HTTP.Proxy.html#_proxyAuth"><span class="hs-identifier hs-var hs-var">_proxyAuth</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP.Proxy.html#UserName"><span class="hs-identifier hs-type">UserName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP.Proxy.html#Password"><span class="hs-identifier hs-type">Password</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-105"></span><span>                                     </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679106926"><span id="local-6989586621679106935"><span id="local-6989586621679106939"><span class="annot"><span class="annottext">Int -&gt; ProxySettings -&gt; ShowS
[ProxySettings] -&gt; ShowS
ProxySettings -&gt; String
(Int -&gt; ProxySettings -&gt; ShowS)
-&gt; (ProxySettings -&gt; String)
-&gt; ([ProxySettings] -&gt; ShowS)
-&gt; Show ProxySettings
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; ProxySettings -&gt; ShowS
showsPrec :: Int -&gt; ProxySettings -&gt; ShowS
$cshow :: ProxySettings -&gt; String
show :: ProxySettings -&gt; String
$cshowList :: [ProxySettings] -&gt; ShowS
showList :: [ProxySettings] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="annot"><a href="Network.HTTP.Proxy.html#httpProtocol"><span class="hs-identifier hs-type">httpProtocol</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP.Proxy.html#ProxyProtocol"><span class="hs-identifier hs-type">ProxyProtocol</span></a></span><span>
</span><span id="line-108"></span><span id="httpProtocol"><span class="annot"><span class="annottext">httpProtocol :: Bool -&gt; ProxyProtocol
</span><a href="Network.HTTP.Proxy.html#httpProtocol"><span class="hs-identifier hs-var hs-var">httpProtocol</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProxyProtocol
</span><a href="Network.HTTP.Proxy.html#HTTPSProxy"><span class="hs-identifier hs-var">HTTPSProxy</span></a></span><span>
</span><span id="line-109"></span><span class="annot"><a href="Network.HTTP.Proxy.html#httpProtocol"><span class="hs-identifier hs-var">httpProtocol</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProxyProtocol
</span><a href="Network.HTTP.Proxy.html#HTTPProxy"><span class="hs-identifier hs-var">HTTPProxy</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-keyword">data</span><span> </span><span id="EnvHelper"><span class="annot"><a href="Network.HTTP.Proxy.html#EnvHelper"><span class="hs-identifier hs-var">EnvHelper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="EHFromRequest"><span class="annot"><a href="Network.HTTP.Proxy.html#EHFromRequest"><span class="hs-identifier hs-var">EHFromRequest</span></a></span></span><span>
</span><span id="line-112"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span id="EHNoProxy"><span class="annot"><a href="Network.HTTP.Proxy.html#EHNoProxy"><span class="hs-identifier hs-var">EHNoProxy</span></a></span></span><span>
</span><span id="line-113"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span id="EHUseProxy"><span class="annot"><a href="Network.HTTP.Proxy.html#EHUseProxy"><span class="hs-identifier hs-var">EHUseProxy</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP.Client.Types.html#Proxy"><span class="hs-identifier hs-type">Proxy</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span id="local-6989586621679106790"><span class="annot"><a href="Network.HTTP.Proxy.html#headJust"><span class="hs-identifier hs-type">headJust</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679106790"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679106790"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-116"></span><span id="headJust"><span class="annot"><span class="annottext">headJust :: forall a. [Maybe a] -&gt; Maybe a
</span><a href="Network.HTTP.Proxy.html#headJust"><span class="hs-identifier hs-var hs-var">headJust</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-117"></span><span class="annot"><a href="Network.HTTP.Proxy.html#headJust"><span class="hs-identifier hs-var">headJust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679106949"><span class="annot"><span class="annottext">[Maybe a]
</span><a href="#local-6989586621679106949"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe a] -&gt; Maybe a
forall a. [Maybe a] -&gt; Maybe a
</span><a href="Network.HTTP.Proxy.html#headJust"><span class="hs-identifier hs-var">headJust</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe a]
</span><a href="#local-6989586621679106949"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-118"></span><span class="annot"><a href="Network.HTTP.Proxy.html#headJust"><span class="hs-identifier hs-var">headJust</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679106950"><span class="annot"><span class="annottext">y :: Maybe a
</span><a href="#local-6989586621679106950"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Maybe a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679106950"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="annot"><a href="Network.HTTP.Proxy.html#systemProxyHelper"><span class="hs-identifier hs-type">systemProxyHelper</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP.Proxy.html#ProxyProtocol"><span class="hs-identifier hs-type">ProxyProtocol</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP.Proxy.html#EnvHelper"><span class="hs-identifier hs-type">EnvHelper</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP.Client.Types.html#Request"><span class="hs-identifier hs-type">Request</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Types.html#Request"><span class="hs-identifier hs-type">Request</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span id="systemProxyHelper"><span class="annot"><span class="annottext">systemProxyHelper :: Maybe Text -&gt; ProxyProtocol -&gt; EnvHelper -&gt; IO (Request -&gt; Request)
</span><a href="Network.HTTP.Proxy.html#systemProxyHelper"><span class="hs-identifier hs-var hs-var">systemProxyHelper</span></a></span></span><span> </span><span id="local-6989586621679106951"><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621679106951"><span class="hs-identifier hs-var">envOveride</span></a></span></span><span> </span><span id="local-6989586621679106952"><span class="annot"><span class="annottext">ProxyProtocol
</span><a href="#local-6989586621679106952"><span class="hs-identifier hs-var">prot</span></a></span></span><span> </span><span id="local-6989586621679106953"><span class="annot"><span class="annottext">EnvHelper
</span><a href="#local-6989586621679106953"><span class="hs-identifier hs-var">eh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679106954"><span class="annot"><span class="annottext">envName' :: Maybe Text -&gt; Text
</span><a href="#local-6989586621679106954"><span class="hs-identifier hs-var hs-var">envName'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProxyProtocol -&gt; Text
</span><a href="Network.HTTP.Proxy.html#envName"><span class="hs-identifier hs-var">envName</span></a></span><span> </span><span class="annot"><span class="annottext">ProxyProtocol
</span><a href="#local-6989586621679106952"><span class="hs-identifier hs-var">prot</span></a></span><span>
</span><span id="line-123"></span><span>        </span><span class="annot"><a href="#local-6989586621679106954"><span class="hs-identifier hs-var">envName'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679106956"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679106956"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679106956"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span>    </span><span id="local-6989586621679106957"><span class="annot"><span class="annottext">UserName -&gt; Maybe ProxySettings
</span><a href="#local-6989586621679106957"><span class="hs-identifier hs-var">modifier</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO (UserName -&gt; Maybe ProxySettings)
</span><a href="Network.HTTP.Proxy.html#envHelper"><span class="hs-identifier hs-var">envHelper</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Text -&gt; Text
</span><a href="#local-6989586621679106954"><span class="hs-identifier hs-var">envName'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="#local-6989586621679106951"><span class="hs-identifier hs-var">envOveride</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">-- Under Windows try first env. variables override then Windows proxy settings</span><span class="hs-cpp">
#if defined(mingw32_HOST_OS)
</span><span>    </span><span class="hs-identifier">modifier'</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">systemProxy</span><span> </span><span class="hs-identifier">prot</span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">modifiers</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">modifier</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">modifier'</span><span class="hs-special">]</span><span class="hs-cpp">
#else
</span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679106958"><span class="annot"><span class="annottext">modifiers :: [UserName -&gt; Maybe ProxySettings]
</span><a href="#local-6989586621679106958"><span class="hs-identifier hs-var hs-var">modifiers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">UserName -&gt; Maybe ProxySettings
</span><a href="#local-6989586621679106957"><span class="hs-identifier hs-var">modifier</span></a></span><span class="hs-special">]</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621679106959"><span class="hs-identifier hs-type">chooseMod</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Types.html#Request"><span class="hs-identifier hs-type">Request</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier hs-type">ProxySettings</span></a></span><span>
</span><span id="line-136"></span><span>        </span><span id="local-6989586621679106959"><span class="annot"><span class="annottext">chooseMod :: Request -&gt; Maybe ProxySettings
</span><a href="#local-6989586621679106959"><span class="hs-identifier hs-var hs-var">chooseMod</span></a></span></span><span> </span><span id="local-6989586621679106960"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679106960"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe ProxySettings] -&gt; Maybe ProxySettings
forall a. [Maybe a] -&gt; Maybe a
</span><a href="Network.HTTP.Proxy.html#headJust"><span class="hs-identifier hs-var">headJust</span></a></span><span> </span><span class="annot"><span class="annottext">([Maybe ProxySettings] -&gt; Maybe ProxySettings)
-&gt; ([UserName -&gt; Maybe ProxySettings] -&gt; [Maybe ProxySettings])
-&gt; [UserName -&gt; Maybe ProxySettings]
-&gt; Maybe ProxySettings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((UserName -&gt; Maybe ProxySettings) -&gt; Maybe ProxySettings)
-&gt; [UserName -&gt; Maybe ProxySettings] -&gt; [Maybe ProxySettings]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679106962"><span class="annot"><span class="annottext">UserName -&gt; Maybe ProxySettings
</span><a href="#local-6989586621679106962"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UserName -&gt; Maybe ProxySettings
</span><a href="#local-6989586621679106962"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">(UserName -&gt; Maybe ProxySettings)
-&gt; (Request -&gt; UserName) -&gt; Request -&gt; Maybe ProxySettings
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Request -&gt; UserName
</span><a href="Network.HTTP.Client.Types.html#host"><span class="hs-identifier hs-var">host</span></a></span><span> </span><span class="annot"><span class="annottext">(Request -&gt; Maybe ProxySettings) -&gt; Request -&gt; Maybe ProxySettings
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679106960"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([UserName -&gt; Maybe ProxySettings] -&gt; Maybe ProxySettings)
-&gt; [UserName -&gt; Maybe ProxySettings] -&gt; Maybe ProxySettings
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[UserName -&gt; Maybe ProxySettings]
</span><a href="#local-6989586621679106958"><span class="hs-identifier hs-var">modifiers</span></a></span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span>        </span><span id="local-6989586621679106964"><span class="annot"><span class="annottext">noEnvProxy :: Request -&gt; Request
</span><a href="#local-6989586621679106964"><span class="hs-identifier hs-var hs-var">noEnvProxy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EnvHelper
</span><a href="#local-6989586621679106953"><span class="hs-identifier hs-var">eh</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-139"></span><span>            </span><span class="annot"><span class="annottext">EnvHelper
</span><a href="Network.HTTP.Proxy.html#EHFromRequest"><span class="hs-identifier hs-var">EHFromRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Request -&gt; Request
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-140"></span><span>            </span><span class="annot"><span class="annottext">EnvHelper
</span><a href="Network.HTTP.Proxy.html#EHNoProxy"><span class="hs-identifier hs-var">EHNoProxy</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679106966"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679106966"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679106966"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Types.html#proxy"><span class="hs-identifier hs-var">proxy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-141"></span><span>            </span><span class="annot"><a href="Network.HTTP.Proxy.html#EHUseProxy"><span class="hs-identifier hs-type">EHUseProxy</span></a></span><span> </span><span id="local-6989586621679106968"><span class="annot"><span class="annottext">Proxy
</span><a href="#local-6989586621679106968"><span class="hs-identifier hs-var">p</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679106969"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679106969"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679106969"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Types.html#proxy"><span class="hs-identifier hs-var">proxy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621679106968"><span class="hs-identifier hs-type">p</span></a></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679106970"><span class="annot"><span class="annottext">result :: Request -&gt; Request
</span><a href="#local-6989586621679106970"><span class="hs-identifier hs-var hs-var">result</span></a></span></span><span> </span><span id="local-6989586621679106971"><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679106971"><span class="hs-identifier hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ProxySettings -&gt; Request
</span><a href="#local-6989586621679106972"><span class="hs-identifier hs-var">toRequest</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe ProxySettings -&gt; Request)
-&gt; (Request -&gt; Maybe ProxySettings) -&gt; Request -&gt; Request
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Request -&gt; Maybe ProxySettings
</span><a href="#local-6989586621679106959"><span class="hs-identifier hs-var">chooseMod</span></a></span><span> </span><span class="annot"><span class="annottext">(Request -&gt; Request) -&gt; Request -&gt; Request
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679106971"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-144"></span><span>            </span><span id="local-6989586621679106972"><span class="annot"><span class="annottext">toRequest :: Maybe ProxySettings -&gt; Request
</span><a href="#local-6989586621679106972"><span class="hs-identifier hs-var hs-var">toRequest</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe ProxySettings
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Request -&gt; Request
</span><a href="#local-6989586621679106964"><span class="hs-identifier hs-var">noEnvProxy</span></a></span><span> </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679106971"><span class="hs-identifier hs-var">req</span></a></span><span>
</span><span id="line-145"></span><span>            </span><span class="annot"><a href="#local-6989586621679106972"><span class="hs-identifier hs-var">toRequest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier hs-type">ProxySettings</span></a></span><span> </span><span id="local-6989586621679106973"><span class="annot"><span class="annottext">Proxy
</span><a href="#local-6989586621679106973"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679106974"><span class="annot"><span class="annottext">Maybe (UserName, UserName)
</span><a href="#local-6989586621679106974"><span class="hs-identifier hs-var">muserpass</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Request -&gt; Request)
-&gt; ((UserName, UserName) -&gt; Request -&gt; Request)
-&gt; Maybe (UserName, UserName)
-&gt; Request
-&gt; Request
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Request -&gt; Request
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(UserName -&gt; UserName -&gt; Request -&gt; Request)
-&gt; (UserName, UserName) -&gt; Request -&gt; Request
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">UserName -&gt; UserName -&gt; Request -&gt; Request
</span><a href="Network.HTTP.Client.Request.html#applyBasicProxyAuth"><span class="hs-identifier hs-var">applyBasicProxyAuth</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (UserName, UserName)
</span><a href="#local-6989586621679106974"><span class="hs-identifier hs-var">muserpass</span></a></span><span>
</span><span id="line-146"></span><span>                                        </span><span class="annot"><span class="annottext">Request
</span><a href="#local-6989586621679106971"><span class="hs-identifier hs-var">req</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Network.HTTP.Client.Types.html#proxy"><span class="hs-identifier hs-var">proxy</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="#local-6989586621679106973"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><span class="annottext">(Request -&gt; Request) -&gt; IO (Request -&gt; Request)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Request -&gt; Request
</span><a href="#local-6989586621679106970"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-cpp">


#if defined(mingw32_HOST_OS)
</span><span class="hs-identifier">windowsProxyString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">String</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span class="hs-identifier">windowsProxyString</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-identifier">mProxy</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">registryProxyString</span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-155"></span><span>        </span><span class="hs-special">(</span><span class="hs-identifier">proxies</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">exceptions</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mProxy</span><span>
</span><span id="line-156"></span><span>        </span><span class="hs-identifier">protoProxy</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">parseWindowsProxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-identifier">proxies</span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">protoProxy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">exceptions</span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="hs-identifier">registryProxyLoc</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">HKEY</span><span class="hs-special">,</span><span class="hs-identifier">String</span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span class="hs-identifier">registryProxyLoc</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">hive</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">path</span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-comment">-- some sources say proxy settings should be at</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-comment">-- HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-comment">--                   \CurrentVersion\Internet Settings\ProxyServer</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-comment">-- but if the user sets them with IE connection panel they seem to</span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-comment">-- end up in the following place:</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-identifier">hive</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">hKEY_CURRENT_USER</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-identifier">path</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings&quot;</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="hs-comment">-- read proxy settings from the windows registry; this is just a best</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- effort and may not work on all setups.</span><span>
</span><span id="line-172"></span><span class="hs-identifier">registryProxyString</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">String</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span class="hs-identifier">registryProxyString</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">catch</span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-special">(</span><span class="hs-identifier">bracket</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uncurry</span><span> </span><span class="hs-identifier">regOpenKey</span><span> </span><span class="hs-identifier">registryProxyLoc</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">regCloseKey</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">hkey</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-identifier">enable</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">toBool</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">maybe</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-identifier">id</span><span> </span><span class="hs-operator">A.&lt;$&gt;</span><span> </span><span class="hs-identifier">regQueryValueDWORD</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-string">&quot;ProxyEnable&quot;</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">enable</span><span>
</span><span id="line-177"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span class="hs-cpp">
#if MIN_VERSION_Win32(2, 6, 0) &amp;&amp; !MIN_VERSION_Win32(2, 8, 0)
</span><span>            </span><span class="hs-identifier">server</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">regQueryValue</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-string">&quot;ProxyServer&quot;</span><span>
</span><span id="line-180"></span><span>            </span><span class="hs-identifier">exceptions</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">try</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">regQueryValue</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-string">&quot;ProxyOverride&quot;</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Either</span><span> </span><span class="hs-identifier">IOException</span><span> </span><span class="hs-identifier">String</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span>            </span><span class="hs-identifier">server</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">regQueryValue</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-string">&quot;ProxyServer&quot;</span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>            </span><span class="hs-identifier">exceptions</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">try</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">regQueryValue</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-string">&quot;ProxyOverride&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Either</span><span> </span><span class="hs-identifier">IOException</span><span> </span><span class="hs-identifier">String</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>            </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">server</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">either</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">const</span><span> </span><span class="hs-string">&quot;&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">id</span><span> </span><span class="hs-identifier">exceptions</span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-identifier">hideError</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-identifier">hideError</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">IOException</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">String</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">String</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>      </span><span class="hs-identifier">hideError</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="hs-comment">-- the proxy string is in the format &quot;http=x.x.x.x:yyyy;https=...;ftp=...;socks=...&quot;</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- even though the following article indicates otherwise</span><span>
</span><span id="line-193"></span><span class="hs-comment">-- https://support.microsoft.com/en-us/kb/819961</span><span>
</span><span id="line-194"></span><span class="hs-comment">--</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- to be sure, parse strings where each entry in the ';'-separated list above is</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- either in the format &quot;protocol=...&quot; or &quot;protocol://...&quot;</span><span>
</span><span id="line-197"></span><span class="hs-identifier">parseWindowsProxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">String</span><span>
</span><span id="line-198"></span><span class="hs-identifier">parseWindowsProxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">proxies</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-identifier">x</span><span class="hs-glyph">:</span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">x</span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-identifier">_</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-203"></span><span>    </span><span class="hs-identifier">parts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">split</span><span> </span><span class="hs-char">';'</span><span> </span><span class="hs-identifier">s</span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-identifier">pr</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">break</span><span> </span><span class="hs-special">(</span><span class="hs-operator">==</span><span> </span><span class="hs-char">'='</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-205"></span><span>      </span><span class="hs-special">(</span><span class="hs-identifier">p</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">p</span><span>  </span><span class="hs-comment">-- might be in format http://</span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-special">(</span><span class="hs-identifier">p</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">u</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">p</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;://&quot;</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">drop</span><span> </span><span class="hs-number">1</span><span> </span><span class="hs-identifier">u</span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-identifier">protoPrefix</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;://&quot;</span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-identifier">proxies</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">filter</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isPrefixOf</span><span> </span><span class="hs-identifier">protoPrefix</span><span class="hs-special">)</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">map</span><span> </span><span class="hs-identifier">pr</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">parts</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-identifier">split</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Eq</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-identifier">split</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-identifier">split</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-identifier">xs</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">break</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">a</span><span> </span><span class="hs-operator">==</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">xs</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-214"></span><span>      </span><span class="hs-special">(</span><span class="hs-identifier">ys</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">ys</span><span class="hs-special">]</span><span>
</span><span id="line-215"></span><span>      </span><span class="hs-special">(</span><span class="hs-identifier">ys</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">zs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">ys</span><span class="hs-glyph">:</span><span class="hs-identifier">split</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-identifier">zs</span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="hs-comment">-- Extract proxy settings from Windows registry. This is a standard way in Windows OS.</span><span>
</span><span id="line-218"></span><span class="hs-identifier">systemProxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">HostAddress</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">ProxySettings</span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span class="hs-identifier">systemProxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">isURLlocal</span><span> </span><span class="hs-string">&quot;127.0.0.1&quot;</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span>
</span><span id="line-221"></span><span>        </span><span class="hs-identifier">isURLlocal</span><span> </span><span class="hs-string">&quot;localhost&quot;</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">True</span><span>
</span><span id="line-222"></span><span>        </span><span class="hs-identifier">isURLlocal</span><span> </span><span class="hs-identifier">_</span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">False</span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span>        </span><span class="hs-identifier">hasLocal</span><span> </span><span class="hs-identifier">exceptions</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;&lt;local&gt;&quot;</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">isInfixOf</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">exceptions</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-identifier">settings</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">fetchProxy</span><span> </span><span class="hs-identifier">proto</span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">url</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-228"></span><span>        </span><span class="hs-special">(</span><span class="hs-identifier">proxy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">exceptions</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">settings</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span>        </span><span class="hs-comment">-- Skip proxy for local hosts if it's enabled in IE settings</span><span>
</span><span id="line-231"></span><span>        </span><span class="hs-comment">-- TODO Implement skipping for address patterns, like (*.google.com)</span><span>
</span><span id="line-232"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">isURLlocal</span><span> </span><span class="hs-identifier">url</span><span> </span><span class="hs-operator">&amp;&amp;</span><span> </span><span class="hs-identifier">hasLocal</span><span> </span><span class="hs-identifier">exceptions</span><span class="hs-special">)</span><span> </span><span class="hs-operator">||</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">url</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">S8.isInfixOf</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">S8.pack</span><span> </span><span class="hs-identifier">exceptions</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><span id="line-233"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">proxy</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span class="hs-comment">-- | @fetchProxy flg@ gets the local proxy settings and parse the string</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- into a @Proxy@ value.</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- Proxy settings are sourced from IE/WinInet's proxy</span><span>
</span><span id="line-238"></span><span class="hs-comment">-- setting in the Registry.</span><span>
</span><span id="line-239"></span><span class="hs-identifier">fetchProxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ProxySettings</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">String</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span class="hs-identifier">fetchProxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-identifier">mstr</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">windowsProxyString</span><span> </span><span class="hs-identifier">proto</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">mstr</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-243"></span><span>      </span><span class="hs-identifier">Nothing</span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">proxy</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">except</span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">parseProxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-identifier">proxy</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-245"></span><span>          </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">p</span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">p</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">except</span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>          </span><span class="hs-identifier">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-247"></span><span>              </span><span class="hs-identifier">throwHttp</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">InvalidProxySettings</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">T.pack</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">unlines</span><span> </span><span class="hs-operator">$</span><span>
</span><span id="line-248"></span><span>                      </span><span class="hs-special">[</span><span> </span><span class="hs-string">&quot;Invalid http proxy uri: &quot;</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">proxy</span><span>
</span><span id="line-249"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;proxy uri must be http with a hostname&quot;</span><span>
</span><span id="line-250"></span><span>                      </span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;ignoring http proxy, trying a direct connection&quot;</span><span>
</span><span id="line-251"></span><span>                      </span><span class="hs-special">]</span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="hs-comment">-- | @parseProxy str@ translates a proxy server string into a @ProxySettings@ value;</span><span>
</span><span id="line-254"></span><span class="hs-comment">-- returns @Nothing@ if not well-formed.</span><span>
</span><span id="line-255"></span><span class="hs-identifier">parseProxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">ProxySettings</span><span>
</span><span id="line-256"></span><span class="hs-identifier">parseProxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-identifier">str</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">join</span><span>
</span><span id="line-257"></span><span>                 </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">uri2proxy</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>                 </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">parseHttpURI</span><span> </span><span class="hs-identifier">str</span><span>
</span><span id="line-259"></span><span>                 </span><span class="hs-special">`</span><span class="hs-identifier">mplus</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">parseHttpURI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">protoPrefix</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-identifier">str</span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-261"></span><span>     </span><span class="hs-identifier">protoPrefix</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;://&quot;</span><span>
</span><span id="line-262"></span><span>     </span><span class="hs-identifier">parseHttpURI</span><span> </span><span class="hs-identifier">str'</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-263"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">parseAbsoluteURI</span><span> </span><span class="hs-identifier">str'</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-264"></span><span>        </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">uri</span><span class="hs-glyph">@</span><span class="hs-identifier">U.URI</span><span class="hs-special">{</span><span class="hs-identifier">U.uriAuthority</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Just</span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fixUserInfo</span><span> </span><span class="hs-identifier">uri</span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>        </span><span class="hs-identifier">_</span><span>                                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span>       </span><span class="hs-comment">-- Note: we need to be able to parse non-URIs like @\&quot;wwwcache.example.com:80\&quot;@</span><span>
</span><span id="line-268"></span><span>       </span><span class="hs-comment">-- which lack the @\&quot;http://\&quot;@ URI scheme. The problem is that</span><span>
</span><span id="line-269"></span><span>       </span><span class="hs-comment">-- @\&quot;wwwcache.example.com:80\&quot;@ is in fact a valid URI but with scheme</span><span>
</span><span id="line-270"></span><span>       </span><span class="hs-comment">-- @\&quot;wwwcache.example.com:\&quot;@, no authority part and a path of @\&quot;80\&quot;@.</span><span>
</span><span id="line-271"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-272"></span><span>       </span><span class="hs-comment">-- So our strategy is to try parsing as normal uri first and if it lacks the</span><span>
</span><span id="line-273"></span><span>       </span><span class="hs-comment">-- 'uriAuthority' then we try parsing again with a @\&quot;http://\&quot;@ prefix.</span><span>
</span><span id="line-274"></span><span>       </span><span class="hs-comment">--</span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span class="hs-comment">-- | @dropWhileTail p ls@ chops off trailing elements from @ls@</span><span>
</span><span id="line-277"></span><span class="hs-comment">-- until @p@ returns @False@.</span><span>
</span><span id="line-278"></span><span class="hs-identifier">dropWhileTail</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Bool</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span>
</span><span id="line-279"></span><span class="hs-identifier">dropWhileTail</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">ls</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">foldr</span><span> </span><span class="hs-identifier">chop</span><span> </span><span class="hs-identifier">Nothing</span><span> </span><span class="hs-identifier">ls</span><span> </span><span class="hs-keyword">of</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">xs</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">xs</span><span class="hs-special">;</span><span> </span><span class="hs-identifier">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-281"></span><span>     </span><span class="hs-keyword">where</span><span>
</span><span id="line-282"></span><span>       </span><span class="hs-identifier">chop</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Just</span><span> </span><span class="hs-identifier">xs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">x</span><span class="hs-glyph">:</span><span class="hs-identifier">xs</span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>       </span><span class="hs-identifier">chop</span><span> </span><span class="hs-identifier">x</span><span> </span><span class="hs-identifier">_</span><span>
</span><span id="line-284"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">x</span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><span id="line-285"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">otherwise</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">x</span><span class="hs-special">]</span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span class="hs-comment">-- | @chopAtDelim elt ls@ breaks up @ls@ into two at first occurrence</span><span>
</span><span id="line-288"></span><span class="hs-comment">-- of @elt@; @elt@ is elided too. If @elt@ does not occur, the second</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- list is empty and the first is equal to @ls@.</span><span>
</span><span id="line-290"></span><span class="hs-identifier">chopAtDelim</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">Eq</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier">a</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-identifier">a</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span class="hs-identifier">chopAtDelim</span><span> </span><span class="hs-identifier">elt</span><span> </span><span class="hs-identifier">xs</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-292"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">break</span><span> </span><span class="hs-special">(</span><span class="hs-operator">==</span><span class="hs-identifier">elt</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">xs</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">xs</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-special">(</span><span class="hs-keyword">as</span><span class="hs-special">,</span><span class="hs-identifier">_</span><span class="hs-glyph">:</span><span class="hs-identifier">bs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">as</span><span class="hs-special">,</span><span class="hs-identifier">bs</span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span class="hs-comment">-- | tidy up user portion, don't want the trailing &quot;\@&quot;.</span><span>
</span><span id="line-297"></span><span class="hs-identifier">fixUserInfo</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">U.URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">U.URI</span><span>
</span><span id="line-298"></span><span class="hs-identifier">fixUserInfo</span><span> </span><span class="hs-identifier">uri</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">uri</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">U.uriAuthority</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">f</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">fmap</span><span class="hs-special">`</span><span> </span><span class="hs-identifier">U.uriAuthority</span><span> </span><span class="hs-identifier">uri</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-300"></span><span>     </span><span class="hs-identifier">f</span><span> </span><span class="hs-identifier">a</span><span class="hs-glyph">@</span><span class="hs-identifier">U.URIAuth</span><span class="hs-special">{</span><span class="hs-identifier">U.uriUserInfo</span><span class="hs-glyph">=</span><span class="hs-identifier">s</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">a</span><span class="hs-special">{</span><span class="hs-identifier">U.uriUserInfo</span><span class="hs-glyph">=</span><span class="hs-identifier">dropWhileTail</span><span> </span><span class="hs-special">(</span><span class="hs-operator">==</span><span class="hs-char">'@'</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">s</span><span class="hs-special">}</span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-identifier">defaultHTTPport</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Int</span><span>
</span><span id="line-303"></span><span class="hs-identifier">defaultHTTPport</span><span> </span><span class="hs-identifier">HTTPProxy</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">80</span><span>
</span><span id="line-304"></span><span class="hs-identifier">defaultHTTPport</span><span> </span><span class="hs-identifier">HTTPSProxy</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-number">443</span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span class="hs-identifier">uri2proxy</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">ProxyProtocol</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">U.URI</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">ProxySettings</span><span>
</span><span id="line-307"></span><span class="hs-identifier">uri2proxy</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-identifier">uri</span><span class="hs-glyph">@</span><span class="hs-identifier">U.URI</span><span class="hs-special">{</span><span> </span><span class="hs-identifier">U.uriAuthority</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">U.URIAuth</span><span> </span><span class="hs-identifier">auth'</span><span> </span><span class="hs-identifier">hst</span><span> </span><span class="hs-identifier">prt</span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">proto</span><span> </span><span class="hs-operator">++</span><span> </span><span class="hs-string">&quot;:&quot;</span><span class="hs-special">)</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">U.uriScheme</span><span> </span><span class="hs-identifier">uri</span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-309"></span><span>        </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ProxySettings</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Proxy</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">S8.pack</span><span> </span><span class="hs-identifier">hst</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">port</span><span> </span><span class="hs-identifier">prt</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">auth</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-311"></span><span>     </span><span class="hs-identifier">port</span><span> </span><span class="hs-special">(</span><span class="hs-char">':'</span><span class="hs-glyph">:</span><span class="hs-identifier">xs</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">readDef</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">defaultHTTPport</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span> </span><span class="hs-identifier">xs</span><span>
</span><span id="line-312"></span><span>     </span><span class="hs-identifier">port</span><span> </span><span class="hs-identifier">_</span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">defaultHTTPport</span><span> </span><span class="hs-identifier">proto</span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>     </span><span class="hs-identifier">auth</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-315"></span><span>       </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier">auth'</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-316"></span><span>         </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><span id="line-317"></span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">Just</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-identifier">S8.pack</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">U.unEscapeString</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">usr</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">S8.pack</span><span> </span><span class="hs-operator">.</span><span> </span><span class="hs-identifier">U.unEscapeString</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">pwd</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>          </span><span class="hs-keyword">where</span><span>
</span><span id="line-319"></span><span>           </span><span class="hs-special">(</span><span class="hs-identifier">usr</span><span class="hs-special">,</span><span class="hs-identifier">pwd</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">chopAtDelim</span><span> </span><span class="hs-char">':'</span><span> </span><span class="hs-keyword">as</span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span class="hs-identifier">uri2proxy</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span class="hs-identifier">regQueryValueDWORD</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">HKEY</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">String</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">Maybe</span><span> </span><span class="hs-identifier">DWORD</span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span class="hs-identifier">regQueryValueDWORD</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">alloca</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">ptr</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>  </span><span class="hs-identifier">key</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">regQueryValueEx</span><span> </span><span class="hs-identifier">hkey</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">castPtr</span><span> </span><span class="hs-identifier">ptr</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">sizeOf</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">undefined</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">DWORD</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-identifier">key</span><span> </span><span class="hs-operator">==</span><span> </span><span class="hs-identifier">rEG_DWORD</span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-327"></span><span>      </span><span class="hs-identifier">Just</span><span> </span><span class="hs-operator">A.&lt;$&gt;</span><span> </span><span class="hs-identifier">peek</span><span> </span><span class="hs-identifier">ptr</span><span>
</span><span id="line-328"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="hs-identifier">return</span><span> </span><span class="hs-identifier">Nothing</span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span class="hs-comment">-- defined(mingw32_HOST_OS)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-333"></span><span class="annot"><a href="Network.HTTP.Proxy.html#envName"><span class="hs-identifier hs-type">envName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP.Proxy.html#ProxyProtocol"><span class="hs-identifier hs-type">ProxyProtocol</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP.Proxy.html#EnvName"><span class="hs-identifier hs-type">EnvName</span></a></span><span>
</span><span id="line-334"></span><span id="envName"><span class="annot"><span class="annottext">envName :: ProxyProtocol -&gt; Text
</span><a href="Network.HTTP.Proxy.html#envName"><span class="hs-identifier hs-var hs-var">envName</span></a></span></span><span> </span><span id="local-6989586621679106977"><span class="annot"><span class="annottext">ProxyProtocol
</span><a href="#local-6989586621679106977"><span class="hs-identifier hs-var">proto</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text) -&gt; String -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ProxyProtocol -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ProxyProtocol
</span><a href="#local-6989586621679106977"><span class="hs-identifier hs-var">proto</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_proxy&quot;</span></span><span>
</span><span id="line-335"></span><span>
</span><span id="line-336"></span><span class="hs-comment">-- Extract proxy settings from environment variables. This is a standard way in Linux.</span><span>
</span><span id="line-337"></span><span class="annot"><a href="Network.HTTP.Proxy.html#envHelper"><span class="hs-identifier hs-type">envHelper</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP.Proxy.html#EnvName"><span class="hs-identifier hs-type">EnvName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP.Proxy.html#HostAddress"><span class="hs-identifier hs-type">HostAddress</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier hs-type">ProxySettings</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span id="envHelper"><span class="annot"><span class="annottext">envHelper :: Text -&gt; IO (UserName -&gt; Maybe ProxySettings)
</span><a href="Network.HTTP.Proxy.html#envHelper"><span class="hs-identifier hs-var hs-var">envHelper</span></a></span></span><span> </span><span id="local-6989586621679106979"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679106979"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-339"></span><span>  </span><span id="local-6989586621679106980"><span class="annot"><span class="annottext">[(String, String)]
</span><a href="#local-6989586621679106980"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [(String, String)]
</span><span class="hs-identifier hs-var">getEnvironment</span></span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679106985"><span class="annot"><span class="annottext">lenv :: Map Text String
</span><a href="#local-6989586621679106985"><span class="hs-identifier hs-var hs-var">lenv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Text, String)] -&gt; Map Text String
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Text, String)] -&gt; Map Text String)
-&gt; [(Text, String)] -&gt; Map Text String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((String, String) -&gt; (Text, String))
-&gt; [(String, String)] -&gt; [(Text, String)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(String -&gt; Text) -&gt; (String, String) -&gt; (Text, String)
forall b c d. (b -&gt; c) -&gt; (b, d) -&gt; (c, d)
forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (b, d) (c, d)
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">((String -&gt; Text) -&gt; (String, String) -&gt; (Text, String))
-&gt; (String -&gt; Text) -&gt; (String, String) -&gt; (Text, String)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">T.toLower</span></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; (String -&gt; Text) -&gt; String -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(String, String)]
</span><a href="#local-6989586621679106980"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-341"></span><span>      </span><span id="local-6989586621679106992"><span class="annot"><span class="annottext">lookupEnvVar :: Text -&gt; Maybe String
</span><a href="#local-6989586621679106992"><span class="hs-identifier hs-var hs-var">lookupEnvVar</span></a></span></span><span> </span><span id="local-6989586621679106993"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679106993"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; [(String, String)] -&gt; Maybe String
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; String
</span><span class="hs-identifier hs-var">T.unpack</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679106993"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(String, String)]
</span><a href="#local-6989586621679106980"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe String -&gt; Maybe String -&gt; Maybe String
forall a. Maybe a -&gt; Maybe a -&gt; Maybe a
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">A.&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Map Text String -&gt; Maybe String
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679106993"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Map Text String
</span><a href="#local-6989586621679106985"><span class="hs-identifier hs-var">lenv</span></a></span><span>
</span><span id="line-342"></span><span>      </span><span id="local-6989586621679106999"><span class="annot"><span class="annottext">noProxyDomains :: [UserName]
</span><a href="#local-6989586621679106999"><span class="hs-identifier hs-var hs-var">noProxyDomains</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe String -&gt; [UserName]
</span><a href="#local-6989586621679107000"><span class="hs-identifier hs-var">domainSuffixes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Maybe String
</span><a href="#local-6989586621679106992"><span class="hs-identifier hs-var">lookupEnvVar</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;no_proxy&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe String
</span><a href="#local-6989586621679106992"><span class="hs-identifier hs-var">lookupEnvVar</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679106979"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-345"></span><span>      </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(UserName -&gt; Maybe ProxySettings)
-&gt; IO (UserName -&gt; Maybe ProxySettings)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((UserName -&gt; Maybe ProxySettings)
 -&gt; IO (UserName -&gt; Maybe ProxySettings))
-&gt; (Maybe ProxySettings -&gt; UserName -&gt; Maybe ProxySettings)
-&gt; Maybe ProxySettings
-&gt; IO (UserName -&gt; Maybe ProxySettings)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe ProxySettings -&gt; UserName -&gt; Maybe ProxySettings
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ProxySettings -&gt; IO (UserName -&gt; Maybe ProxySettings))
-&gt; Maybe ProxySettings -&gt; IO (UserName -&gt; Maybe ProxySettings)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ProxySettings
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-346"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(UserName -&gt; Maybe ProxySettings)
-&gt; IO (UserName -&gt; Maybe ProxySettings)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((UserName -&gt; Maybe ProxySettings)
 -&gt; IO (UserName -&gt; Maybe ProxySettings))
-&gt; (Maybe ProxySettings -&gt; UserName -&gt; Maybe ProxySettings)
-&gt; Maybe ProxySettings
-&gt; IO (UserName -&gt; Maybe ProxySettings)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Maybe ProxySettings -&gt; UserName -&gt; Maybe ProxySettings
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ProxySettings -&gt; IO (UserName -&gt; Maybe ProxySettings))
-&gt; Maybe ProxySettings -&gt; IO (UserName -&gt; Maybe ProxySettings)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ProxySettings
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-347"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679107002"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679107002"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-348"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679107003"><span class="annot"><span class="annottext">invalid :: IO a
</span><a href="#local-6989586621679107003"><span class="hs-identifier hs-var hs-var">invalid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HttpExceptionContent -&gt; IO a
forall a. HttpExceptionContent -&gt; IO a
</span><a href="Network.HTTP.Client.Types.html#throwHttp"><span class="hs-identifier hs-var">throwHttp</span></a></span><span> </span><span class="annot"><span class="annottext">(HttpExceptionContent -&gt; IO a) -&gt; HttpExceptionContent -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; HttpExceptionContent
</span><a href="Network.HTTP.Client.Types.html#InvalidProxyEnvironmentVariable"><span class="hs-identifier hs-var">InvalidProxyEnvironmentVariable</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679106979"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679107002"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679107005"><span class="annot"><span class="annottext">Proxy
</span><a href="#local-6989586621679107005"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679107006"><span class="annot"><span class="annottext">Maybe (UserName, UserName)
</span><a href="#local-6989586621679107006"><span class="hs-identifier hs-var">muserpass</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Proxy, Maybe (UserName, UserName))
-&gt; ((Proxy, Maybe (UserName, UserName))
    -&gt; IO (Proxy, Maybe (UserName, UserName)))
-&gt; Maybe (Proxy, Maybe (UserName, UserName))
-&gt; IO (Proxy, Maybe (UserName, UserName))
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">IO (Proxy, Maybe (UserName, UserName))
forall {a}. IO a
</span><a href="#local-6989586621679107003"><span class="hs-identifier hs-var">invalid</span></a></span><span> </span><span class="annot"><span class="annottext">(Proxy, Maybe (UserName, UserName))
-&gt; IO (Proxy, Maybe (UserName, UserName))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Proxy, Maybe (UserName, UserName))
 -&gt; IO (Proxy, Maybe (UserName, UserName)))
-&gt; Maybe (Proxy, Maybe (UserName, UserName))
-&gt; IO (Proxy, Maybe (UserName, UserName))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-350"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679107011"><span class="annot"><span class="annottext">allowedScheme :: a -&gt; Bool
</span><a href="#local-6989586621679107011"><span class="hs-identifier hs-var hs-var">allowedScheme</span></a></span></span><span> </span><span id="local-6989586621679107012"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679107012"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679107012"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-string">&quot;http:&quot;</span></span><span>
</span><span id="line-351"></span><span>              </span><span id="local-6989586621679107013"><span class="annot"><span class="annottext">URI
</span><a href="#local-6989586621679107013"><span class="hs-identifier hs-var">uri</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe URI
</span><span class="hs-identifier hs-var">U.parseURI</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679107002"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-352"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679107015"><span class="annot"><span class="annottext">URI
</span><a href="#local-6989586621679107015"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">String -&gt; Bool
forall {a}. (Eq a, IsString a) =&gt; a -&gt; Bool
</span><a href="#local-6989586621679107011"><span class="hs-identifier hs-var">allowedScheme</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">URI -&gt; String
</span><span class="hs-identifier hs-var">U.uriScheme</span></span><span> </span><span class="annot"><span class="annottext">URI
</span><a href="#local-6989586621679107015"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">URI -&gt; Maybe URI
forall a. a -&gt; Maybe a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">URI
</span><a href="#local-6989586621679107015"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-353"></span><span>                  </span><span class="annot"><span class="annottext">Maybe URI
</span><span class="hs-identifier">_</span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe URI
</span><span class="hs-identifier hs-var">U.parseURI</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Maybe URI) -&gt; String -&gt; Maybe URI
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;http://&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679107002"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-354"></span><span>
</span><span id="line-355"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Bool
forall {a}. (Eq a, IsString a) =&gt; a -&gt; Bool
</span><a href="#local-6989586621679107011"><span class="hs-identifier hs-var">allowedScheme</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Bool) -&gt; String -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">URI -&gt; String
</span><span class="hs-identifier hs-var">U.uriScheme</span></span><span> </span><span class="annot"><span class="annottext">URI
</span><a href="#local-6989586621679107013"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-356"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">URI -&gt; String
</span><span class="hs-identifier hs-var">U.uriPath</span></span><span> </span><span class="annot"><span class="annottext">URI
</span><a href="#local-6989586621679107013"><span class="hs-identifier hs-var">uri</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">URI -&gt; String
</span><span class="hs-identifier hs-var">U.uriPath</span></span><span> </span><span class="annot"><span class="annottext">URI
</span><a href="#local-6989586621679107013"><span class="hs-identifier hs-var">uri</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;/&quot;</span></span><span>
</span><span id="line-357"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Bool) -&gt; String -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">URI -&gt; String
</span><span class="hs-identifier hs-var">U.uriQuery</span></span><span> </span><span class="annot"><span class="annottext">URI
</span><a href="#local-6989586621679107013"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-358"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Bool) -&gt; String -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">URI -&gt; String
</span><span class="hs-identifier hs-var">U.uriFragment</span></span><span> </span><span class="annot"><span class="annottext">URI
</span><a href="#local-6989586621679107013"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span>              </span><span id="local-6989586621679107022"><span class="annot"><span class="annottext">URIAuth
</span><a href="#local-6989586621679107022"><span class="hs-identifier hs-var">auth</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">URI -&gt; Maybe URIAuth
</span><span class="hs-identifier hs-var">U.uriAuthority</span></span><span> </span><span class="annot"><span class="annottext">URI
</span><a href="#local-6989586621679107013"><span class="hs-identifier hs-var">uri</span></a></span><span>
</span><span id="line-361"></span><span>              </span><span id="local-6989586621679107024"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679107024"><span class="hs-identifier hs-var">port'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-362"></span><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">URIAuth -&gt; String
</span><span class="hs-identifier hs-var">U.uriPort</span></span><span> </span><span class="annot"><span class="annottext">URIAuth
</span><a href="#local-6989586621679107022"><span class="hs-identifier hs-var">auth</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-363"></span><span>                      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">80</span></span><span>
</span><span id="line-364"></span><span>                      </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">':'</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679107026"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679107026"><span class="hs-identifier hs-var">rest</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-365"></span><span>                          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Reader Int
forall a. Integral a =&gt; Reader a
</span><span class="hs-identifier hs-var">decimal</span></span><span> </span><span class="annot"><span class="annottext">Reader Int -&gt; Reader Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679107026"><span class="hs-identifier hs-var">rest</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-366"></span><span>                              </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679107027"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679107027"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679107027"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-367"></span><span>                              </span><span class="annot"><span class="annottext">Either String (Int, Text)
</span><span class="hs-identifier">_</span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-368"></span><span>                      </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span>              </span><span class="annot"><span class="annottext">(Proxy, Maybe (UserName, UserName))
-&gt; Maybe (Proxy, Maybe (UserName, UserName))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UserName -&gt; Int -&gt; Proxy
</span><a href="Network.HTTP.Client.Types.html#Proxy"><span class="hs-identifier hs-var">Proxy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; UserName
</span><span class="hs-identifier hs-var">S8.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; UserName) -&gt; String -&gt; UserName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">URIAuth -&gt; String
</span><span class="hs-identifier hs-var">U.uriRegName</span></span><span> </span><span class="annot"><span class="annottext">URIAuth
</span><a href="#local-6989586621679107022"><span class="hs-identifier hs-var">auth</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679107024"><span class="hs-identifier hs-var">port'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">URI -&gt; Maybe (UserName, UserName)
</span><a href="Network.HTTP.Client.Request.html#extractBasicAuthInfo"><span class="hs-identifier hs-var">extractBasicAuthInfo</span></a></span><span> </span><span class="annot"><span class="annottext">URI
</span><a href="#local-6989586621679107013"><span class="hs-identifier hs-var">uri</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>          </span><span class="annot"><span class="annottext">(UserName -&gt; Maybe ProxySettings)
-&gt; IO (UserName -&gt; Maybe ProxySettings)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((UserName -&gt; Maybe ProxySettings)
 -&gt; IO (UserName -&gt; Maybe ProxySettings))
-&gt; (UserName -&gt; Maybe ProxySettings)
-&gt; IO (UserName -&gt; Maybe ProxySettings)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679107031"><span class="annot"><span class="annottext">UserName
</span><a href="#local-6989586621679107031"><span class="hs-identifier hs-var">hostRequest</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-372"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">UserName
</span><a href="#local-6989586621679107031"><span class="hs-identifier hs-var">hostRequest</span></a></span><span> </span><span class="annot"><span class="annottext">UserName -&gt; [UserName] -&gt; Bool
forall {t :: * -&gt; *}. Foldable t =&gt; UserName -&gt; t UserName -&gt; Bool
</span><a href="#local-6989586621679107032"><span class="hs-operator hs-var">`hasDomainSuffixIn`</span></a></span><span> </span><span class="annot"><span class="annottext">[UserName]
</span><a href="#local-6989586621679106999"><span class="hs-identifier hs-var">noProxyDomains</span></a></span><span>
</span><span id="line-373"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe ProxySettings
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-374"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ProxySettings -&gt; Maybe ProxySettings
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ProxySettings -&gt; Maybe ProxySettings)
-&gt; ProxySettings -&gt; Maybe ProxySettings
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Proxy -&gt; Maybe (UserName, UserName) -&gt; ProxySettings
</span><a href="Network.HTTP.Proxy.html#ProxySettings"><span class="hs-identifier hs-var">ProxySettings</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy
</span><a href="#local-6989586621679107005"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (UserName, UserName)
</span><a href="#local-6989586621679107006"><span class="hs-identifier hs-var">muserpass</span></a></span><span>
</span><span id="line-375"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679107034"><span class="annot"><span class="annottext">prefixed :: UserName -&gt; UserName
</span><a href="#local-6989586621679107034"><span class="hs-identifier hs-var hs-var">prefixed</span></a></span></span><span> </span><span id="local-6989586621679107035"><span class="annot"><span class="annottext">UserName
</span><a href="#local-6989586621679107035"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UserName -&gt; Char
</span><span class="hs-identifier hs-var">S8.head</span></span><span> </span><span class="annot"><span class="annottext">UserName
</span><a href="#local-6989586621679107035"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'.'</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UserName
</span><a href="#local-6989586621679107035"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-376"></span><span>                   </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; UserName -&gt; UserName
</span><span class="hs-identifier hs-var">S8.cons</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'.'</span></span><span> </span><span class="annot"><span class="annottext">UserName
</span><a href="#local-6989586621679107035"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-377"></span><span>        </span><span id="local-6989586621679107000"><span class="annot"><span class="annottext">domainSuffixes :: Maybe String -&gt; [UserName]
</span><a href="#local-6989586621679107000"><span class="hs-identifier hs-var hs-var">domainSuffixes</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-378"></span><span>        </span><span class="annot"><a href="#local-6989586621679107000"><span class="hs-identifier hs-var">domainSuffixes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-379"></span><span>        </span><span class="annot"><a href="#local-6989586621679107000"><span class="hs-identifier hs-var">domainSuffixes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679107043"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679107043"><span class="hs-identifier hs-var">no_proxy</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">UserName -&gt; UserName
</span><a href="#local-6989586621679107034"><span class="hs-identifier hs-var">prefixed</span></a></span><span> </span><span class="annot"><span class="annottext">(UserName -&gt; UserName) -&gt; UserName -&gt; UserName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Char -&gt; Bool) -&gt; UserName -&gt; UserName
</span><span class="hs-identifier hs-var">S8.dropWhile</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">' '</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UserName
</span><a href="#local-6989586621679107045"><span class="hs-identifier hs-var">suffix</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679107045"><span class="annot"><span class="annottext">UserName
</span><a href="#local-6989586621679107045"><span class="hs-identifier hs-var">suffix</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Char -&gt; UserName -&gt; [UserName]
</span><span class="hs-identifier hs-var">S8.split</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">','</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; UserName
</span><span class="hs-identifier hs-var">S8.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Char -&gt; Char) -&gt; ShowS
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Char
</span><span class="hs-identifier hs-var">toLower</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679107043"><span class="hs-identifier hs-var">no_proxy</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UserName -&gt; Bool
</span><span class="hs-identifier hs-var">S8.null</span></span><span> </span><span class="annot"><span class="annottext">UserName
</span><a href="#local-6989586621679107045"><span class="hs-identifier hs-var">suffix</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-380"></span><span>        </span><span id="local-6989586621679107032"><span class="annot"><span class="annottext">hasDomainSuffixIn :: UserName -&gt; t UserName -&gt; Bool
</span><a href="#local-6989586621679107032"><span class="hs-identifier hs-var hs-var">hasDomainSuffixIn</span></a></span></span><span> </span><span id="local-6989586621679107051"><span class="annot"><span class="annottext">UserName
</span><a href="#local-6989586621679107051"><span class="hs-identifier hs-var">host'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UserName -&gt; Bool) -&gt; t UserName -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UserName -&gt; UserName -&gt; Bool
</span><span class="hs-operator hs-var">`S8.isSuffixOf`</span></span><span> </span><span class="annot"><span class="annottext">UserName -&gt; UserName
</span><a href="#local-6989586621679107034"><span class="hs-identifier hs-var">prefixed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Char -&gt; Char) -&gt; UserName -&gt; UserName
</span><span class="hs-identifier hs-var">S8.map</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Char
</span><span class="hs-identifier hs-var">toLower</span></span><span> </span><span class="annot"><span class="annottext">UserName
</span><a href="#local-6989586621679107051"><span class="hs-identifier hs-var">host'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-381"></span></pre></body></html>