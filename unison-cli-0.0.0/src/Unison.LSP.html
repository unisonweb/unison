<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE PolyKinds #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.LSP</span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Unison.LSP.html#spawnLsp"><span class="hs-identifier">spawnLsp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Unison.LSP.html#LspFormattingConfig"><span class="hs-identifier">LspFormattingConfig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Colog.Core</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LogAction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LogAction</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Colog.Core</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Colog</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Compat.html"><span class="hs-identifier">Compat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Compat.html#onWindows"><span class="hs-identifier">onWindows</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Builder.Extra</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">defaultChunkSize</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Char</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">toLower</span></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.IO.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ioe_errno</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ki</span></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Logging</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LSP</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Message</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Msg</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Types</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Utils.SMethodMap</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Protocol.Utils.SMethodMap</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SMM</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.Server</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.LSP.VFS</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Simple.TCP</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TCP</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Environment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">lookupEnv</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">hPutStrLn</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.ProjectPath</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PP</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Runtime</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Runtime</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Debug</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Debug</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.CancelRequest.html"><span class="hs-identifier">Unison.LSP.CancelRequest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.CancelRequest.html#cancelRequestHandler"><span class="hs-identifier">cancelRequestHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.CodeAction.html"><span class="hs-identifier">Unison.LSP.CodeAction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.CodeAction.html#codeActionHandler"><span class="hs-identifier">codeActionHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.CodeLens.html"><span class="hs-identifier">Unison.LSP.CodeLens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.CodeLens.html#codeLensHandler"><span class="hs-identifier">codeLensHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Commands.html"><span class="hs-identifier">Unison.LSP.Commands</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Commands.html#executeCommandHandler"><span class="hs-identifier">executeCommandHandler</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.LSP.Commands.html#supportedCommands"><span class="hs-identifier">supportedCommands</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Completion.html"><span class="hs-identifier">Unison.LSP.Completion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Completion.html#completionHandler"><span class="hs-identifier">completionHandler</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.LSP.Completion.html#completionItemResolveHandler"><span class="hs-identifier">completionItemResolveHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Configuration.html"><span class="hs-identifier">Unison.LSP.Configuration</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Config</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.FileAnalysis.html"><span class="hs-identifier">Unison.LSP.FileAnalysis</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Analysis</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.FoldingRange.html"><span class="hs-identifier">Unison.LSP.FoldingRange</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.FoldingRange.html#foldingRangeRequest"><span class="hs-identifier">foldingRangeRequest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Formatting.html"><span class="hs-identifier">Unison.LSP.Formatting</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Formatting.html#formatDocRequest"><span class="hs-identifier">formatDocRequest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.LSP.Formatting.html#formatRangeRequest"><span class="hs-identifier">formatRangeRequest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.HandlerUtils.html"><span class="hs-identifier">Unison.LSP.HandlerUtils</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Handlers</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Hover.html"><span class="hs-identifier">Unison.LSP.Hover</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Hover.html#hoverHandler"><span class="hs-identifier">hoverHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.NotificationHandlers.html"><span class="hs-identifier">Unison.LSP.NotificationHandlers</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Notifications</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Orphans.html"><span class="hs-identifier">Unison.LSP.Orphans</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html"><span class="hs-identifier">Unison.LSP.Types</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.UCMWorker.html"><span class="hs-identifier">Unison.LSP.UCMWorker</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.UCMWorker.html#ucmWorker"><span class="hs-identifier">ucmWorker</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.Util.Signal.html"><span class="hs-identifier">Unison.LSP.Util.Signal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Util.Signal.html#Signal"><span class="hs-identifier">Signal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.LSP.VFS.html"><span class="hs-identifier">Unison.LSP.VFS</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VFS</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Parser.Ann</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Symbol</span></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO.Foreign</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Errno</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">eADDRINUSE</span></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-keyword">data</span><span> </span><span id="LspFormattingConfig"><span class="annot"><a href="Unison.LSP.html#LspFormattingConfig"><span class="hs-identifier hs-var">LspFormattingConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LspFormatEnabled"><span class="annot"><a href="Unison.LSP.html#LspFormatEnabled"><span class="hs-identifier hs-var">LspFormatEnabled</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="LspFormatDisabled"><span class="annot"><a href="Unison.LSP.html#LspFormatDisabled"><span class="hs-identifier hs-var">LspFormatDisabled</span></a></span></span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680885551"><span id="local-6989586621680885553"><span id="local-6989586621680885557"><span class="annot"><span class="annottext">Int -&gt; LspFormattingConfig -&gt; ShowS
[LspFormattingConfig] -&gt; ShowS
LspFormattingConfig -&gt; String
(Int -&gt; LspFormattingConfig -&gt; ShowS)
-&gt; (LspFormattingConfig -&gt; String)
-&gt; ([LspFormattingConfig] -&gt; ShowS)
-&gt; Show LspFormattingConfig
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; LspFormattingConfig -&gt; ShowS
showsPrec :: Int -&gt; LspFormattingConfig -&gt; ShowS
$cshow :: LspFormattingConfig -&gt; String
show :: LspFormattingConfig -&gt; String
$cshowList :: [LspFormattingConfig] -&gt; ShowS
showList :: [LspFormattingConfig] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680885561"><span id="local-6989586621680885563"><span class="annot"><span class="annottext">LspFormattingConfig -&gt; LspFormattingConfig -&gt; Bool
(LspFormattingConfig -&gt; LspFormattingConfig -&gt; Bool)
-&gt; (LspFormattingConfig -&gt; LspFormattingConfig -&gt; Bool)
-&gt; Eq LspFormattingConfig
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: LspFormattingConfig -&gt; LspFormattingConfig -&gt; Bool
== :: LspFormattingConfig -&gt; LspFormattingConfig -&gt; Bool
$c/= :: LspFormattingConfig -&gt; LspFormattingConfig -&gt; Bool
/= :: LspFormattingConfig -&gt; LspFormattingConfig -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="annot"><a href="Unison.LSP.html#getLspPort"><span class="hs-identifier hs-type">getLspPort</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-61"></span><span id="getLspPort"><span class="annot"><span class="annottext">getLspPort :: IO String
</span><a href="Unison.LSP.html#getLspPort"><span class="hs-identifier hs-var hs-var">getLspPort</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; String
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;5757&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe String -&gt; String) -&gt; IO (Maybe String) -&gt; IO String
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Maybe String)
</span><span class="hs-identifier hs-var">lookupEnv</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;UNISON_LSP_PORT&quot;</span></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="annot"><span class="hs-comment">-- | Spawn an LSP server on the configured port.</span></span><span>
</span><span id="line-64"></span><span class="annot"><a href="Unison.LSP.html#spawnLsp"><span class="hs-identifier hs-type">spawnLsp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><a href="Unison.LSP.html#LspFormattingConfig"><span class="hs-identifier hs-type">LspFormattingConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-67"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Runtime</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-68"></span><span>  </span><span class="annot"><a href="Unison.LSP.Util.Signal.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PP.ProjectPathIds</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-69"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span id="spawnLsp"><span class="annot"><span class="annottext">spawnLsp :: LspFormattingConfig
-&gt; Codebase IO Symbol Ann
-&gt; Runtime Symbol
-&gt; Signal ProjectPathIds
-&gt; IO ()
</span><a href="Unison.LSP.html#spawnLsp"><span class="hs-identifier hs-var hs-var">spawnLsp</span></a></span></span><span> </span><span id="local-6989586621680885570"><span class="annot"><span class="annottext">LspFormattingConfig
</span><a href="#local-6989586621680885570"><span class="hs-identifier hs-var">lspFormattingConfig</span></a></span></span><span> </span><span id="local-6989586621680885571"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621680885571"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621680885572"><span class="annot"><span class="annottext">Runtime Symbol
</span><a href="#local-6989586621680885572"><span class="hs-identifier hs-var">runtime</span></a></span></span><span> </span><span id="local-6989586621680885573"><span class="annot"><span class="annottext">Signal ProjectPathIds
</span><a href="#local-6989586621680885573"><span class="hs-identifier hs-var">signal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-71"></span><span>  </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
</span><a href="#local-6989586621680885574"><span class="hs-identifier hs-var">ifEnabled</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; (IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">TCP.withSocketsDo</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-72"></span><span>    </span><span id="local-6989586621680885577"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680885577"><span class="hs-identifier hs-var">lspPort</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO String
</span><a href="Unison.LSP.html#getLspPort"><span class="hs-identifier hs-var">getLspPort</span></a></span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="annottext">(IOException -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a.
MonadUnliftIO m =&gt;
(IOException -&gt; m a) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">UnliftIO.handleIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; IOException -&gt; IO ()
</span><a href="#local-6989586621680885579"><span class="hs-identifier hs-var">handleFailure</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680885577"><span class="hs-identifier hs-var">lspPort</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-74"></span><span>      </span><span class="annot"><span class="annottext">HostPreference -&gt; String -&gt; ((Socket, SockAddr) -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
HostPreference -&gt; String -&gt; ((Socket, SockAddr) -&gt; IO ()) -&gt; m a
</span><span class="hs-identifier hs-var">TCP.serve</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; HostPreference
</span><span class="hs-identifier hs-var">TCP.Host</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;127.0.0.1&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680885577"><span class="hs-identifier hs-var">lspPort</span></a></span><span> </span><span class="annot"><span class="annottext">(((Socket, SockAddr) -&gt; IO ()) -&gt; IO ())
-&gt; ((Socket, SockAddr) -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680885582"><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621680885582"><span class="hs-identifier hs-var">sock</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680885583"><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621680885583"><span class="hs-identifier hs-var">_sockaddr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-75"></span><span>        </span><span class="annot"><span class="annottext">(Scope -&gt; IO ()) -&gt; IO ()
forall a. (Scope -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">Ki.scoped</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680885585"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680885585"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-76"></span><span>          </span><span class="hs-comment">-- If the socket is closed, reading/writing will throw an exception,</span><span>
</span><span id="line-77"></span><span>          </span><span class="hs-comment">-- but since the socket is closed, this connection will be shutting down</span><span>
</span><span id="line-78"></span><span>          </span><span class="hs-comment">-- immediately anyways, so we just ignore it.</span><span>
</span><span id="line-79"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680885586"><span class="annot"><span class="annottext">clientInput :: IO ByteString
</span><a href="#local-6989586621680885586"><span class="hs-identifier hs-var hs-var">clientInput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; IO ByteString) -&gt; IO ByteString -&gt; IO ByteString
forall (m :: * -&gt; *) a.
MonadUnliftIO m =&gt;
(SomeException -&gt; m a) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">handleAny</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-80"></span><span>                </span><span class="hs-comment">-- The server will be in the process of shutting down if the socket is closed,</span><span>
</span><span id="line-81"></span><span>                </span><span class="hs-comment">-- so just return empty input in the meantime.</span><span>
</span><span id="line-82"></span><span>                </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString -&gt; ByteString
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ByteString -&gt; ByteString)
-&gt; IO (Maybe ByteString) -&gt; IO ByteString
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Socket -&gt; Int -&gt; IO (Maybe ByteString)
forall (m :: * -&gt; *).
MonadIO m =&gt;
Socket -&gt; Int -&gt; m (Maybe ByteString)
</span><span class="hs-identifier hs-var">TCP.recv</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621680885582"><span class="hs-identifier hs-var">sock</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier hs-var">defaultChunkSize</span></span><span>
</span><span id="line-83"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680885589"><span class="annot"><span class="annottext">clientOutput :: ByteString -&gt; IO ()
</span><a href="#local-6989586621680885589"><span class="hs-identifier hs-var hs-var">clientOutput</span></a></span></span><span> </span><span id="local-6989586621680885590"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680885590"><span class="hs-identifier hs-var">output</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SomeException -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a.
MonadUnliftIO m =&gt;
(SomeException -&gt; m a) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">handleAny</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-84"></span><span>                </span><span class="annot"><span class="annottext">Socket -&gt; ByteString -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; Socket -&gt; ByteString -&gt; m ()
</span><span class="hs-identifier hs-var">TCP.sendLazy</span></span><span> </span><span class="annot"><span class="annottext">Socket
</span><a href="#local-6989586621680885582"><span class="hs-identifier hs-var">sock</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621680885590"><span class="hs-identifier hs-var">output</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>          </span><span class="hs-comment">-- currently we have an independent VFS for each LSP client since each client might have</span><span>
</span><span id="line-87"></span><span>          </span><span class="hs-comment">-- different un-saved state for the same file.</span><span>
</span><span id="line-88"></span><span>          </span><span class="hs-keyword">do</span><span>
</span><span id="line-89"></span><span>            </span><span id="local-6989586621680885592"><span class="annot"><span class="annottext">MVar VFS
</span><a href="#local-6989586621680885592"><span class="hs-identifier hs-var">vfsVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VFS -&gt; IO (MVar VFS)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (MVar a)
</span><span class="hs-identifier hs-var">newMVar</span></span><span> </span><span class="annot"><span class="annottext">VFS
</span><span class="hs-identifier hs-var">emptyVFS</span></span><span>
</span><span id="line-90"></span><span>            </span><span class="annot"><span class="annottext">IO Int -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO Int -&gt; IO ()) -&gt; IO Int -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LogAction IO (WithSeverity LspServerLog)
-&gt; LogAction (LspM Config) (WithSeverity LspServerLog)
-&gt; IO ByteString
-&gt; (ByteString -&gt; IO ())
-&gt; ServerDefinition Config
-&gt; IO Int
forall config.
LogAction IO (WithSeverity LspServerLog)
-&gt; LogAction (LspM config) (WithSeverity LspServerLog)
-&gt; IO ByteString
-&gt; (ByteString -&gt; IO ())
-&gt; ServerDefinition config
-&gt; IO Int
</span><span class="hs-identifier hs-var">runServerWith</span></span><span> </span><span class="annot"><span class="annottext">LogAction IO (WithSeverity LspServerLog)
</span><a href="#local-6989586621680885597"><span class="hs-identifier hs-var">lspServerLogger</span></a></span><span> </span><span class="annot"><span class="annottext">LogAction (LspM Config) (WithSeverity LspServerLog)
</span><a href="#local-6989586621680885598"><span class="hs-identifier hs-var">lspClientLogger</span></a></span><span> </span><span class="annot"><span class="annottext">IO ByteString
</span><a href="#local-6989586621680885586"><span class="hs-identifier hs-var">clientInput</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ()
</span><a href="#local-6989586621680885589"><span class="hs-identifier hs-var">clientOutput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LspFormattingConfig
-&gt; MVar VFS
-&gt; Codebase IO Symbol Ann
-&gt; Runtime Symbol
-&gt; Scope
-&gt; Signal ProjectPathIds
-&gt; ServerDefinition Config
</span><a href="Unison.LSP.html#serverDefinition"><span class="hs-identifier hs-var">serverDefinition</span></a></span><span> </span><span class="annot"><span class="annottext">LspFormattingConfig
</span><a href="#local-6989586621680885570"><span class="hs-identifier hs-var">lspFormattingConfig</span></a></span><span> </span><span class="annot"><span class="annottext">MVar VFS
</span><a href="#local-6989586621680885592"><span class="hs-identifier hs-var">vfsVar</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621680885571"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Runtime Symbol
</span><a href="#local-6989586621680885572"><span class="hs-identifier hs-var">runtime</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680885585"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">Signal ProjectPathIds
</span><a href="#local-6989586621680885573"><span class="hs-identifier hs-var">signal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><a href="#local-6989586621680885579"><span class="hs-identifier hs-type">handleFailure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IOException</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>    </span><span id="local-6989586621680885579"><span class="annot"><span class="annottext">handleFailure :: String -&gt; IOException -&gt; IO ()
</span><a href="#local-6989586621680885579"><span class="hs-identifier hs-var hs-var">handleFailure</span></a></span></span><span> </span><span id="local-6989586621680885600"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680885600"><span class="hs-identifier hs-var">lspPort</span></a></span></span><span> </span><span id="local-6989586621680885601"><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621680885601"><span class="hs-identifier hs-var">ioerr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-94"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CInt -&gt; Errno
</span><span class="hs-identifier hs-var">Errno</span></span><span> </span><span class="annot"><span class="annottext">(CInt -&gt; Errno) -&gt; Maybe CInt -&gt; Maybe Errno
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IOException -&gt; Maybe CInt
</span><span class="hs-identifier hs-var">ioe_errno</span></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621680885601"><span class="hs-identifier hs-var">ioerr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-95"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680885603"><span class="annot"><span class="annottext">Errno
</span><a href="#local-6989586621680885603"><span class="hs-identifier hs-var">errNo</span></a></span></span><span>
</span><span id="line-96"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Errno
</span><a href="#local-6989586621680885603"><span class="hs-identifier hs-var">errNo</span></a></span><span> </span><span class="annot"><span class="annottext">Errno -&gt; Errno -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Errno
</span><span class="hs-identifier hs-var">eADDRINUSE</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-97"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Note: Port &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680885600"><span class="hs-identifier hs-var">lspPort</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; is already bound by another process or another UCM. The LSP server will not be started.&quot;</span></span><span>
</span><span id="line-98"></span><span>        </span><span class="annot"><span class="annottext">Maybe Errno
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-99"></span><span>          </span><span class="annot"><span class="annottext">DebugFlag -&gt; String -&gt; IOException -&gt; IO ()
forall a (m :: * -&gt; *).
(Show a, Monad m) =&gt;
DebugFlag -&gt; String -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">Debug.debugM</span></span><span> </span><span class="annot"><span class="annottext">DebugFlag
</span><span class="hs-identifier hs-var">Debug.LSP</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;LSP Exception&quot;</span></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621680885601"><span class="hs-identifier hs-var">ioerr</span></a></span><span>
</span><span id="line-100"></span><span>          </span><span class="annot"><span class="annottext">DebugFlag -&gt; String -&gt; Maybe CInt -&gt; IO ()
forall a (m :: * -&gt; *).
(Show a, Monad m) =&gt;
DebugFlag -&gt; String -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">Debug.debugM</span></span><span> </span><span class="annot"><span class="annottext">DebugFlag
</span><span class="hs-identifier hs-var">Debug.LSP</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;LSP Errno&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IOException -&gt; Maybe CInt
</span><span class="hs-identifier hs-var">ioe_errno</span></span><span> </span><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621680885601"><span class="hs-identifier hs-var">ioerr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;LSP server failed to start.&quot;</span></span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">-- Where to send logs that occur before a client connects</span><span>
</span><span id="line-103"></span><span>    </span><span id="local-6989586621680885597"><span class="annot"><span class="annottext">lspServerLogger :: LogAction IO (WithSeverity LspServerLog)
</span><a href="#local-6989586621680885597"><span class="hs-identifier hs-var hs-var">lspServerLogger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Severity
-&gt; (WithSeverity LspServerLog -&gt; Severity)
-&gt; LogAction IO (WithSeverity LspServerLog)
-&gt; LogAction IO (WithSeverity LspServerLog)
forall (m :: * -&gt; *) a.
Applicative m =&gt;
Severity -&gt; (a -&gt; Severity) -&gt; LogAction m a -&gt; LogAction m a
</span><span class="hs-identifier hs-var">Colog.filterBySeverity</span></span><span> </span><span class="annot"><span class="annottext">Severity
</span><span class="hs-identifier hs-var">Colog.Error</span></span><span> </span><span class="annot"><span class="annottext">WithSeverity LspServerLog -&gt; Severity
forall msg. WithSeverity msg -&gt; Severity
</span><span class="hs-identifier hs-var">Colog.getSeverity</span></span><span> </span><span class="annot"><span class="annottext">(LogAction IO (WithSeverity LspServerLog)
 -&gt; LogAction IO (WithSeverity LspServerLog))
-&gt; LogAction IO (WithSeverity LspServerLog)
-&gt; LogAction IO (WithSeverity LspServerLog)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(WithSeverity LspServerLog -&gt; WithSeverity Text)
-&gt; LogAction IO (WithSeverity Text)
-&gt; LogAction IO (WithSeverity LspServerLog)
forall a b (m :: * -&gt; *).
(a -&gt; b) -&gt; LogAction m b -&gt; LogAction m a
</span><span class="hs-identifier hs-var">Colog.cmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LspServerLog -&gt; Text)
-&gt; WithSeverity LspServerLog -&gt; WithSeverity Text
forall a b. (a -&gt; b) -&gt; WithSeverity a -&gt; WithSeverity b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">LspServerLog -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">tShow</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(WithSeverity Text -&gt; IO ()) -&gt; LogAction IO (WithSeverity Text)
forall (m :: * -&gt; *) msg. (msg -&gt; m ()) -&gt; LogAction m msg
</span><span class="hs-identifier hs-var">LogAction</span></span><span> </span><span class="annot"><span class="annottext">WithSeverity Text -&gt; IO ()
forall a. Show a =&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">print</span></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-comment">-- Where to send logs that occur after a client connects</span><span>
</span><span id="line-105"></span><span>    </span><span id="local-6989586621680885598"><span class="annot"><span class="annottext">lspClientLogger :: LogAction (LspM Config) (WithSeverity LspServerLog)
</span><a href="#local-6989586621680885598"><span class="hs-identifier hs-var hs-var">lspClientLogger</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(WithSeverity LspServerLog -&gt; WithSeverity Text)
-&gt; LogAction (LspM Config) (WithSeverity Text)
-&gt; LogAction (LspM Config) (WithSeverity LspServerLog)
forall a b (m :: * -&gt; *).
(a -&gt; b) -&gt; LogAction m b -&gt; LogAction m a
</span><span class="hs-identifier hs-var">Colog.cmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LspServerLog -&gt; Text)
-&gt; WithSeverity LspServerLog -&gt; WithSeverity Text
forall a b. (a -&gt; b) -&gt; WithSeverity a -&gt; WithSeverity b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">LspServerLog -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">tShow</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LogAction (LspM Config) (WithSeverity Text)
forall c (m :: * -&gt; *).
MonadLsp c m =&gt;
LogAction m (WithSeverity Text)
</span><span class="hs-identifier hs-var">LSP.defaultClientLogger</span></span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><a href="#local-6989586621680885574"><span class="hs-identifier hs-type">ifEnabled</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>    </span><span id="local-6989586621680885574"><span class="annot"><span class="annottext">ifEnabled :: IO () -&gt; IO ()
</span><a href="#local-6989586621680885574"><span class="hs-identifier hs-var hs-var">ifEnabled</span></a></span></span><span> </span><span id="local-6989586621680885636"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680885636"><span class="hs-identifier hs-var">runServer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-comment">-- Default LSP to disabled on Windows unless explicitly enabled</span><span>
</span><span id="line-109"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; IO (Maybe String)
</span><span class="hs-identifier hs-var">lookupEnv</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;UNISON_LSP_ENABLED&quot;</span></span><span> </span><span class="annot"><span class="annottext">IO (Maybe String) -&gt; (Maybe String -&gt; IO ()) -&gt; IO ()
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-110"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Char -&gt; Char) -&gt; ShowS
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Char
</span><span class="hs-identifier hs-var">toLower</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;false&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Char -&gt; Char) -&gt; ShowS
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Char
</span><span class="hs-identifier hs-var">toLower</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;true&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680885636"><span class="hs-identifier hs-var">runServer</span></a></span><span>
</span><span id="line-112"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621680885637"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680885637"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; String -&gt; IO ()
</span><span class="hs-identifier hs-var">hPutStrLn</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><span class="hs-identifier hs-var">stderr</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Invalid value for UNISON_LSP_ENABLED, expected 'true' or 'false' but found: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680885637"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-113"></span><span>        </span><span class="annot"><span class="annottext">Maybe String
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="Compat.html#onWindows"><span class="hs-identifier hs-var">onWindows</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680885636"><span class="hs-identifier hs-var">runServer</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="annot"><a href="Unison.LSP.html#serverDefinition"><span class="hs-identifier hs-type">serverDefinition</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><a href="Unison.LSP.html#LspFormattingConfig"><span class="hs-identifier hs-type">LspFormattingConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">VFS</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-118"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Runtime</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-120"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Ki.Scope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-121"></span><span>  </span><span class="annot"><a href="Unison.LSP.Util.Signal.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PP.ProjectPathIds</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-122"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ServerDefinition</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span>
</span><span id="line-123"></span><span id="serverDefinition"><span class="annot"><span class="annottext">serverDefinition :: LspFormattingConfig
-&gt; MVar VFS
-&gt; Codebase IO Symbol Ann
-&gt; Runtime Symbol
-&gt; Scope
-&gt; Signal ProjectPathIds
-&gt; ServerDefinition Config
</span><a href="Unison.LSP.html#serverDefinition"><span class="hs-identifier hs-var hs-var">serverDefinition</span></a></span></span><span> </span><span id="local-6989586621680885641"><span class="annot"><span class="annottext">LspFormattingConfig
</span><a href="#local-6989586621680885641"><span class="hs-identifier hs-var">lspFormattingConfig</span></a></span></span><span> </span><span id="local-6989586621680885642"><span class="annot"><span class="annottext">MVar VFS
</span><a href="#local-6989586621680885642"><span class="hs-identifier hs-var">vfsVar</span></a></span></span><span> </span><span id="local-6989586621680885643"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621680885643"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621680885644"><span class="annot"><span class="annottext">Runtime Symbol
</span><a href="#local-6989586621680885644"><span class="hs-identifier hs-var">runtime</span></a></span></span><span> </span><span id="local-6989586621680885645"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680885645"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621680885646"><span class="annot"><span class="annottext">Signal ProjectPathIds
</span><a href="#local-6989586621680885646"><span class="hs-identifier hs-var">signal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-124"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">ServerDefinition</span></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">defaultConfig :: Config
</span><span class="hs-identifier hs-var">defaultConfig</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="Unison.LSP.Types.html#defaultLSPConfig"><span class="hs-identifier hs-var">defaultLSPConfig</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-126"></span><span>      </span><span class="annot"><span class="annottext">configSection :: Text
</span><span class="hs-identifier hs-var">configSection</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;unison&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-127"></span><span>      </span><span class="annot"><span class="annottext">parseConfig :: Config -&gt; Value -&gt; Either Text Config
</span><span class="hs-identifier hs-var">parseConfig</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config -&gt; Value -&gt; Either Text Config
</span><a href="Unison.LSP.Configuration.html#parseConfig"><span class="hs-identifier hs-var">Config.parseConfig</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-128"></span><span>      </span><span class="annot"><span class="annottext">onConfigChange :: Config -&gt; Lsp ()
</span><span class="hs-identifier hs-var">onConfigChange</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config -&gt; Lsp ()
forall (m :: * -&gt; *). Applicative m =&gt; Config -&gt; m ()
</span><a href="Unison.LSP.Configuration.html#updateConfig"><span class="hs-identifier hs-var">Config.updateConfig</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-129"></span><span>      </span><span class="annot"><span class="annottext">doInitialize :: LanguageContextEnv Config
-&gt; TMessage 'Method_Initialize -&gt; IO (Either ResponseError Env)
</span><span class="hs-identifier hs-var">doInitialize</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar VFS
-&gt; Codebase IO Symbol Ann
-&gt; Runtime Symbol
-&gt; Scope
-&gt; Signal ProjectPathIds
-&gt; LanguageContextEnv Config
-&gt; TMessage 'Method_Initialize
-&gt; IO (Either ResponseError Env)
</span><a href="Unison.LSP.html#lspDoInitialize"><span class="hs-identifier hs-var">lspDoInitialize</span></a></span><span> </span><span class="annot"><span class="annottext">MVar VFS
</span><a href="#local-6989586621680885642"><span class="hs-identifier hs-var">vfsVar</span></a></span><span> </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621680885643"><span class="hs-identifier hs-var">codebase</span></a></span><span> </span><span class="annot"><span class="annottext">Runtime Symbol
</span><a href="#local-6989586621680885644"><span class="hs-identifier hs-var">runtime</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680885645"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">Signal ProjectPathIds
</span><a href="#local-6989586621680885646"><span class="hs-identifier hs-var">signal</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-130"></span><span>      </span><span class="annot"><span class="annottext">staticHandlers :: ClientCapabilities -&gt; Handlers Lsp
</span><span class="hs-identifier hs-var">staticHandlers</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LspFormattingConfig -&gt; ClientCapabilities -&gt; Handlers Lsp
</span><a href="Unison.LSP.html#lspStaticHandlers"><span class="hs-identifier hs-var">lspStaticHandlers</span></a></span><span> </span><span class="annot"><span class="annottext">LspFormattingConfig
</span><a href="#local-6989586621680885641"><span class="hs-identifier hs-var">lspFormattingConfig</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-131"></span><span>      </span><span class="annot"><span class="annottext">interpretHandler :: Env -&gt; Lsp &lt;~&gt; IO
</span><span class="hs-identifier hs-var">interpretHandler</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Lsp &lt;~&gt; IO
</span><a href="Unison.LSP.html#lspInterpretHandler"><span class="hs-identifier hs-var">lspInterpretHandler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-132"></span><span>      </span><span class="annot"><span class="annottext">options :: Options
</span><span class="hs-identifier hs-var">options</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Options
</span><a href="Unison.LSP.html#lspOptions"><span class="hs-identifier hs-var">lspOptions</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span class="annot"><span class="hs-comment">-- | Initialize any context needed by the LSP server</span></span><span>
</span><span id="line-136"></span><span class="annot"><a href="Unison.LSP.html#lspDoInitialize"><span class="hs-identifier hs-type">lspDoInitialize</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-137"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">VFS</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Codebase</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-139"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Runtime</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Ki.Scope</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-141"></span><span>  </span><span class="annot"><a href="Unison.LSP.Util.Signal.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">PP.ProjectPathIds</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-142"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">LanguageContextEnv</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-143"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Msg.TMessage</span></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Msg.Method_Initialize</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Msg.ResponseError</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span id="lspDoInitialize"><span class="annot"><span class="annottext">lspDoInitialize :: MVar VFS
-&gt; Codebase IO Symbol Ann
-&gt; Runtime Symbol
-&gt; Scope
-&gt; Signal ProjectPathIds
-&gt; LanguageContextEnv Config
-&gt; TMessage 'Method_Initialize
-&gt; IO (Either ResponseError Env)
</span><a href="Unison.LSP.html#lspDoInitialize"><span class="hs-identifier hs-var hs-var">lspDoInitialize</span></a></span></span><span> </span><span id="local-6989586621680885663"><span class="annot"><span class="annottext">MVar VFS
</span><a href="#local-6989586621680885663"><span class="hs-identifier hs-var">vfsVar</span></a></span></span><span> </span><span id="local-6989586621680885664"><span class="annot"><span class="annottext">Codebase IO Symbol Ann
</span><a href="#local-6989586621680885664"><span class="hs-identifier hs-var">codebase</span></a></span></span><span> </span><span id="local-6989586621680885665"><span class="annot"><span class="annottext">Runtime Symbol
</span><a href="#local-6989586621680885665"><span class="hs-identifier hs-var">runtime</span></a></span></span><span> </span><span id="local-6989586621680885666"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680885666"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621680885667"><span class="annot"><span class="annottext">Signal ProjectPathIds
</span><a href="#local-6989586621680885667"><span class="hs-identifier hs-var">signal</span></a></span></span><span> </span><span id="local-6989586621680885668"><span class="annot"><span class="annottext">LanguageContextEnv Config
</span><a href="#local-6989586621680885668"><span class="hs-identifier hs-var">lspContext</span></a></span></span><span> </span><span id="local-6989586621680885669"><span class="annot"><span class="annottext">TMessage 'Method_Initialize
</span><a href="#local-6989586621680885669"><span class="hs-identifier hs-var">_initMsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>  </span><span id="local-6989586621680885670"><span class="annot"><span class="annottext">TVar (Map Uri (TMVar FileAnalysis))
</span><a href="#local-6989586621680885670"><span class="hs-identifier hs-var">checkedFilesVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map Uri (TMVar FileAnalysis)
-&gt; IO (TVar (Map Uri (TMVar FileAnalysis)))
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Map Uri (TMVar FileAnalysis)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-147"></span><span>  </span><span id="local-6989586621680885672"><span class="annot"><span class="annottext">TVar (Set Uri)
</span><a href="#local-6989586621680885672"><span class="hs-identifier hs-var">dirtyFilesVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set Uri -&gt; IO (TVar (Set Uri))
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Set Uri
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-148"></span><span>  </span><span id="local-6989586621680885673"><span class="annot"><span class="annottext">TMVar PrettyPrintEnvDecl
</span><a href="#local-6989586621680885673"><span class="hs-identifier hs-var">ppedCacheVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TMVar PrettyPrintEnvDecl)
forall (m :: * -&gt; *) a. MonadIO m =&gt; m (TMVar a)
</span><span class="hs-identifier hs-var">newEmptyTMVarIO</span></span><span>
</span><span id="line-149"></span><span>  </span><span id="local-6989586621680885675"><span class="annot"><span class="annottext">TMVar Names
</span><a href="#local-6989586621680885675"><span class="hs-identifier hs-var">currentNamesCacheVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TMVar Names)
forall (m :: * -&gt; *) a. MonadIO m =&gt; m (TMVar a)
</span><span class="hs-identifier hs-var">newEmptyTMVarIO</span></span><span>
</span><span id="line-150"></span><span>  </span><span id="local-6989586621680885676"><span class="annot"><span class="annottext">TMVar ProjectPath
</span><a href="#local-6989586621680885676"><span class="hs-identifier hs-var">currentPathCacheVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TMVar ProjectPath)
forall (m :: * -&gt; *) a. MonadIO m =&gt; m (TMVar a)
</span><span class="hs-identifier hs-var">newEmptyTMVarIO</span></span><span>
</span><span id="line-151"></span><span>  </span><span id="local-6989586621680885677"><span class="annot"><span class="annottext">TVar (Map (Int32 |? Text) (IO ()))
</span><a href="#local-6989586621680885677"><span class="hs-identifier hs-var">cancellationMapVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map (Int32 |? Text) (IO ())
-&gt; IO (TVar (Map (Int32 |? Text) (IO ())))
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Map (Int32 |? Text) (IO ())
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-152"></span><span>  </span><span id="local-6989586621680885678"><span class="annot"><span class="annottext">TMVar CompletionTree
</span><a href="#local-6989586621680885678"><span class="hs-identifier hs-var">completionsVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TMVar CompletionTree)
forall (m :: * -&gt; *) a. MonadIO m =&gt; m (TMVar a)
</span><span class="hs-identifier hs-var">newEmptyTMVarIO</span></span><span>
</span><span id="line-153"></span><span>  </span><span id="local-6989586621680885679"><span class="annot"><span class="annottext">TMVar (NameSearch Transaction)
</span><a href="#local-6989586621680885679"><span class="hs-identifier hs-var">nameSearchCacheVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TMVar (NameSearch Transaction))
forall (m :: * -&gt; *) a. MonadIO m =&gt; m (TMVar a)
</span><span class="hs-identifier hs-var">newEmptyTMVarIO</span></span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680885680"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621680885680"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-155"></span><span>        </span><span class="annot"><a href="Unison.LSP.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span>
</span><span id="line-156"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:ppedCache:Env :: IO PrettyPrintEnvDecl
</span><a href="Unison.LSP.Types.html#%24sel%3AppedCache%3AEnv"><span class="hs-identifier hs-var">ppedCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM PrettyPrintEnvDecl -&gt; IO PrettyPrintEnvDecl
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM PrettyPrintEnvDecl -&gt; IO PrettyPrintEnvDecl)
-&gt; STM PrettyPrintEnvDecl -&gt; IO PrettyPrintEnvDecl
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar PrettyPrintEnvDecl -&gt; STM PrettyPrintEnvDecl
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar PrettyPrintEnvDecl
</span><a href="#local-6989586621680885673"><span class="hs-identifier hs-var">ppedCacheVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-157"></span><span>            </span><span class="annot"><span class="annottext">$sel:currentNamesCache:Env :: IO Names
</span><a href="Unison.LSP.Types.html#%24sel%3AcurrentNamesCache%3AEnv"><span class="hs-identifier hs-var">currentNamesCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM Names -&gt; IO Names
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Names -&gt; IO Names) -&gt; STM Names -&gt; IO Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar Names -&gt; STM Names
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar Names
</span><a href="#local-6989586621680885675"><span class="hs-identifier hs-var">currentNamesCacheVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-158"></span><span>            </span><span class="annot"><span class="annottext">$sel:currentProjectPathCache:Env :: IO ProjectPath
</span><a href="Unison.LSP.Types.html#%24sel%3AcurrentProjectPathCache%3AEnv"><span class="hs-identifier hs-var">currentProjectPathCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM ProjectPath -&gt; IO ProjectPath
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM ProjectPath -&gt; IO ProjectPath)
-&gt; STM ProjectPath -&gt; IO ProjectPath
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar ProjectPath -&gt; STM ProjectPath
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar ProjectPath
</span><a href="#local-6989586621680885676"><span class="hs-identifier hs-var">currentPathCacheVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-159"></span><span>            </span><span class="annot"><span class="annottext">$sel:nameSearchCache:Env :: IO (NameSearch Transaction)
</span><a href="Unison.LSP.Types.html#%24sel%3AnameSearchCache%3AEnv"><span class="hs-identifier hs-var">nameSearchCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM (NameSearch Transaction) -&gt; IO (NameSearch Transaction)
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (NameSearch Transaction) -&gt; IO (NameSearch Transaction))
-&gt; STM (NameSearch Transaction) -&gt; IO (NameSearch Transaction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar (NameSearch Transaction) -&gt; STM (NameSearch Transaction)
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar (NameSearch Transaction)
</span><a href="#local-6989586621680885679"><span class="hs-identifier hs-var">nameSearchCacheVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-160"></span><span>            </span><span class="annot"><span class="annottext">MVar VFS
TVar (Map (Int32 |? Text) (IO ()))
TVar (Map Uri (TMVar FileAnalysis))
TVar (Set Uri)
Scope
LanguageContextEnv Config
TMVar CompletionTree
Runtime Symbol
Codebase IO Symbol Ann
vfsVar :: MVar VFS
codebase :: Codebase IO Symbol Ann
runtime :: Runtime Symbol
scope :: Scope
lspContext :: LanguageContextEnv Config
checkedFilesVar :: TVar (Map Uri (TMVar FileAnalysis))
dirtyFilesVar :: TVar (Set Uri)
cancellationMapVar :: TVar (Map (Int32 |? Text) (IO ()))
completionsVar :: TMVar CompletionTree
$sel:lspContext:Env :: LanguageContextEnv Config
$sel:codebase:Env :: Codebase IO Symbol Ann
$sel:vfsVar:Env :: MVar VFS
$sel:runtime:Env :: Runtime Symbol
$sel:checkedFilesVar:Env :: TVar (Map Uri (TMVar FileAnalysis))
$sel:dirtyFilesVar:Env :: TVar (Set Uri)
$sel:cancellationMapVar:Env :: TVar (Map (Int32 |? Text) (IO ()))
$sel:completionsVar:Env :: TMVar CompletionTree
$sel:scope:Env :: Scope
</span><a href="#local-6989586621680885663"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span><span>
</span><span id="line-161"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680885697"><span class="annot"><span class="annottext">lspToIO :: Lsp () -&gt; IO ()
</span><a href="#local-6989586621680885697"><span class="hs-identifier hs-var hs-var">lspToIO</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ReaderT (LanguageContextEnv Config) IO ()
 -&gt; LanguageContextEnv Config -&gt; IO ())
-&gt; LanguageContextEnv Config
-&gt; ReaderT (LanguageContextEnv Config) IO ()
-&gt; IO ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (LanguageContextEnv Config) IO ()
-&gt; LanguageContextEnv Config -&gt; IO ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">LanguageContextEnv Config
</span><a href="#local-6989586621680885668"><span class="hs-identifier hs-var">lspContext</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT (LanguageContextEnv Config) IO () -&gt; IO ())
-&gt; (Lsp () -&gt; ReaderT (LanguageContextEnv Config) IO ())
-&gt; Lsp ()
-&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LspT Config IO () -&gt; ReaderT (LanguageContextEnv Config) IO ()
forall config (m :: * -&gt; *) a.
LspT config m a -&gt; ReaderT (LanguageContextEnv config) m a
</span><span class="hs-identifier hs-var">unLspT</span></span><span> </span><span class="annot"><span class="annottext">(LspT Config IO () -&gt; ReaderT (LanguageContextEnv Config) IO ())
-&gt; (Lsp () -&gt; LspT Config IO ())
-&gt; Lsp ()
-&gt; ReaderT (LanguageContextEnv Config) IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT Env (LspM Config) () -&gt; Env -&gt; LspT Config IO ())
-&gt; Env -&gt; ReaderT Env (LspM Config) () -&gt; LspT Config IO ()
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT Env (LspM Config) () -&gt; Env -&gt; LspT Config IO ()
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621680885680"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT Env (LspM Config) () -&gt; LspT Config IO ())
-&gt; (Lsp () -&gt; ReaderT Env (LspM Config) ())
-&gt; Lsp ()
-&gt; LspT Config IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Lsp () -&gt; ReaderT Env (LspM Config) ()
forall a. Lsp a -&gt; ReaderT Env (LspM Config) a
</span><a href="Unison.LSP.Types.html#%24sel%3ArunLspM%3ALsp"><span class="hs-identifier hs-var">runLspM</span></a></span><span>
</span><span id="line-163"></span><span>  </span><span class="annot"><span class="annottext">Scope -&gt; IO () -&gt; IO (Thread ())
forall a. Scope -&gt; IO a -&gt; IO (Thread a)
</span><span class="hs-identifier hs-var">Ki.fork</span></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680885666"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lsp () -&gt; IO ()
</span><a href="#local-6989586621680885697"><span class="hs-identifier hs-var">lspToIO</span></a></span><span> </span><span class="annot"><span class="annottext">Lsp ()
</span><a href="Unison.LSP.FileAnalysis.html#fileAnalysisWorker"><span class="hs-identifier hs-var">Analysis.fileAnalysisWorker</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>  </span><span class="annot"><span class="annottext">Scope -&gt; IO () -&gt; IO (Thread ())
forall a. Scope -&gt; IO a -&gt; IO (Thread a)
</span><span class="hs-identifier hs-var">Ki.fork</span></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621680885666"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lsp () -&gt; IO ()
</span><a href="#local-6989586621680885697"><span class="hs-identifier hs-var">lspToIO</span></a></span><span> </span><span class="annot"><span class="annottext">(Lsp () -&gt; IO ()) -&gt; Lsp () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar PrettyPrintEnvDecl
-&gt; TMVar Names
-&gt; TMVar (NameSearch Transaction)
-&gt; TMVar ProjectPath
-&gt; Signal ProjectPathIds
-&gt; Lsp ()
</span><a href="Unison.LSP.UCMWorker.html#ucmWorker"><span class="hs-identifier hs-var">ucmWorker</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar PrettyPrintEnvDecl
</span><a href="#local-6989586621680885673"><span class="hs-identifier hs-var">ppedCacheVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar Names
</span><a href="#local-6989586621680885675"><span class="hs-identifier hs-var">currentNamesCacheVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar (NameSearch Transaction)
</span><a href="#local-6989586621680885679"><span class="hs-identifier hs-var">nameSearchCacheVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar ProjectPath
</span><a href="#local-6989586621680885676"><span class="hs-identifier hs-var">currentPathCacheVar</span></a></span><span> </span><span class="annot"><span class="annottext">Signal ProjectPathIds
</span><a href="#local-6989586621680885667"><span class="hs-identifier hs-var">signal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="annot"><span class="annottext">Env -&gt; Either ResponseError Env
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Env -&gt; Either ResponseError Env)
-&gt; Env -&gt; Either ResponseError Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621680885680"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="annot"><span class="hs-comment">-- | LSP request handlers that don't register/unregister dynamically</span></span><span>
</span><span id="line-168"></span><span class="annot"><a href="Unison.LSP.html#lspStaticHandlers"><span class="hs-identifier hs-type">lspStaticHandlers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.LSP.html#LspFormattingConfig"><span class="hs-identifier hs-type">LspFormattingConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ClientCapabilities</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handlers</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span>
</span><span id="line-169"></span><span id="lspStaticHandlers"><span class="annot"><span class="annottext">lspStaticHandlers :: LspFormattingConfig -&gt; ClientCapabilities -&gt; Handlers Lsp
</span><a href="Unison.LSP.html#lspStaticHandlers"><span class="hs-identifier hs-var hs-var">lspStaticHandlers</span></a></span></span><span> </span><span id="local-6989586621680885704"><span class="annot"><span class="annottext">LspFormattingConfig
</span><a href="#local-6989586621680885704"><span class="hs-identifier hs-var">lspFormattingConfig</span></a></span></span><span> </span><span id="local-6989586621680885705"><span class="annot"><span class="annottext">ClientCapabilities
</span><a href="#local-6989586621680885705"><span class="hs-identifier hs-var">_capabilities</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-170"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Handlers</span></span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">reqHandlers :: SMethodMap (ClientMessageHandler Lsp 'Request)
</span><span class="hs-identifier hs-var">reqHandlers</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LspFormattingConfig
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
</span><a href="Unison.LSP.html#lspRequestHandlers"><span class="hs-identifier hs-var">lspRequestHandlers</span></a></span><span> </span><span class="annot"><span class="annottext">LspFormattingConfig
</span><a href="#local-6989586621680885704"><span class="hs-identifier hs-var">lspFormattingConfig</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-172"></span><span>      </span><span class="annot"><span class="annottext">notHandlers :: SMethodMap (ClientMessageHandler Lsp 'Notification)
</span><span class="hs-identifier hs-var">notHandlers</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
</span><a href="Unison.LSP.html#lspNotificationHandlers"><span class="hs-identifier hs-var">lspNotificationHandlers</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="annot"><span class="hs-comment">-- | LSP request handlers</span></span><span>
</span><span id="line-176"></span><span class="annot"><a href="Unison.LSP.html#lspRequestHandlers"><span class="hs-identifier hs-type">lspRequestHandlers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.LSP.html#LspFormattingConfig"><span class="hs-identifier hs-type">LspFormattingConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SMethodMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientMessageHandler</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Msg.Request</span></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span id="lspRequestHandlers"><span class="annot"><span class="annottext">lspRequestHandlers :: LspFormattingConfig
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
</span><a href="Unison.LSP.html#lspRequestHandlers"><span class="hs-identifier hs-var hs-var">lspRequestHandlers</span></a></span></span><span> </span><span id="local-6989586621680885711"><span class="annot"><span class="annottext">LspFormattingConfig
</span><a href="#local-6989586621680885711"><span class="hs-identifier hs-var">lspFormattingConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-178"></span><span>  </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Request)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Request))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentHover
-&gt; ClientMessageHandler Lsp 'Request 'Method_TextDocumentHover
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentHover
</span><span class="hs-identifier hs-var">Msg.SMethod_TextDocumentHover</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TRequestMessage 'Method_TextDocumentHover
 -&gt; (Either ResponseError (MessageResult 'Method_TextDocumentHover)
     -&gt; Lsp ())
 -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request 'Method_TextDocumentHover
forall (m :: Method 'ClientToServer 'Request).
(Show (TRequestMessage m), Show (TResponseMessage m),
 Show (MessageResult m)) =&gt;
(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request m
</span><a href="#local-6989586621680885715"><span class="hs-identifier hs-var">mkHandler</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentHover
-&gt; (Either ResponseError (MessageResult 'Method_TextDocumentHover)
    -&gt; Lsp ())
-&gt; Lsp ()
</span><a href="Unison.LSP.Hover.html#hoverHandler"><span class="hs-identifier hs-var">hoverHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Request)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Request))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentCodeAction
-&gt; ClientMessageHandler Lsp 'Request 'Method_TextDocumentCodeAction
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentCodeAction
</span><span class="hs-identifier hs-var">Msg.SMethod_TextDocumentCodeAction</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TRequestMessage 'Method_TextDocumentCodeAction
 -&gt; (Either
       ResponseError (MessageResult 'Method_TextDocumentCodeAction)
     -&gt; Lsp ())
 -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request 'Method_TextDocumentCodeAction
forall (m :: Method 'ClientToServer 'Request).
(Show (TRequestMessage m), Show (TResponseMessage m),
 Show (MessageResult m)) =&gt;
(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request m
</span><a href="#local-6989586621680885715"><span class="hs-identifier hs-var">mkHandler</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentCodeAction
-&gt; (Either
      ResponseError (MessageResult 'Method_TextDocumentCodeAction)
    -&gt; Lsp ())
-&gt; Lsp ()
</span><a href="Unison.LSP.CodeAction.html#codeActionHandler"><span class="hs-identifier hs-var">codeActionHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Request)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Request))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentCodeLens
-&gt; ClientMessageHandler Lsp 'Request 'Method_TextDocumentCodeLens
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentCodeLens
</span><span class="hs-identifier hs-var">Msg.SMethod_TextDocumentCodeLens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TRequestMessage 'Method_TextDocumentCodeLens
 -&gt; (Either
       ResponseError (MessageResult 'Method_TextDocumentCodeLens)
     -&gt; Lsp ())
 -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request 'Method_TextDocumentCodeLens
forall (m :: Method 'ClientToServer 'Request).
(Show (TRequestMessage m), Show (TResponseMessage m),
 Show (MessageResult m)) =&gt;
(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request m
</span><a href="#local-6989586621680885715"><span class="hs-identifier hs-var">mkHandler</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentCodeLens
-&gt; (Either ResponseError ([CodeLens] |? Null) -&gt; Lsp ()) -&gt; Lsp ()
TRequestMessage 'Method_TextDocumentCodeLens
-&gt; (Either
      ResponseError (MessageResult 'Method_TextDocumentCodeLens)
    -&gt; Lsp ())
-&gt; Lsp ()
</span><a href="Unison.LSP.CodeLens.html#codeLensHandler"><span class="hs-identifier hs-var">codeLensHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Request)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Request))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_WorkspaceExecuteCommand
-&gt; ClientMessageHandler
     Lsp 'Request 'Method_WorkspaceExecuteCommand
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_WorkspaceExecuteCommand
</span><span class="hs-identifier hs-var">Msg.SMethod_WorkspaceExecuteCommand</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TRequestMessage 'Method_WorkspaceExecuteCommand
 -&gt; (Either
       ResponseError (MessageResult 'Method_WorkspaceExecuteCommand)
     -&gt; Lsp ())
 -&gt; Lsp ())
-&gt; ClientMessageHandler
     Lsp 'Request 'Method_WorkspaceExecuteCommand
forall (m :: Method 'ClientToServer 'Request).
(Show (TRequestMessage m), Show (TResponseMessage m),
 Show (MessageResult m)) =&gt;
(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request m
</span><a href="#local-6989586621680885715"><span class="hs-identifier hs-var">mkHandler</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_WorkspaceExecuteCommand
-&gt; (Either ResponseError (Value |? Null) -&gt; Lsp ()) -&gt; Lsp ()
TRequestMessage 'Method_WorkspaceExecuteCommand
-&gt; (Either
      ResponseError (MessageResult 'Method_WorkspaceExecuteCommand)
    -&gt; Lsp ())
-&gt; Lsp ()
</span><a href="Unison.LSP.Commands.html#executeCommandHandler"><span class="hs-identifier hs-var">executeCommandHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Request)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Request))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentFoldingRange
-&gt; ClientMessageHandler
     Lsp 'Request 'Method_TextDocumentFoldingRange
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentFoldingRange
</span><span class="hs-identifier hs-var">Msg.SMethod_TextDocumentFoldingRange</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TRequestMessage 'Method_TextDocumentFoldingRange
 -&gt; (Either
       ResponseError (MessageResult 'Method_TextDocumentFoldingRange)
     -&gt; Lsp ())
 -&gt; Lsp ())
-&gt; ClientMessageHandler
     Lsp 'Request 'Method_TextDocumentFoldingRange
forall (m :: Method 'ClientToServer 'Request).
(Show (TRequestMessage m), Show (TResponseMessage m),
 Show (MessageResult m)) =&gt;
(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request m
</span><a href="#local-6989586621680885715"><span class="hs-identifier hs-var">mkHandler</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentFoldingRange
-&gt; (Either
      ResponseError (MessageResult 'Method_TextDocumentFoldingRange)
    -&gt; Lsp ())
-&gt; Lsp ()
</span><a href="Unison.LSP.FoldingRange.html#foldingRangeRequest"><span class="hs-identifier hs-var">foldingRangeRequest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Request)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Request))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentCompletion
-&gt; ClientMessageHandler Lsp 'Request 'Method_TextDocumentCompletion
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentCompletion
</span><span class="hs-identifier hs-var">Msg.SMethod_TextDocumentCompletion</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TRequestMessage 'Method_TextDocumentCompletion
 -&gt; (Either
       ResponseError (MessageResult 'Method_TextDocumentCompletion)
     -&gt; Lsp ())
 -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request 'Method_TextDocumentCompletion
forall (m :: Method 'ClientToServer 'Request).
(Show (TRequestMessage m), Show (TResponseMessage m),
 Show (MessageResult m)) =&gt;
(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request m
</span><a href="#local-6989586621680885715"><span class="hs-identifier hs-var">mkHandler</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentCompletion
-&gt; (Either
      ResponseError (MessageResult 'Method_TextDocumentCompletion)
    -&gt; Lsp ())
-&gt; Lsp ()
</span><a href="Unison.LSP.Completion.html#completionHandler"><span class="hs-identifier hs-var">completionHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Request)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Request))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_CompletionItemResolve
-&gt; ClientMessageHandler Lsp 'Request 'Method_CompletionItemResolve
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_CompletionItemResolve
</span><span class="hs-identifier hs-var">Msg.SMethod_CompletionItemResolve</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TRequestMessage 'Method_CompletionItemResolve
 -&gt; (Either
       ResponseError (MessageResult 'Method_CompletionItemResolve)
     -&gt; Lsp ())
 -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request 'Method_CompletionItemResolve
forall (m :: Method 'ClientToServer 'Request).
(Show (TRequestMessage m), Show (TResponseMessage m),
 Show (MessageResult m)) =&gt;
(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request m
</span><a href="#local-6989586621680885715"><span class="hs-identifier hs-var">mkHandler</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_CompletionItemResolve
-&gt; (Either ResponseError CompletionItem -&gt; Lsp ()) -&gt; Lsp ()
TRequestMessage 'Method_CompletionItemResolve
-&gt; (Either
      ResponseError (MessageResult 'Method_CompletionItemResolve)
    -&gt; Lsp ())
-&gt; Lsp ()
</span><a href="Unison.LSP.Completion.html#completionItemResolveHandler"><span class="hs-identifier hs-var">completionItemResolveHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Request)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Request))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
</span><a href="#local-6989586621680885722"><span class="hs-identifier hs-var">addFormattingHandlers</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-188"></span><span>    </span><span id="local-6989586621680885722"><span class="annot"><span class="annottext">addFormattingHandlers :: SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
</span><a href="#local-6989586621680885722"><span class="hs-identifier hs-var hs-var">addFormattingHandlers</span></a></span></span><span> </span><span id="local-6989586621680885723"><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
</span><a href="#local-6989586621680885723"><span class="hs-identifier hs-var">handlers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-189"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LspFormattingConfig
</span><a href="#local-6989586621680885711"><span class="hs-identifier hs-var">lspFormattingConfig</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-190"></span><span>        </span><span class="annot"><span class="annottext">LspFormattingConfig
</span><a href="Unison.LSP.html#LspFormatEnabled"><span class="hs-identifier hs-var">LspFormatEnabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-191"></span><span>          </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
</span><a href="#local-6989586621680885723"><span class="hs-identifier hs-var">handlers</span></a></span><span>
</span><span id="line-192"></span><span>            </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Request)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Request))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentFormatting
-&gt; ClientMessageHandler Lsp 'Request 'Method_TextDocumentFormatting
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentFormatting
</span><span class="hs-identifier hs-var">Msg.SMethod_TextDocumentFormatting</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TRequestMessage 'Method_TextDocumentFormatting
 -&gt; (Either
       ResponseError (MessageResult 'Method_TextDocumentFormatting)
     -&gt; Lsp ())
 -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request 'Method_TextDocumentFormatting
forall (m :: Method 'ClientToServer 'Request).
(Show (TRequestMessage m), Show (TResponseMessage m),
 Show (MessageResult m)) =&gt;
(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request m
</span><a href="#local-6989586621680885715"><span class="hs-identifier hs-var">mkHandler</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentFormatting
-&gt; (Either
      ResponseError (MessageResult 'Method_TextDocumentFormatting)
    -&gt; Lsp ())
-&gt; Lsp ()
</span><a href="Unison.LSP.Formatting.html#formatDocRequest"><span class="hs-identifier hs-var">formatDocRequest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>            </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Request)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Request))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentRangeFormatting
-&gt; ClientMessageHandler
     Lsp 'Request 'Method_TextDocumentRangeFormatting
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Request)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentRangeFormatting
</span><span class="hs-identifier hs-var">Msg.SMethod_TextDocumentRangeFormatting</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TRequestMessage 'Method_TextDocumentRangeFormatting
 -&gt; (Either
       ResponseError (MessageResult 'Method_TextDocumentRangeFormatting)
     -&gt; Lsp ())
 -&gt; Lsp ())
-&gt; ClientMessageHandler
     Lsp 'Request 'Method_TextDocumentRangeFormatting
forall (m :: Method 'ClientToServer 'Request).
(Show (TRequestMessage m), Show (TResponseMessage m),
 Show (MessageResult m)) =&gt;
(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request m
</span><a href="#local-6989586621680885715"><span class="hs-identifier hs-var">mkHandler</span></a></span><span> </span><span class="annot"><span class="annottext">TRequestMessage 'Method_TextDocumentRangeFormatting
-&gt; (Either
      ResponseError (MessageResult 'Method_TextDocumentRangeFormatting)
    -&gt; Lsp ())
-&gt; Lsp ()
</span><a href="Unison.LSP.Formatting.html#formatRangeRequest"><span class="hs-identifier hs-var">formatRangeRequest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>        </span><span class="annot"><span class="annottext">LspFormattingConfig
</span><a href="Unison.LSP.html#LspFormatDisabled"><span class="hs-identifier hs-var">LspFormatDisabled</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Request)
</span><a href="#local-6989586621680885723"><span class="hs-identifier hs-var">handlers</span></a></span><span>
</span><span id="line-195"></span><span>    </span><span id="local-6989586621680885728"><span class="annot"><span class="annottext">defaultTimeout :: Int
</span><a href="#local-6989586621680885728"><span class="hs-identifier hs-var hs-var">defaultTimeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10_000</span></span><span> </span><span class="hs-comment">-- 10s</span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><a href="#local-6989586621680885715"><span class="hs-identifier hs-type">mkHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-197"></span><span>      </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680885272"><span class="annot"><a href="#local-6989586621680885272"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-198"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Msg.TRequestMessage</span></span><span> </span><span class="annot"><a href="#local-6989586621680885272"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Msg.TResponseMessage</span></span><span> </span><span class="annot"><a href="#local-6989586621680885272"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Msg.MessageResult</span></span><span> </span><span class="annot"><a href="#local-6989586621680885272"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Msg.TRequestMessage</span></span><span> </span><span class="annot"><a href="#local-6989586621680885272"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-200"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Msg.ResponseError</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Msg.MessageResult</span></span><span> </span><span class="annot"><a href="#local-6989586621680885272"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-201"></span><span>          </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>        </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-203"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">ClientMessageHandler</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Msg.Request</span></span><span> </span><span class="annot"><a href="#local-6989586621680885272"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-204"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621680885715"><span class="annot"><span class="annottext">mkHandler :: forall (m :: Method 'ClientToServer 'Request).
(Show (TRequestMessage m), Show (TResponseMessage m),
 Show (MessageResult m)) =&gt;
(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request m
</span><a href="#local-6989586621680885715"><span class="hs-identifier hs-var hs-var">mkHandler</span></a></span></span><span> </span><span id="local-6989586621680885734"><span class="annot"><span class="annottext">TRequestMessage m
-&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ()
</span><a href="#local-6989586621680885734"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-206"></span><span>      </span><span class="annot"><span class="annottext">TRequestMessage m
-&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ()
</span><a href="#local-6989586621680885734"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-207"></span><span>        </span><span class="annot"><span class="annottext">(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ((TRequestMessage m
     -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
    -&gt; TRequestMessage m
    -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ())
    -&gt; Lsp ())
-&gt; TRequestMessage m
-&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ())
-&gt; Lsp ()
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
-&gt; (TRequestMessage m
    -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; TRequestMessage m
-&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ())
-&gt; Lsp ()
forall {f :: MessageDirection} (message :: Method f 'Request).
Maybe Int
-&gt; (TRequestMessage message
    -&gt; (Either ResponseError (MessageResult message) -&gt; Lsp ())
    -&gt; Lsp ())
-&gt; TRequestMessage message
-&gt; (Either ResponseError (MessageResult message) -&gt; Lsp ())
-&gt; Lsp ()
</span><a href="Unison.LSP.HandlerUtils.html#withCancellation"><span class="hs-identifier hs-var">Handlers.withCancellation</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Maybe Int
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680885728"><span class="hs-identifier hs-var">defaultTimeout</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>        </span><span class="annot"><span class="annottext">(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ((TRequestMessage m
     -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
    -&gt; TRequestMessage m
    -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ())
    -&gt; Lsp ())
-&gt; TRequestMessage m
-&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ())
-&gt; Lsp ()
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; TRequestMessage m
-&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ())
-&gt; Lsp ()
forall {f :: MessageDirection} (message :: Method f 'Request).
(Show (TRequestMessage message), Show (MessageResult message)) =&gt;
(TRequestMessage message
 -&gt; (Either ResponseError (MessageResult message) -&gt; Lsp ())
 -&gt; Lsp ())
-&gt; TRequestMessage message
-&gt; (Either ResponseError (MessageResult message) -&gt; Lsp ())
-&gt; Lsp ()
</span><a href="Unison.LSP.HandlerUtils.html#withDebugging"><span class="hs-identifier hs-var">Handlers.withDebugging</span></a></span><span>
</span><span id="line-209"></span><span>        </span><span class="annot"><span class="annottext">(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ((TRequestMessage m
     -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
    -&gt; ClientMessageHandler Lsp 'Request m)
-&gt; ClientMessageHandler Lsp 'Request m
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Handler Lsp m -&gt; ClientMessageHandler Lsp 'Request m
(TRequestMessage m
 -&gt; (Either ResponseError (MessageResult m) -&gt; Lsp ()) -&gt; Lsp ())
-&gt; ClientMessageHandler Lsp 'Request m
forall (f :: * -&gt; *) (t :: MessageKind)
       (m :: Method 'ClientToServer t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="annot"><span class="hs-comment">-- | LSP notification handlers</span></span><span>
</span><span id="line-212"></span><span class="annot"><a href="Unison.LSP.html#lspNotificationHandlers"><span class="hs-identifier hs-type">lspNotificationHandlers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SMethodMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ClientMessageHandler</span></span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><span class="hs-identifier hs-type">Msg.Notification</span></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span id="lspNotificationHandlers"><span class="annot"><span class="annottext">lspNotificationHandlers :: SMethodMap (ClientMessageHandler Lsp 'Notification)
</span><a href="Unison.LSP.html#lspNotificationHandlers"><span class="hs-identifier hs-var hs-var">lspNotificationHandlers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Notification)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Notification))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentDidOpen
-&gt; ClientMessageHandler
     Lsp 'Notification 'Method_TextDocumentDidOpen
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentDidOpen
</span><span class="hs-identifier hs-var">Msg.SMethod_TextDocumentDidOpen</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handler Lsp 'Method_TextDocumentDidOpen
-&gt; ClientMessageHandler
     Lsp 'Notification 'Method_TextDocumentDidOpen
forall (f :: * -&gt; *) (t :: MessageKind)
       (m :: Method 'ClientToServer t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span> </span><span class="annot"><span class="annottext">Handler Lsp 'Method_TextDocumentDidOpen
TNotificationMessage 'Method_TextDocumentDidOpen -&gt; Lsp ()
</span><a href="Unison.LSP.VFS.html#lspOpenFile"><span class="hs-identifier hs-var">VFS.lspOpenFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Notification)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Notification))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentDidClose
-&gt; ClientMessageHandler
     Lsp 'Notification 'Method_TextDocumentDidClose
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentDidClose
</span><span class="hs-identifier hs-var">Msg.SMethod_TextDocumentDidClose</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handler Lsp 'Method_TextDocumentDidClose
-&gt; ClientMessageHandler
     Lsp 'Notification 'Method_TextDocumentDidClose
forall (f :: * -&gt; *) (t :: MessageKind)
       (m :: Method 'ClientToServer t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span> </span><span class="annot"><span class="annottext">Handler Lsp 'Method_TextDocumentDidClose
TNotificationMessage 'Method_TextDocumentDidClose -&gt; Lsp ()
</span><a href="Unison.LSP.VFS.html#lspCloseFile"><span class="hs-identifier hs-var">VFS.lspCloseFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Notification)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Notification))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentDidChange
-&gt; ClientMessageHandler
     Lsp 'Notification 'Method_TextDocumentDidChange
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_TextDocumentDidChange
</span><span class="hs-identifier hs-var">Msg.SMethod_TextDocumentDidChange</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handler Lsp 'Method_TextDocumentDidChange
-&gt; ClientMessageHandler
     Lsp 'Notification 'Method_TextDocumentDidChange
forall (f :: * -&gt; *) (t :: MessageKind)
       (m :: Method 'ClientToServer t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span> </span><span class="annot"><span class="annottext">Handler Lsp 'Method_TextDocumentDidChange
TNotificationMessage 'Method_TextDocumentDidChange -&gt; Lsp ()
</span><a href="Unison.LSP.VFS.html#lspChangeFile"><span class="hs-identifier hs-var">VFS.lspChangeFile</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Notification)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Notification))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_Initialized
-&gt; ClientMessageHandler Lsp 'Notification 'Method_Initialized
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_Initialized
</span><span class="hs-identifier hs-var">Msg.SMethod_Initialized</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handler Lsp 'Method_Initialized
-&gt; ClientMessageHandler Lsp 'Notification 'Method_Initialized
forall (f :: * -&gt; *) (t :: MessageKind)
       (m :: Method 'ClientToServer t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span> </span><span class="annot"><span class="annottext">Handler Lsp 'Method_Initialized
TNotificationMessage 'Method_Initialized -&gt; Lsp ()
</span><a href="Unison.LSP.NotificationHandlers.html#initializedHandler"><span class="hs-identifier hs-var">Notifications.initializedHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Notification)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Notification))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_CancelRequest
-&gt; ClientMessageHandler Lsp 'Notification 'Method_CancelRequest
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_CancelRequest
forall {f :: MessageDirection}. SMethod 'Method_CancelRequest
</span><span class="hs-identifier hs-var">Msg.SMethod_CancelRequest</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handler Lsp 'Method_CancelRequest
-&gt; ClientMessageHandler Lsp 'Notification 'Method_CancelRequest
forall (f :: * -&gt; *) (t :: MessageKind)
       (m :: Method 'ClientToServer t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span> </span><span class="annot"><span class="annottext">(Handler Lsp 'Method_CancelRequest
 -&gt; ClientMessageHandler Lsp 'Notification 'Method_CancelRequest)
-&gt; Handler Lsp 'Method_CancelRequest
-&gt; ClientMessageHandler Lsp 'Notification 'Method_CancelRequest
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TNotificationMessage 'Method_CancelRequest -&gt; Lsp ())
-&gt; TNotificationMessage 'Method_CancelRequest -&gt; Lsp ()
forall m. Show m =&gt; (m -&gt; Lsp ()) -&gt; m -&gt; Lsp ()
</span><a href="Unison.LSP.NotificationHandlers.html#withDebugging"><span class="hs-identifier hs-var">Notifications.withDebugging</span></a></span><span> </span><span class="annot"><span class="annottext">TNotificationMessage 'Method_CancelRequest -&gt; Lsp ()
forall {f :: MessageDirection}.
TNotificationMessage 'Method_CancelRequest -&gt; Lsp ()
</span><a href="Unison.LSP.CancelRequest.html#cancelRequestHandler"><span class="hs-identifier hs-var">cancelRequestHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Notification)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Notification))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_WorkspaceDidChangeConfiguration
-&gt; ClientMessageHandler
     Lsp 'Notification 'Method_WorkspaceDidChangeConfiguration
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_WorkspaceDidChangeConfiguration
</span><span class="hs-identifier hs-var">Msg.SMethod_WorkspaceDidChangeConfiguration</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handler Lsp 'Method_WorkspaceDidChangeConfiguration
-&gt; ClientMessageHandler
     Lsp 'Notification 'Method_WorkspaceDidChangeConfiguration
forall (f :: * -&gt; *) (t :: MessageKind)
       (m :: Method 'ClientToServer t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span> </span><span class="annot"><span class="annottext">Handler Lsp 'Method_WorkspaceDidChangeConfiguration
TNotificationMessage 'Method_WorkspaceDidChangeConfiguration
-&gt; Lsp ()
</span><a href="Unison.LSP.Configuration.html#workspaceConfigurationChanged"><span class="hs-identifier hs-var">Config.workspaceConfigurationChanged</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>    </span><span class="annot"><span class="annottext">SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; (SMethodMap (ClientMessageHandler Lsp 'Notification)
    -&gt; SMethodMap (ClientMessageHandler Lsp 'Notification))
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_SetTrace
-&gt; ClientMessageHandler Lsp 'Notification 'Method_SetTrace
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
-&gt; SMethodMap (ClientMessageHandler Lsp 'Notification)
forall {f :: MessageDirection} {t :: MessageKind} (a :: Method f t)
       (v :: Method f t -&gt; *).
SMethod a -&gt; v a -&gt; SMethodMap v -&gt; SMethodMap v
</span><span class="hs-identifier hs-var">SMM.insert</span></span><span> </span><span class="annot"><span class="annottext">SMethod 'Method_SetTrace
</span><span class="hs-identifier hs-var">Msg.SMethod_SetTrace</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handler Lsp 'Method_SetTrace
-&gt; ClientMessageHandler Lsp 'Notification 'Method_SetTrace
forall (f :: * -&gt; *) (t :: MessageKind)
       (m :: Method 'ClientToServer t).
Handler f m -&gt; ClientMessageHandler f t m
</span><span class="hs-identifier hs-var">ClientMessageHandler</span></span><span> </span><span class="annot"><span class="annottext">Handler Lsp 'Method_SetTrace
TNotificationMessage 'Method_SetTrace -&gt; Lsp ()
</span><a href="Unison.LSP.NotificationHandlers.html#setTraceHandler"><span class="hs-identifier hs-var">Notifications.setTraceHandler</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="annot"><span class="hs-comment">-- | A natural transformation into IO, required by the LSP lib.</span></span><span>
</span><span id="line-224"></span><span class="annot"><a href="Unison.LSP.html#lspInterpretHandler"><span class="hs-identifier hs-type">lspInterpretHandler</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;~&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span>
</span><span id="line-225"></span><span id="lspInterpretHandler"><span class="annot"><span class="annottext">lspInterpretHandler :: Env -&gt; Lsp &lt;~&gt; IO
</span><a href="Unison.LSP.html#lspInterpretHandler"><span class="hs-identifier hs-var hs-var">lspInterpretHandler</span></a></span></span><span> </span><span id="local-6989586621680885752"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621680885752"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680885753"><span class="annot"><span class="annottext">LanguageContextEnv Config
$sel:lspContext:Env :: Env -&gt; LanguageContextEnv Config
lspContext :: LanguageContextEnv Config
</span><a href="Unison.LSP.Types.html#%24sel%3AlspContext%3AEnv"><span class="hs-identifier hs-var hs-var">lspContext</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-226"></span><span>  </span><span class="annot"><span class="annottext">(forall a. Lsp a -&gt; IO a)
-&gt; (forall a. IO a -&gt; Lsp a) -&gt; Lsp &lt;~&gt; IO
forall {k} (m :: k -&gt; *) (n :: k -&gt; *).
(forall (a :: k). m a -&gt; n a)
-&gt; (forall (a :: k). n a -&gt; m a) -&gt; m &lt;~&gt; n
</span><span class="hs-identifier hs-var">Iso</span></span><span> </span><span class="annot"><span class="annottext">Lsp a -&gt; IO a
forall a. Lsp a -&gt; IO a
</span><a href="#local-6989586621680885755"><span class="hs-identifier hs-var">toIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO a -&gt; Lsp a
forall a. IO a -&gt; Lsp a
forall {m :: * -&gt; *} {a}. MonadIO m =&gt; IO a -&gt; m a
</span><a href="#local-6989586621680885756"><span class="hs-identifier hs-var">fromIO</span></a></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><a href="#local-6989586621680885755"><span class="hs-identifier hs-type">toIO</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680885759"><span class="annot"><a href="#local-6989586621680885759"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680885759"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621680885759"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span id="local-6989586621680885755"><span class="annot"><span class="annottext">toIO :: forall a. Lsp a -&gt; IO a
</span><a href="#local-6989586621680885755"><span class="hs-identifier hs-var hs-var">toIO</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.LSP.Types.html#Lsp"><span class="hs-identifier hs-type">Lsp</span></a></span><span> </span><span id="local-6989586621680885761"><span class="annot"><span class="annottext">ReaderT Env (LspM Config) a
</span><a href="#local-6989586621680885761"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ReaderT (LanguageContextEnv Config) IO a
 -&gt; LanguageContextEnv Config -&gt; IO a)
-&gt; LanguageContextEnv Config
-&gt; ReaderT (LanguageContextEnv Config) IO a
-&gt; IO a
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (LanguageContextEnv Config) IO a
-&gt; LanguageContextEnv Config -&gt; IO a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">LanguageContextEnv Config
</span><a href="#local-6989586621680885753"><span class="hs-identifier hs-var">lspContext</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT (LanguageContextEnv Config) IO a -&gt; IO a)
-&gt; (ReaderT Env (LspM Config) a
    -&gt; ReaderT (LanguageContextEnv Config) IO a)
-&gt; ReaderT Env (LspM Config) a
-&gt; IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LspT Config IO a -&gt; ReaderT (LanguageContextEnv Config) IO a
forall config (m :: * -&gt; *) a.
LspT config m a -&gt; ReaderT (LanguageContextEnv config) m a
</span><span class="hs-identifier hs-var">unLspT</span></span><span> </span><span class="annot"><span class="annottext">(LspT Config IO a -&gt; ReaderT (LanguageContextEnv Config) IO a)
-&gt; (ReaderT Env (LspM Config) a -&gt; LspT Config IO a)
-&gt; ReaderT Env (LspM Config) a
-&gt; ReaderT (LanguageContextEnv Config) IO a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT Env (LspM Config) a -&gt; Env -&gt; LspT Config IO a)
-&gt; Env -&gt; ReaderT Env (LspM Config) a -&gt; LspT Config IO a
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT Env (LspM Config) a -&gt; Env -&gt; LspT Config IO a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621680885752"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT Env (LspM Config) a -&gt; IO a)
-&gt; ReaderT Env (LspM Config) a -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReaderT Env (LspM Config) a
</span><a href="#local-6989586621680885761"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span id="local-6989586621680885756"><span class="annot"><span class="annottext">fromIO :: IO a -&gt; m a
</span><a href="#local-6989586621680885756"><span class="hs-identifier hs-var hs-var">fromIO</span></a></span></span><span> </span><span id="local-6989586621680885773"><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621680885773"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; m a
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621680885773"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="annot"><a href="Unison.LSP.html#lspOptions"><span class="hs-identifier hs-type">lspOptions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Options</span></span><span>
</span><span id="line-233"></span><span id="lspOptions"><span class="annot"><span class="annottext">lspOptions :: Options
</span><a href="Unison.LSP.html#lspOptions"><span class="hs-identifier hs-var hs-var">lspOptions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><span class="annottext">Options
</span><span class="hs-identifier hs-var">defaultOptions</span></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">optTextDocumentSync</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><a href="#local-6989586621680885777"><span class="hs-identifier hs-type">textDocSyncOptions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-236"></span><span>      </span><span class="annot"><span class="hs-identifier hs-var">optExecuteCommandCommands</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="Unison.LSP.Commands.html#supportedCommands"><span class="hs-identifier hs-type">supportedCommands</span></a></span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-239"></span><span>    </span><span id="local-6989586621680885777"><span class="annot"><span class="annottext">textDocSyncOptions :: TextDocumentSyncOptions
</span><a href="#local-6989586621680885777"><span class="hs-identifier hs-var hs-var">textDocSyncOptions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-240"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">TextDocumentSyncOptions</span></span><span>
</span><span id="line-241"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- Clients should send file open/close messages so the VFS can handle them</span><span>
</span><span id="line-242"></span><span>          </span><span class="annot"><span class="annottext">$sel:_openClose:TextDocumentSyncOptions :: Maybe Bool
</span><span class="hs-identifier hs-var">_openClose</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span>
</span><span id="line-243"></span><span>          </span><span class="hs-comment">-- Clients should send file change messages so the VFS can handle them</span><span>
</span><span id="line-244"></span><span>          </span><span class="annot"><span class="annottext">$sel:_change:TextDocumentSyncOptions :: Maybe TextDocumentSyncKind
</span><span class="hs-identifier hs-var">_change</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TextDocumentSyncKind -&gt; Maybe TextDocumentSyncKind
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TextDocumentSyncKind
</span><span class="hs-identifier hs-var">TextDocumentSyncKind_Incremental</span></span><span class="hs-special">,</span><span>
</span><span id="line-245"></span><span>          </span><span class="hs-comment">-- Clients should tell us when files are saved</span><span>
</span><span id="line-246"></span><span>          </span><span class="annot"><span class="annottext">$sel:_willSave:TextDocumentSyncOptions :: Maybe Bool
</span><span class="hs-identifier hs-var">_willSave</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span>
</span><span id="line-247"></span><span>          </span><span class="hs-comment">-- If we implement a pre-save hook we can enable this.</span><span>
</span><span id="line-248"></span><span>          </span><span class="annot"><span class="annottext">$sel:_willSaveWaitUntil:TextDocumentSyncOptions :: Maybe Bool
</span><span class="hs-identifier hs-var">_willSaveWaitUntil</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span>
</span><span id="line-249"></span><span>          </span><span class="hs-comment">-- If we implement a save hook we can enable this.</span><span>
</span><span id="line-250"></span><span>          </span><span class="annot"><span class="annottext">$sel:_save:TextDocumentSyncOptions :: Maybe (Bool |? SaveOptions)
</span><span class="hs-identifier hs-var">_save</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Bool |? SaveOptions) -&gt; Maybe (Bool |? SaveOptions)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool |? SaveOptions
forall a b. a -&gt; a |? b
</span><span class="hs-identifier hs-var">InL</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-252"></span></pre></body></html>