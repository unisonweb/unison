<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="annot"><span class="hs-comment">-- | @update@ input handler.</span></span><span>
</span><span id="line-2"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.Codebase.Editor.HandleInput.Update2</span><span>
</span><span id="line-3"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update2.html#handleUpdate2"><span class="hs-identifier">handleUpdate2</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Misc helpers to be organized later</span></span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update2.html#typecheckedUnisonFileToBranchUpdates"><span class="hs-identifier">typecheckedUnisonFileToBranchUpdates</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mapped</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(.=)</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ask</span></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifoldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">bifoldMap</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Foldable</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">List</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Reference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Reference'</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TermReferenceId</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Operations</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Operations</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Cli.Monad.html"><span class="hs-identifier">Unison.Cli.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Cli.Monad.html#Cli"><span class="hs-identifier">Cli</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Cli.Monad.html#Env"><span class="hs-identifier">Env</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Cli.Monad.html"><span class="hs-identifier">Unison.Cli.Monad</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cli</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Cli.MonadUtils.html"><span class="hs-identifier">Unison.Cli.MonadUtils</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Cli</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Cli.Pretty.html"><span class="hs-identifier">Unison.Cli.Pretty</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Pretty</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Cli.UpdateUtils.html"><span class="hs-identifier">Unison.Cli.UpdateUtils</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Cli.UpdateUtils.html#getNamespaceDependentsOf2"><span class="hs-identifier">getNamespaceDependentsOf2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Cli.UpdateUtils.html#hydrateDefns"><span class="hs-identifier">hydrateDefns</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Cli.UpdateUtils.html#narrowDefns"><span class="hs-identifier">narrowDefns</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Unison.Cli.UpdateUtils.html#parseAndTypecheck"><span class="hs-identifier">parseAndTypecheck</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Codebase</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Branch</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Branch0</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Branch</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Branch</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Branch.Names</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Branch</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.BranchUtil</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BranchUtil</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.Output.html"><span class="hs-identifier">Unison.Codebase.Editor.Output</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Codebase.Editor.Output.html#Output"><span class="hs-identifier">Output</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.Output.html"><span class="hs-identifier">Unison.Codebase.Editor.Output</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Output</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Path</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Path</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.Path</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Path</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Codebase.SqliteCodebase.Operations</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Operations</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Decl</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DataDeclaration</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Decl</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.DeclNameLookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">DeclNameLookup</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Merge</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Merge</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Name</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Name</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Names</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Names</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Names</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Names</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Parser.Ann</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Ann</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnv.Names</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PPE</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnvDecl</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PrettyPrintEnvDecl</span></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnvDecl</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PPED</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.PrettyPrintEnvDecl.Names</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PPED</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TypeReference</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">TypeReferenceId</span></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Reference</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Reference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromId</span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Referent</span></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Referent</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Referent</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Sqlite</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Transaction</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Symbol</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Symbol</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Syntax.FilePrinter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">renderDefnsForUnisonFile</span></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Syntax.Name</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Name</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.UnisonFile</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UF</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.UnisonFile.Names</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UF</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.UnisonFile.Type</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TypecheckedUnisonFile</span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.BiMultimap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">BiMultimap</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.BiMultimap</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BiMultimap</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Defns</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">DefnsF</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">defnsAreEmpty</span></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Monoid</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Monoid</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Nametree</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">flattenNametrees</span></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ColorText</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Pretty</span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Pretty</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Pretty</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Relation</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Relation</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Var</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Var</span></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.WatchKind</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">WK</span></span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update2.html#handleUpdate2"><span class="hs-identifier hs-type">handleUpdate2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Unison.Cli.Monad.html#Cli"><span class="hs-identifier hs-type">Cli</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span id="handleUpdate2"><span class="annot"><span class="annottext">handleUpdate2 :: Cli ()
</span><a href="Unison.Codebase.Editor.HandleInput.Update2.html#handleUpdate2"><span class="hs-identifier hs-var hs-var">handleUpdate2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-72"></span><span>  </span><span id="local-6989586621680912804"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621680912804"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli Env
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-73"></span><span>  </span><span id="local-6989586621680912805"><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912805"><span class="hs-identifier hs-var">tuf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli (TypecheckedUnisonFile Symbol Ann)
</span><a href="Unison.Cli.MonadUtils.html#expectLatestTypecheckedFile"><span class="hs-identifier hs-var">Cli.expectLatestTypecheckedFile</span></a></span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680912807"><span class="annot"><span class="annottext">termAndDeclNames :: DefnsF Set Name Name
</span><a href="#local-6989586621680912807"><span class="hs-identifier hs-var hs-var">termAndDeclNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann -&gt; DefnsF Set Name Name
forall v a.
Var v =&gt;
TypecheckedUnisonFile v a -&gt; DefnsF Set Name Name
</span><a href="Unison.Codebase.Editor.HandleInput.Update2.html#getTermAndDeclNames"><span class="hs-identifier hs-var">getTermAndDeclNames</span></a></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912805"><span class="hs-identifier hs-var">tuf</span></a></span><span>
</span><span id="line-75"></span><span>  </span><span id="local-6989586621680912809"><span class="annot"><span class="annottext">ProjectPath
</span><a href="#local-6989586621680912809"><span class="hs-identifier hs-var">pp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli ProjectPath
</span><a href="Unison.Cli.MonadUtils.html#getCurrentProjectPath"><span class="hs-identifier hs-var">Cli.getCurrentProjectPath</span></a></span><span>
</span><span id="line-76"></span><span>  </span><span id="local-6989586621680912811"><span class="annot"><span class="annottext">Branch0 IO
</span><a href="#local-6989586621680912811"><span class="hs-identifier hs-var">currentBranch0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli (Branch0 IO)
</span><a href="Unison.Cli.MonadUtils.html#getCurrentBranch0"><span class="hs-identifier hs-var">Cli.getCurrentBranch0</span></a></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680912813"><span class="annot"><span class="annottext">currentBranch0ExcludingLibdeps :: Branch0 IO
</span><a href="#local-6989586621680912813"><span class="hs-identifier hs-var hs-var">currentBranch0ExcludingLibdeps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Branch0 IO -&gt; Branch0 IO
forall (m :: * -&gt; *). Branch0 m -&gt; Branch0 m
</span><span class="hs-identifier hs-var">Branch.deleteLibdeps</span></span><span> </span><span class="annot"><span class="annottext">Branch0 IO
</span><a href="#local-6989586621680912811"><span class="hs-identifier hs-var">currentBranch0</span></a></span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680912815"><span class="annot"><span class="annottext">namesIncludingLibdeps :: Names
</span><a href="#local-6989586621680912815"><span class="hs-identifier hs-var hs-var">namesIncludingLibdeps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Branch0 IO -&gt; Names
forall (m :: * -&gt; *). Branch0 m -&gt; Names
</span><span class="hs-identifier hs-var">Branch.toNames</span></span><span> </span><span class="annot"><span class="annottext">Branch0 IO
</span><a href="#local-6989586621680912811"><span class="hs-identifier hs-var">currentBranch0</span></a></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-comment">-- Assert that the namespace doesn't have any conflicted names</span><span>
</span><span id="line-81"></span><span>  </span><span id="local-6989586621680912817"><span class="annot"><span class="annottext">Nametree (DefnsF (Map NameSegment) Referent TypeReference)
</span><a href="#local-6989586621680912817"><span class="hs-identifier hs-var">nametree</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><span class="annottext">DefnsF (Relation Name) Referent TypeReference
-&gt; Either
     (Defn (Conflicted Name Referent) (Conflicted Name TypeReference))
     (Nametree (DefnsF (Map NameSegment) Referent TypeReference))
forall term typ.
(Ord term, Ord typ) =&gt;
DefnsF (Relation Name) term typ
-&gt; Either
     (Defn (Conflicted Name term) (Conflicted Name typ))
     (Nametree (DefnsF (Map NameSegment) term typ))
</span><a href="Unison.Cli.UpdateUtils.html#narrowDefns"><span class="hs-identifier hs-var">narrowDefns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Branch0 IO -&gt; DefnsF (Relation Name) Referent TypeReference
forall (m :: * -&gt; *).
Branch0 m -&gt; DefnsF (Relation Name) Referent TypeReference
</span><span class="hs-identifier hs-var">Branch.deepDefns</span></span><span> </span><span class="annot"><span class="annottext">Branch0 IO
</span><a href="#local-6989586621680912813"><span class="hs-identifier hs-var">currentBranch0ExcludingLibdeps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>      </span><span class="annot"><span class="annottext">Either
  (Defn (Conflicted Name Referent) (Conflicted Name TypeReference))
  (Nametree (DefnsF (Map NameSegment) Referent TypeReference))
-&gt; (Either
      (Defn (Conflicted Name Referent) (Conflicted Name TypeReference))
      (Nametree (DefnsF (Map NameSegment) Referent TypeReference))
    -&gt; Cli
         (Nametree (DefnsF (Map NameSegment) Referent TypeReference)))
-&gt; Cli (Nametree (DefnsF (Map NameSegment) Referent TypeReference))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Defn (Conflicted Name Referent) (Conflicted Name TypeReference)
 -&gt; Cli
      (Nametree (DefnsF (Map NameSegment) Referent TypeReference)))
-&gt; Either
     (Defn (Conflicted Name Referent) (Conflicted Name TypeReference))
     (Nametree (DefnsF (Map NameSegment) Referent TypeReference))
-&gt; Cli (Nametree (DefnsF (Map NameSegment) Referent TypeReference))
forall (m :: * -&gt; *) a b.
Applicative m =&gt;
(a -&gt; m b) -&gt; Either a b -&gt; m b
</span><span class="hs-identifier hs-var">onLeft</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Output
-&gt; Cli (Nametree (DefnsF (Map NameSegment) Referent TypeReference))
forall a. Output -&gt; Cli a
</span><a href="Unison.Cli.Monad.html#returnEarly"><span class="hs-identifier hs-var">Cli.returnEarly</span></a></span><span> </span><span class="annot"><span class="annottext">(Output
 -&gt; Cli
      (Nametree (DefnsF (Map NameSegment) Referent TypeReference)))
-&gt; (Defn (Conflicted Name Referent) (Conflicted Name TypeReference)
    -&gt; Output)
-&gt; Defn (Conflicted Name Referent) (Conflicted Name TypeReference)
-&gt; Cli (Nametree (DefnsF (Map NameSegment) Referent TypeReference))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text
-&gt; Defn (Conflicted Name Referent) (Conflicted Name TypeReference)
-&gt; Output
</span><a href="Unison.Codebase.Editor.Output.html#ConflictedDefn"><span class="hs-identifier hs-var">Output.ConflictedDefn</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;update&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680912824"><span class="hs-identifier hs-type">defns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Referent</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">BiMultimap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>      </span><span id="local-6989586621680912824"><span class="annot"><span class="annottext">defns :: Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
</span><a href="#local-6989586621680912824"><span class="hs-identifier hs-var hs-var">defns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-87"></span><span>        </span><span class="annot"><span class="annottext">Nametree (DefnsF (Map NameSegment) Referent TypeReference)
-&gt; Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
forall term typ.
(Ord term, Ord typ) =&gt;
Nametree (DefnsF (Map NameSegment) term typ)
-&gt; Defns (BiMultimap term Name) (BiMultimap typ Name)
</span><span class="hs-identifier hs-var">flattenNametrees</span></span><span> </span><span class="annot"><span class="annottext">Nametree (DefnsF (Map NameSegment) Referent TypeReference)
</span><a href="#local-6989586621680912817"><span class="hs-identifier hs-var">nametree</span></a></span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-comment">-- Get the number of constructors for every type declaration</span><span>
</span><span id="line-90"></span><span>  </span><span id="local-6989586621680912825"><span class="annot"><span class="annottext">Map (Id' Hash) Int
</span><a href="#local-6989586621680912825"><span class="hs-identifier hs-var">numConstructors</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-91"></span><span>    </span><span class="annot"><span class="annottext">Transaction (Map (Id' Hash) Int) -&gt; Cli (Map (Id' Hash) Int)
forall a. Transaction a -&gt; Cli a
</span><a href="Unison.Cli.Monad.html#runTransaction"><span class="hs-identifier hs-var">Cli.runTransaction</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-92"></span><span>      </span><span class="annot"><span class="annottext">Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
</span><a href="#local-6989586621680912824"><span class="hs-identifier hs-var">defns</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">types</span><span>
</span><span id="line-93"></span><span>        </span><span class="annot"><span class="annottext">BiMultimap TypeReference Name
-&gt; (BiMultimap TypeReference Name -&gt; Set TypeReference)
-&gt; Set TypeReference
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">BiMultimap TypeReference Name -&gt; Set TypeReference
forall a b. BiMultimap a b -&gt; Set a
</span><span class="hs-identifier hs-var">BiMultimap.dom</span></span><span>
</span><span id="line-94"></span><span>        </span><span class="annot"><span class="annottext">Set TypeReference
-&gt; (Set TypeReference -&gt; [TypeReference]) -&gt; [TypeReference]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Set TypeReference -&gt; [TypeReference]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">Set.toList</span></span><span>
</span><span id="line-95"></span><span>        </span><span class="annot"><span class="annottext">[TypeReference]
-&gt; ([TypeReference] -&gt; Transaction (Map (Id' Hash) Int))
-&gt; Transaction (Map (Id' Hash) Int)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Map (Id' Hash) Int
 -&gt; TypeReference -&gt; Transaction (Map (Id' Hash) Int))
-&gt; Map (Id' Hash) Int
-&gt; [TypeReference]
-&gt; Transaction (Map (Id' Hash) Int)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">Foldable.foldlM</span></span><span>
</span><span id="line-96"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680912830"><span class="annot"><span class="annottext">Map (Id' Hash) Int
</span><a href="#local-6989586621680912830"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-97"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">ReferenceBuiltin</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map (Id' Hash) Int -&gt; Transaction (Map (Id' Hash) Int)
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Map (Id' Hash) Int
</span><a href="#local-6989586621680912830"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-98"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">ReferenceDerived</span></span><span> </span><span id="local-6989586621680912833"><span class="annot"><span class="annottext">Id' Hash
</span><a href="#local-6989586621680912833"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-99"></span><span>                </span><span id="local-6989586621680912834"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680912834"><span class="hs-identifier hs-var">num</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Id' Hash -&gt; Transaction Int
</span><span class="hs-identifier hs-var">Operations.expectDeclNumConstructors</span></span><span> </span><span class="annot"><span class="annottext">Id' Hash
</span><a href="#local-6989586621680912833"><span class="hs-identifier hs-var">ref</span></a></span><span>
</span><span id="line-100"></span><span>                </span><span class="annot"><span class="annottext">Map (Id' Hash) Int -&gt; Transaction (Map (Id' Hash) Int)
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Map (Id' Hash) Int -&gt; Transaction (Map (Id' Hash) Int))
-&gt; Map (Id' Hash) Int -&gt; Transaction (Map (Id' Hash) Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Id' Hash -&gt; Int -&gt; Map (Id' Hash) Int -&gt; Map (Id' Hash) Int
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.insert</span></span><span> </span><span class="annot"><span class="annottext">Id' Hash
</span><a href="#local-6989586621680912833"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680912834"><span class="hs-identifier hs-var">num</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Id' Hash) Int
</span><a href="#local-6989586621680912830"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-101"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span>          </span><span class="annot"><span class="annottext">Map (Id' Hash) Int
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-comment">-- Assert that the namespace doesn't have any incoherent decls</span><span>
</span><span id="line-105"></span><span>  </span><span id="local-6989586621680912839"><span class="annot"><span class="annottext">DeclNameLookup
</span><a href="#local-6989586621680912839"><span class="hs-identifier hs-var">declNameLookup</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><span class="annottext">HasCallStack =&gt;
Nametree (DefnsF (Map NameSegment) Referent TypeReference)
-&gt; Map (Id' Hash) Int -&gt; Either IncoherentDeclReason DeclNameLookup
Nametree (DefnsF (Map NameSegment) Referent TypeReference)
-&gt; Map (Id' Hash) Int -&gt; Either IncoherentDeclReason DeclNameLookup
</span><span class="hs-identifier hs-var">Merge.checkDeclCoherency</span></span><span> </span><span class="annot"><span class="annottext">Nametree (DefnsF (Map NameSegment) Referent TypeReference)
</span><a href="#local-6989586621680912817"><span class="hs-identifier hs-var">nametree</span></a></span><span> </span><span class="annot"><span class="annottext">Map (Id' Hash) Int
</span><a href="#local-6989586621680912825"><span class="hs-identifier hs-var">numConstructors</span></a></span><span>
</span><span id="line-107"></span><span>      </span><span class="annot"><span class="annottext">Either IncoherentDeclReason DeclNameLookup
-&gt; (Either IncoherentDeclReason DeclNameLookup
    -&gt; Cli DeclNameLookup)
-&gt; Cli DeclNameLookup
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(IncoherentDeclReason -&gt; Cli DeclNameLookup)
-&gt; Either IncoherentDeclReason DeclNameLookup -&gt; Cli DeclNameLookup
forall (m :: * -&gt; *) a b.
Applicative m =&gt;
(a -&gt; m b) -&gt; Either a b -&gt; m b
</span><span class="hs-identifier hs-var">onLeft</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Output -&gt; Cli DeclNameLookup
forall a. Output -&gt; Cli a
</span><a href="Unison.Cli.Monad.html#returnEarly"><span class="hs-identifier hs-var">Cli.returnEarly</span></a></span><span> </span><span class="annot"><span class="annottext">(Output -&gt; Cli DeclNameLookup)
-&gt; (IncoherentDeclReason -&gt; Output)
-&gt; IncoherentDeclReason
-&gt; Cli DeclNameLookup
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IncoherentDeclReason -&gt; Output
</span><a href="Unison.Codebase.Editor.Output.html#IncoherentDeclDuringUpdate"><span class="hs-identifier hs-var">Output.IncoherentDeclDuringUpdate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><span class="annottext">Output -&gt; Cli ()
</span><a href="Unison.Cli.Monad.html#respond"><span class="hs-identifier hs-var">Cli.respond</span></a></span><span> </span><span class="annot"><span class="annottext">Output
</span><a href="Unison.Codebase.Editor.Output.html#UpdateLookingForDependents"><span class="hs-identifier hs-var">Output.UpdateLookingForDependents</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621680912844"><span class="annot"><span class="annottext">DefnsF (Map Name) (Id' Hash) (Id' Hash)
</span><a href="#local-6989586621680912844"><span class="hs-identifier hs-var">dependents</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680912845"><span class="annot"><span class="annottext">DefnsF
  (Map Name)
  (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
  (Id' Hash, Decl Symbol Ann)
</span><a href="#local-6989586621680912845"><span class="hs-identifier hs-var">hydratedDependents</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><span class="annottext">Transaction
  (DefnsF (Map Name) (Id' Hash) (Id' Hash),
   DefnsF
     (Map Name)
     (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
     (Id' Hash, Decl Symbol Ann))
-&gt; Cli
     (DefnsF (Map Name) (Id' Hash) (Id' Hash),
      DefnsF
        (Map Name)
        (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
        (Id' Hash, Decl Symbol Ann))
forall a. Transaction a -&gt; Cli a
</span><a href="Unison.Cli.Monad.html#runTransaction"><span class="hs-identifier hs-var">Cli.runTransaction</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-comment">-- Get all dependents of things being updated</span><span>
</span><span id="line-114"></span><span>      </span><span id="local-6989586621680912846"><span class="annot"><span class="annottext">DefnsF (Map Name) (Id' Hash) (Id' Hash)
</span><a href="#local-6989586621680912846"><span class="hs-identifier hs-var">dependents0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-115"></span><span>        </span><span class="annot"><span class="annottext">Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
-&gt; Set TypeReference
-&gt; Transaction (DefnsF (Map Name) (Id' Hash) (Id' Hash))
</span><a href="Unison.Cli.UpdateUtils.html#getNamespaceDependentsOf2"><span class="hs-identifier hs-var">getNamespaceDependentsOf2</span></a></span><span>
</span><span id="line-116"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Nametree (DefnsF (Map NameSegment) Referent TypeReference)
-&gt; Defns (BiMultimap Referent Name) (BiMultimap TypeReference Name)
forall term typ.
(Ord term, Ord typ) =&gt;
Nametree (DefnsF (Map NameSegment) term typ)
-&gt; Defns (BiMultimap term Name) (BiMultimap typ Name)
</span><span class="hs-identifier hs-var">flattenNametrees</span></span><span> </span><span class="annot"><span class="annottext">Nametree (DefnsF (Map NameSegment) Referent TypeReference)
</span><a href="#local-6989586621680912817"><span class="hs-identifier hs-var">nametree</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-117"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DefnsF Set Name Name -&gt; Names -&gt; Set TypeReference
</span><a href="Unison.Codebase.Editor.HandleInput.Update2.html#getExistingReferencesNamed"><span class="hs-identifier hs-var">getExistingReferencesNamed</span></a></span><span> </span><span class="annot"><span class="annottext">DefnsF Set Name Name
</span><a href="#local-6989586621680912807"><span class="hs-identifier hs-var">termAndDeclNames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Branch0 IO -&gt; Names
forall (m :: * -&gt; *). Branch0 m -&gt; Names
</span><span class="hs-identifier hs-var">Branch.toNames</span></span><span> </span><span class="annot"><span class="annottext">Branch0 IO
</span><a href="#local-6989586621680912813"><span class="hs-identifier hs-var">currentBranch0ExcludingLibdeps</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span>      </span><span class="hs-comment">-- Throw away the dependents that are shadowed by the file itself</span><span>
</span><span id="line-120"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680912848"><span class="hs-identifier hs-type">dependents1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefnsF</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReferenceId</span></span><span>
</span><span id="line-121"></span><span>          </span><span id="local-6989586621680912848"><span class="annot"><span class="annottext">dependents1 :: DefnsF (Map Name) (Id' Hash) (Id' Hash)
</span><a href="#local-6989586621680912848"><span class="hs-identifier hs-var hs-var">dependents1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-122"></span><span>            </span><span class="annot"><span class="annottext">(Map Name (Id' Hash) -&gt; Map Name (Id' Hash))
-&gt; (Map Name (Id' Hash) -&gt; Map Name (Id' Hash))
-&gt; DefnsF (Map Name) (Id' Hash) (Id' Hash)
-&gt; DefnsF (Map Name) (Id' Hash) (Id' Hash)
forall a b c d. (a -&gt; b) -&gt; (c -&gt; d) -&gt; Defns a c -&gt; Defns b d
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span>
</span><span id="line-123"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name (Id' Hash) -&gt; Set Name -&gt; Map Name (Id' Hash)
forall k a. Ord k =&gt; Map k a -&gt; Set k -&gt; Map k a
</span><span class="hs-operator hs-var">`Map.withoutKeys`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Symbol -&gt; Name) -&gt; Set Symbol -&gt; Set Name
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeParseVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann -&gt; Set Symbol
forall v a. Ord v =&gt; TypecheckedUnisonFile v a -&gt; Set v
</span><span class="hs-identifier hs-var">UF.termNamespaceBindings</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912805"><span class="hs-identifier hs-var">tuf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Name (Id' Hash) -&gt; Set Name -&gt; Map Name (Id' Hash)
forall k a. Ord k =&gt; Map k a -&gt; Set k -&gt; Map k a
</span><span class="hs-operator hs-var">`Map.withoutKeys`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Symbol -&gt; Name) -&gt; Set Symbol -&gt; Set Name
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeParseVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann -&gt; Set Symbol
forall v a. Ord v =&gt; TypecheckedUnisonFile v a -&gt; Set v
</span><span class="hs-identifier hs-var">UF.typeNamespaceBindings</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912805"><span class="hs-identifier hs-var">tuf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-125"></span><span>              </span><span class="annot"><span class="annottext">DefnsF (Map Name) (Id' Hash) (Id' Hash)
</span><a href="#local-6989586621680912846"><span class="hs-identifier hs-var">dependents0</span></a></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span>      </span><span class="hs-comment">-- Hydrate the dependents for rendering</span><span>
</span><span id="line-128"></span><span>      </span><span id="local-6989586621680912855"><span class="annot"><span class="annottext">DefnsF
  (Map Name)
  (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
  (Id' Hash, Decl Symbol Ann)
</span><a href="#local-6989586621680912855"><span class="hs-identifier hs-var">hydratedDependents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-129"></span><span>        </span><span class="annot"><span class="annottext">(Hash -&gt; Transaction [(Term Symbol Ann, Type Symbol Ann)])
-&gt; (Hash -&gt; Transaction [Decl Symbol Ann])
-&gt; DefnsF (Map Name) (Id' Hash) (Id' Hash)
-&gt; Transaction
     (DefnsF
        (Map Name)
        (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
        (Id' Hash, Decl Symbol Ann))
forall (m :: * -&gt; *) name term typ.
(Monad m, Ord name) =&gt;
(Hash -&gt; m [term])
-&gt; (Hash -&gt; m [typ])
-&gt; DefnsF (Map name) (Id' Hash) (Id' Hash)
-&gt; m (DefnsF (Map name) (Id' Hash, term) (Id' Hash, typ))
</span><a href="Unison.Cli.UpdateUtils.html#hydrateDefns"><span class="hs-identifier hs-var">hydrateDefns</span></a></span><span>
</span><span id="line-130"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; Hash -&gt; Transaction [(Term Symbol Ann, Type Symbol Ann)]
forall (m :: * -&gt; *) v a.
HasCallStack =&gt;
Codebase m v a -&gt; Hash -&gt; Transaction [(Term v a, Type v a)]
</span><span class="hs-identifier hs-var">Codebase.unsafeGetTermComponent</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621680912804"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">codebase</span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>          </span><span class="annot"><span class="annottext">HasCallStack =&gt; Hash -&gt; Transaction [Decl Symbol Ann]
Hash -&gt; Transaction [Decl Symbol Ann]
</span><span class="hs-identifier hs-var">Operations.expectDeclComponent</span></span><span>
</span><span id="line-132"></span><span>          </span><span class="annot"><span class="annottext">DefnsF (Map Name) (Id' Hash) (Id' Hash)
</span><a href="#local-6989586621680912848"><span class="hs-identifier hs-var">dependents1</span></a></span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span>      </span><span class="hs-identifier">pure</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DefnsF (Map Name) (Id' Hash) (Id' Hash)
</span><a href="#local-6989586621680912848"><span class="hs-identifier hs-var">dependents1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DefnsF
  (Map Name)
  (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
  (Id' Hash, Decl Symbol Ann)
</span><a href="#local-6989586621680912855"><span class="hs-identifier hs-var">hydratedDependents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>  </span><span id="local-6989586621680912858"><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912858"><span class="hs-identifier hs-var">secondTuf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DefnsF (Map Name) (Id' Hash) (Id' Hash) -&gt; Bool
forall (f :: * -&gt; *) (g :: * -&gt; *) a b.
(Foldable f, Foldable g) =&gt;
Defns (f a) (g b) -&gt; Bool
</span><span class="hs-identifier hs-var">defnsAreEmpty</span></span><span> </span><span class="annot"><span class="annottext">DefnsF (Map Name) (Id' Hash) (Id' Hash)
</span><a href="#local-6989586621680912844"><span class="hs-identifier hs-var">dependents</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-138"></span><span>      </span><span class="hs-comment">-- If there are no dependents of the updates, then just use the already-typechecked file.</span><span>
</span><span id="line-139"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Cli (TypecheckedUnisonFile Symbol Ann)
forall a. a -&gt; Cli a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912805"><span class="hs-identifier hs-var">tuf</span></a></span><span>
</span><span id="line-140"></span><span>      </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-141"></span><span>        </span><span class="annot"><span class="annottext">Output -&gt; Cli ()
</span><a href="Unison.Cli.Monad.html#respond"><span class="hs-identifier hs-var">Cli.respond</span></a></span><span> </span><span class="annot"><span class="annottext">Output
</span><a href="Unison.Codebase.Editor.Output.html#UpdateStartTypechecking"><span class="hs-identifier hs-var">Output.UpdateStartTypechecking</span></a></span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680912860"><span class="annot"><span class="annottext">prettyUnisonFile :: Pretty ColorText
</span><a href="#local-6989586621680912860"><span class="hs-identifier hs-var hs-var">prettyUnisonFile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-144"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680912861"><span class="annot"><span class="annottext">ppe :: PrettyPrintEnvDecl
</span><a href="#local-6989586621680912861"><span class="hs-identifier hs-var hs-var">ppe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Names
-&gt; Names
-&gt; DefnsF (Map Name) (Id' Hash) (Id' Hash)
-&gt; PrettyPrintEnvDecl
</span><a href="Unison.Codebase.Editor.HandleInput.Update2.html#makePPE"><span class="hs-identifier hs-var">makePPE</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">10</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680912815"><span class="hs-identifier hs-var">namesIncludingLibdeps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann -&gt; Names
forall v a. Var v =&gt; TypecheckedUnisonFile v a -&gt; Names
</span><span class="hs-identifier hs-var">UF.typecheckedToNames</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912805"><span class="hs-identifier hs-var">tuf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DefnsF (Map Name) (Id' Hash) (Id' Hash)
</span><a href="#local-6989586621680912844"><span class="hs-identifier hs-var">dependents</span></a></span><span>
</span><span id="line-145"></span><span>               </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
-&gt; DefnsF (Map Name) (Pretty ColorText) (Pretty ColorText)
-&gt; Pretty ColorText
</span><a href="Unison.Codebase.Editor.HandleInput.Update2.html#makePrettyUnisonFile"><span class="hs-identifier hs-var">makePrettyUnisonFile</span></a></span><span>
</span><span id="line-146"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrettyPrintEnvDecl -&gt; UnisonFile Symbol Ann -&gt; Pretty ColorText
forall v a.
(Var v, Ord a) =&gt;
PrettyPrintEnvDecl -&gt; UnisonFile v a -&gt; Pretty ColorText
</span><a href="Unison.Cli.Pretty.html#prettyUnisonFile"><span class="hs-identifier hs-var">Pretty.prettyUnisonFile</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><a href="#local-6989586621680912861"><span class="hs-identifier hs-var">ppe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann -&gt; UnisonFile Symbol Ann
forall v a. Ord v =&gt; TypecheckedUnisonFile v a -&gt; UnisonFile v a
</span><span class="hs-identifier hs-var">UF.discardTypes</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912805"><span class="hs-identifier hs-var">tuf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DeclNameLookup
-&gt; PrettyPrintEnvDecl
-&gt; DefnsF
     (Map Name)
     (Term Symbol Ann, Type Symbol Ann)
     (Id' Hash, Decl Symbol Ann)
-&gt; DefnsF (Map Name) (Pretty ColorText) (Pretty ColorText)
forall a v.
(Var v, Monoid a) =&gt;
DeclNameLookup
-&gt; PrettyPrintEnvDecl
-&gt; DefnsF (Map Name) (Term v a, Type v a) (Id' Hash, Decl v a)
-&gt; DefnsF (Map Name) (Pretty ColorText) (Pretty ColorText)
</span><span class="hs-identifier hs-var">renderDefnsForUnisonFile</span></span><span> </span><span class="annot"><span class="annottext">DeclNameLookup
</span><a href="#local-6989586621680912839"><span class="hs-identifier hs-var">declNameLookup</span></a></span><span> </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl
</span><a href="#local-6989586621680912861"><span class="hs-identifier hs-var">ppe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ASetter
  (DefnsF
     (Map Name)
     (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
     (Id' Hash, Decl Symbol Ann))
  (DefnsF
     (Map Name)
     (Term Symbol Ann, Type Symbol Ann)
     (Id' Hash, Decl Symbol Ann))
  (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
  (Term Symbol Ann, Type Symbol Ann)
-&gt; ((Id' Hash, (Term Symbol Ann, Type Symbol Ann))
    -&gt; (Term Symbol Ann, Type Symbol Ann))
-&gt; DefnsF
     (Map Name)
     (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
     (Id' Hash, Decl Symbol Ann)
-&gt; DefnsF
     (Map Name)
     (Term Symbol Ann, Type Symbol Ann)
     (Id' Hash, Decl Symbol Ann)
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><span class="hs-identifier hs-var">over</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map Name (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
 -&gt; Identity (Map Name (Term Symbol Ann, Type Symbol Ann)))
-&gt; DefnsF
     (Map Name)
     (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
     (Id' Hash, Decl Symbol Ann)
-&gt; Identity
     (DefnsF
        (Map Name)
        (Term Symbol Ann, Type Symbol Ann)
        (Id' Hash, Decl Symbol Ann))
</span><span class="">#terms</span></span><span> </span><span class="annot"><span class="annottext">((Map Name (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
  -&gt; Identity (Map Name (Term Symbol Ann, Type Symbol Ann)))
 -&gt; DefnsF
      (Map Name)
      (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
      (Id' Hash, Decl Symbol Ann)
 -&gt; Identity
      (DefnsF
         (Map Name)
         (Term Symbol Ann, Type Symbol Ann)
         (Id' Hash, Decl Symbol Ann)))
-&gt; (((Id' Hash, (Term Symbol Ann, Type Symbol Ann))
     -&gt; Identity (Term Symbol Ann, Type Symbol Ann))
    -&gt; Map Name (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
    -&gt; Identity (Map Name (Term Symbol Ann, Type Symbol Ann)))
-&gt; ASetter
     (DefnsF
        (Map Name)
        (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
        (Id' Hash, Decl Symbol Ann))
     (DefnsF
        (Map Name)
        (Term Symbol Ann, Type Symbol Ann)
        (Id' Hash, Decl Symbol Ann))
     (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
     (Term Symbol Ann, Type Symbol Ann)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Id' Hash, (Term Symbol Ann, Type Symbol Ann))
 -&gt; Identity (Term Symbol Ann, Type Symbol Ann))
-&gt; Map Name (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
-&gt; Identity (Map Name (Term Symbol Ann, Type Symbol Ann))
Setter
  (Map Name (Id' Hash, (Term Symbol Ann, Type Symbol Ann)))
  (Map Name (Term Symbol Ann, Type Symbol Ann))
  (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
  (Term Symbol Ann, Type Symbol Ann)
forall (f :: * -&gt; *) a b. Functor f =&gt; Setter (f a) (f b) a b
</span><span class="hs-identifier hs-var">mapped</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Id' Hash, (Term Symbol Ann, Type Symbol Ann))
-&gt; (Term Symbol Ann, Type Symbol Ann)
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">DefnsF
  (Map Name)
  (Id' Hash, (Term Symbol Ann, Type Symbol Ann))
  (Id' Hash, Decl Symbol Ann)
</span><a href="#local-6989586621680912845"><span class="hs-identifier hs-var">hydratedDependents</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span>        </span><span id="local-6989586621680912869"><span class="annot"><span class="annottext">ParsingEnv Transaction
</span><a href="#local-6989586621680912869"><span class="hs-identifier hs-var">parsingEnv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ProjectPath -&gt; Names -&gt; Cli (ParsingEnv Transaction)
</span><a href="Unison.Cli.MonadUtils.html#makeParsingEnv"><span class="hs-identifier hs-var">Cli.makeParsingEnv</span></a></span><span> </span><span class="annot"><span class="annottext">ProjectPath
</span><a href="#local-6989586621680912809"><span class="hs-identifier hs-var">pp</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680912815"><span class="hs-identifier hs-var">namesIncludingLibdeps</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span>        </span><span id="local-6989586621680912871"><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912871"><span class="hs-identifier hs-var">secondTuf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-152"></span><span>          </span><span class="annot"><span class="annottext">Pretty ColorText
-&gt; ParsingEnv Transaction
-&gt; Cli (Maybe (TypecheckedUnisonFile Symbol Ann))
</span><a href="Unison.Cli.UpdateUtils.html#parseAndTypecheck"><span class="hs-identifier hs-var">parseAndTypecheck</span></a></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
</span><a href="#local-6989586621680912860"><span class="hs-identifier hs-var">prettyUnisonFile</span></a></span><span> </span><span class="annot"><span class="annottext">ParsingEnv Transaction
</span><a href="#local-6989586621680912869"><span class="hs-identifier hs-var">parsingEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Cli (Maybe (TypecheckedUnisonFile Symbol Ann))
-&gt; (Cli (Maybe (TypecheckedUnisonFile Symbol Ann))
    -&gt; Cli (TypecheckedUnisonFile Symbol Ann))
-&gt; Cli (TypecheckedUnisonFile Symbol Ann)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Cli (TypecheckedUnisonFile Symbol Ann)
-&gt; Cli (Maybe (TypecheckedUnisonFile Symbol Ann))
-&gt; Cli (TypecheckedUnisonFile Symbol Ann)
forall (m :: * -&gt; *) a. Monad m =&gt; m a -&gt; m (Maybe a) -&gt; m a
</span><span class="hs-identifier hs-var">onNothingM</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-153"></span><span>            </span><span id="local-6989586621680912873"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621680912873"><span class="hs-identifier hs-var">scratchFilePath</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(FilePath, Bool) -&gt; FilePath
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((FilePath, Bool) -&gt; FilePath)
-&gt; Cli (FilePath, Bool) -&gt; Cli FilePath
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Cli (FilePath, Bool)
</span><a href="Unison.Cli.MonadUtils.html#expectLatestFile"><span class="hs-identifier hs-var">Cli.expectLatestFile</span></a></span><span>
</span><span id="line-154"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; Cli ()
forall a. IO a -&gt; Cli a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; Cli ()) -&gt; IO () -&gt; Cli ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621680912804"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">writeSource</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621680912873"><span class="hs-identifier hs-var">scratchFilePath</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; Text
</span><span class="hs-identifier hs-var">Text.pack</span></span><span> </span><span class="annot"><span class="annottext">(FilePath -&gt; Text) -&gt; FilePath -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Width -&gt; Pretty ColorText -&gt; FilePath
</span><span class="hs-identifier hs-var">Pretty.toPlain</span></span><span> </span><span class="annot"><span class="annottext">Width
</span><span class="hs-number">80</span></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
</span><a href="#local-6989586621680912860"><span class="hs-identifier hs-var">prettyUnisonFile</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-155"></span><span>            </span><span class="annot"><span class="annottext">Output -&gt; Cli (TypecheckedUnisonFile Symbol Ann)
forall a. Output -&gt; Cli a
</span><a href="Unison.Cli.Monad.html#returnEarly"><span class="hs-identifier hs-var">Cli.returnEarly</span></a></span><span> </span><span class="annot"><span class="annottext">Output
</span><a href="Unison.Codebase.Editor.Output.html#UpdateTypecheckingFailure"><span class="hs-identifier hs-var">Output.UpdateTypecheckingFailure</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>        </span><span class="annot"><span class="annottext">Output -&gt; Cli ()
</span><a href="Unison.Cli.Monad.html#respond"><span class="hs-identifier hs-var">Cli.respond</span></a></span><span> </span><span class="annot"><span class="annottext">Output
</span><a href="Unison.Codebase.Editor.Output.html#UpdateTypecheckingSuccess"><span class="hs-identifier hs-var">Output.UpdateTypecheckingSuccess</span></a></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span>        </span><span class="hs-identifier">pure</span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912871"><span class="hs-identifier hs-var">secondTuf</span></a></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>  </span><span id="local-6989586621680912882"><span class="annot"><span class="annottext">ProjectPath
</span><a href="#local-6989586621680912882"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Cli ProjectPath
</span><a href="Unison.Cli.MonadUtils.html#getCurrentProjectPath"><span class="hs-identifier hs-var">Cli.getCurrentProjectPath</span></a></span><span>
</span><span id="line-162"></span><span>  </span><span id="local-6989586621680912883"><span class="annot"><span class="annottext">[(Path, Branch0 IO -&gt; Branch0 IO)]
</span><a href="#local-6989586621680912883"><span class="hs-identifier hs-var">branchUpdates</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-163"></span><span>    </span><span class="annot"><span class="annottext">((forall void. Output -&gt; Transaction void)
 -&gt; Transaction [(Path, Branch0 IO -&gt; Branch0 IO)])
-&gt; Cli [(Path, Branch0 IO -&gt; Branch0 IO)]
forall a.
((forall void. Output -&gt; Transaction void) -&gt; Transaction a)
-&gt; Cli a
</span><a href="Unison.Cli.Monad.html#runTransactionWithRollback"><span class="hs-identifier hs-var">Cli.runTransactionWithRollback</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680912885"><span class="annot"><span class="annottext">forall void. Output -&gt; Transaction void
</span><a href="#local-6989586621680912885"><span class="hs-identifier hs-var">abort</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>      </span><span class="annot"><span class="annottext">Codebase IO Symbol Ann
-&gt; TypecheckedUnisonFile Symbol Ann -&gt; Transaction ()
forall (m :: * -&gt; *) v a.
(Var v, Show a) =&gt;
Codebase m v a -&gt; TypecheckedUnisonFile v a -&gt; Transaction ()
</span><span class="hs-identifier hs-var">Codebase.addDefsToCodebase</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621680912804"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">codebase</span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912858"><span class="hs-identifier hs-var">secondTuf</span></a></span><span>
</span><span id="line-165"></span><span>      </span><span class="annot"><span class="annottext">(forall void. Output -&gt; Transaction void)
-&gt; (Name -&gt; Either Output (Maybe [Name]))
-&gt; TypecheckedUnisonFile Symbol Ann
-&gt; Transaction [(Path, Branch0 IO -&gt; Branch0 IO)]
forall (m :: * -&gt; *).
(forall void. Output -&gt; Transaction void)
-&gt; (Name -&gt; Either Output (Maybe [Name]))
-&gt; TypecheckedUnisonFile Symbol Ann
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="Unison.Codebase.Editor.HandleInput.Update2.html#typecheckedUnisonFileToBranchUpdates"><span class="hs-identifier hs-var">typecheckedUnisonFileToBranchUpdates</span></a></span><span>
</span><span id="line-166"></span><span>        </span><span class="annot"><span class="annottext">Output -&gt; Transaction void
forall void. Output -&gt; Transaction void
</span><a href="#local-6989586621680912885"><span class="hs-identifier hs-var">abort</span></a></span><span>
</span><span id="line-167"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680912887"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680912887"><span class="hs-identifier hs-var">typeName</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe [Name] -&gt; Either Output (Maybe [Name])
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Map Name [Name] -&gt; Maybe [Name]
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Map.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680912887"><span class="hs-identifier hs-var">typeName</span></a></span><span> </span><span class="annot"><span class="annottext">DeclNameLookup
</span><a href="#local-6989586621680912839"><span class="hs-identifier hs-var">declNameLookup</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">declToConstructors</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>        </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912858"><span class="hs-identifier hs-var">secondTuf</span></a></span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><span class="annottext">Text -&gt; (ProjectPath, Branch0 IO -&gt; Branch0 IO) -&gt; Cli ()
</span><a href="Unison.Cli.MonadUtils.html#stepAt"><span class="hs-identifier hs-var">Cli.stepAt</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;update&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProjectPath
</span><a href="#local-6989586621680912882"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 IO -&gt; Branch0 IO)] -&gt; Branch0 IO -&gt; Branch0 IO
forall (f :: * -&gt; *) (m :: * -&gt; *).
(Monad m, Foldable f) =&gt;
f (Path, Branch0 m -&gt; Branch0 m) -&gt; Branch0 m -&gt; Branch0 m
</span><span class="hs-identifier hs-var">Branch.batchUpdates</span></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 IO -&gt; Branch0 IO)]
</span><a href="#local-6989586621680912883"><span class="hs-identifier hs-var">branchUpdates</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
  #latestTypecheckedFile .= Nothing
</span><span>
</span><span id="line-172"></span><span>  </span><span class="annot"><span class="annottext">Output -&gt; Cli ()
</span><a href="Unison.Cli.Monad.html#respond"><span class="hs-identifier hs-var">Cli.respond</span></a></span><span> </span><span class="annot"><span class="annottext">Output
</span><a href="Unison.Codebase.Editor.Output.html#Success"><span class="hs-identifier hs-var">Output.Success</span></a></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update2.html#makePrettyUnisonFile"><span class="hs-identifier hs-type">makePrettyUnisonFile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ColorText</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefnsF</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ColorText</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ColorText</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ColorText</span></span><span>
</span><span id="line-175"></span><span id="makePrettyUnisonFile"><span class="annot"><span class="annottext">makePrettyUnisonFile :: Pretty ColorText
-&gt; DefnsF (Map Name) (Pretty ColorText) (Pretty ColorText)
-&gt; Pretty ColorText
</span><a href="Unison.Codebase.Editor.HandleInput.Update2.html#makePrettyUnisonFile"><span class="hs-identifier hs-var hs-var">makePrettyUnisonFile</span></a></span></span><span> </span><span id="local-6989586621680912892"><span class="annot"><span class="annottext">Pretty ColorText
</span><a href="#local-6989586621680912892"><span class="hs-identifier hs-var">originalFile</span></a></span></span><span> </span><span id="local-6989586621680912893"><span class="annot"><span class="annottext">DefnsF (Map Name) (Pretty ColorText) (Pretty ColorText)
</span><a href="#local-6989586621680912893"><span class="hs-identifier hs-var">dependents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><span class="annottext">Pretty ColorText
</span><a href="#local-6989586621680912892"><span class="hs-identifier hs-var">originalFile</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><span class="annottext">Pretty ColorText -&gt; Pretty ColorText -&gt; Pretty ColorText
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
forall s. IsString s =&gt; Pretty s
</span><span class="hs-identifier hs-var">Pretty.newline</span></span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><span class="annottext">Pretty ColorText -&gt; Pretty ColorText -&gt; Pretty ColorText
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
forall s. IsString s =&gt; Pretty s
</span><span class="hs-identifier hs-var">Pretty.newline</span></span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><span class="annottext">Pretty ColorText -&gt; Pretty ColorText -&gt; Pretty ColorText
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
</span><span class="hs-string">&quot;-- The definitions below no longer typecheck with the changes above.&quot;</span></span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><span class="annottext">Pretty ColorText -&gt; Pretty ColorText -&gt; Pretty ColorText
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
forall s. IsString s =&gt; Pretty s
</span><span class="hs-identifier hs-var">Pretty.newline</span></span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><span class="annottext">Pretty ColorText -&gt; Pretty ColorText -&gt; Pretty ColorText
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
</span><span class="hs-string">&quot;-- Please fix the errors and try `update` again.&quot;</span></span><span>
</span><span id="line-182"></span><span>    </span><span class="annot"><span class="annottext">Pretty ColorText -&gt; Pretty ColorText -&gt; Pretty ColorText
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
forall s. IsString s =&gt; Pretty s
</span><span class="hs-identifier hs-var">Pretty.newline</span></span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><span class="annottext">Pretty ColorText -&gt; Pretty ColorText -&gt; Pretty ColorText
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
forall s. IsString s =&gt; Pretty s
</span><span class="hs-identifier hs-var">Pretty.newline</span></span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><span class="annottext">Pretty ColorText -&gt; Pretty ColorText -&gt; Pretty ColorText
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">DefnsF (Map Name) (Pretty ColorText) (Pretty ColorText)
</span><a href="#local-6989586621680912893"><span class="hs-identifier hs-var">dependents</span></a></span><span>
</span><span id="line-185"></span><span>           </span><span class="annot"><span class="annottext">DefnsF (Map Name) (Pretty ColorText) (Pretty ColorText)
-&gt; (DefnsF (Map Name) (Pretty ColorText) (Pretty ColorText)
    -&gt; DefnsF [] (Pretty ColorText) (Pretty ColorText))
-&gt; DefnsF [] (Pretty ColorText) (Pretty ColorText)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">DefnsF (Map Name) (Pretty ColorText) (Pretty ColorText)
-&gt; DefnsF [] (Pretty ColorText) (Pretty ColorText)
forall a b. DefnsF (Map Name) a b -&gt; DefnsF [] a b
</span><a href="#local-6989586621680912895"><span class="hs-identifier hs-var">inAlphabeticalOrder</span></a></span><span>
</span><span id="line-186"></span><span>           </span><span class="annot"><span class="annottext">DefnsF [] (Pretty ColorText) (Pretty ColorText)
-&gt; (DefnsF [] (Pretty ColorText) (Pretty ColorText)
    -&gt; Pretty ColorText)
-&gt; Pretty ColorText
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680912902"><span class="annot"><span class="annottext">f :: [Pretty ColorText] -&gt; Pretty ColorText
</span><a href="#local-6989586621680912902"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Pretty ColorText -&gt; Pretty ColorText)
-&gt; [Pretty ColorText] -&gt; Pretty ColorText
forall m a. Monoid m =&gt; (a -&gt; m) -&gt; [a] -&gt; m
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680912904"><span class="annot"><span class="annottext">Pretty ColorText
</span><a href="#local-6989586621680912904"><span class="hs-identifier hs-var">defn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
</span><a href="#local-6989586621680912904"><span class="hs-identifier hs-var">defn</span></a></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText -&gt; Pretty ColorText -&gt; Pretty ColorText
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
forall s. IsString s =&gt; Pretty s
</span><span class="hs-identifier hs-var">Pretty.newline</span></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText -&gt; Pretty ColorText -&gt; Pretty ColorText
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pretty ColorText
forall s. IsString s =&gt; Pretty s
</span><span class="hs-identifier hs-var">Pretty.newline</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">([Pretty ColorText] -&gt; Pretty ColorText)
-&gt; ([Pretty ColorText] -&gt; Pretty ColorText)
-&gt; DefnsF [] (Pretty ColorText) (Pretty ColorText)
-&gt; Pretty ColorText
forall m a b. Monoid m =&gt; (a -&gt; m) -&gt; (b -&gt; m) -&gt; Defns a b -&gt; m
forall (p :: * -&gt; * -&gt; *) m a b.
(Bifoldable p, Monoid m) =&gt;
(a -&gt; m) -&gt; (b -&gt; m) -&gt; p a b -&gt; m
</span><span class="hs-identifier hs-var">bifoldMap</span></span><span> </span><span class="annot"><span class="annottext">[Pretty ColorText] -&gt; Pretty ColorText
</span><a href="#local-6989586621680912902"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[Pretty ColorText] -&gt; Pretty ColorText
</span><a href="#local-6989586621680912902"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-187"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621680912456"><span id="local-6989586621680912457"><span class="annot"><a href="#local-6989586621680912895"><span class="hs-identifier hs-type">inAlphabeticalOrder</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefnsF</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680912456"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680912457"><span class="hs-identifier hs-type">b</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefnsF</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621680912456"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680912457"><span class="hs-identifier hs-type">b</span></a></span></span></span><span>
</span><span id="line-190"></span><span>    </span><span id="local-6989586621680912895"><span class="annot"><span class="annottext">inAlphabeticalOrder :: forall a b. DefnsF (Map Name) a b -&gt; DefnsF [] a b
</span><a href="#local-6989586621680912895"><span class="hs-identifier hs-var hs-var">inAlphabeticalOrder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-191"></span><span>      </span><span class="annot"><span class="annottext">(Map Name a -&gt; [a])
-&gt; (Map Name b -&gt; [b])
-&gt; Defns (Map Name a) (Map Name b)
-&gt; Defns [a] [b]
forall a b c d. (a -&gt; b) -&gt; (c -&gt; d) -&gt; Defns a c -&gt; Defns b d
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Map Name a -&gt; [a]
forall {b}. Map Name b -&gt; [b]
</span><a href="#local-6989586621680912906"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name b -&gt; [b]
forall {b}. Map Name b -&gt; [b]
</span><a href="#local-6989586621680912906"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-192"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-193"></span><span>        </span><span id="local-6989586621680912906"><span class="annot"><span class="annottext">f :: Map Name b -&gt; [b]
</span><a href="#local-6989586621680912906"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, b) -&gt; b) -&gt; [(Name, b)] -&gt; [b]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, b) -&gt; b
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(Name, b)] -&gt; [b])
-&gt; (Map Name b -&gt; [(Name, b)]) -&gt; Map Name b -&gt; [b]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Name, b) -&gt; Text) -&gt; [(Name, b)] -&gt; [(Name, b)]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">List.sortOn</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Text
</span><span class="hs-identifier hs-var">Name.toText</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Text) -&gt; ((Name, b) -&gt; Name) -&gt; (Name, b) -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, b) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Name, b)] -&gt; [(Name, b)])
-&gt; (Map Name b -&gt; [(Name, b)]) -&gt; Map Name b -&gt; [(Name, b)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map Name b -&gt; [(Name, b)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">-- @typecheckedUnisonFileToBranchUpdates getConstructors file@ returns a list of branch updates (suitable for passing</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- along to `batchUpdates` or some &quot;step at&quot; combinator) that corresponds to using all of the contents of @file@.</span><span>
</span><span id="line-197"></span><span class="hs-comment">-- `getConstructors` returns the full constructor names of a decl, e.g. &quot;Maybe&quot; -&gt; [&quot;Maybe.Nothing&quot;, &quot;Maybe.Just&quot;]</span><span>
</span><span id="line-198"></span><span class="hs-comment">--</span><span>
</span><span id="line-199"></span><span class="hs-comment">-- For example, if the file contains</span><span>
</span><span id="line-200"></span><span class="hs-comment">--</span><span>
</span><span id="line-201"></span><span class="hs-comment">--     foo.bar.baz = &lt;#foo&gt;</span><span>
</span><span id="line-202"></span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- then the returned updates will look like</span><span>
</span><span id="line-204"></span><span class="hs-comment">--</span><span>
</span><span id="line-205"></span><span class="hs-comment">--     [ (&quot;foo.bar&quot;, insert-term(&quot;baz&quot;,&lt;#foo&gt;)) ]</span><span>
</span><span id="line-206"></span><span id="local-6989586621680912442"><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update2.html#typecheckedUnisonFileToBranchUpdates"><span class="hs-identifier hs-type">typecheckedUnisonFileToBranchUpdates</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680912911"><span class="annot"><a href="#local-6989586621680912911"><span class="hs-identifier hs-type">void</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.Output.html#Output"><span class="hs-identifier hs-type">Output</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><a href="#local-6989586621680912911"><span class="hs-identifier hs-type">void</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-comment">-- | Returns 'Nothing' if the decl isn't in namesExcludingLibdeps,</span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-comment">-- in which case we know the decl is new and do not need to generate</span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-comment">-- delete actions for it.</span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.Output.html#Output"><span class="hs-identifier hs-type">Output</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-212"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">TypecheckedUnisonFile</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621680912442"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621680912442"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-214"></span><span id="typecheckedUnisonFileToBranchUpdates"><span class="annot"><span class="annottext">typecheckedUnisonFileToBranchUpdates :: forall (m :: * -&gt; *).
(forall void. Output -&gt; Transaction void)
-&gt; (Name -&gt; Either Output (Maybe [Name]))
-&gt; TypecheckedUnisonFile Symbol Ann
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="Unison.Codebase.Editor.HandleInput.Update2.html#typecheckedUnisonFileToBranchUpdates"><span class="hs-identifier hs-var hs-var">typecheckedUnisonFileToBranchUpdates</span></a></span></span><span> </span><span id="local-6989586621680912914"><span class="annot"><span class="annottext">forall void. Output -&gt; Transaction void
</span><a href="#local-6989586621680912914"><span class="hs-identifier hs-var">abort</span></a></span></span><span> </span><span id="local-6989586621680912915"><span class="annot"><span class="annottext">Name -&gt; Either Output (Maybe [Name])
</span><a href="#local-6989586621680912915"><span class="hs-identifier hs-var">getConstructors</span></a></span></span><span> </span><span id="local-6989586621680912916"><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912916"><span class="hs-identifier hs-var">tuf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>  </span><span id="local-6989586621680912917"><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912917"><span class="hs-identifier hs-var">declUpdates</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(forall void. Output -&gt; Transaction void)
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
forall (m :: * -&gt; *).
(forall void. Output -&gt; Transaction void)
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912918"><span class="hs-identifier hs-var">makeDeclUpdates</span></a></span><span> </span><span class="annot"><span class="annottext">Output -&gt; Transaction void
forall void. Output -&gt; Transaction void
</span><a href="#local-6989586621680912914"><span class="hs-identifier hs-var">abort</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912917"><span class="hs-identifier hs-var">declUpdates</span></a></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
forall (m :: * -&gt; *). [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912919"><span class="hs-identifier hs-var">termUpdates</span></a></span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><a href="#local-6989586621680912918"><span class="hs-identifier hs-type">makeDeclUpdates</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680912475"><span class="annot"><a href="#local-6989586621680912475"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680912920"><span class="annot"><a href="#local-6989586621680912920"><span class="hs-identifier hs-type">void</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Unison.Codebase.Editor.Output.html#Output"><span class="hs-identifier hs-type">Output</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="annot"><a href="#local-6989586621680912920"><span class="hs-identifier hs-type">void</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621680912475"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621680912475"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-219"></span><span>    </span><span id="local-6989586621680912918"><span class="annot"><span class="annottext">makeDeclUpdates :: forall (m :: * -&gt; *).
(forall void. Output -&gt; Transaction void)
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912918"><span class="hs-identifier hs-var hs-var">makeDeclUpdates</span></a></span></span><span> </span><span id="local-6989586621680912940"><span class="annot"><span class="annottext">forall void. Output -&gt; Transaction void
</span><a href="#local-6989586621680912940"><span class="hs-identifier hs-var">abort</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>      </span><span id="local-6989586621680912941"><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912941"><span class="hs-identifier hs-var">dataDeclUpdates</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Symbol, (Id' Hash, DataDeclaration Symbol Ann))
 -&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; [(Symbol, (Id' Hash, DataDeclaration Symbol Ann))]
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
forall (m :: * -&gt; *) (f :: * -&gt; *) b a.
(Monad m, Foldable f, Monoid b) =&gt;
(a -&gt; m b) -&gt; f a -&gt; m b
</span><span class="hs-identifier hs-var">Monoid.foldMapM</span></span><span> </span><span class="annot"><span class="annottext">(Symbol, (Id' Hash, DataDeclaration Symbol Ann))
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912943"><span class="hs-identifier hs-var">makeDataDeclUpdates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Symbol (Id' Hash, DataDeclaration Symbol Ann)
-&gt; [(Symbol, (Id' Hash, DataDeclaration Symbol Ann))]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">(Map Symbol (Id' Hash, DataDeclaration Symbol Ann)
 -&gt; [(Symbol, (Id' Hash, DataDeclaration Symbol Ann))])
-&gt; Map Symbol (Id' Hash, DataDeclaration Symbol Ann)
-&gt; [(Symbol, (Id' Hash, DataDeclaration Symbol Ann))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Map Symbol (Id' Hash, DataDeclaration Symbol Ann)
forall v a.
TypecheckedUnisonFile v a -&gt; Map v (Id' Hash, DataDeclaration v a)
</span><span class="hs-identifier hs-var">UF.dataDeclarationsId'</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912916"><span class="hs-identifier hs-var">tuf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>      </span><span id="local-6989586621680912945"><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912945"><span class="hs-identifier hs-var">effectDeclUpdates</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Symbol, (Id' Hash, EffectDeclaration Symbol Ann))
 -&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; [(Symbol, (Id' Hash, EffectDeclaration Symbol Ann))]
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
forall (m :: * -&gt; *) (f :: * -&gt; *) b a.
(Monad m, Foldable f, Monoid b) =&gt;
(a -&gt; m b) -&gt; f a -&gt; m b
</span><span class="hs-identifier hs-var">Monoid.foldMapM</span></span><span> </span><span class="annot"><span class="annottext">(Symbol, (Id' Hash, EffectDeclaration Symbol Ann))
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912946"><span class="hs-identifier hs-var">makeEffectDeclUpdates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map Symbol (Id' Hash, EffectDeclaration Symbol Ann)
-&gt; [(Symbol, (Id' Hash, EffectDeclaration Symbol Ann))]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span> </span><span class="annot"><span class="annottext">(Map Symbol (Id' Hash, EffectDeclaration Symbol Ann)
 -&gt; [(Symbol, (Id' Hash, EffectDeclaration Symbol Ann))])
-&gt; Map Symbol (Id' Hash, EffectDeclaration Symbol Ann)
-&gt; [(Symbol, (Id' Hash, EffectDeclaration Symbol Ann))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Map Symbol (Id' Hash, EffectDeclaration Symbol Ann)
forall v a.
TypecheckedUnisonFile v a
-&gt; Map v (Id' Hash, EffectDeclaration v a)
</span><span class="hs-identifier hs-var">UF.effectDeclarationsId'</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912916"><span class="hs-identifier hs-var">tuf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>      </span><span class="hs-identifier">pure</span><span> </span><span class="hs-operator">$</span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912941"><span class="hs-identifier hs-var">dataDeclUpdates</span></a></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912945"><span class="hs-identifier hs-var">effectDeclUpdates</span></a></span><span>
</span><span id="line-223"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-224"></span><span>        </span><span id="local-6989586621680912943"><span class="annot"><span class="annottext">makeDataDeclUpdates :: (Symbol, (Id' Hash, DataDeclaration Symbol Ann))
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912943"><span class="hs-identifier hs-var hs-var">makeDataDeclUpdates</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680912948"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680912948"><span class="hs-identifier hs-var">symbol</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680912949"><span class="annot"><span class="annottext">Id' Hash
</span><a href="#local-6989586621680912949"><span class="hs-identifier hs-var">typeRefId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680912950"><span class="annot"><span class="annottext">DataDeclaration Symbol Ann
</span><a href="#local-6989586621680912950"><span class="hs-identifier hs-var">dataDecl</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Symbol, (Id' Hash, Decl Symbol Ann))
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912951"><span class="hs-identifier hs-var">makeDeclUpdates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680912948"><span class="hs-identifier hs-var">symbol</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id' Hash
</span><a href="#local-6989586621680912949"><span class="hs-identifier hs-var">typeRefId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DataDeclaration Symbol Ann -&gt; Decl Symbol Ann
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration Symbol Ann
</span><a href="#local-6989586621680912950"><span class="hs-identifier hs-var">dataDecl</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>        </span><span id="local-6989586621680912946"><span class="annot"><span class="annottext">makeEffectDeclUpdates :: (Symbol, (Id' Hash, EffectDeclaration Symbol Ann))
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912946"><span class="hs-identifier hs-var hs-var">makeEffectDeclUpdates</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680912952"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680912952"><span class="hs-identifier hs-var">symbol</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680912953"><span class="annot"><span class="annottext">Id' Hash
</span><a href="#local-6989586621680912953"><span class="hs-identifier hs-var">typeRefId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680912954"><span class="annot"><span class="annottext">EffectDeclaration Symbol Ann
</span><a href="#local-6989586621680912954"><span class="hs-identifier hs-var">effectDecl</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Symbol, (Id' Hash, Decl Symbol Ann))
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912951"><span class="hs-identifier hs-var">makeDeclUpdates</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680912952"><span class="hs-identifier hs-var">symbol</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id' Hash
</span><a href="#local-6989586621680912953"><span class="hs-identifier hs-var">typeRefId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EffectDeclaration Symbol Ann -&gt; Decl Symbol Ann
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">EffectDeclaration Symbol Ann
</span><a href="#local-6989586621680912954"><span class="hs-identifier hs-var">effectDecl</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span>        </span><span class="annot"><a href="#local-6989586621680912951"><span class="hs-identifier hs-type">makeDeclUpdates</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TypeReferenceId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Decl</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ann</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Transaction</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621680912475"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621680912475"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-228"></span><span>        </span><span id="local-6989586621680912951"><span class="annot"><span class="annottext">makeDeclUpdates :: (Symbol, (Id' Hash, Decl Symbol Ann))
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912951"><span class="hs-identifier hs-var hs-var">makeDeclUpdates</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680912955"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680912955"><span class="hs-identifier hs-var">symbol</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680912956"><span class="annot"><span class="annottext">Id' Hash
</span><a href="#local-6989586621680912956"><span class="hs-identifier hs-var">typeRefId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680912957"><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680912957"><span class="hs-identifier hs-var">decl</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-229"></span><span>          </span><span class="hs-comment">-- some decls will be deleted, we want to delete their</span><span>
</span><span id="line-230"></span><span>          </span><span class="hs-comment">-- constructors as well</span><span>
</span><span id="line-231"></span><span>          </span><span id="local-6989586621680912958"><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912958"><span class="hs-identifier hs-var">deleteConstructorActions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-232"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
-&gt; ([Name] -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; Maybe [Name]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Name -&gt; (Path, Branch0 m -&gt; Branch0 m))
-&gt; [Name] -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Split -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall (m :: * -&gt; *). Split -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeAnnihilateTermName</span></span><span> </span><span class="annot"><span class="annottext">(Split -&gt; (Path, Branch0 m -&gt; Branch0 m))
-&gt; (Name -&gt; Split) -&gt; Name -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Split
</span><span class="hs-identifier hs-var">Path.splitFromName</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>                </span><span class="annot"><span class="annottext">(Maybe [Name] -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; Either Output (Maybe [Name])
-&gt; Either Output [(Path, Branch0 m -&gt; Branch0 m)]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Either Output (Maybe [Name])
</span><a href="#local-6989586621680912915"><span class="hs-identifier hs-var">getConstructors</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Symbol -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeParseVar</span></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680912955"><span class="hs-identifier hs-var">symbol</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>              </span><span class="annot"><span class="annottext">Either Output [(Path, Branch0 m -&gt; Branch0 m)]
-&gt; (Either Output [(Path, Branch0 m -&gt; Branch0 m)]
    -&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Output -&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; Either Output [(Path, Branch0 m -&gt; Branch0 m)]
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
forall (m :: * -&gt; *) a b.
Applicative m =&gt;
(a -&gt; m b) -&gt; Either a b -&gt; m b
</span><span class="hs-identifier hs-var">onLeft</span></span><span> </span><span class="annot"><span class="annottext">Output -&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
forall void. Output -&gt; Transaction void
</span><a href="#local-6989586621680912940"><span class="hs-identifier hs-var">abort</span></a></span><span>
</span><span id="line-236"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680912962"><span class="annot"><span class="annottext">deleteTypeAction :: (Path, Branch0 m -&gt; Branch0 m)
</span><a href="#local-6989586621680912962"><span class="hs-identifier hs-var hs-var">deleteTypeAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Split -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall (m :: * -&gt; *). Split -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeAnnihilateTypeName</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621680912964"><span class="hs-identifier hs-var">split</span></a></span><span>
</span><span id="line-237"></span><span>              </span><span id="local-6989586621680912964"><span class="annot"><span class="annottext">split :: Split
</span><a href="#local-6989586621680912964"><span class="hs-identifier hs-var hs-var">split</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Split
</span><a href="#local-6989586621680912965"><span class="hs-identifier hs-var">splitVar</span></a></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680912955"><span class="hs-identifier hs-var">symbol</span></a></span><span>
</span><span id="line-238"></span><span>              </span><span id="local-6989586621680912966"><span class="annot"><span class="annottext">insertTypeAction :: (Path, Branch0 m -&gt; Branch0 m)
</span><a href="#local-6989586621680912966"><span class="hs-identifier hs-var hs-var">insertTypeAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Split -&gt; TypeReference -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall p (m :: * -&gt; *).
(p, NameSegment) -&gt; TypeReference -&gt; (p, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeAddTypeName</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621680912964"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id' Hash -&gt; TypeReference
</span><span class="hs-identifier hs-var">Reference.fromId</span></span><span> </span><span class="annot"><span class="annottext">Id' Hash
</span><a href="#local-6989586621680912956"><span class="hs-identifier hs-var">typeRefId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>              </span><span id="local-6989586621680912968"><span class="annot"><span class="annottext">insertTypeConstructorActions :: [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912968"><span class="hs-identifier hs-var hs-var">insertTypeConstructorActions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-240"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680912969"><span class="annot"><span class="annottext">referentIdsWithNames :: [(Symbol, Id)]
</span><a href="#local-6989586621680912969"><span class="hs-identifier hs-var hs-var">referentIdsWithNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Symbol] -&gt; [Id] -&gt; [(Symbol, Id)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DataDeclaration Symbol Ann -&gt; [Symbol]
forall v a. DataDeclaration v a -&gt; [v]
</span><span class="hs-identifier hs-var">Decl.constructorVars</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Decl Symbol Ann -&gt; DataDeclaration Symbol Ann
forall v a. Decl v a -&gt; DataDeclaration v a
</span><span class="hs-identifier hs-var">Decl.asDataDecl</span></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680912957"><span class="hs-identifier hs-var">decl</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id' Hash -&gt; Decl Symbol Ann -&gt; [Id]
forall v a. Id' Hash -&gt; Decl v a -&gt; [Id]
</span><span class="hs-identifier hs-var">Decl.declConstructorReferents</span></span><span> </span><span class="annot"><span class="annottext">Id' Hash
</span><a href="#local-6989586621680912956"><span class="hs-identifier hs-var">typeRefId</span></a></span><span> </span><span class="annot"><span class="annottext">Decl Symbol Ann
</span><a href="#local-6989586621680912957"><span class="hs-identifier hs-var">decl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">((Symbol, Id) -&gt; (Path, Branch0 m -&gt; Branch0 m))
-&gt; [(Symbol, Id)] -&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span>
</span><span id="line-242"></span><span>                      </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680912973"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680912973"><span class="hs-identifier hs-var">sym</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680912974"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680912974"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-243"></span><span>                          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680912975"><span class="annot"><span class="annottext">splitConName :: Split
</span><a href="#local-6989586621680912975"><span class="hs-identifier hs-var hs-var">splitConName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Split
</span><a href="#local-6989586621680912965"><span class="hs-identifier hs-var">splitVar</span></a></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680912973"><span class="hs-identifier hs-var">sym</span></a></span><span>
</span><span id="line-244"></span><span>                           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Split -&gt; Referent -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall p (m :: * -&gt; *).
(p, NameSegment) -&gt; Referent -&gt; (p, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeAddTermName</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621680912975"><span class="hs-identifier hs-var">splitConName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id' Hash -&gt; TypeReference
</span><span class="hs-identifier hs-var">Reference.fromId</span></span><span> </span><span class="annot"><span class="annottext">(Id' Hash -&gt; TypeReference) -&gt; Id -&gt; Referent
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621680912974"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>                      </span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>                      </span><span class="annot"><span class="annottext">[(Symbol, Id)]
</span><a href="#local-6989586621680912969"><span class="hs-identifier hs-var">referentIdsWithNames</span></a></span><span>
</span><span id="line-247"></span><span>              </span><span id="local-6989586621680912977"><span class="annot"><span class="annottext">deleteStuff :: [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912977"><span class="hs-identifier hs-var hs-var">deleteStuff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Path, Branch0 m -&gt; Branch0 m)
</span><a href="#local-6989586621680912962"><span class="hs-identifier hs-var">deleteTypeAction</span></a></span><span> </span><span class="annot"><span class="annottext">(Path, Branch0 m -&gt; Branch0 m)
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912958"><span class="hs-identifier hs-var">deleteConstructorActions</span></a></span><span>
</span><span id="line-248"></span><span>              </span><span id="local-6989586621680912978"><span class="annot"><span class="annottext">addStuff :: [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912978"><span class="hs-identifier hs-var hs-var">addStuff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Path, Branch0 m -&gt; Branch0 m)
</span><a href="#local-6989586621680912966"><span class="hs-identifier hs-var">insertTypeAction</span></a></span><span> </span><span class="annot"><span class="annottext">(Path, Branch0 m -&gt; Branch0 m)
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912968"><span class="hs-identifier hs-var">insertTypeConstructorActions</span></a></span><span>
</span><span id="line-249"></span><span>          </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
forall a. a -&gt; Transaction a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([(Path, Branch0 m -&gt; Branch0 m)]
 -&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
-&gt; Transaction [(Path, Branch0 m -&gt; Branch0 m)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912977"><span class="hs-identifier hs-var">deleteStuff</span></a></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912978"><span class="hs-identifier hs-var">addStuff</span></a></span><span>
</span><span id="line-250"></span><span>
</span><span id="line-251"></span><span>    </span><span id="local-6989586621680912478"><span class="annot"><a href="#local-6989586621680912919"><span class="hs-identifier hs-type">termUpdates</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Path</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621680912478"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Branch0</span></span><span> </span><span class="annot"><a href="#local-6989586621680912478"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-252"></span><span>    </span><span id="local-6989586621680912919"><span class="annot"><span class="annottext">termUpdates :: forall (m :: * -&gt; *). [(Path, Branch0 m -&gt; Branch0 m)]
</span><a href="#local-6989586621680912919"><span class="hs-identifier hs-var hs-var">termUpdates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-253"></span><span>      </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
</span><a href="#local-6989586621680912916"><span class="hs-identifier hs-var">tuf</span></a></span><span>
</span><span id="line-254"></span><span>        </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; (TypecheckedUnisonFile Symbol Ann
    -&gt; Map
         Symbol
         (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann, Type Symbol Ann))
-&gt; Map
     Symbol
     (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann, Type Symbol Ann)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile Symbol Ann
-&gt; Map
     Symbol
     (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann, Type Symbol Ann)
forall v a.
TypecheckedUnisonFile v a
-&gt; Map v (a, Id' Hash, Maybe FilePath, Term v a, Type v a)
</span><span class="hs-identifier hs-var">UF.hashTermsId</span></span><span>
</span><span id="line-255"></span><span>        </span><span class="annot"><span class="annottext">Map
  Symbol
  (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann, Type Symbol Ann)
-&gt; (Map
      Symbol
      (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann, Type Symbol Ann)
    -&gt; [(Symbol,
         (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann,
          Type Symbol Ann))])
-&gt; [(Symbol,
     (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann, Type Symbol Ann))]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map
  Symbol
  (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann, Type Symbol Ann)
-&gt; [(Symbol,
     (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann, Type Symbol Ann))]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span>
</span><span id="line-256"></span><span>        </span><span class="annot"><span class="annottext">[(Symbol,
  (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann, Type Symbol Ann))]
-&gt; ([(Symbol,
      (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann, Type Symbol Ann))]
    -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((Symbol,
  (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann, Type Symbol Ann))
 -&gt; [(Path, Branch0 m -&gt; Branch0 m)])
-&gt; [(Symbol,
     (Ann, Id' Hash, Maybe FilePath, Term Symbol Ann, Type Symbol Ann))]
-&gt; [(Path, Branch0 m -&gt; Branch0 m)]
forall m a. Monoid m =&gt; (a -&gt; m) -&gt; [a] -&gt; m
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680912982"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680912982"><span class="hs-identifier hs-var">var</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ann
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680912983"><span class="annot"><span class="annottext">Id' Hash
</span><a href="#local-6989586621680912983"><span class="hs-identifier hs-var">ref</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680912984"><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621680912984"><span class="hs-identifier hs-var">wk</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Term Symbol Ann
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type Symbol Ann
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-257"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Maybe FilePath -&gt; Bool
</span><span class="hs-identifier hs-var">WK.watchKindShouldBeStoredInDatabase</span></span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621680912984"><span class="hs-identifier hs-var">wk</span></a></span><span>
</span><span id="line-258"></span><span>            </span><span class="hs-keyword">then</span><span>
</span><span id="line-259"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680912986"><span class="annot"><span class="annottext">split :: Split
</span><a href="#local-6989586621680912986"><span class="hs-identifier hs-var hs-var">split</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Split
</span><a href="#local-6989586621680912965"><span class="hs-identifier hs-var">splitVar</span></a></span><span> </span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621680912982"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-260"></span><span>               </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Split -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall (m :: * -&gt; *). Split -&gt; (Path, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeAnnihilateTermName</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621680912986"><span class="hs-identifier hs-var">split</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-261"></span><span>                    </span><span class="annot"><span class="annottext">Split -&gt; Referent -&gt; (Path, Branch0 m -&gt; Branch0 m)
forall p (m :: * -&gt; *).
(p, NameSegment) -&gt; Referent -&gt; (p, Branch0 m -&gt; Branch0 m)
</span><span class="hs-identifier hs-var">BranchUtil.makeAddTermName</span></span><span> </span><span class="annot"><span class="annottext">Split
</span><a href="#local-6989586621680912986"><span class="hs-identifier hs-var">split</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id' Hash -&gt; Referent
</span><span class="hs-identifier hs-var">Referent.fromTermReferenceId</span></span><span> </span><span class="annot"><span class="annottext">Id' Hash
</span><a href="#local-6989586621680912983"><span class="hs-identifier hs-var">ref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>                  </span><span class="hs-special">]</span><span>
</span><span id="line-263"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span>    </span><span class="annot"><a href="#local-6989586621680912965"><span class="hs-identifier hs-type">splitVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Symbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Path.Split</span></span><span>
</span><span id="line-266"></span><span>    </span><span id="local-6989586621680912965"><span class="annot"><span class="annottext">splitVar :: Symbol -&gt; Split
</span><a href="#local-6989586621680912965"><span class="hs-identifier hs-var hs-var">splitVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Split
</span><span class="hs-identifier hs-var">Path.splitFromName</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Split) -&gt; (Symbol -&gt; Name) -&gt; Symbol -&gt; Split
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeParseVar</span></span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span class="hs-comment">-- | get references from `names` that have the same names as in `defns`</span><span>
</span><span id="line-269"></span><span class="hs-comment">-- For constructors, we get the type reference.</span><span>
</span><span id="line-270"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update2.html#getExistingReferencesNamed"><span class="hs-identifier hs-type">getExistingReferencesNamed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefnsF</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span>
</span><span id="line-271"></span><span id="getExistingReferencesNamed"><span class="annot"><span class="annottext">getExistingReferencesNamed :: DefnsF Set Name Name -&gt; Names -&gt; Set TypeReference
</span><a href="Unison.Codebase.Editor.HandleInput.Update2.html#getExistingReferencesNamed"><span class="hs-identifier hs-var hs-var">getExistingReferencesNamed</span></a></span></span><span> </span><span id="local-6989586621680912988"><span class="annot"><span class="annottext">DefnsF Set Name Name
</span><a href="#local-6989586621680912988"><span class="hs-identifier hs-var">defns</span></a></span></span><span> </span><span id="local-6989586621680912989"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680912989"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-272"></span><span>  </span><span class="annot"><span class="annottext">(Set Name -&gt; Set TypeReference)
-&gt; (Set Name -&gt; Set TypeReference)
-&gt; DefnsF Set Name Name
-&gt; Set TypeReference
forall m a b. Monoid m =&gt; (a -&gt; m) -&gt; (b -&gt; m) -&gt; Defns a b -&gt; m
forall (p :: * -&gt; * -&gt; *) m a b.
(Bifoldable p, Monoid m) =&gt;
(a -&gt; m) -&gt; (b -&gt; m) -&gt; p a b -&gt; m
</span><span class="hs-identifier hs-var">bifoldMap</span></span><span> </span><span class="annot"><span class="annottext">Set Name -&gt; Set TypeReference
</span><a href="#local-6989586621680912990"><span class="hs-identifier hs-var">fromTerms</span></a></span><span> </span><span class="annot"><span class="annottext">Set Name -&gt; Set TypeReference
</span><a href="#local-6989586621680912991"><span class="hs-identifier hs-var">fromTypes</span></a></span><span> </span><span class="annot"><span class="annottext">DefnsF Set Name Name
</span><a href="#local-6989586621680912988"><span class="hs-identifier hs-var">defns</span></a></span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><a href="#local-6989586621680912990"><span class="hs-identifier hs-type">fromTerms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Reference</span></span><span>
</span><span id="line-275"></span><span>    </span><span id="local-6989586621680912990"><span class="annot"><span class="annottext">fromTerms :: Set Name -&gt; Set TypeReference
</span><a href="#local-6989586621680912990"><span class="hs-identifier hs-var hs-var">fromTerms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><span class="annottext">(Name -&gt; Set TypeReference) -&gt; Set Name -&gt; Set TypeReference
forall m a. Monoid m =&gt; (a -&gt; m) -&gt; Set a -&gt; m
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680912992"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680912992"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-277"></span><span>        </span><span class="annot"><span class="annottext">(Referent -&gt; TypeReference) -&gt; Set Referent -&gt; Set TypeReference
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">Referent -&gt; TypeReference
</span><span class="hs-identifier hs-var">Referent.toReference</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Relation Name Referent -&gt; Set Referent
forall a b. Ord a =&gt; a -&gt; Relation a b -&gt; Set b
</span><span class="hs-identifier hs-var">Relation.lookupDom</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680912992"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Relation Name Referent
</span><span class="hs-identifier hs-var">Names.terms</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680912989"><span class="hs-identifier hs-var">names</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span>    </span><span class="annot"><a href="#local-6989586621680912991"><span class="hs-identifier hs-type">fromTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReference</span></span><span>
</span><span id="line-280"></span><span>    </span><span id="local-6989586621680912991"><span class="annot"><span class="annottext">fromTypes :: Set Name -&gt; Set TypeReference
</span><a href="#local-6989586621680912991"><span class="hs-identifier hs-var hs-var">fromTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-281"></span><span>      </span><span class="annot"><span class="annottext">(Name -&gt; Set TypeReference) -&gt; Set Name -&gt; Set TypeReference
forall m a. Monoid m =&gt; (a -&gt; m) -&gt; Set a -&gt; m
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680912996"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680912996"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><span class="annottext">Name -&gt; Relation Name TypeReference -&gt; Set TypeReference
forall a b. Ord a =&gt; a -&gt; Relation a b -&gt; Set b
</span><span class="hs-identifier hs-var">Relation.lookupDom</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621680912996"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Relation Name TypeReference
</span><span class="hs-identifier hs-var">Names.types</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680912989"><span class="hs-identifier hs-var">names</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span class="hs-comment">-- @getTermAndDeclNames file@ returns the names of the terms and decls defined in a typechecked Unison file.</span><span>
</span><span id="line-285"></span><span id="local-6989586621680912336"><span id="local-6989586621680912337"><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update2.html#getTermAndDeclNames"><span class="hs-identifier hs-type">getTermAndDeclNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Var</span></span><span> </span><span class="annot"><a href="#local-6989586621680912336"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypecheckedUnisonFile</span></span><span> </span><span class="annot"><a href="#local-6989586621680912336"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680912337"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DefnsF</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span></span></span><span>
</span><span id="line-286"></span><span id="getTermAndDeclNames"><span class="annot"><span class="annottext">getTermAndDeclNames :: forall v a.
Var v =&gt;
TypecheckedUnisonFile v a -&gt; DefnsF Set Name Name
</span><a href="Unison.Codebase.Editor.HandleInput.Update2.html#getTermAndDeclNames"><span class="hs-identifier hs-var hs-var">getTermAndDeclNames</span></a></span></span><span> </span><span id="local-6989586621680913019"><span class="annot"><span class="annottext">TypecheckedUnisonFile v a
</span><a href="#local-6989586621680913019"><span class="hs-identifier hs-var">tuf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-287"></span><span>  </span><span class="annot"><span class="annottext">Set Name -&gt; Set Name -&gt; DefnsF Set Name Name
forall terms types. terms -&gt; types -&gt; Defns terms types
</span><span class="hs-identifier hs-var">Defns</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Name
</span><a href="#local-6989586621680913021"><span class="hs-identifier hs-var">terms</span></a></span><span> </span><span class="annot"><span class="annottext">Set Name -&gt; Set Name -&gt; Set Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set Name
</span><a href="#local-6989586621680913022"><span class="hs-identifier hs-var">effectCtors</span></a></span><span> </span><span class="annot"><span class="annottext">Set Name -&gt; Set Name -&gt; Set Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set Name
</span><a href="#local-6989586621680913023"><span class="hs-identifier hs-var">dataCtors</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Name
</span><a href="#local-6989586621680913024"><span class="hs-identifier hs-var">effects</span></a></span><span> </span><span class="annot"><span class="annottext">Set Name -&gt; Set Name -&gt; Set Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set Name
</span><a href="#local-6989586621680913025"><span class="hs-identifier hs-var">datas</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-289"></span><span>    </span><span id="local-6989586621680913021"><span class="annot"><span class="annottext">terms :: Set Name
</span><a href="#local-6989586621680913021"><span class="hs-identifier hs-var hs-var">terms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-290"></span><span>      </span><span class="annot"><span class="annottext">TypecheckedUnisonFile v a
-&gt; Map v (a, Id' Hash, Maybe FilePath, Term v a, Type v a)
forall v a.
TypecheckedUnisonFile v a
-&gt; Map v (a, Id' Hash, Maybe FilePath, Term v a, Type v a)
</span><span class="hs-identifier hs-var">UF.hashTermsId</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile v a
</span><a href="#local-6989586621680913019"><span class="hs-identifier hs-var">tuf</span></a></span><span>
</span><span id="line-291"></span><span>        </span><span class="annot"><span class="annottext">Map v (a, Id' Hash, Maybe FilePath, Term v a, Type v a)
-&gt; (Map v (a, Id' Hash, Maybe FilePath, Term v a, Type v a)
    -&gt; Set Name)
-&gt; Set Name
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(v
 -&gt; (a, Id' Hash, Maybe FilePath, Term v a, Type v a) -&gt; Set Name)
-&gt; Map v (a, Id' Hash, Maybe FilePath, Term v a, Type v a)
-&gt; Set Name
forall m k a. Monoid m =&gt; (k -&gt; a -&gt; m) -&gt; Map k a -&gt; m
</span><span class="hs-identifier hs-var">Map.foldMapWithKey</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680913027"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680913027"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Id' Hash
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680913028"><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621680913028"><span class="hs-identifier hs-var">wk</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Term v a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type v a
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-292"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Maybe FilePath -&gt; Bool
</span><span class="hs-identifier hs-var">WK.watchKindShouldBeStoredInDatabase</span></span><span> </span><span class="annot"><span class="annottext">Maybe FilePath
</span><a href="#local-6989586621680913028"><span class="hs-identifier hs-var">wk</span></a></span><span>
</span><span id="line-293"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Set Name
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">Set.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">v -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeParseVar</span></span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621680913027"><span class="hs-identifier hs-var">var</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Set Name
forall a. Set a
</span><span class="hs-identifier hs-var">Set.empty</span></span><span>
</span><span id="line-295"></span><span>    </span><span id="local-6989586621680913024"><span class="annot"><span class="annottext">effects :: Set Name
</span><a href="#local-6989586621680913024"><span class="hs-identifier hs-var hs-var">effects</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map v (Id' Hash, EffectDeclaration v a) -&gt; Set Name
forall {a}. Map v a -&gt; Set Name
</span><a href="#local-6989586621680913031"><span class="hs-identifier hs-var">keysToNames</span></a></span><span> </span><span class="annot"><span class="annottext">(Map v (Id' Hash, EffectDeclaration v a) -&gt; Set Name)
-&gt; Map v (Id' Hash, EffectDeclaration v a) -&gt; Set Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile v a
-&gt; Map v (Id' Hash, EffectDeclaration v a)
forall v a.
TypecheckedUnisonFile v a
-&gt; Map v (Id' Hash, EffectDeclaration v a)
</span><span class="hs-identifier hs-var">UF.effectDeclarationsId'</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile v a
</span><a href="#local-6989586621680913019"><span class="hs-identifier hs-var">tuf</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span id="local-6989586621680913025"><span class="annot"><span class="annottext">datas :: Set Name
</span><a href="#local-6989586621680913025"><span class="hs-identifier hs-var hs-var">datas</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map v (Id' Hash, DataDeclaration v a) -&gt; Set Name
forall {a}. Map v a -&gt; Set Name
</span><a href="#local-6989586621680913031"><span class="hs-identifier hs-var">keysToNames</span></a></span><span> </span><span class="annot"><span class="annottext">(Map v (Id' Hash, DataDeclaration v a) -&gt; Set Name)
-&gt; Map v (Id' Hash, DataDeclaration v a) -&gt; Set Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile v a -&gt; Map v (Id' Hash, DataDeclaration v a)
forall v a.
TypecheckedUnisonFile v a -&gt; Map v (Id' Hash, DataDeclaration v a)
</span><span class="hs-identifier hs-var">UF.dataDeclarationsId'</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile v a
</span><a href="#local-6989586621680913019"><span class="hs-identifier hs-var">tuf</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span id="local-6989586621680913022"><span class="annot"><span class="annottext">effectCtors :: Set Name
</span><a href="#local-6989586621680913022"><span class="hs-identifier hs-var hs-var">effectCtors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DataDeclaration v a -&gt; Set Name)
-&gt; Map v (DataDeclaration v a) -&gt; Set Name
forall m a. Monoid m =&gt; (a -&gt; m) -&gt; Map v a -&gt; m
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration v a -&gt; Set Name
forall {a}. DataDeclaration v a -&gt; Set Name
</span><a href="#local-6989586621680913032"><span class="hs-identifier hs-var">ctorsToNames</span></a></span><span> </span><span class="annot"><span class="annottext">(Map v (DataDeclaration v a) -&gt; Set Name)
-&gt; Map v (DataDeclaration v a) -&gt; Set Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Id' Hash, EffectDeclaration v a) -&gt; DataDeclaration v a)
-&gt; Map v (Id' Hash, EffectDeclaration v a)
-&gt; Map v (DataDeclaration v a)
forall a b. (a -&gt; b) -&gt; Map v a -&gt; Map v b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EffectDeclaration v a -&gt; DataDeclaration v a
forall v a. EffectDeclaration v a -&gt; DataDeclaration v a
</span><span class="hs-identifier hs-var">Decl.toDataDecl</span></span><span> </span><span class="annot"><span class="annottext">(EffectDeclaration v a -&gt; DataDeclaration v a)
-&gt; ((Id' Hash, EffectDeclaration v a) -&gt; EffectDeclaration v a)
-&gt; (Id' Hash, EffectDeclaration v a)
-&gt; DataDeclaration v a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Id' Hash, EffectDeclaration v a) -&gt; EffectDeclaration v a
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map v (Id' Hash, EffectDeclaration v a)
 -&gt; Map v (DataDeclaration v a))
-&gt; Map v (Id' Hash, EffectDeclaration v a)
-&gt; Map v (DataDeclaration v a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile v a
-&gt; Map v (Id' Hash, EffectDeclaration v a)
forall v a.
TypecheckedUnisonFile v a
-&gt; Map v (Id' Hash, EffectDeclaration v a)
</span><span class="hs-identifier hs-var">UF.effectDeclarationsId'</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile v a
</span><a href="#local-6989586621680913019"><span class="hs-identifier hs-var">tuf</span></a></span><span>
</span><span id="line-298"></span><span>    </span><span id="local-6989586621680913023"><span class="annot"><span class="annottext">dataCtors :: Set Name
</span><a href="#local-6989586621680913023"><span class="hs-identifier hs-var hs-var">dataCtors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DataDeclaration v a -&gt; Set Name)
-&gt; Map v (DataDeclaration v a) -&gt; Set Name
forall m a. Monoid m =&gt; (a -&gt; m) -&gt; Map v a -&gt; m
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration v a -&gt; Set Name
forall {a}. DataDeclaration v a -&gt; Set Name
</span><a href="#local-6989586621680913032"><span class="hs-identifier hs-var">ctorsToNames</span></a></span><span> </span><span class="annot"><span class="annottext">(Map v (DataDeclaration v a) -&gt; Set Name)
-&gt; Map v (DataDeclaration v a) -&gt; Set Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Id' Hash, DataDeclaration v a) -&gt; DataDeclaration v a)
-&gt; Map v (Id' Hash, DataDeclaration v a)
-&gt; Map v (DataDeclaration v a)
forall a b. (a -&gt; b) -&gt; Map v a -&gt; Map v b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Id' Hash, DataDeclaration v a) -&gt; DataDeclaration v a
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(Map v (Id' Hash, DataDeclaration v a)
 -&gt; Map v (DataDeclaration v a))
-&gt; Map v (Id' Hash, DataDeclaration v a)
-&gt; Map v (DataDeclaration v a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile v a -&gt; Map v (Id' Hash, DataDeclaration v a)
forall v a.
TypecheckedUnisonFile v a -&gt; Map v (Id' Hash, DataDeclaration v a)
</span><span class="hs-identifier hs-var">UF.dataDeclarationsId'</span></span><span> </span><span class="annot"><span class="annottext">TypecheckedUnisonFile v a
</span><a href="#local-6989586621680913019"><span class="hs-identifier hs-var">tuf</span></a></span><span>
</span><span id="line-299"></span><span>    </span><span id="local-6989586621680913031"><span class="annot"><span class="annottext">keysToNames :: Map v a -&gt; Set Name
</span><a href="#local-6989586621680913031"><span class="hs-identifier hs-var hs-var">keysToNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(v -&gt; Name) -&gt; Set v -&gt; Set Name
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">Set.map</span></span><span> </span><span class="annot"><span class="annottext">v -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeParseVar</span></span><span> </span><span class="annot"><span class="annottext">(Set v -&gt; Set Name) -&gt; (Map v a -&gt; Set v) -&gt; Map v a -&gt; Set Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map v a -&gt; Set v
forall k a. Map k a -&gt; Set k
</span><span class="hs-identifier hs-var">Map.keysSet</span></span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621680913032"><span class="annot"><span class="annottext">ctorsToNames :: DataDeclaration v a -&gt; Set Name
</span><a href="#local-6989586621680913032"><span class="hs-identifier hs-var hs-var">ctorsToNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; Set Name
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">Set.fromList</span></span><span> </span><span class="annot"><span class="annottext">([Name] -&gt; Set Name)
-&gt; (DataDeclaration v a -&gt; [Name])
-&gt; DataDeclaration v a
-&gt; Set Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(v -&gt; Name) -&gt; [v] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">v -&gt; Name
forall v. Var v =&gt; v -&gt; Name
</span><span class="hs-identifier hs-var">Name.unsafeParseVar</span></span><span> </span><span class="annot"><span class="annottext">([v] -&gt; [Name])
-&gt; (DataDeclaration v a -&gt; [v]) -&gt; DataDeclaration v a -&gt; [Name]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DataDeclaration v a -&gt; [v]
forall v a. DataDeclaration v a -&gt; [v]
</span><span class="hs-identifier hs-var">Decl.constructorVars</span></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-comment">-- The big picture behind PPE building, though there are many details:</span><span>
</span><span id="line-303"></span><span class="hs-comment">--</span><span>
</span><span id="line-304"></span><span class="hs-comment">--   * We are updating old references to new references by rendering old references as names that are then parsed</span><span>
</span><span id="line-305"></span><span class="hs-comment">--     back to resolve to new references (the world's weirdest implementation of AST substitution).</span><span>
</span><span id="line-306"></span><span class="hs-comment">--</span><span>
</span><span id="line-307"></span><span class="hs-comment">--   * We have to render names that refer to definitions in the file with a different suffixification strategy</span><span>
</span><span id="line-308"></span><span class="hs-comment">--     (namely, &quot;suffixify by name&quot;) than names that refer to things in the codebase.</span><span>
</span><span id="line-309"></span><span class="hs-comment">--</span><span>
</span><span id="line-310"></span><span class="hs-comment">--     This is because you *may* refer to aliases that share a suffix by that suffix for definitions in the</span><span>
</span><span id="line-311"></span><span class="hs-comment">--     codebase, but not in the file.</span><span>
</span><span id="line-312"></span><span class="hs-comment">--</span><span>
</span><span id="line-313"></span><span class="hs-comment">--     For example, the following file will fail to parse:</span><span>
</span><span id="line-314"></span><span class="hs-comment">--</span><span>
</span><span id="line-315"></span><span class="hs-comment">--       one.foo = 10</span><span>
</span><span id="line-316"></span><span class="hs-comment">--       two.foo = 10</span><span>
</span><span id="line-317"></span><span class="hs-comment">--       hey = foo + foo -- &quot;Which foo do you mean? There are two.&quot;</span><span>
</span><span id="line-318"></span><span class="hs-comment">--</span><span>
</span><span id="line-319"></span><span class="hs-comment">--     However, the following file will not fail to parse, if `one.foo` and `two.foo` are aliases in the codebase:</span><span>
</span><span id="line-320"></span><span class="hs-comment">--</span><span>
</span><span id="line-321"></span><span class="hs-comment">--       hey = foo + foo</span><span>
</span><span id="line-322"></span><span class="annot"><a href="Unison.Codebase.Editor.HandleInput.Update2.html#makePPE"><span class="hs-identifier hs-type">makePPE</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-323"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-324"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-325"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Names</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-326"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">DefnsF</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Name</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermReferenceId</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeReferenceId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-327"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">PrettyPrintEnvDecl</span></span><span>
</span><span id="line-328"></span><span id="makePPE"><span class="annot"><span class="annottext">makePPE :: Int
-&gt; Names
-&gt; Names
-&gt; DefnsF (Map Name) (Id' Hash) (Id' Hash)
-&gt; PrettyPrintEnvDecl
</span><a href="Unison.Codebase.Editor.HandleInput.Update2.html#makePPE"><span class="hs-identifier hs-var hs-var">makePPE</span></a></span></span><span> </span><span id="local-6989586621680913048"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680913048"><span class="hs-identifier hs-var">hashLen</span></a></span></span><span> </span><span id="local-6989586621680913049"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680913049"><span class="hs-identifier hs-var">namespaceNames</span></a></span></span><span> </span><span id="local-6989586621680913050"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680913050"><span class="hs-identifier hs-var">initialFileNames</span></a></span></span><span> </span><span id="local-6989586621680913051"><span class="annot"><span class="annottext">DefnsF (Map Name) (Id' Hash) (Id' Hash)
</span><a href="#local-6989586621680913051"><span class="hs-identifier hs-var">dependents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-329"></span><span>  </span><span class="annot"><span class="annottext">PrettyPrintEnvDecl -&gt; PrettyPrintEnvDecl -&gt; PrettyPrintEnvDecl
</span><span class="hs-identifier hs-var">PPED.addFallback</span></span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680913053"><span class="annot"><span class="annottext">names :: Names
</span><a href="#local-6989586621680913053"><span class="hs-identifier hs-var hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680913050"><span class="hs-identifier hs-var">initialFileNames</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">DefnsF (Map Name) (Id' Hash) (Id' Hash) -&gt; Names
</span><span class="hs-identifier hs-var">Names.fromUnconflictedReferenceIds</span></span><span> </span><span class="annot"><span class="annottext">DefnsF (Map Name) (Id' Hash) (Id' Hash)
</span><a href="#local-6989586621680913051"><span class="hs-identifier hs-var">dependents</span></a></span><span>
</span><span id="line-331"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Namer -&gt; Suffixifier -&gt; PrettyPrintEnvDecl
</span><span class="hs-identifier hs-var">PPED.makePPED</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Namer
</span><span class="hs-identifier hs-var">PPE.namer</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680913053"><span class="hs-identifier hs-var">names</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Suffixifier
</span><span class="hs-identifier hs-var">PPE.suffixifyByName</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><span class="hs-identifier hs-var">Names.shadowing</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680913053"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680913049"><span class="hs-identifier hs-var">namespaceNames</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Namer -&gt; Suffixifier -&gt; PrettyPrintEnvDecl
</span><span class="hs-identifier hs-var">PPED.makePPED</span></span><span>
</span><span id="line-334"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Names -&gt; Namer
</span><span class="hs-identifier hs-var">PPE.hqNamer</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680913048"><span class="hs-identifier hs-var">hashLen</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680913049"><span class="hs-identifier hs-var">namespaceNames</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-335"></span><span>        </span><span class="hs-comment">-- We don't want to over-suffixify for a reference in the namespace. For example, say we have &quot;foo.bar&quot; in the</span><span>
</span><span id="line-336"></span><span>        </span><span class="hs-comment">-- namespace and &quot;oink.bar&quot; in the file. &quot;bar&quot; may be a unique suffix among the namespace names, but would be</span><span>
</span><span id="line-337"></span><span>        </span><span class="hs-comment">-- ambiguous in the context of namespace + file names.</span><span>
</span><span id="line-338"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-339"></span><span>        </span><span class="hs-comment">-- So, we use `shadowing`, which starts with the LHS names (the namespace), and adds to it names from the</span><span>
</span><span id="line-340"></span><span>        </span><span class="hs-comment">-- RHS (the initial file names, i.e. what was originally saved) that don't already exist in the LHS.</span><span>
</span><span id="line-341"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Suffixifier
</span><span class="hs-identifier hs-var">PPE.suffixifyByHash</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
</span><span class="hs-identifier hs-var">Names.shadowing</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680913049"><span class="hs-identifier hs-var">namespaceNames</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621680913050"><span class="hs-identifier hs-var">initialFileNames</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-343"></span></pre></body></html>