<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.HTTP2.H2.Context</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Control</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.HTTP.Types</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Method</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Socket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SockAddr</span></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO.Exception</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO.STM</span></span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Imports.html"><span class="hs-identifier">Imports</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">insert</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HPACK.html"><span class="hs-identifier">Network.HPACK</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.html"><span class="hs-identifier">Network.HTTP2.Frame</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Settings.html"><span class="hs-identifier">Network.HTTP2.H2.Settings</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Stream.html"><span class="hs-identifier">Network.HTTP2.H2.Stream</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.StreamTable.html"><span class="hs-identifier">Network.HTTP2.H2.StreamTable</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html"><span class="hs-identifier">Network.HTTP2.H2.Types</span></a></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">data</span><span> </span><span id="Role"><span class="annot"><a href="Network.HTTP2.H2.Context.html#Role"><span class="hs-identifier hs-var">Role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Client"><span class="annot"><a href="Network.HTTP2.H2.Context.html#Client"><span class="hs-identifier hs-var">Client</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Server"><span class="annot"><a href="Network.HTTP2.H2.Context.html#Server"><span class="hs-identifier hs-var">Server</span></a></span></span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679116875"><span id="local-6989586621679116877"><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
(Role -&gt; Role -&gt; Bool) -&gt; (Role -&gt; Role -&gt; Bool) -&gt; Eq Role
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: Role -&gt; Role -&gt; Bool
== :: Role -&gt; Role -&gt; Bool
$c/= :: Role -&gt; Role -&gt; Bool
/= :: Role -&gt; Role -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679116881"><span id="local-6989586621679116883"><span id="local-6989586621679116887"><span class="annot"><span class="annottext">Int -&gt; Role -&gt; ShowS
[Role] -&gt; ShowS
Role -&gt; String
(Int -&gt; Role -&gt; ShowS)
-&gt; (Role -&gt; String) -&gt; ([Role] -&gt; ShowS) -&gt; Show Role
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Int -&gt; Role -&gt; ShowS
showsPrec :: Int -&gt; Role -&gt; ShowS
$cshow :: Role -&gt; String
show :: Role -&gt; String
$cshowList :: [Role] -&gt; ShowS
showList :: [Role] -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-keyword">data</span><span> </span><span id="RoleInfo"><span class="annot"><a href="Network.HTTP2.H2.Context.html#RoleInfo"><span class="hs-identifier hs-var">RoleInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RIS"><span class="annot"><a href="Network.HTTP2.H2.Context.html#RIS"><span class="hs-identifier hs-var">RIS</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#ServerInfo"><span class="hs-identifier hs-type">ServerInfo</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="RIC"><span class="annot"><a href="Network.HTTP2.H2.Context.html#RIC"><span class="hs-identifier hs-var">RIC</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#ClientInfo"><span class="hs-identifier hs-type">ClientInfo</span></a></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">data</span><span> </span><span id="ServerInfo"><span class="annot"><a href="Network.HTTP2.H2.Context.html#ServerInfo"><span class="hs-identifier hs-var">ServerInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ServerInfo"><span class="annot"><a href="Network.HTTP2.H2.Context.html#ServerInfo"><span class="hs-identifier hs-var">ServerInfo</span></a></span></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="inputQ"><span class="annot"><span class="annottext">ServerInfo -&gt; TQueue (Input Stream)
</span><a href="Network.HTTP2.H2.Context.html#inputQ"><span class="hs-identifier hs-var hs-var">inputQ</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Input"><span class="hs-identifier hs-type">Input</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">data</span><span> </span><span id="ClientInfo"><span class="annot"><a href="Network.HTTP2.H2.Context.html#ClientInfo"><span class="hs-identifier hs-var">ClientInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ClientInfo"><span class="annot"><a href="Network.HTTP2.H2.Context.html#ClientInfo"><span class="hs-identifier hs-var">ClientInfo</span></a></span></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="scheme"><span class="annot"><span class="annottext">ClientInfo -&gt; ByteString
</span><a href="Network.HTTP2.H2.Context.html#scheme"><span class="hs-identifier hs-var hs-var">scheme</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="authority"><span class="annot"><span class="annottext">ClientInfo -&gt; ByteString
</span><a href="Network.HTTP2.H2.Context.html#authority"><span class="hs-identifier hs-var hs-var">authority</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#toServerInfo"><span class="hs-identifier hs-type">toServerInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#RoleInfo"><span class="hs-identifier hs-type">RoleInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#ServerInfo"><span class="hs-identifier hs-type">ServerInfo</span></a></span><span>
</span><span id="line-39"></span><span id="toServerInfo"><span class="annot"><span class="annottext">toServerInfo :: RoleInfo -&gt; ServerInfo
</span><a href="Network.HTTP2.H2.Context.html#toServerInfo"><span class="hs-identifier hs-var hs-var">toServerInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Context.html#RIS"><span class="hs-identifier hs-type">RIS</span></a></span><span> </span><span id="local-6989586621679116898"><span class="annot"><span class="annottext">ServerInfo
</span><a href="#local-6989586621679116898"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerInfo
</span><a href="#local-6989586621679116898"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-40"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#toServerInfo"><span class="hs-identifier hs-var">toServerInfo</span></a></span><span> </span><span class="annot"><span class="annottext">RoleInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; ServerInfo
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;toServerInfo&quot;</span></span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#toClientInfo"><span class="hs-identifier hs-type">toClientInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#RoleInfo"><span class="hs-identifier hs-type">RoleInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#ClientInfo"><span class="hs-identifier hs-type">ClientInfo</span></a></span><span>
</span><span id="line-43"></span><span id="toClientInfo"><span class="annot"><span class="annottext">toClientInfo :: RoleInfo -&gt; ClientInfo
</span><a href="Network.HTTP2.H2.Context.html#toClientInfo"><span class="hs-identifier hs-var hs-var">toClientInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Context.html#RIC"><span class="hs-identifier hs-type">RIC</span></a></span><span> </span><span id="local-6989586621679116901"><span class="annot"><span class="annottext">ClientInfo
</span><a href="#local-6989586621679116901"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClientInfo
</span><a href="#local-6989586621679116901"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-44"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#toClientInfo"><span class="hs-identifier hs-var">toClientInfo</span></a></span><span> </span><span class="annot"><span class="annottext">RoleInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; ClientInfo
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;toClientInfo&quot;</span></span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#newServerInfo"><span class="hs-identifier hs-type">newServerInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#RoleInfo"><span class="hs-identifier hs-type">RoleInfo</span></a></span><span>
</span><span id="line-47"></span><span id="newServerInfo"><span class="annot"><span class="annottext">newServerInfo :: IO RoleInfo
</span><a href="Network.HTTP2.H2.Context.html#newServerInfo"><span class="hs-identifier hs-var hs-var">newServerInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerInfo -&gt; RoleInfo
</span><a href="Network.HTTP2.H2.Context.html#RIS"><span class="hs-identifier hs-var">RIS</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerInfo -&gt; RoleInfo)
-&gt; (TQueue (Input Stream) -&gt; ServerInfo)
-&gt; TQueue (Input Stream)
-&gt; RoleInfo
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Input Stream) -&gt; ServerInfo
</span><a href="Network.HTTP2.H2.Context.html#ServerInfo"><span class="hs-identifier hs-var">ServerInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(TQueue (Input Stream) -&gt; RoleInfo)
-&gt; IO (TQueue (Input Stream)) -&gt; IO RoleInfo
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO (TQueue (Input Stream))
forall (m :: * -&gt; *) a. MonadIO m =&gt; m (TQueue a)
</span><span class="hs-identifier hs-var">newTQueueIO</span></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#newClientInfo"><span class="hs-identifier hs-type">newClientInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#RoleInfo"><span class="hs-identifier hs-type">RoleInfo</span></a></span><span>
</span><span id="line-50"></span><span id="newClientInfo"><span class="annot"><span class="annottext">newClientInfo :: ByteString -&gt; ByteString -&gt; RoleInfo
</span><a href="Network.HTTP2.H2.Context.html#newClientInfo"><span class="hs-identifier hs-var hs-var">newClientInfo</span></a></span></span><span> </span><span id="local-6989586621679116907"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679116907"><span class="hs-identifier hs-var">scm</span></a></span></span><span> </span><span id="local-6989586621679116908"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679116908"><span class="hs-identifier hs-var">auth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClientInfo -&gt; RoleInfo
</span><a href="Network.HTTP2.H2.Context.html#RIC"><span class="hs-identifier hs-var">RIC</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientInfo -&gt; RoleInfo) -&gt; ClientInfo -&gt; RoleInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ClientInfo
</span><a href="Network.HTTP2.H2.Context.html#ClientInfo"><span class="hs-identifier hs-var">ClientInfo</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679116907"><span class="hs-identifier hs-var">scm</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679116908"><span class="hs-identifier hs-var">auth</span></a></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="annot"><span class="hs-comment">-- | The context for HTTP/2 connection.</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">data</span><span> </span><span id="Context"><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-var">Context</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Context"><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-var">Context</span></a></span></span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="role"><span class="annot"><span class="annottext">Context -&gt; Role
</span><a href="Network.HTTP2.H2.Context.html#role"><span class="hs-keyword hs-var hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="roleInfo"><span class="annot"><span class="annottext">Context -&gt; RoleInfo
</span><a href="Network.HTTP2.H2.Context.html#roleInfo"><span class="hs-identifier hs-var hs-var">roleInfo</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#RoleInfo"><span class="hs-identifier hs-type">RoleInfo</span></a></span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- Settings</span><span>
</span><span id="line-59"></span><span>      </span><span id="mySettings"><span class="annot"><span class="annottext">Context -&gt; Settings
</span><a href="Network.HTTP2.H2.Context.html#mySettings"><span class="hs-identifier hs-var hs-var">mySettings</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Settings.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="myFirstSettings"><span class="annot"><span class="annottext">Context -&gt; IORef Bool
</span><a href="Network.HTTP2.H2.Context.html#myFirstSettings"><span class="hs-identifier hs-var hs-var">myFirstSettings</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="peerSettings"><span class="annot"><span class="annottext">Context -&gt; IORef Settings
</span><a href="Network.HTTP2.H2.Context.html#peerSettings"><span class="hs-identifier hs-var hs-var">peerSettings</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Settings.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span>
</span><span id="line-62"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="oddStreamTable"><span class="annot"><span class="annottext">Context -&gt; TVar OddStreamTable
</span><a href="Network.HTTP2.H2.Context.html#oddStreamTable"><span class="hs-identifier hs-var hs-var">oddStreamTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.StreamTable.html#OddStreamTable"><span class="hs-identifier hs-type">OddStreamTable</span></a></span><span>
</span><span id="line-63"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="evenStreamTable"><span class="annot"><span class="annottext">Context -&gt; TVar EvenStreamTable
</span><a href="Network.HTTP2.H2.Context.html#evenStreamTable"><span class="hs-identifier hs-var hs-var">evenStreamTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.StreamTable.html#EvenStreamTable"><span class="hs-identifier hs-type">EvenStreamTable</span></a></span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="continued"><span class="annot"><span class="annottext">Context -&gt; IORef (Maybe Int)
</span><a href="Network.HTTP2.H2.Context.html#continued"><span class="hs-identifier hs-var hs-var">continued</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>    </span><span class="hs-comment">-- ^ RFC 9113 says &quot;Other frames (from any stream) MUST NOT</span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-comment">--   occur between the HEADERS frame and any CONTINUATION</span><span>
</span><span id="line-67"></span><span>    </span><span class="hs-comment">--   frames that might follow&quot;. This field is used to implement</span><span>
</span><span id="line-68"></span><span>    </span><span class="hs-comment">--   this requirement.</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="myStreamId"><span class="annot"><span class="annottext">Context -&gt; TVar Int
</span><a href="Network.HTTP2.H2.Context.html#myStreamId"><span class="hs-identifier hs-var hs-var">myStreamId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="peerStreamId"><span class="annot"><span class="annottext">Context -&gt; IORef Int
</span><a href="Network.HTTP2.H2.Context.html#peerStreamId"><span class="hs-identifier hs-var hs-var">peerStreamId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="outputBufferLimit"><span class="annot"><span class="annottext">Context -&gt; IORef Int
</span><a href="Network.HTTP2.H2.Context.html#outputBufferLimit"><span class="hs-identifier hs-var hs-var">outputBufferLimit</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="outputQ"><span class="annot"><span class="annottext">Context -&gt; TQueue (Output Stream)
</span><a href="Network.HTTP2.H2.Context.html#outputQ"><span class="hs-identifier hs-var hs-var">outputQ</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Output"><span class="hs-identifier hs-type">Output</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="outputQStreamID"><span class="annot"><span class="annottext">Context -&gt; TVar Int
</span><a href="Network.HTTP2.H2.Context.html#outputQStreamID"><span class="hs-identifier hs-var hs-var">outputQStreamID</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="controlQ"><span class="annot"><span class="annottext">Context -&gt; TQueue Control
</span><a href="Network.HTTP2.H2.Context.html#controlQ"><span class="hs-identifier hs-var hs-var">controlQ</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TQueue</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Control"><span class="hs-identifier hs-type">Control</span></a></span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="encodeDynamicTable"><span class="annot"><span class="annottext">Context -&gt; DynamicTable
</span><a href="Network.HTTP2.H2.Context.html#encodeDynamicTable"><span class="hs-identifier hs-var hs-var">encodeDynamicTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HPACK.Table.Dynamic.html#DynamicTable"><span class="hs-identifier hs-type">DynamicTable</span></a></span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="decodeDynamicTable"><span class="annot"><span class="annottext">Context -&gt; DynamicTable
</span><a href="Network.HTTP2.H2.Context.html#decodeDynamicTable"><span class="hs-identifier hs-var hs-var">decodeDynamicTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HPACK.Table.Dynamic.html#DynamicTable"><span class="hs-identifier hs-type">DynamicTable</span></a></span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-comment">-- the connection window for sending data</span><span>
</span><span id="line-78"></span><span>      </span><span id="txFlow"><span class="annot"><span class="annottext">Context -&gt; TVar TxFlow
</span><a href="Network.HTTP2.H2.Context.html#txFlow"><span class="hs-identifier hs-var hs-var">txFlow</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TxFlow</span></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="rxFlow"><span class="annot"><span class="annottext">Context -&gt; IORef RxFlow
</span><a href="Network.HTTP2.H2.Context.html#rxFlow"><span class="hs-identifier hs-var hs-var">rxFlow</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">RxFlow</span></span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="pingRate"><span class="annot"><span class="annottext">Context -&gt; Rate
</span><a href="Network.HTTP2.H2.Context.html#pingRate"><span class="hs-identifier hs-var hs-var">pingRate</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rate</span></span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="settingsRate"><span class="annot"><span class="annottext">Context -&gt; Rate
</span><a href="Network.HTTP2.H2.Context.html#settingsRate"><span class="hs-identifier hs-var hs-var">settingsRate</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rate</span></span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="emptyFrameRate"><span class="annot"><span class="annottext">Context -&gt; Rate
</span><a href="Network.HTTP2.H2.Context.html#emptyFrameRate"><span class="hs-identifier hs-var hs-var">emptyFrameRate</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rate</span></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="rstRate"><span class="annot"><span class="annottext">Context -&gt; Rate
</span><a href="Network.HTTP2.H2.Context.html#rstRate"><span class="hs-identifier hs-var hs-var">rstRate</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Rate</span></span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="mySockAddr"><span class="annot"><span class="annottext">Context -&gt; SockAddr
</span><a href="Network.HTTP2.H2.Context.html#mySockAddr"><span class="hs-identifier hs-var hs-var">mySockAddr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SockAddr</span></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="peerSockAddr"><span class="annot"><span class="annottext">Context -&gt; SockAddr
</span><a href="Network.HTTP2.H2.Context.html#peerSockAddr"><span class="hs-identifier hs-var hs-var">peerSockAddr</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SockAddr</span></span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#newContext"><span class="hs-identifier hs-type">newContext</span></a></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#RoleInfo"><span class="hs-identifier hs-type">RoleInfo</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Settings.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-97"></span><span id="newContext"><span class="annot"><span class="annottext">newContext :: RoleInfo -&gt; Config -&gt; Int -&gt; Int -&gt; Settings -&gt; IO Context
</span><a href="Network.HTTP2.H2.Context.html#newContext"><span class="hs-identifier hs-var hs-var">newContext</span></a></span></span><span> </span><span id="local-6989586621679116936"><span class="annot"><span class="annottext">RoleInfo
</span><a href="#local-6989586621679116936"><span class="hs-identifier hs-var">rinfo</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span class="hs-special">{</span><span id="local-6989586621679116938"><span id="local-6989586621679116939"><span id="local-6989586621679116940"><span id="local-6989586621679116941"><span id="local-6989586621679116942"><span id="local-6989586621679116943"><span id="local-6989586621679116944"><span id="local-6989586621679116945"><span class="annot"><span class="annottext">Int
Buffer
Manager
SockAddr
Int -&gt; IO ByteString
PositionReadMaker
ByteString -&gt; IO ()
confWriteBuffer :: Buffer
confBufferSize :: Int
confSendAll :: ByteString -&gt; IO ()
confReadN :: Int -&gt; IO ByteString
confPositionReadMaker :: PositionReadMaker
confTimeoutManager :: Manager
confMySockAddr :: SockAddr
confPeerSockAddr :: SockAddr
confWriteBuffer :: Config -&gt; Buffer
confBufferSize :: Config -&gt; Int
confSendAll :: Config -&gt; ByteString -&gt; IO ()
confReadN :: Config -&gt; Int -&gt; IO ByteString
confPositionReadMaker :: Config -&gt; PositionReadMaker
confTimeoutManager :: Config -&gt; Manager
confMySockAddr :: Config -&gt; SockAddr
confPeerSockAddr :: Config -&gt; SockAddr
</span><a href="#local-6989586621679116938"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679116954"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116954"><span class="hs-identifier hs-var">cacheSiz</span></a></span></span><span> </span><span id="local-6989586621679116955"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116955"><span class="hs-identifier hs-var">connRxWS</span></a></span></span><span> </span><span id="local-6989586621679116956"><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679116956"><span class="hs-identifier hs-var">settings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-comment">-- My: Use this even if ack has not been received yet.</span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><span class="annottext">Role
-&gt; RoleInfo
-&gt; Settings
-&gt; IORef Bool
-&gt; IORef Settings
-&gt; TVar OddStreamTable
-&gt; TVar EvenStreamTable
-&gt; IORef (Maybe Int)
-&gt; TVar Int
-&gt; IORef Int
-&gt; IORef Int
-&gt; TQueue (Output Stream)
-&gt; TVar Int
-&gt; TQueue Control
-&gt; DynamicTable
-&gt; DynamicTable
-&gt; TVar TxFlow
-&gt; IORef RxFlow
-&gt; Rate
-&gt; Rate
-&gt; Rate
-&gt; Rate
-&gt; SockAddr
-&gt; SockAddr
-&gt; Context
</span><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-var">Context</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621679116957"><span class="hs-identifier hs-var">rl</span></a></span><span> </span><span class="annot"><span class="annottext">RoleInfo
</span><a href="#local-6989586621679116936"><span class="hs-identifier hs-var">rinfo</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679116956"><span class="hs-identifier hs-var">settings</span></a></span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="annottext">(IORef Bool
 -&gt; IORef Settings
 -&gt; TVar OddStreamTable
 -&gt; TVar EvenStreamTable
 -&gt; IORef (Maybe Int)
 -&gt; TVar Int
 -&gt; IORef Int
 -&gt; IORef Int
 -&gt; TQueue (Output Stream)
 -&gt; TVar Int
 -&gt; TQueue Control
 -&gt; DynamicTable
 -&gt; DynamicTable
 -&gt; TVar TxFlow
 -&gt; IORef RxFlow
 -&gt; Rate
 -&gt; Rate
 -&gt; Rate
 -&gt; Rate
 -&gt; SockAddr
 -&gt; SockAddr
 -&gt; Context)
-&gt; IO (IORef Bool)
-&gt; IO
     (IORef Settings
      -&gt; TVar OddStreamTable
      -&gt; TVar EvenStreamTable
      -&gt; IORef (Maybe Int)
      -&gt; TVar Int
      -&gt; IORef Int
      -&gt; IORef Int
      -&gt; TQueue (Output Stream)
      -&gt; TVar Int
      -&gt; TQueue Control
      -&gt; DynamicTable
      -&gt; DynamicTable
      -&gt; TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (IORef Bool)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-101"></span><span>        </span><span class="hs-comment">-- Peer: The spec defines max concurrency is infinite unless</span><span>
</span><span id="line-102"></span><span>        </span><span class="hs-comment">-- SETTINGS_MAX_CONCURRENT_STREAMS is exchanged.</span><span>
</span><span id="line-103"></span><span>        </span><span class="hs-comment">-- But it is vulnerable, so we set the limitations.</span><span>
</span><span id="line-104"></span><span>        </span><span class="annot"><span class="annottext">IO
  (IORef Settings
   -&gt; TVar OddStreamTable
   -&gt; TVar EvenStreamTable
   -&gt; IORef (Maybe Int)
   -&gt; TVar Int
   -&gt; IORef Int
   -&gt; IORef Int
   -&gt; TQueue (Output Stream)
   -&gt; TVar Int
   -&gt; TQueue Control
   -&gt; DynamicTable
   -&gt; DynamicTable
   -&gt; TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO (IORef Settings)
-&gt; IO
     (TVar OddStreamTable
      -&gt; TVar EvenStreamTable
      -&gt; IORef (Maybe Int)
      -&gt; TVar Int
      -&gt; IORef Int
      -&gt; IORef Int
      -&gt; TQueue (Output Stream)
      -&gt; TVar Int
      -&gt; TQueue Control
      -&gt; DynamicTable
      -&gt; DynamicTable
      -&gt; TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Settings -&gt; IO (IORef Settings)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679116956"><span class="hs-identifier hs-var">settings</span></a></span><span>
</span><span id="line-105"></span><span>        </span><span class="annot"><span class="annottext">IO
  (TVar OddStreamTable
   -&gt; TVar EvenStreamTable
   -&gt; IORef (Maybe Int)
   -&gt; TVar Int
   -&gt; IORef Int
   -&gt; IORef Int
   -&gt; TQueue (Output Stream)
   -&gt; TVar Int
   -&gt; TQueue Control
   -&gt; DynamicTable
   -&gt; DynamicTable
   -&gt; TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO (TVar OddStreamTable)
-&gt; IO
     (TVar EvenStreamTable
      -&gt; IORef (Maybe Int)
      -&gt; TVar Int
      -&gt; IORef Int
      -&gt; IORef Int
      -&gt; TQueue (Output Stream)
      -&gt; TVar Int
      -&gt; TQueue Control
      -&gt; DynamicTable
      -&gt; DynamicTable
      -&gt; TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">OddStreamTable -&gt; IO (TVar OddStreamTable)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">OddStreamTable
</span><a href="Network.HTTP2.H2.StreamTable.html#emptyOddStreamTable"><span class="hs-identifier hs-var">emptyOddStreamTable</span></a></span><span>
</span><span id="line-106"></span><span>        </span><span class="annot"><span class="annottext">IO
  (TVar EvenStreamTable
   -&gt; IORef (Maybe Int)
   -&gt; TVar Int
   -&gt; IORef Int
   -&gt; IORef Int
   -&gt; TQueue (Output Stream)
   -&gt; TVar Int
   -&gt; TQueue Control
   -&gt; DynamicTable
   -&gt; DynamicTable
   -&gt; TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO (TVar EvenStreamTable)
-&gt; IO
     (IORef (Maybe Int)
      -&gt; TVar Int
      -&gt; IORef Int
      -&gt; IORef Int
      -&gt; TQueue (Output Stream)
      -&gt; TVar Int
      -&gt; TQueue Control
      -&gt; DynamicTable
      -&gt; DynamicTable
      -&gt; TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">EvenStreamTable -&gt; IO (TVar EvenStreamTable)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; EvenStreamTable
</span><a href="Network.HTTP2.H2.StreamTable.html#emptyEvenStreamTable"><span class="hs-identifier hs-var">emptyEvenStreamTable</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116954"><span class="hs-identifier hs-var">cacheSiz</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>        </span><span class="annot"><span class="annottext">IO
  (IORef (Maybe Int)
   -&gt; TVar Int
   -&gt; IORef Int
   -&gt; IORef Int
   -&gt; TQueue (Output Stream)
   -&gt; TVar Int
   -&gt; TQueue Control
   -&gt; DynamicTable
   -&gt; DynamicTable
   -&gt; TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO (IORef (Maybe Int))
-&gt; IO
     (TVar Int
      -&gt; IORef Int
      -&gt; IORef Int
      -&gt; TQueue (Output Stream)
      -&gt; TVar Int
      -&gt; TQueue Control
      -&gt; DynamicTable
      -&gt; DynamicTable
      -&gt; TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int -&gt; IO (IORef (Maybe Int))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Maybe Int
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-108"></span><span>        </span><span class="annot"><span class="annottext">IO
  (TVar Int
   -&gt; IORef Int
   -&gt; IORef Int
   -&gt; TQueue (Output Stream)
   -&gt; TVar Int
   -&gt; TQueue Control
   -&gt; DynamicTable
   -&gt; DynamicTable
   -&gt; TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO (TVar Int)
-&gt; IO
     (IORef Int
      -&gt; IORef Int
      -&gt; TQueue (Output Stream)
      -&gt; TVar Int
      -&gt; TQueue Control
      -&gt; DynamicTable
      -&gt; DynamicTable
      -&gt; TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (TVar Int)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116962"><span class="hs-identifier hs-var">sid0</span></a></span><span>
</span><span id="line-109"></span><span>        </span><span class="annot"><span class="annottext">IO
  (IORef Int
   -&gt; IORef Int
   -&gt; TQueue (Output Stream)
   -&gt; TVar Int
   -&gt; TQueue Control
   -&gt; DynamicTable
   -&gt; DynamicTable
   -&gt; TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO (IORef Int)
-&gt; IO
     (IORef Int
      -&gt; TQueue (Output Stream)
      -&gt; TVar Int
      -&gt; TQueue Control
      -&gt; DynamicTable
      -&gt; DynamicTable
      -&gt; TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (IORef Int)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-110"></span><span>        </span><span class="annot"><span class="annottext">IO
  (IORef Int
   -&gt; TQueue (Output Stream)
   -&gt; TVar Int
   -&gt; TQueue Control
   -&gt; DynamicTable
   -&gt; DynamicTable
   -&gt; TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO (IORef Int)
-&gt; IO
     (TQueue (Output Stream)
      -&gt; TVar Int
      -&gt; TQueue Control
      -&gt; DynamicTable
      -&gt; DynamicTable
      -&gt; TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (IORef Int)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116963"><span class="hs-identifier hs-var">buflim</span></a></span><span>
</span><span id="line-111"></span><span>        </span><span class="annot"><span class="annottext">IO
  (TQueue (Output Stream)
   -&gt; TVar Int
   -&gt; TQueue Control
   -&gt; DynamicTable
   -&gt; DynamicTable
   -&gt; TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO (TQueue (Output Stream))
-&gt; IO
     (TVar Int
      -&gt; TQueue Control
      -&gt; DynamicTable
      -&gt; DynamicTable
      -&gt; TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO (TQueue (Output Stream))
forall (m :: * -&gt; *) a. MonadIO m =&gt; m (TQueue a)
</span><span class="hs-identifier hs-var">newTQueueIO</span></span><span>
</span><span id="line-112"></span><span>        </span><span class="annot"><span class="annottext">IO
  (TVar Int
   -&gt; TQueue Control
   -&gt; DynamicTable
   -&gt; DynamicTable
   -&gt; TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO (TVar Int)
-&gt; IO
     (TQueue Control
      -&gt; DynamicTable
      -&gt; DynamicTable
      -&gt; TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (TVar Int)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116962"><span class="hs-identifier hs-var">sid0</span></a></span><span>
</span><span id="line-113"></span><span>        </span><span class="annot"><span class="annottext">IO
  (TQueue Control
   -&gt; DynamicTable
   -&gt; DynamicTable
   -&gt; TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO (TQueue Control)
-&gt; IO
     (DynamicTable
      -&gt; DynamicTable
      -&gt; TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO (TQueue Control)
forall (m :: * -&gt; *) a. MonadIO m =&gt; m (TQueue a)
</span><span class="hs-identifier hs-var">newTQueueIO</span></span><span>
</span><span id="line-114"></span><span>        </span><span class="hs-comment">-- My SETTINGS_HEADER_TABLE_SIZE</span><span>
</span><span id="line-115"></span><span>        </span><span class="annot"><span class="annottext">IO
  (DynamicTable
   -&gt; DynamicTable
   -&gt; TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO DynamicTable
-&gt; IO
     (DynamicTable
      -&gt; TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO DynamicTable
</span><a href="Network.HPACK.Table.Dynamic.html#newDynamicTableForEncoding"><span class="hs-identifier hs-var">newDynamicTableForEncoding</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HPACK.html#defaultDynamicTableSize"><span class="hs-identifier hs-var">defaultDynamicTableSize</span></a></span><span>
</span><span id="line-116"></span><span>        </span><span class="annot"><span class="annottext">IO
  (DynamicTable
   -&gt; TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO DynamicTable
-&gt; IO
     (TVar TxFlow
      -&gt; IORef RxFlow
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; Rate
      -&gt; SockAddr
      -&gt; SockAddr
      -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; IO DynamicTable
</span><a href="Network.HPACK.Table.Dynamic.html#newDynamicTableForDecoding"><span class="hs-identifier hs-var">newDynamicTableForDecoding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.H2.Settings.html#headerTableSize"><span class="hs-identifier hs-var">headerTableSize</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679116956"><span class="hs-identifier hs-var">settings</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4096</span></span><span>
</span><span id="line-117"></span><span>        </span><span class="annot"><span class="annottext">IO
  (TVar TxFlow
   -&gt; IORef RxFlow
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; Rate
   -&gt; SockAddr
   -&gt; SockAddr
   -&gt; Context)
-&gt; IO (TVar TxFlow)
-&gt; IO
     (IORef RxFlow
      -&gt; Rate -&gt; Rate -&gt; Rate -&gt; Rate -&gt; SockAddr -&gt; SockAddr -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">TxFlow -&gt; IO (TVar TxFlow)
forall (m :: * -&gt; *) a. MonadIO m =&gt; a -&gt; m (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; TxFlow
</span><span class="hs-identifier hs-var">newTxFlow</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Frame.Types.html#defaultWindowSize"><span class="hs-identifier hs-var">defaultWindowSize</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- 64K</span><span>
</span><span id="line-118"></span><span>        </span><span class="annot"><span class="annottext">IO
  (IORef RxFlow
   -&gt; Rate -&gt; Rate -&gt; Rate -&gt; Rate -&gt; SockAddr -&gt; SockAddr -&gt; Context)
-&gt; IO (IORef RxFlow)
-&gt; IO
     (Rate -&gt; Rate -&gt; Rate -&gt; Rate -&gt; SockAddr -&gt; SockAddr -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">RxFlow -&gt; IO (IORef RxFlow)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; RxFlow
</span><span class="hs-identifier hs-var">newRxFlow</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116955"><span class="hs-identifier hs-var">connRxWS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>        </span><span class="annot"><span class="annottext">IO
  (Rate -&gt; Rate -&gt; Rate -&gt; Rate -&gt; SockAddr -&gt; SockAddr -&gt; Context)
-&gt; IO Rate
-&gt; IO (Rate -&gt; Rate -&gt; Rate -&gt; SockAddr -&gt; SockAddr -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO Rate
</span><span class="hs-identifier hs-var">newRate</span></span><span>
</span><span id="line-120"></span><span>        </span><span class="annot"><span class="annottext">IO (Rate -&gt; Rate -&gt; Rate -&gt; SockAddr -&gt; SockAddr -&gt; Context)
-&gt; IO Rate -&gt; IO (Rate -&gt; Rate -&gt; SockAddr -&gt; SockAddr -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO Rate
</span><span class="hs-identifier hs-var">newRate</span></span><span>
</span><span id="line-121"></span><span>        </span><span class="annot"><span class="annottext">IO (Rate -&gt; Rate -&gt; SockAddr -&gt; SockAddr -&gt; Context)
-&gt; IO Rate -&gt; IO (Rate -&gt; SockAddr -&gt; SockAddr -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO Rate
</span><span class="hs-identifier hs-var">newRate</span></span><span>
</span><span id="line-122"></span><span>        </span><span class="annot"><span class="annottext">IO (Rate -&gt; SockAddr -&gt; SockAddr -&gt; Context)
-&gt; IO Rate -&gt; IO (SockAddr -&gt; SockAddr -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO Rate
</span><span class="hs-identifier hs-var">newRate</span></span><span>
</span><span id="line-123"></span><span>        </span><span class="annot"><span class="annottext">IO (SockAddr -&gt; SockAddr -&gt; Context)
-&gt; IO SockAddr -&gt; IO (SockAddr -&gt; Context)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SockAddr -&gt; IO SockAddr
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621679116944"><span class="hs-identifier hs-var">confMySockAddr</span></a></span><span>
</span><span id="line-124"></span><span>        </span><span class="annot"><span class="annottext">IO (SockAddr -&gt; Context) -&gt; IO SockAddr -&gt; IO Context
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SockAddr -&gt; IO SockAddr
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SockAddr
</span><a href="#local-6989586621679116945"><span class="hs-identifier hs-var">confPeerSockAddr</span></a></span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621679116957"><span class="annot"><span class="annottext">rl :: Role
</span><a href="#local-6989586621679116957"><span class="hs-identifier hs-var hs-var">rl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RoleInfo
</span><a href="#local-6989586621679116936"><span class="hs-identifier hs-var">rinfo</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-127"></span><span>        </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#RIC"><span class="hs-identifier hs-type">RIC</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.HTTP2.H2.Context.html#Client"><span class="hs-identifier hs-var">Client</span></a></span><span>
</span><span id="line-128"></span><span>        </span><span class="annot"><span class="annottext">RoleInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.HTTP2.H2.Context.html#Server"><span class="hs-identifier hs-var">Server</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span id="local-6989586621679116962"><span class="annot"><span class="annottext">sid0 :: Int
</span><a href="#local-6989586621679116962"><span class="hs-identifier hs-var hs-var">sid0</span></a></span></span><span>
</span><span id="line-130"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621679116957"><span class="hs-identifier hs-var">rl</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.HTTP2.H2.Context.html#Client"><span class="hs-identifier hs-var">Client</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-131"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-132"></span><span>    </span><span id="local-6989586621679116976"><span class="annot"><span class="annottext">dlim :: Int
</span><a href="#local-6989586621679116976"><span class="hs-identifier hs-var hs-var">dlim</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Frame.Types.html#defaultPayloadLength"><span class="hs-identifier hs-var">defaultPayloadLength</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Frame.Types.html#frameHeaderLength"><span class="hs-identifier hs-var">frameHeaderLength</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span id="local-6989586621679116963"><span class="annot"><span class="annottext">buflim :: Int
</span><a href="#local-6989586621679116963"><span class="hs-identifier hs-var hs-var">buflim</span></a></span></span><span>
</span><span id="line-134"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116939"><span class="hs-identifier hs-var">confBufferSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116976"><span class="hs-identifier hs-var">dlim</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116976"><span class="hs-identifier hs-var">dlim</span></a></span><span>
</span><span id="line-135"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116939"><span class="hs-identifier hs-var">confBufferSize</span></a></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#makeMySettingsList"><span class="hs-identifier hs-type">makeMySettingsList</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WindowSize</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#SettingsKey"><span class="hs-identifier hs-type">SettingsKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-138"></span><span id="makeMySettingsList"><span class="annot"><span class="annottext">makeMySettingsList :: Config -&gt; Int -&gt; Int -&gt; [(SettingsKey, Int)]
</span><a href="Network.HTTP2.H2.Context.html#makeMySettingsList"><span class="hs-identifier hs-var hs-var">makeMySettingsList</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span class="hs-special">{</span><span id="local-6989586621679116983"><span id="local-6989586621679116984"><span id="local-6989586621679116985"><span id="local-6989586621679116986"><span id="local-6989586621679116987"><span id="local-6989586621679116988"><span id="local-6989586621679116989"><span id="local-6989586621679116990"><span class="annot"><span class="annottext">Int
Buffer
Manager
SockAddr
Int -&gt; IO ByteString
PositionReadMaker
ByteString -&gt; IO ()
confWriteBuffer :: Config -&gt; Buffer
confBufferSize :: Config -&gt; Int
confSendAll :: Config -&gt; ByteString -&gt; IO ()
confReadN :: Config -&gt; Int -&gt; IO ByteString
confPositionReadMaker :: Config -&gt; PositionReadMaker
confTimeoutManager :: Config -&gt; Manager
confMySockAddr :: Config -&gt; SockAddr
confPeerSockAddr :: Config -&gt; SockAddr
confWriteBuffer :: Buffer
confBufferSize :: Int
confSendAll :: ByteString -&gt; IO ()
confReadN :: Int -&gt; IO ByteString
confPositionReadMaker :: PositionReadMaker
confTimeoutManager :: Manager
confMySockAddr :: SockAddr
confPeerSockAddr :: SockAddr
</span><a href="Network.HTTP2.H2.Types.html#confWriteBuffer"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679116991"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116991"><span class="hs-identifier hs-var">maxConc</span></a></span></span><span> </span><span id="local-6989586621679116992"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116992"><span class="hs-identifier hs-var">winSiz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(SettingsKey, Int)]
</span><a href="#local-6989586621679116993"><span class="hs-identifier hs-var">myInitialAlist</span></a></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-comment">-- confBufferSize is the size of the write buffer.</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-comment">-- But we assume that the size of the read buffer is the same size.</span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-comment">-- So, the size is announced to via SETTINGS_MAX_FRAME_SIZE.</span><span>
</span><span id="line-143"></span><span>    </span><span id="local-6989586621679116995"><span class="annot"><span class="annottext">len :: Int
</span><a href="#local-6989586621679116995"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116984"><span class="hs-identifier hs-var">confBufferSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Frame.Types.html#frameHeaderLength"><span class="hs-identifier hs-var">frameHeaderLength</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span id="local-6989586621679116997"><span class="annot"><span class="annottext">payloadLen :: Int
</span><a href="#local-6989586621679116997"><span class="hs-identifier hs-var hs-var">payloadLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Network.HTTP2.Frame.Types.html#defaultPayloadLength"><span class="hs-identifier hs-var">defaultPayloadLength</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116995"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-145"></span><span>    </span><span id="local-6989586621679116993"><span class="annot"><span class="annottext">myInitialAlist :: [(SettingsKey, Int)]
</span><a href="#local-6989586621679116993"><span class="hs-identifier hs-var hs-var">myInitialAlist</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-146"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SettingsKey
</span><a href="Network.HTTP2.Frame.Types.html#SettingsMaxFrameSize"><span class="hs-identifier hs-var">SettingsMaxFrameSize</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116997"><span class="hs-identifier hs-var">payloadLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SettingsKey
</span><a href="Network.HTTP2.Frame.Types.html#SettingsMaxConcurrentStreams"><span class="hs-identifier hs-var">SettingsMaxConcurrentStreams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116991"><span class="hs-identifier hs-var">maxConc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SettingsKey
</span><a href="Network.HTTP2.Frame.Types.html#SettingsInitialWindowSize"><span class="hs-identifier hs-var">SettingsInitialWindowSize</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679116992"><span class="hs-identifier hs-var">winSiz</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#isClient"><span class="hs-identifier hs-type">isClient</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-154"></span><span id="isClient"><span class="annot"><span class="annottext">isClient :: Context -&gt; Bool
</span><a href="Network.HTTP2.H2.Context.html#isClient"><span class="hs-identifier hs-var hs-var">isClient</span></a></span></span><span> </span><span id="local-6989586621679117003"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117003"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Role
</span><a href="Network.HTTP2.H2.Context.html#role"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117003"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.HTTP2.H2.Context.html#Client"><span class="hs-identifier hs-var">Client</span></a></span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#isServer"><span class="hs-identifier hs-type">isServer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-157"></span><span id="isServer"><span class="annot"><span class="annottext">isServer :: Context -&gt; Bool
</span><a href="Network.HTTP2.H2.Context.html#isServer"><span class="hs-identifier hs-var hs-var">isServer</span></a></span></span><span> </span><span id="local-6989586621679117005"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117005"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Role
</span><a href="Network.HTTP2.H2.Context.html#role"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117005"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.HTTP2.H2.Context.html#Server"><span class="hs-identifier hs-var">Server</span></a></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#getMyNewStreamId"><span class="hs-identifier hs-type">getMyNewStreamId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span>
</span><span id="line-162"></span><span id="getMyNewStreamId"><span class="annot"><span class="annottext">getMyNewStreamId :: Context -&gt; STM Int
</span><a href="Network.HTTP2.H2.Context.html#getMyNewStreamId"><span class="hs-identifier hs-var hs-var">getMyNewStreamId</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679117007"><span id="local-6989586621679117008"><span id="local-6989586621679117009"><span id="local-6989586621679117010"><span id="local-6989586621679117011"><span id="local-6989586621679117012"><span id="local-6989586621679117013"><span id="local-6989586621679117014"><span id="local-6989586621679117015"><span id="local-6989586621679117016"><span id="local-6989586621679117017"><span id="local-6989586621679117018"><span id="local-6989586621679117019"><span id="local-6989586621679117020"><span id="local-6989586621679117021"><span id="local-6989586621679117022"><span id="local-6989586621679117023"><span id="local-6989586621679117024"><span id="local-6989586621679117025"><span id="local-6989586621679117026"><span id="local-6989586621679117027"><span id="local-6989586621679117028"><span id="local-6989586621679117029"><span id="local-6989586621679117030"><span class="annot"><span class="annottext">TVar Int
TVar TxFlow
TVar EvenStreamTable
TVar OddStreamTable
IORef Bool
IORef Int
IORef (Maybe Int)
IORef RxFlow
IORef Settings
SockAddr
Rate
TQueue Control
TQueue (Output Stream)
DynamicTable
Settings
RoleInfo
Role
role :: Context -&gt; Role
roleInfo :: Context -&gt; RoleInfo
mySettings :: Context -&gt; Settings
myFirstSettings :: Context -&gt; IORef Bool
peerSettings :: Context -&gt; IORef Settings
oddStreamTable :: Context -&gt; TVar OddStreamTable
evenStreamTable :: Context -&gt; TVar EvenStreamTable
continued :: Context -&gt; IORef (Maybe Int)
myStreamId :: Context -&gt; TVar Int
peerStreamId :: Context -&gt; IORef Int
outputBufferLimit :: Context -&gt; IORef Int
outputQ :: Context -&gt; TQueue (Output Stream)
outputQStreamID :: Context -&gt; TVar Int
controlQ :: Context -&gt; TQueue Control
encodeDynamicTable :: Context -&gt; DynamicTable
decodeDynamicTable :: Context -&gt; DynamicTable
txFlow :: Context -&gt; TVar TxFlow
rxFlow :: Context -&gt; IORef RxFlow
pingRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
emptyFrameRate :: Context -&gt; Rate
rstRate :: Context -&gt; Rate
mySockAddr :: Context -&gt; SockAddr
peerSockAddr :: Context -&gt; SockAddr
role :: Role
roleInfo :: RoleInfo
mySettings :: Settings
myFirstSettings :: IORef Bool
peerSettings :: IORef Settings
oddStreamTable :: TVar OddStreamTable
evenStreamTable :: TVar EvenStreamTable
continued :: IORef (Maybe Int)
myStreamId :: TVar Int
peerStreamId :: IORef Int
outputBufferLimit :: IORef Int
outputQ :: TQueue (Output Stream)
outputQStreamID :: TVar Int
controlQ :: TQueue Control
encodeDynamicTable :: DynamicTable
decodeDynamicTable :: DynamicTable
txFlow :: TVar TxFlow
rxFlow :: IORef RxFlow
pingRate :: Rate
settingsRate :: Rate
emptyFrameRate :: Rate
rstRate :: Rate
mySockAddr :: SockAddr
peerSockAddr :: SockAddr
</span><a href="Network.HTTP2.H2.Context.html#role"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-163"></span><span>    </span><span id="local-6989586621679117031"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117031"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Int -&gt; STM Int
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621679117015"><span class="hs-identifier hs-var">myStreamId</span></a></span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679117035"><span class="annot"><span class="annottext">n' :: Int
</span><a href="#local-6989586621679117035"><span class="hs-identifier hs-var hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117031"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span>
</span><span id="line-165"></span><span>    </span><span class="annot"><span class="annottext">TVar Int -&gt; Int -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar Int
</span><a href="#local-6989586621679117015"><span class="hs-identifier hs-var">myStreamId</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117035"><span class="hs-identifier hs-var">n'</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; STM Int
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117031"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#getPeerStreamID"><span class="hs-identifier hs-type">getPeerStreamID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span>
</span><span id="line-169"></span><span id="getPeerStreamID"><span class="annot"><span class="annottext">getPeerStreamID :: Context -&gt; IO Int
</span><a href="Network.HTTP2.H2.Context.html#getPeerStreamID"><span class="hs-identifier hs-var hs-var">getPeerStreamID</span></a></span></span><span> </span><span id="local-6989586621679117038"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117038"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; IO Int
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">(IORef Int -&gt; IO Int) -&gt; IORef Int -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; IORef Int
</span><a href="Network.HTTP2.H2.Context.html#peerStreamId"><span class="hs-identifier hs-var">peerStreamId</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117038"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#setPeerStreamID"><span class="hs-identifier hs-type">setPeerStreamID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span id="setPeerStreamID"><span class="annot"><span class="annottext">setPeerStreamID :: Context -&gt; Int -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#setPeerStreamID"><span class="hs-identifier hs-var hs-var">setPeerStreamID</span></a></span></span><span> </span><span id="local-6989586621679117041"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117041"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679117042"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117042"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; Int -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; IORef Int
</span><a href="Network.HTTP2.H2.Context.html#peerStreamId"><span class="hs-identifier hs-var">peerStreamId</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117041"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117042"><span class="hs-identifier hs-var">sid</span></a></span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#setStreamState"><span class="hs-pragma hs-type">setStreamState</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-177"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#setStreamState"><span class="hs-identifier hs-type">setStreamState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#StreamState"><span class="hs-identifier hs-type">StreamState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span id="setStreamState"><span class="annot"><span class="annottext">setStreamState :: Context -&gt; Stream -&gt; StreamState -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#setStreamState"><span class="hs-identifier hs-var hs-var">setStreamState</span></a></span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679117046"><span class="annot"><span class="annottext">IORef StreamState
streamState :: IORef StreamState
streamState :: Stream -&gt; IORef StreamState
</span><a href="#local-6989586621679117046"><span class="hs-identifier hs-var hs-var">streamState</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679117048"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679117048"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef StreamState -&gt; StreamState -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef StreamState
</span><a href="#local-6989586621679117046"><span class="hs-identifier hs-var">streamState</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679117048"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#opened"><span class="hs-identifier hs-type">opened</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span id="opened"><span class="annot"><span class="annottext">opened :: Context -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#opened"><span class="hs-identifier hs-var hs-var">opened</span></a></span></span><span> </span><span id="local-6989586621679117050"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117050"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679117051"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117051"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; StreamState -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#setStreamState"><span class="hs-identifier hs-var">setStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117050"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117051"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ClosedCode -&gt; OpenState -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">OpenState
</span><a href="Network.HTTP2.H2.Types.html#JustOpened"><span class="hs-identifier hs-var">JustOpened</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#halfClosedRemote"><span class="hs-identifier hs-type">halfClosedRemote</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span id="halfClosedRemote"><span class="annot"><span class="annottext">halfClosedRemote :: Context -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#halfClosedRemote"><span class="hs-identifier hs-var hs-var">halfClosedRemote</span></a></span></span><span> </span><span id="local-6989586621679117055"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117055"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679117056"><span class="annot"><span class="annottext">stream :: Stream
</span><a href="#local-6989586621679117056"><span class="hs-identifier hs-var">stream</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679117057"><span class="annot"><span class="annottext">IORef StreamState
streamState :: Stream -&gt; IORef StreamState
streamState :: IORef StreamState
</span><a href="Network.HTTP2.H2.Types.html#streamState"><span class="hs-identifier hs-var hs-var">streamState</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>    </span><span id="local-6989586621679117058"><span class="annot"><span class="annottext">Maybe ClosedCode
</span><a href="#local-6989586621679117058"><span class="hs-identifier hs-var">closingCode</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef StreamState
-&gt; (StreamState -&gt; (StreamState, Maybe ClosedCode))
-&gt; IO (Maybe ClosedCode)
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef StreamState
</span><a href="#local-6989586621679117057"><span class="hs-identifier hs-var">streamState</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState -&gt; (StreamState, Maybe ClosedCode)
</span><a href="#local-6989586621679117060"><span class="hs-identifier hs-var">closeHalf</span></a></span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><span class="annottext">(ClosedCode -&gt; IO ()) -&gt; Maybe ClosedCode -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; ClosedCode -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#closed"><span class="hs-identifier hs-var">closed</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117055"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117056"><span class="hs-identifier hs-var">stream</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><a href="#local-6989586621679117058"><span class="hs-identifier hs-var">closingCode</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><a href="#local-6989586621679117060"><span class="hs-identifier hs-type">closeHalf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#StreamState"><span class="hs-identifier hs-type">StreamState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#StreamState"><span class="hs-identifier hs-type">StreamState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#ClosedCode"><span class="hs-identifier hs-type">ClosedCode</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621679117060"><span class="annot"><span class="annottext">closeHalf :: StreamState -&gt; (StreamState, Maybe ClosedCode)
</span><a href="#local-6989586621679117060"><span class="hs-identifier hs-var hs-var">closeHalf</span></a></span></span><span> </span><span id="local-6989586621679117063"><span class="annot"><span class="annottext">x :: StreamState
</span><a href="#local-6989586621679117063"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Closed"><span class="hs-identifier hs-type">Closed</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679117063"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><a href="#local-6989586621679117060"><span class="hs-identifier hs-var">closeHalf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679117065"><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679117065"><span class="hs-identifier hs-var">cc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OpenState
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosedCode -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Closed"><span class="hs-identifier hs-var">Closed</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679117065"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ClosedCode -&gt; Maybe ClosedCode
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679117065"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><a href="#local-6989586621679117060"><span class="hs-identifier hs-var">closeHalf</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamState
</span><a href="Network.HTTP2.H2.Types.html#HalfClosedRemote"><span class="hs-identifier hs-var">HalfClosedRemote</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#halfClosedLocal"><span class="hs-identifier hs-type">halfClosedLocal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#ClosedCode"><span class="hs-identifier hs-type">ClosedCode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span id="halfClosedLocal"><span class="annot"><span class="annottext">halfClosedLocal :: Context -&gt; Stream -&gt; ClosedCode -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#halfClosedLocal"><span class="hs-identifier hs-var hs-var">halfClosedLocal</span></a></span></span><span> </span><span id="local-6989586621679117068"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117068"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679117069"><span class="annot"><span class="annottext">stream :: Stream
</span><a href="#local-6989586621679117069"><span class="hs-identifier hs-var">stream</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679117070"><span class="annot"><span class="annottext">IORef StreamState
streamState :: Stream -&gt; IORef StreamState
streamState :: IORef StreamState
</span><a href="Network.HTTP2.H2.Types.html#streamState"><span class="hs-identifier hs-var hs-var">streamState</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679117071"><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679117071"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-195"></span><span>    </span><span id="local-6989586621679117072"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679117072"><span class="hs-identifier hs-var">shouldFinalize</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef StreamState
-&gt; (StreamState -&gt; (StreamState, Bool)) -&gt; IO Bool
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef StreamState
</span><a href="#local-6989586621679117070"><span class="hs-identifier hs-var">streamState</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState -&gt; (StreamState, Bool)
</span><a href="#local-6989586621679117073"><span class="hs-identifier hs-var">closeHalf</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679117072"><span class="hs-identifier hs-var">shouldFinalize</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-197"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; ClosedCode -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#closed"><span class="hs-identifier hs-var">closed</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117068"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117069"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679117071"><span class="hs-identifier hs-var">cc</span></a></span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-199"></span><span>    </span><span class="annot"><a href="#local-6989586621679117073"><span class="hs-identifier hs-type">closeHalf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#StreamState"><span class="hs-identifier hs-type">StreamState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#StreamState"><span class="hs-identifier hs-type">StreamState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>    </span><span id="local-6989586621679117073"><span class="annot"><span class="annottext">closeHalf :: StreamState -&gt; (StreamState, Bool)
</span><a href="#local-6989586621679117073"><span class="hs-identifier hs-var hs-var">closeHalf</span></a></span></span><span> </span><span id="local-6989586621679117075"><span class="annot"><span class="annottext">x :: StreamState
</span><a href="#local-6989586621679117075"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Closed"><span class="hs-identifier hs-type">Closed</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679117075"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><a href="#local-6989586621679117073"><span class="hs-identifier hs-var">closeHalf</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="Network.HTTP2.H2.Types.html#HalfClosedRemote"><span class="hs-identifier hs-var">HalfClosedRemote</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosedCode -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Closed"><span class="hs-identifier hs-var">Closed</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679117071"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><a href="#local-6989586621679117073"><span class="hs-identifier hs-var">closeHalf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621679117076"><span class="annot"><span class="annottext">OpenState
</span><a href="#local-6989586621679117076"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ClosedCode -&gt; OpenState -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosedCode -&gt; Maybe ClosedCode
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679117071"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OpenState
</span><a href="#local-6989586621679117076"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><a href="#local-6989586621679117073"><span class="hs-identifier hs-var">closeHalf</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ClosedCode -&gt; OpenState -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosedCode -&gt; Maybe ClosedCode
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679117071"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OpenState
</span><a href="Network.HTTP2.H2.Types.html#JustOpened"><span class="hs-identifier hs-var">JustOpened</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#closed"><span class="hs-identifier hs-type">closed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#ClosedCode"><span class="hs-identifier hs-type">ClosedCode</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span id="closed"><span class="annot"><span class="annottext">closed :: Context -&gt; Stream -&gt; ClosedCode -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#closed"><span class="hs-identifier hs-var hs-var">closed</span></a></span></span><span> </span><span id="local-6989586621679117077"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679117077"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679117078"><span class="annot"><span class="annottext">TVar OddStreamTable
oddStreamTable :: Context -&gt; TVar OddStreamTable
oddStreamTable :: TVar OddStreamTable
</span><a href="Network.HTTP2.H2.Context.html#oddStreamTable"><span class="hs-identifier hs-var hs-var">oddStreamTable</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679117079"><span class="annot"><span class="annottext">TVar EvenStreamTable
evenStreamTable :: Context -&gt; TVar EvenStreamTable
evenStreamTable :: TVar EvenStreamTable
</span><a href="Network.HTTP2.H2.Context.html#evenStreamTable"><span class="hs-identifier hs-var hs-var">evenStreamTable</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679117080"><span class="annot"><span class="annottext">strm :: Stream
</span><a href="#local-6989586621679117080"><span class="hs-identifier hs-var">strm</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679117081"><span class="annot"><span class="annottext">Int
streamNumber :: Int
streamNumber :: Stream -&gt; Int
</span><a href="#local-6989586621679117081"><span class="hs-identifier hs-var hs-var">streamNumber</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679117083"><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679117083"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#isServerInitiated"><span class="hs-identifier hs-var">isServerInitiated</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117081"><span class="hs-identifier hs-var">streamNumber</span></a></span><span>
</span><span id="line-208"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TVar EvenStreamTable -&gt; Int -&gt; SomeException -&gt; IO ()
</span><a href="Network.HTTP2.H2.StreamTable.html#deleteEven"><span class="hs-identifier hs-var">deleteEven</span></a></span><span> </span><span class="annot"><span class="annottext">TVar EvenStreamTable
</span><a href="#local-6989586621679117079"><span class="hs-identifier hs-var">evenStreamTable</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117081"><span class="hs-identifier hs-var">streamNumber</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679117086"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-209"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TVar OddStreamTable -&gt; Int -&gt; SomeException -&gt; IO ()
</span><a href="Network.HTTP2.H2.StreamTable.html#deleteOdd"><span class="hs-identifier hs-var">deleteOdd</span></a></span><span> </span><span class="annot"><span class="annottext">TVar OddStreamTable
</span><a href="#local-6989586621679117078"><span class="hs-identifier hs-var">oddStreamTable</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117081"><span class="hs-identifier hs-var">streamNumber</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679117086"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-210"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; StreamState -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#setStreamState"><span class="hs-identifier hs-var">setStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117077"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117080"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosedCode -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Closed"><span class="hs-identifier hs-var">Closed</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679117083"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- anyway</span><span>
</span><span id="line-211"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-212"></span><span>    </span><span class="annot"><a href="#local-6989586621679117086"><span class="hs-identifier hs-type">err</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span>
</span><span id="line-213"></span><span>    </span><span id="local-6989586621679117086"><span class="annot"><span class="annottext">err :: SomeException
</span><a href="#local-6989586621679117086"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><span class="hs-identifier hs-var">toException</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; ClosedCode -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#closedCodeToError"><span class="hs-identifier hs-var">closedCodeToError</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117081"><span class="hs-identifier hs-var">streamNumber</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679117083"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- From peer</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="hs-comment">-- Server</span><span>
</span><span id="line-219"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#openOddStreamCheck"><span class="hs-identifier hs-type">openOddStreamCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameType"><span class="hs-identifier hs-type">FrameType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span>
</span><span id="line-220"></span><span id="openOddStreamCheck"><span class="annot"><span class="annottext">openOddStreamCheck :: Context -&gt; Int -&gt; FrameType -&gt; IO Stream
</span><a href="Network.HTTP2.H2.Context.html#openOddStreamCheck"><span class="hs-identifier hs-var hs-var">openOddStreamCheck</span></a></span></span><span> </span><span id="local-6989586621679117091"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679117091"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679117092"><span class="annot"><span class="annottext">TVar OddStreamTable
oddStreamTable :: Context -&gt; TVar OddStreamTable
oddStreamTable :: TVar OddStreamTable
</span><a href="Network.HTTP2.H2.Context.html#oddStreamTable"><span class="hs-identifier hs-var hs-var">oddStreamTable</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679117093"><span class="annot"><span class="annottext">IORef Settings
peerSettings :: Context -&gt; IORef Settings
peerSettings :: IORef Settings
</span><a href="Network.HTTP2.H2.Context.html#peerSettings"><span class="hs-identifier hs-var hs-var">peerSettings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679117094"><span class="annot"><span class="annottext">Settings
mySettings :: Context -&gt; Settings
mySettings :: Settings
</span><a href="Network.HTTP2.H2.Context.html#mySettings"><span class="hs-identifier hs-var hs-var">mySettings</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679117095"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117095"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span id="local-6989586621679117096"><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679117096"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-comment">-- My SETTINGS_MAX_CONCURRENT_STREAMS</span><span>
</span><span id="line-222"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679117096"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; FrameType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-223"></span><span>        </span><span id="local-6989586621679117098"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117098"><span class="hs-identifier hs-var">conc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar OddStreamTable -&gt; IO Int
</span><a href="Network.HTTP2.H2.StreamTable.html#getOddConcurrency"><span class="hs-identifier hs-var">getOddConcurrency</span></a></span><span> </span><span class="annot"><span class="annottext">TVar OddStreamTable
</span><a href="#local-6989586621679117092"><span class="hs-identifier hs-var">oddStreamTable</span></a></span><span>
</span><span id="line-224"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; Settings -&gt; Int -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#checkMyConcurrency"><span class="hs-identifier hs-var">checkMyConcurrency</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117095"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679117094"><span class="hs-identifier hs-var">mySettings</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117098"><span class="hs-identifier hs-var">conc</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>    </span><span id="local-6989586621679117101"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117101"><span class="hs-identifier hs-var">txws</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.H2.Settings.html#initialWindowSize"><span class="hs-identifier hs-var">initialWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; Int) -&gt; IO Settings -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings -&gt; IO Settings
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings
</span><a href="#local-6989586621679117093"><span class="hs-identifier hs-var">peerSettings</span></a></span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679117103"><span class="annot"><span class="annottext">rxws :: Int
</span><a href="#local-6989586621679117103"><span class="hs-identifier hs-var hs-var">rxws</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.H2.Settings.html#initialWindowSize"><span class="hs-identifier hs-var">initialWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679117094"><span class="hs-identifier hs-var">mySettings</span></a></span><span>
</span><span id="line-227"></span><span>    </span><span id="local-6989586621679117104"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117104"><span class="hs-identifier hs-var">newstrm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; IO Stream
</span><a href="Network.HTTP2.H2.Stream.html#newOddStream"><span class="hs-identifier hs-var">newOddStream</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117095"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117101"><span class="hs-identifier hs-var">txws</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117103"><span class="hs-identifier hs-var">rxws</span></a></span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679117096"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; FrameType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679117096"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; FrameType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FramePushPromise"><span class="hs-identifier hs-var">FramePushPromise</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#opened"><span class="hs-identifier hs-var">opened</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117091"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117104"><span class="hs-identifier hs-var">newstrm</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><span class="annottext">TVar OddStreamTable -&gt; Int -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.H2.StreamTable.html#insertOdd"><span class="hs-identifier hs-var">insertOdd</span></a></span><span> </span><span class="annot"><span class="annottext">TVar OddStreamTable
</span><a href="#local-6989586621679117092"><span class="hs-identifier hs-var">oddStreamTable</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117095"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117104"><span class="hs-identifier hs-var">newstrm</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span class="annot"><span class="annottext">Stream -&gt; IO Stream
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117104"><span class="hs-identifier hs-var">newstrm</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="hs-comment">-- Client</span><span>
</span><span id="line-233"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#openEvenStreamCacheCheck"><span class="hs-identifier hs-type">openEvenStreamCacheCheck</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Method</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span id="openEvenStreamCacheCheck"><span class="annot"><span class="annottext">openEvenStreamCacheCheck :: Context -&gt; Int -&gt; ByteString -&gt; ByteString -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#openEvenStreamCacheCheck"><span class="hs-identifier hs-var hs-var">openEvenStreamCacheCheck</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679117110"><span class="annot"><span class="annottext">TVar EvenStreamTable
evenStreamTable :: Context -&gt; TVar EvenStreamTable
evenStreamTable :: TVar EvenStreamTable
</span><a href="Network.HTTP2.H2.Context.html#evenStreamTable"><span class="hs-identifier hs-var hs-var">evenStreamTable</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679117111"><span class="annot"><span class="annottext">IORef Settings
peerSettings :: Context -&gt; IORef Settings
peerSettings :: IORef Settings
</span><a href="Network.HTTP2.H2.Context.html#peerSettings"><span class="hs-identifier hs-var hs-var">peerSettings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679117112"><span class="annot"><span class="annottext">Settings
mySettings :: Context -&gt; Settings
mySettings :: Settings
</span><a href="Network.HTTP2.H2.Context.html#mySettings"><span class="hs-identifier hs-var hs-var">mySettings</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679117113"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117113"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span id="local-6989586621679117114"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679117114"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679117115"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679117115"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-comment">-- My SETTINGS_MAX_CONCURRENT_STREAMS</span><span>
</span><span id="line-236"></span><span>    </span><span id="local-6989586621679117116"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117116"><span class="hs-identifier hs-var">conc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar EvenStreamTable -&gt; IO Int
</span><a href="Network.HTTP2.H2.StreamTable.html#getEvenConcurrency"><span class="hs-identifier hs-var">getEvenConcurrency</span></a></span><span> </span><span class="annot"><span class="annottext">TVar EvenStreamTable
</span><a href="#local-6989586621679117110"><span class="hs-identifier hs-var">evenStreamTable</span></a></span><span>
</span><span id="line-237"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; Settings -&gt; Int -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#checkMyConcurrency"><span class="hs-identifier hs-var">checkMyConcurrency</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117113"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679117112"><span class="hs-identifier hs-var">mySettings</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117116"><span class="hs-identifier hs-var">conc</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>    </span><span id="local-6989586621679117118"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117118"><span class="hs-identifier hs-var">txws</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.H2.Settings.html#initialWindowSize"><span class="hs-identifier hs-var">initialWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; Int) -&gt; IO Settings -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings -&gt; IO Settings
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings
</span><a href="#local-6989586621679117111"><span class="hs-identifier hs-var">peerSettings</span></a></span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679117119"><span class="annot"><span class="annottext">rxws :: Int
</span><a href="#local-6989586621679117119"><span class="hs-identifier hs-var hs-var">rxws</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.H2.Settings.html#initialWindowSize"><span class="hs-identifier hs-var">initialWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679117112"><span class="hs-identifier hs-var">mySettings</span></a></span><span>
</span><span id="line-240"></span><span>    </span><span id="local-6989586621679117120"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117120"><span class="hs-identifier hs-var">newstrm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; IO Stream
</span><a href="Network.HTTP2.H2.Stream.html#newEvenStream"><span class="hs-identifier hs-var">newEvenStream</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117113"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117118"><span class="hs-identifier hs-var">txws</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117119"><span class="hs-identifier hs-var">rxws</span></a></span><span>
</span><span id="line-241"></span><span>    </span><span class="annot"><span class="annottext">TVar EvenStreamTable -&gt; ByteString -&gt; ByteString -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.H2.StreamTable.html#insertEvenCache"><span class="hs-identifier hs-var">insertEvenCache</span></a></span><span> </span><span class="annot"><span class="annottext">TVar EvenStreamTable
</span><a href="#local-6989586621679117110"><span class="hs-identifier hs-var">evenStreamTable</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679117114"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679117115"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117120"><span class="hs-identifier hs-var">newstrm</span></a></span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#checkMyConcurrency"><span class="hs-identifier hs-type">checkMyConcurrency</span></a></span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Settings.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span id="checkMyConcurrency"><span class="annot"><span class="annottext">checkMyConcurrency :: Int -&gt; Settings -&gt; Int -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#checkMyConcurrency"><span class="hs-identifier hs-var hs-var">checkMyConcurrency</span></a></span></span><span> </span><span id="local-6989586621679117123"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117123"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span id="local-6989586621679117124"><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679117124"><span class="hs-identifier hs-var">settings</span></a></span></span><span> </span><span id="local-6989586621679117125"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117125"><span class="hs-identifier hs-var">conc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679117126"><span class="annot"><span class="annottext">mMaxConc :: Maybe Int
</span><a href="#local-6989586621679117126"><span class="hs-identifier hs-var hs-var">mMaxConc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Maybe Int
</span><a href="Network.HTTP2.H2.Settings.html#maxConcurrentStreams"><span class="hs-identifier hs-var">maxConcurrentStreams</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679117124"><span class="hs-identifier hs-var">settings</span></a></span><span>
</span><span id="line-247"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679117126"><span class="hs-identifier hs-var">mMaxConc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-248"></span><span>        </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679117128"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117128"><span class="hs-identifier hs-var">maxConc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117125"><span class="hs-identifier hs-var">conc</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117128"><span class="hs-identifier hs-var">maxConc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-251"></span><span>                </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-252"></span><span>                    </span><span class="annot"><span class="annottext">ErrorCode -&gt; Int -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#StreamErrorIsSent"><span class="hs-identifier hs-var">StreamErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#RefusedStream"><span class="hs-identifier hs-var">RefusedStream</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117123"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;exceeds max concurrent&quot;</span></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- From me</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="hs-comment">-- Clinet</span><span>
</span><span id="line-258"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#openOddStreamWait"><span class="hs-identifier hs-type">openOddStreamWait</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span id="openOddStreamWait"><span class="annot"><span class="annottext">openOddStreamWait :: Context -&gt; IO (Int, Stream)
</span><a href="Network.HTTP2.H2.Context.html#openOddStreamWait"><span class="hs-identifier hs-var hs-var">openOddStreamWait</span></a></span></span><span> </span><span id="local-6989586621679117134"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679117134"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679117135"><span class="annot"><span class="annottext">TVar OddStreamTable
oddStreamTable :: Context -&gt; TVar OddStreamTable
oddStreamTable :: TVar OddStreamTable
</span><a href="Network.HTTP2.H2.Context.html#oddStreamTable"><span class="hs-identifier hs-var hs-var">oddStreamTable</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679117136"><span class="annot"><span class="annottext">Settings
mySettings :: Context -&gt; Settings
mySettings :: Settings
</span><a href="Network.HTTP2.H2.Context.html#mySettings"><span class="hs-identifier hs-var hs-var">mySettings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679117137"><span class="annot"><span class="annottext">IORef Settings
peerSettings :: Context -&gt; IORef Settings
peerSettings :: IORef Settings
</span><a href="Network.HTTP2.H2.Context.html#peerSettings"><span class="hs-identifier hs-var hs-var">peerSettings</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-comment">-- Peer SETTINGS_MAX_CONCURRENT_STREAMS</span><span>
</span><span id="line-261"></span><span>    </span><span id="local-6989586621679117138"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679117138"><span class="hs-identifier hs-var">mMaxConc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Maybe Int
</span><a href="Network.HTTP2.H2.Settings.html#maxConcurrentStreams"><span class="hs-identifier hs-var">maxConcurrentStreams</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; Maybe Int) -&gt; IO Settings -&gt; IO (Maybe Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings -&gt; IO Settings
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings
</span><a href="#local-6989586621679117137"><span class="hs-identifier hs-var">peerSettings</span></a></span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679117139"><span class="annot"><span class="annottext">rxws :: Int
</span><a href="#local-6989586621679117139"><span class="hs-identifier hs-var hs-var">rxws</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.H2.Settings.html#initialWindowSize"><span class="hs-identifier hs-var">initialWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679117136"><span class="hs-identifier hs-var">mySettings</span></a></span><span>
</span><span id="line-263"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679117138"><span class="hs-identifier hs-var">mMaxConc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-264"></span><span>        </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>            </span><span id="local-6989586621679117140"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117140"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM Int -&gt; IO Int
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Int -&gt; IO Int) -&gt; STM Int -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; STM Int
</span><a href="Network.HTTP2.H2.Context.html#getMyNewStreamId"><span class="hs-identifier hs-var">getMyNewStreamId</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117134"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-266"></span><span>            </span><span id="local-6989586621679117142"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117142"><span class="hs-identifier hs-var">txws</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.H2.Settings.html#initialWindowSize"><span class="hs-identifier hs-var">initialWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; Int) -&gt; IO Settings -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings -&gt; IO Settings
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings
</span><a href="#local-6989586621679117137"><span class="hs-identifier hs-var">peerSettings</span></a></span><span>
</span><span id="line-267"></span><span>            </span><span id="local-6989586621679117143"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117143"><span class="hs-identifier hs-var">newstrm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; IO Stream
</span><a href="Network.HTTP2.H2.Stream.html#newOddStream"><span class="hs-identifier hs-var">newOddStream</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117140"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117142"><span class="hs-identifier hs-var">txws</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117139"><span class="hs-identifier hs-var">rxws</span></a></span><span>
</span><span id="line-268"></span><span>            </span><span class="annot"><span class="annottext">TVar OddStreamTable -&gt; Int -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.H2.StreamTable.html#insertOdd"><span class="hs-identifier hs-var">insertOdd</span></a></span><span> </span><span class="annot"><span class="annottext">TVar OddStreamTable
</span><a href="#local-6989586621679117135"><span class="hs-identifier hs-var">oddStreamTable</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117140"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117143"><span class="hs-identifier hs-var">newstrm</span></a></span><span>
</span><span id="line-269"></span><span>            </span><span class="annot"><span class="annottext">(Int, Stream) -&gt; IO (Int, Stream)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117140"><span class="hs-identifier hs-var">sid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117143"><span class="hs-identifier hs-var">newstrm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679117144"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117144"><span class="hs-identifier hs-var">maxConc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-271"></span><span>            </span><span id="local-6989586621679117145"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117145"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM Int -&gt; IO Int
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Int -&gt; IO Int) -&gt; STM Int -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-272"></span><span>                </span><span class="annot"><span class="annottext">TVar OddStreamTable -&gt; Int -&gt; STM ()
</span><a href="Network.HTTP2.H2.StreamTable.html#waitIncOdd"><span class="hs-identifier hs-var">waitIncOdd</span></a></span><span> </span><span class="annot"><span class="annottext">TVar OddStreamTable
</span><a href="#local-6989586621679117135"><span class="hs-identifier hs-var">oddStreamTable</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117144"><span class="hs-identifier hs-var">maxConc</span></a></span><span>
</span><span id="line-273"></span><span>                </span><span class="annot"><span class="annottext">Context -&gt; STM Int
</span><a href="Network.HTTP2.H2.Context.html#getMyNewStreamId"><span class="hs-identifier hs-var">getMyNewStreamId</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117134"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-274"></span><span>            </span><span id="local-6989586621679117147"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117147"><span class="hs-identifier hs-var">txws</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.H2.Settings.html#initialWindowSize"><span class="hs-identifier hs-var">initialWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; Int) -&gt; IO Settings -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings -&gt; IO Settings
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings
</span><a href="#local-6989586621679117137"><span class="hs-identifier hs-var">peerSettings</span></a></span><span>
</span><span id="line-275"></span><span>            </span><span id="local-6989586621679117148"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117148"><span class="hs-identifier hs-var">newstrm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; IO Stream
</span><a href="Network.HTTP2.H2.Stream.html#newOddStream"><span class="hs-identifier hs-var">newOddStream</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117145"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117147"><span class="hs-identifier hs-var">txws</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117139"><span class="hs-identifier hs-var">rxws</span></a></span><span>
</span><span id="line-276"></span><span>            </span><span class="annot"><span class="annottext">TVar OddStreamTable -&gt; Int -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.H2.StreamTable.html#insertOdd%27"><span class="hs-identifier hs-var">insertOdd'</span></a></span><span> </span><span class="annot"><span class="annottext">TVar OddStreamTable
</span><a href="#local-6989586621679117135"><span class="hs-identifier hs-var">oddStreamTable</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117145"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117148"><span class="hs-identifier hs-var">newstrm</span></a></span><span>
</span><span id="line-277"></span><span>            </span><span class="annot"><span class="annottext">(Int, Stream) -&gt; IO (Int, Stream)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117145"><span class="hs-identifier hs-var">sid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117148"><span class="hs-identifier hs-var">newstrm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span class="hs-comment">-- Server</span><span>
</span><span id="line-280"></span><span class="annot"><a href="Network.HTTP2.H2.Context.html#openEvenStreamWait"><span class="hs-identifier hs-type">openEvenStreamWait</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span id="openEvenStreamWait"><span class="annot"><span class="annottext">openEvenStreamWait :: Context -&gt; IO (Int, Stream)
</span><a href="Network.HTTP2.H2.Context.html#openEvenStreamWait"><span class="hs-identifier hs-var hs-var">openEvenStreamWait</span></a></span></span><span> </span><span id="local-6989586621679117151"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679117151"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679117152"><span id="local-6989586621679117153"><span id="local-6989586621679117154"><span id="local-6989586621679117155"><span id="local-6989586621679117156"><span id="local-6989586621679117157"><span id="local-6989586621679117158"><span id="local-6989586621679117159"><span id="local-6989586621679117160"><span id="local-6989586621679117161"><span id="local-6989586621679117162"><span id="local-6989586621679117163"><span id="local-6989586621679117164"><span id="local-6989586621679117165"><span id="local-6989586621679117166"><span id="local-6989586621679117167"><span id="local-6989586621679117168"><span id="local-6989586621679117169"><span id="local-6989586621679117170"><span id="local-6989586621679117171"><span id="local-6989586621679117172"><span id="local-6989586621679117173"><span id="local-6989586621679117174"><span id="local-6989586621679117175"><span class="annot"><span class="annottext">TVar Int
TVar TxFlow
TVar EvenStreamTable
TVar OddStreamTable
IORef Bool
IORef Int
IORef (Maybe Int)
IORef RxFlow
IORef Settings
SockAddr
Rate
TQueue Control
TQueue (Output Stream)
DynamicTable
Settings
RoleInfo
Role
role :: Context -&gt; Role
roleInfo :: Context -&gt; RoleInfo
mySettings :: Context -&gt; Settings
myFirstSettings :: Context -&gt; IORef Bool
peerSettings :: Context -&gt; IORef Settings
oddStreamTable :: Context -&gt; TVar OddStreamTable
evenStreamTable :: Context -&gt; TVar EvenStreamTable
continued :: Context -&gt; IORef (Maybe Int)
myStreamId :: Context -&gt; TVar Int
peerStreamId :: Context -&gt; IORef Int
outputBufferLimit :: Context -&gt; IORef Int
outputQ :: Context -&gt; TQueue (Output Stream)
outputQStreamID :: Context -&gt; TVar Int
controlQ :: Context -&gt; TQueue Control
encodeDynamicTable :: Context -&gt; DynamicTable
decodeDynamicTable :: Context -&gt; DynamicTable
txFlow :: Context -&gt; TVar TxFlow
rxFlow :: Context -&gt; IORef RxFlow
pingRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
emptyFrameRate :: Context -&gt; Rate
rstRate :: Context -&gt; Rate
mySockAddr :: Context -&gt; SockAddr
peerSockAddr :: Context -&gt; SockAddr
role :: Role
roleInfo :: RoleInfo
mySettings :: Settings
myFirstSettings :: IORef Bool
peerSettings :: IORef Settings
oddStreamTable :: TVar OddStreamTable
evenStreamTable :: TVar EvenStreamTable
continued :: IORef (Maybe Int)
myStreamId :: TVar Int
peerStreamId :: IORef Int
outputBufferLimit :: IORef Int
outputQ :: TQueue (Output Stream)
outputQStreamID :: TVar Int
controlQ :: TQueue Control
encodeDynamicTable :: DynamicTable
decodeDynamicTable :: DynamicTable
txFlow :: TVar TxFlow
rxFlow :: IORef RxFlow
pingRate :: Rate
settingsRate :: Rate
emptyFrameRate :: Rate
rstRate :: Rate
mySockAddr :: SockAddr
peerSockAddr :: SockAddr
</span><a href="Network.HTTP2.H2.Context.html#role"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-comment">-- Peer SETTINGS_MAX_CONCURRENT_STREAMS</span><span>
</span><span id="line-283"></span><span>    </span><span id="local-6989586621679117176"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679117176"><span class="hs-identifier hs-var">mMaxConc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Maybe Int
</span><a href="Network.HTTP2.H2.Settings.html#maxConcurrentStreams"><span class="hs-identifier hs-var">maxConcurrentStreams</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; Maybe Int) -&gt; IO Settings -&gt; IO (Maybe Int)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings -&gt; IO Settings
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings
</span><a href="#local-6989586621679117156"><span class="hs-identifier hs-var">peerSettings</span></a></span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679117177"><span class="annot"><span class="annottext">rxws :: Int
</span><a href="#local-6989586621679117177"><span class="hs-identifier hs-var hs-var">rxws</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.H2.Settings.html#initialWindowSize"><span class="hs-identifier hs-var">initialWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679117154"><span class="hs-identifier hs-var">mySettings</span></a></span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679117176"><span class="hs-identifier hs-var">mMaxConc</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-286"></span><span>        </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-287"></span><span>            </span><span id="local-6989586621679117178"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117178"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM Int -&gt; IO Int
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Int -&gt; IO Int) -&gt; STM Int -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; STM Int
</span><a href="Network.HTTP2.H2.Context.html#getMyNewStreamId"><span class="hs-identifier hs-var">getMyNewStreamId</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117151"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-288"></span><span>            </span><span id="local-6989586621679117179"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117179"><span class="hs-identifier hs-var">txws</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.H2.Settings.html#initialWindowSize"><span class="hs-identifier hs-var">initialWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; Int) -&gt; IO Settings -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings -&gt; IO Settings
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings
</span><a href="#local-6989586621679117156"><span class="hs-identifier hs-var">peerSettings</span></a></span><span>
</span><span id="line-289"></span><span>            </span><span id="local-6989586621679117180"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117180"><span class="hs-identifier hs-var">newstrm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; IO Stream
</span><a href="Network.HTTP2.H2.Stream.html#newEvenStream"><span class="hs-identifier hs-var">newEvenStream</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117178"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117179"><span class="hs-identifier hs-var">txws</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117177"><span class="hs-identifier hs-var">rxws</span></a></span><span>
</span><span id="line-290"></span><span>            </span><span class="annot"><span class="annottext">TVar EvenStreamTable -&gt; Int -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.H2.StreamTable.html#insertEven"><span class="hs-identifier hs-var">insertEven</span></a></span><span> </span><span class="annot"><span class="annottext">TVar EvenStreamTable
</span><a href="#local-6989586621679117158"><span class="hs-identifier hs-var">evenStreamTable</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117178"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117180"><span class="hs-identifier hs-var">newstrm</span></a></span><span>
</span><span id="line-291"></span><span>            </span><span class="annot"><span class="annottext">(Int, Stream) -&gt; IO (Int, Stream)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117178"><span class="hs-identifier hs-var">sid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117180"><span class="hs-identifier hs-var">newstrm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679117182"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117182"><span class="hs-identifier hs-var">maxConc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>            </span><span id="local-6989586621679117183"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117183"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM Int -&gt; IO Int
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Int -&gt; IO Int) -&gt; STM Int -&gt; IO Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-294"></span><span>                </span><span class="annot"><span class="annottext">TVar EvenStreamTable -&gt; Int -&gt; STM ()
</span><a href="Network.HTTP2.H2.StreamTable.html#waitIncEven"><span class="hs-identifier hs-var">waitIncEven</span></a></span><span> </span><span class="annot"><span class="annottext">TVar EvenStreamTable
</span><a href="#local-6989586621679117158"><span class="hs-identifier hs-var">evenStreamTable</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117182"><span class="hs-identifier hs-var">maxConc</span></a></span><span>
</span><span id="line-295"></span><span>                </span><span class="annot"><span class="annottext">Context -&gt; STM Int
</span><a href="Network.HTTP2.H2.Context.html#getMyNewStreamId"><span class="hs-identifier hs-var">getMyNewStreamId</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679117151"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-296"></span><span>            </span><span id="local-6989586621679117185"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117185"><span class="hs-identifier hs-var">txws</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; Int
</span><a href="Network.HTTP2.H2.Settings.html#initialWindowSize"><span class="hs-identifier hs-var">initialWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">(Settings -&gt; Int) -&gt; IO Settings -&gt; IO Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings -&gt; IO Settings
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Settings
</span><a href="#local-6989586621679117156"><span class="hs-identifier hs-var">peerSettings</span></a></span><span>
</span><span id="line-297"></span><span>            </span><span id="local-6989586621679117186"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117186"><span class="hs-identifier hs-var">newstrm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; IO Stream
</span><a href="Network.HTTP2.H2.Stream.html#newEvenStream"><span class="hs-identifier hs-var">newEvenStream</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117183"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117185"><span class="hs-identifier hs-var">txws</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117177"><span class="hs-identifier hs-var">rxws</span></a></span><span>
</span><span id="line-298"></span><span>            </span><span class="annot"><span class="annottext">TVar EvenStreamTable -&gt; Int -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.H2.StreamTable.html#insertEven%27"><span class="hs-identifier hs-var">insertEven'</span></a></span><span> </span><span class="annot"><span class="annottext">TVar EvenStreamTable
</span><a href="#local-6989586621679117158"><span class="hs-identifier hs-var">evenStreamTable</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117183"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117186"><span class="hs-identifier hs-var">newstrm</span></a></span><span>
</span><span id="line-299"></span><span>            </span><span class="annot"><span class="annottext">(Int, Stream) -&gt; IO (Int, Stream)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679117183"><span class="hs-identifier hs-var">sid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679117186"><span class="hs-identifier hs-var">newstrm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-300"></span></pre></body></html>