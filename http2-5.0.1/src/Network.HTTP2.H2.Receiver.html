<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE PatternGuards #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.HTTP2.H2.Receiver</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#frameReceiver"><span class="hs-identifier">frameReceiver</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Char8</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C8</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Short</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Short</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Control</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO.Concurrent</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO.Exception</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">UnliftIO.STM</span></span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Imports.html"><span class="hs-identifier">Imports</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">delete</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">insert</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HPACK.html"><span class="hs-identifier">Network.HPACK</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HPACK.Token.html"><span class="hs-identifier">Network.HPACK.Token</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.html"><span class="hs-identifier">Network.HTTP2.Frame</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html"><span class="hs-identifier">Network.HTTP2.H2.Context</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.EncodeFrame.html"><span class="hs-identifier">Network.HTTP2.H2.EncodeFrame</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.HPACK.html"><span class="hs-identifier">Network.HTTP2.H2.HPACK</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Queue.html"><span class="hs-identifier">Network.HTTP2.H2.Queue</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Settings.html"><span class="hs-identifier">Network.HTTP2.H2.Settings</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Stream.html"><span class="hs-identifier">Network.HTTP2.H2.Stream</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.StreamTable.html"><span class="hs-identifier">Network.HTTP2.H2.StreamTable</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html"><span class="hs-identifier">Network.HTTP2.H2.Types</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Window.html"><span class="hs-identifier">Network.HTTP2.H2.Window</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#continuationLimit"><span class="hs-identifier hs-type">continuationLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-36"></span><span id="continuationLimit"><span class="annot"><span class="annottext">continuationLimit :: StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#continuationLimit"><span class="hs-identifier hs-var hs-var">continuationLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">10</span></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#headerFragmentLimit"><span class="hs-identifier hs-type">headerFragmentLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-39"></span><span id="headerFragmentLimit"><span class="annot"><span class="annottext">headerFragmentLimit :: StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#headerFragmentLimit"><span class="hs-identifier hs-var hs-var">headerFragmentLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">51200</span></span><span> </span><span class="hs-comment">-- 50K</span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#pingRateLimit"><span class="hs-identifier hs-type">pingRateLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-42"></span><span id="pingRateLimit"><span class="annot"><span class="annottext">pingRateLimit :: StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#pingRateLimit"><span class="hs-identifier hs-var hs-var">pingRateLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">4</span></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#settingsRateLimit"><span class="hs-identifier hs-type">settingsRateLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-45"></span><span id="settingsRateLimit"><span class="annot"><span class="annottext">settingsRateLimit :: StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#settingsRateLimit"><span class="hs-identifier hs-var hs-var">settingsRateLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">4</span></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#emptyFrameRateLimit"><span class="hs-identifier hs-type">emptyFrameRateLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-48"></span><span id="emptyFrameRateLimit"><span class="annot"><span class="annottext">emptyFrameRateLimit :: StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#emptyFrameRateLimit"><span class="hs-identifier hs-var hs-var">emptyFrameRateLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">4</span></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#rstRateLimit"><span class="hs-identifier hs-type">rstRateLimit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-51"></span><span id="rstRateLimit"><span class="annot"><span class="annottext">rstRateLimit :: StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#rstRateLimit"><span class="hs-identifier hs-var hs-var">rstRateLimit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">4</span></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#frameReceiver"><span class="hs-identifier hs-type">frameReceiver</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span id="frameReceiver"><span class="annot"><span class="annottext">frameReceiver :: Context -&gt; Config -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#frameReceiver"><span class="hs-identifier hs-var hs-var">frameReceiver</span></a></span></span><span> </span><span id="local-6989586621679119167"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679119167"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119169"><span id="local-6989586621679119170"><span id="local-6989586621679119171"><span id="local-6989586621679119172"><span id="local-6989586621679119173"><span id="local-6989586621679119174"><span id="local-6989586621679119175"><span id="local-6989586621679119176"><span id="local-6989586621679119177"><span id="local-6989586621679119178"><span id="local-6989586621679119179"><span id="local-6989586621679119180"><span id="local-6989586621679119181"><span id="local-6989586621679119182"><span id="local-6989586621679119183"><span id="local-6989586621679119184"><span id="local-6989586621679119185"><span id="local-6989586621679119186"><span id="local-6989586621679119187"><span id="local-6989586621679119188"><span id="local-6989586621679119189"><span id="local-6989586621679119190"><span id="local-6989586621679119191"><span id="local-6989586621679119192"><span class="annot"><span class="annottext">TVar StreamId
TVar TxFlow
TVar EvenStreamTable
TVar OddStreamTable
IORef Bool
IORef StreamId
IORef (Maybe StreamId)
IORef RxFlow
IORef Settings
SockAddr
Rate
TQueue Control
TQueue (Output Stream)
DynamicTable
Settings
RoleInfo
Role
role :: Role
roleInfo :: RoleInfo
mySettings :: Settings
myFirstSettings :: IORef Bool
peerSettings :: IORef Settings
oddStreamTable :: TVar OddStreamTable
evenStreamTable :: TVar EvenStreamTable
continued :: IORef (Maybe StreamId)
myStreamId :: TVar StreamId
peerStreamId :: IORef StreamId
outputBufferLimit :: IORef StreamId
outputQ :: TQueue (Output Stream)
outputQStreamID :: TVar StreamId
controlQ :: TQueue Control
encodeDynamicTable :: DynamicTable
decodeDynamicTable :: DynamicTable
txFlow :: TVar TxFlow
rxFlow :: IORef RxFlow
pingRate :: Rate
settingsRate :: Rate
emptyFrameRate :: Rate
rstRate :: Rate
mySockAddr :: SockAddr
peerSockAddr :: SockAddr
role :: Context -&gt; Role
roleInfo :: Context -&gt; RoleInfo
mySettings :: Context -&gt; Settings
myFirstSettings :: Context -&gt; IORef Bool
peerSettings :: Context -&gt; IORef Settings
oddStreamTable :: Context -&gt; TVar OddStreamTable
evenStreamTable :: Context -&gt; TVar EvenStreamTable
continued :: Context -&gt; IORef (Maybe StreamId)
myStreamId :: Context -&gt; TVar StreamId
peerStreamId :: Context -&gt; IORef StreamId
outputBufferLimit :: Context -&gt; IORef StreamId
outputQ :: Context -&gt; TQueue (Output Stream)
outputQStreamID :: Context -&gt; TVar StreamId
controlQ :: Context -&gt; TQueue Control
encodeDynamicTable :: Context -&gt; DynamicTable
decodeDynamicTable :: Context -&gt; DynamicTable
txFlow :: Context -&gt; TVar TxFlow
rxFlow :: Context -&gt; IORef RxFlow
pingRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
emptyFrameRate :: Context -&gt; Rate
rstRate :: Context -&gt; Rate
mySockAddr :: Context -&gt; SockAddr
peerSockAddr :: Context -&gt; SockAddr
</span><a href="#local-6989586621679119169"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119217"><span class="annot"><span class="annottext">conf :: Config
</span><a href="#local-6989586621679119217"><span class="hs-identifier hs-var">conf</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119219"><span id="local-6989586621679119220"><span id="local-6989586621679119221"><span id="local-6989586621679119222"><span id="local-6989586621679119223"><span id="local-6989586621679119224"><span id="local-6989586621679119225"><span id="local-6989586621679119226"><span class="annot"><span class="annottext">StreamId
Buffer
Manager
SockAddr
StreamId -&gt; IO ByteString
PositionReadMaker
ByteString -&gt; IO ()
confWriteBuffer :: Buffer
confBufferSize :: StreamId
confSendAll :: ByteString -&gt; IO ()
confReadN :: StreamId -&gt; IO ByteString
confPositionReadMaker :: PositionReadMaker
confTimeoutManager :: Manager
confMySockAddr :: SockAddr
confPeerSockAddr :: SockAddr
confWriteBuffer :: Config -&gt; Buffer
confBufferSize :: Config -&gt; StreamId
confSendAll :: Config -&gt; ByteString -&gt; IO ()
confReadN :: Config -&gt; StreamId -&gt; IO ByteString
confPositionReadMaker :: Config -&gt; PositionReadMaker
confTimeoutManager :: Config -&gt; Manager
confMySockAddr :: Config -&gt; SockAddr
confPeerSockAddr :: Config -&gt; SockAddr
</span><a href="#local-6989586621679119219"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; IO ()
</span><a href="#local-6989586621679119235"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; (SomeException -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) e a.
(MonadUnliftIO m, Exception e) =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`E.catch`</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; IO ()
</span><a href="#local-6989586621679119237"><span class="hs-identifier hs-var">sendGoaway</span></a></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><a href="#local-6989586621679119235"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>    </span><span id="local-6989586621679119235"><span class="annot"><span class="annottext">loop :: StreamId -&gt; IO ()
</span><a href="#local-6989586621679119235"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span id="local-6989586621679119238"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119238"><span class="hs-identifier hs-var">n</span></a></span></span><span>
</span><span id="line-60"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119238"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">6</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-61"></span><span>            </span><span class="annot"><span class="annottext">IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; m ()
</span><span class="hs-identifier hs-var">yield</span></span><span>
</span><span id="line-62"></span><span>            </span><span class="annot"><span class="annottext">StreamId -&gt; IO ()
</span><a href="#local-6989586621679119235"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">0</span></span><span>
</span><span id="line-63"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-64"></span><span>            </span><span id="local-6989586621679119240"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119240"><span class="hs-identifier hs-var">hd</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; IO ByteString
</span><a href="#local-6989586621679119222"><span class="hs-identifier hs-var">confReadN</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="Network.HTTP2.Frame.Types.html#frameHeaderLength"><span class="hs-identifier hs-var">frameHeaderLength</span></a></span><span>
</span><span id="line-65"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Bool
</span><span class="hs-identifier hs-var">BS.null</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119240"><span class="hs-identifier hs-var">hd</span></a></span><span>
</span><span id="line-66"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119182"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFinish"><span class="hs-identifier hs-var">CFinish</span></a></span><span> </span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionIsClosed"><span class="hs-identifier hs-var">ConnectionIsClosed</span></a></span><span>
</span><span id="line-67"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-68"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; Config -&gt; (FrameType, FrameHeader) -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#processFrame"><span class="hs-identifier hs-var">processFrame</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119167"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679119217"><span class="hs-identifier hs-var">conf</span></a></span><span> </span><span class="annot"><span class="annottext">((FrameType, FrameHeader) -&gt; IO ())
-&gt; (FrameType, FrameHeader) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; (FrameType, FrameHeader)
</span><a href="Network.HTTP2.Frame.Decode.html#decodeFrameHeader"><span class="hs-identifier hs-var">decodeFrameHeader</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119240"><span class="hs-identifier hs-var">hd</span></a></span><span>
</span><span id="line-69"></span><span>                    </span><span class="annot"><span class="annottext">StreamId -&gt; IO ()
</span><a href="#local-6989586621679119235"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119238"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; StreamId
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span>    </span><span id="local-6989586621679119237"><span class="annot"><span class="annottext">sendGoaway :: SomeException -&gt; IO ()
</span><a href="#local-6989586621679119237"><span class="hs-identifier hs-var hs-var">sendGoaway</span></a></span></span><span> </span><span id="local-6989586621679119259"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679119259"><span class="hs-identifier hs-var">se</span></a></span></span><span>
</span><span id="line-72"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119260"><span class="annot"><span class="annottext">e :: HTTP2Error
</span><a href="#local-6989586621679119260"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionIsClosed"><span class="hs-identifier hs-var">ConnectionIsClosed</span></a></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe HTTP2Error
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">E.fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679119259"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-73"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119182"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFinish"><span class="hs-identifier hs-var">CFinish</span></a></span><span> </span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679119260"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-74"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119262"><span class="annot"><span class="annottext">e :: HTTP2Error
</span><a href="#local-6989586621679119262"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsReceived"><span class="hs-identifier hs-type">ConnectionErrorIsReceived</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe HTTP2Error
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">E.fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679119259"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-75"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119182"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFinish"><span class="hs-identifier hs-var">CFinish</span></a></span><span> </span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679119262"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-76"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119264"><span class="annot"><span class="annottext">e :: HTTP2Error
</span><a href="#local-6989586621679119264"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-type">ConnectionErrorIsSent</span></a></span><span> </span><span id="local-6989586621679119266"><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119266"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span id="local-6989586621679119267"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119267"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span id="local-6989586621679119268"><span class="annot"><span class="annottext">ReasonPhrase
</span><a href="#local-6989586621679119268"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe HTTP2Error
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">E.fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679119259"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-77"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119269"><span class="annot"><span class="annottext">frame :: ByteString
</span><a href="#local-6989586621679119269"><span class="hs-identifier hs-var hs-var">frame</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; ErrorCode -&gt; ByteString -&gt; ByteString
</span><a href="Network.HTTP2.H2.EncodeFrame.html#goawayFrame"><span class="hs-identifier hs-var">goawayFrame</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119267"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119266"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString) -&gt; ByteString -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase -&gt; ByteString
</span><span class="hs-identifier hs-var">Short.fromShort</span></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><a href="#local-6989586621679119268"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-78"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119182"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe SettingsList -&gt; [ByteString] -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFrames"><span class="hs-identifier hs-var">CFrames</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SettingsList
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119269"><span class="hs-identifier hs-var">frame</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-79"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119182"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFinish"><span class="hs-identifier hs-var">CFinish</span></a></span><span> </span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679119264"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-80"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119273"><span class="annot"><span class="annottext">e :: HTTP2Error
</span><a href="#local-6989586621679119273"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#StreamErrorIsSent"><span class="hs-identifier hs-type">StreamErrorIsSent</span></a></span><span> </span><span id="local-6989586621679119275"><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119275"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span id="local-6989586621679119276"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119276"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span id="local-6989586621679119277"><span class="annot"><span class="annottext">ReasonPhrase
</span><a href="#local-6989586621679119277"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe HTTP2Error
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">E.fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679119259"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-81"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119278"><span class="annot"><span class="annottext">frame :: ByteString
</span><a href="#local-6989586621679119278"><span class="hs-identifier hs-var hs-var">frame</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ByteString
</span><a href="Network.HTTP2.H2.EncodeFrame.html#resetFrame"><span class="hs-identifier hs-var">resetFrame</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119275"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119276"><span class="hs-identifier hs-var">sid</span></a></span><span>
</span><span id="line-82"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119182"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe SettingsList -&gt; [ByteString] -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFrames"><span class="hs-identifier hs-var">CFrames</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SettingsList
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119278"><span class="hs-identifier hs-var">frame</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-83"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119280"><span class="annot"><span class="annottext">frame' :: ByteString
</span><a href="#local-6989586621679119280"><span class="hs-identifier hs-var hs-var">frame'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; ErrorCode -&gt; ByteString -&gt; ByteString
</span><a href="Network.HTTP2.H2.EncodeFrame.html#goawayFrame"><span class="hs-identifier hs-var">goawayFrame</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119276"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119275"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString) -&gt; ByteString -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase -&gt; ByteString
</span><span class="hs-identifier hs-var">Short.fromShort</span></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><a href="#local-6989586621679119277"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-84"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119182"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe SettingsList -&gt; [ByteString] -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFrames"><span class="hs-identifier hs-var">CFrames</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SettingsList
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119280"><span class="hs-identifier hs-var">frame'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-85"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119182"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFinish"><span class="hs-identifier hs-var">CFinish</span></a></span><span> </span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679119273"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-86"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119281"><span class="annot"><span class="annottext">e :: HTTP2Error
</span><a href="#local-6989586621679119281"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#StreamErrorIsReceived"><span class="hs-identifier hs-type">StreamErrorIsReceived</span></a></span><span> </span><span id="local-6989586621679119283"><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119283"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span id="local-6989586621679119284"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119284"><span class="hs-identifier hs-var">sid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe HTTP2Error
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">E.fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679119259"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-87"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119286"><span class="annot"><span class="annottext">frame :: ByteString
</span><a href="#local-6989586621679119286"><span class="hs-identifier hs-var hs-var">frame</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; ErrorCode -&gt; ByteString -&gt; ByteString
</span><a href="Network.HTTP2.H2.EncodeFrame.html#goawayFrame"><span class="hs-identifier hs-var">goawayFrame</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119284"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119283"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;treat a stream error as a connection error&quot;</span></span><span>
</span><span id="line-88"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119182"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe SettingsList -&gt; [ByteString] -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFrames"><span class="hs-identifier hs-var">CFrames</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SettingsList
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119286"><span class="hs-identifier hs-var">frame</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-89"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119182"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFinish"><span class="hs-identifier hs-var">CFinish</span></a></span><span> </span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679119281"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-90"></span><span>        </span><span class="hs-comment">-- this never happens</span><span>
</span><span id="line-91"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119287"><span class="annot"><span class="annottext">e :: HTTP2Error
</span><a href="#local-6989586621679119287"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#BadThingHappen"><span class="hs-identifier hs-type">BadThingHappen</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe HTTP2Error
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">E.fromException</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679119259"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-92"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119182"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFinish"><span class="hs-identifier hs-var">CFinish</span></a></span><span> </span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="#local-6989586621679119287"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-93"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-94"></span><span>            </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119182"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFinish"><span class="hs-identifier hs-var">CFinish</span></a></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; Control) -&gt; HTTP2Error -&gt; Control
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#BadThingHappen"><span class="hs-identifier hs-var">BadThingHappen</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679119259"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#processFrame"><span class="hs-identifier hs-type">processFrame</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameType"><span class="hs-identifier hs-type">FrameType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span id="processFrame"><span class="annot"><span class="annottext">processFrame :: Context -&gt; Config -&gt; (FrameType, FrameHeader) -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#processFrame"><span class="hs-identifier hs-var hs-var">processFrame</span></a></span></span><span> </span><span id="local-6989586621679119289"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119289"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679119290"><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679119290"><span class="hs-identifier hs-var">_conf</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679119291"><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119291"><span class="hs-identifier hs-var">fid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119293"><span class="annot"><span class="annottext">StreamId
streamId :: StreamId
streamId :: FrameHeader -&gt; StreamId
</span><a href="#local-6989586621679119293"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.HTTP2.H2.Context.html#isServer"><span class="hs-identifier hs-var">isServer</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119289"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-101"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#isServerInitiated"><span class="hs-identifier hs-var">isServerInitiated</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119293"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-102"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119291"><span class="hs-identifier hs-var">fid</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; [FrameType] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FramePriority"><span class="hs-identifier hs-var">FramePriority</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameRSTStream"><span class="hs-identifier hs-var">FrameRSTStream</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameWindowUpdate"><span class="hs-identifier hs-var">FrameWindowUpdate</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-103"></span><span>        </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-104"></span><span>            </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119293"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;stream id should be odd&quot;</span></span><span>
</span><span id="line-105"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#processFrame"><span class="hs-identifier hs-var">processFrame</span></a></span><span> </span><span id="local-6989586621679119304"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119304"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679119305"><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679119305"><span class="hs-identifier hs-var">_conf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FramePushPromise"><span class="hs-identifier hs-var">FramePushPromise</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119307"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.HTTP2.H2.Context.html#isServer"><span class="hs-identifier hs-var">isServer</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119304"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-107"></span><span>        </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-108"></span><span>            </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119307"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;push promise is not allowed&quot;</span></span><span>
</span><span id="line-109"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#processFrame"><span class="hs-identifier hs-var">processFrame</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119308"><span id="local-6989586621679119309"><span id="local-6989586621679119310"><span id="local-6989586621679119311"><span id="local-6989586621679119312"><span id="local-6989586621679119313"><span id="local-6989586621679119314"><span id="local-6989586621679119315"><span id="local-6989586621679119316"><span id="local-6989586621679119317"><span id="local-6989586621679119318"><span id="local-6989586621679119319"><span id="local-6989586621679119320"><span id="local-6989586621679119321"><span id="local-6989586621679119322"><span id="local-6989586621679119323"><span id="local-6989586621679119324"><span id="local-6989586621679119325"><span id="local-6989586621679119326"><span id="local-6989586621679119327"><span id="local-6989586621679119328"><span id="local-6989586621679119329"><span id="local-6989586621679119330"><span id="local-6989586621679119331"><span class="annot"><span class="annottext">TVar StreamId
TVar TxFlow
TVar EvenStreamTable
TVar OddStreamTable
IORef Bool
IORef StreamId
IORef (Maybe StreamId)
IORef RxFlow
IORef Settings
SockAddr
Rate
TQueue Control
TQueue (Output Stream)
DynamicTable
Settings
RoleInfo
Role
role :: Context -&gt; Role
roleInfo :: Context -&gt; RoleInfo
mySettings :: Context -&gt; Settings
myFirstSettings :: Context -&gt; IORef Bool
peerSettings :: Context -&gt; IORef Settings
oddStreamTable :: Context -&gt; TVar OddStreamTable
evenStreamTable :: Context -&gt; TVar EvenStreamTable
continued :: Context -&gt; IORef (Maybe StreamId)
myStreamId :: Context -&gt; TVar StreamId
peerStreamId :: Context -&gt; IORef StreamId
outputBufferLimit :: Context -&gt; IORef StreamId
outputQ :: Context -&gt; TQueue (Output Stream)
outputQStreamID :: Context -&gt; TVar StreamId
controlQ :: Context -&gt; TQueue Control
encodeDynamicTable :: Context -&gt; DynamicTable
decodeDynamicTable :: Context -&gt; DynamicTable
txFlow :: Context -&gt; TVar TxFlow
rxFlow :: Context -&gt; IORef RxFlow
pingRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
emptyFrameRate :: Context -&gt; Rate
rstRate :: Context -&gt; Rate
mySockAddr :: Context -&gt; SockAddr
peerSockAddr :: Context -&gt; SockAddr
role :: Role
roleInfo :: RoleInfo
mySettings :: Settings
myFirstSettings :: IORef Bool
peerSettings :: IORef Settings
oddStreamTable :: TVar OddStreamTable
evenStreamTable :: TVar EvenStreamTable
continued :: IORef (Maybe StreamId)
myStreamId :: TVar StreamId
peerStreamId :: IORef StreamId
outputBufferLimit :: IORef StreamId
outputQ :: TQueue (Output Stream)
outputQStreamID :: TVar StreamId
controlQ :: TQueue Control
encodeDynamicTable :: DynamicTable
decodeDynamicTable :: DynamicTable
txFlow :: TVar TxFlow
rxFlow :: IORef RxFlow
pingRate :: Rate
settingsRate :: Rate
emptyFrameRate :: Rate
rstRate :: Rate
mySockAddr :: SockAddr
peerSockAddr :: SockAddr
</span><a href="Network.HTTP2.H2.Context.html#role"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119332"><span id="local-6989586621679119333"><span id="local-6989586621679119334"><span id="local-6989586621679119335"><span id="local-6989586621679119336"><span id="local-6989586621679119337"><span id="local-6989586621679119338"><span id="local-6989586621679119339"><span class="annot"><span class="annottext">StreamId
Buffer
Manager
SockAddr
StreamId -&gt; IO ByteString
PositionReadMaker
ByteString -&gt; IO ()
confWriteBuffer :: Config -&gt; Buffer
confBufferSize :: Config -&gt; StreamId
confSendAll :: Config -&gt; ByteString -&gt; IO ()
confReadN :: Config -&gt; StreamId -&gt; IO ByteString
confPositionReadMaker :: Config -&gt; PositionReadMaker
confTimeoutManager :: Config -&gt; Manager
confMySockAddr :: Config -&gt; SockAddr
confPeerSockAddr :: Config -&gt; SockAddr
confWriteBuffer :: Buffer
confBufferSize :: StreamId
confSendAll :: ByteString -&gt; IO ()
confReadN :: StreamId -&gt; IO ByteString
confPositionReadMaker :: PositionReadMaker
confTimeoutManager :: Manager
confMySockAddr :: SockAddr
confPeerSockAddr :: SockAddr
</span><a href="Network.HTTP2.H2.Types.html#confWriteBuffer"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679119340"><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119340"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119341"><span class="annot"><span class="annottext">StreamId
payloadLength :: StreamId
payloadLength :: FrameHeader -&gt; StreamId
</span><a href="#local-6989586621679119341"><span class="hs-identifier hs-var hs-var">payloadLength</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119343"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119340"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; FrameType -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#maxFrameType"><span class="hs-identifier hs-var">maxFrameType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-111"></span><span>        </span><span id="local-6989586621679119346"><span class="annot"><span class="annottext">Maybe StreamId
</span><a href="#local-6989586621679119346"><span class="hs-identifier hs-var">mx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe StreamId) -&gt; IO (Maybe StreamId)
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe StreamId)
</span><a href="#local-6989586621679119315"><span class="hs-identifier hs-var">continued</span></a></span><span>
</span><span id="line-112"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe StreamId
</span><a href="#local-6989586621679119346"><span class="hs-identifier hs-var">mx</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-113"></span><span>            </span><span class="annot"><span class="annottext">Maybe StreamId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-114"></span><span>                </span><span class="hs-comment">-- ignoring unknown frame</span><span>
</span><span id="line-115"></span><span>                </span><span class="annot"><span class="annottext">IO ByteString -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; IO ()) -&gt; IO ByteString -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; IO ByteString
</span><a href="#local-6989586621679119335"><span class="hs-identifier hs-var">confReadN</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119341"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-116"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119343"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;unknown frame&quot;</span></span><span>
</span><span id="line-117"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#processFrame"><span class="hs-identifier hs-var">processFrame</span></a></span><span> </span><span id="local-6989586621679119349"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679119349"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119350"><span id="local-6989586621679119351"><span id="local-6989586621679119352"><span id="local-6989586621679119353"><span id="local-6989586621679119354"><span id="local-6989586621679119355"><span id="local-6989586621679119356"><span id="local-6989586621679119357"><span id="local-6989586621679119358"><span id="local-6989586621679119359"><span id="local-6989586621679119360"><span id="local-6989586621679119361"><span id="local-6989586621679119362"><span id="local-6989586621679119363"><span id="local-6989586621679119364"><span id="local-6989586621679119365"><span id="local-6989586621679119366"><span id="local-6989586621679119367"><span id="local-6989586621679119368"><span id="local-6989586621679119369"><span id="local-6989586621679119370"><span id="local-6989586621679119371"><span id="local-6989586621679119372"><span id="local-6989586621679119373"><span class="annot"><span class="annottext">TVar StreamId
TVar TxFlow
TVar EvenStreamTable
TVar OddStreamTable
IORef Bool
IORef StreamId
IORef (Maybe StreamId)
IORef RxFlow
IORef Settings
SockAddr
Rate
TQueue Control
TQueue (Output Stream)
DynamicTable
Settings
RoleInfo
Role
role :: Context -&gt; Role
roleInfo :: Context -&gt; RoleInfo
mySettings :: Context -&gt; Settings
myFirstSettings :: Context -&gt; IORef Bool
peerSettings :: Context -&gt; IORef Settings
oddStreamTable :: Context -&gt; TVar OddStreamTable
evenStreamTable :: Context -&gt; TVar EvenStreamTable
continued :: Context -&gt; IORef (Maybe StreamId)
myStreamId :: Context -&gt; TVar StreamId
peerStreamId :: Context -&gt; IORef StreamId
outputBufferLimit :: Context -&gt; IORef StreamId
outputQ :: Context -&gt; TQueue (Output Stream)
outputQStreamID :: Context -&gt; TVar StreamId
controlQ :: Context -&gt; TQueue Control
encodeDynamicTable :: Context -&gt; DynamicTable
decodeDynamicTable :: Context -&gt; DynamicTable
txFlow :: Context -&gt; TVar TxFlow
rxFlow :: Context -&gt; IORef RxFlow
pingRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
emptyFrameRate :: Context -&gt; Rate
rstRate :: Context -&gt; Rate
mySockAddr :: Context -&gt; SockAddr
peerSockAddr :: Context -&gt; SockAddr
role :: Role
roleInfo :: RoleInfo
mySettings :: Settings
myFirstSettings :: IORef Bool
peerSettings :: IORef Settings
oddStreamTable :: TVar OddStreamTable
evenStreamTable :: TVar EvenStreamTable
continued :: IORef (Maybe StreamId)
myStreamId :: TVar StreamId
peerStreamId :: IORef StreamId
outputBufferLimit :: IORef StreamId
outputQ :: TQueue (Output Stream)
outputQStreamID :: TVar StreamId
controlQ :: TQueue Control
encodeDynamicTable :: DynamicTable
decodeDynamicTable :: DynamicTable
txFlow :: TVar TxFlow
rxFlow :: IORef RxFlow
pingRate :: Rate
settingsRate :: Rate
emptyFrameRate :: Rate
rstRate :: Rate
mySockAddr :: SockAddr
peerSockAddr :: SockAddr
</span><a href="Network.HTTP2.H2.Context.html#role"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119374"><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679119374"><span class="hs-identifier hs-var">conf</span></a></span></span><span> </span><span id="local-6989586621679119375"><span class="annot"><span class="annottext">typhdr :: (FrameType, FrameHeader)
</span><a href="#local-6989586621679119375"><span class="hs-identifier hs-var">typhdr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679119376"><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119376"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119377"><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119377"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-comment">-- My SETTINGS_MAX_FRAME_SIZE</span><span>
</span><span id="line-119"></span><span>    </span><span class="hs-comment">-- My SETTINGS_ENABLE_PUSH</span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(FrameType, FrameHeader)
-&gt; Either FrameDecodeError (FrameType, FrameHeader)
</span><a href="Network.HTTP2.Frame.Decode.html#checkFrameHeader"><span class="hs-identifier hs-var">checkFrameHeader</span></a></span><span> </span><span class="annot"><span class="annottext">(FrameType, FrameHeader)
</span><a href="#local-6989586621679119375"><span class="hs-identifier hs-var">typhdr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-121"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Frame.Decode.html#FrameDecodeError"><span class="hs-identifier hs-type">FrameDecodeError</span></a></span><span> </span><span id="local-6989586621679119380"><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119380"><span class="hs-identifier hs-var">ec</span></a></span></span><span> </span><span id="local-6989586621679119381"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119381"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span id="local-6989586621679119382"><span class="annot"><span class="annottext">ReasonPhrase
</span><a href="#local-6989586621679119382"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119380"><span class="hs-identifier hs-var">ec</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119381"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><a href="#local-6989586621679119382"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-122"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">(FrameType, FrameHeader)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-123"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Settings.html#Settings"><span class="hs-identifier hs-type">Settings</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119384"><span class="annot"><span class="annottext">StreamId
maxFrameSize :: StreamId
maxFrameSize :: Settings -&gt; StreamId
</span><a href="#local-6989586621679119384"><span class="hs-identifier hs-var hs-var">maxFrameSize</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119386"><span class="annot"><span class="annottext">Bool
enablePush :: Bool
enablePush :: Settings -&gt; Bool
</span><a href="#local-6989586621679119386"><span class="hs-identifier hs-var hs-var">enablePush</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679119352"><span class="hs-identifier hs-var">mySettings</span></a></span><span>
</span><span id="line-124"></span><span>                </span><span id="local-6989586621679119388"><span class="annot"><span class="annottext">sid :: StreamId
</span><a href="#local-6989586621679119388"><span class="hs-identifier hs-var hs-var">sid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FrameHeader -&gt; StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119377"><span class="hs-identifier hs-var">header</span></a></span><span>
</span><span id="line-125"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameHeader -&gt; StreamId
</span><a href="Network.HTTP2.Frame.Types.html#payloadLength"><span class="hs-identifier hs-var">payloadLength</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119377"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119384"><span class="hs-identifier hs-var">maxFrameSize</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-126"></span><span>                </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-127"></span><span>                    </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#FrameSizeError"><span class="hs-identifier hs-var">FrameSizeError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119388"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;exceeds maximum frame size&quot;</span></span><span>
</span><span id="line-128"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119386"><span class="hs-identifier hs-var">enablePush</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119376"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; FrameType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FramePushPromise"><span class="hs-identifier hs-var">FramePushPromise</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-129"></span><span>                </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-130"></span><span>                    </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119388"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;push not enabled&quot;</span></span><span>
</span><span id="line-131"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Config -&gt; FrameType -&gt; FrameHeader -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#controlOrStream"><span class="hs-identifier hs-var">controlOrStream</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119349"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Config
</span><a href="#local-6989586621679119374"><span class="hs-identifier hs-var">conf</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119376"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119377"><span class="hs-identifier hs-var">header</span></a></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#controlOrStream"><span class="hs-identifier hs-type">controlOrStream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameType"><span class="hs-identifier hs-type">FrameType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span id="controlOrStream"><span class="annot"><span class="annottext">controlOrStream :: Context -&gt; Config -&gt; FrameType -&gt; FrameHeader -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#controlOrStream"><span class="hs-identifier hs-var hs-var">controlOrStream</span></a></span></span><span> </span><span id="local-6989586621679119393"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679119393"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119394"><span id="local-6989586621679119395"><span id="local-6989586621679119396"><span id="local-6989586621679119397"><span id="local-6989586621679119398"><span id="local-6989586621679119399"><span id="local-6989586621679119400"><span id="local-6989586621679119401"><span id="local-6989586621679119402"><span id="local-6989586621679119403"><span id="local-6989586621679119404"><span id="local-6989586621679119405"><span id="local-6989586621679119406"><span id="local-6989586621679119407"><span id="local-6989586621679119408"><span id="local-6989586621679119409"><span id="local-6989586621679119410"><span id="local-6989586621679119411"><span id="local-6989586621679119412"><span id="local-6989586621679119413"><span id="local-6989586621679119414"><span id="local-6989586621679119415"><span id="local-6989586621679119416"><span id="local-6989586621679119417"><span class="annot"><span class="annottext">TVar StreamId
TVar TxFlow
TVar EvenStreamTable
TVar OddStreamTable
IORef Bool
IORef StreamId
IORef (Maybe StreamId)
IORef RxFlow
IORef Settings
SockAddr
Rate
TQueue Control
TQueue (Output Stream)
DynamicTable
Settings
RoleInfo
Role
role :: Context -&gt; Role
roleInfo :: Context -&gt; RoleInfo
mySettings :: Context -&gt; Settings
myFirstSettings :: Context -&gt; IORef Bool
peerSettings :: Context -&gt; IORef Settings
oddStreamTable :: Context -&gt; TVar OddStreamTable
evenStreamTable :: Context -&gt; TVar EvenStreamTable
continued :: Context -&gt; IORef (Maybe StreamId)
myStreamId :: Context -&gt; TVar StreamId
peerStreamId :: Context -&gt; IORef StreamId
outputBufferLimit :: Context -&gt; IORef StreamId
outputQ :: Context -&gt; TQueue (Output Stream)
outputQStreamID :: Context -&gt; TVar StreamId
controlQ :: Context -&gt; TQueue Control
encodeDynamicTable :: Context -&gt; DynamicTable
decodeDynamicTable :: Context -&gt; DynamicTable
txFlow :: Context -&gt; TVar TxFlow
rxFlow :: Context -&gt; IORef RxFlow
pingRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
emptyFrameRate :: Context -&gt; Rate
rstRate :: Context -&gt; Rate
mySockAddr :: Context -&gt; SockAddr
peerSockAddr :: Context -&gt; SockAddr
role :: Role
roleInfo :: RoleInfo
mySettings :: Settings
myFirstSettings :: IORef Bool
peerSettings :: IORef Settings
oddStreamTable :: TVar OddStreamTable
evenStreamTable :: TVar EvenStreamTable
continued :: IORef (Maybe StreamId)
myStreamId :: TVar StreamId
peerStreamId :: IORef StreamId
outputBufferLimit :: IORef StreamId
outputQ :: TQueue (Output Stream)
outputQStreamID :: TVar StreamId
controlQ :: TQueue Control
encodeDynamicTable :: DynamicTable
decodeDynamicTable :: DynamicTable
txFlow :: TVar TxFlow
rxFlow :: IORef RxFlow
pingRate :: Rate
settingsRate :: Rate
emptyFrameRate :: Rate
rstRate :: Rate
mySockAddr :: SockAddr
peerSockAddr :: SockAddr
</span><a href="Network.HTTP2.H2.Context.html#role"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119418"><span id="local-6989586621679119419"><span id="local-6989586621679119420"><span id="local-6989586621679119421"><span id="local-6989586621679119422"><span id="local-6989586621679119423"><span id="local-6989586621679119424"><span id="local-6989586621679119425"><span class="annot"><span class="annottext">StreamId
Buffer
Manager
SockAddr
StreamId -&gt; IO ByteString
PositionReadMaker
ByteString -&gt; IO ()
confWriteBuffer :: Config -&gt; Buffer
confBufferSize :: Config -&gt; StreamId
confSendAll :: Config -&gt; ByteString -&gt; IO ()
confReadN :: Config -&gt; StreamId -&gt; IO ByteString
confPositionReadMaker :: Config -&gt; PositionReadMaker
confTimeoutManager :: Config -&gt; Manager
confMySockAddr :: Config -&gt; SockAddr
confPeerSockAddr :: Config -&gt; SockAddr
confWriteBuffer :: Buffer
confBufferSize :: StreamId
confSendAll :: ByteString -&gt; IO ()
confReadN :: StreamId -&gt; IO ByteString
confPositionReadMaker :: PositionReadMaker
confTimeoutManager :: Manager
confMySockAddr :: SockAddr
confPeerSockAddr :: SockAddr
</span><a href="Network.HTTP2.H2.Types.html#confWriteBuffer"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119426"><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119426"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span> </span><span id="local-6989586621679119427"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679119427"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119428"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119429"><span class="annot"><span class="annottext">StreamId
payloadLength :: FrameHeader -&gt; StreamId
payloadLength :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#payloadLength"><span class="hs-identifier hs-var hs-var">payloadLength</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#isControl"><span class="hs-identifier hs-var">isControl</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119428"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>        </span><span id="local-6989586621679119431"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119431"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; IO ByteString
</span><a href="#local-6989586621679119421"><span class="hs-identifier hs-var">confReadN</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119429"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><span class="annottext">FrameType -&gt; FrameHeader -&gt; ByteString -&gt; Context -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#control"><span class="hs-identifier hs-var">control</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119426"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119427"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119431"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119393"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119426"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; FrameType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FramePushPromise"><span class="hs-identifier hs-var">FramePushPromise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-141"></span><span>        </span><span id="local-6989586621679119433"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119433"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; IO ByteString
</span><a href="#local-6989586621679119421"><span class="hs-identifier hs-var">confReadN</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119429"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-142"></span><span>        </span><span class="annot"><span class="annottext">FrameHeader -&gt; ByteString -&gt; Context -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#push"><span class="hs-identifier hs-var">push</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119427"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119433"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119393"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>        </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679119435"><span class="hs-identifier hs-var">checkContinued</span></a></span><span>
</span><span id="line-145"></span><span>        </span><span id="local-6989586621679119436"><span class="annot"><span class="annottext">Maybe Stream
</span><a href="#local-6989586621679119436"><span class="hs-identifier hs-var">mstrm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; FrameType -&gt; StreamId -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.H2.Receiver.html#getStream"><span class="hs-identifier hs-var">getStream</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119393"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119426"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119428"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-146"></span><span>        </span><span id="local-6989586621679119438"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119438"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; IO ByteString
</span><a href="#local-6989586621679119421"><span class="hs-identifier hs-var">confReadN</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119429"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-147"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Stream
</span><a href="#local-6989586621679119436"><span class="hs-identifier hs-var">mstrm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-148"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119439"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119439"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>                </span><span id="local-6989586621679119440"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119440"><span class="hs-identifier hs-var">state0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stream -&gt; IO StreamState
</span><a href="Network.HTTP2.H2.Stream.html#readStreamState"><span class="hs-identifier hs-var">readStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119439"><span class="hs-identifier hs-var">strm</span></a></span><span>
</span><span id="line-150"></span><span>                </span><span id="local-6989586621679119442"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119442"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FrameType
-&gt; FrameHeader
-&gt; ByteString
-&gt; Context
-&gt; StreamState
-&gt; Stream
-&gt; IO StreamState
</span><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119426"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119427"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119438"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119393"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119440"><span class="hs-identifier hs-var">state0</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119439"><span class="hs-identifier hs-var">strm</span></a></span><span>
</span><span id="line-151"></span><span>                </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679119444"><span class="hs-identifier hs-var">resetContinued</span></a></span><span>
</span><span id="line-152"></span><span>                </span><span id="local-6989586621679119445"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119445"><span class="hs-identifier hs-var">set</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamState -&gt; Context -&gt; Stream -&gt; StreamId -&gt; IO Bool
</span><a href="Network.HTTP2.H2.Receiver.html#processState"><span class="hs-identifier hs-var">processState</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119442"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119393"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119439"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119428"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-153"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119445"><span class="hs-identifier hs-var">set</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679119447"><span class="hs-identifier hs-var">setContinued</span></a></span><span>
</span><span id="line-154"></span><span>            </span><span class="annot"><span class="annottext">Maybe Stream
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-155"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119426"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; FrameType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FramePriority"><span class="hs-identifier hs-var">FramePriority</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>                    </span><span class="hs-comment">-- for h2spec only</span><span>
</span><span id="line-157"></span><span>                    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#PriorityFrame"><span class="hs-identifier hs-type">PriorityFrame</span></a></span><span> </span><span id="local-6989586621679119449"><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679119449"><span class="hs-identifier hs-var">newpri</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a. Either FrameDecodeError a -&gt; IO a
</span><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either FrameDecodeError FramePayload -&gt; IO FramePayload)
-&gt; Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodePriorityFrame"><span class="hs-identifier hs-var">decodePriorityFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119427"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119438"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-158"></span><span>                    </span><span class="annot"><span class="annottext">Priority -&gt; StreamId -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#checkPriority"><span class="hs-identifier hs-var">checkPriority</span></a></span><span> </span><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679119449"><span class="hs-identifier hs-var">newpri</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119428"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-159"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-161"></span><span>    </span><span id="local-6989586621679119447"><span class="annot"><span class="annottext">setContinued :: IO ()
</span><a href="#local-6989586621679119447"><span class="hs-identifier hs-var hs-var">setContinued</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe StreamId) -&gt; Maybe StreamId -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe StreamId)
</span><a href="#local-6989586621679119401"><span class="hs-identifier hs-var">continued</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe StreamId -&gt; IO ()) -&gt; Maybe StreamId -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; Maybe StreamId
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119428"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-162"></span><span>    </span><span id="local-6989586621679119444"><span class="annot"><span class="annottext">resetContinued :: IO ()
</span><a href="#local-6989586621679119444"><span class="hs-identifier hs-var hs-var">resetContinued</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe StreamId) -&gt; Maybe StreamId -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe StreamId)
</span><a href="#local-6989586621679119401"><span class="hs-identifier hs-var">continued</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe StreamId
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-163"></span><span>    </span><span id="local-6989586621679119435"><span class="annot"><span class="annottext">checkContinued :: IO ()
</span><a href="#local-6989586621679119435"><span class="hs-identifier hs-var hs-var">checkContinued</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>        </span><span id="local-6989586621679119462"><span class="annot"><span class="annottext">Maybe StreamId
</span><a href="#local-6989586621679119462"><span class="hs-identifier hs-var">mx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe StreamId) -&gt; IO (Maybe StreamId)
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe StreamId)
</span><a href="#local-6989586621679119401"><span class="hs-identifier hs-var">continued</span></a></span><span>
</span><span id="line-165"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe StreamId
</span><a href="#local-6989586621679119462"><span class="hs-identifier hs-var">mx</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-166"></span><span>            </span><span class="annot"><span class="annottext">Maybe StreamId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119463"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119463"><span class="hs-identifier hs-var">sid</span></a></span></span><span>
</span><span id="line-168"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119463"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119428"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119426"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; FrameType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameContinuation"><span class="hs-identifier hs-var">FrameContinuation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-170"></span><span>                    </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-171"></span><span>                        </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119428"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;continuation frame must follow&quot;</span></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#processState"><span class="hs-identifier hs-type">processState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#StreamState"><span class="hs-identifier hs-type">StreamState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-176"></span><span class="hs-comment">-- Transition (process1)</span><span>
</span><span id="line-177"></span><span id="processState"><span class="annot"><span class="annottext">processState :: StreamState -&gt; Context -&gt; Stream -&gt; StreamId -&gt; IO Bool
</span><a href="Network.HTTP2.H2.Receiver.html#processState"><span class="hs-identifier hs-var hs-var">processState</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#NoBody"><span class="hs-identifier hs-type">NoBody</span></a></span><span> </span><span id="local-6989586621679119467"><span class="annot"><span class="annottext">tbl :: HeaderTable
</span><a href="#local-6989586621679119467"><span class="hs-identifier hs-var">tbl</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenHeaderList
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119468"><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679119468"><span class="hs-identifier hs-var">reqvt</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679119469"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679119469"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119470"><span id="local-6989586621679119471"><span id="local-6989586621679119472"><span id="local-6989586621679119473"><span id="local-6989586621679119474"><span id="local-6989586621679119475"><span id="local-6989586621679119476"><span id="local-6989586621679119477"><span id="local-6989586621679119478"><span id="local-6989586621679119479"><span id="local-6989586621679119480"><span id="local-6989586621679119481"><span id="local-6989586621679119482"><span id="local-6989586621679119483"><span id="local-6989586621679119484"><span id="local-6989586621679119485"><span id="local-6989586621679119486"><span id="local-6989586621679119487"><span id="local-6989586621679119488"><span id="local-6989586621679119489"><span id="local-6989586621679119490"><span id="local-6989586621679119491"><span id="local-6989586621679119492"><span id="local-6989586621679119493"><span class="annot"><span class="annottext">TVar StreamId
TVar TxFlow
TVar EvenStreamTable
TVar OddStreamTable
IORef Bool
IORef StreamId
IORef (Maybe StreamId)
IORef RxFlow
IORef Settings
SockAddr
Rate
TQueue Control
TQueue (Output Stream)
DynamicTable
Settings
RoleInfo
Role
role :: Context -&gt; Role
roleInfo :: Context -&gt; RoleInfo
mySettings :: Context -&gt; Settings
myFirstSettings :: Context -&gt; IORef Bool
peerSettings :: Context -&gt; IORef Settings
oddStreamTable :: Context -&gt; TVar OddStreamTable
evenStreamTable :: Context -&gt; TVar EvenStreamTable
continued :: Context -&gt; IORef (Maybe StreamId)
myStreamId :: Context -&gt; TVar StreamId
peerStreamId :: Context -&gt; IORef StreamId
outputBufferLimit :: Context -&gt; IORef StreamId
outputQ :: Context -&gt; TQueue (Output Stream)
outputQStreamID :: Context -&gt; TVar StreamId
controlQ :: Context -&gt; TQueue Control
encodeDynamicTable :: Context -&gt; DynamicTable
decodeDynamicTable :: Context -&gt; DynamicTable
txFlow :: Context -&gt; TVar TxFlow
rxFlow :: Context -&gt; IORef RxFlow
pingRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
emptyFrameRate :: Context -&gt; Rate
rstRate :: Context -&gt; Rate
mySockAddr :: Context -&gt; SockAddr
peerSockAddr :: Context -&gt; SockAddr
role :: Role
roleInfo :: RoleInfo
mySettings :: Settings
myFirstSettings :: IORef Bool
peerSettings :: IORef Settings
oddStreamTable :: TVar OddStreamTable
evenStreamTable :: TVar EvenStreamTable
continued :: IORef (Maybe StreamId)
myStreamId :: TVar StreamId
peerStreamId :: IORef StreamId
outputBufferLimit :: IORef StreamId
outputQ :: TQueue (Output Stream)
outputQStreamID :: TVar StreamId
controlQ :: TQueue Control
encodeDynamicTable :: DynamicTable
decodeDynamicTable :: DynamicTable
txFlow :: TVar TxFlow
rxFlow :: IORef RxFlow
pingRate :: Rate
settingsRate :: Rate
emptyFrameRate :: Rate
rstRate :: Rate
mySockAddr :: SockAddr
peerSockAddr :: SockAddr
</span><a href="Network.HTTP2.H2.Context.html#role"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119494"><span class="annot"><span class="annottext">strm :: Stream
</span><a href="#local-6989586621679119494"><span class="hs-identifier hs-var">strm</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119496"><span class="annot"><span class="annottext">MVar (Either SomeException InpObj)
streamInput :: MVar (Either SomeException InpObj)
streamInput :: Stream -&gt; MVar (Either SomeException InpObj)
</span><a href="#local-6989586621679119496"><span class="hs-identifier hs-var hs-var">streamInput</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119498"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119498"><span class="hs-identifier hs-var">streamId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119503"><span class="annot"><span class="annottext">mcl :: Maybe StreamId
</span><a href="#local-6989586621679119503"><span class="hs-identifier hs-var hs-var">mcl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(StreamId, ByteString) -&gt; StreamId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((StreamId, ByteString) -&gt; StreamId)
-&gt; Maybe (StreamId, ByteString) -&gt; Maybe StreamId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Token -&gt; ValueTable -&gt; Maybe ByteString
</span><a href="Network.HPACK.HeaderBlock.Decode.html#getHeaderValue"><span class="hs-identifier hs-var">getHeaderValue</span></a></span><span> </span><span class="annot"><span class="annottext">Token
</span><a href="Network.HPACK.Token.html#tokenContentLength"><span class="hs-identifier hs-var">tokenContentLength</span></a></span><span> </span><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679119468"><span class="hs-identifier hs-var">reqvt</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
-&gt; (ByteString -&gt; Maybe (StreamId, ByteString))
-&gt; Maybe (StreamId, ByteString)
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (StreamId, ByteString)
</span><span class="hs-identifier hs-var">C8.readInt</span></span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe StreamId -&gt; (StreamId -&gt; Bool) -&gt; Bool
forall a. Maybe a -&gt; (a -&gt; Bool) -&gt; Bool
</span><a href="Network.HTTP2.H2.HPACK.html#just"><span class="hs-identifier hs-var">just</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe StreamId
</span><a href="#local-6989586621679119503"><span class="hs-identifier hs-var">mcl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-181"></span><span>            </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#StreamErrorIsSent"><span class="hs-identifier hs-var">StreamErrorIsSent</span></a></span><span>
</span><span id="line-182"></span><span>                </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span>
</span><span id="line-183"></span><span>                </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119498"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-184"></span><span>                </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;no body but content-length is not zero&quot;</span></span><span>
</span><span id="line-185"></span><span>    </span><span id="local-6989586621679119511"><span class="annot"><span class="annottext">IORef (Maybe HeaderTable)
</span><a href="#local-6989586621679119511"><span class="hs-identifier hs-var">tlr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe HeaderTable -&gt; IO (IORef (Maybe HeaderTable))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Maybe HeaderTable
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119516"><span class="annot"><span class="annottext">inpObj :: InpObj
</span><a href="#local-6989586621679119516"><span class="hs-identifier hs-var hs-var">inpObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderTable
-&gt; Maybe StreamId
-&gt; IO ByteString
-&gt; IORef (Maybe HeaderTable)
-&gt; InpObj
</span><a href="Network.HTTP2.H2.Types.html#InpObj"><span class="hs-identifier hs-var">InpObj</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderTable
</span><a href="#local-6989586621679119467"><span class="hs-identifier hs-var">tbl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamId -&gt; Maybe StreamId
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe HeaderTable)
</span><a href="#local-6989586621679119511"><span class="hs-identifier hs-var">tlr</span></a></span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.HTTP2.H2.Context.html#isServer"><span class="hs-identifier hs-var">isServer</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119469"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-188"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119518"><span class="annot"><span class="annottext">si :: ServerInfo
</span><a href="#local-6989586621679119518"><span class="hs-identifier hs-var hs-var">si</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RoleInfo -&gt; ServerInfo
</span><a href="Network.HTTP2.H2.Context.html#toServerInfo"><span class="hs-identifier hs-var">toServerInfo</span></a></span><span> </span><span class="annot"><span class="annottext">RoleInfo
</span><a href="#local-6989586621679119471"><span class="hs-identifier hs-var">roleInfo</span></a></span><span>
</span><span id="line-190"></span><span>            </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Input Stream) -&gt; Input Stream -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerInfo -&gt; TQueue (Input Stream)
</span><a href="Network.HTTP2.H2.Context.html#inputQ"><span class="hs-identifier hs-var">inputQ</span></a></span><span> </span><span class="annot"><span class="annottext">ServerInfo
</span><a href="#local-6989586621679119518"><span class="hs-identifier hs-var">si</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Input Stream -&gt; STM ()) -&gt; Input Stream -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream -&gt; InpObj -&gt; Input Stream
forall a. a -&gt; InpObj -&gt; Input a
</span><a href="Network.HTTP2.H2.Types.html#Input"><span class="hs-identifier hs-var">Input</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119494"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">InpObj
</span><a href="#local-6989586621679119516"><span class="hs-identifier hs-var">inpObj</span></a></span><span>
</span><span id="line-191"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">MVar (Either SomeException InpObj)
-&gt; Either SomeException InpObj -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; MVar a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar (Either SomeException InpObj)
</span><a href="#local-6989586621679119496"><span class="hs-identifier hs-var">streamInput</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException InpObj -&gt; IO ())
-&gt; Either SomeException InpObj -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InpObj -&gt; Either SomeException InpObj
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">InpObj
</span><a href="#local-6989586621679119516"><span class="hs-identifier hs-var">inpObj</span></a></span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#halfClosedRemote"><span class="hs-identifier hs-var">halfClosedRemote</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119469"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119494"><span class="hs-identifier hs-var">strm</span></a></span><span>
</span><span id="line-193"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">-- Transition (process2)</span><span>
</span><span id="line-196"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#processState"><span class="hs-identifier hs-var">processState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span id="local-6989586621679119526"><span class="annot"><span class="annottext">Maybe ClosedCode
</span><a href="#local-6989586621679119526"><span class="hs-identifier hs-var">hcl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#HasBody"><span class="hs-identifier hs-type">HasBody</span></a></span><span> </span><span id="local-6989586621679119528"><span class="annot"><span class="annottext">tbl :: HeaderTable
</span><a href="#local-6989586621679119528"><span class="hs-identifier hs-var">tbl</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenHeaderList
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119529"><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679119529"><span class="hs-identifier hs-var">reqvt</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679119530"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679119530"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119531"><span id="local-6989586621679119532"><span id="local-6989586621679119533"><span id="local-6989586621679119534"><span id="local-6989586621679119535"><span id="local-6989586621679119536"><span id="local-6989586621679119537"><span id="local-6989586621679119538"><span id="local-6989586621679119539"><span id="local-6989586621679119540"><span id="local-6989586621679119541"><span id="local-6989586621679119542"><span id="local-6989586621679119543"><span id="local-6989586621679119544"><span id="local-6989586621679119545"><span id="local-6989586621679119546"><span id="local-6989586621679119547"><span id="local-6989586621679119548"><span id="local-6989586621679119549"><span id="local-6989586621679119550"><span id="local-6989586621679119551"><span id="local-6989586621679119552"><span id="local-6989586621679119553"><span id="local-6989586621679119554"><span class="annot"><span class="annottext">TVar StreamId
TVar TxFlow
TVar EvenStreamTable
TVar OddStreamTable
IORef Bool
IORef StreamId
IORef (Maybe StreamId)
IORef RxFlow
IORef Settings
SockAddr
Rate
TQueue Control
TQueue (Output Stream)
DynamicTable
Settings
RoleInfo
Role
role :: Context -&gt; Role
roleInfo :: Context -&gt; RoleInfo
mySettings :: Context -&gt; Settings
myFirstSettings :: Context -&gt; IORef Bool
peerSettings :: Context -&gt; IORef Settings
oddStreamTable :: Context -&gt; TVar OddStreamTable
evenStreamTable :: Context -&gt; TVar EvenStreamTable
continued :: Context -&gt; IORef (Maybe StreamId)
myStreamId :: Context -&gt; TVar StreamId
peerStreamId :: Context -&gt; IORef StreamId
outputBufferLimit :: Context -&gt; IORef StreamId
outputQ :: Context -&gt; TQueue (Output Stream)
outputQStreamID :: Context -&gt; TVar StreamId
controlQ :: Context -&gt; TQueue Control
encodeDynamicTable :: Context -&gt; DynamicTable
decodeDynamicTable :: Context -&gt; DynamicTable
txFlow :: Context -&gt; TVar TxFlow
rxFlow :: Context -&gt; IORef RxFlow
pingRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
emptyFrameRate :: Context -&gt; Rate
rstRate :: Context -&gt; Rate
mySockAddr :: Context -&gt; SockAddr
peerSockAddr :: Context -&gt; SockAddr
role :: Role
roleInfo :: RoleInfo
mySettings :: Settings
myFirstSettings :: IORef Bool
peerSettings :: IORef Settings
oddStreamTable :: TVar OddStreamTable
evenStreamTable :: TVar EvenStreamTable
continued :: IORef (Maybe StreamId)
myStreamId :: TVar StreamId
peerStreamId :: IORef StreamId
outputBufferLimit :: IORef StreamId
outputQ :: TQueue (Output Stream)
outputQStreamID :: TVar StreamId
controlQ :: TQueue Control
encodeDynamicTable :: DynamicTable
decodeDynamicTable :: DynamicTable
txFlow :: TVar TxFlow
rxFlow :: IORef RxFlow
pingRate :: Rate
settingsRate :: Rate
emptyFrameRate :: Rate
rstRate :: Rate
mySockAddr :: SockAddr
peerSockAddr :: SockAddr
</span><a href="Network.HTTP2.H2.Context.html#role"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119555"><span class="annot"><span class="annottext">strm :: Stream
</span><a href="#local-6989586621679119555"><span class="hs-identifier hs-var">strm</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119556"><span class="annot"><span class="annottext">MVar (Either SomeException InpObj)
streamInput :: Stream -&gt; MVar (Either SomeException InpObj)
streamInput :: MVar (Either SomeException InpObj)
</span><a href="Network.HTTP2.H2.Types.html#streamInput"><span class="hs-identifier hs-var hs-var">streamInput</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119557"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119557"><span class="hs-identifier hs-var">_streamId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119560"><span class="annot"><span class="annottext">mcl :: Maybe StreamId
</span><a href="#local-6989586621679119560"><span class="hs-identifier hs-var hs-var">mcl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(StreamId, ByteString) -&gt; StreamId
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((StreamId, ByteString) -&gt; StreamId)
-&gt; Maybe (StreamId, ByteString) -&gt; Maybe StreamId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Token -&gt; ValueTable -&gt; Maybe ByteString
</span><a href="Network.HPACK.HeaderBlock.Decode.html#getHeaderValue"><span class="hs-identifier hs-var">getHeaderValue</span></a></span><span> </span><span class="annot"><span class="annottext">Token
</span><a href="Network.HPACK.Token.html#tokenContentLength"><span class="hs-identifier hs-var">tokenContentLength</span></a></span><span> </span><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679119529"><span class="hs-identifier hs-var">reqvt</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
-&gt; (ByteString -&gt; Maybe (StreamId, ByteString))
-&gt; Maybe (StreamId, ByteString)
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe (StreamId, ByteString)
</span><span class="hs-identifier hs-var">C8.readInt</span></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>    </span><span id="local-6989586621679119561"><span class="annot"><span class="annottext">IORef StreamId
</span><a href="#local-6989586621679119561"><span class="hs-identifier hs-var">bodyLength</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; IO (IORef StreamId)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">0</span></span><span>
</span><span id="line-199"></span><span>    </span><span id="local-6989586621679119562"><span class="annot"><span class="annottext">IORef (Maybe HeaderTable)
</span><a href="#local-6989586621679119562"><span class="hs-identifier hs-var">tlr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe HeaderTable -&gt; IO (IORef (Maybe HeaderTable))
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Maybe HeaderTable
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-200"></span><span>    </span><span id="local-6989586621679119563"><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
</span><a href="#local-6989586621679119563"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TQueue (Either SomeException ByteString))
forall (m :: * -&gt; *) a. MonadIO m =&gt; m (TQueue a)
</span><span class="hs-identifier hs-var">newTQueueIO</span></span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; StreamState -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#setStreamState"><span class="hs-identifier hs-var">setStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119530"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119555"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">(StreamState -&gt; IO ()) -&gt; StreamState -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode -&gt; OpenState -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><a href="#local-6989586621679119526"><span class="hs-identifier hs-var">hcl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
-&gt; Maybe StreamId
-&gt; IORef StreamId
-&gt; IORef (Maybe HeaderTable)
-&gt; OpenState
</span><a href="Network.HTTP2.H2.Types.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
</span><a href="#local-6989586621679119563"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe StreamId
</span><a href="#local-6989586621679119560"><span class="hs-identifier hs-var">mcl</span></a></span><span> </span><span class="annot"><span class="annottext">IORef StreamId
</span><a href="#local-6989586621679119561"><span class="hs-identifier hs-var">bodyLength</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe HeaderTable)
</span><a href="#local-6989586621679119562"><span class="hs-identifier hs-var">tlr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>    </span><span class="hs-comment">-- FLOW CONTROL: WINDOW_UPDATE 0: recv: announcing my limit properly</span><span>
</span><span id="line-203"></span><span>    </span><span class="hs-comment">-- FLOW CONTROL: WINDOW_UPDATE: recv: announcing my limit properly</span><span>
</span><span id="line-204"></span><span>    </span><span id="local-6989586621679119567"><span class="annot"><span class="annottext">Source
</span><a href="#local-6989586621679119567"><span class="hs-identifier hs-var">bodySource</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
-&gt; (StreamId -&gt; IO ()) -&gt; IO Source
</span><a href="Network.HTTP2.H2.Receiver.html#mkSource"><span class="hs-identifier hs-var">mkSource</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
</span><a href="#local-6989586621679119563"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">((StreamId -&gt; IO ()) -&gt; IO Source)
-&gt; (StreamId -&gt; IO ()) -&gt; IO Source
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; StreamId -&gt; IO ()
</span><a href="Network.HTTP2.H2.Window.html#informWindowUpdate"><span class="hs-identifier hs-var">informWindowUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119530"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119555"><span class="hs-identifier hs-var">strm</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119570"><span class="annot"><span class="annottext">inpObj :: InpObj
</span><a href="#local-6989586621679119570"><span class="hs-identifier hs-var hs-var">inpObj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HeaderTable
-&gt; Maybe StreamId
-&gt; IO ByteString
-&gt; IORef (Maybe HeaderTable)
-&gt; InpObj
</span><a href="Network.HTTP2.H2.Types.html#InpObj"><span class="hs-identifier hs-var">InpObj</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderTable
</span><a href="#local-6989586621679119528"><span class="hs-identifier hs-var">tbl</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe StreamId
</span><a href="#local-6989586621679119560"><span class="hs-identifier hs-var">mcl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Source -&gt; IO ByteString
</span><a href="Network.HTTP2.H2.Receiver.html#readSource"><span class="hs-identifier hs-var">readSource</span></a></span><span> </span><span class="annot"><span class="annottext">Source
</span><a href="#local-6989586621679119567"><span class="hs-identifier hs-var">bodySource</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe HeaderTable)
</span><a href="#local-6989586621679119562"><span class="hs-identifier hs-var">tlr</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.HTTP2.H2.Context.html#isServer"><span class="hs-identifier hs-var">isServer</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119530"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-207"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119572"><span class="annot"><span class="annottext">si :: ServerInfo
</span><a href="#local-6989586621679119572"><span class="hs-identifier hs-var hs-var">si</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RoleInfo -&gt; ServerInfo
</span><a href="Network.HTTP2.H2.Context.html#toServerInfo"><span class="hs-identifier hs-var">toServerInfo</span></a></span><span> </span><span class="annot"><span class="annottext">RoleInfo
</span><a href="#local-6989586621679119532"><span class="hs-identifier hs-var">roleInfo</span></a></span><span>
</span><span id="line-209"></span><span>            </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Input Stream) -&gt; Input Stream -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerInfo -&gt; TQueue (Input Stream)
</span><a href="Network.HTTP2.H2.Context.html#inputQ"><span class="hs-identifier hs-var">inputQ</span></a></span><span> </span><span class="annot"><span class="annottext">ServerInfo
</span><a href="#local-6989586621679119572"><span class="hs-identifier hs-var">si</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Input Stream -&gt; STM ()) -&gt; Input Stream -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stream -&gt; InpObj -&gt; Input Stream
forall a. a -&gt; InpObj -&gt; Input a
</span><a href="Network.HTTP2.H2.Types.html#Input"><span class="hs-identifier hs-var">Input</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119555"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">InpObj
</span><a href="#local-6989586621679119570"><span class="hs-identifier hs-var">inpObj</span></a></span><span>
</span><span id="line-210"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">MVar (Either SomeException InpObj)
-&gt; Either SomeException InpObj -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; MVar a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar (Either SomeException InpObj)
</span><a href="#local-6989586621679119556"><span class="hs-identifier hs-var">streamInput</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException InpObj -&gt; IO ())
-&gt; Either SomeException InpObj -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">InpObj -&gt; Either SomeException InpObj
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">InpObj
</span><a href="#local-6989586621679119570"><span class="hs-identifier hs-var">inpObj</span></a></span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="hs-comment">-- Transition (process3)</span><span>
</span><span id="line-214"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#processState"><span class="hs-identifier hs-var">processState</span></a></span><span> </span><span id="local-6989586621679119573"><span class="annot"><span class="annottext">s :: StreamState
</span><a href="#local-6989586621679119573"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Continued"><span class="hs-identifier hs-type">Continued</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679119575"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119575"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679119576"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119576"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span id="local-6989586621679119577"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119577"><span class="hs-identifier hs-var">_streamId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; StreamState -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#setStreamState"><span class="hs-identifier hs-var">setStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119575"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119576"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119573"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="hs-comment">-- Transition (process4)</span><span>
</span><span id="line-219"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#processState"><span class="hs-identifier hs-var">processState</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="Network.HTTP2.H2.Types.html#HalfClosedRemote"><span class="hs-identifier hs-var">HalfClosedRemote</span></a></span><span> </span><span id="local-6989586621679119579"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119579"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679119580"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119580"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span id="local-6989586621679119581"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119581"><span class="hs-identifier hs-var">_streamId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#halfClosedRemote"><span class="hs-identifier hs-var">halfClosedRemote</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119579"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119580"><span class="hs-identifier hs-var">strm</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="hs-comment">-- Transition (process5)</span><span>
</span><span id="line-224"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#processState"><span class="hs-identifier hs-var">processState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Closed"><span class="hs-identifier hs-type">Closed</span></a></span><span> </span><span id="local-6989586621679119583"><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679119583"><span class="hs-identifier hs-var">cc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679119584"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119584"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679119585"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119585"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span id="local-6989586621679119586"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119586"><span class="hs-identifier hs-var">_streamId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; ClosedCode -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#closed"><span class="hs-identifier hs-var">closed</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119584"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119585"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679119583"><span class="hs-identifier hs-var">cc</span></a></span><span>
</span><span id="line-226"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="hs-comment">-- Transition (process6)</span><span>
</span><span id="line-229"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#processState"><span class="hs-identifier hs-var">processState</span></a></span><span> </span><span id="local-6989586621679119588"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119588"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679119589"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119589"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679119590"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119590"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span id="local-6989586621679119591"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119591"><span class="hs-identifier hs-var">_streamId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>    </span><span class="hs-comment">-- Idle, Open Body, Closed</span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; StreamState -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#setStreamState"><span class="hs-identifier hs-var">setStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119589"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119590"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119588"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span class="hs-comment">{- FOURMOLU_DISABLE -}</span><span>
</span><span id="line-237"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#getStream"><span class="hs-identifier hs-type">getStream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameType"><span class="hs-identifier hs-type">FrameType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span id="getStream"><span class="annot"><span class="annottext">getStream :: Context -&gt; FrameType -&gt; StreamId -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.H2.Receiver.html#getStream"><span class="hs-identifier hs-var hs-var">getStream</span></a></span></span><span> </span><span id="local-6989586621679119592"><span class="annot"><span class="annottext">ctx :: Context
</span><a href="#local-6989586621679119592"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119593"><span id="local-6989586621679119594"><span id="local-6989586621679119595"><span id="local-6989586621679119596"><span id="local-6989586621679119597"><span id="local-6989586621679119598"><span id="local-6989586621679119599"><span id="local-6989586621679119600"><span id="local-6989586621679119601"><span id="local-6989586621679119602"><span id="local-6989586621679119603"><span id="local-6989586621679119604"><span id="local-6989586621679119605"><span id="local-6989586621679119606"><span id="local-6989586621679119607"><span id="local-6989586621679119608"><span id="local-6989586621679119609"><span id="local-6989586621679119610"><span id="local-6989586621679119611"><span id="local-6989586621679119612"><span id="local-6989586621679119613"><span id="local-6989586621679119614"><span id="local-6989586621679119615"><span id="local-6989586621679119616"><span class="annot"><span class="annottext">TVar StreamId
TVar TxFlow
TVar EvenStreamTable
TVar OddStreamTable
IORef Bool
IORef StreamId
IORef (Maybe StreamId)
IORef RxFlow
IORef Settings
SockAddr
Rate
TQueue Control
TQueue (Output Stream)
DynamicTable
Settings
RoleInfo
Role
role :: Context -&gt; Role
roleInfo :: Context -&gt; RoleInfo
mySettings :: Context -&gt; Settings
myFirstSettings :: Context -&gt; IORef Bool
peerSettings :: Context -&gt; IORef Settings
oddStreamTable :: Context -&gt; TVar OddStreamTable
evenStreamTable :: Context -&gt; TVar EvenStreamTable
continued :: Context -&gt; IORef (Maybe StreamId)
myStreamId :: Context -&gt; TVar StreamId
peerStreamId :: Context -&gt; IORef StreamId
outputBufferLimit :: Context -&gt; IORef StreamId
outputQ :: Context -&gt; TQueue (Output Stream)
outputQStreamID :: Context -&gt; TVar StreamId
controlQ :: Context -&gt; TQueue Control
encodeDynamicTable :: Context -&gt; DynamicTable
decodeDynamicTable :: Context -&gt; DynamicTable
txFlow :: Context -&gt; TVar TxFlow
rxFlow :: Context -&gt; IORef RxFlow
pingRate :: Context -&gt; Rate
settingsRate :: Context -&gt; Rate
emptyFrameRate :: Context -&gt; Rate
rstRate :: Context -&gt; Rate
mySockAddr :: Context -&gt; SockAddr
peerSockAddr :: Context -&gt; SockAddr
role :: Role
roleInfo :: RoleInfo
mySettings :: Settings
myFirstSettings :: IORef Bool
peerSettings :: IORef Settings
oddStreamTable :: TVar OddStreamTable
evenStreamTable :: TVar EvenStreamTable
continued :: IORef (Maybe StreamId)
myStreamId :: TVar StreamId
peerStreamId :: IORef StreamId
outputBufferLimit :: IORef StreamId
outputQ :: TQueue (Output Stream)
outputQStreamID :: TVar StreamId
controlQ :: TQueue Control
encodeDynamicTable :: DynamicTable
decodeDynamicTable :: DynamicTable
txFlow :: TVar TxFlow
rxFlow :: IORef RxFlow
pingRate :: Rate
settingsRate :: Rate
emptyFrameRate :: Rate
rstRate :: Rate
mySockAddr :: SockAddr
peerSockAddr :: SockAddr
</span><a href="Network.HTTP2.H2.Context.html#role"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119617"><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119617"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span> </span><span id="local-6989586621679119618"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119618"><span class="hs-identifier hs-var">streamId</span></a></span></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119619"><span class="hs-identifier hs-var">isEven</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar EvenStreamTable -&gt; StreamId -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.H2.StreamTable.html#lookupEven"><span class="hs-identifier hs-var">lookupEven</span></a></span><span> </span><span class="annot"><span class="annottext">TVar EvenStreamTable
</span><a href="#local-6989586621679119599"><span class="hs-identifier hs-var">evenStreamTable</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119618"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe Stream)
-&gt; (Maybe Stream -&gt; IO (Maybe Stream)) -&gt; IO (Maybe Stream)
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; FrameType -&gt; Maybe Stream -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.H2.Receiver.html#getEvenStream"><span class="hs-identifier hs-var">getEvenStream</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119592"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119617"><span class="hs-identifier hs-var">ftyp</span></a></span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar OddStreamTable -&gt; StreamId -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.H2.StreamTable.html#lookupOdd"><span class="hs-identifier hs-var">lookupOdd</span></a></span><span> </span><span class="annot"><span class="annottext">TVar OddStreamTable
</span><a href="#local-6989586621679119598"><span class="hs-identifier hs-var">oddStreamTable</span></a></span><span>  </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119618"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe Stream)
-&gt; (Maybe Stream -&gt; IO (Maybe Stream)) -&gt; IO (Maybe Stream)
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; FrameType -&gt; StreamId -&gt; Maybe Stream -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.H2.Receiver.html#getOddStream"><span class="hs-identifier hs-var">getOddStream</span></a></span><span>  </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119592"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119617"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119618"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-242"></span><span>    </span><span id="local-6989586621679119619"><span class="annot"><span class="annottext">isEven :: Bool
</span><a href="#local-6989586621679119619"><span class="hs-identifier hs-var hs-var">isEven</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#isServerInitiated"><span class="hs-identifier hs-var">isServerInitiated</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119618"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-243"></span><span class="hs-comment">{- FOURMOLU_ENABLE -}</span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#getEvenStream"><span class="hs-identifier hs-type">getEvenStream</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameType"><span class="hs-identifier hs-type">FrameType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span id="getEvenStream"><span class="annot"><span class="annottext">getEvenStream :: Context -&gt; FrameType -&gt; Maybe Stream -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.H2.Receiver.html#getEvenStream"><span class="hs-identifier hs-var hs-var">getEvenStream</span></a></span></span><span> </span><span id="local-6989586621679119624"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119624"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679119625"><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119625"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span> </span><span id="local-6989586621679119626"><span class="annot"><span class="annottext">js :: Maybe Stream
</span><a href="#local-6989586621679119626"><span class="hs-identifier hs-var">js</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119627"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119627"><span class="hs-identifier hs-var">strm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119625"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; FrameType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-248"></span><span>        </span><span id="local-6989586621679119629"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119629"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stream -&gt; IO StreamState
</span><a href="Network.HTTP2.H2.Stream.html#readStreamState"><span class="hs-identifier hs-var">readStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119627"><span class="hs-identifier hs-var">strm</span></a></span><span>
</span><span id="line-249"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamState -&gt; Bool
</span><a href="Network.HTTP2.H2.Stream.html#isReserved"><span class="hs-identifier hs-var">isReserved</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119629"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; ClosedCode -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#halfClosedLocal"><span class="hs-identifier hs-var">halfClosedLocal</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119624"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119627"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="Network.HTTP2.H2.Types.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><span class="annottext">Maybe Stream -&gt; IO (Maybe Stream)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Stream
</span><a href="#local-6989586621679119626"><span class="hs-identifier hs-var">js</span></a></span><span>
</span><span id="line-251"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#getEvenStream"><span class="hs-identifier hs-var">getEvenStream</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe Stream
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Stream -&gt; IO (Maybe Stream)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Stream
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#getOddStream"><span class="hs-identifier hs-type">getOddStream</span></a></span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameType"><span class="hs-identifier hs-type">FrameType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span id="getOddStream"><span class="annot"><span class="annottext">getOddStream :: Context
-&gt; FrameType -&gt; StreamId -&gt; Maybe Stream -&gt; IO (Maybe Stream)
</span><a href="Network.HTTP2.H2.Receiver.html#getOddStream"><span class="hs-identifier hs-var hs-var">getOddStream</span></a></span></span><span> </span><span id="local-6989586621679119633"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119633"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679119634"><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119634"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span> </span><span id="local-6989586621679119635"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119635"><span class="hs-identifier hs-var">streamId</span></a></span></span><span> </span><span id="local-6989586621679119636"><span class="annot"><span class="annottext">js :: Maybe Stream
</span><a href="#local-6989586621679119636"><span class="hs-identifier hs-var">js</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119637"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119637"><span class="hs-identifier hs-var">strm0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119634"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; FrameType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-257"></span><span>        </span><span id="local-6989586621679119638"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119638"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stream -&gt; IO StreamState
</span><a href="Network.HTTP2.H2.Stream.html#readStreamState"><span class="hs-identifier hs-var">readStreamState</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119637"><span class="hs-identifier hs-var">strm0</span></a></span><span>
</span><span id="line-258"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamState -&gt; Bool
</span><a href="Network.HTTP2.H2.Stream.html#isHalfClosedRemote"><span class="hs-identifier hs-var">isHalfClosedRemote</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119638"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-259"></span><span>            </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-260"></span><span>                </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span>
</span><span id="line-261"></span><span>                    </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#StreamClosed"><span class="hs-identifier hs-var">StreamClosed</span></a></span><span>
</span><span id="line-262"></span><span>                    </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119635"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-263"></span><span>                    </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;header must not be sent to half or fully closed stream&quot;</span></span><span>
</span><span id="line-264"></span><span>        </span><span class="hs-comment">-- Priority made an idle stream</span><span>
</span><span id="line-265"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamState -&gt; Bool
</span><a href="Network.HTTP2.H2.Stream.html#isIdle"><span class="hs-identifier hs-var">isIdle</span></a></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119638"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#opened"><span class="hs-identifier hs-var">opened</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119633"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119637"><span class="hs-identifier hs-var">strm0</span></a></span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><span class="annottext">Maybe Stream -&gt; IO (Maybe Stream)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Stream
</span><a href="#local-6989586621679119636"><span class="hs-identifier hs-var">js</span></a></span><span>
</span><span id="line-267"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#getOddStream"><span class="hs-identifier hs-var">getOddStream</span></a></span><span> </span><span id="local-6989586621679119643"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119643"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679119644"><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119644"><span class="hs-identifier hs-var">ftyp</span></a></span></span><span> </span><span id="local-6989586621679119645"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119645"><span class="hs-identifier hs-var">streamId</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe Stream
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.HTTP2.H2.Context.html#isServer"><span class="hs-identifier hs-var">isServer</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119643"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-269"></span><span>        </span><span id="local-6989586621679119646"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119646"><span class="hs-identifier hs-var">csid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO StreamId
</span><a href="Network.HTTP2.H2.Context.html#getPeerStreamID"><span class="hs-identifier hs-var">getPeerStreamID</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119643"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-270"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119645"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119646"><span class="hs-identifier hs-var">csid</span></a></span><span> </span><span class="hs-comment">-- consider the stream closed</span><span>
</span><span id="line-271"></span><span>            </span><span class="hs-keyword">then</span><span>
</span><span id="line-272"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119644"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; [FrameType] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameWindowUpdate"><span class="hs-identifier hs-var">FrameWindowUpdate</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameRSTStream"><span class="hs-identifier hs-var">FrameRSTStream</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FramePriority"><span class="hs-identifier hs-var">FramePriority</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-273"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe Stream -&gt; IO (Maybe Stream)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Stream
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-comment">-- will be ignored</span><span>
</span><span id="line-274"></span><span>                    </span><span class="hs-keyword">else</span><span>
</span><span id="line-275"></span><span>                        </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO (Maybe Stream)
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO (Maybe Stream))
-&gt; HTTP2Error -&gt; IO (Maybe Stream)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-276"></span><span>                            </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span>
</span><span id="line-277"></span><span>                                </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span>
</span><span id="line-278"></span><span>                                </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119645"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-279"></span><span>                                </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;stream identifier must not decrease&quot;</span></span><span>
</span><span id="line-280"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-281"></span><span>                </span><span class="hs-comment">-- consider the stream idle</span><span>
</span><span id="line-282"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119644"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; [FrameType] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FramePriority"><span class="hs-identifier hs-var">FramePriority</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-283"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119652"><span class="annot"><span class="annottext">errmsg :: ReasonPhrase
</span><a href="#local-6989586621679119652"><span class="hs-identifier hs-var hs-var">errmsg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-284"></span><span>                            </span><span class="annot"><span class="annottext">ByteString -&gt; ReasonPhrase
</span><span class="hs-identifier hs-var">Short.toShort</span></span><span>
</span><span id="line-285"></span><span>                                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;this frame is not allowed in an idle stream: &quot;</span></span><span>
</span><span id="line-286"></span><span>                                    </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
</span><span class="hs-operator hs-var">`BS.append`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; ByteString
</span><span class="hs-identifier hs-var">C8.pack</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameType -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119644"><span class="hs-identifier hs-var">ftyp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>                                </span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>                    </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119645"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><a href="#local-6989586621679119652"><span class="hs-identifier hs-var">errmsg</span></a></span><span>
</span><span id="line-289"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119644"><span class="hs-identifier hs-var">ftyp</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; FrameType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; StreamId -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#setPeerStreamID"><span class="hs-identifier hs-var">setPeerStreamID</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119643"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119645"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-290"></span><span>                </span><span class="hs-comment">-- FLOW CONTROL: SETTINGS_MAX_CONCURRENT_STREAMS: recv: rejecting if over my limit</span><span>
</span><span id="line-291"></span><span>                </span><span class="annot"><span class="annottext">Stream -&gt; Maybe Stream
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Stream -&gt; Maybe Stream) -&gt; IO Stream -&gt; IO (Maybe Stream)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; StreamId -&gt; FrameType -&gt; IO Stream
</span><a href="Network.HTTP2.H2.Context.html#openOddStreamCheck"><span class="hs-identifier hs-var">openOddStreamCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119643"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119645"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119644"><span class="hs-identifier hs-var">ftyp</span></a></span><span>
</span><span id="line-292"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Maybe Stream)
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span> </span><span class="hs-comment">-- never reach</span><span>
</span><span id="line-293"></span><span>
</span><span id="line-294"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span class="hs-keyword">type</span><span> </span><span id="Payload"><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#Payload"><span class="hs-identifier hs-var">Payload</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#control"><span class="hs-identifier hs-type">control</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameType"><span class="hs-identifier hs-type">FrameType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#Payload"><span class="hs-identifier hs-type">Payload</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span id="control"><span class="annot"><span class="annottext">control :: FrameType -&gt; FrameHeader -&gt; ByteString -&gt; Context -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#control"><span class="hs-identifier hs-var hs-var">control</span></a></span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameSettings"><span class="hs-identifier hs-var">FrameSettings</span></a></span><span> </span><span id="local-6989586621679119662"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679119662"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119663"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameFlags
flags :: FrameHeader -&gt; FrameFlags
</span><a href="#local-6989586621679119663"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119665"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119666"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119666"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119667"><span class="annot"><span class="annottext">IORef Bool
myFirstSettings :: Context -&gt; IORef Bool
myFirstSettings :: IORef Bool
</span><a href="Network.HTTP2.H2.Context.html#myFirstSettings"><span class="hs-identifier hs-var hs-var">myFirstSettings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119668"><span class="annot"><span class="annottext">TQueue Control
controlQ :: Context -&gt; TQueue Control
controlQ :: TQueue Control
</span><a href="Network.HTTP2.H2.Context.html#controlQ"><span class="hs-identifier hs-var hs-var">controlQ</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119669"><span class="annot"><span class="annottext">Rate
settingsRate :: Context -&gt; Rate
settingsRate :: Rate
</span><a href="Network.HTTP2.H2.Context.html#settingsRate"><span class="hs-identifier hs-var hs-var">settingsRate</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119670"><span class="annot"><span class="annottext">Settings
mySettings :: Context -&gt; Settings
mySettings :: Settings
</span><a href="Network.HTTP2.H2.Context.html#mySettings"><span class="hs-identifier hs-var hs-var">mySettings</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119671"><span class="annot"><span class="annottext">IORef RxFlow
rxFlow :: Context -&gt; IORef RxFlow
rxFlow :: IORef RxFlow
</span><a href="Network.HTTP2.H2.Context.html#rxFlow"><span class="hs-identifier hs-var hs-var">rxFlow</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#SettingsFrame"><span class="hs-identifier hs-type">SettingsFrame</span></a></span><span> </span><span id="local-6989586621679119673"><span class="annot"><span class="annottext">SettingsList
</span><a href="#local-6989586621679119673"><span class="hs-identifier hs-var">peerAlist</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a. Either FrameDecodeError a -&gt; IO a
</span><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either FrameDecodeError FramePayload -&gt; IO FramePayload)
-&gt; Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeSettingsFrame"><span class="hs-identifier hs-var">decodeSettingsFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119662"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119666"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO Any) -&gt; Maybe HTTP2Error -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f ()
</span><span class="hs-identifier hs-var">traverse_</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO Any
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(Maybe HTTP2Error -&gt; IO ()) -&gt; Maybe HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SettingsList -&gt; Maybe HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#checkSettingsList"><span class="hs-identifier hs-var">checkSettingsList</span></a></span><span> </span><span class="annot"><span class="annottext">SettingsList
</span><a href="#local-6989586621679119673"><span class="hs-identifier hs-var">peerAlist</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testAck"><span class="hs-identifier hs-var">testAck</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679119663"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-304"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SettingsList
</span><a href="#local-6989586621679119673"><span class="hs-identifier hs-var">peerAlist</span></a></span><span> </span><span class="annot"><span class="annottext">SettingsList -&gt; SettingsList -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-305"></span><span>                </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-306"></span><span>                    </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#FrameSizeError"><span class="hs-identifier hs-var">FrameSizeError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119665"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;ack settings has a body&quot;</span></span><span>
</span><span id="line-307"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-308"></span><span>            </span><span class="hs-comment">-- Settings Flood - CVE-2019-9515</span><span>
</span><span id="line-309"></span><span>            </span><span id="local-6989586621679119678"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119678"><span class="hs-identifier hs-var">rate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rate -&gt; IO StreamId
</span><span class="hs-identifier hs-var">getRate</span></span><span> </span><span class="annot"><span class="annottext">Rate
</span><a href="#local-6989586621679119669"><span class="hs-identifier hs-var">settingsRate</span></a></span><span>
</span><span id="line-310"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119678"><span class="hs-identifier hs-var">rate</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#settingsRateLimit"><span class="hs-identifier hs-var">settingsRateLimit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-311"></span><span>                </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-312"></span><span>                    </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#EnhanceYourCalm"><span class="hs-identifier hs-var">EnhanceYourCalm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119665"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;too many settings&quot;</span></span><span>
</span><span id="line-313"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119681"><span class="annot"><span class="annottext">ack :: ByteString
</span><a href="#local-6989586621679119681"><span class="hs-identifier hs-var hs-var">ack</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FrameFlags -&gt; FrameFlags) -&gt; SettingsList -&gt; ByteString
</span><a href="Network.HTTP2.H2.EncodeFrame.html#settingsFrame"><span class="hs-identifier hs-var">settingsFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; FrameFlags
</span><a href="Network.HTTP2.Frame.Types.html#setAck"><span class="hs-identifier hs-var">setAck</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-314"></span><span>            </span><span id="local-6989586621679119684"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119684"><span class="hs-identifier hs-var">sent</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Bool -&gt; IO Bool
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679119667"><span class="hs-identifier hs-var">myFirstSettings</span></a></span><span>
</span><span id="line-315"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119684"><span class="hs-identifier hs-var">sent</span></a></span><span>
</span><span id="line-316"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-317"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119685"><span class="annot"><span class="annottext">setframe :: Control
</span><a href="#local-6989586621679119685"><span class="hs-identifier hs-var hs-var">setframe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe SettingsList -&gt; [ByteString] -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFrames"><span class="hs-identifier hs-var">CFrames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SettingsList -&gt; Maybe SettingsList
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SettingsList
</span><a href="#local-6989586621679119673"><span class="hs-identifier hs-var">peerAlist</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119681"><span class="hs-identifier hs-var">ack</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-318"></span><span>                    </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119668"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">Control
</span><a href="#local-6989586621679119685"><span class="hs-identifier hs-var">setframe</span></a></span><span>
</span><span id="line-319"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-320"></span><span>                    </span><span class="hs-comment">-- Server side only</span><span>
</span><span id="line-321"></span><span>                    </span><span id="local-6989586621679119686"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119686"><span class="hs-identifier hs-var">connRxWS</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RxFlow -&gt; StreamId
</span><span class="hs-identifier hs-var">rxfWindow</span></span><span> </span><span class="annot"><span class="annottext">(RxFlow -&gt; StreamId) -&gt; IO RxFlow -&gt; IO StreamId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef RxFlow -&gt; IO RxFlow
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef RxFlow
</span><a href="#local-6989586621679119671"><span class="hs-identifier hs-var">rxFlow</span></a></span><span>
</span><span id="line-322"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119688"><span class="annot"><span class="annottext">frames :: [ByteString]
</span><a href="#local-6989586621679119688"><span class="hs-identifier hs-var hs-var">frames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; StreamId -&gt; [ByteString]
</span><a href="Network.HTTP2.H2.Settings.html#makeNegotiationFrames"><span class="hs-identifier hs-var">makeNegotiationFrames</span></a></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621679119670"><span class="hs-identifier hs-var">mySettings</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119686"><span class="hs-identifier hs-var">connRxWS</span></a></span><span>
</span><span id="line-323"></span><span>                        </span><span id="local-6989586621679119690"><span class="annot"><span class="annottext">setframe :: Control
</span><a href="#local-6989586621679119690"><span class="hs-identifier hs-var hs-var">setframe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe SettingsList -&gt; [ByteString] -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFrames"><span class="hs-identifier hs-var">CFrames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SettingsList -&gt; Maybe SettingsList
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SettingsList
</span><a href="#local-6989586621679119673"><span class="hs-identifier hs-var">peerAlist</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679119688"><span class="hs-identifier hs-var">frames</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; [ByteString] -&gt; [ByteString]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119681"><span class="hs-identifier hs-var">ack</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>                    </span><span class="annot"><span class="annottext">IORef Bool -&gt; Bool -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679119667"><span class="hs-identifier hs-var">myFirstSettings</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-325"></span><span>                    </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119668"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">Control
</span><a href="#local-6989586621679119690"><span class="hs-identifier hs-var">setframe</span></a></span><span>
</span><span id="line-326"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#control"><span class="hs-identifier hs-var">control</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FramePing"><span class="hs-identifier hs-var">FramePing</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119692"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameHeader -&gt; FrameFlags
flags :: FrameFlags
</span><a href="Network.HTTP2.Frame.Types.html#flags"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119693"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119694"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119694"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119695"><span class="annot"><span class="annottext">TQueue Control
controlQ :: Context -&gt; TQueue Control
controlQ :: TQueue Control
</span><a href="Network.HTTP2.H2.Context.html#controlQ"><span class="hs-identifier hs-var hs-var">controlQ</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119696"><span class="annot"><span class="annottext">Rate
pingRate :: Context -&gt; Rate
pingRate :: Rate
</span><a href="Network.HTTP2.H2.Context.html#pingRate"><span class="hs-identifier hs-var hs-var">pingRate</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testAck"><span class="hs-identifier hs-var">testAck</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679119692"><span class="hs-identifier hs-var">flags</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>        </span><span class="hs-comment">-- Ping Flood - CVE-2019-9512</span><span>
</span><span id="line-329"></span><span>        </span><span id="local-6989586621679119698"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119698"><span class="hs-identifier hs-var">rate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rate -&gt; IO StreamId
</span><span class="hs-identifier hs-var">getRate</span></span><span> </span><span class="annot"><span class="annottext">Rate
</span><a href="#local-6989586621679119696"><span class="hs-identifier hs-var">pingRate</span></a></span><span>
</span><span id="line-330"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119698"><span class="hs-identifier hs-var">rate</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#pingRateLimit"><span class="hs-identifier hs-var">pingRateLimit</span></a></span><span>
</span><span id="line-331"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#EnhanceYourCalm"><span class="hs-identifier hs-var">EnhanceYourCalm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119693"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;too many ping&quot;</span></span><span>
</span><span id="line-332"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-333"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119699"><span class="annot"><span class="annottext">frame :: ByteString
</span><a href="#local-6989586621679119699"><span class="hs-identifier hs-var hs-var">frame</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><a href="Network.HTTP2.H2.EncodeFrame.html#pingFrame"><span class="hs-identifier hs-var">pingFrame</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119694"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-334"></span><span>                </span><span class="annot"><span class="annottext">TQueue Control -&gt; Control -&gt; IO ()
</span><a href="Network.HTTP2.H2.Queue.html#enqueueControl"><span class="hs-identifier hs-var">enqueueControl</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue Control
</span><a href="#local-6989586621679119695"><span class="hs-identifier hs-var">controlQ</span></a></span><span> </span><span class="annot"><span class="annottext">(Control -&gt; IO ()) -&gt; Control -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe SettingsList -&gt; [ByteString] -&gt; Control
</span><a href="Network.HTTP2.H2.Types.html#CFrames"><span class="hs-identifier hs-var">CFrames</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe SettingsList
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119699"><span class="hs-identifier hs-var">frame</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-335"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#control"><span class="hs-identifier hs-var">control</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameGoAway"><span class="hs-identifier hs-var">FrameGoAway</span></a></span><span> </span><span id="local-6989586621679119702"><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119702"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621679119703"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119703"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-336"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#GoAwayFrame"><span class="hs-identifier hs-type">GoAwayFrame</span></a></span><span> </span><span id="local-6989586621679119705"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119705"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span id="local-6989586621679119706"><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119706"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span id="local-6989586621679119707"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119707"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a. Either FrameDecodeError a -&gt; IO a
</span><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either FrameDecodeError FramePayload -&gt; IO FramePayload)
-&gt; Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeGoAwayFrame"><span class="hs-identifier hs-var">decodeGoAwayFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119702"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119703"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119706"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; ErrorCode -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#NoError"><span class="hs-identifier hs-var">NoError</span></a></span><span>
</span><span id="line-338"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionIsClosed"><span class="hs-identifier hs-var">ConnectionIsClosed</span></a></span><span>
</span><span id="line-339"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsReceived"><span class="hs-identifier hs-var">ConnectionErrorIsReceived</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119706"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119705"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">(ReasonPhrase -&gt; HTTP2Error) -&gt; ReasonPhrase -&gt; HTTP2Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ReasonPhrase
</span><span class="hs-identifier hs-var">Short.toShort</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119707"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-340"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#control"><span class="hs-identifier hs-var">control</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameWindowUpdate"><span class="hs-identifier hs-var">FrameWindowUpdate</span></a></span><span> </span><span id="local-6989586621679119710"><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119710"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621679119711"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119711"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621679119712"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119712"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#WindowUpdateFrame"><span class="hs-identifier hs-type">WindowUpdateFrame</span></a></span><span> </span><span id="local-6989586621679119714"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119714"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a. Either FrameDecodeError a -&gt; IO a
</span><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either FrameDecodeError FramePayload -&gt; IO FramePayload)
-&gt; Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeWindowUpdateFrame"><span class="hs-identifier hs-var">decodeWindowUpdateFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119710"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119711"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-342"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; StreamId -&gt; IO ()
</span><a href="Network.HTTP2.H2.Window.html#increaseConnectionWindowSize"><span class="hs-identifier hs-var">increaseConnectionWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119712"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119714"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-343"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#control"><span class="hs-identifier hs-var">control</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-344"></span><span>    </span><span class="hs-comment">-- must not reach here</span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span class="hs-comment">-- Called in client only</span><span>
</span><span id="line-350"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#push"><span class="hs-identifier hs-type">push</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span id="push"><span class="annot"><span class="annottext">push :: FrameHeader -&gt; ByteString -&gt; Context -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#push"><span class="hs-identifier hs-var hs-var">push</span></a></span></span><span> </span><span id="local-6989586621679119717"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679119717"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119718"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119719"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119719"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621679119720"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119720"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#PushPromiseFrame"><span class="hs-identifier hs-type">PushPromiseFrame</span></a></span><span> </span><span id="local-6989586621679119722"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119722"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span id="local-6989586621679119723"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119723"><span class="hs-identifier hs-var">frag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a. Either FrameDecodeError a -&gt; IO a
</span><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either FrameDecodeError FramePayload -&gt; IO FramePayload)
-&gt; Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodePushPromiseFrame"><span class="hs-identifier hs-var">decodePushPromiseFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119717"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119719"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamId -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#isServerInitiated"><span class="hs-identifier hs-var">isServerInitiated</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119722"><span class="hs-identifier hs-var">sid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-354"></span><span>        </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-355"></span><span>            </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span>
</span><span id="line-356"></span><span>                </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span>
</span><span id="line-357"></span><span>                </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119718"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-358"></span><span>                </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;push promise must specify an even stream identifier&quot;</span></span><span>
</span><span id="line-359"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119723"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-360"></span><span>        </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-361"></span><span>            </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span>
</span><span id="line-362"></span><span>                </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span>
</span><span id="line-363"></span><span>                </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119718"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-364"></span><span>                </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;wrong header fragment for push promise&quot;</span></span><span>
</span><span id="line-365"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenHeaderList
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119725"><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679119725"><span class="hs-identifier hs-var">vt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; StreamId -&gt; Context -&gt; IO HeaderTable
</span><a href="Network.HTTP2.H2.HPACK.html#hpackDecodeHeader"><span class="hs-identifier hs-var">hpackDecodeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119723"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119718"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119720"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-366"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#ClientInfo"><span class="hs-identifier hs-type">ClientInfo</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119728"><span id="local-6989586621679119729"><span class="annot"><span class="annottext">ByteString
scheme :: ByteString
authority :: ByteString
scheme :: ClientInfo -&gt; ByteString
authority :: ClientInfo -&gt; ByteString
</span><a href="#local-6989586621679119728"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RoleInfo -&gt; ClientInfo
</span><a href="Network.HTTP2.H2.Context.html#toClientInfo"><span class="hs-identifier hs-var">toClientInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(RoleInfo -&gt; ClientInfo) -&gt; RoleInfo -&gt; ClientInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; RoleInfo
</span><a href="Network.HTTP2.H2.Context.html#roleInfo"><span class="hs-identifier hs-var">roleInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119720"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-367"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span>
</span><span id="line-368"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Token -&gt; ValueTable -&gt; Maybe ByteString
</span><a href="Network.HPACK.HeaderBlock.Decode.html#getHeaderValue"><span class="hs-identifier hs-var">getHeaderValue</span></a></span><span> </span><span class="annot"><span class="annottext">Token
</span><a href="Network.HPACK.Token.html#tokenAuthority"><span class="hs-identifier hs-var">tokenAuthority</span></a></span><span> </span><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679119725"><span class="hs-identifier hs-var">vt</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Maybe ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119729"><span class="hs-identifier hs-var">authority</span></a></span><span>
</span><span id="line-369"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Token -&gt; ValueTable -&gt; Maybe ByteString
</span><a href="Network.HPACK.HeaderBlock.Decode.html#getHeaderValue"><span class="hs-identifier hs-var">getHeaderValue</span></a></span><span> </span><span class="annot"><span class="annottext">Token
</span><a href="Network.HPACK.Token.html#tokenScheme"><span class="hs-identifier hs-var">tokenScheme</span></a></span><span> </span><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679119725"><span class="hs-identifier hs-var">vt</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Maybe ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119728"><span class="hs-identifier hs-var">scheme</span></a></span><span>
</span><span id="line-370"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>        </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119735"><span class="annot"><span class="annottext">mmethod :: Maybe ByteString
</span><a href="#local-6989586621679119735"><span class="hs-identifier hs-var hs-var">mmethod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Token -&gt; ValueTable -&gt; Maybe ByteString
</span><a href="Network.HPACK.HeaderBlock.Decode.html#getHeaderValue"><span class="hs-identifier hs-var">getHeaderValue</span></a></span><span> </span><span class="annot"><span class="annottext">Token
</span><a href="Network.HPACK.Token.html#tokenMethod"><span class="hs-identifier hs-var">tokenMethod</span></a></span><span> </span><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679119725"><span class="hs-identifier hs-var">vt</span></a></span><span>
</span><span id="line-373"></span><span>                </span><span id="local-6989586621679119737"><span class="annot"><span class="annottext">mpath :: Maybe ByteString
</span><a href="#local-6989586621679119737"><span class="hs-identifier hs-var hs-var">mpath</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Token -&gt; ValueTable -&gt; Maybe ByteString
</span><a href="Network.HPACK.HeaderBlock.Decode.html#getHeaderValue"><span class="hs-identifier hs-var">getHeaderValue</span></a></span><span> </span><span class="annot"><span class="annottext">Token
</span><a href="Network.HPACK.Token.html#tokenPath"><span class="hs-identifier hs-var">tokenPath</span></a></span><span> </span><span class="annot"><span class="annottext">ValueTable
</span><a href="#local-6989586621679119725"><span class="hs-identifier hs-var">vt</span></a></span><span>
</span><span id="line-374"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679119735"><span class="hs-identifier hs-var">mmethod</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><a href="#local-6989586621679119737"><span class="hs-identifier hs-var">mpath</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-375"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119739"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119739"><span class="hs-identifier hs-var">method</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119740"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119740"><span class="hs-identifier hs-var">path</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-376"></span><span>                    </span><span class="hs-comment">-- FLOW CONTROL: SETTINGS_MAX_CONCURRENT_STREAMS: recv: rejecting if over my limit</span><span>
</span><span id="line-377"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; StreamId -&gt; ByteString -&gt; ByteString -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#openEvenStreamCacheCheck"><span class="hs-identifier hs-var">openEvenStreamCacheCheck</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119720"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119722"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119739"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119740"><span class="hs-identifier hs-var">path</span></a></span><span>
</span><span id="line-378"></span><span>                </span><span class="annot"><span class="annottext">(Maybe ByteString, Maybe ByteString)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-pragma hs-type">guardIt</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-383"></span><span id="local-6989586621679118732"><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-type">guardIt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Decode.html#FrameDecodeError"><span class="hs-identifier hs-type">FrameDecodeError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679118732"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679118732"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-384"></span><span id="guardIt"><span class="annot"><span class="annottext">guardIt :: forall a. Either FrameDecodeError a -&gt; IO a
</span><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-var hs-var">guardIt</span></a></span></span><span> </span><span id="local-6989586621679119745"><span class="annot"><span class="annottext">Either FrameDecodeError a
</span><a href="#local-6989586621679119745"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either FrameDecodeError a
</span><a href="#local-6989586621679119745"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-385"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.Frame.Decode.html#FrameDecodeError"><span class="hs-identifier hs-type">FrameDecodeError</span></a></span><span> </span><span id="local-6989586621679119746"><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119746"><span class="hs-identifier hs-var">ec</span></a></span></span><span> </span><span id="local-6989586621679119747"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119747"><span class="hs-identifier hs-var">sid</span></a></span></span><span> </span><span id="local-6989586621679119748"><span class="annot"><span class="annottext">ReasonPhrase
</span><a href="#local-6989586621679119748"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO a
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO a) -&gt; HTTP2Error -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119746"><span class="hs-identifier hs-var">ec</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119747"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><a href="#local-6989586621679119748"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-386"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679119749"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679119749"><span class="hs-identifier hs-var">frame</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679119749"><span class="hs-identifier hs-var">frame</span></a></span><span>
</span><span id="line-387"></span><span>
</span><span id="line-388"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#checkPriority"><span class="hs-pragma hs-type">checkPriority</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-389"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#checkPriority"><span class="hs-identifier hs-type">checkPriority</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#Priority"><span class="hs-identifier hs-type">Priority</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#StreamId"><span class="hs-identifier hs-type">StreamId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-390"></span><span id="checkPriority"><span class="annot"><span class="annottext">checkPriority :: Priority -&gt; StreamId -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#checkPriority"><span class="hs-identifier hs-var hs-var">checkPriority</span></a></span></span><span> </span><span id="local-6989586621679119750"><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679119750"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679119751"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119751"><span class="hs-identifier hs-var">me</span></a></span></span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119752"><span class="hs-identifier hs-var">dep</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119751"><span class="hs-identifier hs-var">me</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-392"></span><span>        </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#StreamErrorIsSent"><span class="hs-identifier hs-var">StreamErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119751"><span class="hs-identifier hs-var">me</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;priority depends on itself&quot;</span></span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-395"></span><span>    </span><span id="local-6989586621679119752"><span class="annot"><span class="annottext">dep :: StreamId
</span><a href="#local-6989586621679119752"><span class="hs-identifier hs-var hs-var">dep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Priority -&gt; StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamDependency"><span class="hs-identifier hs-var">streamDependency</span></a></span><span> </span><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679119750"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-396"></span><span>
</span><span id="line-397"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-type">stream</span></a></span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameType"><span class="hs-identifier hs-type">FrameType</span></a></span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span>
</span><span id="line-400"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-401"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-402"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#StreamState"><span class="hs-identifier hs-type">StreamState</span></a></span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#StreamState"><span class="hs-identifier hs-type">StreamState</span></a></span><span>
</span><span id="line-405"></span><span class="hs-comment">-- Transition (stream1)</span><span>
</span><span id="line-406"></span><span id="stream"><span class="annot"><span class="annottext">stream :: FrameType
-&gt; FrameHeader
-&gt; ByteString
-&gt; Context
-&gt; StreamState
-&gt; Stream
-&gt; IO StreamState
</span><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var hs-var">stream</span></a></span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span> </span><span id="local-6989586621679119754"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679119754"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119755"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameHeader -&gt; FrameFlags
flags :: FrameFlags
</span><a href="Network.HTTP2.Frame.Types.html#flags"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119756"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119757"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119757"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621679119758"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119758"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679119759"><span class="annot"><span class="annottext">s :: StreamState
</span><a href="#local-6989586621679119759"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span id="local-6989586621679119760"><span class="annot"><span class="annottext">Maybe ClosedCode
</span><a href="#local-6989586621679119760"><span class="hs-identifier hs-var">hcl</span></a></span></span><span> </span><span class="annot"><span class="annottext">OpenState
</span><a href="Network.HTTP2.H2.Types.html#JustOpened"><span class="hs-identifier hs-var">JustOpened</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119762"><span class="annot"><span class="annottext">StreamId
streamNumber :: StreamId
streamNumber :: Stream -&gt; StreamId
</span><a href="#local-6989586621679119762"><span class="hs-identifier hs-var hs-var">streamNumber</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-407"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#HeadersFrame"><span class="hs-identifier hs-type">HeadersFrame</span></a></span><span> </span><span id="local-6989586621679119765"><span class="annot"><span class="annottext">Maybe Priority
</span><a href="#local-6989586621679119765"><span class="hs-identifier hs-var">mp</span></a></span></span><span> </span><span id="local-6989586621679119766"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119766"><span class="hs-identifier hs-var">frag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a. Either FrameDecodeError a -&gt; IO a
</span><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either FrameDecodeError FramePayload -&gt; IO FramePayload)
-&gt; Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeHeadersFrame"><span class="hs-identifier hs-var">decodeHeadersFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119754"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119757"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-408"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119768"><span class="annot"><span class="annottext">endOfStream :: Bool
</span><a href="#local-6989586621679119768"><span class="hs-identifier hs-var hs-var">endOfStream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testEndStream"><span class="hs-identifier hs-var">testEndStream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679119755"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-409"></span><span>        </span><span id="local-6989586621679119770"><span class="annot"><span class="annottext">endOfHeader :: Bool
</span><a href="#local-6989586621679119770"><span class="hs-identifier hs-var hs-var">endOfHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testEndHeader"><span class="hs-identifier hs-var">testEndHeader</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679119755"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-410"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119766"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119768"><span class="hs-identifier hs-var">endOfStream</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119770"><span class="hs-identifier hs-var">endOfHeader</span></a></span><span>
</span><span id="line-411"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-412"></span><span>            </span><span class="hs-comment">-- Empty Frame Flooding - CVE-2019-9518</span><span>
</span><span id="line-413"></span><span>            </span><span id="local-6989586621679119772"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119772"><span class="hs-identifier hs-var">rate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rate -&gt; IO StreamId
</span><span class="hs-identifier hs-var">getRate</span></span><span> </span><span class="annot"><span class="annottext">(Rate -&gt; IO StreamId) -&gt; Rate -&gt; IO StreamId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Rate
</span><a href="Network.HTTP2.H2.Context.html#emptyFrameRate"><span class="hs-identifier hs-var">emptyFrameRate</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119758"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-414"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119772"><span class="hs-identifier hs-var">rate</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#emptyFrameRateLimit"><span class="hs-identifier hs-var">emptyFrameRateLimit</span></a></span><span>
</span><span id="line-415"></span><span>                </span><span class="hs-keyword">then</span><span>
</span><span id="line-416"></span><span>                    </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-417"></span><span>                        </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#EnhanceYourCalm"><span class="hs-identifier hs-var">EnhanceYourCalm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119756"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;too many empty headers&quot;</span></span><span>
</span><span id="line-418"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119759"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-419"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-420"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Priority
</span><a href="#local-6989586621679119765"><span class="hs-identifier hs-var">mp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-421"></span><span>                </span><span class="annot"><span class="annottext">Maybe Priority
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119773"><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679119773"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Priority -&gt; StreamId -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#checkPriority"><span class="hs-identifier hs-var">checkPriority</span></a></span><span> </span><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679119773"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119762"><span class="hs-identifier hs-var">streamNumber</span></a></span><span>
</span><span id="line-423"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119770"><span class="hs-identifier hs-var">endOfHeader</span></a></span><span>
</span><span id="line-424"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-425"></span><span>                    </span><span id="local-6989586621679119774"><span class="annot"><span class="annottext">HeaderTable
</span><a href="#local-6989586621679119774"><span class="hs-identifier hs-var">tbl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; StreamId -&gt; Context -&gt; IO HeaderTable
</span><a href="Network.HTTP2.H2.HPACK.html#hpackDecodeHeader"><span class="hs-identifier hs-var">hpackDecodeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119766"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119756"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119758"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-426"></span><span>                    </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(StreamState -&gt; IO StreamState) -&gt; StreamState -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-427"></span><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119768"><span class="hs-identifier hs-var">endOfStream</span></a></span><span>
</span><span id="line-428"></span><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-comment">-- turned into HalfClosedRemote in processState</span><span>
</span><span id="line-429"></span><span>                                </span><span class="annot"><span class="annottext">Maybe ClosedCode -&gt; OpenState -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><a href="#local-6989586621679119760"><span class="hs-identifier hs-var">hcl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderTable -&gt; OpenState
</span><a href="Network.HTTP2.H2.Types.html#NoBody"><span class="hs-identifier hs-var">NoBody</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderTable
</span><a href="#local-6989586621679119774"><span class="hs-identifier hs-var">tbl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode -&gt; OpenState -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><a href="#local-6989586621679119760"><span class="hs-identifier hs-var">hcl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderTable -&gt; OpenState
</span><a href="Network.HTTP2.H2.Types.html#HasBody"><span class="hs-identifier hs-var">HasBody</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderTable
</span><a href="#local-6989586621679119774"><span class="hs-identifier hs-var">tbl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-432"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119775"><span class="annot"><span class="annottext">siz :: StreamId
</span><a href="#local-6989586621679119775"><span class="hs-identifier hs-var hs-var">siz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; StreamId
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119766"><span class="hs-identifier hs-var">frag</span></a></span><span>
</span><span id="line-433"></span><span>                    </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(StreamState -&gt; IO StreamState) -&gt; StreamState -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode -&gt; OpenState -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><a href="#local-6989586621679119760"><span class="hs-identifier hs-var">hcl</span></a></span><span> </span><span class="annot"><span class="annottext">(OpenState -&gt; StreamState) -&gt; OpenState -&gt; StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; StreamId -&gt; StreamId -&gt; Bool -&gt; OpenState
</span><a href="Network.HTTP2.H2.Types.html#Continued"><span class="hs-identifier hs-var">Continued</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119766"><span class="hs-identifier hs-var">frag</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119775"><span class="hs-identifier hs-var">siz</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119768"><span class="hs-identifier hs-var">endOfStream</span></a></span><span>
</span><span id="line-434"></span><span>
</span><span id="line-435"></span><span class="hs-comment">-- Transition (stream2)</span><span>
</span><span id="line-436"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameHeaders"><span class="hs-identifier hs-var">FrameHeaders</span></a></span><span> </span><span id="local-6989586621679119777"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679119777"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119778"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameHeader -&gt; FrameFlags
flags :: FrameFlags
</span><a href="Network.HTTP2.Frame.Types.html#flags"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119779"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119780"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119780"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621679119781"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119781"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span id="local-6989586621679119782"><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
</span><a href="#local-6989586621679119782"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe StreamId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IORef StreamId
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679119783"><span class="annot"><span class="annottext">IORef (Maybe HeaderTable)
</span><a href="#local-6989586621679119783"><span class="hs-identifier hs-var">tlr</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-437"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#HeadersFrame"><span class="hs-identifier hs-type">HeadersFrame</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Priority
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679119784"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119784"><span class="hs-identifier hs-var">frag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a. Either FrameDecodeError a -&gt; IO a
</span><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either FrameDecodeError FramePayload -&gt; IO FramePayload)
-&gt; Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeHeadersFrame"><span class="hs-identifier hs-var">decodeHeadersFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119777"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119780"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-438"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119785"><span class="annot"><span class="annottext">endOfStream :: Bool
</span><a href="#local-6989586621679119785"><span class="hs-identifier hs-var hs-var">endOfStream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testEndStream"><span class="hs-identifier hs-var">testEndStream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679119778"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-439"></span><span>    </span><span class="hs-comment">-- checking frag == &quot;&quot; is not necessary</span><span>
</span><span id="line-440"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119785"><span class="hs-identifier hs-var">endOfStream</span></a></span><span>
</span><span id="line-441"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-442"></span><span>            </span><span id="local-6989586621679119786"><span class="annot"><span class="annottext">HeaderTable
</span><a href="#local-6989586621679119786"><span class="hs-identifier hs-var">tbl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; StreamId -&gt; Context -&gt; IO HeaderTable
</span><a href="Network.HTTP2.H2.HPACK.html#hpackDecodeTrailer"><span class="hs-identifier hs-var">hpackDecodeTrailer</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119784"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119779"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119781"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-443"></span><span>            </span><span class="annot"><span class="annottext">IORef (Maybe HeaderTable) -&gt; Maybe HeaderTable -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe HeaderTable)
</span><a href="#local-6989586621679119783"><span class="hs-identifier hs-var">tlr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderTable -&gt; Maybe HeaderTable
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">HeaderTable
</span><a href="#local-6989586621679119786"><span class="hs-identifier hs-var">tbl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>            </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
-&gt; Either SomeException ByteString -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
</span><a href="#local-6989586621679119782"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException ByteString -&gt; STM ())
-&gt; Either SomeException ByteString -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either SomeException ByteString
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-445"></span><span>            </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="Network.HTTP2.H2.Types.html#HalfClosedRemote"><span class="hs-identifier hs-var">HalfClosedRemote</span></a></span><span>
</span><span id="line-446"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-comment">-- we don't support continuation here.</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span>            </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-449"></span><span>                </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span>
</span><span id="line-450"></span><span>                    </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span>
</span><span id="line-451"></span><span>                    </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119779"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-452"></span><span>                    </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;continuation in trailer is not supported&quot;</span></span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span class="hs-comment">-- Transition (stream4)</span><span>
</span><span id="line-455"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span>
</span><span id="line-456"></span><span>    </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameData"><span class="hs-identifier hs-var">FrameData</span></a></span><span>
</span><span id="line-457"></span><span>    </span><span id="local-6989586621679119789"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679119789"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119790"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameHeader -&gt; FrameFlags
flags :: FrameFlags
</span><a href="Network.HTTP2.Frame.Types.html#flags"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119791"><span class="annot"><span class="annottext">StreamId
payloadLength :: FrameHeader -&gt; StreamId
payloadLength :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#payloadLength"><span class="hs-identifier hs-var hs-var">payloadLength</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119792"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-458"></span><span>    </span><span id="local-6989586621679119793"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119793"><span class="hs-identifier hs-var">bs</span></a></span></span><span>
</span><span id="line-459"></span><span>    </span><span class="annot"><a href="Network.HTTP2.H2.Context.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119794"><span class="annot"><span class="annottext">Rate
emptyFrameRate :: Context -&gt; Rate
emptyFrameRate :: Rate
</span><a href="Network.HTTP2.H2.Context.html#emptyFrameRate"><span class="hs-identifier hs-var hs-var">emptyFrameRate</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119795"><span class="annot"><span class="annottext">IORef RxFlow
rxFlow :: Context -&gt; IORef RxFlow
rxFlow :: IORef RxFlow
</span><a href="Network.HTTP2.H2.Context.html#rxFlow"><span class="hs-identifier hs-var hs-var">rxFlow</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-460"></span><span>    </span><span id="local-6989586621679119796"><span class="annot"><span class="annottext">s :: StreamState
</span><a href="#local-6989586621679119796"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span id="local-6989586621679119797"><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
</span><a href="#local-6989586621679119797"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679119798"><span class="annot"><span class="annottext">Maybe StreamId
</span><a href="#local-6989586621679119798"><span class="hs-identifier hs-var">mcl</span></a></span></span><span> </span><span id="local-6989586621679119799"><span class="annot"><span class="annottext">IORef StreamId
</span><a href="#local-6989586621679119799"><span class="hs-identifier hs-var">bodyLength</span></a></span></span><span> </span><span class="annot"><span class="annottext">IORef (Maybe HeaderTable)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span>    </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119800"><span id="local-6989586621679119801"><span id="local-6989586621679119802"><span id="local-6989586621679119803"><span id="local-6989586621679119804"><span class="annot"><span class="annottext">StreamId
MVar (Either SomeException InpObj)
TVar TxFlow
IORef RxFlow
IORef StreamState
streamInput :: Stream -&gt; MVar (Either SomeException InpObj)
streamNumber :: Stream -&gt; StreamId
streamNumber :: StreamId
streamState :: IORef StreamState
streamInput :: MVar (Either SomeException InpObj)
streamTxFlow :: TVar TxFlow
streamRxFlow :: IORef RxFlow
streamState :: Stream -&gt; IORef StreamState
streamTxFlow :: Stream -&gt; TVar TxFlow
streamRxFlow :: Stream -&gt; IORef RxFlow
</span><a href="Network.HTTP2.H2.Types.html#streamInput"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-462"></span><span>        </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#DataFrame"><span class="hs-identifier hs-type">DataFrame</span></a></span><span> </span><span id="local-6989586621679119809"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119809"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a. Either FrameDecodeError a -&gt; IO a
</span><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either FrameDecodeError FramePayload -&gt; IO FramePayload)
-&gt; Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeDataFrame"><span class="hs-identifier hs-var">decodeDataFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119789"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119793"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-463"></span><span>        </span><span class="hs-comment">-- FLOW CONTROL: WINDOW_UPDATE 0: recv: rejecting if over my limit</span><span>
</span><span id="line-464"></span><span>        </span><span id="local-6989586621679119811"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119811"><span class="hs-identifier hs-var">okc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef RxFlow -&gt; (RxFlow -&gt; (RxFlow, Bool)) -&gt; IO Bool
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">IORef RxFlow
</span><a href="#local-6989586621679119795"><span class="hs-identifier hs-var">rxFlow</span></a></span><span> </span><span class="annot"><span class="annottext">((RxFlow -&gt; (RxFlow, Bool)) -&gt; IO Bool)
-&gt; (RxFlow -&gt; (RxFlow, Bool)) -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; RxFlow -&gt; (RxFlow, Bool)
</span><span class="hs-identifier hs-var">checkRxLimit</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119791"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-465"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119811"><span class="hs-identifier hs-var">okc</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-466"></span><span>            </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-467"></span><span>                </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span>
</span><span id="line-468"></span><span>                    </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#EnhanceYourCalm"><span class="hs-identifier hs-var">EnhanceYourCalm</span></a></span><span>
</span><span id="line-469"></span><span>                    </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119792"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-470"></span><span>                    </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;exceeds connection flow-control limit&quot;</span></span><span>
</span><span id="line-471"></span><span>        </span><span class="hs-comment">-- FLOW CONTROL: WINDOW_UPDATE: recv: rejecting if over my limit</span><span>
</span><span id="line-472"></span><span>        </span><span id="local-6989586621679119814"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119814"><span class="hs-identifier hs-var">oks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef RxFlow -&gt; (RxFlow -&gt; (RxFlow, Bool)) -&gt; IO Bool
forall a b. IORef a -&gt; (a -&gt; (a, b)) -&gt; IO b
</span><span class="hs-identifier hs-var">atomicModifyIORef'</span></span><span> </span><span class="annot"><span class="annottext">IORef RxFlow
</span><a href="#local-6989586621679119804"><span class="hs-identifier hs-var">streamRxFlow</span></a></span><span> </span><span class="annot"><span class="annottext">((RxFlow -&gt; (RxFlow, Bool)) -&gt; IO Bool)
-&gt; (RxFlow -&gt; (RxFlow, Bool)) -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; RxFlow -&gt; (RxFlow, Bool)
</span><span class="hs-identifier hs-var">checkRxLimit</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119791"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-473"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119814"><span class="hs-identifier hs-var">oks</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-474"></span><span>            </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-475"></span><span>                </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span>
</span><span id="line-476"></span><span>                    </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#EnhanceYourCalm"><span class="hs-identifier hs-var">EnhanceYourCalm</span></a></span><span>
</span><span id="line-477"></span><span>                    </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119792"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-478"></span><span>                    </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;exceeds stream flow-control limit&quot;</span></span><span>
</span><span id="line-479"></span><span>        </span><span id="local-6989586621679119815"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119815"><span class="hs-identifier hs-var">len0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef StreamId -&gt; IO StreamId
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef StreamId
</span><a href="#local-6989586621679119799"><span class="hs-identifier hs-var">bodyLength</span></a></span><span>
</span><span id="line-480"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119817"><span class="annot"><span class="annottext">len :: StreamId
</span><a href="#local-6989586621679119817"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119815"><span class="hs-identifier hs-var">len0</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; StreamId
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119791"><span class="hs-identifier hs-var">payloadLength</span></a></span><span>
</span><span id="line-481"></span><span>            </span><span id="local-6989586621679119818"><span class="annot"><span class="annottext">endOfStream :: Bool
</span><a href="#local-6989586621679119818"><span class="hs-identifier hs-var hs-var">endOfStream</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testEndStream"><span class="hs-identifier hs-var">testEndStream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679119790"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-482"></span><span>        </span><span class="hs-comment">-- Empty Frame Flooding - CVE-2019-9518</span><span>
</span><span id="line-483"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119809"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-484"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119818"><span class="hs-identifier hs-var">endOfStream</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-485"></span><span>                </span><span id="local-6989586621679119819"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119819"><span class="hs-identifier hs-var">rate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rate -&gt; IO StreamId
</span><span class="hs-identifier hs-var">getRate</span></span><span> </span><span class="annot"><span class="annottext">Rate
</span><a href="#local-6989586621679119794"><span class="hs-identifier hs-var">emptyFrameRate</span></a></span><span>
</span><span id="line-486"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119819"><span class="hs-identifier hs-var">rate</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#emptyFrameRateLimit"><span class="hs-identifier hs-var">emptyFrameRateLimit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-487"></span><span>                    </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#EnhanceYourCalm"><span class="hs-identifier hs-var">EnhanceYourCalm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119792"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;too many empty data&quot;</span></span><span>
</span><span id="line-488"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-489"></span><span>                </span><span class="annot"><span class="annottext">IORef StreamId -&gt; StreamId -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef StreamId
</span><a href="#local-6989586621679119799"><span class="hs-identifier hs-var">bodyLength</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119817"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-490"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
-&gt; Either SomeException ByteString -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
</span><a href="#local-6989586621679119797"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException ByteString -&gt; STM ())
-&gt; Either SomeException ByteString -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either SomeException ByteString
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119809"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-491"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119818"><span class="hs-identifier hs-var">endOfStream</span></a></span><span>
</span><span id="line-492"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-493"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe StreamId
</span><a href="#local-6989586621679119798"><span class="hs-identifier hs-var">mcl</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-494"></span><span>                    </span><span class="annot"><span class="annottext">Maybe StreamId
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679119820"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119820"><span class="hs-identifier hs-var">cl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-496"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119820"><span class="hs-identifier hs-var">cl</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119817"><span class="hs-identifier hs-var">len</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-497"></span><span>                            </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-498"></span><span>                                </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#StreamErrorIsSent"><span class="hs-identifier hs-var">StreamErrorIsSent</span></a></span><span>
</span><span id="line-499"></span><span>                                    </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span>
</span><span id="line-500"></span><span>                                    </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119792"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-501"></span><span>                                    </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;actual body length is not the same as content-length&quot;</span></span><span>
</span><span id="line-502"></span><span>                </span><span class="hs-comment">-- no trailers</span><span>
</span><span id="line-503"></span><span>                </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
-&gt; Either SomeException ByteString -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
</span><a href="#local-6989586621679119797"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">(Either SomeException ByteString -&gt; STM ())
-&gt; Either SomeException ByteString -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Either SomeException ByteString
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-504"></span><span>                </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="Network.HTTP2.H2.Types.html#HalfClosedRemote"><span class="hs-identifier hs-var">HalfClosedRemote</span></a></span><span>
</span><span id="line-505"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119796"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-506"></span><span>
</span><span id="line-507"></span><span class="hs-comment">-- Transition (stream5)</span><span>
</span><span id="line-508"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameContinuation"><span class="hs-identifier hs-var">FrameContinuation</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119821"><span class="annot"><span class="annottext">FrameFlags
flags :: FrameHeader -&gt; FrameFlags
flags :: FrameFlags
</span><a href="Network.HTTP2.Frame.Types.html#flags"><span class="hs-identifier hs-var hs-var">flags</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679119822"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119823"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119823"><span class="hs-identifier hs-var">frag</span></a></span></span><span> </span><span id="local-6989586621679119824"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119824"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679119825"><span class="annot"><span class="annottext">s :: StreamState
</span><a href="#local-6989586621679119825"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span id="local-6989586621679119826"><span class="annot"><span class="annottext">Maybe ClosedCode
</span><a href="#local-6989586621679119826"><span class="hs-identifier hs-var">hcl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Continued"><span class="hs-identifier hs-type">Continued</span></a></span><span> </span><span id="local-6989586621679119827"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679119827"><span class="hs-identifier hs-var">rfrags</span></a></span></span><span> </span><span id="local-6989586621679119828"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119828"><span class="hs-identifier hs-var">siz</span></a></span></span><span> </span><span id="local-6989586621679119829"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119829"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621679119830"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119830"><span class="hs-identifier hs-var">endOfStream</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-509"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119831"><span class="annot"><span class="annottext">endOfHeader :: Bool
</span><a href="#local-6989586621679119831"><span class="hs-identifier hs-var hs-var">endOfHeader</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FrameFlags -&gt; Bool
</span><a href="Network.HTTP2.Frame.Types.html#testEndHeader"><span class="hs-identifier hs-var">testEndHeader</span></a></span><span> </span><span class="annot"><span class="annottext">FrameFlags
</span><a href="#local-6989586621679119821"><span class="hs-identifier hs-var">flags</span></a></span><span>
</span><span id="line-510"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119823"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119831"><span class="hs-identifier hs-var">endOfHeader</span></a></span><span>
</span><span id="line-511"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-512"></span><span>            </span><span class="hs-comment">-- Empty Frame Flooding - CVE-2019-9518</span><span>
</span><span id="line-513"></span><span>            </span><span id="local-6989586621679119832"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119832"><span class="hs-identifier hs-var">rate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rate -&gt; IO StreamId
</span><span class="hs-identifier hs-var">getRate</span></span><span> </span><span class="annot"><span class="annottext">(Rate -&gt; IO StreamId) -&gt; Rate -&gt; IO StreamId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Rate
</span><a href="Network.HTTP2.H2.Context.html#emptyFrameRate"><span class="hs-identifier hs-var">emptyFrameRate</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119824"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-514"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119832"><span class="hs-identifier hs-var">rate</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#emptyFrameRateLimit"><span class="hs-identifier hs-var">emptyFrameRateLimit</span></a></span><span>
</span><span id="line-515"></span><span>                </span><span class="hs-keyword">then</span><span>
</span><span id="line-516"></span><span>                    </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-517"></span><span>                        </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#EnhanceYourCalm"><span class="hs-identifier hs-var">EnhanceYourCalm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119822"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;too many empty continuation&quot;</span></span><span>
</span><span id="line-518"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119825"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-519"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-520"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119833"><span class="annot"><span class="annottext">rfrags' :: [ByteString]
</span><a href="#local-6989586621679119833"><span class="hs-identifier hs-var hs-var">rfrags'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119823"><span class="hs-identifier hs-var">frag</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679119827"><span class="hs-identifier hs-var">rfrags</span></a></span><span>
</span><span id="line-521"></span><span>                </span><span id="local-6989586621679119835"><span class="annot"><span class="annottext">siz' :: StreamId
</span><a href="#local-6989586621679119835"><span class="hs-identifier hs-var hs-var">siz'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119828"><span class="hs-identifier hs-var">siz</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; StreamId
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; StreamId
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119823"><span class="hs-identifier hs-var">frag</span></a></span><span>
</span><span id="line-522"></span><span>                </span><span id="local-6989586621679119838"><span class="annot"><span class="annottext">n' :: StreamId
</span><a href="#local-6989586621679119838"><span class="hs-identifier hs-var hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119829"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; StreamId
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><span class="hs-number">1</span></span><span>
</span><span id="line-523"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119835"><span class="hs-identifier hs-var">siz'</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#headerFragmentLimit"><span class="hs-identifier hs-var">headerFragmentLimit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-524"></span><span>                </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-525"></span><span>                    </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#EnhanceYourCalm"><span class="hs-identifier hs-var">EnhanceYourCalm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119822"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;Header is too big&quot;</span></span><span>
</span><span id="line-526"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119838"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#continuationLimit"><span class="hs-identifier hs-var">continuationLimit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-527"></span><span>                </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-528"></span><span>                    </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#EnhanceYourCalm"><span class="hs-identifier hs-var">EnhanceYourCalm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119822"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;Header is too fragmented&quot;</span></span><span>
</span><span id="line-529"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119831"><span class="hs-identifier hs-var">endOfHeader</span></a></span><span>
</span><span id="line-530"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-531"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119839"><span class="annot"><span class="annottext">hdrblk :: ByteString
</span><a href="#local-6989586621679119839"><span class="hs-identifier hs-var hs-var">hdrblk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">BS.concat</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString) -&gt; [ByteString] -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; [ByteString]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679119833"><span class="hs-identifier hs-var">rfrags'</span></a></span><span>
</span><span id="line-532"></span><span>                    </span><span id="local-6989586621679119842"><span class="annot"><span class="annottext">HeaderTable
</span><a href="#local-6989586621679119842"><span class="hs-identifier hs-var">tbl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; StreamId -&gt; Context -&gt; IO HeaderTable
</span><a href="Network.HTTP2.H2.HPACK.html#hpackDecodeHeader"><span class="hs-identifier hs-var">hpackDecodeHeader</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119839"><span class="hs-identifier hs-var">hdrblk</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119822"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119824"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-533"></span><span>                    </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(StreamState -&gt; IO StreamState) -&gt; StreamState -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-534"></span><span>                        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119830"><span class="hs-identifier hs-var">endOfStream</span></a></span><span>
</span><span id="line-535"></span><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="hs-comment">-- turned into HalfClosedRemote in processState</span><span>
</span><span id="line-536"></span><span>                                </span><span class="annot"><span class="annottext">Maybe ClosedCode -&gt; OpenState -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><a href="#local-6989586621679119826"><span class="hs-identifier hs-var">hcl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderTable -&gt; OpenState
</span><a href="Network.HTTP2.H2.Types.html#NoBody"><span class="hs-identifier hs-var">NoBody</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderTable
</span><a href="#local-6989586621679119842"><span class="hs-identifier hs-var">tbl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode -&gt; OpenState -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><a href="#local-6989586621679119826"><span class="hs-identifier hs-var">hcl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HeaderTable -&gt; OpenState
</span><a href="Network.HTTP2.H2.Types.html#HasBody"><span class="hs-identifier hs-var">HasBody</span></a></span><span> </span><span class="annot"><span class="annottext">HeaderTable
</span><a href="#local-6989586621679119842"><span class="hs-identifier hs-var">tbl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-538"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(StreamState -&gt; IO StreamState) -&gt; StreamState -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode -&gt; OpenState -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><a href="#local-6989586621679119826"><span class="hs-identifier hs-var">hcl</span></a></span><span> </span><span class="annot"><span class="annottext">(OpenState -&gt; StreamState) -&gt; OpenState -&gt; StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; StreamId -&gt; StreamId -&gt; Bool -&gt; OpenState
</span><a href="Network.HTTP2.H2.Types.html#Continued"><span class="hs-identifier hs-var">Continued</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679119833"><span class="hs-identifier hs-var">rfrags'</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119835"><span class="hs-identifier hs-var">siz'</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119838"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119830"><span class="hs-identifier hs-var">endOfStream</span></a></span><span>
</span><span id="line-539"></span><span>
</span><span id="line-540"></span><span class="hs-comment">-- (No state transition)</span><span>
</span><span id="line-541"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameWindowUpdate"><span class="hs-identifier hs-var">FrameWindowUpdate</span></a></span><span> </span><span id="local-6989586621679119843"><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119843"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621679119844"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119844"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679119845"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119845"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679119846"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119846"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-542"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#WindowUpdateFrame"><span class="hs-identifier hs-type">WindowUpdateFrame</span></a></span><span> </span><span id="local-6989586621679119847"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119847"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a. Either FrameDecodeError a -&gt; IO a
</span><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either FrameDecodeError FramePayload -&gt; IO FramePayload)
-&gt; Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeWindowUpdateFrame"><span class="hs-identifier hs-var">decodeWindowUpdateFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119843"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119844"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-543"></span><span>    </span><span class="annot"><span class="annottext">Stream -&gt; StreamId -&gt; IO ()
</span><a href="Network.HTTP2.H2.Window.html#increaseStreamWindowSize"><span class="hs-identifier hs-var">increaseStreamWindowSize</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119846"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119847"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-544"></span><span>    </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119845"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span class="hs-comment">-- Transition (stream6)</span><span>
</span><span id="line-547"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameRSTStream"><span class="hs-identifier hs-var">FrameRSTStream</span></a></span><span> </span><span id="local-6989586621679119849"><span class="annot"><span class="annottext">header :: FrameHeader
</span><a href="#local-6989586621679119849"><span class="hs-identifier hs-var">header</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119850"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679119851"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119851"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621679119852"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119852"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679119853"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119853"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679119854"><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119854"><span class="hs-identifier hs-var">strm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-548"></span><span>    </span><span class="hs-comment">-- Rapid Rest: CVE-2023-44487</span><span>
</span><span id="line-549"></span><span>    </span><span id="local-6989586621679119855"><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119855"><span class="hs-identifier hs-var">rate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Rate -&gt; IO StreamId
</span><span class="hs-identifier hs-var">getRate</span></span><span> </span><span class="annot"><span class="annottext">(Rate -&gt; IO StreamId) -&gt; Rate -&gt; IO StreamId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Rate
</span><a href="Network.HTTP2.H2.Context.html#rstRate"><span class="hs-identifier hs-var">rstRate</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119852"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-550"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119855"><span class="hs-identifier hs-var">rate</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; StreamId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="Network.HTTP2.H2.Receiver.html#rstRateLimit"><span class="hs-identifier hs-var">rstRateLimit</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-551"></span><span>        </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO ()
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO ()) -&gt; HTTP2Error -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-552"></span><span>            </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#EnhanceYourCalm"><span class="hs-identifier hs-var">EnhanceYourCalm</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119850"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;too many rst_stream&quot;</span></span><span>
</span><span id="line-553"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#RSTStreamFrame"><span class="hs-identifier hs-type">RSTStreamFrame</span></a></span><span> </span><span id="local-6989586621679119857"><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119857"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a. Either FrameDecodeError a -&gt; IO a
</span><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either FrameDecodeError FramePayload -&gt; IO FramePayload)
-&gt; Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodeRSTStreamFrame"><span class="hs-identifier hs-var">decodeRSTStreamFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119849"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119851"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-554"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119859"><span class="annot"><span class="annottext">cc :: ClosedCode
</span><a href="#local-6989586621679119859"><span class="hs-identifier hs-var hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; ClosedCode
</span><a href="Network.HTTP2.H2.Types.html#Reset"><span class="hs-identifier hs-var">Reset</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119857"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-555"></span><span>
</span><span id="line-556"></span><span>    </span><span class="hs-comment">-- The spec mandates (section 8.1):</span><span>
</span><span id="line-557"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-558"></span><span>    </span><span class="hs-comment">-- &gt; When this is true, a server MAY request that the client abort</span><span>
</span><span id="line-559"></span><span>    </span><span class="hs-comment">-- &gt; transmission of a request without error by sending a RST_STREAM with an</span><span>
</span><span id="line-560"></span><span>    </span><span class="hs-comment">-- &gt; error code of NO_ERROR after sending a complete response (i.e., a frame</span><span>
</span><span id="line-561"></span><span>    </span><span class="hs-comment">-- &gt; with the END_STREAM flag).</span><span>
</span><span id="line-562"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-563"></span><span>    </span><span class="hs-comment">-- We check the first part (&quot;after sending a complete response&quot;) by checking</span><span>
</span><span id="line-564"></span><span>    </span><span class="hs-comment">-- the current stream state.</span><span>
</span><span id="line-565"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119853"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119857"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-566"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamState
</span><a href="Network.HTTP2.H2.Types.html#HalfClosedRemote"><span class="hs-identifier hs-var">HalfClosedRemote</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#NoError"><span class="hs-identifier hs-var">NoError</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-567"></span><span>            </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClosedCode -&gt; StreamState
</span><a href="Network.HTTP2.H2.Types.html#Closed"><span class="hs-identifier hs-var">Closed</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679119859"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>        </span><span id="local-6989586621679119861"><span class="annot"><span class="annottext">(StreamState, ErrorCode)
</span><a href="#local-6989586621679119861"><span class="hs-identifier hs-var">_otherwise</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-569"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Stream -&gt; ClosedCode -&gt; IO ()
</span><a href="Network.HTTP2.H2.Context.html#closed"><span class="hs-identifier hs-var">closed</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679119852"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Stream
</span><a href="#local-6989586621679119854"><span class="hs-identifier hs-var">strm</span></a></span><span> </span><span class="annot"><span class="annottext">ClosedCode
</span><a href="#local-6989586621679119859"><span class="hs-identifier hs-var">cc</span></a></span><span>
</span><span id="line-570"></span><span>            </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#StreamErrorIsReceived"><span class="hs-identifier hs-var">StreamErrorIsReceived</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679119857"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119850"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-571"></span><span>
</span><span id="line-572"></span><span class="hs-comment">-- (No state transition)</span><span>
</span><span id="line-573"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FramePriority"><span class="hs-identifier hs-var">FramePriority</span></a></span><span> </span><span id="local-6989586621679119862"><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119862"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621679119863"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119863"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679119864"><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119864"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119865"><span class="annot"><span class="annottext">StreamId
streamNumber :: Stream -&gt; StreamId
streamNumber :: StreamId
</span><a href="Network.HTTP2.H2.Types.html#streamNumber"><span class="hs-identifier hs-var hs-var">streamNumber</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-574"></span><span>    </span><span class="hs-comment">-- ignore</span><span>
</span><span id="line-575"></span><span>    </span><span class="hs-comment">-- Resource Loop - CVE-2019-9513</span><span>
</span><span id="line-576"></span><span>    </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#PriorityFrame"><span class="hs-identifier hs-type">PriorityFrame</span></a></span><span> </span><span id="local-6989586621679119866"><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679119866"><span class="hs-identifier hs-var">newpri</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a. Either FrameDecodeError a -&gt; IO a
</span><a href="Network.HTTP2.H2.Receiver.html#guardIt"><span class="hs-identifier hs-var">guardIt</span></a></span><span> </span><span class="annot"><span class="annottext">(Either FrameDecodeError FramePayload -&gt; IO FramePayload)
-&gt; Either FrameDecodeError FramePayload -&gt; IO FramePayload
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FramePayloadDecoder
</span><a href="Network.HTTP2.Frame.Decode.html#decodePriorityFrame"><span class="hs-identifier hs-var">decodePriorityFrame</span></a></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><a href="#local-6989586621679119862"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119863"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-577"></span><span>    </span><span class="annot"><span class="annottext">Priority -&gt; StreamId -&gt; IO ()
</span><a href="Network.HTTP2.H2.Receiver.html#checkPriority"><span class="hs-identifier hs-var">checkPriority</span></a></span><span> </span><span class="annot"><span class="annottext">Priority
</span><a href="#local-6989586621679119866"><span class="hs-identifier hs-var">newpri</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119865"><span class="hs-identifier hs-var">streamNumber</span></a></span><span>
</span><span id="line-578"></span><span>    </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119864"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span class="hs-comment">-- this ordering is important</span><span>
</span><span id="line-581"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameContinuation"><span class="hs-identifier hs-var">FrameContinuation</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119867"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-582"></span><span>    </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-583"></span><span>        </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119867"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;continue frame cannot come here&quot;</span></span><span>
</span><span id="line-584"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119868"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ClosedCode
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Continued"><span class="hs-identifier hs-type">Continued</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-585"></span><span>    </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-586"></span><span>        </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#ConnectionErrorIsSent"><span class="hs-identifier hs-var">ConnectionErrorIsSent</span></a></span><span>
</span><span id="line-587"></span><span>            </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span>
</span><span id="line-588"></span><span>            </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119868"><span class="hs-identifier hs-var">streamId</span></a></span><span>
</span><span id="line-589"></span><span>            </span><span class="annot"><span class="annottext">ReasonPhrase
</span><span class="hs-string">&quot;an illegal frame follows header/continuation frames&quot;</span></span><span>
</span><span id="line-590"></span><span class="hs-comment">-- Ignore frames to streams we have just reset, per section 5.1.</span><span>
</span><span id="line-591"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">FrameHeader
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679119869"><span class="annot"><span class="annottext">st :: StreamState
</span><a href="#local-6989586621679119869"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#Closed"><span class="hs-identifier hs-type">Closed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Types.html#ResetByMe"><span class="hs-identifier hs-type">ResetByMe</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StreamState -&gt; IO StreamState
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><a href="#local-6989586621679119869"><span class="hs-identifier hs-var">st</span></a></span><span>
</span><span id="line-592"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="Network.HTTP2.Frame.Types.html#FrameData"><span class="hs-identifier hs-var">FrameData</span></a></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119871"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-593"></span><span>    </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-594"></span><span>        </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#StreamErrorIsSent"><span class="hs-identifier hs-var">StreamErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#StreamClosed"><span class="hs-identifier hs-var">StreamClosed</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119871"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">(ReasonPhrase -&gt; HTTP2Error) -&gt; ReasonPhrase -&gt; HTTP2Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-595"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; ReasonPhrase
forall a. IsString a =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;illegal data frame for &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119871"><span class="hs-identifier hs-var">streamId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-596"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#stream"><span class="hs-identifier hs-var">stream</span></a></span><span> </span><span id="local-6989586621679119872"><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119872"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><a href="Network.HTTP2.Frame.Types.html#FrameHeader"><span class="hs-identifier hs-type">FrameHeader</span></a></span><span class="hs-special">{</span><span id="local-6989586621679119873"><span class="annot"><span class="annottext">StreamId
streamId :: FrameHeader -&gt; StreamId
streamId :: StreamId
</span><a href="Network.HTTP2.Frame.Types.html#streamId"><span class="hs-identifier hs-var hs-var">streamId</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StreamState
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-597"></span><span>    </span><span class="annot"><span class="annottext">HTTP2Error -&gt; IO StreamState
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">(HTTP2Error -&gt; IO StreamState) -&gt; HTTP2Error -&gt; IO StreamState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-598"></span><span>        </span><span class="annot"><span class="annottext">ErrorCode -&gt; StreamId -&gt; ReasonPhrase -&gt; HTTP2Error
</span><a href="Network.HTTP2.H2.Types.html#StreamErrorIsSent"><span class="hs-identifier hs-var">StreamErrorIsSent</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="Network.HTTP2.Frame.Types.html#ProtocolError"><span class="hs-identifier hs-var">ProtocolError</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119873"><span class="hs-identifier hs-var">streamId</span></a></span><span> </span><span class="annot"><span class="annottext">(ReasonPhrase -&gt; HTTP2Error) -&gt; ReasonPhrase -&gt; HTTP2Error
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-599"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; ReasonPhrase
forall a. IsString a =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;illegal frame &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">FrameType -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">FrameType
</span><a href="#local-6989586621679119872"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; for &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119873"><span class="hs-identifier hs-var">streamId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-600"></span><span>
</span><span id="line-601"></span><span class="hs-comment">----------------------------------------------------------------</span><span>
</span><span id="line-602"></span><span>
</span><span id="line-603"></span><span class="annot"><span class="hs-comment">-- | Type for input streaming.</span></span><span>
</span><span id="line-604"></span><span class="hs-keyword">data</span><span> </span><span id="Source"><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#Source"><span class="hs-identifier hs-var">Source</span></a></span></span><span>
</span><span id="line-605"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="Source"><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#Source"><span class="hs-identifier hs-var">Source</span></a></span></span><span>
</span><span id="line-606"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-607"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">E.SomeException</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-608"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-610"></span><span>
</span><span id="line-611"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#mkSource"><span class="hs-identifier hs-type">mkSource</span></a></span><span>
</span><span id="line-612"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TQueue</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">E.SomeException</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#Source"><span class="hs-identifier hs-type">Source</span></a></span><span>
</span><span id="line-613"></span><span id="mkSource"><span class="annot"><span class="annottext">mkSource :: TQueue (Either SomeException ByteString)
-&gt; (StreamId -&gt; IO ()) -&gt; IO Source
</span><a href="Network.HTTP2.H2.Receiver.html#mkSource"><span class="hs-identifier hs-var hs-var">mkSource</span></a></span></span><span> </span><span id="local-6989586621679119875"><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
</span><a href="#local-6989586621679119875"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679119876"><span class="annot"><span class="annottext">StreamId -&gt; IO ()
</span><a href="#local-6989586621679119876"><span class="hs-identifier hs-var">inform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(StreamId -&gt; IO ())
-&gt; TQueue (Either SomeException ByteString)
-&gt; IORef ByteString
-&gt; IORef Bool
-&gt; Source
</span><a href="Network.HTTP2.H2.Receiver.html#Source"><span class="hs-identifier hs-var">Source</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId -&gt; IO ()
</span><a href="#local-6989586621679119876"><span class="hs-identifier hs-var">inform</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
</span><a href="#local-6989586621679119875"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">(IORef ByteString -&gt; IORef Bool -&gt; Source)
-&gt; IO (IORef ByteString) -&gt; IO (IORef Bool -&gt; Source)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO (IORef ByteString)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">IO (IORef Bool -&gt; Source) -&gt; IO (IORef Bool) -&gt; IO Source
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (IORef Bool)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#readSource"><span class="hs-identifier hs-type">readSource</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#Source"><span class="hs-identifier hs-type">Source</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-616"></span><span id="readSource"><span class="annot"><span class="annottext">readSource :: Source -&gt; IO ByteString
</span><a href="Network.HTTP2.H2.Receiver.html#readSource"><span class="hs-identifier hs-var hs-var">readSource</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.HTTP2.H2.Receiver.html#Source"><span class="hs-identifier hs-type">Source</span></a></span><span> </span><span id="local-6989586621679119877"><span class="annot"><span class="annottext">StreamId -&gt; IO ()
</span><a href="#local-6989586621679119877"><span class="hs-identifier hs-var">inform</span></a></span></span><span> </span><span id="local-6989586621679119878"><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
</span><a href="#local-6989586621679119878"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span id="local-6989586621679119879"><span class="annot"><span class="annottext">IORef ByteString
</span><a href="#local-6989586621679119879"><span class="hs-identifier hs-var">refBS</span></a></span></span><span> </span><span id="local-6989586621679119880"><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679119880"><span class="hs-identifier hs-var">refEOF</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-617"></span><span>    </span><span id="local-6989586621679119881"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119881"><span class="hs-identifier hs-var">eof</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Bool -&gt; IO Bool
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679119880"><span class="hs-identifier hs-var">refEOF</span></a></span><span>
</span><span id="line-618"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679119881"><span class="hs-identifier hs-var">eof</span></a></span><span>
</span><span id="line-619"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-620"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-621"></span><span>            </span><span id="local-6989586621679119882"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119882"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ByteString
</span><a href="#local-6989586621679119883"><span class="hs-identifier hs-var">readBS</span></a></span><span>
</span><span id="line-622"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679119884"><span class="annot"><span class="annottext">len :: StreamId
</span><a href="#local-6989586621679119884"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; StreamId
</span><span class="hs-identifier hs-var">BS.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119882"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-623"></span><span>            </span><span class="annot"><span class="annottext">StreamId -&gt; IO ()
</span><a href="#local-6989586621679119877"><span class="hs-identifier hs-var">inform</span></a></span><span> </span><span class="annot"><span class="annottext">StreamId
</span><a href="#local-6989586621679119884"><span class="hs-identifier hs-var">len</span></a></span><span>
</span><span id="line-624"></span><span>            </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119882"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-625"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-626"></span><span>    </span><span class="annot"><a href="#local-6989586621679119883"><span class="hs-identifier hs-type">readBS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ByteString</span></span><span>
</span><span id="line-627"></span><span>    </span><span id="local-6989586621679119883"><span class="annot"><span class="annottext">readBS :: IO ByteString
</span><a href="#local-6989586621679119883"><span class="hs-identifier hs-var hs-var">readBS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-628"></span><span>        </span><span id="local-6989586621679119885"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119885"><span class="hs-identifier hs-var">bs0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef ByteString -&gt; IO ByteString
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef ByteString
</span><a href="#local-6989586621679119879"><span class="hs-identifier hs-var">refBS</span></a></span><span>
</span><span id="line-629"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119885"><span class="hs-identifier hs-var">bs0</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-630"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-631"></span><span>                </span><span id="local-6989586621679119886"><span class="annot"><span class="annottext">Either SomeException ByteString
</span><a href="#local-6989586621679119886"><span class="hs-identifier hs-var">mBS</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (Either SomeException ByteString)
-&gt; IO (Either SomeException ByteString)
forall (m :: * -&gt; *) a. MonadIO m =&gt; STM a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (Either SomeException ByteString)
 -&gt; IO (Either SomeException ByteString))
-&gt; STM (Either SomeException ByteString)
-&gt; IO (Either SomeException ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
-&gt; STM (Either SomeException ByteString)
forall a. TQueue a -&gt; STM a
</span><span class="hs-identifier hs-var">readTQueue</span></span><span> </span><span class="annot"><span class="annottext">TQueue (Either SomeException ByteString)
</span><a href="#local-6989586621679119878"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-632"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either SomeException ByteString
</span><a href="#local-6989586621679119886"><span class="hs-identifier hs-var">mBS</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-633"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679119888"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679119888"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-634"></span><span>                        </span><span class="annot"><span class="annottext">IORef Bool -&gt; Bool -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679119880"><span class="hs-identifier hs-var">refEOF</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-635"></span><span>                        </span><span class="annot"><span class="annottext">SomeException -&gt; IO ByteString
forall (m :: * -&gt; *) e a. (MonadIO m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679119888"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-636"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679119889"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119889"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-637"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119889"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IORef Bool -&gt; Bool -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Bool
</span><a href="#local-6989586621679119880"><span class="hs-identifier hs-var">refEOF</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-638"></span><span>                        </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119889"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-639"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-640"></span><span>                </span><span class="annot"><span class="annottext">IORef ByteString -&gt; ByteString -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">writeIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef ByteString
</span><a href="#local-6989586621679119879"><span class="hs-identifier hs-var">refBS</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span>
</span><span id="line-641"></span><span>                </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679119885"><span class="hs-identifier hs-var">bs0</span></a></span><span>
</span><span id="line-642"></span></pre></body></html>