<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="annot"><span class="hs-comment">-- | An API for merging together two collections of library dependencies.</span></span><span>
</span><span id="line-2"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Unison.Merge.Libdeps</span><span>
</span><span id="line-3"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Unison.Merge.Libdeps.html#LibdepDiffOp"><span class="hs-identifier">LibdepDiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><a href="Unison.Merge.Libdeps.html#diffLibdeps"><span class="hs-identifier">diffLibdeps</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Unison.Merge.Libdeps.html#applyLibdepsDiff"><span class="hs-identifier">applyLibdepsDiff</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Unison.Merge.Libdeps.html#getTwoFreshLibdepNames"><span class="hs-identifier">getTwoFreshLibdepNames</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">where</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Merge.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Semialign</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">alignWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Set</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.These</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">These</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.DiffOp.html"><span class="hs-identifier">Unison.Merge.DiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier">DiffOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.EitherWay.html"><span class="hs-identifier">Unison.Merge.EitherWay</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">EitherWay</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.ThreeWay.html"><span class="hs-identifier">Unison.Merge.ThreeWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.ThreeWay.html#ThreeWay"><span class="hs-identifier">ThreeWay</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.TwoDiffOps.html"><span class="hs-identifier">Unison.Merge.TwoDiffOps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.TwoDiffOps.html#TwoDiffOps"><span class="hs-identifier">TwoDiffOps</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.TwoDiffOps.html"><span class="hs-identifier">Unison.Merge.TwoDiffOps</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TwoDiffOps</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.TwoWay.html"><span class="hs-identifier">Unison.Merge.TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier">TwoWay</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html"><span class="hs-identifier">Unison.Merge.Updated</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier">Updated</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.NameSegment.Internal</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NameSegment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NameSegment</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.NameSegment.Internal</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NameSegment</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Util.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Witherable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-29"></span><span class="hs-comment">-- Diffing libdeps</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">data</span><span> </span><span id="LibdepDiffOp"><span class="annot"><a href="Unison.Merge.Libdeps.html#LibdepDiffOp"><span class="hs-identifier hs-var">LibdepDiffOp</span></a></span></span><span> </span><span id="local-6989586621679188693"><span class="annot"><a href="#local-6989586621679188693"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="AddLibdep"><span class="annot"><a href="Unison.Merge.Libdeps.html#AddLibdep"><span class="hs-identifier hs-var">AddLibdep</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679188693"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AddBothLibdeps"><span class="annot"><a href="Unison.Merge.Libdeps.html#AddBothLibdeps"><span class="hs-identifier hs-var">AddBothLibdeps</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679188693"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="#local-6989586621679188693"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="DeleteLibdep"><span class="annot"><a href="Unison.Merge.Libdeps.html#DeleteLibdep"><span class="hs-identifier hs-var">DeleteLibdep</span></a></span></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="annot"><span class="hs-comment">-- | Perform a three-way diff on two collections of library dependencies.</span></span><span>
</span><span id="line-37"></span><span id="local-6989586621679188631"><span id="local-6989586621679188632"><span class="annot"><a href="Unison.Merge.Libdeps.html#diffLibdeps"><span class="hs-identifier hs-type">diffLibdeps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679188631"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679188632"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Library dependencies.</span></span><span>
</span><span id="line-40"></span><span>  </span><span class="annot"><a href="Unison.Merge.ThreeWay.html#ThreeWay"><span class="hs-identifier hs-type">ThreeWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679188631"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188632"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-41"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Library dependencies diff.</span></span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679188631"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Libdeps.html#LibdepDiffOp"><span class="hs-identifier hs-type">LibdepDiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188632"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-43"></span><span id="diffLibdeps"><span class="annot"><span class="annottext">diffLibdeps :: forall k v.
(Ord k, Eq v) =&gt;
ThreeWay (Map k v) -&gt; Map k (LibdepDiffOp v)
</span><a href="Unison.Merge.Libdeps.html#diffLibdeps"><span class="hs-identifier hs-var hs-var">diffLibdeps</span></a></span></span><span> </span><span id="local-6989586621679188764"><span class="annot"><span class="annottext">ThreeWay (Map k v)
</span><a href="#local-6989586621679188764"><span class="hs-identifier hs-var">libdeps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-44"></span><span>  </span><span class="annot"><span class="annottext">Map k (DiffOp v) -&gt; Map k (DiffOp v) -&gt; Map k (LibdepDiffOp v)
forall k v.
(Ord k, Eq v) =&gt;
Map k (DiffOp v) -&gt; Map k (DiffOp v) -&gt; Map k (LibdepDiffOp v)
</span><a href="Unison.Merge.Libdeps.html#mergeDiffs"><span class="hs-identifier hs-var">mergeDiffs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map k v -&gt; Map k v -&gt; Map k (DiffOp v)
forall k v. (Ord k, Eq v) =&gt; Map k v -&gt; Map k v -&gt; Map k (DiffOp v)
</span><a href="Unison.Merge.Libdeps.html#twoWayDiff"><span class="hs-identifier hs-var">twoWayDiff</span></a></span><span> </span><span class="annot"><span class="annottext">ThreeWay (Map k v)
</span><a href="#local-6989586621679188764"><span class="hs-identifier hs-var">libdeps</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">lca</span><span> </span><span class="annot"><span class="annottext">ThreeWay (Map k v)
</span><a href="#local-6989586621679188764"><span class="hs-identifier hs-var">libdeps</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">alice</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map k v -&gt; Map k v -&gt; Map k (DiffOp v)
forall k v. (Ord k, Eq v) =&gt; Map k v -&gt; Map k v -&gt; Map k (DiffOp v)
</span><a href="Unison.Merge.Libdeps.html#twoWayDiff"><span class="hs-identifier hs-var">twoWayDiff</span></a></span><span> </span><span class="annot"><span class="annottext">ThreeWay (Map k v)
</span><a href="#local-6989586621679188764"><span class="hs-identifier hs-var">libdeps</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">lca</span><span> </span><span class="annot"><span class="annottext">ThreeWay (Map k v)
</span><a href="#local-6989586621679188764"><span class="hs-identifier hs-var">libdeps</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">bob</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-comment">-- `twoWayDiff old new` computes a diff between old thing `old` and new thing `new`.</span><span>
</span><span id="line-47"></span><span class="hs-comment">--</span><span>
</span><span id="line-48"></span><span class="hs-comment">-- Values present in `old` but not `new` are tagged as &quot;deleted&quot;; similar for &quot;added&quot; and &quot;updated&quot;.</span><span>
</span><span id="line-49"></span><span id="local-6989586621679188641"><span id="local-6989586621679188642"><span class="annot"><a href="Unison.Merge.Libdeps.html#twoWayDiff"><span class="hs-identifier hs-type">twoWayDiff</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679188641"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679188642"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679188641"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188642"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679188641"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188642"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679188641"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188642"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-50"></span><span id="twoWayDiff"><span class="annot"><span class="annottext">twoWayDiff :: forall k v. (Ord k, Eq v) =&gt; Map k v -&gt; Map k v -&gt; Map k (DiffOp v)
</span><a href="Unison.Merge.Libdeps.html#twoWayDiff"><span class="hs-identifier hs-var hs-var">twoWayDiff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-51"></span><span>  </span><span class="annot"><span class="annottext">SimpleWhenMissing k v (DiffOp v)
-&gt; SimpleWhenMissing k v (DiffOp v)
-&gt; SimpleWhenMatched k v v (DiffOp v)
-&gt; Map k v
-&gt; Map k v
-&gt; Map k (DiffOp v)
forall k a c b.
Ord k =&gt;
SimpleWhenMissing k a c
-&gt; SimpleWhenMissing k b c
-&gt; SimpleWhenMatched k a b c
-&gt; Map k a
-&gt; Map k b
-&gt; Map k c
</span><span class="hs-identifier hs-var">Map.merge</span></span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(k -&gt; v -&gt; DiffOp v) -&gt; SimpleWhenMissing k v (DiffOp v)
forall (f :: * -&gt; *) k x y.
Applicative f =&gt;
(k -&gt; x -&gt; y) -&gt; WhenMissing f k x y
</span><span class="hs-identifier hs-var">Map.mapMissing</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">k
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">v -&gt; DiffOp v
forall a. a -&gt; DiffOp a
</span><a href="Unison.Merge.DiffOp.html#DiffOp%27Delete"><span class="hs-identifier hs-var">DiffOp'Delete</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(k -&gt; v -&gt; DiffOp v) -&gt; SimpleWhenMissing k v (DiffOp v)
forall (f :: * -&gt; *) k x y.
Applicative f =&gt;
(k -&gt; x -&gt; y) -&gt; WhenMissing f k x y
</span><span class="hs-identifier hs-var">Map.mapMissing</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">k
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">v -&gt; DiffOp v
forall a. a -&gt; DiffOp a
</span><a href="Unison.Merge.DiffOp.html#DiffOp%27Add"><span class="hs-identifier hs-var">DiffOp'Add</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(k -&gt; v -&gt; v -&gt; Maybe (DiffOp v))
-&gt; SimpleWhenMatched k v v (DiffOp v)
forall (f :: * -&gt; *) k x y z.
Applicative f =&gt;
(k -&gt; x -&gt; y -&gt; Maybe z) -&gt; WhenMatched f k x y z
</span><span class="hs-identifier hs-var">Map.zipWithMaybeMatched</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">k
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679188780"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679188780"><span class="hs-identifier hs-var">old</span></a></span></span><span> </span><span id="local-6989586621679188781"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679188781"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-55"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679188780"><span class="hs-identifier hs-var">old</span></a></span><span> </span><span class="annot"><span class="annottext">v -&gt; v -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679188781"><span class="hs-identifier hs-var">new</span></a></span><span>
</span><span id="line-56"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe (DiffOp v)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-57"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">DiffOp v -&gt; Maybe (DiffOp v)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Updated v -&gt; DiffOp v
forall a. Updated a -&gt; DiffOp a
</span><a href="Unison.Merge.DiffOp.html#DiffOp%27Update"><span class="hs-identifier hs-var">DiffOp'Update</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.Updated.html#Updated"><span class="hs-identifier hs-type">Updated</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">v
old :: v
$sel:old:Updated :: v
</span><a href="#local-6989586621679188780"><span class="hs-identifier hs-var hs-var">old</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">v
new :: v
$sel:new:Updated :: v
</span><a href="#local-6989586621679188781"><span class="hs-identifier hs-var hs-var">new</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-comment">-- Merge two library dependency diffs together:</span><span>
</span><span id="line-61"></span><span class="hs-comment">--</span><span>
</span><span id="line-62"></span><span class="hs-comment">--   * Keep all adds/updates (allowing conflicts as necessary, which will be resolved later)</span><span>
</span><span id="line-63"></span><span class="hs-comment">--   * Ignore deletes that only one party makes (because the other party may expect the dep to still be there)</span><span>
</span><span id="line-64"></span><span class="annot"><a href="Unison.Merge.Libdeps.html#mergeDiffs"><span class="hs-identifier hs-type">mergeDiffs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679188639"><span class="annot"><a href="#local-6989586621679188639"><span class="hs-identifier hs-type">k</span></a></span></span><span> </span><span id="local-6989586621679188640"><span class="annot"><a href="#local-6989586621679188640"><span class="hs-identifier hs-type">v</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679188639"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679188640"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-comment">-- The LCA-&gt;Alice library dependencies diff.</span><span>
</span><span id="line-68"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679188639"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188640"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-comment">-- The LCA-&gt;Bob library dependencies diff.</span><span>
</span><span id="line-70"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679188639"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188640"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-comment">-- The merged library dependencies diff.</span><span>
</span><span id="line-72"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679188639"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Libdeps.html#LibdepDiffOp"><span class="hs-identifier hs-type">LibdepDiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188640"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span id="mergeDiffs"><span class="annot"><span class="annottext">mergeDiffs :: forall k v.
(Ord k, Eq v) =&gt;
Map k (DiffOp v) -&gt; Map k (DiffOp v) -&gt; Map k (LibdepDiffOp v)
</span><a href="Unison.Merge.Libdeps.html#mergeDiffs"><span class="hs-identifier hs-var hs-var">mergeDiffs</span></a></span></span><span> </span><span id="local-6989586621679188793"><span class="annot"><span class="annottext">Map k (DiffOp v)
</span><a href="#local-6989586621679188793"><span class="hs-identifier hs-var">alice</span></a></span></span><span> </span><span id="local-6989586621679188794"><span class="annot"><span class="annottext">Map k (DiffOp v)
</span><a href="#local-6989586621679188794"><span class="hs-identifier hs-var">bob</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-74"></span><span>  </span><span class="annot"><span class="annottext">Map k (Maybe (LibdepDiffOp v)) -&gt; Map k (LibdepDiffOp v)
forall a. Map k (Maybe a) -&gt; Map k a
forall (f :: * -&gt; *) a. Filterable f =&gt; f (Maybe a) -&gt; f a
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(These (DiffOp v) (DiffOp v) -&gt; Maybe (LibdepDiffOp v))
-&gt; Map k (DiffOp v)
-&gt; Map k (DiffOp v)
-&gt; Map k (Maybe (LibdepDiffOp v))
forall a b c. (These a b -&gt; c) -&gt; Map k a -&gt; Map k b -&gt; Map k c
forall (f :: * -&gt; *) a b c.
Semialign f =&gt;
(These a b -&gt; c) -&gt; f a -&gt; f b -&gt; f c
</span><span class="hs-identifier hs-var">alignWith</span></span><span> </span><span class="annot"><span class="annottext">These (DiffOp v) (DiffOp v) -&gt; Maybe (LibdepDiffOp v)
forall a.
Eq a =&gt;
These (DiffOp a) (DiffOp a) -&gt; Maybe (LibdepDiffOp a)
</span><a href="Unison.Merge.Libdeps.html#combineDiffOps"><span class="hs-identifier hs-var">combineDiffOps</span></a></span><span> </span><span class="annot"><span class="annottext">Map k (DiffOp v)
</span><a href="#local-6989586621679188793"><span class="hs-identifier hs-var">alice</span></a></span><span> </span><span class="annot"><span class="annottext">Map k (DiffOp v)
</span><a href="#local-6989586621679188794"><span class="hs-identifier hs-var">bob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span id="local-6989586621679188680"><span class="annot"><a href="Unison.Merge.Libdeps.html#combineDiffOps"><span class="hs-identifier hs-type">combineDiffOps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679188680"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">These</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188680"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.DiffOp.html#DiffOp"><span class="hs-identifier hs-type">DiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188680"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Libdeps.html#LibdepDiffOp"><span class="hs-identifier hs-type">LibdepDiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188680"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-77"></span><span id="combineDiffOps"><span class="annot"><span class="annottext">combineDiffOps :: forall a.
Eq a =&gt;
These (DiffOp a) (DiffOp a) -&gt; Maybe (LibdepDiffOp a)
</span><a href="Unison.Merge.Libdeps.html#combineDiffOps"><span class="hs-identifier hs-var hs-var">combineDiffOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-78"></span><span>  </span><span class="annot"><span class="annottext">These (DiffOp a) (DiffOp a) -&gt; TwoDiffOps a
forall a. These (DiffOp a) (DiffOp a) -&gt; TwoDiffOps a
</span><a href="Unison.Merge.TwoDiffOps.html#make"><span class="hs-identifier hs-var">TwoDiffOps.make</span></a></span><span> </span><span class="annot"><span class="annottext">(These (DiffOp a) (DiffOp a) -&gt; TwoDiffOps a)
-&gt; (TwoDiffOps a -&gt; Maybe (LibdepDiffOp a))
-&gt; These (DiffOp a) (DiffOp a)
-&gt; Maybe (LibdepDiffOp a)
forall {k} (cat :: k -&gt; k -&gt; *) (a :: k) (b :: k) (c :: k).
Category cat =&gt;
cat a b -&gt; cat b c -&gt; cat a c
</span><span class="hs-operator hs-var">&gt;&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TwoDiffOps a -&gt; Maybe (LibdepDiffOp a)
forall a. Eq a =&gt; TwoDiffOps a -&gt; Maybe (LibdepDiffOp a)
</span><a href="Unison.Merge.Libdeps.html#combineDiffOps1"><span class="hs-identifier hs-var">combineDiffOps1</span></a></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span id="local-6989586621679188690"><span class="annot"><a href="Unison.Merge.Libdeps.html#combineDiffOps1"><span class="hs-identifier hs-type">combineDiffOps1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621679188690"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Unison.Merge.TwoDiffOps.html#TwoDiffOps"><span class="hs-identifier hs-type">TwoDiffOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188690"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Libdeps.html#LibdepDiffOp"><span class="hs-identifier hs-type">LibdepDiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188690"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-81"></span><span id="combineDiffOps1"><span class="annot"><span class="annottext">combineDiffOps1 :: forall a. Eq a =&gt; TwoDiffOps a -&gt; Maybe (LibdepDiffOp a)
</span><a href="Unison.Merge.Libdeps.html#combineDiffOps1"><span class="hs-identifier hs-var hs-var">combineDiffOps1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-82"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoDiffOps.html#TwoDiffOps%27Add"><span class="hs-identifier hs-type">TwoDiffOps'Add</span></a></span><span> </span><span id="local-6989586621679188811"><span class="annot"><span class="annottext">EitherWay a
</span><a href="#local-6989586621679188811"><span class="hs-identifier hs-var">new</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LibdepDiffOp a -&gt; Maybe (LibdepDiffOp a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; LibdepDiffOp a
forall a. a -&gt; LibdepDiffOp a
</span><a href="Unison.Merge.Libdeps.html#AddLibdep"><span class="hs-identifier hs-var">AddLibdep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EitherWay a -&gt; a
forall a. EitherWay a -&gt; a
</span><a href="Unison.Merge.EitherWay.html#value"><span class="hs-identifier hs-var">EitherWay.value</span></a></span><span> </span><span class="annot"><span class="annottext">EitherWay a
</span><a href="#local-6989586621679188811"><span class="hs-identifier hs-var">new</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-comment">-- If Alice deletes a dep and Bob doesn't touch it, ignore the delete, since Bob may still be using it.</span><span>
</span><span id="line-84"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoDiffOps.html#TwoDiffOps%27Delete"><span class="hs-identifier hs-type">TwoDiffOps'Delete</span></a></span><span> </span><span id="local-6989586621679188814"><span class="annot"><span class="annottext">EitherWay a
</span><a href="#local-6989586621679188814"><span class="hs-identifier hs-var">_old</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (LibdepDiffOp a)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-comment">-- If Alice updates a dep and Bob doesn't touch it, keep the old one around too, since Bob may still be using it.</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoDiffOps.html#TwoDiffOps%27Update"><span class="hs-identifier hs-type">TwoDiffOps'Update</span></a></span><span> </span><span id="local-6989586621679188816"><span class="annot"><span class="annottext">EitherWay (Updated a)
</span><a href="#local-6989586621679188816"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LibdepDiffOp a -&gt; Maybe (LibdepDiffOp a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; LibdepDiffOp a
forall a. a -&gt; a -&gt; LibdepDiffOp a
</span><a href="Unison.Merge.Libdeps.html#AddBothLibdeps"><span class="hs-identifier hs-var">AddBothLibdeps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EitherWay (Updated a) -&gt; Updated a
forall a. EitherWay a -&gt; a
</span><a href="Unison.Merge.EitherWay.html#value"><span class="hs-identifier hs-var">EitherWay.value</span></a></span><span> </span><span class="annot"><span class="annottext">EitherWay (Updated a)
</span><a href="#local-6989586621679188816"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-operator">.</span><span class="hs-identifier">old</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EitherWay (Updated a) -&gt; Updated a
forall a. EitherWay a -&gt; a
</span><a href="Unison.Merge.EitherWay.html#value"><span class="hs-identifier hs-var">EitherWay.value</span></a></span><span> </span><span class="annot"><span class="annottext">EitherWay (Updated a)
</span><a href="#local-6989586621679188816"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-operator">.</span><span class="hs-identifier">new</span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoDiffOps.html#TwoDiffOps%27AddAdd"><span class="hs-identifier hs-type">TwoDiffOps'AddAdd</span></a></span><span> </span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier hs-type">TwoWay</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679188819"><span class="annot"><span class="annottext">a
alice :: a
$sel:alice:TwoWay :: forall a. TwoWay a -&gt; a
</span><a href="#local-6989586621679188819"><span class="hs-identifier hs-var hs-var">alice</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679188821"><span class="annot"><span class="annottext">a
bob :: a
$sel:bob:TwoWay :: forall a. TwoWay a -&gt; a
</span><a href="#local-6989586621679188821"><span class="hs-identifier hs-var hs-var">bob</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679188819"><span class="hs-identifier hs-var">alice</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679188821"><span class="hs-identifier hs-var">bob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LibdepDiffOp a -&gt; Maybe (LibdepDiffOp a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; LibdepDiffOp a
forall a. a -&gt; LibdepDiffOp a
</span><a href="Unison.Merge.Libdeps.html#AddLibdep"><span class="hs-identifier hs-var">AddLibdep</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679188819"><span class="hs-identifier hs-var">alice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LibdepDiffOp a -&gt; Maybe (LibdepDiffOp a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; LibdepDiffOp a
forall a. a -&gt; a -&gt; LibdepDiffOp a
</span><a href="Unison.Merge.Libdeps.html#AddBothLibdeps"><span class="hs-identifier hs-var">AddBothLibdeps</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679188819"><span class="hs-identifier hs-var">alice</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679188821"><span class="hs-identifier hs-var">bob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-comment">-- If Alice and Bob both delete something, delete it.</span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoDiffOps.html#TwoDiffOps%27DeleteDelete"><span class="hs-identifier hs-type">TwoDiffOps'DeleteDelete</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LibdepDiffOp a -&gt; Maybe (LibdepDiffOp a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">LibdepDiffOp a
forall a. LibdepDiffOp a
</span><a href="Unison.Merge.Libdeps.html#DeleteLibdep"><span class="hs-identifier hs-var">DeleteLibdep</span></a></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-comment">-- If Alice updates a dependency and Bob deletes the old one, ignore the delete and keep Alice's, and vice versa.</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoDiffOps.html#TwoDiffOps%27DeleteUpdate"><span class="hs-identifier hs-type">TwoDiffOps'DeleteUpdate</span></a></span><span> </span><span id="local-6989586621679188825"><span class="annot"><span class="annottext">Updated a
</span><a href="#local-6989586621679188825"><span class="hs-identifier hs-var">bob</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LibdepDiffOp a -&gt; Maybe (LibdepDiffOp a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; LibdepDiffOp a
forall a. a -&gt; LibdepDiffOp a
</span><a href="Unison.Merge.Libdeps.html#AddLibdep"><span class="hs-identifier hs-var">AddLibdep</span></a></span><span> </span><span class="annot"><span class="annottext">Updated a
</span><a href="#local-6989586621679188825"><span class="hs-identifier hs-var">bob</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">new</span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoDiffOps.html#TwoDiffOps%27UpdateDelete"><span class="hs-identifier hs-type">TwoDiffOps'UpdateDelete</span></a></span><span> </span><span id="local-6989586621679188827"><span class="annot"><span class="annottext">Updated a
</span><a href="#local-6989586621679188827"><span class="hs-identifier hs-var">alice</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LibdepDiffOp a -&gt; Maybe (LibdepDiffOp a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; LibdepDiffOp a
forall a. a -&gt; LibdepDiffOp a
</span><a href="Unison.Merge.Libdeps.html#AddLibdep"><span class="hs-identifier hs-var">AddLibdep</span></a></span><span> </span><span class="annot"><span class="annottext">Updated a
</span><a href="#local-6989586621679188827"><span class="hs-identifier hs-var">alice</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">new</span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-comment">-- combineDiffOps (Deleted _) (Updated _ bob) = AddLibdep bob</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-comment">-- combineDiffOps (Updated _ alice) (Deleted _) = AddLibdep alice</span><span>
</span><span id="line-97"></span><span>  </span><span class="annot"><a href="Unison.Merge.TwoDiffOps.html#TwoDiffOps%27UpdateUpdate"><span class="hs-identifier hs-type">TwoDiffOps'UpdateUpdate</span></a></span><span> </span><span id="local-6989586621679188829"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679188829"><span class="hs-identifier hs-var">_old</span></a></span></span><span> </span><span class="annot"><a href="Unison.Merge.TwoWay.html#TwoWay"><span class="hs-identifier hs-type">TwoWay</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679188830"><span class="annot"><span class="annottext">a
$sel:alice:TwoWay :: forall a. TwoWay a -&gt; a
alice :: a
</span><a href="Unison.Merge.TwoWay.html#%24sel%3Aalice%3ATwoWay"><span class="hs-identifier hs-var hs-var">alice</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679188831"><span class="annot"><span class="annottext">a
$sel:bob:TwoWay :: forall a. TwoWay a -&gt; a
bob :: a
</span><a href="Unison.Merge.TwoWay.html#%24sel%3Abob%3ATwoWay"><span class="hs-identifier hs-var hs-var">bob</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679188830"><span class="hs-identifier hs-var">alice</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679188831"><span class="hs-identifier hs-var">bob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LibdepDiffOp a -&gt; Maybe (LibdepDiffOp a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; LibdepDiffOp a
forall a. a -&gt; LibdepDiffOp a
</span><a href="Unison.Merge.Libdeps.html#AddLibdep"><span class="hs-identifier hs-var">AddLibdep</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679188830"><span class="hs-identifier hs-var">alice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LibdepDiffOp a -&gt; Maybe (LibdepDiffOp a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; a -&gt; LibdepDiffOp a
forall a. a -&gt; a -&gt; LibdepDiffOp a
</span><a href="Unison.Merge.Libdeps.html#AddBothLibdeps"><span class="hs-identifier hs-var">AddBothLibdeps</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679188830"><span class="hs-identifier hs-var">alice</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679188831"><span class="hs-identifier hs-var">bob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- Applying libdeps diff</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-comment">-- Apply a library dependencies diff to the LCA.</span><span>
</span><span id="line-105"></span><span class="annot"><a href="Unison.Merge.Libdeps.html#applyLibdepsDiff"><span class="hs-identifier hs-type">applyLibdepsDiff</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679188697"><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span></span><span> </span><span id="local-6989586621679188699"><span class="annot"><a href="#local-6989586621679188699"><span class="hs-identifier hs-type">v</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-108"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Freshen a name, e.g. &quot;base&quot; -&gt; (&quot;base__4&quot;, &quot;base__5&quot;).</span></span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-110"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Library dependencies.</span></span><span>
</span><span id="line-111"></span><span>  </span><span class="annot"><a href="Unison.Merge.ThreeWay.html#ThreeWay"><span class="hs-identifier hs-type">ThreeWay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188699"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-112"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Library dependencies diff.</span></span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Unison.Merge.Libdeps.html#LibdepDiffOp"><span class="hs-identifier hs-type">LibdepDiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188699"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><span class="hs-comment">-- | Merged library dependencies.</span></span><span>
</span><span id="line-115"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188699"><span class="hs-identifier hs-type">v</span></a></span><span>
</span><span id="line-116"></span><span id="applyLibdepsDiff"><span class="annot"><span class="annottext">applyLibdepsDiff :: forall k v.
Ord k =&gt;
(Set k -&gt; k -&gt; (k, k))
-&gt; ThreeWay (Map k v) -&gt; Map k (LibdepDiffOp v) -&gt; Map k v
</span><a href="Unison.Merge.Libdeps.html#applyLibdepsDiff"><span class="hs-identifier hs-var hs-var">applyLibdepsDiff</span></a></span></span><span> </span><span id="local-6989586621679188844"><span class="annot"><span class="annottext">Set k -&gt; k -&gt; (k, k)
</span><a href="#local-6989586621679188844"><span class="hs-identifier hs-var">freshen0</span></a></span></span><span> </span><span id="local-6989586621679188845"><span class="annot"><span class="annottext">ThreeWay (Map k v)
</span><a href="#local-6989586621679188845"><span class="hs-identifier hs-var">libdeps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><span class="annottext">(k -&gt; v -&gt; Map k v)
-&gt; (k -&gt; LibdepDiffOp v -&gt; Map k v)
-&gt; (k -&gt; v -&gt; LibdepDiffOp v -&gt; Map k v)
-&gt; Map k v
-&gt; Map k (LibdepDiffOp v)
-&gt; Map k v
forall a b k m.
(Monoid m, Ord k) =&gt;
(k -&gt; a -&gt; m)
-&gt; (k -&gt; b -&gt; m) -&gt; (k -&gt; a -&gt; b -&gt; m) -&gt; Map k a -&gt; Map k b -&gt; m
</span><span class="hs-identifier hs-var">Map.mergeMap</span></span><span> </span><span class="annot"><span class="annottext">k -&gt; v -&gt; Map k v
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.singleton</span></span><span> </span><span class="annot"><span class="annottext">k -&gt; LibdepDiffOp v -&gt; Map k v
</span><a href="#local-6989586621679188848"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679188849"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679188849"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">v
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">k -&gt; LibdepDiffOp v -&gt; Map k v
</span><a href="#local-6989586621679188848"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679188849"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ThreeWay (Map k v)
</span><a href="#local-6989586621679188845"><span class="hs-identifier hs-var">libdeps</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">lca</span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-119"></span><span>    </span><span class="annot"><a href="#local-6989586621679188848"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Unison.Merge.Libdeps.html#LibdepDiffOp"><span class="hs-identifier hs-type">LibdepDiffOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188699"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Map</span></span><span> </span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679188699"><span class="hs-identifier hs-type">v</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span id="local-6989586621679188848"><span class="annot"><span class="annottext">f :: k -&gt; LibdepDiffOp v -&gt; Map k v
</span><a href="#local-6989586621679188848"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679188850"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679188850"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-121"></span><span>      </span><span class="annot"><a href="Unison.Merge.Libdeps.html#AddLibdep"><span class="hs-identifier hs-type">AddLibdep</span></a></span><span> </span><span id="local-6989586621679188851"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679188851"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">k -&gt; v -&gt; Map k v
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.singleton</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679188850"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679188851"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-122"></span><span>      </span><span class="annot"><a href="Unison.Merge.Libdeps.html#AddBothLibdeps"><span class="hs-identifier hs-type">AddBothLibdeps</span></a></span><span> </span><span id="local-6989586621679188852"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679188852"><span class="hs-identifier hs-var">v1</span></a></span></span><span> </span><span id="local-6989586621679188853"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679188853"><span class="hs-identifier hs-var">v2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-123"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679188854"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679188854"><span class="hs-identifier hs-var">k1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679188855"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679188855"><span class="hs-identifier hs-var">k2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k -&gt; (k, k)
</span><a href="#local-6989586621679188856"><span class="hs-identifier hs-var">freshen</span></a></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679188850"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-124"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[(k, v)] -&gt; Map k v
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679188854"><span class="hs-identifier hs-var">k1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679188852"><span class="hs-identifier hs-var">v1</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621679188855"><span class="hs-identifier hs-var">k2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679188853"><span class="hs-identifier hs-var">v2</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-125"></span><span>      </span><span class="annot"><span class="annottext">LibdepDiffOp v
</span><a href="Unison.Merge.Libdeps.html#DeleteLibdep"><span class="hs-identifier hs-var">DeleteLibdep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Map k v
forall k a. Map k a
</span><span class="hs-identifier hs-var">Map.empty</span></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><a href="#local-6989586621679188856"><span class="hs-identifier hs-type">freshen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679188697"><span class="hs-identifier hs-type">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>    </span><span id="local-6989586621679188856"><span class="annot"><span class="annottext">freshen :: k -&gt; (k, k)
</span><a href="#local-6989586621679188856"><span class="hs-identifier hs-var hs-var">freshen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-129"></span><span>      </span><span class="annot"><span class="annottext">Set k -&gt; k -&gt; (k, k)
</span><a href="#local-6989586621679188844"><span class="hs-identifier hs-var">freshen0</span></a></span><span> </span><span class="annot"><span class="annottext">(Set k -&gt; k -&gt; (k, k)) -&gt; Set k -&gt; k -&gt; (k, k)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-130"></span><span>        </span><span class="annot"><span class="annottext">[Set k] -&gt; Set k
forall (f :: * -&gt; *) a. (Foldable f, Ord a) =&gt; f (Set a) -&gt; Set a
</span><span class="hs-identifier hs-var">Set.unions</span></span><span>
</span><span id="line-131"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Map k v -&gt; Set k
forall k a. Map k a -&gt; Set k
</span><span class="hs-identifier hs-var">Map.keysSet</span></span><span> </span><span class="annot"><span class="annottext">ThreeWay (Map k v)
</span><a href="#local-6989586621679188845"><span class="hs-identifier hs-var">libdeps</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">lca</span><span class="hs-special">,</span><span>
</span><span id="line-132"></span><span>            </span><span class="annot"><span class="annottext">Map k v -&gt; Set k
forall k a. Map k a -&gt; Set k
</span><span class="hs-identifier hs-var">Map.keysSet</span></span><span> </span><span class="annot"><span class="annottext">ThreeWay (Map k v)
</span><a href="#local-6989586621679188845"><span class="hs-identifier hs-var">libdeps</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">alice</span><span class="hs-special">,</span><span>
</span><span id="line-133"></span><span>            </span><span class="annot"><span class="annottext">Map k v -&gt; Set k
forall k a. Map k a -&gt; Set k
</span><span class="hs-identifier hs-var">Map.keysSet</span></span><span> </span><span class="annot"><span class="annottext">ThreeWay (Map k v)
</span><a href="#local-6989586621679188845"><span class="hs-identifier hs-var">libdeps</span></a></span><span class="hs-operator">.</span><span class="hs-identifier">bob</span><span>
</span><span id="line-134"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="hs-comment">------------------------------------------------------------------------------------------------------------------------</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- Getting fresh libdeps names</span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="hs-comment">-- Given a name like &quot;base&quot;, try &quot;base__1&quot;, then &quot;base__2&quot;, etc, until we find a name that doesn't</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- clash with any existing dependencies.</span><span>
</span><span id="line-141"></span><span class="annot"><a href="Unison.Merge.Libdeps.html#getTwoFreshLibdepNames"><span class="hs-identifier hs-type">getTwoFreshLibdepNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">NameSegment</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NameSegment</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NameSegment</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NameSegment</span></span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span id="getTwoFreshLibdepNames"><span class="annot"><span class="annottext">getTwoFreshLibdepNames :: Set NameSegment -&gt; NameSegment -&gt; (NameSegment, NameSegment)
</span><a href="Unison.Merge.Libdeps.html#getTwoFreshLibdepNames"><span class="hs-identifier hs-var hs-var">getTwoFreshLibdepNames</span></a></span></span><span> </span><span id="local-6989586621679188861"><span class="annot"><span class="annottext">Set NameSegment
</span><a href="#local-6989586621679188861"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621679188862"><span class="annot"><span class="annottext">NameSegment
</span><a href="#local-6989586621679188862"><span class="hs-identifier hs-var">name0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-143"></span><span>  </span><span class="annot"><span class="annottext">Integer -&gt; (NameSegment, NameSegment)
</span><a href="#local-6989586621679188863"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-comment">-- if</span><span>
</span><span id="line-146"></span><span>    </span><span class="hs-comment">--   name0 = &quot;base&quot;</span><span>
</span><span id="line-147"></span><span>    </span><span class="hs-comment">--   names = {&quot;base__5&quot;, &quot;base__6&quot;}</span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-comment">-- then</span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-comment">--   go2 4 = (&quot;base__4&quot;, &quot;base__7&quot;)</span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><a href="#local-6989586621679188863"><span class="hs-identifier hs-type">go2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NameSegment</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NameSegment</span></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>    </span><span id="local-6989586621679188863"><span class="annot"><span class="annottext">go2 :: Integer -&gt; (NameSegment, NameSegment)
</span><a href="#local-6989586621679188863"><span class="hs-identifier hs-var hs-var">go2</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679188864"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679188864"><span class="hs-identifier hs-var">i</span></a></span></span><span>
</span><span id="line-152"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">NameSegment -&gt; Set NameSegment -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">NameSegment
</span><a href="#local-6989586621679188866"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Set NameSegment
</span><a href="#local-6989586621679188861"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; (NameSegment, NameSegment)
</span><a href="#local-6989586621679188863"><span class="hs-identifier hs-var">go2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679188864"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NameSegment
</span><a href="#local-6989586621679188866"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; NameSegment
</span><a href="#local-6989586621679188868"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679188864"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-155"></span><span>        </span><span id="local-6989586621679188866"><span class="annot"><span class="annottext">name :: NameSegment
</span><a href="#local-6989586621679188866"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; NameSegment
</span><a href="#local-6989586621679188869"><span class="hs-identifier hs-var">mangled</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679188864"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-comment">-- if</span><span>
</span><span id="line-158"></span><span>    </span><span class="hs-comment">--   name0 = &quot;base&quot;</span><span>
</span><span id="line-159"></span><span>    </span><span class="hs-comment">--   names = {&quot;base__5&quot;, &quot;base__6&quot;}</span><span>
</span><span id="line-160"></span><span>    </span><span class="hs-comment">-- then</span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-comment">--   go1 5 = &quot;base__7&quot;</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><a href="#local-6989586621679188868"><span class="hs-identifier hs-type">go1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NameSegment</span></span><span>
</span><span id="line-163"></span><span>    </span><span id="local-6989586621679188868"><span class="annot"><span class="annottext">go1 :: Integer -&gt; NameSegment
</span><a href="#local-6989586621679188868"><span class="hs-identifier hs-var hs-var">go1</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679188870"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679188870"><span class="hs-identifier hs-var">i</span></a></span></span><span>
</span><span id="line-164"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">NameSegment -&gt; Set NameSegment -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-identifier hs-var">Set.member</span></span><span> </span><span class="annot"><span class="annottext">NameSegment
</span><a href="#local-6989586621679188871"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Set NameSegment
</span><a href="#local-6989586621679188861"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; NameSegment
</span><a href="#local-6989586621679188868"><span class="hs-identifier hs-var">go1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679188870"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NameSegment
</span><a href="#local-6989586621679188871"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-166"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-167"></span><span>        </span><span id="local-6989586621679188871"><span class="annot"><span class="annottext">name :: NameSegment
</span><a href="#local-6989586621679188871"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; NameSegment
</span><a href="#local-6989586621679188869"><span class="hs-identifier hs-var">mangled</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679188870"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><a href="#local-6989586621679188869"><span class="hs-identifier hs-type">mangled</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NameSegment</span></span><span>
</span><span id="line-170"></span><span>    </span><span id="local-6989586621679188869"><span class="annot"><span class="annottext">mangled :: Integer -&gt; NameSegment
</span><a href="#local-6989586621679188869"><span class="hs-identifier hs-var hs-var">mangled</span></a></span></span><span> </span><span id="local-6989586621679188872"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679188872"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-171"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; NameSegment
</span><span class="hs-identifier hs-var">NameSegment</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NameSegment -&gt; Text
</span><span class="hs-identifier hs-var">NameSegment.toUnescapedText</span></span><span> </span><span class="annot"><span class="annottext">NameSegment
</span><a href="#local-6989586621679188862"><span class="hs-identifier hs-var">name0</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;__&quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Text
forall a. Show a =&gt; a -&gt; Text
</span><span class="hs-identifier hs-var">tShow</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679188872"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-172"></span></pre></body></html>