<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns, TypeSynonymInstances, FlexibleInstances, TupleSections #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# OPTIONS_GHC -O2 #-}</span><span>
</span><span id="line-3"></span><span class="hs-comment">{- Building this module with -O0 causes streams not to fuse and too much
 - memory to be used. -}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">-- | </span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Copyright: 2015 Joey Hess &lt;id@joeyh.name&gt;</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- License: BSD-2-clause</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- </span><span>
</span><span id="line-10"></span><span class="hs-comment">-- Concurrent output handling, internals.</span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- May change at any time.</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">System.Console.Concurrent.Internal</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Directory</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Exit</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">liftIO</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">MonadIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.IO.Unsafe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafePerformIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.STM</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.Async</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Monoid</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">System.Process</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">P</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.IO</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Utility.Monad.html"><span class="hs-identifier">Utility.Monad</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Utility.Exception.html"><span class="hs-identifier">Utility.Exception</span></a></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">data</span><span> </span><span id="OutputHandle"><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputHandle"><span class="hs-identifier hs-var">OutputHandle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="OutputHandle"><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputHandle"><span class="hs-identifier hs-var">OutputHandle</span></a></span></span><span>
</span><span id="line-39"></span><span>	</span><span class="hs-special">{</span><span> </span><span id="outputLock"><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar Lock
</span><a href="System.Console.Concurrent.Internal.html#outputLock"><span class="hs-identifier hs-var hs-var">outputLock</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TMVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Lock"><span class="hs-identifier hs-type">Lock</span></a></span><span>
</span><span id="line-40"></span><span>	</span><span class="hs-special">,</span><span> </span><span id="outputBuffer"><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#outputBuffer"><span class="hs-identifier hs-var hs-var">outputBuffer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TMVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span>
</span><span id="line-41"></span><span>	</span><span class="hs-special">,</span><span> </span><span id="errorBuffer"><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#errorBuffer"><span class="hs-identifier hs-var hs-var">errorBuffer</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TMVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span>
</span><span id="line-42"></span><span>	</span><span class="hs-special">,</span><span> </span><span id="outputThreads"><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar Integer
</span><a href="System.Console.Concurrent.Internal.html#outputThreads"><span class="hs-identifier hs-var hs-var">outputThreads</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TMVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span>
</span><span id="line-43"></span><span>	</span><span class="hs-special">}</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">data</span><span> </span><span id="Lock"><span class="annot"><a href="System.Console.Concurrent.Internal.html#Lock"><span class="hs-identifier hs-var">Lock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Locked"><span class="annot"><a href="System.Console.Concurrent.Internal.html#Locked"><span class="hs-identifier hs-var">Locked</span></a></span></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="annot"><span class="hs-comment">-- | A shared global variable for the OutputHandle.</span></span><span>
</span><span id="line-48"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#globalOutputHandle"><span class="hs-pragma hs-type">globalOutputHandle</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-49"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#globalOutputHandle"><span class="hs-identifier hs-type">globalOutputHandle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputHandle"><span class="hs-identifier hs-type">OutputHandle</span></a></span><span>
</span><span id="line-50"></span><span id="globalOutputHandle"><span class="annot"><span class="annottext">globalOutputHandle :: OutputHandle
</span><a href="System.Console.Concurrent.Internal.html#globalOutputHandle"><span class="hs-identifier hs-var hs-var">globalOutputHandle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO OutputHandle -&gt; OutputHandle
forall a. IO a -&gt; a
</span><span class="hs-identifier hs-var">unsafePerformIO</span></span><span> </span><span class="annot"><span class="annottext">(IO OutputHandle -&gt; OutputHandle)
-&gt; IO OutputHandle -&gt; OutputHandle
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar Lock
-&gt; TMVar OutputBuffer
-&gt; TMVar OutputBuffer
-&gt; TMVar Integer
-&gt; OutputHandle
</span><a href="System.Console.Concurrent.Internal.html#OutputHandle"><span class="hs-identifier hs-var">OutputHandle</span></a></span><span>
</span><span id="line-51"></span><span>	</span><span class="annot"><span class="annottext">(TMVar Lock
 -&gt; TMVar OutputBuffer
 -&gt; TMVar OutputBuffer
 -&gt; TMVar Integer
 -&gt; OutputHandle)
-&gt; IO (TMVar Lock)
-&gt; IO
     (TMVar OutputBuffer
      -&gt; TMVar OutputBuffer -&gt; TMVar Integer -&gt; OutputHandle)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO (TMVar Lock)
forall a. IO (TMVar a)
</span><span class="hs-identifier hs-var">newEmptyTMVarIO</span></span><span>
</span><span id="line-52"></span><span>	</span><span class="annot"><span class="annottext">IO
  (TMVar OutputBuffer
   -&gt; TMVar OutputBuffer -&gt; TMVar Integer -&gt; OutputHandle)
-&gt; IO (TMVar OutputBuffer)
-&gt; IO (TMVar OutputBuffer -&gt; TMVar Integer -&gt; OutputHandle)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">OutputBuffer -&gt; IO (TMVar OutputBuffer)
forall a. a -&gt; IO (TMVar a)
</span><span class="hs-identifier hs-var">newTMVarIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>	</span><span class="annot"><span class="annottext">IO (TMVar OutputBuffer -&gt; TMVar Integer -&gt; OutputHandle)
-&gt; IO (TMVar OutputBuffer) -&gt; IO (TMVar Integer -&gt; OutputHandle)
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">OutputBuffer -&gt; IO (TMVar OutputBuffer)
forall a. a -&gt; IO (TMVar a)
</span><span class="hs-identifier hs-var">newTMVarIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>	</span><span class="annot"><span class="annottext">IO (TMVar Integer -&gt; OutputHandle)
-&gt; IO (TMVar Integer) -&gt; IO OutputHandle
forall a b. IO (a -&gt; b) -&gt; IO a -&gt; IO b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; IO (TMVar Integer)
forall a. a -&gt; IO (TMVar a)
</span><span class="hs-identifier hs-var">newTMVarIO</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-comment">-- | Holds a lock while performing an action. This allows the action to</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- perform its own output to the console, without using functions from this</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- module.</span><span>
</span><span id="line-59"></span><span class="hs-comment">--</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- While this is running, other threads that try to lockOutput will block.</span><span>
</span><span id="line-61"></span><span class="hs-comment">-- Any calls to `outputConcurrent` and `createProcessConcurrent` will not</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- block, but the output will be buffered and displayed only once the</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- action is done.</span><span>
</span><span id="line-64"></span><span id="local-6989586621679072132"><span id="local-6989586621679072133"><span class="annot"><a href="System.Console.Concurrent.Internal.html#lockOutput"><span class="hs-identifier hs-type">lockOutput</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679072132"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679072132"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679072132"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072133"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679072132"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072133"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-65"></span><span id="lockOutput"><span class="annot"><span class="annottext">lockOutput :: forall (m :: * -&gt; *) a. (MonadIO m, MonadMask m) =&gt; m a -&gt; m a
</span><a href="System.Console.Concurrent.Internal.html#lockOutput"><span class="hs-identifier hs-var hs-var">lockOutput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; m () -&gt; m a -&gt; m a
forall (m :: * -&gt; *) a c b.
(HasCallStack, MonadMask m) =&gt;
m a -&gt; m c -&gt; m b -&gt; m b
</span><span class="hs-identifier hs-var">bracket_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="System.Console.Concurrent.Internal.html#takeOutputLock"><span class="hs-identifier hs-var">takeOutputLock</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="System.Console.Concurrent.Internal.html#dropOutputLock"><span class="hs-identifier hs-var">dropOutputLock</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="annot"><span class="hs-comment">-- | Blocks until we have the output lock.</span></span><span>
</span><span id="line-68"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#takeOutputLock"><span class="hs-identifier hs-type">takeOutputLock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span id="takeOutputLock"><span class="annot"><span class="annottext">takeOutputLock :: IO ()
</span><a href="System.Console.Concurrent.Internal.html#takeOutputLock"><span class="hs-identifier hs-var hs-var">takeOutputLock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; IO ()) -&gt; IO Bool -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
</span><a href="System.Console.Concurrent.Internal.html#takeOutputLock%27"><span class="hs-identifier hs-var">takeOutputLock'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="annot"><span class="hs-comment">-- | Tries to take the output lock, without blocking.</span></span><span>
</span><span id="line-72"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#tryTakeOutputLock"><span class="hs-identifier hs-type">tryTakeOutputLock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-73"></span><span id="tryTakeOutputLock"><span class="annot"><span class="annottext">tryTakeOutputLock :: IO Bool
</span><a href="System.Console.Concurrent.Internal.html#tryTakeOutputLock"><span class="hs-identifier hs-var hs-var">tryTakeOutputLock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
</span><a href="System.Console.Concurrent.Internal.html#takeOutputLock%27"><span class="hs-identifier hs-var">takeOutputLock'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span id="local-6989586621679072144"><span class="annot"><a href="System.Console.Concurrent.Internal.html#withLock"><span class="hs-identifier hs-type">withLock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TMVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Lock"><span class="hs-identifier hs-type">Lock</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="annot"><a href="#local-6989586621679072144"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679072144"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-76"></span><span id="withLock"><span class="annot"><span class="annottext">withLock :: forall a. (TMVar Lock -&gt; STM a) -&gt; IO a
</span><a href="System.Console.Concurrent.Internal.html#withLock"><span class="hs-identifier hs-var hs-var">withLock</span></a></span></span><span> </span><span id="local-6989586621679072395"><span class="annot"><span class="annottext">TMVar Lock -&gt; STM a
</span><a href="#local-6989586621679072395"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM a -&gt; IO a
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM a -&gt; IO a) -&gt; STM a -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar Lock -&gt; STM a
</span><a href="#local-6989586621679072395"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar Lock
</span><a href="System.Console.Concurrent.Internal.html#outputLock"><span class="hs-identifier hs-var">outputLock</span></a></span><span> </span><span class="annot"><span class="annottext">OutputHandle
</span><a href="System.Console.Concurrent.Internal.html#globalOutputHandle"><span class="hs-identifier hs-var">globalOutputHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#takeOutputLock%27"><span class="hs-identifier hs-type">takeOutputLock'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-79"></span><span id="takeOutputLock%27"><span class="annot"><span class="annottext">takeOutputLock' :: Bool -&gt; IO Bool
</span><a href="System.Console.Concurrent.Internal.html#takeOutputLock%27"><span class="hs-identifier hs-var hs-var">takeOutputLock'</span></a></span></span><span> </span><span id="local-6989586621679072397"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679072397"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-80"></span><span>	</span><span id="local-6989586621679072398"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679072398"><span class="hs-identifier hs-var">locked</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TMVar Lock -&gt; STM Bool) -&gt; IO Bool
forall a. (TMVar Lock -&gt; STM a) -&gt; IO a
</span><a href="System.Console.Concurrent.Internal.html#withLock"><span class="hs-identifier hs-var">withLock</span></a></span><span> </span><span class="annot"><span class="annottext">((TMVar Lock -&gt; STM Bool) -&gt; IO Bool)
-&gt; (TMVar Lock -&gt; STM Bool) -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679072399"><span class="annot"><span class="annottext">TMVar Lock
</span><a href="#local-6989586621679072399"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-81"></span><span>		</span><span id="local-6989586621679072400"><span class="annot"><span class="annottext">Maybe Lock
</span><a href="#local-6989586621679072400"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMVar Lock -&gt; STM (Maybe Lock)
forall a. TMVar a -&gt; STM (Maybe a)
</span><span class="hs-identifier hs-var">tryTakeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar Lock
</span><a href="#local-6989586621679072399"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-82"></span><span>		</span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Lock
</span><a href="#local-6989586621679072400"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-83"></span><span>			</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Lock
</span><a href="System.Console.Concurrent.Internal.html#Locked"><span class="hs-identifier hs-var">Locked</span></a></span><span>
</span><span id="line-84"></span><span>				</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679072397"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM Bool
forall a. STM a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-85"></span><span>				</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-86"></span><span>					</span><span class="hs-comment">-- Restore value we took.</span><span>
</span><span id="line-87"></span><span>					</span><span class="annot"><span class="annottext">TMVar Lock -&gt; Lock -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar Lock
</span><a href="#local-6989586621679072399"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Lock
</span><a href="System.Console.Concurrent.Internal.html#Locked"><span class="hs-identifier hs-var">Locked</span></a></span><span>
</span><span id="line-88"></span><span>					</span><span class="annot"><span class="annottext">Bool -&gt; STM Bool
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-89"></span><span>			</span><span class="annot"><span class="annottext">Maybe Lock
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-90"></span><span>				</span><span class="annot"><span class="annottext">TMVar Lock -&gt; Lock -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar Lock
</span><a href="#local-6989586621679072399"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Lock
</span><a href="System.Console.Concurrent.Internal.html#Locked"><span class="hs-identifier hs-var">Locked</span></a></span><span>
</span><span id="line-91"></span><span>				</span><span class="annot"><span class="annottext">Bool -&gt; STM Bool
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-92"></span><span>	</span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679072398"><span class="hs-identifier hs-var">locked</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-93"></span><span>		</span><span class="hs-special">(</span><span id="local-6989586621679072405"><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072405"><span class="hs-identifier hs-var">outbuf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072406"><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072406"><span class="hs-identifier hs-var">errbuf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (OutputBuffer, OutputBuffer) -&gt; IO (OutputBuffer, OutputBuffer)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (OutputBuffer, OutputBuffer)
 -&gt; IO (OutputBuffer, OutputBuffer))
-&gt; STM (OutputBuffer, OutputBuffer)
-&gt; IO (OutputBuffer, OutputBuffer)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>			</span><span class="annot"><span class="annottext">(OutputBuffer -&gt; OutputBuffer -&gt; (OutputBuffer, OutputBuffer))
-&gt; STM OutputBuffer
-&gt; STM (OutputBuffer -&gt; (OutputBuffer, OutputBuffer))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMVar OutputBuffer -&gt; OutputBuffer -&gt; STM OutputBuffer
forall a. TMVar a -&gt; a -&gt; STM a
</span><span class="hs-identifier hs-var">swapTMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#outputBuffer"><span class="hs-identifier hs-var">outputBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">OutputHandle
</span><a href="System.Console.Concurrent.Internal.html#globalOutputHandle"><span class="hs-identifier hs-var">globalOutputHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>			</span><span class="annot"><span class="annottext">STM (OutputBuffer -&gt; (OutputBuffer, OutputBuffer))
-&gt; STM OutputBuffer -&gt; STM (OutputBuffer, OutputBuffer)
forall a b. STM (a -&gt; b) -&gt; STM a -&gt; STM b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMVar OutputBuffer -&gt; OutputBuffer -&gt; STM OutputBuffer
forall a. TMVar a -&gt; a -&gt; STM a
</span><span class="hs-identifier hs-var">swapTMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#errorBuffer"><span class="hs-identifier hs-var">errorBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">OutputHandle
</span><a href="System.Console.Concurrent.Internal.html#globalOutputHandle"><span class="hs-identifier hs-var">globalOutputHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>		</span><span class="annot"><span class="annottext">StdHandle -&gt; OutputBuffer -&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#emitOutputBuffer"><span class="hs-identifier hs-var">emitOutputBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="System.Console.Concurrent.Internal.html#StdOut"><span class="hs-identifier hs-var">StdOut</span></a></span><span> </span><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072405"><span class="hs-identifier hs-var">outbuf</span></a></span><span>
</span><span id="line-97"></span><span>		</span><span class="annot"><span class="annottext">StdHandle -&gt; OutputBuffer -&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#emitOutputBuffer"><span class="hs-identifier hs-var">emitOutputBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="System.Console.Concurrent.Internal.html#StdErr"><span class="hs-identifier hs-var">StdErr</span></a></span><span> </span><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072406"><span class="hs-identifier hs-var">errbuf</span></a></span><span>
</span><span id="line-98"></span><span>	</span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679072398"><span class="hs-identifier hs-var">locked</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="annot"><span class="hs-comment">-- | Only safe to call after taking the output lock.</span></span><span>
</span><span id="line-101"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#dropOutputLock"><span class="hs-identifier hs-type">dropOutputLock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-102"></span><span id="dropOutputLock"><span class="annot"><span class="annottext">dropOutputLock :: IO ()
</span><a href="System.Console.Concurrent.Internal.html#dropOutputLock"><span class="hs-identifier hs-var hs-var">dropOutputLock</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TMVar Lock -&gt; STM ()) -&gt; IO ()
forall a. (TMVar Lock -&gt; STM a) -&gt; IO a
</span><a href="System.Console.Concurrent.Internal.html#withLock"><span class="hs-identifier hs-var">withLock</span></a></span><span> </span><span class="annot"><span class="annottext">((TMVar Lock -&gt; STM ()) -&gt; IO ())
-&gt; (TMVar Lock -&gt; STM ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">STM Lock -&gt; STM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(STM Lock -&gt; STM ())
-&gt; (TMVar Lock -&gt; STM Lock) -&gt; TMVar Lock -&gt; STM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TMVar Lock -&gt; STM Lock
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-comment">-- | Use this around any actions that use `outputConcurrent`</span><span>
</span><span id="line-105"></span><span class="hs-comment">-- or `createProcessConcurrent`, unless </span><span>
</span><span id="line-106"></span><span class="hs-comment">-- `System.Console.Regions.displayConsoleRegions` is being used.</span><span>
</span><span id="line-107"></span><span class="hs-comment">--</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- This is necessary to ensure that buffered concurrent output actually</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- gets displayed before the program exits.</span><span>
</span><span id="line-110"></span><span id="local-6989586621679072413"><span id="local-6989586621679072414"><span class="annot"><a href="System.Console.Concurrent.Internal.html#withConcurrentOutput"><span class="hs-identifier hs-type">withConcurrentOutput</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679072413"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadMask</span></span><span> </span><span class="annot"><a href="#local-6989586621679072413"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679072413"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072414"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679072413"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072414"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-111"></span><span id="withConcurrentOutput"><span class="annot"><span class="annottext">withConcurrentOutput :: forall (m :: * -&gt; *) a. (MonadIO m, MonadMask m) =&gt; m a -&gt; m a
</span><a href="System.Console.Concurrent.Internal.html#withConcurrentOutput"><span class="hs-identifier hs-var hs-var">withConcurrentOutput</span></a></span></span><span> </span><span id="local-6989586621679072422"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679072422"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679072422"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; m () -&gt; m a
forall (m :: * -&gt; *) a b.
(HasCallStack, MonadMask m) =&gt;
m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`finally`</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="System.Console.Concurrent.Internal.html#flushConcurrentOutput"><span class="hs-identifier hs-var">flushConcurrentOutput</span></a></span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-comment">-- | Blocks until any processes started by `createProcessConcurrent` have</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- finished, and any buffered output is displayed. Also blocks while</span><span>
</span><span id="line-115"></span><span class="hs-comment">-- `lockOutput` is is use.</span><span>
</span><span id="line-116"></span><span class="hs-comment">--</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- `withConcurrentOutput` calls this at the end, so you do not normally</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- need to use this.</span><span>
</span><span id="line-119"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#flushConcurrentOutput"><span class="hs-identifier hs-type">flushConcurrentOutput</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-120"></span><span id="flushConcurrentOutput"><span class="annot"><span class="annottext">flushConcurrentOutput :: IO ()
</span><a href="System.Console.Concurrent.Internal.html#flushConcurrentOutput"><span class="hs-identifier hs-var hs-var">flushConcurrentOutput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-121"></span><span>	</span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-122"></span><span>		</span><span id="local-6989586621679072425"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679072425"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMVar Integer -&gt; STM Integer
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar Integer
</span><a href="System.Console.Concurrent.Internal.html#outputThreads"><span class="hs-identifier hs-var">outputThreads</span></a></span><span> </span><span class="annot"><span class="annottext">OutputHandle
</span><a href="System.Console.Concurrent.Internal.html#globalOutputHandle"><span class="hs-identifier hs-var">globalOutputHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span>		</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679072425"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-124"></span><span>			</span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TMVar Integer -&gt; Integer -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar Integer
</span><a href="System.Console.Concurrent.Internal.html#outputThreads"><span class="hs-identifier hs-var">outputThreads</span></a></span><span> </span><span class="annot"><span class="annottext">OutputHandle
</span><a href="System.Console.Concurrent.Internal.html#globalOutputHandle"><span class="hs-identifier hs-var">globalOutputHandle</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621679072425"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-125"></span><span>			</span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">STM ()
forall a. STM a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-126"></span><span>	</span><span class="hs-comment">-- Take output lock to wait for anything else that might be</span><span>
</span><span id="line-127"></span><span>	</span><span class="hs-comment">-- currently generating output.</span><span>
</span><span id="line-128"></span><span>	</span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (m :: * -&gt; *) a. (MonadIO m, MonadMask m) =&gt; m a -&gt; m a
</span><a href="System.Console.Concurrent.Internal.html#lockOutput"><span class="hs-identifier hs-var">lockOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span class="annot"><span class="hs-comment">-- | Values that can be output.</span></span><span>
</span><span id="line-131"></span><span class="hs-keyword">class</span><span> </span><span id="Outputable"><span class="annot"><a href="System.Console.Concurrent.Internal.html#Outputable"><span class="hs-identifier hs-var">Outputable</span></a></span></span><span> </span><span id="local-6989586621679072168"><span class="annot"><a href="#local-6989586621679072168"><span class="hs-identifier hs-type">v</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-132"></span><span>	</span><span id="toOutput"><span class="annot"><a href="System.Console.Concurrent.Internal.html#toOutput"><span class="hs-identifier hs-type">toOutput</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679072168"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-135"></span><span>	</span><span id="local-6989586621679072431"><span class="annot"><span class="annottext">toOutput :: Text -&gt; Text
</span><a href="System.Console.Concurrent.Internal.html#toOutput"><span class="hs-identifier hs-var hs-var hs-var hs-var">toOutput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span class="hs-comment">-- | Note that using a lazy Text as an Outputable value </span><span>
</span><span id="line-138"></span><span class="hs-comment">-- will buffer it all in memory.</span><span>
</span><span id="line-139"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">L.Text</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-140"></span><span>	</span><span id="local-6989586621679072436"><span class="annot"><span class="annottext">toOutput :: Text -&gt; Text
</span><a href="System.Console.Concurrent.Internal.html#toOutput"><span class="hs-identifier hs-var hs-var hs-var hs-var">toOutput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
forall v. Outputable v =&gt; v -&gt; Text
</span><a href="System.Console.Concurrent.Internal.html#toOutput"><span class="hs-identifier hs-var">toOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; (Text -&gt; Text) -&gt; Text -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
</span><span class="hs-identifier hs-var">L.toStrict</span></span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-143"></span><span>	</span><span id="local-6989586621679072441"><span class="annot"><span class="annottext">toOutput :: String -&gt; Text
</span><a href="System.Console.Concurrent.Internal.html#toOutput"><span class="hs-identifier hs-var hs-var hs-var hs-var">toOutput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
forall v. Outputable v =&gt; v -&gt; Text
</span><a href="System.Console.Concurrent.Internal.html#toOutput"><span class="hs-identifier hs-var">toOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Text) -&gt; (String -&gt; Text) -&gt; String -&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><span class="hs-identifier hs-var">T.pack</span></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-comment">-- | Displays a value to stdout.</span><span>
</span><span id="line-146"></span><span class="hs-comment">--</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- Uses locking to ensure that the whole output occurs atomically</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- even when other threads are concurrently generating output.</span><span>
</span><span id="line-149"></span><span class="hs-comment">--</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- No newline is appended to the value, so if you want a newline, be sure</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- to include it yourself.</span><span>
</span><span id="line-152"></span><span class="hs-comment">--</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- When something else is writing to the console at the same time, this does</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- not block. It buffers the value, so it will be displayed once the other</span><span>
</span><span id="line-155"></span><span class="hs-comment">-- writer is done.</span><span>
</span><span id="line-156"></span><span class="hs-comment">--</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- When outputConcurrent is used within a call to</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- `System.Console.Regions.displayConsoleRegions`, the output is displayed</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- above the currently open console regions. Only lines ending in a newline</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- are displayed in this case (it uses `waitCompleteLines`).</span><span>
</span><span id="line-161"></span><span id="local-6989586621679072171"><span class="annot"><a href="System.Console.Concurrent.Internal.html#outputConcurrent"><span class="hs-identifier hs-type">outputConcurrent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072171"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679072171"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-162"></span><span id="outputConcurrent"><span class="annot"><span class="annottext">outputConcurrent :: forall v. Outputable v =&gt; v -&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#outputConcurrent"><span class="hs-identifier hs-var hs-var">outputConcurrent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdHandle -&gt; v -&gt; IO ()
forall v. Outputable v =&gt; StdHandle -&gt; v -&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#outputConcurrent%27"><span class="hs-identifier hs-var">outputConcurrent'</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="System.Console.Concurrent.Internal.html#StdOut"><span class="hs-identifier hs-var">StdOut</span></a></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="hs-comment">-- | Like `outputConcurrent`, but displays to stderr.</span><span>
</span><span id="line-165"></span><span class="hs-comment">--</span><span>
</span><span id="line-166"></span><span class="hs-comment">-- (Does not throw an exception.)</span><span>
</span><span id="line-167"></span><span id="local-6989586621679072447"><span class="annot"><a href="System.Console.Concurrent.Internal.html#errorConcurrent"><span class="hs-identifier hs-type">errorConcurrent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072447"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679072447"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-168"></span><span id="errorConcurrent"><span class="annot"><span class="annottext">errorConcurrent :: forall v. Outputable v =&gt; v -&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#errorConcurrent"><span class="hs-identifier hs-var hs-var">errorConcurrent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdHandle -&gt; v -&gt; IO ()
forall v. Outputable v =&gt; StdHandle -&gt; v -&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#outputConcurrent%27"><span class="hs-identifier hs-var">outputConcurrent'</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="System.Console.Concurrent.Internal.html#StdErr"><span class="hs-identifier hs-var">StdErr</span></a></span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span id="local-6989586621679072173"><span class="annot"><a href="System.Console.Concurrent.Internal.html#outputConcurrent%27"><span class="hs-identifier hs-type">outputConcurrent'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072173"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdHandle"><span class="hs-identifier hs-type">StdHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679072173"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-171"></span><span id="outputConcurrent%27"><span class="annot"><span class="annottext">outputConcurrent' :: forall v. Outputable v =&gt; StdHandle -&gt; v -&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#outputConcurrent%27"><span class="hs-identifier hs-var hs-var">outputConcurrent'</span></a></span></span><span> </span><span id="local-6989586621679072456"><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072456"><span class="hs-identifier hs-var">stdh</span></a></span></span><span> </span><span id="local-6989586621679072457"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679072457"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-172"></span><span>	</span><span class="hs-comment">-- Use a worker thread. This is so any async exception that</span><span>
</span><span id="line-173"></span><span>	</span><span class="hs-comment">-- is thrown to the current thread does not affect</span><span>
</span><span id="line-174"></span><span>	</span><span class="hs-comment">-- tryTakeOutputLock, which is not async exception safe.</span><span>
</span><span id="line-175"></span><span>	</span><span id="local-6989586621679072458"><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621679072458"><span class="hs-identifier hs-var">worker</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; IO () -&gt; IO (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; (Bool -&gt; IO ()) -&gt; (Bool -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a c b.
(HasCallStack, MonadMask m) =&gt;
m a -&gt; (a -&gt; m c) -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="annot"><span class="annottext">IO Bool
</span><a href="#local-6989586621679072461"><span class="hs-identifier hs-var">setup</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO ()
</span><a href="#local-6989586621679072462"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO ()
</span><a href="#local-6989586621679072463"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-176"></span><span>	</span><span class="annot"><span class="annottext">Async () -&gt; IO ()
forall a. Async a -&gt; IO a
</span><span class="hs-identifier hs-var">wait</span></span><span> </span><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621679072458"><span class="hs-identifier hs-var">worker</span></a></span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-178"></span><span>	</span><span id="local-6989586621679072461"><span class="annot"><span class="annottext">setup :: IO Bool
</span><a href="#local-6989586621679072461"><span class="hs-identifier hs-var hs-var">setup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Bool
</span><a href="System.Console.Concurrent.Internal.html#tryTakeOutputLock"><span class="hs-identifier hs-var">tryTakeOutputLock</span></a></span><span>
</span><span id="line-179"></span><span>	</span><span id="local-6989586621679072462"><span class="annot"><span class="annottext">cleanup :: Bool -&gt; IO ()
</span><a href="#local-6989586621679072462"><span class="hs-identifier hs-var hs-var">cleanup</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>	</span><span class="annot"><a href="#local-6989586621679072462"><span class="hs-identifier hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="System.Console.Concurrent.Internal.html#dropOutputLock"><span class="hs-identifier hs-var">dropOutputLock</span></a></span><span>
</span><span id="line-181"></span><span>	</span><span id="local-6989586621679072463"><span class="annot"><span class="annottext">go :: Bool -&gt; IO ()
</span><a href="#local-6989586621679072463"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-182"></span><span>		</span><span class="annot"><span class="annottext">Handle -&gt; Text -&gt; IO ()
</span><span class="hs-identifier hs-var">T.hPutStr</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072472"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">v -&gt; Text
forall v. Outputable v =&gt; v -&gt; Text
</span><a href="System.Console.Concurrent.Internal.html#toOutput"><span class="hs-identifier hs-var">toOutput</span></a></span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679072457"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>		</span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><span class="hs-identifier hs-var">hFlush</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072472"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-184"></span><span>	</span><span class="annot"><a href="#local-6989586621679072463"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>		</span><span id="local-6989586621679072474"><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072474"><span class="hs-identifier hs-var">oldbuf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM OutputBuffer -&gt; IO OutputBuffer
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM OutputBuffer -&gt; IO OutputBuffer)
-&gt; STM OutputBuffer -&gt; IO OutputBuffer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar OutputBuffer -&gt; STM OutputBuffer
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar OutputBuffer
</span><a href="#local-6989586621679072475"><span class="hs-identifier hs-var">bv</span></a></span><span>
</span><span id="line-186"></span><span>		</span><span id="local-6989586621679072476"><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072476"><span class="hs-identifier hs-var">newbuf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutputBufferedActivity -&gt; OutputBuffer -&gt; IO OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#addOutputBuffer"><span class="hs-identifier hs-var">addOutputBuffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; OutputBufferedActivity
</span><a href="System.Console.Concurrent.Internal.html#Output"><span class="hs-identifier hs-var">Output</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">v -&gt; Text
forall v. Outputable v =&gt; v -&gt; Text
</span><a href="System.Console.Concurrent.Internal.html#toOutput"><span class="hs-identifier hs-var">toOutput</span></a></span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679072457"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072474"><span class="hs-identifier hs-var">oldbuf</span></a></span><span>
</span><span id="line-187"></span><span>		</span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar OutputBuffer -&gt; OutputBuffer -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar OutputBuffer
</span><a href="#local-6989586621679072475"><span class="hs-identifier hs-var">bv</span></a></span><span> </span><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072476"><span class="hs-identifier hs-var">newbuf</span></a></span><span>
</span><span id="line-188"></span><span>	</span><span id="local-6989586621679072472"><span class="annot"><span class="annottext">h :: Handle
</span><a href="#local-6989586621679072472"><span class="hs-identifier hs-var hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdHandle -&gt; Handle
</span><a href="System.Console.Concurrent.Internal.html#toHandle"><span class="hs-identifier hs-var">toHandle</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072456"><span class="hs-identifier hs-var">stdh</span></a></span><span>
</span><span id="line-189"></span><span>	</span><span id="local-6989586621679072475"><span class="annot"><span class="annottext">bv :: TMVar OutputBuffer
</span><a href="#local-6989586621679072475"><span class="hs-identifier hs-var hs-var">bv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdHandle -&gt; TMVar OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#bufferFor"><span class="hs-identifier hs-var">bufferFor</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072456"><span class="hs-identifier hs-var">stdh</span></a></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="annot"><span class="hs-comment">-- | This alias is provided to avoid breaking backwards compatibility.</span></span><span>
</span><span id="line-192"></span><span class="hs-keyword">type</span><span> </span><span id="ConcurrentProcessHandle"><span class="annot"><a href="System.Console.Concurrent.Internal.html#ConcurrentProcessHandle"><span class="hs-identifier hs-var">ConcurrentProcessHandle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">P.ProcessHandle</span></span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span class="hs-comment">-- | Same as `P.waitForProcess`; provided to avoid breaking backwards</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- compatibility.</span><span>
</span><span id="line-196"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#waitForProcessConcurrent"><span class="hs-identifier hs-type">waitForProcessConcurrent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#ConcurrentProcessHandle"><span class="hs-identifier hs-type">ConcurrentProcessHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ExitCode</span></span><span>
</span><span id="line-197"></span><span id="waitForProcessConcurrent"><span class="annot"><span class="annottext">waitForProcessConcurrent :: ConcurrentProcessHandle -&gt; IO ExitCode
</span><a href="System.Console.Concurrent.Internal.html#waitForProcessConcurrent"><span class="hs-identifier hs-var hs-var">waitForProcessConcurrent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ConcurrentProcessHandle -&gt; IO ExitCode
</span><span class="hs-identifier hs-var">P.waitForProcess</span></span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span class="hs-comment">-- | Wrapper around `System.Process.createProcess` that prevents </span><span>
</span><span id="line-200"></span><span class="hs-comment">-- multiple processes that are running concurrently from writing</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- to stdout/stderr at the same time.</span><span>
</span><span id="line-202"></span><span class="hs-comment">--</span><span>
</span><span id="line-203"></span><span class="hs-comment">-- If the process does not output to stdout or stderr, it's run</span><span>
</span><span id="line-204"></span><span class="hs-comment">-- by createProcess entirely as usual. Only processes that can generate</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- output are handled specially:</span><span>
</span><span id="line-206"></span><span class="hs-comment">--</span><span>
</span><span id="line-207"></span><span class="hs-comment">-- A process is allowed to write to stdout and stderr in the usual</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- way, assuming it can successfully take the output lock.</span><span>
</span><span id="line-209"></span><span class="hs-comment">--</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- When the output lock is held (ie, by another concurrent process,</span><span>
</span><span id="line-211"></span><span class="hs-comment">-- or because `outputConcurrent` is being called at the same time),</span><span>
</span><span id="line-212"></span><span class="hs-comment">-- the process is instead run with its stdout and stderr</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- redirected to a buffer. The buffered output will be displayed as soon</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- as the output lock becomes free.</span><span>
</span><span id="line-215"></span><span class="hs-comment">--</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- Note that the the process is waited for by a background thread,</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- so unlike createProcess, neglecting to call waitForProcess will not</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- result in zombie processess.</span><span>
</span><span id="line-219"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#createProcessConcurrent"><span class="hs-identifier hs-type">createProcessConcurrent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">P.CreateProcess</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">P.ProcessHandle</span></span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-220"></span><span id="createProcessConcurrent"><span class="annot"><span class="annottext">createProcessConcurrent :: CreateProcess
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="System.Console.Concurrent.Internal.html#createProcessConcurrent"><span class="hs-identifier hs-var hs-var">createProcessConcurrent</span></a></span></span><span> </span><span id="local-6989586621679072484"><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072484"><span class="hs-identifier hs-var">p</span></a></span></span><span>
</span><span id="line-221"></span><span>	</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StdStream -&gt; Bool
</span><a href="System.Console.Concurrent.Internal.html#willOutput"><span class="hs-identifier hs-var">willOutput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CreateProcess -&gt; StdStream
</span><span class="hs-identifier hs-var">P.std_out</span></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072484"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">StdStream -&gt; Bool
</span><a href="System.Console.Concurrent.Internal.html#willOutput"><span class="hs-identifier hs-var">willOutput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CreateProcess -&gt; StdStream
</span><span class="hs-identifier hs-var">P.std_err</span></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072484"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-222"></span><span>		</span><span class="annot"><span class="annottext">IO Bool
-&gt; (IO
      (Maybe Handle, Maybe Handle, Maybe Handle,
       ConcurrentProcessHandle),
    IO
      (Maybe Handle, Maybe Handle, Maybe Handle,
       ConcurrentProcessHandle))
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
forall (m :: * -&gt; *) a. Monad m =&gt; m Bool -&gt; (m a, m a) -&gt; m a
</span><a href="Utility.Monad.html#ifM"><span class="hs-identifier hs-var">ifM</span></a></span><span> </span><span class="annot"><span class="annottext">IO Bool
</span><a href="System.Console.Concurrent.Internal.html#tryTakeOutputLock"><span class="hs-identifier hs-var">tryTakeOutputLock</span></a></span><span>
</span><span id="line-223"></span><span>			</span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">CreateProcess
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="System.Console.Concurrent.Internal.html#fgProcess"><span class="hs-identifier hs-var">fgProcess</span></a></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072484"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-224"></span><span>			</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CreateProcess
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="System.Console.Concurrent.Internal.html#bgProcess"><span class="hs-identifier hs-var">bgProcess</span></a></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072484"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-225"></span><span>			</span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>	</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-227"></span><span>		</span><span id="local-6989586621679072492"><span class="annot"><span class="annottext">r :: (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="#local-6989586621679072492"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072493"><span class="annot"><span class="annottext">ConcurrentProcessHandle
</span><a href="#local-6989586621679072493"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CreateProcess
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><span class="hs-identifier hs-var">P.createProcess</span></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072484"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-228"></span><span>		</span><span class="annot"><span class="annottext">Async ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; IO () -&gt; IO (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either IOException ExitCode) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either IOException ExitCode) -&gt; IO ())
-&gt; IO (Either IOException ExitCode) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO ExitCode -&gt; IO (Either IOException ExitCode)
forall (m :: * -&gt; *) a.
MonadCatch m =&gt;
m a -&gt; m (Either IOException a)
</span><a href="Utility.Exception.html#tryIO"><span class="hs-identifier hs-var">tryIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ExitCode -&gt; IO (Either IOException ExitCode))
-&gt; IO ExitCode -&gt; IO (Either IOException ExitCode)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcurrentProcessHandle -&gt; IO ExitCode
</span><span class="hs-identifier hs-var">P.waitForProcess</span></span><span> </span><span class="annot"><span class="annottext">ConcurrentProcessHandle
</span><a href="#local-6989586621679072493"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-229"></span><span>		</span><span class="annot"><span class="annottext">(Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="#local-6989586621679072492"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span class="hs-comment">-- | Wrapper around `System.Process.createProcess` that makes sure a process</span><span>
</span><span id="line-232"></span><span class="hs-comment">-- is run in the foreground, with direct access to stdout and stderr.</span><span>
</span><span id="line-233"></span><span class="hs-comment">-- Useful when eg, running an interactive process.</span><span>
</span><span id="line-234"></span><span class="hs-comment">--</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- Note that the the process is waited for by a background thread,</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- so unlike createProcess, neglecting to call waitForProcess will not</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- result in zombie processess.</span><span>
</span><span id="line-238"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#createProcessForeground"><span class="hs-identifier hs-type">createProcessForeground</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">P.CreateProcess</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">P.ProcessHandle</span></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span id="createProcessForeground"><span class="annot"><span class="annottext">createProcessForeground :: CreateProcess
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="System.Console.Concurrent.Internal.html#createProcessForeground"><span class="hs-identifier hs-var hs-var">createProcessForeground</span></a></span></span><span> </span><span id="local-6989586621679072497"><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072497"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-240"></span><span>	</span><span class="annot"><span class="annottext">IO ()
</span><a href="System.Console.Concurrent.Internal.html#takeOutputLock"><span class="hs-identifier hs-var">takeOutputLock</span></a></span><span>
</span><span id="line-241"></span><span>	</span><span class="annot"><span class="annottext">CreateProcess
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="System.Console.Concurrent.Internal.html#fgProcess"><span class="hs-identifier hs-var">fgProcess</span></a></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072497"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-242"></span><span>
</span><span id="line-243"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#fgProcess"><span class="hs-identifier hs-type">fgProcess</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">P.CreateProcess</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">P.ProcessHandle</span></span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span id="fgProcess"><span class="annot"><span class="annottext">fgProcess :: CreateProcess
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="System.Console.Concurrent.Internal.html#fgProcess"><span class="hs-identifier hs-var hs-var">fgProcess</span></a></span></span><span> </span><span id="local-6989586621679072498"><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072498"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-245"></span><span>	</span><span id="local-6989586621679072499"><span class="annot"><span class="annottext">r :: (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="#local-6989586621679072499"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072500"><span class="annot"><span class="annottext">ConcurrentProcessHandle
</span><a href="#local-6989586621679072500"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CreateProcess
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><span class="hs-identifier hs-var">P.createProcess</span></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072498"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-246"></span><span>		</span><span class="annot"><span class="annottext">IO
  (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
-&gt; IO ()
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
forall (m :: * -&gt; *) a b.
(HasCallStack, MonadCatch m) =&gt;
m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`onException`</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="System.Console.Concurrent.Internal.html#dropOutputLock"><span class="hs-identifier hs-var">dropOutputLock</span></a></span><span>
</span><span id="line-247"></span><span>	</span><span class="annot"><span class="annottext">IO ()
</span><a href="System.Console.Concurrent.Internal.html#registerOutputThread"><span class="hs-identifier hs-var">registerOutputThread</span></a></span><span>
</span><span id="line-248"></span><span>	</span><span class="hs-comment">-- Wait for the process to exit and drop the lock.</span><span>
</span><span id="line-249"></span><span>	</span><span class="annot"><span class="annottext">Async ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; IO () -&gt; IO (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-250"></span><span>		</span><span class="annot"><span class="annottext">IO (Either IOException ExitCode) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either IOException ExitCode) -&gt; IO ())
-&gt; IO (Either IOException ExitCode) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO ExitCode -&gt; IO (Either IOException ExitCode)
forall (m :: * -&gt; *) a.
MonadCatch m =&gt;
m a -&gt; m (Either IOException a)
</span><a href="Utility.Exception.html#tryIO"><span class="hs-identifier hs-var">tryIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ExitCode -&gt; IO (Either IOException ExitCode))
-&gt; IO ExitCode -&gt; IO (Either IOException ExitCode)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcurrentProcessHandle -&gt; IO ExitCode
</span><span class="hs-identifier hs-var">P.waitForProcess</span></span><span> </span><span class="annot"><span class="annottext">ConcurrentProcessHandle
</span><a href="#local-6989586621679072500"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-251"></span><span>		</span><span class="annot"><span class="annottext">IO ()
</span><a href="System.Console.Concurrent.Internal.html#unregisterOutputThread"><span class="hs-identifier hs-var">unregisterOutputThread</span></a></span><span>
</span><span id="line-252"></span><span>		</span><span class="annot"><span class="annottext">IO ()
</span><a href="System.Console.Concurrent.Internal.html#dropOutputLock"><span class="hs-identifier hs-var">dropOutputLock</span></a></span><span>
</span><span id="line-253"></span><span>	</span><span class="annot"><span class="annottext">(Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="#local-6989586621679072499"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#bgProcess"><span class="hs-identifier hs-type">bgProcess</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">P.CreateProcess</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">P.ProcessHandle</span></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span id="bgProcess"><span class="annot"><span class="annottext">bgProcess :: CreateProcess
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="System.Console.Concurrent.Internal.html#bgProcess"><span class="hs-identifier hs-var hs-var">bgProcess</span></a></span></span><span> </span><span id="local-6989586621679072504"><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072504"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-257"></span><span>	</span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679072505"><span class="annot"><span class="annottext">p' :: CreateProcess
</span><a href="#local-6989586621679072505"><span class="hs-identifier hs-var hs-var">p'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072504"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-258"></span><span>		</span><span class="hs-special">{</span><span> </span><span class="annot"><span class="hs-identifier hs-var">P.std_out</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679072506"><span class="hs-identifier hs-type">rediroutput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-var">P.std_out</span></span><span> </span><span class="annot"><a href="#local-6989586621679072504"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>		</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-var">P.std_err</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621679072506"><span class="hs-identifier hs-type">rediroutput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-var">P.std_err</span></span><span> </span><span class="annot"><a href="#local-6989586621679072504"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>		</span><span class="hs-special">}</span><span>
</span><span id="line-261"></span><span>	</span><span class="annot"><span class="annottext">IO ()
</span><a href="System.Console.Concurrent.Internal.html#registerOutputThread"><span class="hs-identifier hs-var">registerOutputThread</span></a></span><span>
</span><span id="line-262"></span><span>	</span><span class="hs-special">(</span><span id="local-6989586621679072507"><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679072507"><span class="hs-identifier hs-var">stdin_h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072508"><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679072508"><span class="hs-identifier hs-var">stdout_h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072509"><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679072509"><span class="hs-identifier hs-var">stderr_h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072510"><span class="annot"><span class="annottext">ConcurrentProcessHandle
</span><a href="#local-6989586621679072510"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CreateProcess
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><span class="hs-identifier hs-var">P.createProcess</span></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072505"><span class="hs-identifier hs-var">p'</span></a></span><span>
</span><span id="line-263"></span><span>		</span><span class="annot"><span class="annottext">IO
  (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
-&gt; IO ()
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
forall (m :: * -&gt; *) a b.
(HasCallStack, MonadCatch m) =&gt;
m a -&gt; m b -&gt; m a
</span><span class="hs-operator hs-var">`onException`</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="System.Console.Concurrent.Internal.html#unregisterOutputThread"><span class="hs-identifier hs-var">unregisterOutputThread</span></a></span><span>
</span><span id="line-264"></span><span>	</span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679072511"><span class="annot"><span class="annottext">r :: (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="#local-6989586621679072511"><span class="hs-identifier hs-var hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-265"></span><span>		</span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679072507"><span class="hs-identifier hs-var">stdin_h</span></a></span><span>
</span><span id="line-266"></span><span>		</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StdStream -&gt; Maybe Handle -&gt; Maybe Handle
forall {a}. StdStream -&gt; Maybe a -&gt; Maybe a
</span><a href="#local-6989586621679072512"><span class="hs-identifier hs-var">mungeret</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CreateProcess -&gt; StdStream
</span><span class="hs-identifier hs-var">P.std_out</span></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072504"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679072508"><span class="hs-identifier hs-var">stdout_h</span></a></span><span>
</span><span id="line-267"></span><span>		</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StdStream -&gt; Maybe Handle -&gt; Maybe Handle
forall {a}. StdStream -&gt; Maybe a -&gt; Maybe a
</span><a href="#local-6989586621679072512"><span class="hs-identifier hs-var">mungeret</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CreateProcess -&gt; StdStream
</span><span class="hs-identifier hs-var">P.std_err</span></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072504"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679072509"><span class="hs-identifier hs-var">stderr_h</span></a></span><span>
</span><span id="line-268"></span><span>		</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ConcurrentProcessHandle
</span><a href="#local-6989586621679072510"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-269"></span><span>		</span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>	</span><span class="hs-comment">-- Wait for the process for symmetry with fgProcess,</span><span>
</span><span id="line-271"></span><span>	</span><span class="hs-comment">-- which does the same.</span><span>
</span><span id="line-272"></span><span>	</span><span class="annot"><span class="annottext">Async ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; IO () -&gt; IO (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either IOException ExitCode) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either IOException ExitCode) -&gt; IO ())
-&gt; IO (Either IOException ExitCode) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO ExitCode -&gt; IO (Either IOException ExitCode)
forall (m :: * -&gt; *) a.
MonadCatch m =&gt;
m a -&gt; m (Either IOException a)
</span><a href="Utility.Exception.html#tryIO"><span class="hs-identifier hs-var">tryIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ExitCode -&gt; IO (Either IOException ExitCode))
-&gt; IO ExitCode -&gt; IO (Either IOException ExitCode)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConcurrentProcessHandle -&gt; IO ExitCode
</span><span class="hs-identifier hs-var">P.waitForProcess</span></span><span> </span><span class="annot"><span class="annottext">ConcurrentProcessHandle
</span><a href="#local-6989586621679072510"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-273"></span><span>	</span><span id="local-6989586621679072513"><span class="annot"><span class="annottext">(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
</span><a href="#local-6989586621679072513"><span class="hs-identifier hs-var">outbuf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StdHandle
-&gt; Maybe Handle
-&gt; IO (StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
</span><a href="System.Console.Concurrent.Internal.html#setupOutputBuffer"><span class="hs-identifier hs-var">setupOutputBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="System.Console.Concurrent.Internal.html#StdOut"><span class="hs-identifier hs-var">StdOut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StdStream -&gt; Maybe Handle -&gt; Maybe Handle
forall {a}. StdStream -&gt; Maybe a -&gt; Maybe a
</span><a href="#local-6989586621679072515"><span class="hs-identifier hs-var">mungebuf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CreateProcess -&gt; StdStream
</span><span class="hs-identifier hs-var">P.std_out</span></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072504"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679072508"><span class="hs-identifier hs-var">stdout_h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>	</span><span id="local-6989586621679072516"><span class="annot"><span class="annottext">(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
</span><a href="#local-6989586621679072516"><span class="hs-identifier hs-var">errbuf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StdHandle
-&gt; Maybe Handle
-&gt; IO (StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
</span><a href="System.Console.Concurrent.Internal.html#setupOutputBuffer"><span class="hs-identifier hs-var">setupOutputBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="System.Console.Concurrent.Internal.html#StdErr"><span class="hs-identifier hs-var">StdErr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StdStream -&gt; Maybe Handle -&gt; Maybe Handle
forall {a}. StdStream -&gt; Maybe a -&gt; Maybe a
</span><a href="#local-6989586621679072515"><span class="hs-identifier hs-var">mungebuf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CreateProcess -&gt; StdStream
</span><span class="hs-identifier hs-var">P.std_err</span></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621679072504"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679072509"><span class="hs-identifier hs-var">stderr_h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>	</span><span class="annot"><span class="annottext">IO (Async ()) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO (Async ()) -&gt; IO ()) -&gt; IO (Async ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; IO () -&gt; IO (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)]
-&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#bufferWriter"><span class="hs-identifier hs-var">bufferWriter</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
</span><a href="#local-6989586621679072513"><span class="hs-identifier hs-var">outbuf</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
</span><a href="#local-6989586621679072516"><span class="hs-identifier hs-var">errbuf</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-276"></span><span>	</span><span class="annot"><span class="annottext">(Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
-&gt; IO
     (Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Handle, Maybe Handle, Maybe Handle, ConcurrentProcessHandle)
</span><a href="#local-6989586621679072511"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-278"></span><span>	</span><span id="local-6989586621679072506"><span class="annot"><span class="annottext">rediroutput :: StdStream -&gt; StdStream
</span><a href="#local-6989586621679072506"><span class="hs-identifier hs-var hs-var">rediroutput</span></a></span></span><span> </span><span id="local-6989586621679072518"><span class="annot"><span class="annottext">StdStream
</span><a href="#local-6989586621679072518"><span class="hs-identifier hs-var">ss</span></a></span></span><span>
</span><span id="line-279"></span><span>		</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StdStream -&gt; Bool
</span><a href="System.Console.Concurrent.Internal.html#willOutput"><span class="hs-identifier hs-var">willOutput</span></a></span><span> </span><span class="annot"><span class="annottext">StdStream
</span><a href="#local-6989586621679072518"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdStream
</span><span class="hs-identifier hs-var">P.CreatePipe</span></span><span>
</span><span id="line-280"></span><span>		</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdStream
</span><a href="#local-6989586621679072518"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-281"></span><span>	</span><span id="local-6989586621679072515"><span class="annot"><span class="annottext">mungebuf :: StdStream -&gt; Maybe a -&gt; Maybe a
</span><a href="#local-6989586621679072515"><span class="hs-identifier hs-var hs-var">mungebuf</span></a></span></span><span> </span><span id="local-6989586621679072520"><span class="annot"><span class="annottext">StdStream
</span><a href="#local-6989586621679072520"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621679072521"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679072521"><span class="hs-identifier hs-var">mh</span></a></span></span><span>
</span><span id="line-282"></span><span>		</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StdStream -&gt; Bool
</span><a href="System.Console.Concurrent.Internal.html#willOutput"><span class="hs-identifier hs-var">willOutput</span></a></span><span> </span><span class="annot"><span class="annottext">StdStream
</span><a href="#local-6989586621679072520"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679072521"><span class="hs-identifier hs-var">mh</span></a></span><span>
</span><span id="line-283"></span><span>		</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-284"></span><span>	</span><span id="local-6989586621679072512"><span class="annot"><span class="annottext">mungeret :: StdStream -&gt; Maybe a -&gt; Maybe a
</span><a href="#local-6989586621679072512"><span class="hs-identifier hs-var hs-var">mungeret</span></a></span></span><span> </span><span id="local-6989586621679072522"><span class="annot"><span class="annottext">StdStream
</span><a href="#local-6989586621679072522"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span id="local-6989586621679072523"><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679072523"><span class="hs-identifier hs-var">mh</span></a></span></span><span>
</span><span id="line-285"></span><span>		</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StdStream -&gt; Bool
</span><a href="System.Console.Concurrent.Internal.html#willOutput"><span class="hs-identifier hs-var">willOutput</span></a></span><span> </span><span class="annot"><span class="annottext">StdStream
</span><a href="#local-6989586621679072522"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-286"></span><span>		</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><a href="#local-6989586621679072523"><span class="hs-identifier hs-var">mh</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#willOutput"><span class="hs-identifier hs-type">willOutput</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">P.StdStream</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-289"></span><span id="willOutput"><span class="annot"><span class="annottext">willOutput :: StdStream -&gt; Bool
</span><a href="System.Console.Concurrent.Internal.html#willOutput"><span class="hs-identifier hs-var hs-var">willOutput</span></a></span></span><span> </span><span class="annot"><span class="annottext">StdStream
</span><span class="hs-identifier hs-var">P.Inherit</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-290"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#willOutput"><span class="hs-identifier hs-var">willOutput</span></a></span><span> </span><span class="annot"><span class="annottext">StdStream
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span class="annot"><span class="hs-comment">-- | Buffered output.</span></span><span>
</span><span id="line-293"></span><span class="hs-keyword">data</span><span> </span><span id="OutputBuffer"><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="OutputBuffer"><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBufferedActivity"><span class="hs-identifier hs-type">OutputBufferedActivity</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-294"></span><span>	</span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072526"><span id="local-6989586621679072531"><span class="annot"><span class="annottext">OutputBuffer -&gt; OutputBuffer -&gt; Bool
(OutputBuffer -&gt; OutputBuffer -&gt; Bool)
-&gt; (OutputBuffer -&gt; OutputBuffer -&gt; Bool) -&gt; Eq OutputBuffer
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: OutputBuffer -&gt; OutputBuffer -&gt; Bool
== :: OutputBuffer -&gt; OutputBuffer -&gt; Bool
$c/= :: OutputBuffer -&gt; OutputBuffer -&gt; Bool
/= :: OutputBuffer -&gt; OutputBuffer -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span class="hs-keyword">data</span><span> </span><span id="StdHandle"><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdHandle"><span class="hs-identifier hs-var">StdHandle</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="StdOut"><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdOut"><span class="hs-identifier hs-var">StdOut</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="StdErr"><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdErr"><span class="hs-identifier hs-var">StdErr</span></a></span></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#toHandle"><span class="hs-identifier hs-type">toHandle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdHandle"><span class="hs-identifier hs-type">StdHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span>
</span><span id="line-299"></span><span id="toHandle"><span class="annot"><span class="annottext">toHandle :: StdHandle -&gt; Handle
</span><a href="System.Console.Concurrent.Internal.html#toHandle"><span class="hs-identifier hs-var hs-var">toHandle</span></a></span></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="System.Console.Concurrent.Internal.html#StdOut"><span class="hs-identifier hs-var">StdOut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Handle
</span><span class="hs-identifier hs-var">stdout</span></span><span>
</span><span id="line-300"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#toHandle"><span class="hs-identifier hs-var">toHandle</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="System.Console.Concurrent.Internal.html#StdErr"><span class="hs-identifier hs-var">StdErr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Handle
</span><span class="hs-identifier hs-var">stderr</span></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#bufferFor"><span class="hs-identifier hs-type">bufferFor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdHandle"><span class="hs-identifier hs-type">StdHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TMVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span>
</span><span id="line-303"></span><span id="bufferFor"><span class="annot"><span class="annottext">bufferFor :: StdHandle -&gt; TMVar OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#bufferFor"><span class="hs-identifier hs-var hs-var">bufferFor</span></a></span></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="System.Console.Concurrent.Internal.html#StdOut"><span class="hs-identifier hs-var">StdOut</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#outputBuffer"><span class="hs-identifier hs-var">outputBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">OutputHandle
</span><a href="System.Console.Concurrent.Internal.html#globalOutputHandle"><span class="hs-identifier hs-var">globalOutputHandle</span></a></span><span>
</span><span id="line-304"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#bufferFor"><span class="hs-identifier hs-var">bufferFor</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="System.Console.Concurrent.Internal.html#StdErr"><span class="hs-identifier hs-var">StdErr</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#errorBuffer"><span class="hs-identifier hs-var">errorBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">OutputHandle
</span><a href="System.Console.Concurrent.Internal.html#globalOutputHandle"><span class="hs-identifier hs-var">globalOutputHandle</span></a></span><span>
</span><span id="line-305"></span><span>
</span><span id="line-306"></span><span class="hs-keyword">data</span><span> </span><span id="OutputBufferedActivity"><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBufferedActivity"><span class="hs-identifier hs-var">OutputBufferedActivity</span></a></span></span><span>
</span><span id="line-307"></span><span>	</span><span class="hs-glyph">=</span><span> </span><span id="Output"><span class="annot"><a href="System.Console.Concurrent.Internal.html#Output"><span class="hs-identifier hs-var">Output</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-308"></span><span>	</span><span class="hs-glyph">|</span><span> </span><span id="InTempFile"><span class="annot"><a href="System.Console.Concurrent.Internal.html#InTempFile"><span class="hs-identifier hs-var">InTempFile</span></a></span></span><span>
</span><span id="line-309"></span><span>		</span><span class="hs-special">{</span><span> </span><span id="tempFile"><span class="annot"><span class="annottext">OutputBufferedActivity -&gt; String
</span><a href="System.Console.Concurrent.Internal.html#tempFile"><span class="hs-identifier hs-var hs-var">tempFile</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span>
</span><span id="line-310"></span><span>		</span><span class="hs-special">,</span><span> </span><span id="endsInNewLine"><span class="annot"><span class="annottext">OutputBufferedActivity -&gt; Bool
</span><a href="System.Console.Concurrent.Internal.html#endsInNewLine"><span class="hs-identifier hs-var hs-var">endsInNewLine</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-311"></span><span>		</span><span class="hs-special">}</span><span>
</span><span id="line-312"></span><span>	</span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072543"><span id="local-6989586621679072550"><span class="annot"><span class="annottext">OutputBufferedActivity -&gt; OutputBufferedActivity -&gt; Bool
(OutputBufferedActivity -&gt; OutputBufferedActivity -&gt; Bool)
-&gt; (OutputBufferedActivity -&gt; OutputBufferedActivity -&gt; Bool)
-&gt; Eq OutputBufferedActivity
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: OutputBufferedActivity -&gt; OutputBufferedActivity -&gt; Bool
== :: OutputBufferedActivity -&gt; OutputBufferedActivity -&gt; Bool
$c/= :: OutputBufferedActivity -&gt; OutputBufferedActivity -&gt; Bool
/= :: OutputBufferedActivity -&gt; OutputBufferedActivity -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span class="hs-keyword">data</span><span> </span><span id="AtEnd"><span class="annot"><a href="System.Console.Concurrent.Internal.html#AtEnd"><span class="hs-identifier hs-var">AtEnd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AtEnd"><span class="annot"><a href="System.Console.Concurrent.Internal.html#AtEnd"><span class="hs-identifier hs-var">AtEnd</span></a></span></span><span>
</span><span id="line-315"></span><span>	</span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621679072554"><span id="local-6989586621679072556"><span class="annot"><span class="annottext">AtEnd -&gt; AtEnd -&gt; Bool
(AtEnd -&gt; AtEnd -&gt; Bool) -&gt; (AtEnd -&gt; AtEnd -&gt; Bool) -&gt; Eq AtEnd
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: AtEnd -&gt; AtEnd -&gt; Bool
== :: AtEnd -&gt; AtEnd -&gt; Bool
$c/= :: AtEnd -&gt; AtEnd -&gt; Bool
/= :: AtEnd -&gt; AtEnd -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span class="hs-keyword">data</span><span> </span><span id="BufSig"><span class="annot"><a href="System.Console.Concurrent.Internal.html#BufSig"><span class="hs-identifier hs-var">BufSig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BufSig"><span class="annot"><a href="System.Console.Concurrent.Internal.html#BufSig"><span class="hs-identifier hs-var">BufSig</span></a></span></span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#setupOutputBuffer"><span class="hs-identifier hs-type">setupOutputBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdHandle"><span class="hs-identifier hs-type">StdHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdHandle"><span class="hs-identifier hs-type">StdHandle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TMVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#BufSig"><span class="hs-identifier hs-type">BufSig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TMVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#AtEnd"><span class="hs-identifier hs-type">AtEnd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span id="setupOutputBuffer"><span class="annot"><span class="annottext">setupOutputBuffer :: StdHandle
-&gt; Maybe Handle
-&gt; IO (StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
</span><a href="System.Console.Concurrent.Internal.html#setupOutputBuffer"><span class="hs-identifier hs-var hs-var">setupOutputBuffer</span></a></span></span><span> </span><span id="local-6989586621679072560"><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072560"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679072561"><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679072561"><span class="hs-identifier hs-var">fromh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-321"></span><span>	</span><span id="local-6989586621679072562"><span class="annot"><span class="annottext">MVar OutputBuffer
</span><a href="#local-6989586621679072562"><span class="hs-identifier hs-var">buf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutputBuffer -&gt; IO (MVar OutputBuffer)
forall a. a -&gt; IO (MVar a)
</span><span class="hs-identifier hs-var">newMVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span>	</span><span id="local-6989586621679072564"><span class="annot"><span class="annottext">TMVar BufSig
</span><a href="#local-6989586621679072564"><span class="hs-identifier hs-var">bufsig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TMVar BufSig) -&gt; IO (TMVar BufSig)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">STM (TMVar BufSig)
forall a. STM (TMVar a)
</span><span class="hs-identifier hs-var">newEmptyTMVar</span></span><span>
</span><span id="line-323"></span><span>	</span><span id="local-6989586621679072566"><span class="annot"><span class="annottext">TMVar AtEnd
</span><a href="#local-6989586621679072566"><span class="hs-identifier hs-var">bufend</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TMVar AtEnd) -&gt; IO (TMVar AtEnd)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">STM (TMVar AtEnd)
forall a. STM (TMVar a)
</span><span class="hs-identifier hs-var">newEmptyTMVar</span></span><span>
</span><span id="line-324"></span><span>	</span><span class="annot"><span class="annottext">IO (Async ()) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO (Async ()) -&gt; IO ()) -&gt; IO (Async ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; IO () -&gt; IO (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
-&gt; MVar OutputBuffer -&gt; TMVar BufSig -&gt; TMVar AtEnd -&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#outputDrainer"><span class="hs-identifier hs-var">outputDrainer</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679072561"><span class="hs-identifier hs-var">fromh</span></a></span><span> </span><span class="annot"><span class="annottext">MVar OutputBuffer
</span><a href="#local-6989586621679072562"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar BufSig
</span><a href="#local-6989586621679072564"><span class="hs-identifier hs-var">bufsig</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar AtEnd
</span><a href="#local-6989586621679072566"><span class="hs-identifier hs-var">bufend</span></a></span><span>
</span><span id="line-325"></span><span>	</span><span class="annot"><span class="annottext">(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
-&gt; IO (StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072560"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MVar OutputBuffer
</span><a href="#local-6989586621679072562"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TMVar BufSig
</span><a href="#local-6989586621679072564"><span class="hs-identifier hs-var">bufsig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TMVar AtEnd
</span><a href="#local-6989586621679072566"><span class="hs-identifier hs-var">bufend</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span class="hs-comment">-- Drain output from the handle, and buffer it.</span><span>
</span><span id="line-328"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#outputDrainer"><span class="hs-identifier hs-type">outputDrainer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Handle</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TMVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#BufSig"><span class="hs-identifier hs-type">BufSig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TMVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#AtEnd"><span class="hs-identifier hs-type">AtEnd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span id="outputDrainer"><span class="annot"><span class="annottext">outputDrainer :: Maybe Handle
-&gt; MVar OutputBuffer -&gt; TMVar BufSig -&gt; TMVar AtEnd -&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#outputDrainer"><span class="hs-identifier hs-var hs-var">outputDrainer</span></a></span></span><span> </span><span id="local-6989586621679072568"><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679072568"><span class="hs-identifier hs-var">mfromh</span></a></span></span><span> </span><span id="local-6989586621679072569"><span class="annot"><span class="annottext">MVar OutputBuffer
</span><a href="#local-6989586621679072569"><span class="hs-identifier hs-var">buf</span></a></span></span><span> </span><span id="local-6989586621679072570"><span class="annot"><span class="annottext">TMVar BufSig
</span><a href="#local-6989586621679072570"><span class="hs-identifier hs-var">bufsig</span></a></span></span><span> </span><span id="local-6989586621679072571"><span class="annot"><span class="annottext">TMVar AtEnd
</span><a href="#local-6989586621679072571"><span class="hs-identifier hs-var">bufend</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Handle
</span><a href="#local-6989586621679072568"><span class="hs-identifier hs-var">mfromh</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-330"></span><span>	</span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679072572"><span class="hs-identifier hs-var">atend</span></a></span><span>
</span><span id="line-331"></span><span>	</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679072573"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072573"><span class="hs-identifier hs-var">fromh</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><a href="#local-6989586621679072574"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072573"><span class="hs-identifier hs-var">fromh</span></a></span><span>
</span><span id="line-332"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-333"></span><span>	</span><span id="local-6989586621679072574"><span class="annot"><span class="annottext">go :: Handle -&gt; IO ()
</span><a href="#local-6989586621679072574"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679072579"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072579"><span class="hs-identifier hs-var">fromh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-334"></span><span>		</span><span id="local-6989586621679072580"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072580"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Handle -&gt; IO Text
</span><span class="hs-identifier hs-var">T.hGetChunk</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072579"><span class="hs-identifier hs-var">fromh</span></a></span><span>
</span><span id="line-335"></span><span>		</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><span class="hs-identifier hs-var">T.null</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072580"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-336"></span><span>			</span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-337"></span><span>				</span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679072572"><span class="hs-identifier hs-var">atend</span></a></span><span>
</span><span id="line-338"></span><span>				</span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><span class="hs-identifier hs-var">hClose</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072579"><span class="hs-identifier hs-var">fromh</span></a></span><span>
</span><span id="line-339"></span><span>			</span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-340"></span><span>				</span><span class="annot"><span class="annottext">MVar OutputBuffer -&gt; (OutputBuffer -&gt; IO OutputBuffer) -&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><span class="hs-identifier hs-var">modifyMVar_</span></span><span> </span><span class="annot"><span class="annottext">MVar OutputBuffer
</span><a href="#local-6989586621679072569"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="annot"><span class="annottext">((OutputBuffer -&gt; IO OutputBuffer) -&gt; IO ())
-&gt; (OutputBuffer -&gt; IO OutputBuffer) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OutputBufferedActivity -&gt; OutputBuffer -&gt; IO OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#addOutputBuffer"><span class="hs-identifier hs-var">addOutputBuffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; OutputBufferedActivity
</span><a href="System.Console.Concurrent.Internal.html#Output"><span class="hs-identifier hs-var">Output</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072580"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>				</span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679072585"><span class="hs-identifier hs-var">changed</span></a></span><span>
</span><span id="line-342"></span><span>				</span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><a href="#local-6989586621679072574"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072579"><span class="hs-identifier hs-var">fromh</span></a></span><span>
</span><span id="line-343"></span><span>	</span><span id="local-6989586621679072572"><span class="annot"><span class="annottext">atend :: IO ()
</span><a href="#local-6989586621679072572"><span class="hs-identifier hs-var hs-var">atend</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar AtEnd -&gt; AtEnd -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar AtEnd
</span><a href="#local-6989586621679072571"><span class="hs-identifier hs-var">bufend</span></a></span><span> </span><span class="annot"><span class="annottext">AtEnd
</span><a href="System.Console.Concurrent.Internal.html#AtEnd"><span class="hs-identifier hs-var">AtEnd</span></a></span><span>
</span><span id="line-344"></span><span>	</span><span id="local-6989586621679072585"><span class="annot"><span class="annottext">changed :: IO ()
</span><a href="#local-6989586621679072585"><span class="hs-identifier hs-var hs-var">changed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-345"></span><span>		</span><span class="annot"><span class="annottext">STM (Maybe BufSig) -&gt; STM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(STM (Maybe BufSig) -&gt; STM ()) -&gt; STM (Maybe BufSig) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar BufSig -&gt; STM (Maybe BufSig)
forall a. TMVar a -&gt; STM (Maybe a)
</span><span class="hs-identifier hs-var">tryTakeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar BufSig
</span><a href="#local-6989586621679072570"><span class="hs-identifier hs-var">bufsig</span></a></span><span>
</span><span id="line-346"></span><span>		</span><span class="annot"><span class="annottext">TMVar BufSig -&gt; BufSig -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar BufSig
</span><a href="#local-6989586621679072570"><span class="hs-identifier hs-var">bufsig</span></a></span><span> </span><span class="annot"><span class="annottext">BufSig
</span><a href="System.Console.Concurrent.Internal.html#BufSig"><span class="hs-identifier hs-var">BufSig</span></a></span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#registerOutputThread"><span class="hs-identifier hs-type">registerOutputThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span id="registerOutputThread"><span class="annot"><span class="annottext">registerOutputThread :: IO ()
</span><a href="System.Console.Concurrent.Internal.html#registerOutputThread"><span class="hs-identifier hs-var hs-var">registerOutputThread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-350"></span><span>	</span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679072588"><span class="annot"><span class="annottext">v :: TMVar Integer
</span><a href="#local-6989586621679072588"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar Integer
</span><a href="System.Console.Concurrent.Internal.html#outputThreads"><span class="hs-identifier hs-var">outputThreads</span></a></span><span> </span><span class="annot"><span class="annottext">OutputHandle
</span><a href="System.Console.Concurrent.Internal.html#globalOutputHandle"><span class="hs-identifier hs-var">globalOutputHandle</span></a></span><span>
</span><span id="line-351"></span><span>	</span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar Integer -&gt; Integer -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar Integer
</span><a href="#local-6989586621679072588"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; STM ()) -&gt; (Integer -&gt; Integer) -&gt; Integer -&gt; STM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">succ</span></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; STM ()) -&gt; STM Integer -&gt; STM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TMVar Integer -&gt; STM Integer
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar Integer
</span><a href="#local-6989586621679072588"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-352"></span><span>	</span><span>
</span><span id="line-353"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#unregisterOutputThread"><span class="hs-identifier hs-type">unregisterOutputThread</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span id="unregisterOutputThread"><span class="annot"><span class="annottext">unregisterOutputThread :: IO ()
</span><a href="System.Console.Concurrent.Internal.html#unregisterOutputThread"><span class="hs-identifier hs-var hs-var">unregisterOutputThread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-355"></span><span>	</span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679072591"><span class="annot"><span class="annottext">v :: TMVar Integer
</span><a href="#local-6989586621679072591"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputHandle -&gt; TMVar Integer
</span><a href="System.Console.Concurrent.Internal.html#outputThreads"><span class="hs-identifier hs-var">outputThreads</span></a></span><span> </span><span class="annot"><span class="annottext">OutputHandle
</span><a href="System.Console.Concurrent.Internal.html#globalOutputHandle"><span class="hs-identifier hs-var">globalOutputHandle</span></a></span><span>
</span><span id="line-356"></span><span>	</span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar Integer -&gt; Integer -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar Integer
</span><a href="#local-6989586621679072591"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; STM ()) -&gt; (Integer -&gt; Integer) -&gt; Integer -&gt; STM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer
forall a. Enum a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">pred</span></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; STM ()) -&gt; STM Integer -&gt; STM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TMVar Integer -&gt; STM Integer
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar Integer
</span><a href="#local-6989586621679072591"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span class="hs-comment">-- Wait to lock output, and once we can, display everything </span><span>
</span><span id="line-359"></span><span class="hs-comment">-- that's put into the buffers, until the end.</span><span>
</span><span id="line-360"></span><span class="hs-comment">--</span><span>
</span><span id="line-361"></span><span class="hs-comment">-- If end is reached before lock is taken, instead add the command's</span><span>
</span><span id="line-362"></span><span class="hs-comment">-- buffers to the global outputBuffer and errorBuffer.</span><span>
</span><span id="line-363"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#bufferWriter"><span class="hs-identifier hs-type">bufferWriter</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdHandle"><span class="hs-identifier hs-type">StdHandle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TMVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#BufSig"><span class="hs-identifier hs-type">BufSig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TMVar</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#AtEnd"><span class="hs-identifier hs-type">AtEnd</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span id="bufferWriter"><span class="annot"><span class="annottext">bufferWriter :: [(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)]
-&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#bufferWriter"><span class="hs-identifier hs-var hs-var">bufferWriter</span></a></span></span><span> </span><span id="local-6989586621679072593"><span class="annot"><span class="annottext">[(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)]
</span><a href="#local-6989586621679072593"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-365"></span><span>	</span><span id="local-6989586621679072594"><span class="annot"><span class="annottext">TMVar ()
</span><a href="#local-6989586621679072594"><span class="hs-identifier hs-var">activitysig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (TMVar ()) -&gt; IO (TMVar ())
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">STM (TMVar ())
forall a. STM (TMVar a)
</span><span class="hs-identifier hs-var">newEmptyTMVar</span></span><span>
</span><span id="line-366"></span><span>	</span><span id="local-6989586621679072595"><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621679072595"><span class="hs-identifier hs-var">worker1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; IO () -&gt; IO (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (m :: * -&gt; *) a. (MonadIO m, MonadMask m) =&gt; m a -&gt; m a
</span><a href="System.Console.Concurrent.Internal.html#lockOutput"><span class="hs-identifier hs-var">lockOutput</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-367"></span><span>		</span><span class="annot"><span class="annottext">IO Bool -&gt; (IO (), IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a. Monad m =&gt; m Bool -&gt; (m a, m a) -&gt; m a
</span><a href="Utility.Monad.html#ifM"><span class="hs-identifier hs-var">ifM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM Bool -&gt; IO Bool
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Bool -&gt; IO Bool) -&gt; STM Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar () -&gt; () -&gt; STM Bool
forall a. TMVar a -&gt; a -&gt; STM Bool
</span><span class="hs-identifier hs-var">tryPutTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar ()
</span><a href="#local-6989586621679072594"><span class="hs-identifier hs-var">activitysig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-368"></span><span>			</span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">IO [()] -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO [()] -&gt; IO ()) -&gt; IO [()] -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
 -&gt; IO ())
-&gt; [(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)]
-&gt; IO [()]
forall (t :: * -&gt; *) a b.
Traversable t =&gt;
(a -&gt; IO b) -&gt; t a -&gt; IO (t b)
</span><span class="hs-identifier hs-var">mapConcurrently</span></span><span> </span><span class="annot"><span class="annottext">(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd) -&gt; IO ()
</span><a href="#local-6989586621679072598"><span class="hs-identifier hs-var">displaybuf</span></a></span><span> </span><span class="annot"><span class="annottext">[(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)]
</span><a href="#local-6989586621679072593"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-369"></span><span>			</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO ()
forall (m :: * -&gt; *). Monad m =&gt; m ()
</span><a href="Utility.Monad.html#noop"><span class="hs-identifier hs-var">noop</span></a></span><span> </span><span class="hs-comment">-- buffers already moved to global</span><span>
</span><span id="line-370"></span><span>			</span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>	</span><span id="local-6989586621679072600"><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621679072600"><span class="hs-identifier hs-var">worker2</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; IO () -&gt; IO (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TMVar () -&gt; Async () -&gt; IO ()
forall {a}. TMVar () -&gt; Async a -&gt; IO ()
</span><a href="#local-6989586621679072601"><span class="hs-identifier hs-var">globalbuf</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar ()
</span><a href="#local-6989586621679072594"><span class="hs-identifier hs-var">activitysig</span></a></span><span> </span><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621679072595"><span class="hs-identifier hs-var">worker1</span></a></span><span>
</span><span id="line-372"></span><span>	</span><span class="annot"><span class="annottext">IO (Async ()) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO (Async ()) -&gt; IO ()) -&gt; IO (Async ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><span class="hs-identifier hs-var">async</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; IO () -&gt; IO (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-373"></span><span>		</span><span class="annot"><span class="annottext">IO (Either SomeException ()) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either SomeException ()) -&gt; IO ())
-&gt; IO (Either SomeException ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Async () -&gt; IO (Either SomeException ())
forall a. Async a -&gt; IO (Either SomeException a)
</span><span class="hs-identifier hs-var">waitCatch</span></span><span> </span><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621679072595"><span class="hs-identifier hs-var">worker1</span></a></span><span>
</span><span id="line-374"></span><span>		</span><span class="annot"><span class="annottext">IO (Either SomeException ()) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either SomeException ()) -&gt; IO ())
-&gt; IO (Either SomeException ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Async () -&gt; IO (Either SomeException ())
forall a. Async a -&gt; IO (Either SomeException a)
</span><span class="hs-identifier hs-var">waitCatch</span></span><span> </span><span class="annot"><span class="annottext">Async ()
</span><a href="#local-6989586621679072600"><span class="hs-identifier hs-var">worker2</span></a></span><span>
</span><span id="line-375"></span><span>		</span><span class="annot"><span class="annottext">IO ()
</span><a href="System.Console.Concurrent.Internal.html#unregisterOutputThread"><span class="hs-identifier hs-var">unregisterOutputThread</span></a></span><span>
</span><span id="line-376"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-377"></span><span>	</span><span id="local-6989586621679072598"><span class="annot"><span class="annottext">displaybuf :: (StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd) -&gt; IO ()
</span><a href="#local-6989586621679072598"><span class="hs-identifier hs-var hs-var">displaybuf</span></a></span></span><span> </span><span id="local-6989586621679072610"><span class="annot"><span class="annottext">v :: (StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
</span><a href="#local-6989586621679072610"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679072611"><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072611"><span class="hs-identifier hs-var">outh</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072612"><span class="annot"><span class="annottext">MVar OutputBuffer
</span><a href="#local-6989586621679072612"><span class="hs-identifier hs-var">buf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072613"><span class="annot"><span class="annottext">TMVar BufSig
</span><a href="#local-6989586621679072613"><span class="hs-identifier hs-var">bufsig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072614"><span class="annot"><span class="annottext">TMVar AtEnd
</span><a href="#local-6989586621679072614"><span class="hs-identifier hs-var">bufend</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-378"></span><span>		</span><span id="local-6989586621679072615"><span class="annot"><span class="annottext">Either AtEnd BufSig
</span><a href="#local-6989586621679072615"><span class="hs-identifier hs-var">change</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM (Either AtEnd BufSig) -&gt; IO (Either AtEnd BufSig)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM (Either AtEnd BufSig) -&gt; IO (Either AtEnd BufSig))
-&gt; STM (Either AtEnd BufSig) -&gt; IO (Either AtEnd BufSig)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-379"></span><span>			</span><span class="hs-special">(</span><span class="annot"><span class="annottext">BufSig -&gt; Either AtEnd BufSig
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(BufSig -&gt; Either AtEnd BufSig)
-&gt; STM BufSig -&gt; STM (Either AtEnd BufSig)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMVar BufSig -&gt; STM BufSig
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar BufSig
</span><a href="#local-6989586621679072613"><span class="hs-identifier hs-var">bufsig</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>				</span><span class="annot"><span class="annottext">STM (Either AtEnd BufSig)
-&gt; STM (Either AtEnd BufSig) -&gt; STM (Either AtEnd BufSig)
forall a. STM a -&gt; STM a -&gt; STM a
</span><span class="hs-operator hs-var">`orElse`</span></span><span>
</span><span id="line-381"></span><span>			</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AtEnd -&gt; Either AtEnd BufSig
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(AtEnd -&gt; Either AtEnd BufSig)
-&gt; STM AtEnd -&gt; STM (Either AtEnd BufSig)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMVar AtEnd -&gt; STM AtEnd
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar AtEnd
</span><a href="#local-6989586621679072614"><span class="hs-identifier hs-var">bufend</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span>		</span><span id="local-6989586621679072617"><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072617"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar OutputBuffer -&gt; IO OutputBuffer
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">takeMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar OutputBuffer
</span><a href="#local-6989586621679072612"><span class="hs-identifier hs-var">buf</span></a></span><span>
</span><span id="line-383"></span><span>		</span><span class="annot"><span class="annottext">MVar OutputBuffer -&gt; OutputBuffer -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><span class="hs-identifier hs-var">putMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar OutputBuffer
</span><a href="#local-6989586621679072612"><span class="hs-identifier hs-var">buf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>		</span><span class="annot"><span class="annottext">StdHandle -&gt; OutputBuffer -&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#emitOutputBuffer"><span class="hs-identifier hs-var">emitOutputBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072611"><span class="hs-identifier hs-var">outh</span></a></span><span> </span><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072617"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-385"></span><span>		</span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either AtEnd BufSig
</span><a href="#local-6989586621679072615"><span class="hs-identifier hs-var">change</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-386"></span><span>			</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span class="annot"><span class="annottext">BufSig
</span><a href="System.Console.Concurrent.Internal.html#BufSig"><span class="hs-identifier hs-var">BufSig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd) -&gt; IO ()
</span><a href="#local-6989586621679072598"><span class="hs-identifier hs-var">displaybuf</span></a></span><span> </span><span class="annot"><span class="annottext">(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
</span><a href="#local-6989586621679072610"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-387"></span><span>			</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">AtEnd
</span><a href="System.Console.Concurrent.Internal.html#AtEnd"><span class="hs-identifier hs-var">AtEnd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>	</span><span id="local-6989586621679072601"><span class="annot"><span class="annottext">globalbuf :: TMVar () -&gt; Async a -&gt; IO ()
</span><a href="#local-6989586621679072601"><span class="hs-identifier hs-var hs-var">globalbuf</span></a></span></span><span> </span><span id="local-6989586621679072635"><span class="annot"><span class="annottext">TMVar ()
</span><a href="#local-6989586621679072635"><span class="hs-identifier hs-var">activitysig</span></a></span></span><span> </span><span id="local-6989586621679072636"><span class="annot"><span class="annottext">Async a
</span><a href="#local-6989586621679072636"><span class="hs-identifier hs-var">worker1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-389"></span><span>		</span><span id="local-6989586621679072637"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679072637"><span class="hs-identifier hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM Bool -&gt; IO Bool
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM Bool -&gt; IO Bool) -&gt; STM Bool -&gt; IO Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-390"></span><span>			</span><span class="hs-comment">-- signal we're going to handle it</span><span>
</span><span id="line-391"></span><span>			</span><span class="hs-comment">-- (returns false if the displaybuf already did)</span><span>
</span><span id="line-392"></span><span>			</span><span id="local-6989586621679072638"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679072638"><span class="hs-identifier hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMVar () -&gt; () -&gt; STM Bool
forall a. TMVar a -&gt; a -&gt; STM Bool
</span><span class="hs-identifier hs-var">tryPutTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar ()
</span><a href="#local-6989586621679072635"><span class="hs-identifier hs-var">activitysig</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>			</span><span class="hs-comment">-- wait for end of all buffers</span><span>
</span><span id="line-394"></span><span>			</span><span class="annot"><span class="annottext">Bool -&gt; STM () -&gt; STM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679072638"><span class="hs-identifier hs-var">ok</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; STM ()) -&gt; STM () -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-395"></span><span>				</span><span class="annot"><span class="annottext">((StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
 -&gt; STM AtEnd)
-&gt; [(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)]
-&gt; STM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679072640"><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072640"><span class="hs-identifier hs-var">_outh</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072641"><span class="annot"><span class="annottext">MVar OutputBuffer
</span><a href="#local-6989586621679072641"><span class="hs-identifier hs-var">_buf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072642"><span class="annot"><span class="annottext">TMVar BufSig
</span><a href="#local-6989586621679072642"><span class="hs-identifier hs-var">_bufsig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072643"><span class="annot"><span class="annottext">TMVar AtEnd
</span><a href="#local-6989586621679072643"><span class="hs-identifier hs-var">bufend</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TMVar AtEnd -&gt; STM AtEnd
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar AtEnd
</span><a href="#local-6989586621679072643"><span class="hs-identifier hs-var">bufend</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)]
</span><a href="#local-6989586621679072593"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-396"></span><span>			</span><span class="annot"><span class="annottext">Bool -&gt; STM Bool
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679072638"><span class="hs-identifier hs-var">ok</span></a></span><span>
</span><span id="line-397"></span><span>		</span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679072637"><span class="hs-identifier hs-var">ok</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-398"></span><span>			</span><span class="hs-comment">-- add all of the command's buffered output to the</span><span>
</span><span id="line-399"></span><span>			</span><span class="hs-comment">-- global output buffer, atomically</span><span>
</span><span id="line-400"></span><span>			</span><span id="local-6989586621679072644"><span class="annot"><span class="annottext">[(StdHandle, OutputBuffer)]
</span><a href="#local-6989586621679072644"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)]
-&gt; ((StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
    -&gt; IO (StdHandle, OutputBuffer))
-&gt; IO [(StdHandle, OutputBuffer)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)]
</span><a href="#local-6989586621679072593"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">(((StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
  -&gt; IO (StdHandle, OutputBuffer))
 -&gt; IO [(StdHandle, OutputBuffer)])
-&gt; ((StdHandle, MVar OutputBuffer, TMVar BufSig, TMVar AtEnd)
    -&gt; IO (StdHandle, OutputBuffer))
-&gt; IO [(StdHandle, OutputBuffer)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679072646"><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072646"><span class="hs-identifier hs-var">outh</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072647"><span class="annot"><span class="annottext">MVar OutputBuffer
</span><a href="#local-6989586621679072647"><span class="hs-identifier hs-var">buf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072648"><span class="annot"><span class="annottext">TMVar BufSig
</span><a href="#local-6989586621679072648"><span class="hs-identifier hs-var">_bufsig</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072649"><span class="annot"><span class="annottext">TMVar AtEnd
</span><a href="#local-6989586621679072649"><span class="hs-identifier hs-var">_bufend</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-401"></span><span>				</span><span class="hs-special">(</span><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072646"><span class="hs-identifier hs-var">outh</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(OutputBuffer -&gt; (StdHandle, OutputBuffer))
-&gt; IO OutputBuffer -&gt; IO (StdHandle, OutputBuffer)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">MVar OutputBuffer -&gt; IO OutputBuffer
forall a. MVar a -&gt; IO a
</span><span class="hs-identifier hs-var">takeMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar OutputBuffer
</span><a href="#local-6989586621679072647"><span class="hs-identifier hs-var">buf</span></a></span><span>
</span><span id="line-402"></span><span>			</span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-403"></span><span>				</span><span class="annot"><span class="annottext">[(StdHandle, OutputBuffer)]
-&gt; ((StdHandle, OutputBuffer) -&gt; STM ()) -&gt; STM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(StdHandle, OutputBuffer)]
</span><a href="#local-6989586621679072644"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">(((StdHandle, OutputBuffer) -&gt; STM ()) -&gt; STM ())
-&gt; ((StdHandle, OutputBuffer) -&gt; STM ()) -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679072651"><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072651"><span class="hs-identifier hs-var">outh</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072652"><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072652"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span>
</span><span id="line-404"></span><span>					</span><span class="annot"><span class="annottext">StdHandle -&gt; OutputBuffer -&gt; STM ()
</span><a href="System.Console.Concurrent.Internal.html#bufferOutputSTM%27"><span class="hs-identifier hs-var">bufferOutputSTM'</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072651"><span class="hs-identifier hs-var">outh</span></a></span><span> </span><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072652"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-405"></span><span>			</span><span class="hs-comment">-- worker1 might be blocked waiting for the output</span><span>
</span><span id="line-406"></span><span>			</span><span class="hs-comment">-- lock, and we've already done its job, so cancel it</span><span>
</span><span id="line-407"></span><span>			</span><span class="annot"><span class="annottext">Async a -&gt; IO ()
forall a. Async a -&gt; IO ()
</span><span class="hs-identifier hs-var">cancel</span></span><span> </span><span class="annot"><span class="annottext">Async a
</span><a href="#local-6989586621679072636"><span class="hs-identifier hs-var">worker1</span></a></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span class="hs-comment">-- Adds a value to the OutputBuffer. When adding Output to a Handle,</span><span>
</span><span id="line-410"></span><span class="hs-comment">-- it's cheaper to combine it with any already buffered Output to that</span><span>
</span><span id="line-411"></span><span class="hs-comment">-- same Handle.</span><span>
</span><span id="line-412"></span><span class="hs-comment">--</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- When the total buffered Output exceeds 1 mb in size, it's moved out of</span><span>
</span><span id="line-414"></span><span class="hs-comment">-- memory, to a temp file. This should only happen rarely, but is done to</span><span>
</span><span id="line-415"></span><span class="hs-comment">-- avoid some verbose process unexpectedly causing excessive memory use.</span><span>
</span><span id="line-416"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#addOutputBuffer"><span class="hs-identifier hs-type">addOutputBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBufferedActivity"><span class="hs-identifier hs-type">OutputBufferedActivity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span>
</span><span id="line-417"></span><span id="addOutputBuffer"><span class="annot"><span class="annottext">addOutputBuffer :: OutputBufferedActivity -&gt; OutputBuffer -&gt; IO OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#addOutputBuffer"><span class="hs-identifier hs-var hs-var">addOutputBuffer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Output"><span class="hs-identifier hs-type">Output</span></a></span><span> </span><span id="local-6989586621679072655"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072655"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span id="local-6989586621679072656"><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072656"><span class="hs-identifier hs-var">buf</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>	</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Int
</span><span class="hs-identifier hs-var">T.length</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072658"><span class="hs-identifier hs-var">t'</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1048576</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputBuffer -&gt; IO OutputBuffer
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(OutputBuffer -&gt; IO OutputBuffer)
-&gt; OutputBuffer -&gt; IO OutputBuffer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; OutputBufferedActivity
</span><a href="System.Console.Concurrent.Internal.html#Output"><span class="hs-identifier hs-var">Output</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072658"><span class="hs-identifier hs-var">t'</span></a></span><span> </span><span class="annot"><span class="annottext">OutputBufferedActivity
-&gt; [OutputBufferedActivity] -&gt; [OutputBufferedActivity]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072659"><span class="hs-identifier hs-var">other</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>	</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-420"></span><span>		</span><span id="local-6989586621679072660"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679072660"><span class="hs-identifier hs-var">tmpdir</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO String
</span><span class="hs-identifier hs-var">getTemporaryDirectory</span></span><span>
</span><span id="line-421"></span><span>		</span><span class="hs-special">(</span><span id="local-6989586621679072662"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679072662"><span class="hs-identifier hs-var">tmp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072663"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072663"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; IO (String, Handle)
</span><span class="hs-identifier hs-var">openTempFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679072660"><span class="hs-identifier hs-var">tmpdir</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;output.tmp&quot;</span></span><span>
</span><span id="line-422"></span><span>		</span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679072665"><span class="annot"><span class="annottext">endnl :: Bool
</span><a href="#local-6989586621679072665"><span class="hs-identifier hs-var hs-var">endnl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><a href="System.Console.Concurrent.Internal.html#endsNewLine"><span class="hs-identifier hs-var">endsNewLine</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072658"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-423"></span><span>		</span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679072667"><span class="annot"><span class="annottext">i :: OutputBufferedActivity
</span><a href="#local-6989586621679072667"><span class="hs-identifier hs-var hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#InTempFile"><span class="hs-identifier hs-type">InTempFile</span></a></span><span>
</span><span id="line-424"></span><span>			</span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">tempFile :: String
</span><a href="System.Console.Concurrent.Internal.html#tempFile"><span class="hs-identifier hs-var">tempFile</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679072662"><span class="hs-identifier hs-var">tmp</span></a></span><span>
</span><span id="line-425"></span><span>			</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">endsInNewLine :: Bool
</span><a href="System.Console.Concurrent.Internal.html#endsInNewLine"><span class="hs-identifier hs-var">endsInNewLine</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679072665"><span class="hs-identifier hs-var">endnl</span></a></span><span>
</span><span id="line-426"></span><span>			</span><span class="hs-special">}</span><span>
</span><span id="line-427"></span><span>		</span><span class="annot"><span class="annottext">Handle -&gt; Text -&gt; IO ()
</span><span class="hs-identifier hs-var">T.hPutStr</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072663"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072658"><span class="hs-identifier hs-var">t'</span></a></span><span>
</span><span id="line-428"></span><span>		</span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><span class="hs-identifier hs-var">hClose</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072663"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-429"></span><span>		</span><span class="annot"><span class="annottext">OutputBuffer -&gt; IO OutputBuffer
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(OutputBuffer -&gt; IO OutputBuffer)
-&gt; OutputBuffer -&gt; IO OutputBuffer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutputBufferedActivity
</span><a href="#local-6989586621679072667"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">OutputBufferedActivity
-&gt; [OutputBufferedActivity] -&gt; [OutputBufferedActivity]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072659"><span class="hs-identifier hs-var">other</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-431"></span><span>	</span><span class="hs-glyph">!</span><span id="local-6989586621679072658"><span class="annot"><span class="annottext">t' :: Text
</span><a href="#local-6989586621679072658"><span class="hs-identifier hs-var hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Text] -&gt; Text
</span><span class="hs-identifier hs-var">T.concat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(OutputBufferedActivity -&gt; Maybe Text)
-&gt; [OutputBufferedActivity] -&gt; [Text]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">OutputBufferedActivity -&gt; Maybe Text
</span><a href="#local-6989586621679072672"><span class="hs-identifier hs-var">getOutput</span></a></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072673"><span class="hs-identifier hs-var">this</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072655"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-432"></span><span>	</span><span class="hs-glyph">!</span><span class="hs-special">(</span><span id="local-6989586621679072673"><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072673"><span class="hs-identifier hs-var">this</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072659"><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072659"><span class="hs-identifier hs-var">other</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutputBufferedActivity -&gt; Bool)
-&gt; [OutputBufferedActivity]
-&gt; ([OutputBufferedActivity], [OutputBufferedActivity])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">partition</span></span><span> </span><span class="annot"><span class="annottext">OutputBufferedActivity -&gt; Bool
</span><a href="#local-6989586621679072675"><span class="hs-identifier hs-var">isOutput</span></a></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072656"><span class="hs-identifier hs-var">buf</span></a></span><span>
</span><span id="line-433"></span><span>	</span><span id="local-6989586621679072675"><span class="annot"><span class="annottext">isOutput :: OutputBufferedActivity -&gt; Bool
</span><a href="#local-6989586621679072675"><span class="hs-identifier hs-var hs-var">isOutput</span></a></span></span><span> </span><span id="local-6989586621679072676"><span class="annot"><span class="annottext">OutputBufferedActivity
</span><a href="#local-6989586621679072676"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OutputBufferedActivity
</span><a href="#local-6989586621679072676"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-434"></span><span>		</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Output"><span class="hs-identifier hs-type">Output</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-435"></span><span>		</span><span class="annot"><span class="annottext">OutputBufferedActivity
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-436"></span><span>	</span><span id="local-6989586621679072672"><span class="annot"><span class="annottext">getOutput :: OutputBufferedActivity -&gt; Maybe Text
</span><a href="#local-6989586621679072672"><span class="hs-identifier hs-var hs-var">getOutput</span></a></span></span><span> </span><span id="local-6989586621679072677"><span class="annot"><span class="annottext">OutputBufferedActivity
</span><a href="#local-6989586621679072677"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OutputBufferedActivity
</span><a href="#local-6989586621679072677"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-437"></span><span>		</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Output"><span class="hs-identifier hs-type">Output</span></a></span><span> </span><span id="local-6989586621679072678"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072678"><span class="hs-identifier hs-var">t''</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Maybe Text
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072678"><span class="hs-identifier hs-var">t''</span></a></span><span>
</span><span id="line-438"></span><span>		</span><span class="annot"><span class="annottext">OutputBufferedActivity
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Text
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-439"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#addOutputBuffer"><span class="hs-identifier hs-var">addOutputBuffer</span></a></span><span> </span><span id="local-6989586621679072679"><span class="annot"><span class="annottext">OutputBufferedActivity
</span><a href="#local-6989586621679072679"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span id="local-6989586621679072680"><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072680"><span class="hs-identifier hs-var">buf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputBuffer -&gt; IO OutputBuffer
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(OutputBuffer -&gt; IO OutputBuffer)
-&gt; OutputBuffer -&gt; IO OutputBuffer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutputBufferedActivity
</span><a href="#local-6989586621679072679"><span class="hs-identifier hs-var">v</span></a></span><span class="annot"><span class="annottext">OutputBufferedActivity
-&gt; [OutputBufferedActivity] -&gt; [OutputBufferedActivity]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072680"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-440"></span><span>
</span><span id="line-441"></span><span class="hs-comment">-- | Adds a value to the output buffer for later display.</span><span>
</span><span id="line-442"></span><span class="hs-comment">--</span><span>
</span><span id="line-443"></span><span class="hs-comment">-- Note that buffering large quantities of data this way will keep it</span><span>
</span><span id="line-444"></span><span class="hs-comment">-- resident in memory until it can be displayed. While `outputConcurrent`</span><span>
</span><span id="line-445"></span><span class="hs-comment">-- uses temp files if the buffer gets too big, this STM function cannot do</span><span>
</span><span id="line-446"></span><span class="hs-comment">-- so.</span><span>
</span><span id="line-447"></span><span id="local-6989586621679072240"><span class="annot"><a href="System.Console.Concurrent.Internal.html#bufferOutputSTM"><span class="hs-identifier hs-type">bufferOutputSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Outputable"><span class="hs-identifier hs-type">Outputable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679072240"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdHandle"><span class="hs-identifier hs-type">StdHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679072240"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-448"></span><span id="bufferOutputSTM"><span class="annot"><span class="annottext">bufferOutputSTM :: forall v. Outputable v =&gt; StdHandle -&gt; v -&gt; STM ()
</span><a href="System.Console.Concurrent.Internal.html#bufferOutputSTM"><span class="hs-identifier hs-var hs-var">bufferOutputSTM</span></a></span></span><span> </span><span id="local-6989586621679072684"><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072684"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span id="local-6989586621679072685"><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679072685"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdHandle -&gt; OutputBuffer -&gt; STM ()
</span><a href="System.Console.Concurrent.Internal.html#bufferOutputSTM%27"><span class="hs-identifier hs-var">bufferOutputSTM'</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072684"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Text -&gt; OutputBufferedActivity
</span><a href="System.Console.Concurrent.Internal.html#Output"><span class="hs-identifier hs-var">Output</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">v -&gt; Text
forall v. Outputable v =&gt; v -&gt; Text
</span><a href="System.Console.Concurrent.Internal.html#toOutput"><span class="hs-identifier hs-var">toOutput</span></a></span><span> </span><span class="annot"><span class="annottext">v
</span><a href="#local-6989586621679072685"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>
</span><span id="line-450"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#bufferOutputSTM%27"><span class="hs-identifier hs-type">bufferOutputSTM'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdHandle"><span class="hs-identifier hs-type">StdHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span id="bufferOutputSTM%27"><span class="annot"><span class="annottext">bufferOutputSTM' :: StdHandle -&gt; OutputBuffer -&gt; STM ()
</span><a href="System.Console.Concurrent.Internal.html#bufferOutputSTM%27"><span class="hs-identifier hs-var hs-var">bufferOutputSTM'</span></a></span></span><span> </span><span id="local-6989586621679072686"><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072686"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span id="local-6989586621679072687"><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072687"><span class="hs-identifier hs-var">newbuf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-452"></span><span>	</span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span id="local-6989586621679072688"><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072688"><span class="hs-identifier hs-var">buf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMVar OutputBuffer -&gt; STM OutputBuffer
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar OutputBuffer
</span><a href="#local-6989586621679072689"><span class="hs-identifier hs-var">bv</span></a></span><span>
</span><span id="line-453"></span><span>	</span><span class="annot"><span class="annottext">TMVar OutputBuffer -&gt; OutputBuffer -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar OutputBuffer
</span><a href="#local-6989586621679072689"><span class="hs-identifier hs-var">bv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072687"><span class="hs-identifier hs-var">newbuf</span></a></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity]
-&gt; [OutputBufferedActivity] -&gt; [OutputBufferedActivity]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072688"><span class="hs-identifier hs-var">buf</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-454"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-455"></span><span>	</span><span id="local-6989586621679072689"><span class="annot"><span class="annottext">bv :: TMVar OutputBuffer
</span><a href="#local-6989586621679072689"><span class="hs-identifier hs-var hs-var">bv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdHandle -&gt; TMVar OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#bufferFor"><span class="hs-identifier hs-var">bufferFor</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072686"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-456"></span><span>
</span><span id="line-457"></span><span class="hs-comment">-- | A STM action that waits for some buffered output to become</span><span>
</span><span id="line-458"></span><span class="hs-comment">-- available, and returns it.</span><span>
</span><span id="line-459"></span><span class="hs-comment">--</span><span>
</span><span id="line-460"></span><span class="hs-comment">-- The function can select a subset of output when only some is desired;</span><span>
</span><span id="line-461"></span><span class="hs-comment">-- the fst part is returned and the snd is left in the buffer.</span><span>
</span><span id="line-462"></span><span class="hs-comment">--</span><span>
</span><span id="line-463"></span><span class="hs-comment">-- This will prevent it from being displayed in the usual way, so you'll</span><span>
</span><span id="line-464"></span><span class="hs-comment">-- need to use `emitOutputBuffer` to display it yourself.</span><span>
</span><span id="line-465"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#outputBufferWaiterSTM"><span class="hs-identifier hs-type">outputBufferWaiterSTM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdHandle"><span class="hs-identifier hs-type">StdHandle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-466"></span><span id="outputBufferWaiterSTM"><span class="annot"><span class="annottext">outputBufferWaiterSTM :: (OutputBuffer -&gt; (OutputBuffer, OutputBuffer))
-&gt; STM (StdHandle, OutputBuffer)
</span><a href="System.Console.Concurrent.Internal.html#outputBufferWaiterSTM"><span class="hs-identifier hs-var hs-var">outputBufferWaiterSTM</span></a></span></span><span> </span><span id="local-6989586621679072691"><span class="annot"><span class="annottext">OutputBuffer -&gt; (OutputBuffer, OutputBuffer)
</span><a href="#local-6989586621679072691"><span class="hs-identifier hs-var">selector</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdHandle -&gt; STM (StdHandle, OutputBuffer)
</span><a href="#local-6989586621679072692"><span class="hs-identifier hs-var">waitgetbuf</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="System.Console.Concurrent.Internal.html#StdOut"><span class="hs-identifier hs-var">StdOut</span></a></span><span> </span><span class="annot"><span class="annottext">STM (StdHandle, OutputBuffer)
-&gt; STM (StdHandle, OutputBuffer) -&gt; STM (StdHandle, OutputBuffer)
forall a. STM a -&gt; STM a -&gt; STM a
</span><span class="hs-operator hs-var">`orElse`</span></span><span> </span><span class="annot"><span class="annottext">StdHandle -&gt; STM (StdHandle, OutputBuffer)
</span><a href="#local-6989586621679072692"><span class="hs-identifier hs-var">waitgetbuf</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="System.Console.Concurrent.Internal.html#StdErr"><span class="hs-identifier hs-var">StdErr</span></a></span><span>
</span><span id="line-467"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-468"></span><span>	</span><span id="local-6989586621679072692"><span class="annot"><span class="annottext">waitgetbuf :: StdHandle -&gt; STM (StdHandle, OutputBuffer)
</span><a href="#local-6989586621679072692"><span class="hs-identifier hs-var hs-var">waitgetbuf</span></a></span></span><span> </span><span id="local-6989586621679072700"><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072700"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-469"></span><span>		</span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679072701"><span class="annot"><span class="annottext">bv :: TMVar OutputBuffer
</span><a href="#local-6989586621679072701"><span class="hs-identifier hs-var hs-var">bv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdHandle -&gt; TMVar OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#bufferFor"><span class="hs-identifier hs-var">bufferFor</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072700"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-470"></span><span>		</span><span class="hs-special">(</span><span id="local-6989586621679072702"><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072702"><span class="hs-identifier hs-var">selected</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072703"><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072703"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OutputBuffer -&gt; (OutputBuffer, OutputBuffer)
</span><a href="#local-6989586621679072691"><span class="hs-identifier hs-var">selector</span></a></span><span> </span><span class="annot"><span class="annottext">(OutputBuffer -&gt; (OutputBuffer, OutputBuffer))
-&gt; STM OutputBuffer -&gt; STM (OutputBuffer, OutputBuffer)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TMVar OutputBuffer -&gt; STM OutputBuffer
forall a. TMVar a -&gt; STM a
</span><span class="hs-identifier hs-var">takeTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar OutputBuffer
</span><a href="#local-6989586621679072701"><span class="hs-identifier hs-var">bv</span></a></span><span>
</span><span id="line-471"></span><span>		</span><span class="annot"><span class="annottext">Bool -&gt; STM () -&gt; STM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072702"><span class="hs-identifier hs-var">selected</span></a></span><span> </span><span class="annot"><span class="annottext">OutputBuffer -&gt; OutputBuffer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-472"></span><span>			</span><span class="annot"><span class="annottext">STM ()
forall a. STM a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-473"></span><span>		</span><span class="annot"><span class="annottext">TMVar OutputBuffer -&gt; OutputBuffer -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">putTMVar</span></span><span> </span><span class="annot"><span class="annottext">TMVar OutputBuffer
</span><a href="#local-6989586621679072701"><span class="hs-identifier hs-var">bv</span></a></span><span> </span><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072703"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-474"></span><span>		</span><span class="annot"><span class="annottext">(StdHandle, OutputBuffer) -&gt; STM (StdHandle, OutputBuffer)
forall a. a -&gt; STM a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072700"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072702"><span class="hs-identifier hs-var">selected</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-475"></span><span>
</span><span id="line-476"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#waitAnyBuffer"><span class="hs-identifier hs-type">waitAnyBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span id="waitAnyBuffer"><span class="annot"><span class="annottext">waitAnyBuffer :: OutputBuffer -&gt; (OutputBuffer, OutputBuffer)
</span><a href="System.Console.Concurrent.Internal.html#waitAnyBuffer"><span class="hs-identifier hs-var hs-var">waitAnyBuffer</span></a></span></span><span> </span><span id="local-6989586621679072705"><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072705"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OutputBuffer
</span><a href="#local-6989586621679072705"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span class="hs-comment">-- | Use with `outputBufferWaiterSTM` to make it only return buffered</span><span>
</span><span id="line-480"></span><span class="hs-comment">-- output that ends with a newline. Anything buffered without a newline</span><span>
</span><span id="line-481"></span><span class="hs-comment">-- is left in the buffer.</span><span>
</span><span id="line-482"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#waitCompleteLines"><span class="hs-identifier hs-type">waitCompleteLines</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span id="waitCompleteLines"><span class="annot"><span class="annottext">waitCompleteLines :: OutputBuffer -&gt; (OutputBuffer, OutputBuffer)
</span><a href="System.Console.Concurrent.Internal.html#waitCompleteLines"><span class="hs-identifier hs-var hs-var">waitCompleteLines</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span id="local-6989586621679072706"><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072706"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-484"></span><span>	</span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072707"><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072707"><span class="hs-identifier hs-var">selected</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679072708"><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072708"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(OutputBufferedActivity -&gt; Bool)
-&gt; [OutputBufferedActivity]
-&gt; ([OutputBufferedActivity], [OutputBufferedActivity])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">span</span></span><span> </span><span class="annot"><span class="annottext">OutputBufferedActivity -&gt; Bool
</span><a href="#local-6989586621679072710"><span class="hs-identifier hs-var">completeline</span></a></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072706"><span class="hs-identifier hs-var">l</span></a></span><span>
</span><span id="line-485"></span><span>	</span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072707"><span class="hs-identifier hs-var">selected</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; OutputBuffer
</span><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-var">OutputBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072708"><span class="hs-identifier hs-var">rest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-487"></span><span>	</span><span id="local-6989586621679072710"><span class="annot"><span class="annottext">completeline :: OutputBufferedActivity -&gt; Bool
</span><a href="#local-6989586621679072710"><span class="hs-identifier hs-var hs-var">completeline</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679072711"><span class="annot"><span class="annottext">v :: OutputBufferedActivity
</span><a href="#local-6989586621679072711"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#InTempFile"><span class="hs-identifier hs-type">InTempFile</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OutputBufferedActivity -&gt; Bool
</span><a href="System.Console.Concurrent.Internal.html#endsInNewLine"><span class="hs-identifier hs-var">endsInNewLine</span></a></span><span> </span><span class="annot"><span class="annottext">OutputBufferedActivity
</span><a href="#local-6989586621679072711"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-488"></span><span>	</span><span class="annot"><a href="#local-6989586621679072710"><span class="hs-identifier hs-var">completeline</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Output"><span class="hs-identifier hs-type">Output</span></a></span><span> </span><span id="local-6989586621679072712"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072712"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><a href="System.Console.Concurrent.Internal.html#endsNewLine"><span class="hs-identifier hs-var">endsNewLine</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072712"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-489"></span><span>
</span><span id="line-490"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#endsNewLine"><span class="hs-identifier hs-type">endsNewLine</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-491"></span><span id="endsNewLine"><span class="annot"><span class="annottext">endsNewLine :: Text -&gt; Bool
</span><a href="System.Console.Concurrent.Internal.html#endsNewLine"><span class="hs-identifier hs-var hs-var">endsNewLine</span></a></span></span><span> </span><span id="local-6989586621679072713"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072713"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Bool
</span><span class="hs-identifier hs-var">T.null</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072713"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">HasCallStack =&gt; Text -&gt; Char
Text -&gt; Char
</span><span class="hs-identifier hs-var">T.last</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072713"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'\n'</span></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span class="hs-comment">-- | Emits the content of the OutputBuffer to the Handle</span><span>
</span><span id="line-494"></span><span class="hs-comment">--</span><span>
</span><span id="line-495"></span><span class="hs-comment">-- If you use this, you should use `lockOutput` to ensure you're the only</span><span>
</span><span id="line-496"></span><span class="hs-comment">-- thread writing to the console.</span><span>
</span><span id="line-497"></span><span class="annot"><a href="System.Console.Concurrent.Internal.html#emitOutputBuffer"><span class="hs-identifier hs-type">emitOutputBuffer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#StdHandle"><span class="hs-identifier hs-type">StdHandle</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span id="emitOutputBuffer"><span class="annot"><span class="annottext">emitOutputBuffer :: StdHandle -&gt; OutputBuffer -&gt; IO ()
</span><a href="System.Console.Concurrent.Internal.html#emitOutputBuffer"><span class="hs-identifier hs-var hs-var">emitOutputBuffer</span></a></span></span><span> </span><span id="local-6989586621679072717"><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072717"><span class="hs-identifier hs-var">stdh</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#OutputBuffer"><span class="hs-identifier hs-type">OutputBuffer</span></a></span><span> </span><span id="local-6989586621679072718"><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072718"><span class="hs-identifier hs-var">l</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-499"></span><span>	</span><span class="annot"><span class="annottext">[OutputBufferedActivity]
-&gt; (OutputBufferedActivity -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OutputBufferedActivity] -&gt; [OutputBufferedActivity]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[OutputBufferedActivity]
</span><a href="#local-6989586621679072718"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((OutputBufferedActivity -&gt; IO ()) -&gt; IO ())
-&gt; (OutputBufferedActivity -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679072720"><span class="annot"><span class="annottext">OutputBufferedActivity
</span><a href="#local-6989586621679072720"><span class="hs-identifier hs-var">ba</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OutputBufferedActivity
</span><a href="#local-6989586621679072720"><span class="hs-identifier hs-var">ba</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-500"></span><span>		</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#Output"><span class="hs-identifier hs-type">Output</span></a></span><span> </span><span id="local-6989586621679072721"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072721"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; IO ()
</span><a href="#local-6989586621679072722"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072721"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-501"></span><span>		</span><span class="annot"><a href="System.Console.Concurrent.Internal.html#InTempFile"><span class="hs-identifier hs-type">InTempFile</span></a></span><span> </span><span id="local-6989586621679072723"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679072723"><span class="hs-identifier hs-var">tmp</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-502"></span><span>			</span><span class="annot"><span class="annottext">Text -&gt; IO ()
</span><a href="#local-6989586621679072722"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; IO ()) -&gt; IO Text -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO Text
</span><span class="hs-identifier hs-var">T.readFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679072723"><span class="hs-identifier hs-var">tmp</span></a></span><span>
</span><span id="line-503"></span><span>			</span><span class="annot"><span class="annottext">IO (Maybe ()) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe ()) -&gt; IO ()) -&gt; IO (Maybe ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Maybe ())
forall (m :: * -&gt; *) a. MonadCatch m =&gt; m a -&gt; m (Maybe a)
</span><a href="Utility.Exception.html#tryWhenExists"><span class="hs-identifier hs-var">tryWhenExists</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Maybe ())) -&gt; IO () -&gt; IO (Maybe ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">removeFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679072723"><span class="hs-identifier hs-var">tmp</span></a></span><span>
</span><span id="line-504"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-505"></span><span>	</span><span id="local-6989586621679072727"><span class="annot"><span class="annottext">outh :: Handle
</span><a href="#local-6989586621679072727"><span class="hs-identifier hs-var hs-var">outh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StdHandle -&gt; Handle
</span><a href="System.Console.Concurrent.Internal.html#toHandle"><span class="hs-identifier hs-var">toHandle</span></a></span><span> </span><span class="annot"><span class="annottext">StdHandle
</span><a href="#local-6989586621679072717"><span class="hs-identifier hs-var">stdh</span></a></span><span>
</span><span id="line-506"></span><span>	</span><span id="local-6989586621679072722"><span class="annot"><span class="annottext">emit :: Text -&gt; IO ()
</span><a href="#local-6989586621679072722"><span class="hs-identifier hs-var hs-var">emit</span></a></span></span><span> </span><span id="local-6989586621679072731"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072731"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Either IOException ()) -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either IOException ()) -&gt; IO ())
-&gt; IO (Either IOException ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Either IOException ())
forall (m :: * -&gt; *) a.
MonadCatch m =&gt;
m a -&gt; m (Either IOException a)
</span><a href="Utility.Exception.html#tryIO"><span class="hs-identifier hs-var">tryIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Either IOException ()))
-&gt; IO () -&gt; IO (Either IOException ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-507"></span><span>		</span><span class="annot"><span class="annottext">Handle -&gt; Text -&gt; IO ()
</span><span class="hs-identifier hs-var">T.hPutStr</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072727"><span class="hs-identifier hs-var">outh</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679072731"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-508"></span><span>		</span><span class="annot"><span class="annottext">Handle -&gt; IO ()
</span><span class="hs-identifier hs-var">hFlush</span></span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621679072727"><span class="hs-identifier hs-var">outh</span></a></span><span>
</span><span id="line-509"></span></pre></body></html>