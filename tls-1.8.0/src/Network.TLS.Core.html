<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# OPTIONS_HADDOCK hide #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings, ScopedTypeVariables, BangPatterns #-}</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- Module      : Network.TLS.Core</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- License     : BSD-style</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- Maintainer  : Vincent Hanquez &lt;vincent@snarc.org&gt;</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Stability   : experimental</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- Portability : unknown</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.TLS.Core</span><span>
</span><span id="line-11"></span><span>    </span><span class="hs-special">(</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Internal packet sending and receiving</span></span><span>
</span><span id="line-13"></span><span>      </span><span class="annot"><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier">sendPacket</span></a></span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.IO.html#recvPacket"><span class="hs-identifier">recvPacket</span></a></span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Initialisation and Termination of context</span></span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Core.html#bye"><span class="hs-identifier">bye</span></a></span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.html#handshake"><span class="hs-identifier">handshake</span></a></span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Application Layer Protocol Negotiation</span></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Core.html#getNegotiatedProtocol"><span class="hs-identifier">getNegotiatedProtocol</span></a></span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Server Name Indication</span></span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Core.html#getClientSNI"><span class="hs-identifier">getClientSNI</span></a></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><span class="hs-comment">-- * High level API</span></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Core.html#sendData"><span class="hs-identifier">sendData</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Core.html#recvData"><span class="hs-identifier">recvData</span></a></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Core.html#recvData%27"><span class="hs-identifier">recvData'</span></a></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Core.html#updateKey"><span class="hs-identifier">updateKey</span></a></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Core.html#KeyUpdateRequest"><span class="hs-identifier">KeyUpdateRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.PostHandshake.html#requestCertificate"><span class="hs-identifier">requestCertificate</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Cipher.html"><span class="hs-identifier">Network.TLS.Cipher</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Context.html"><span class="hs-identifier">Network.TLS.Context</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Crypto.html"><span class="hs-identifier">Network.TLS.Crypto</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html"><span class="hs-identifier">Network.TLS.Struct</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Struct13.html"><span class="hs-identifier">Network.TLS.Struct13</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.State.html"><span class="hs-identifier">Network.TLS.State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.State.html#getSession"><span class="hs-identifier">getSession</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html"><span class="hs-identifier">Network.TLS.Parameters</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.IO.html"><span class="hs-identifier">Network.TLS.IO</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Session.html"><span class="hs-identifier">Network.TLS.Session</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.html"><span class="hs-identifier">Network.TLS.Handshake</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Common.html"><span class="hs-identifier">Network.TLS.Handshake.Common</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Common13.html"><span class="hs-identifier">Network.TLS.Handshake.Common13</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Process.html"><span class="hs-identifier">Network.TLS.Handshake.Process</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.State.html"><span class="hs-identifier">Network.TLS.Handshake.State</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.State13.html"><span class="hs-identifier">Network.TLS.Handshake.State13</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.PostHandshake.html"><span class="hs-identifier">Network.TLS.PostHandshake</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.KeySchedule.html"><span class="hs-identifier">Network.TLS.KeySchedule</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Types.html"><span class="hs-identifier">Network.TLS.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Types.html#Role"><span class="hs-identifier">Role</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">HostName</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#AnyTrafficSecret"><span class="hs-identifier">AnyTrafficSecret</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#ApplicationSecret"><span class="hs-identifier">ApplicationSecret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Util.html"><span class="hs-identifier">Network.TLS.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Util.html#catchException"><span class="hs-identifier">catchException</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Util.html#mapChunks_"><span class="hs-identifier">mapChunks_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Extension.html"><span class="hs-identifier">Network.TLS.Extension</span></a></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Network.TLS.State.html"><span class="hs-identifier">Network.TLS.State</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B</span></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Char8</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C8</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unless</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">E</span></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Strict</span></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-comment">-- | notify the context that this side wants to close connection.</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- this is important that it is called before closing the handle, otherwise</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- the session might not be resumable (for version &lt; TLS1.2).</span><span>
</span><span id="line-67"></span><span class="hs-comment">--</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- this doesn't actually close the handle</span><span>
</span><span id="line-69"></span><span id="local-6989586621679196237"><span class="annot"><a href="Network.TLS.Core.html#bye"><span class="hs-identifier hs-type">bye</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679196237"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679196237"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-70"></span><span id="bye"><span class="annot"><span class="annottext">bye :: forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ()
</span><a href="Network.TLS.Core.html#bye"><span class="hs-identifier hs-var hs-var">bye</span></a></span></span><span> </span><span id="local-6989586621679196400"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196400"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-comment">-- Although setEOF is always protected by the read lock, here we don't try</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-comment">-- to wrap ctxEOF with it, so that function bye can still be called</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-comment">-- concurrently to a blocked recvData.</span><span>
</span><span id="line-74"></span><span>    </span><span id="local-6989586621679196402"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196402"><span class="hs-identifier hs-var">eof</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Bool
</span><a href="Network.TLS.Context.Internal.html#ctxEOF"><span class="hs-identifier hs-var">ctxEOF</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196400"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-75"></span><span>    </span><span id="local-6989586621679196404"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196404"><span class="hs-identifier hs-var">tls13</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Bool
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m Bool
</span><a href="Network.TLS.Context.Internal.html#tls13orLater"><span class="hs-identifier hs-var">tls13orLater</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196400"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-76"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196402"><span class="hs-identifier hs-var">eof</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO () -&gt; IO ()
forall a. Context -&gt; IO a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#withWriteLock"><span class="hs-identifier hs-var">withWriteLock</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196400"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-77"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196404"><span class="hs-identifier hs-var">tls13</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-78"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Packet13 -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket13"><span class="hs-identifier hs-var">sendPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196400"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet13 -&gt; IO ()) -&gt; Packet13 -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Alert13"><span class="hs-identifier hs-var">Alert13</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Warning"><span class="hs-identifier hs-var">AlertLevel_Warning</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#CloseNotify"><span class="hs-identifier hs-var">CloseNotify</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-79"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-80"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Packet -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier hs-var">sendPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196400"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet -&gt; IO ()) -&gt; Packet -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)] -&gt; Packet
</span><a href="Network.TLS.Struct.html#Alert"><span class="hs-identifier hs-var">Alert</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Warning"><span class="hs-identifier hs-var">AlertLevel_Warning</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#CloseNotify"><span class="hs-identifier hs-var">CloseNotify</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- | If the ALPN extensions have been used, this will</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- return get the protocol agreed upon.</span><span>
</span><span id="line-84"></span><span id="local-6989586621679196252"><span class="annot"><a href="Network.TLS.Core.html#getNegotiatedProtocol"><span class="hs-identifier hs-type">getNegotiatedProtocol</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679196252"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679196252"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-85"></span><span id="getNegotiatedProtocol"><span class="annot"><span class="annottext">getNegotiatedProtocol :: forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m (Maybe ByteString)
</span><a href="Network.TLS.Core.html#getNegotiatedProtocol"><span class="hs-identifier hs-var hs-var">getNegotiatedProtocol</span></a></span></span><span> </span><span id="local-6989586621679196414"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196414"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ByteString) -&gt; m (Maybe ByteString)
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe ByteString) -&gt; m (Maybe ByteString))
-&gt; IO (Maybe ByteString) -&gt; m (Maybe ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt (Maybe ByteString) -&gt; IO (Maybe ByteString)
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196414"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt (Maybe ByteString)
</span><a href="Network.TLS.State.html#getNegotiatedProtocol"><span class="hs-identifier hs-var">S.getNegotiatedProtocol</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-comment">-- | If the Server Name Indication extension has been used, return the</span><span>
</span><span id="line-88"></span><span class="hs-comment">-- hostname specified by the client.</span><span>
</span><span id="line-89"></span><span id="local-6989586621679196257"><span class="annot"><a href="Network.TLS.Core.html#getClientSNI"><span class="hs-identifier hs-type">getClientSNI</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679196257"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679196257"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">HostName</span></span><span class="hs-special">)</span></span><span>
</span><span id="line-90"></span><span id="getClientSNI"><span class="annot"><span class="annottext">getClientSNI :: forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m (Maybe HostName)
</span><a href="Network.TLS.Core.html#getClientSNI"><span class="hs-identifier hs-var hs-var">getClientSNI</span></a></span></span><span> </span><span id="local-6989586621679196419"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196419"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO (Maybe HostName) -&gt; m (Maybe HostName)
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe HostName) -&gt; m (Maybe HostName))
-&gt; IO (Maybe HostName) -&gt; m (Maybe HostName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt (Maybe HostName) -&gt; IO (Maybe HostName)
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196419"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt (Maybe HostName)
</span><a href="Network.TLS.State.html#getClientSNI"><span class="hs-identifier hs-var">S.getClientSNI</span></a></span><span>
</span><span id="line-91"></span><span>
</span><span id="line-92"></span><span class="hs-comment">-- | sendData sends a bunch of data.</span><span>
</span><span id="line-93"></span><span class="hs-comment">-- It will automatically chunk data to acceptable packet size</span><span>
</span><span id="line-94"></span><span id="local-6989586621679196260"><span class="annot"><a href="Network.TLS.Core.html#sendData"><span class="hs-identifier hs-type">sendData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679196260"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">L.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679196260"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-95"></span><span id="sendData"><span class="annot"><span class="annottext">sendData :: forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; ByteString -&gt; m ()
</span><a href="Network.TLS.Core.html#sendData"><span class="hs-identifier hs-var hs-var">sendData</span></a></span></span><span> </span><span id="local-6989586621679196430"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196430"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679196431"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196431"><span class="hs-identifier hs-var">dataToSend</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-96"></span><span>    </span><span id="local-6989586621679196432"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196432"><span class="hs-identifier hs-var">tls13</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Bool
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m Bool
</span><a href="Network.TLS.Context.Internal.html#tls13orLater"><span class="hs-identifier hs-var">tls13orLater</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196430"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196433"><span class="annot"><span class="annottext">sendP :: ByteString -&gt; IO ()
</span><a href="#local-6989586621679196433"><span class="hs-identifier hs-var hs-var">sendP</span></a></span></span><span>
</span><span id="line-98"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196432"><span class="hs-identifier hs-var">tls13</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Packet13 -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket13"><span class="hs-identifier hs-var">sendPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196430"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet13 -&gt; IO ())
-&gt; (ByteString -&gt; Packet13) -&gt; ByteString -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#AppData13"><span class="hs-identifier hs-var">AppData13</span></a></span><span>
</span><span id="line-99"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Packet -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier hs-var">sendPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196430"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet -&gt; IO ()) -&gt; (ByteString -&gt; Packet) -&gt; ByteString -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Packet
</span><a href="Network.TLS.Struct.html#AppData"><span class="hs-identifier hs-var">AppData</span></a></span><span>
</span><span id="line-100"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; IO () -&gt; IO ()
forall a. Context -&gt; IO a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#withWriteLock"><span class="hs-identifier hs-var">withWriteLock</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196430"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.IO.html#checkValid"><span class="hs-identifier hs-var">checkValid</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196430"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-102"></span><span>        </span><span class="hs-comment">-- All chunks are protected with the same write lock because we don't</span><span>
</span><span id="line-103"></span><span>        </span><span class="hs-comment">-- want to interleave writes from other threads in the middle of our</span><span>
</span><span id="line-104"></span><span>        </span><span class="hs-comment">-- possibly large write.</span><span>
</span><span id="line-105"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196438"><span class="annot"><span class="annottext">len :: Maybe Int
</span><a href="#local-6989586621679196438"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Maybe Int
</span><a href="Network.TLS.Context.Internal.html#ctxFragmentSize"><span class="hs-identifier hs-var">ctxFragmentSize</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196430"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-106"></span><span>        </span><span class="annot"><span class="annottext">(ByteString -&gt; IO ()) -&gt; [ByteString] -&gt; IO ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Int -&gt; (ByteString -&gt; IO ()) -&gt; ByteString -&gt; IO ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
Maybe Int -&gt; (ByteString -&gt; m a) -&gt; ByteString -&gt; m ()
</span><a href="Network.TLS.Util.html#mapChunks_"><span class="hs-identifier hs-var">mapChunks_</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679196438"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ()
</span><a href="#local-6989586621679196433"><span class="hs-identifier hs-var">sendP</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString]
</span><span class="hs-identifier hs-var">L.toChunks</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196431"><span class="hs-identifier hs-var">dataToSend</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-comment">-- | Get data out of Data packet, and automatically renegotiate if a Handshake</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- ClientHello is received.  An empty result means EOF.</span><span>
</span><span id="line-110"></span><span id="local-6989586621679196272"><span class="annot"><a href="Network.TLS.Core.html#recvData"><span class="hs-identifier hs-type">recvData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679196272"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679196272"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span></span><span>
</span><span id="line-111"></span><span id="recvData"><span class="annot"><span class="annottext">recvData :: forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ByteString
</span><a href="Network.TLS.Core.html#recvData"><span class="hs-identifier hs-var hs-var">recvData</span></a></span></span><span> </span><span id="local-6989586621679196447"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196447"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ByteString -&gt; m ByteString
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; m ByteString) -&gt; IO ByteString -&gt; m ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-112"></span><span>    </span><span id="local-6989586621679196448"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196448"><span class="hs-identifier hs-var">tls13</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Bool
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m Bool
</span><a href="Network.TLS.Context.Internal.html#tls13orLater"><span class="hs-identifier hs-var">tls13orLater</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196447"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-113"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString -&gt; IO ByteString
forall a. Context -&gt; IO a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#withReadLock"><span class="hs-identifier hs-var">withReadLock</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196447"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ByteString -&gt; IO ByteString) -&gt; IO ByteString -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-114"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.IO.html#checkValid"><span class="hs-identifier hs-var">checkValid</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196447"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-115"></span><span>        </span><span class="hs-comment">-- We protect with a read lock both reception and processing of the</span><span>
</span><span id="line-116"></span><span>        </span><span class="hs-comment">-- packet, because don't want another thread to receive a new packet</span><span>
</span><span id="line-117"></span><span>        </span><span class="hs-comment">-- before this one has been fully processed.</span><span>
</span><span id="line-118"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-119"></span><span>        </span><span class="hs-comment">-- Even when recvData1/recvData13 loops, we only need to call function</span><span>
</span><span id="line-120"></span><span>        </span><span class="hs-comment">-- checkValid once.  Since we hold the read lock, no concurrent call</span><span>
</span><span id="line-121"></span><span>        </span><span class="hs-comment">-- will impact the validity of the context.</span><span>
</span><span id="line-122"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196448"><span class="hs-identifier hs-var">tls13</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString
</span><a href="Network.TLS.Core.html#recvData13"><span class="hs-identifier hs-var">recvData13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196447"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString
</span><a href="Network.TLS.Core.html#recvData1"><span class="hs-identifier hs-var">recvData1</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196447"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="annot"><a href="Network.TLS.Core.html#recvData1"><span class="hs-identifier hs-type">recvData1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span>
</span><span id="line-125"></span><span id="recvData1"><span class="annot"><span class="annottext">recvData1 :: Context -&gt; IO ByteString
</span><a href="Network.TLS.Core.html#recvData1"><span class="hs-identifier hs-var hs-var">recvData1</span></a></span></span><span> </span><span id="local-6989586621679196452"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196452"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-126"></span><span>    </span><span id="local-6989586621679196453"><span class="annot"><span class="annottext">Either TLSError Packet
</span><a href="#local-6989586621679196453"><span class="hs-identifier hs-var">pkt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO (Either TLSError Packet)
</span><a href="Network.TLS.IO.html#recvPacket"><span class="hs-identifier hs-var">recvPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196452"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ByteString)
-&gt; (Packet -&gt; IO ByteString)
-&gt; Either TLSError Packet
-&gt; IO ByteString
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TLSError
 -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ByteString)
-&gt; TLSError -&gt; IO ByteString
forall (m :: * -&gt; *).
Monad m =&gt;
(TLSError
 -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; m ByteString)
-&gt; TLSError -&gt; m ByteString
</span><a href="Network.TLS.Core.html#onError"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span class="annot"><span class="annottext">TLSError
-&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ByteString
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196456"><span class="hs-identifier hs-var">terminate</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Packet -&gt; IO ByteString
</span><a href="#local-6989586621679196457"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="annot"><span class="annottext">Either TLSError Packet
</span><a href="#local-6989586621679196453"><span class="hs-identifier hs-var">pkt</span></a></span><span>
</span><span id="line-128"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679196457"><span class="annot"><span class="annottext">process :: Packet -&gt; IO ByteString
</span><a href="#local-6989586621679196457"><span class="hs-identifier hs-var hs-var">process</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679196479"><span class="annot"><span class="annottext">ch :: Handshake
</span><a href="#local-6989586621679196479"><span class="hs-identifier hs-var">ch</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.TLS.Struct.html#ClientHello"><span class="hs-identifier hs-type">ClientHello</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-129"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Handshake -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; Handshake -&gt; m ()
</span><a href="Network.TLS.Handshake.html#handshakeWith"><span class="hs-identifier hs-var">handshakeWith</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196452"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679196479"><span class="hs-identifier hs-var">ch</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ByteString -&gt; IO ByteString
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString
</span><a href="Network.TLS.Core.html#recvData1"><span class="hs-identifier hs-var">recvData1</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196452"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-130"></span><span>        </span><span class="annot"><a href="#local-6989586621679196457"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679196482"><span class="annot"><span class="annottext">hr :: Handshake
</span><a href="#local-6989586621679196482"><span class="hs-identifier hs-var">hr</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">Handshake
</span><a href="Network.TLS.Struct.html#HelloRequest"><span class="hs-identifier hs-var">HelloRequest</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-131"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Handshake -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; Handshake -&gt; m ()
</span><a href="Network.TLS.Handshake.html#handshakeWith"><span class="hs-identifier hs-var">handshakeWith</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196452"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679196482"><span class="hs-identifier hs-var">hr</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ByteString -&gt; IO ByteString
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString
</span><a href="Network.TLS.Core.html#recvData1"><span class="hs-identifier hs-var">recvData1</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196452"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span>        </span><span class="annot"><a href="#local-6989586621679196457"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#Alert"><span class="hs-identifier hs-type">Alert</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Warning"><span class="hs-identifier hs-var">AlertLevel_Warning</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#CloseNotify"><span class="hs-identifier hs-var">CloseNotify</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Core.html#tryBye"><span class="hs-identifier hs-var">tryBye</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196452"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#setEOF"><span class="hs-identifier hs-var">setEOF</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196452"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ByteString -&gt; IO ByteString
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-134"></span><span>        </span><span class="annot"><a href="#local-6989586621679196457"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#Alert"><span class="hs-identifier hs-type">Alert</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679196488"><span class="annot"><span class="annottext">AlertDescription
</span><a href="#local-6989586621679196488"><span class="hs-identifier hs-var">desc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-135"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#setEOF"><span class="hs-identifier hs-var">setEOF</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196452"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-136"></span><span>            </span><span class="annot"><span class="annottext">TLSException -&gt; IO ByteString
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; HostName -&gt; TLSError -&gt; TLSException
</span><a href="Network.TLS.Struct.html#Terminated"><span class="hs-identifier hs-var">Terminated</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;received fatal error: &quot;</span></span><span> </span><span class="annot"><span class="annottext">HostName -&gt; HostName -&gt; HostName
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">AlertDescription -&gt; HostName
forall a. Show a =&gt; a -&gt; HostName
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="#local-6989586621679196488"><span class="hs-identifier hs-var">desc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HostName, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;remote side fatal error&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="#local-6989586621679196488"><span class="hs-identifier hs-var">desc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span>        </span><span class="hs-comment">-- when receiving empty appdata, we just retry to get some data.</span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><a href="#local-6989586621679196457"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#AppData"><span class="hs-identifier hs-type">AppData</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString
</span><a href="Network.TLS.Core.html#recvData1"><span class="hs-identifier hs-var">recvData1</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196452"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-140"></span><span>        </span><span class="annot"><a href="#local-6989586621679196457"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#AppData"><span class="hs-identifier hs-type">AppData</span></a></span><span> </span><span id="local-6989586621679196493"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196493"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196493"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-141"></span><span>        </span><span class="annot"><a href="#local-6989586621679196457"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span id="local-6989586621679196494"><span class="annot"><span class="annottext">Packet
</span><a href="#local-6989586621679196494"><span class="hs-identifier hs-var">p</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196499"><span class="annot"><span class="annottext">reason :: HostName
</span><a href="#local-6989586621679196499"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;unexpected message &quot;</span></span><span> </span><span class="annot"><span class="annottext">HostName -&gt; HostName -&gt; HostName
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Packet -&gt; HostName
forall a. Show a =&gt; a -&gt; HostName
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Packet
</span><a href="#local-6989586621679196494"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-142"></span><span>                               </span><span class="annot"><span class="annottext">TLSError
-&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ByteString
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196456"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Misc"><span class="hs-identifier hs-var">Error_Misc</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196499"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196499"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span>        </span><span id="local-6989586621679196456"><span class="annot"><span class="annottext">terminate :: TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196456"><span class="hs-identifier hs-var hs-var">terminate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; ([(AlertLevel, AlertDescription)] -&gt; IO ())
-&gt; TLSError
-&gt; AlertLevel
-&gt; AlertDescription
-&gt; HostName
-&gt; IO a
forall a.
Context
-&gt; ([(AlertLevel, AlertDescription)] -&gt; IO ())
-&gt; TLSError
-&gt; AlertLevel
-&gt; AlertDescription
-&gt; HostName
-&gt; IO a
</span><a href="Network.TLS.Core.html#terminateWithWriteLock"><span class="hs-identifier hs-var">terminateWithWriteLock</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196452"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Packet -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier hs-var">sendPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196452"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet -&gt; IO ())
-&gt; ([(AlertLevel, AlertDescription)] -&gt; Packet)
-&gt; [(AlertLevel, AlertDescription)]
-&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)] -&gt; Packet
</span><a href="Network.TLS.Struct.html#Alert"><span class="hs-identifier hs-var">Alert</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span class="annot"><a href="Network.TLS.Core.html#recvData13"><span class="hs-identifier hs-type">recvData13</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span>
</span><span id="line-147"></span><span id="recvData13"><span class="annot"><span class="annottext">recvData13 :: Context -&gt; IO ByteString
</span><a href="Network.TLS.Core.html#recvData13"><span class="hs-identifier hs-var hs-var">recvData13</span></a></span></span><span> </span><span id="local-6989586621679196503"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-148"></span><span>    </span><span id="local-6989586621679196504"><span class="annot"><span class="annottext">Either TLSError Packet13
</span><a href="#local-6989586621679196504"><span class="hs-identifier hs-var">pkt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO (Either TLSError Packet13)
</span><a href="Network.TLS.IO.html#recvPacket13"><span class="hs-identifier hs-var">recvPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-149"></span><span>    </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ByteString)
-&gt; (Packet13 -&gt; IO ByteString)
-&gt; Either TLSError Packet13
-&gt; IO ByteString
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TLSError
 -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ByteString)
-&gt; TLSError -&gt; IO ByteString
forall (m :: * -&gt; *).
Monad m =&gt;
(TLSError
 -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; m ByteString)
-&gt; TLSError -&gt; m ByteString
</span><a href="Network.TLS.Core.html#onError"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span class="annot"><span class="annottext">TLSError
-&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ByteString
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196506"><span class="hs-identifier hs-var">terminate</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Packet13 -&gt; IO ByteString
</span><a href="#local-6989586621679196507"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="annot"><span class="annottext">Either TLSError Packet13
</span><a href="#local-6989586621679196504"><span class="hs-identifier hs-var">pkt</span></a></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679196507"><span class="annot"><span class="annottext">process :: Packet13 -&gt; IO ByteString
</span><a href="#local-6989586621679196507"><span class="hs-identifier hs-var hs-var">process</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#Alert13"><span class="hs-identifier hs-type">Alert13</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Warning"><span class="hs-identifier hs-var">AlertLevel_Warning</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UserCanceled"><span class="hs-identifier hs-var">UserCanceled</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-151"></span><span>        </span><span class="annot"><a href="#local-6989586621679196507"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#Alert13"><span class="hs-identifier hs-type">Alert13</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Warning"><span class="hs-identifier hs-var">AlertLevel_Warning</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#CloseNotify"><span class="hs-identifier hs-var">CloseNotify</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Core.html#tryBye"><span class="hs-identifier hs-var">tryBye</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#setEOF"><span class="hs-identifier hs-var">setEOF</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ByteString -&gt; IO ByteString
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-152"></span><span>        </span><span class="annot"><a href="#local-6989586621679196507"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#Alert13"><span class="hs-identifier hs-type">Alert13</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679196538"><span class="annot"><span class="annottext">AlertDescription
</span><a href="#local-6989586621679196538"><span class="hs-identifier hs-var">desc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-153"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#setEOF"><span class="hs-identifier hs-var">setEOF</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-154"></span><span>            </span><span class="annot"><span class="annottext">TLSException -&gt; IO ByteString
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; HostName -&gt; TLSError -&gt; TLSException
</span><a href="Network.TLS.Struct.html#Terminated"><span class="hs-identifier hs-var">Terminated</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;received fatal error: &quot;</span></span><span> </span><span class="annot"><span class="annottext">HostName -&gt; HostName -&gt; HostName
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">AlertDescription -&gt; HostName
forall a. Show a =&gt; a -&gt; HostName
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="#local-6989586621679196538"><span class="hs-identifier hs-var">desc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HostName, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;remote side fatal error&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="#local-6989586621679196538"><span class="hs-identifier hs-var">desc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>        </span><span class="annot"><a href="#local-6989586621679196507"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-type">Handshake13</span></a></span><span> </span><span id="local-6989586621679196540"><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196540"><span class="hs-identifier hs-var">hs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>            </span><span class="annot"><span class="annottext">[Handshake13] -&gt; IO ()
</span><a href="#local-6989586621679196541"><span class="hs-identifier hs-var">loopHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196540"><span class="hs-identifier hs-var">hs</span></a></span><span>
</span><span id="line-157"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString
</span><a href="Network.TLS.Core.html#recvData13"><span class="hs-identifier hs-var">recvData13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-158"></span><span>        </span><span class="hs-comment">-- when receiving empty appdata, we just retry to get some data.</span><span>
</span><span id="line-159"></span><span>        </span><span class="annot"><a href="#local-6989586621679196507"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#AppData13"><span class="hs-identifier hs-type">AppData13</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString
</span><a href="Network.TLS.Core.html#recvData13"><span class="hs-identifier hs-var">recvData13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-160"></span><span>        </span><span class="annot"><a href="#local-6989586621679196507"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#AppData13"><span class="hs-identifier hs-type">AppData13</span></a></span><span> </span><span id="local-6989586621679196542"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196542"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-161"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196543"><span class="annot"><span class="annottext">chunkLen :: Int
</span><a href="#local-6989586621679196543"><span class="hs-identifier hs-var hs-var">chunkLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">C8.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196542"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-162"></span><span>            </span><span id="local-6989586621679196545"><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679196545"><span class="hs-identifier hs-var">established</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Established
</span><a href="Network.TLS.Context.Internal.html#ctxEstablished"><span class="hs-identifier hs-var">ctxEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-163"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679196545"><span class="hs-identifier hs-var">established</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-164"></span><span>              </span><span class="annot"><a href="Network.TLS.Context.Internal.html#EarlyDataAllowed"><span class="hs-identifier hs-type">EarlyDataAllowed</span></a></span><span> </span><span id="local-6989586621679196548"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679196548"><span class="hs-identifier hs-var">maxSize</span></a></span></span><span>
</span><span id="line-165"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679196543"><span class="hs-identifier hs-var">chunkLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679196548"><span class="hs-identifier hs-var">maxSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-166"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; Established -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#setEstablished"><span class="hs-identifier hs-var">setEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Established -&gt; IO ()) -&gt; Established -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Established
</span><a href="Network.TLS.Context.Internal.html#EarlyDataAllowed"><span class="hs-identifier hs-var">EarlyDataAllowed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679196548"><span class="hs-identifier hs-var">maxSize</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679196543"><span class="hs-identifier hs-var">chunkLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>                    </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196542"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-168"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-169"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196552"><span class="annot"><span class="annottext">reason :: HostName
</span><a href="#local-6989586621679196552"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;early data overflow&quot;</span></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-170"></span><span>                    </span><span class="annot"><span class="annottext">TLSError
-&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ByteString
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196506"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Misc"><span class="hs-identifier hs-var">Error_Misc</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196552"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196552"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-171"></span><span>              </span><span class="annot"><a href="Network.TLS.Context.Internal.html#EarlyDataNotAllowed"><span class="hs-identifier hs-type">EarlyDataNotAllowed</span></a></span><span> </span><span id="local-6989586621679196554"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679196554"><span class="hs-identifier hs-var">n</span></a></span></span><span>
</span><span id="line-172"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679196554"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-173"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; Established -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#setEstablished"><span class="hs-identifier hs-var">setEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Established -&gt; IO ()) -&gt; Established -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Established
</span><a href="Network.TLS.Context.Internal.html#EarlyDataNotAllowed"><span class="hs-identifier hs-var">EarlyDataNotAllowed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679196554"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString
</span><a href="Network.TLS.Core.html#recvData13"><span class="hs-identifier hs-var">recvData13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-comment">-- ignore &quot;x&quot;</span><span>
</span><span id="line-175"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-176"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196557"><span class="annot"><span class="annottext">reason :: HostName
</span><a href="#local-6989586621679196557"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;early data deprotect overflow&quot;</span></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-177"></span><span>                    </span><span class="annot"><span class="annottext">TLSError
-&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ByteString
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196506"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Misc"><span class="hs-identifier hs-var">Error_Misc</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196557"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196557"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-178"></span><span>              </span><span class="annot"><span class="annottext">Established
</span><a href="Network.TLS.Context.Internal.html#Established"><span class="hs-identifier hs-var">Established</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196542"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-179"></span><span>              </span><span class="annot"><span class="annottext">Established
</span><a href="Network.TLS.Context.Internal.html#NotEstablished"><span class="hs-identifier hs-var">NotEstablished</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ByteString
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ByteString) -&gt; TLSError -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HostName, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;data at not-established&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><a href="#local-6989586621679196507"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="annot"><span class="annottext">Packet13
</span><a href="Network.TLS.Struct13.html#ChangeCipherSpec13"><span class="hs-identifier hs-var">ChangeCipherSpec13</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-181"></span><span>            </span><span id="local-6989586621679196562"><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679196562"><span class="hs-identifier hs-var">established</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Established
</span><a href="Network.TLS.Context.Internal.html#ctxEstablished"><span class="hs-identifier hs-var">ctxEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-182"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679196562"><span class="hs-identifier hs-var">established</span></a></span><span> </span><span class="annot"><span class="annottext">Established -&gt; Established -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Established
</span><a href="Network.TLS.Context.Internal.html#Established"><span class="hs-identifier hs-var">Established</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-183"></span><span>                </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString
</span><a href="Network.TLS.Core.html#recvData13"><span class="hs-identifier hs-var">recvData13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-184"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196565"><span class="annot"><span class="annottext">reason :: HostName
</span><a href="#local-6989586621679196565"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;CSS after Finished&quot;</span></span><span>
</span><span id="line-186"></span><span>                </span><span class="annot"><span class="annottext">TLSError
-&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ByteString
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196506"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Misc"><span class="hs-identifier hs-var">Error_Misc</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196565"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196565"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-187"></span><span>        </span><span class="annot"><a href="#local-6989586621679196507"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span id="local-6989586621679196566"><span class="annot"><span class="annottext">Packet13
</span><a href="#local-6989586621679196566"><span class="hs-identifier hs-var">p</span></a></span></span><span>             </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196571"><span class="annot"><span class="annottext">reason :: HostName
</span><a href="#local-6989586621679196571"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;unexpected message &quot;</span></span><span> </span><span class="annot"><span class="annottext">HostName -&gt; HostName -&gt; HostName
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Packet13 -&gt; HostName
forall a. Show a =&gt; a -&gt; HostName
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Packet13
</span><a href="#local-6989586621679196566"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-188"></span><span>                                </span><span class="annot"><span class="annottext">TLSError
-&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ByteString
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196506"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Misc"><span class="hs-identifier hs-var">Error_Misc</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196571"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196571"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span>        </span><span id="local-6989586621679196541"><span class="annot"><span class="annottext">loopHandshake13 :: [Handshake13] -&gt; IO ()
</span><a href="#local-6989586621679196541"><span class="hs-identifier hs-var hs-var">loopHandshake13</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>        </span><span class="annot"><a href="#local-6989586621679196541"><span class="hs-identifier hs-var">loopHandshake13</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#ClientHello13"><span class="hs-identifier hs-type">ClientHello13</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[Handshake13]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196622"><span class="annot"><span class="annottext">reason :: HostName
</span><a href="#local-6989586621679196622"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;Client hello is not allowed&quot;</span></span><span>
</span><span id="line-193"></span><span>            </span><span class="annot"><span class="annottext">TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ()
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196506"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Misc"><span class="hs-identifier hs-var">Error_Misc</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196622"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196622"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-194"></span><span>        </span><span class="hs-comment">-- fixme: some implementations send multiple NST at the same time.</span><span>
</span><span id="line-195"></span><span>        </span><span class="hs-comment">-- Only the first one is used at this moment.</span><span>
</span><span id="line-196"></span><span>        </span><span class="annot"><a href="#local-6989586621679196541"><span class="hs-identifier hs-var">loopHandshake13</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#NewSessionTicket13"><span class="hs-identifier hs-type">NewSessionTicket13</span></a></span><span> </span><span id="local-6989586621679196624"><span class="annot"><span class="annottext">Second
</span><a href="#local-6989586621679196624"><span class="hs-identifier hs-var">life</span></a></span></span><span> </span><span id="local-6989586621679196625"><span class="annot"><span class="annottext">Second
</span><a href="#local-6989586621679196625"><span class="hs-identifier hs-var">add</span></a></span></span><span> </span><span id="local-6989586621679196626"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196626"><span class="hs-identifier hs-var">nonce</span></a></span></span><span> </span><span id="local-6989586621679196627"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196627"><span class="hs-keyword hs-var">label</span></a></span></span><span> </span><span id="local-6989586621679196628"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679196628"><span class="hs-identifier hs-var">exts</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679196629"><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196629"><span class="hs-identifier hs-var">hs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-197"></span><span>            </span><span id="local-6989586621679196630"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621679196630"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Role -&gt; IO Role
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Role
</span><a href="Network.TLS.State.html#isClientContext"><span class="hs-identifier hs-var">S.isClientContext</span></a></span><span>
</span><span id="line-198"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621679196630"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; Role -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ClientRole"><span class="hs-identifier hs-var">ClientRole</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-199"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196635"><span class="annot"><span class="annottext">reason :: HostName
</span><a href="#local-6989586621679196635"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;Session ticket is allowed for client only&quot;</span></span><span>
</span><span id="line-200"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ()
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196506"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Misc"><span class="hs-identifier hs-var">Error_Misc</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196635"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196635"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-201"></span><span>            </span><span class="hs-comment">-- This part is similar to handshake code, so protected with</span><span>
</span><span id="line-202"></span><span>            </span><span class="hs-comment">-- read+write locks (which is also what we use for all calls to the</span><span>
</span><span id="line-203"></span><span>            </span><span class="hs-comment">-- session manager).</span><span>
</span><span id="line-204"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; IO () -&gt; IO ()
forall a. Context -&gt; IO a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#withWriteLock"><span class="hs-identifier hs-var">withWriteLock</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-205"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679196636"><span class="annot"><span class="annottext">BaseSecret ResumptionSecret
</span><a href="#local-6989586621679196636"><span class="hs-identifier hs-var">resumptionMasterSecret</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; HandshakeM (Maybe (BaseSecret ResumptionSecret))
-&gt; IO (Maybe (BaseSecret ResumptionSecret))
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM (Maybe (BaseSecret ResumptionSecret))
</span><a href="Network.TLS.Handshake.State.html#getTLS13ResumptionSecret"><span class="hs-identifier hs-var">getTLS13ResumptionSecret</span></a></span><span>
</span><span id="line-206"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679196639"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679196639"><span class="hs-identifier hs-var">usedCipher</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CryptLevel
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO (Hash, Cipher, CryptLevel, ByteString)
</span><a href="Network.TLS.Handshake.State13.html#getTxState"><span class="hs-identifier hs-var">getTxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-207"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196641"><span class="annot"><span class="annottext">choice :: CipherChoice
</span><a href="#local-6989586621679196641"><span class="hs-identifier hs-var hs-var">choice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Version -&gt; Cipher -&gt; CipherChoice
</span><a href="Network.TLS.Handshake.Common13.html#makeCipherChoice"><span class="hs-identifier hs-var">makeCipherChoice</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS13"><span class="hs-identifier hs-var">TLS13</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679196639"><span class="hs-identifier hs-var">usedCipher</span></a></span><span>
</span><span id="line-208"></span><span>                    </span><span id="local-6989586621679196644"><span class="annot"><span class="annottext">psk :: ByteString
</span><a href="#local-6989586621679196644"><span class="hs-identifier hs-var hs-var">psk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CipherChoice
-&gt; BaseSecret ResumptionSecret -&gt; ByteString -&gt; ByteString
</span><a href="Network.TLS.Handshake.Common13.html#derivePSK"><span class="hs-identifier hs-var">derivePSK</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679196641"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret ResumptionSecret
</span><a href="#local-6989586621679196636"><span class="hs-identifier hs-var">resumptionMasterSecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196626"><span class="hs-identifier hs-var">nonce</span></a></span><span>
</span><span id="line-209"></span><span>                    </span><span id="local-6989586621679196660"><span class="annot"><span class="annottext">maxSize :: Int
</span><a href="#local-6989586621679196660"><span class="hs-identifier hs-var hs-var">maxSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_EarlyData"><span class="hs-identifier hs-var">extensionID_EarlyData</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679196628"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
-&gt; (ByteString -&gt; Maybe EarlyDataIndication)
-&gt; Maybe EarlyDataIndication
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">MessageType -&gt; ByteString -&gt; Maybe EarlyDataIndication
forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTNewSessionTicket"><span class="hs-identifier hs-var">MsgTNewSessionTicket</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-210"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#EarlyDataIndication"><span class="hs-identifier hs-type">EarlyDataIndication</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679196666"><span class="annot"><span class="annottext">Second
</span><a href="#local-6989586621679196666"><span class="hs-identifier hs-var">ms</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Second -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Second -&gt; Int) -&gt; Second -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Second -&gt; Second
forall a. (Num a, Ord a, FiniteBits a) =&gt; a -&gt; a
</span><a href="Network.TLS.Handshake.Common13.html#safeNonNegative32"><span class="hs-identifier hs-var">safeNonNegative32</span></a></span><span> </span><span class="annot"><span class="annottext">Second
</span><a href="#local-6989586621679196666"><span class="hs-identifier hs-var">ms</span></a></span><span>
</span><span id="line-211"></span><span>                        </span><span class="annot"><span class="annottext">Maybe EarlyDataIndication
</span><span class="hs-identifier">_</span></span><span>                                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-212"></span><span>                    </span><span id="local-6989586621679196670"><span class="annot"><span class="annottext">life7d :: Second
</span><a href="#local-6989586621679196670"><span class="hs-identifier hs-var hs-var">life7d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Second -&gt; Second -&gt; Second
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="annot"><span class="annottext">Second
</span><a href="#local-6989586621679196624"><span class="hs-identifier hs-var">life</span></a></span><span> </span><span class="annot"><span class="annottext">Second
</span><span class="hs-number">604800</span></span><span>  </span><span class="hs-comment">-- 7 days max</span><span>
</span><span id="line-213"></span><span>                </span><span id="local-6989586621679196672"><span class="annot"><span class="annottext">TLS13TicketInfo
</span><a href="#local-6989586621679196672"><span class="hs-identifier hs-var">tinfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Second
-&gt; Either Context Second -&gt; Maybe Millisecond -&gt; IO TLS13TicketInfo
</span><a href="Network.TLS.Handshake.Common13.html#createTLS13TicketInfo"><span class="hs-identifier hs-var">createTLS13TicketInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Second
</span><a href="#local-6989586621679196670"><span class="hs-identifier hs-var">life7d</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Second -&gt; Either Context Second
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Second
</span><a href="#local-6989586621679196625"><span class="hs-identifier hs-var">add</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Millisecond
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-214"></span><span>                </span><span id="local-6989586621679196674"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679196674"><span class="hs-identifier hs-var">sdata</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; Cipher -&gt; TLS13TicketInfo -&gt; Int -&gt; ByteString -&gt; IO SessionData
</span><a href="Network.TLS.Handshake.Common13.html#getSessionData13"><span class="hs-identifier hs-var">getSessionData13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679196639"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">TLS13TicketInfo
</span><a href="#local-6989586621679196672"><span class="hs-identifier hs-var">tinfo</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679196660"><span class="hs-identifier hs-var">maxSize</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196644"><span class="hs-identifier hs-var">psk</span></a></span><span>
</span><span id="line-215"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679196676"><span class="annot"><span class="annottext">label' :: ByteString
</span><a href="#local-6989586621679196676"><span class="hs-identifier hs-var hs-var">label'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">B.copy</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196627"><span class="hs-keyword hs-var">label</span></a></span><span>
</span><span id="line-216"></span><span>                </span><span class="annot"><span class="annottext">SessionManager -&gt; ByteString -&gt; SessionData -&gt; IO ()
</span><a href="Network.TLS.Session.html#sessionEstablish"><span class="hs-identifier hs-var">sessionEstablish</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shared -&gt; SessionManager
</span><a href="Network.TLS.Parameters.html#sharedSessionManager"><span class="hs-identifier hs-var">sharedSessionManager</span></a></span><span> </span><span class="annot"><span class="annottext">(Shared -&gt; SessionManager) -&gt; Shared -&gt; SessionManager
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Shared
</span><a href="Network.TLS.Context.Internal.html#ctxShared"><span class="hs-identifier hs-var">ctxShared</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196676"><span class="hs-identifier hs-var">label'</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679196674"><span class="hs-identifier hs-var">sdata</span></a></span><span>
</span><span id="line-217"></span><span>                </span><span class="hs-comment">-- putStrLn $ &quot;NewSessionTicket received: lifetime = &quot; ++ show life ++ &quot; sec&quot;</span><span>
</span><span id="line-218"></span><span>            </span><span class="annot"><span class="annottext">[Handshake13] -&gt; IO ()
</span><a href="#local-6989586621679196541"><span class="hs-identifier hs-var">loopHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196629"><span class="hs-identifier hs-var">hs</span></a></span><span>
</span><span id="line-219"></span><span>        </span><span class="annot"><a href="#local-6989586621679196541"><span class="hs-identifier hs-var">loopHandshake13</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#KeyUpdate13"><span class="hs-identifier hs-type">KeyUpdate13</span></a></span><span> </span><span id="local-6989586621679196682"><span class="annot"><span class="annottext">KeyUpdate
</span><a href="#local-6989586621679196682"><span class="hs-identifier hs-var">mode</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679196683"><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196683"><span class="hs-identifier hs-var">hs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-220"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.TLS.Context.Internal.html#ctxQUICMode"><span class="hs-identifier hs-var">ctxQUICMode</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-221"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196687"><span class="annot"><span class="annottext">reason :: HostName
</span><a href="#local-6989586621679196687"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;KeyUpdate is not allowed for QUIC&quot;</span></span><span>
</span><span id="line-222"></span><span>                </span><span class="annot"><span class="annottext">TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ()
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196506"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Misc"><span class="hs-identifier hs-var">Error_Misc</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196687"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196687"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-223"></span><span>            </span><span class="annot"><span class="annottext">[Handshake13] -&gt; IO ()
forall {t :: * -&gt; *} {a}. Foldable t =&gt; t a -&gt; IO ()
</span><a href="#local-6989586621679196688"><span class="hs-identifier hs-var">checkAlignment</span></a></span><span> </span><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196683"><span class="hs-identifier hs-var">hs</span></a></span><span>
</span><span id="line-224"></span><span>            </span><span id="local-6989586621679196689"><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679196689"><span class="hs-identifier hs-var">established</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Established
</span><a href="Network.TLS.Context.Internal.html#ctxEstablished"><span class="hs-identifier hs-var">ctxEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-225"></span><span>            </span><span class="hs-comment">-- Though RFC 8446 Sec 4.6.3 does not clearly says,</span><span>
</span><span id="line-226"></span><span>            </span><span class="hs-comment">-- unidirectional key update is legal.</span><span>
</span><span id="line-227"></span><span>            </span><span class="hs-comment">-- So, we don't have to check if this key update is corresponding</span><span>
</span><span id="line-228"></span><span>            </span><span class="hs-comment">-- to key update (update_requested) which we sent.</span><span>
</span><span id="line-229"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679196689"><span class="hs-identifier hs-var">established</span></a></span><span> </span><span class="annot"><span class="annottext">Established -&gt; Established -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Established
</span><a href="Network.TLS.Context.Internal.html#Established"><span class="hs-identifier hs-var">Established</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>                </span><span class="annot"><span class="annottext">Context
-&gt; (Context -&gt; IO (Hash, Cipher, CryptLevel, ByteString))
-&gt; (Context
    -&gt; Hash -&gt; Cipher -&gt; AnyTrafficSecret ApplicationSecret -&gt; IO ())
-&gt; IO ()
</span><a href="Network.TLS.Core.html#keyUpdate"><span class="hs-identifier hs-var">keyUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO (Hash, Cipher, CryptLevel, ByteString)
</span><a href="Network.TLS.Handshake.State13.html#getRxState"><span class="hs-identifier hs-var">getRxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; Hash -&gt; Cipher -&gt; AnyTrafficSecret ApplicationSecret -&gt; IO ()
forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setRxState"><span class="hs-identifier hs-var">setRxState</span></a></span><span>
</span><span id="line-231"></span><span>                </span><span class="hs-comment">-- Write lock wraps both actions because we don't want another</span><span>
</span><span id="line-232"></span><span>                </span><span class="hs-comment">-- packet to be sent by another thread before the Tx state is</span><span>
</span><span id="line-233"></span><span>                </span><span class="hs-comment">-- updated.</span><span>
</span><span id="line-234"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyUpdate
</span><a href="#local-6989586621679196682"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">KeyUpdate -&gt; KeyUpdate -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">KeyUpdate
</span><a href="Network.TLS.Struct13.html#UpdateRequested"><span class="hs-identifier hs-var">UpdateRequested</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO () -&gt; IO ()
forall a. Context -&gt; IO a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#withWriteLock"><span class="hs-identifier hs-var">withWriteLock</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; Packet13 -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket13"><span class="hs-identifier hs-var">sendPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet13 -&gt; IO ()) -&gt; Packet13 -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">KeyUpdate -&gt; Handshake13
</span><a href="Network.TLS.Struct13.html#KeyUpdate13"><span class="hs-identifier hs-var">KeyUpdate13</span></a></span><span> </span><span class="annot"><span class="annottext">KeyUpdate
</span><a href="Network.TLS.Struct13.html#UpdateNotRequested"><span class="hs-identifier hs-var">UpdateNotRequested</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-236"></span><span>                    </span><span class="annot"><span class="annottext">Context
-&gt; (Context -&gt; IO (Hash, Cipher, CryptLevel, ByteString))
-&gt; (Context
    -&gt; Hash -&gt; Cipher -&gt; AnyTrafficSecret ApplicationSecret -&gt; IO ())
-&gt; IO ()
</span><a href="Network.TLS.Core.html#keyUpdate"><span class="hs-identifier hs-var">keyUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO (Hash, Cipher, CryptLevel, ByteString)
</span><a href="Network.TLS.Handshake.State13.html#getTxState"><span class="hs-identifier hs-var">getTxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; Hash -&gt; Cipher -&gt; AnyTrafficSecret ApplicationSecret -&gt; IO ()
forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setTxState"><span class="hs-identifier hs-var">setTxState</span></a></span><span>
</span><span id="line-237"></span><span>                </span><span class="annot"><span class="annottext">[Handshake13] -&gt; IO ()
</span><a href="#local-6989586621679196541"><span class="hs-identifier hs-var">loopHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196683"><span class="hs-identifier hs-var">hs</span></a></span><span>
</span><span id="line-238"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-239"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196698"><span class="annot"><span class="annottext">reason :: HostName
</span><a href="#local-6989586621679196698"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;received key update before established&quot;</span></span><span>
</span><span id="line-240"></span><span>                </span><span class="annot"><span class="annottext">TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ()
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196506"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Misc"><span class="hs-identifier hs-var">Error_Misc</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196698"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196698"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-241"></span><span>        </span><span class="annot"><a href="#local-6989586621679196541"><span class="hs-identifier hs-var">loopHandshake13</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679196699"><span class="annot"><span class="annottext">h :: Handshake13
</span><a href="#local-6989586621679196699"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.TLS.Struct13.html#CertRequest13"><span class="hs-identifier hs-type">CertRequest13</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679196701"><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196701"><span class="hs-identifier hs-var">hs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-242"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Handshake13 -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; Handshake13 -&gt; m ()
</span><a href="Network.TLS.PostHandshake.html#postHandshakeAuthWith"><span class="hs-identifier hs-var">postHandshakeAuthWith</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679196699"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; IO ()
</span><a href="#local-6989586621679196541"><span class="hs-identifier hs-var">loopHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196701"><span class="hs-identifier hs-var">hs</span></a></span><span>
</span><span id="line-243"></span><span>        </span><span class="annot"><a href="#local-6989586621679196541"><span class="hs-identifier hs-var">loopHandshake13</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679196703"><span class="annot"><span class="annottext">h :: Handshake13
</span><a href="#local-6989586621679196703"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Network.TLS.Struct13.html#Certificate13"><span class="hs-identifier hs-type">Certificate13</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679196705"><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196705"><span class="hs-identifier hs-var">hs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-244"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Handshake13 -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; Handshake13 -&gt; m ()
</span><a href="Network.TLS.PostHandshake.html#postHandshakeAuthWith"><span class="hs-identifier hs-var">postHandshakeAuthWith</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679196703"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; IO ()
</span><a href="#local-6989586621679196541"><span class="hs-identifier hs-var">loopHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196705"><span class="hs-identifier hs-var">hs</span></a></span><span>
</span><span id="line-245"></span><span>        </span><span class="annot"><a href="#local-6989586621679196541"><span class="hs-identifier hs-var">loopHandshake13</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679196706"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679196706"><span class="hs-identifier hs-var">h</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679196707"><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196707"><span class="hs-identifier hs-var">hs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-246"></span><span>            </span><span id="local-6989586621679196708"><span class="annot"><span class="annottext">Maybe PendingAction
</span><a href="#local-6989586621679196708"><span class="hs-identifier hs-var">mPendingAction</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO (Maybe PendingAction)
</span><a href="Network.TLS.Handshake.State13.html#popPendingAction"><span class="hs-identifier hs-var">popPendingAction</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-247"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe PendingAction
</span><a href="#local-6989586621679196708"><span class="hs-identifier hs-var">mPendingAction</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-248"></span><span>                </span><span class="annot"><span class="annottext">Maybe PendingAction
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196714"><span class="annot"><span class="annottext">reason :: HostName
</span><a href="#local-6989586621679196714"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;unexpected handshake message &quot;</span></span><span> </span><span class="annot"><span class="annottext">HostName -&gt; HostName -&gt; HostName
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Handshake13 -&gt; HostName
forall a. Show a =&gt; a -&gt; HostName
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679196706"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-249"></span><span>                           </span><span class="annot"><span class="annottext">TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ()
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196506"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Misc"><span class="hs-identifier hs-var">Error_Misc</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196714"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196714"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-250"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679196715"><span class="annot"><span class="annottext">PendingAction
</span><a href="#local-6989586621679196715"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>                    </span><span class="hs-comment">-- Pending actions are executed with read+write locks, just</span><span>
</span><span id="line-252"></span><span>                    </span><span class="hs-comment">-- like regular handshake code.</span><span>
</span><span id="line-253"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; IO () -&gt; IO ()
forall a. Context -&gt; IO a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#withWriteLock"><span class="hs-identifier hs-var">withWriteLock</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO () -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common.html#handleException"><span class="hs-identifier hs-var">handleException</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-254"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PendingAction
</span><a href="#local-6989586621679196715"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-255"></span><span>                            </span><span class="annot"><a href="Network.TLS.Context.Internal.html#PendingAction"><span class="hs-identifier hs-type">PendingAction</span></a></span><span> </span><span id="local-6989586621679196718"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196718"><span class="hs-identifier hs-var">needAligned</span></a></span></span><span> </span><span id="local-6989586621679196719"><span class="annot"><span class="annottext">Handshake13 -&gt; IO ()
</span><a href="#local-6989586621679196719"><span class="hs-identifier hs-var">pa</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>                                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196718"><span class="hs-identifier hs-var">needAligned</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; IO ()
forall {t :: * -&gt; *} {a}. Foldable t =&gt; t a -&gt; IO ()
</span><a href="#local-6989586621679196688"><span class="hs-identifier hs-var">checkAlignment</span></a></span><span> </span><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196707"><span class="hs-identifier hs-var">hs</span></a></span><span>
</span><span id="line-257"></span><span>                                </span><span class="annot"><span class="annottext">Context -&gt; Handshake13 -&gt; IO ()
</span><a href="Network.TLS.Handshake.Process.html#processHandshake13"><span class="hs-identifier hs-var">processHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679196706"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Handshake13 -&gt; IO ()
</span><a href="#local-6989586621679196719"><span class="hs-identifier hs-var">pa</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679196706"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-258"></span><span>                            </span><span class="annot"><a href="Network.TLS.Context.Internal.html#PendingActionHash"><span class="hs-identifier hs-type">PendingActionHash</span></a></span><span> </span><span id="local-6989586621679196722"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196722"><span class="hs-identifier hs-var">needAligned</span></a></span></span><span> </span><span id="local-6989586621679196723"><span class="annot"><span class="annottext">ByteString -&gt; Handshake13 -&gt; IO ()
</span><a href="#local-6989586621679196723"><span class="hs-identifier hs-var">pa</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-259"></span><span>                                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196722"><span class="hs-identifier hs-var">needAligned</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; IO ()
forall {t :: * -&gt; *} {a}. Foldable t =&gt; t a -&gt; IO ()
</span><a href="#local-6989586621679196688"><span class="hs-identifier hs-var">checkAlignment</span></a></span><span> </span><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196707"><span class="hs-identifier hs-var">hs</span></a></span><span>
</span><span id="line-260"></span><span>                                </span><span id="local-6989586621679196724"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196724"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ByteString
</span><a href="Network.TLS.Handshake.State13.html#transcriptHash"><span class="hs-identifier hs-var">transcriptHash</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-261"></span><span>                                </span><span class="annot"><span class="annottext">Context -&gt; Handshake13 -&gt; IO ()
</span><a href="Network.TLS.Handshake.Process.html#processHandshake13"><span class="hs-identifier hs-var">processHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679196706"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-262"></span><span>                                </span><span class="annot"><span class="annottext">ByteString -&gt; Handshake13 -&gt; IO ()
</span><a href="#local-6989586621679196723"><span class="hs-identifier hs-var">pa</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196724"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679196706"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-263"></span><span>                    </span><span class="annot"><span class="annottext">[Handshake13] -&gt; IO ()
</span><a href="#local-6989586621679196541"><span class="hs-identifier hs-var">loopHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">[Handshake13]
</span><a href="#local-6989586621679196707"><span class="hs-identifier hs-var">hs</span></a></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span>        </span><span id="local-6989586621679196506"><span class="annot"><span class="annottext">terminate :: TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196506"><span class="hs-identifier hs-var hs-var">terminate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; ([(AlertLevel, AlertDescription)] -&gt; IO ())
-&gt; TLSError
-&gt; AlertLevel
-&gt; AlertDescription
-&gt; HostName
-&gt; IO a
forall a.
Context
-&gt; ([(AlertLevel, AlertDescription)] -&gt; IO ())
-&gt; TLSError
-&gt; AlertLevel
-&gt; AlertDescription
-&gt; HostName
-&gt; IO a
</span><a href="Network.TLS.Core.html#terminateWithWriteLock"><span class="hs-identifier hs-var">terminateWithWriteLock</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Packet13 -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket13"><span class="hs-identifier hs-var">sendPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet13 -&gt; IO ())
-&gt; ([(AlertLevel, AlertDescription)] -&gt; Packet13)
-&gt; [(AlertLevel, AlertDescription)]
-&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Alert13"><span class="hs-identifier hs-var">Alert13</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span>        </span><span id="local-6989586621679196688"><span class="annot"><span class="annottext">checkAlignment :: t a -&gt; IO ()
</span><a href="#local-6989586621679196688"><span class="hs-identifier hs-var hs-var">checkAlignment</span></a></span></span><span> </span><span id="local-6989586621679196730"><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621679196730"><span class="hs-identifier hs-var">hs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>            </span><span id="local-6989586621679196731"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196731"><span class="hs-identifier hs-var">complete</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Bool
</span><a href="Network.TLS.IO.html#isRecvComplete"><span class="hs-identifier hs-var">isRecvComplete</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196503"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-269"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196731"><span class="hs-identifier hs-var">complete</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">t a -&gt; Bool
forall a. t a -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621679196730"><span class="hs-identifier hs-var">hs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-270"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196737"><span class="annot"><span class="annottext">reason :: HostName
</span><a href="#local-6989586621679196737"><span class="hs-identifier hs-var hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;received message not aligned with record boundary&quot;</span></span><span>
</span><span id="line-271"></span><span>                 </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO ()
forall {a}.
TLSError -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; IO a
</span><a href="#local-6989586621679196506"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Misc"><span class="hs-identifier hs-var">Error_Misc</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196737"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Fatal"><span class="hs-identifier hs-var">AlertLevel_Fatal</span></a></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196737"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span class="hs-comment">-- the other side could have close the connection already, so wrap</span><span>
</span><span id="line-274"></span><span class="hs-comment">-- this in a try and ignore all exceptions</span><span>
</span><span id="line-275"></span><span class="annot"><a href="Network.TLS.Core.html#tryBye"><span class="hs-identifier hs-type">tryBye</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span id="tryBye"><span class="annot"><span class="annottext">tryBye :: Context -&gt; IO ()
</span><a href="Network.TLS.Core.html#tryBye"><span class="hs-identifier hs-var hs-var">tryBye</span></a></span></span><span> </span><span id="local-6989586621679196738"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196738"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; (SomeException -&gt; IO ()) -&gt; IO ()
forall a. IO a -&gt; (SomeException -&gt; IO a) -&gt; IO a
</span><a href="Network.TLS.Util.html#catchException"><span class="hs-identifier hs-var">catchException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ()
</span><a href="Network.TLS.Core.html#bye"><span class="hs-identifier hs-var">bye</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196738"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span>
</span><span id="line-278"></span><span id="local-6989586621679196278"><span class="annot"><a href="Network.TLS.Core.html#onError"><span class="hs-identifier hs-type">onError</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621679196278"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#TLSError"><span class="hs-identifier hs-type">TLSError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#AlertLevel"><span class="hs-identifier hs-type">AlertLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#AlertDescription"><span class="hs-identifier hs-type">AlertDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679196278"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#TLSError"><span class="hs-identifier hs-type">TLSError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679196278"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">B.ByteString</span></span></span><span>
</span><span id="line-280"></span><span id="onError"><span class="annot"><span class="annottext">onError :: forall (m :: * -&gt; *).
Monad m =&gt;
(TLSError
 -&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; m ByteString)
-&gt; TLSError -&gt; m ByteString
</span><a href="Network.TLS.Core.html#onError"><span class="hs-identifier hs-var hs-var">onError</span></a></span></span><span> </span><span class="annot"><span class="annottext">TLSError
-&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; m ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TLSError
</span><a href="Network.TLS.Struct.html#Error_EOF"><span class="hs-identifier hs-var">Error_EOF</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- Not really an error.</span><span>
</span><span id="line-281"></span><span>            </span><span class="annot"><span class="annottext">ByteString -&gt; m ByteString
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-282"></span><span class="annot"><a href="Network.TLS.Core.html#onError"><span class="hs-identifier hs-var">onError</span></a></span><span> </span><span id="local-6989586621679196742"><span class="annot"><span class="annottext">TLSError
-&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; m ByteString
</span><a href="#local-6989586621679196742"><span class="hs-identifier hs-var">terminate</span></a></span></span><span> </span><span id="local-6989586621679196743"><span class="annot"><span class="annottext">TLSError
</span><a href="#local-6989586621679196743"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679196744"><span class="annot"><span class="annottext">AlertLevel
</span><a href="#local-6989586621679196744"><span class="hs-identifier hs-var">lvl</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679196745"><span class="annot"><span class="annottext">AlertDescription
</span><a href="#local-6989586621679196745"><span class="hs-identifier hs-var">ad</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; (AlertLevel, AlertDescription)
</span><a href="Network.TLS.Handshake.Common.html#errorToAlert"><span class="hs-identifier hs-var">errorToAlert</span></a></span><span> </span><span class="annot"><span class="annottext">TLSError
</span><a href="#local-6989586621679196743"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-283"></span><span>                        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TLSError
-&gt; AlertLevel -&gt; AlertDescription -&gt; HostName -&gt; m ByteString
</span><a href="#local-6989586621679196742"><span class="hs-identifier hs-var">terminate</span></a></span><span> </span><span class="annot"><span class="annottext">TLSError
</span><a href="#local-6989586621679196743"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">AlertLevel
</span><a href="#local-6989586621679196744"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="#local-6989586621679196745"><span class="hs-identifier hs-var">ad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TLSError -&gt; HostName
</span><a href="Network.TLS.Handshake.Common.html#errorToAlertMessage"><span class="hs-identifier hs-var">errorToAlertMessage</span></a></span><span> </span><span class="annot"><span class="annottext">TLSError
</span><a href="#local-6989586621679196743"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span id="local-6989586621679196296"><span class="annot"><a href="Network.TLS.Core.html#terminateWithWriteLock"><span class="hs-identifier hs-type">terminateWithWriteLock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#AlertLevel"><span class="hs-identifier hs-type">AlertLevel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#AlertDescription"><span class="hs-identifier hs-type">AlertDescription</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#TLSError"><span class="hs-identifier hs-type">TLSError</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#AlertLevel"><span class="hs-identifier hs-type">AlertLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#AlertDescription"><span class="hs-identifier hs-type">AlertDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679196296"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-287"></span><span id="terminateWithWriteLock"><span class="annot"><span class="annottext">terminateWithWriteLock :: forall a.
Context
-&gt; ([(AlertLevel, AlertDescription)] -&gt; IO ())
-&gt; TLSError
-&gt; AlertLevel
-&gt; AlertDescription
-&gt; HostName
-&gt; IO a
</span><a href="Network.TLS.Core.html#terminateWithWriteLock"><span class="hs-identifier hs-var hs-var">terminateWithWriteLock</span></a></span></span><span> </span><span id="local-6989586621679196755"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196755"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679196756"><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)] -&gt; IO ()
</span><a href="#local-6989586621679196756"><span class="hs-identifier hs-var">send</span></a></span></span><span> </span><span id="local-6989586621679196757"><span class="annot"><span class="annottext">TLSError
</span><a href="#local-6989586621679196757"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span id="local-6989586621679196758"><span class="annot"><span class="annottext">AlertLevel
</span><a href="#local-6989586621679196758"><span class="hs-identifier hs-var">level</span></a></span></span><span> </span><span id="local-6989586621679196759"><span class="annot"><span class="annottext">AlertDescription
</span><a href="#local-6989586621679196759"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621679196760"><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196760"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>    </span><span id="local-6989586621679196761"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679196761"><span class="hs-identifier hs-var">session</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Session -&gt; IO Session
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196755"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Session
</span><a href="Network.TLS.State.html#getSession"><span class="hs-identifier hs-var">getSession</span></a></span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-comment">-- Session manager is always invoked with read+write locks, so we merge this</span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-comment">-- with the alert packet being emitted.</span><span>
</span><span id="line-291"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; IO () -&gt; IO ()
forall a. Context -&gt; IO a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#withWriteLock"><span class="hs-identifier hs-var">withWriteLock</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196755"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-292"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679196761"><span class="hs-identifier hs-var">session</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-293"></span><span>            </span><span class="annot"><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier hs-var">Nothing</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>            </span><span class="annot"><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679196763"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196763"><span class="hs-identifier hs-var">sid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SessionManager -&gt; ByteString -&gt; IO ()
</span><a href="Network.TLS.Session.html#sessionInvalidate"><span class="hs-identifier hs-var">sessionInvalidate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shared -&gt; SessionManager
</span><a href="Network.TLS.Parameters.html#sharedSessionManager"><span class="hs-identifier hs-var">sharedSessionManager</span></a></span><span> </span><span class="annot"><span class="annottext">(Shared -&gt; SessionManager) -&gt; Shared -&gt; SessionManager
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Shared
</span><a href="Network.TLS.Context.Internal.html#ctxShared"><span class="hs-identifier hs-var">ctxShared</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196755"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196763"><span class="hs-identifier hs-var">sid</span></a></span><span>
</span><span id="line-295"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; (SomeException -&gt; IO ()) -&gt; IO ()
forall a. IO a -&gt; (SomeException -&gt; IO a) -&gt; IO a
</span><a href="Network.TLS.Util.html#catchException"><span class="hs-identifier hs-var">catchException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)] -&gt; IO ()
</span><a href="#local-6989586621679196756"><span class="hs-identifier hs-var">send</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AlertLevel
</span><a href="#local-6989586621679196758"><span class="hs-identifier hs-var">level</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="#local-6989586621679196759"><span class="hs-identifier hs-var">desc</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#setEOF"><span class="hs-identifier hs-var">setEOF</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196755"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span class="annot"><span class="annottext">TLSException -&gt; IO a
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">E.throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; HostName -&gt; TLSError -&gt; TLSException
</span><a href="Network.TLS.Struct.html#Terminated"><span class="hs-identifier hs-var">Terminated</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">HostName
</span><a href="#local-6989586621679196760"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="annot"><span class="annottext">TLSError
</span><a href="#local-6989586621679196757"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span>
</span><span id="line-300"></span><span class="hs-pragma">{-# DEPRECATED</span><span> </span><span class="hs-pragma">recvData'</span><span> </span><span class="hs-pragma">&quot;use recvData that returns strict bytestring&quot;</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-301"></span><span class="annot"><span class="hs-comment">-- | same as recvData but returns a lazy bytestring.</span></span><span>
</span><span id="line-302"></span><span id="local-6989586621679196353"><span class="annot"><a href="Network.TLS.Core.html#recvData%27"><span class="hs-identifier hs-type">recvData'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679196353"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679196353"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">L.ByteString</span></span></span><span>
</span><span id="line-303"></span><span id="recvData%27"><span class="annot"><span class="annottext">recvData' :: forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ByteString
</span><a href="Network.TLS.Core.html#recvData%27"><span class="hs-identifier hs-var hs-var">recvData'</span></a></span></span><span> </span><span id="local-6989586621679196774"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196774"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">L.fromChunks</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString)
-&gt; (ByteString -&gt; [ByteString]) -&gt; ByteString -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ByteString) -&gt; m ByteString -&gt; m ByteString
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; m ByteString
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ByteString
</span><a href="Network.TLS.Core.html#recvData"><span class="hs-identifier hs-var">recvData</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196774"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="annot"><a href="Network.TLS.Core.html#keyUpdate"><span class="hs-identifier hs-type">keyUpdate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-306"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Crypto.html#Hash"><span class="hs-identifier hs-type">Hash</span></a></span><span class="hs-special">,</span><span class="annot"><a href="Network.TLS.Cipher.html#Cipher"><span class="hs-identifier hs-type">Cipher</span></a></span><span class="hs-special">,</span><span class="annot"><a href="Network.TLS.Record.State.html#CryptLevel"><span class="hs-identifier hs-type">CryptLevel</span></a></span><span class="hs-special">,</span><span class="annot"><span class="hs-identifier hs-type">C8.ByteString</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Crypto.html#Hash"><span class="hs-identifier hs-type">Hash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Cipher.html#Cipher"><span class="hs-identifier hs-type">Cipher</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#AnyTrafficSecret"><span class="hs-identifier hs-type">AnyTrafficSecret</span></a></span><span> </span><span class="annot"><a href="Network.TLS.Types.html#ApplicationSecret"><span class="hs-identifier hs-type">ApplicationSecret</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span id="keyUpdate"><span class="annot"><span class="annottext">keyUpdate :: Context
-&gt; (Context -&gt; IO (Hash, Cipher, CryptLevel, ByteString))
-&gt; (Context
    -&gt; Hash -&gt; Cipher -&gt; AnyTrafficSecret ApplicationSecret -&gt; IO ())
-&gt; IO ()
</span><a href="Network.TLS.Core.html#keyUpdate"><span class="hs-identifier hs-var hs-var">keyUpdate</span></a></span></span><span> </span><span id="local-6989586621679196777"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196777"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679196778"><span class="annot"><span class="annottext">Context -&gt; IO (Hash, Cipher, CryptLevel, ByteString)
</span><a href="#local-6989586621679196778"><span class="hs-identifier hs-var">getState</span></a></span></span><span> </span><span id="local-6989586621679196779"><span class="annot"><span class="annottext">Context
-&gt; Hash -&gt; Cipher -&gt; AnyTrafficSecret ApplicationSecret -&gt; IO ()
</span><a href="#local-6989586621679196779"><span class="hs-identifier hs-var">setState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679196780"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679196780"><span class="hs-identifier hs-var">usedHash</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679196781"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679196781"><span class="hs-identifier hs-var">usedCipher</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679196782"><span class="annot"><span class="annottext">CryptLevel
</span><a href="#local-6989586621679196782"><span class="hs-identifier hs-var">level</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679196783"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196783"><span class="hs-identifier hs-var">applicationSecretN</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO (Hash, Cipher, CryptLevel, ByteString)
</span><a href="#local-6989586621679196778"><span class="hs-identifier hs-var">getState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196777"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-311"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CryptLevel
</span><a href="#local-6989586621679196782"><span class="hs-identifier hs-var">level</span></a></span><span> </span><span class="annot"><span class="annottext">CryptLevel -&gt; CryptLevel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CryptLevel
</span><a href="Network.TLS.Record.State.html#CryptApplicationSecret"><span class="hs-identifier hs-var">CryptApplicationSecret</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-312"></span><span>        </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HostName, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HostName
</span><span class="hs-string">&quot;tried key update without application traffic secret&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#InternalError"><span class="hs-identifier hs-var">InternalError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196788"><span class="annot"><span class="annottext">applicationSecretN1 :: ByteString
</span><a href="#local-6989586621679196788"><span class="hs-identifier hs-var hs-var">applicationSecretN1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; ByteString -&gt; ByteString -&gt; ByteString -&gt; Int -&gt; ByteString
</span><a href="Network.TLS.KeySchedule.html#hkdfExpandLabel"><span class="hs-identifier hs-var">hkdfExpandLabel</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679196780"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196783"><span class="hs-identifier hs-var">applicationSecretN</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;traffic upd&quot;</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; ByteString) -&gt; Int -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Int
</span><a href="Network.TLS.Crypto.html#hashDigestSize"><span class="hs-identifier hs-var">hashDigestSize</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679196780"><span class="hs-identifier hs-var">usedHash</span></a></span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><span class="annottext">Context
-&gt; Hash -&gt; Cipher -&gt; AnyTrafficSecret ApplicationSecret -&gt; IO ()
</span><a href="#local-6989586621679196779"><span class="hs-identifier hs-var">setState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196777"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679196780"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679196781"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; AnyTrafficSecret ApplicationSecret
forall a. ByteString -&gt; AnyTrafficSecret a
</span><a href="Network.TLS.Types.html#AnyTrafficSecret"><span class="hs-identifier hs-var">AnyTrafficSecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679196788"><span class="hs-identifier hs-var">applicationSecretN1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span class="annot"><span class="hs-comment">-- | How to update keys in TLS 1.3</span></span><span>
</span><span id="line-317"></span><span class="hs-keyword">data</span><span> </span><span id="KeyUpdateRequest"><span class="annot"><a href="Network.TLS.Core.html#KeyUpdateRequest"><span class="hs-identifier hs-var">KeyUpdateRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="OneWay"><span class="annot"><a href="Network.TLS.Core.html#OneWay"><span class="hs-identifier hs-var">OneWay</span></a></span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Unidirectional key update</span></span><span>
</span><span id="line-318"></span><span>                      </span><span class="hs-glyph">|</span><span> </span><span id="TwoWay"><span class="annot"><a href="Network.TLS.Core.html#TwoWay"><span class="hs-identifier hs-var">TwoWay</span></a></span></span><span> </span><span class="annot"><span class="hs-comment">-- ^ Bidirectional key update (normal case)</span></span><span>
</span><span id="line-319"></span><span>                      </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679196795"><span id="local-6989586621679196797"><span class="annot"><span class="annottext">KeyUpdateRequest -&gt; KeyUpdateRequest -&gt; Bool
(KeyUpdateRequest -&gt; KeyUpdateRequest -&gt; Bool)
-&gt; (KeyUpdateRequest -&gt; KeyUpdateRequest -&gt; Bool)
-&gt; Eq KeyUpdateRequest
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
$c== :: KeyUpdateRequest -&gt; KeyUpdateRequest -&gt; Bool
== :: KeyUpdateRequest -&gt; KeyUpdateRequest -&gt; Bool
$c/= :: KeyUpdateRequest -&gt; KeyUpdateRequest -&gt; Bool
/= :: KeyUpdateRequest -&gt; KeyUpdateRequest -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679196802"><span id="local-6989586621679196804"><span id="local-6989586621679196808"><span class="annot"><span class="annottext">Int -&gt; KeyUpdateRequest -&gt; HostName -&gt; HostName
[KeyUpdateRequest] -&gt; HostName -&gt; HostName
KeyUpdateRequest -&gt; HostName
(Int -&gt; KeyUpdateRequest -&gt; HostName -&gt; HostName)
-&gt; (KeyUpdateRequest -&gt; HostName)
-&gt; ([KeyUpdateRequest] -&gt; HostName -&gt; HostName)
-&gt; Show KeyUpdateRequest
forall a.
(Int -&gt; a -&gt; HostName -&gt; HostName)
-&gt; (a -&gt; HostName) -&gt; ([a] -&gt; HostName -&gt; HostName) -&gt; Show a
$cshowsPrec :: Int -&gt; KeyUpdateRequest -&gt; HostName -&gt; HostName
showsPrec :: Int -&gt; KeyUpdateRequest -&gt; HostName -&gt; HostName
$cshow :: KeyUpdateRequest -&gt; HostName
show :: KeyUpdateRequest -&gt; HostName
$cshowList :: [KeyUpdateRequest] -&gt; HostName -&gt; HostName
showList :: [KeyUpdateRequest] -&gt; HostName -&gt; HostName
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span class="hs-comment">-- | Updating appication traffic secrets for TLS 1.3.</span><span>
</span><span id="line-322"></span><span class="hs-comment">--   If this API is called for TLS 1.3, 'True' is returned.</span><span>
</span><span id="line-323"></span><span class="hs-comment">--   Otherwise, 'False' is returned.</span><span>
</span><span id="line-324"></span><span id="local-6989586621679196361"><span class="annot"><a href="Network.TLS.Core.html#updateKey"><span class="hs-identifier hs-type">updateKey</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679196361"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Core.html#KeyUpdateRequest"><span class="hs-identifier hs-type">KeyUpdateRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679196361"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-325"></span><span id="updateKey"><span class="annot"><span class="annottext">updateKey :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; KeyUpdateRequest -&gt; m Bool
</span><a href="Network.TLS.Core.html#updateKey"><span class="hs-identifier hs-var hs-var">updateKey</span></a></span></span><span> </span><span id="local-6989586621679196821"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196821"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679196822"><span class="annot"><span class="annottext">KeyUpdateRequest
</span><a href="#local-6989586621679196822"><span class="hs-identifier hs-var">way</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Bool -&gt; m Bool
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Bool -&gt; m Bool) -&gt; IO Bool -&gt; m Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-326"></span><span>    </span><span id="local-6989586621679196823"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196823"><span class="hs-identifier hs-var">tls13</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Bool
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m Bool
</span><a href="Network.TLS.Context.Internal.html#tls13orLater"><span class="hs-identifier hs-var">tls13orLater</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196821"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196823"><span class="hs-identifier hs-var">tls13</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679196824"><span class="annot"><span class="annottext">req :: KeyUpdate
</span><a href="#local-6989586621679196824"><span class="hs-identifier hs-var hs-var">req</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">KeyUpdateRequest
</span><a href="#local-6989586621679196822"><span class="hs-identifier hs-var">way</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-329"></span><span>                </span><span class="annot"><span class="annottext">KeyUpdateRequest
</span><a href="Network.TLS.Core.html#OneWay"><span class="hs-identifier hs-var">OneWay</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">KeyUpdate
</span><a href="Network.TLS.Struct13.html#UpdateNotRequested"><span class="hs-identifier hs-var">UpdateNotRequested</span></a></span><span>
</span><span id="line-330"></span><span>                </span><span class="annot"><span class="annottext">KeyUpdateRequest
</span><a href="Network.TLS.Core.html#TwoWay"><span class="hs-identifier hs-var">TwoWay</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">KeyUpdate
</span><a href="Network.TLS.Struct13.html#UpdateRequested"><span class="hs-identifier hs-var">UpdateRequested</span></a></span><span>
</span><span id="line-331"></span><span>        </span><span class="hs-comment">-- Write lock wraps both actions because we don't want another packet to</span><span>
</span><span id="line-332"></span><span>        </span><span class="hs-comment">-- be sent by another thread before the Tx state is updated.</span><span>
</span><span id="line-333"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; IO () -&gt; IO ()
forall a. Context -&gt; IO a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#withWriteLock"><span class="hs-identifier hs-var">withWriteLock</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196821"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-334"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Packet13 -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket13"><span class="hs-identifier hs-var">sendPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196821"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet13 -&gt; IO ()) -&gt; Packet13 -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">KeyUpdate -&gt; Handshake13
</span><a href="Network.TLS.Struct13.html#KeyUpdate13"><span class="hs-identifier hs-var">KeyUpdate13</span></a></span><span> </span><span class="annot"><span class="annottext">KeyUpdate
</span><a href="#local-6989586621679196824"><span class="hs-identifier hs-var">req</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-335"></span><span>            </span><span class="annot"><span class="annottext">Context
-&gt; (Context -&gt; IO (Hash, Cipher, CryptLevel, ByteString))
-&gt; (Context
    -&gt; Hash -&gt; Cipher -&gt; AnyTrafficSecret ApplicationSecret -&gt; IO ())
-&gt; IO ()
</span><a href="Network.TLS.Core.html#keyUpdate"><span class="hs-identifier hs-var">keyUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679196821"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO (Hash, Cipher, CryptLevel, ByteString)
</span><a href="Network.TLS.Handshake.State13.html#getTxState"><span class="hs-identifier hs-var">getTxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; Hash -&gt; Cipher -&gt; AnyTrafficSecret ApplicationSecret -&gt; IO ()
forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setTxState"><span class="hs-identifier hs-var">setTxState</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO Bool
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679196823"><span class="hs-identifier hs-var">tls13</span></a></span><span>
</span><span id="line-337"></span></pre></body></html>