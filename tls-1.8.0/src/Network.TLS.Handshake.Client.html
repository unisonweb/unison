<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- Module      : Network.TLS.Handshake.Client</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- License     : BSD-style</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- Maintainer  : Vincent Hanquez &lt;vincent@snarc.org&gt;</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Stability   : experimental</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- Portability : unknown</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Network.TLS.Handshake.Client</span><span>
</span><span id="line-11"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Client.html#handshakeClient"><span class="hs-identifier">handshakeClient</span></a></span><span>
</span><span id="line-12"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Client.html#handshakeClientWith"><span class="hs-identifier">handshakeClientWith</span></a></span><span>
</span><span id="line-13"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Client.html#postHandshakeAuthClientWith"><span class="hs-identifier">postHandshakeAuthClientWith</span></a></span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Crypto.html"><span class="hs-identifier">Network.TLS.Crypto</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html"><span class="hs-identifier">Network.TLS.Context.Internal</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html"><span class="hs-identifier">Network.TLS.Parameters</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html"><span class="hs-identifier">Network.TLS.Struct</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Struct13.html"><span class="hs-identifier">Network.TLS.Struct13</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Cipher.html"><span class="hs-identifier">Network.TLS.Cipher</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Compression.html"><span class="hs-identifier">Network.TLS.Compression</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html"><span class="hs-identifier">Network.TLS.Credentials</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Packet.html"><span class="hs-identifier">Network.TLS.Packet</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Packet.html#getExtensions"><span class="hs-identifier">getExtensions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.ErrT.html"><span class="hs-identifier">Network.TLS.ErrT</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Extension.html"><span class="hs-identifier">Network.TLS.Extension</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.IO.html"><span class="hs-identifier">Network.TLS.IO</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Imports.html"><span class="hs-identifier">Network.TLS.Imports</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.State.html"><span class="hs-identifier">Network.TLS.State</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Measurement.html"><span class="hs-identifier">Network.TLS.Measurement</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Util.html"><span class="hs-identifier">Network.TLS.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Util.html#bytesEq"><span class="hs-identifier">bytesEq</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Util.html#catchException"><span class="hs-identifier">catchException</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Util.html#fromJust"><span class="hs-identifier">fromJust</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Util.html#mapChunks_"><span class="hs-identifier">mapChunks_</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Types.html"><span class="hs-identifier">Network.TLS.Types</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.X509.html"><span class="hs-identifier">Network.TLS.X509</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">B</span></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.X509</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ExtKeyUsageFlag</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Strict</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">SomeException</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">bracket</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Certificate.html"><span class="hs-identifier">Network.TLS.Handshake.Certificate</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Common.html"><span class="hs-identifier">Network.TLS.Handshake.Common</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Common13.html"><span class="hs-identifier">Network.TLS.Handshake.Common13</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Control.html"><span class="hs-identifier">Network.TLS.Handshake.Control</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Key.html"><span class="hs-identifier">Network.TLS.Handshake.Key</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Process.html"><span class="hs-identifier">Network.TLS.Handshake.Process</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Random.html"><span class="hs-identifier">Network.TLS.Handshake.Random</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Signature.html"><span class="hs-identifier">Network.TLS.Handshake.Signature</span></a></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.State.html"><span class="hs-identifier">Network.TLS.Handshake.State</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.State13.html"><span class="hs-identifier">Network.TLS.Handshake.State13</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Network.TLS.Wire.html"><span class="hs-identifier">Network.TLS.Wire</span></a></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#handshakeClientWith"><span class="hs-identifier hs-type">handshakeClientWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ClientParams"><span class="hs-identifier hs-type">ClientParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span id="handshakeClientWith"><span class="annot"><span class="annottext">handshakeClientWith :: ClientParams -&gt; Context -&gt; Handshake -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#handshakeClientWith"><span class="hs-identifier hs-var hs-var">handshakeClientWith</span></a></span></span><span> </span><span id="local-6989586621679194336"><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194336"><span class="hs-identifier hs-var">cparams</span></a></span></span><span> </span><span id="local-6989586621679194337"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194337"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="Network.TLS.Struct.html#HelloRequest"><span class="hs-identifier hs-var">HelloRequest</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#handshakeClient"><span class="hs-identifier hs-var">handshakeClient</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194336"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194337"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-54"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#handshakeClientWith"><span class="hs-identifier hs-var">handshakeClientWith</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><span class="hs-identifier">_</span></span><span>       </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span>   </span><span class="annot"><span class="annottext">Handshake
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unexpected handshake message received in handshakeClientWith&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-comment">-- client part of handshake. send a bunch of handshake of client</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- values intertwined with response from the server.</span><span>
</span><span id="line-58"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#handshakeClient"><span class="hs-identifier hs-type">handshakeClient</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ClientParams"><span class="hs-identifier hs-type">ClientParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span id="handshakeClient"><span class="annot"><span class="annottext">handshakeClient :: ClientParams -&gt; Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#handshakeClient"><span class="hs-identifier hs-var hs-var">handshakeClient</span></a></span></span><span> </span><span id="local-6989586621679194342"><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194342"><span class="hs-identifier hs-var">cparams</span></a></span></span><span> </span><span id="local-6989586621679194343"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194343"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-60"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194345"><span class="annot"><span class="annottext">groups :: [Group]
</span><a href="#local-6989586621679194345"><span class="hs-identifier hs-var hs-var">groups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Maybe (ByteString, SessionData)
</span><a href="Network.TLS.Parameters.html#clientWantSessionResume"><span class="hs-identifier hs-var">clientWantSessionResume</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194342"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-61"></span><span>              </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679194347"><span class="hs-identifier hs-var">groupsSupported</span></a></span><span>
</span><span id="line-62"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194348"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194348"><span class="hs-identifier hs-var">sdata</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Maybe Group
</span><a href="Network.TLS.Types.html#sessionGroup"><span class="hs-identifier hs-var">sessionGroup</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194348"><span class="hs-identifier hs-var">sdata</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-63"></span><span>                  </span><span class="annot"><span class="annottext">Maybe Group
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- TLS 1.2 or earlier</span><span>
</span><span id="line-64"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679194350"><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679194350"><span class="hs-identifier hs-var">grp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679194350"><span class="hs-identifier hs-var">grp</span></a></span><span> </span><span class="annot"><span class="annottext">Group -&gt; [Group] -&gt; [Group]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(Group -&gt; Bool) -&gt; [Group] -&gt; [Group]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Group -&gt; Group -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679194350"><span class="hs-identifier hs-var">grp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679194347"><span class="hs-identifier hs-var">groupsSupported</span></a></span><span>
</span><span id="line-65"></span><span>        </span><span id="local-6989586621679194347"><span class="annot"><span class="annottext">groupsSupported :: [Group]
</span><a href="#local-6989586621679194347"><span class="hs-identifier hs-var hs-var">groupsSupported</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Group]
</span><a href="Network.TLS.Parameters.html#supportedGroups"><span class="hs-identifier hs-var">supportedGroups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194343"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><span class="annottext">ClientParams
-&gt; Context
-&gt; [Group]
-&gt; Maybe (ClientRandom, Session, Version)
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#handshakeClient%27"><span class="hs-identifier hs-var">handshakeClient'</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194342"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194343"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679194345"><span class="hs-identifier hs-var">groups</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ClientRandom, Session, Version)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-comment">-- https://tools.ietf.org/html/rfc8446#section-4.1.2 says:</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- &quot;The client will also send a</span><span>
</span><span id="line-70"></span><span class="hs-comment">--  ClientHello when the server has responded to its ClientHello with a</span><span>
</span><span id="line-71"></span><span class="hs-comment">--  HelloRetryRequest.  In that case, the client MUST send the same</span><span>
</span><span id="line-72"></span><span class="hs-comment">--  ClientHello without modification, except as follows:&quot;</span><span>
</span><span id="line-73"></span><span class="hs-comment">--</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- So, the ClientRandom in the first client hello is necessary.</span><span>
</span><span id="line-75"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#handshakeClient%27"><span class="hs-identifier hs-type">handshakeClient'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ClientParams"><span class="hs-identifier hs-type">ClientParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Crypto.Types.html#Group"><span class="hs-identifier hs-type">Group</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#ClientRandom"><span class="hs-identifier hs-type">ClientRandom</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#Version"><span class="hs-identifier hs-type">Version</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span id="handshakeClient%27"><span class="annot"><span class="annottext">handshakeClient' :: ClientParams
-&gt; Context
-&gt; [Group]
-&gt; Maybe (ClientRandom, Session, Version)
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#handshakeClient%27"><span class="hs-identifier hs-var hs-var">handshakeClient'</span></a></span></span><span> </span><span id="local-6989586621679194355"><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span></span><span> </span><span id="local-6989586621679194356"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679194357"><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679194357"><span class="hs-identifier hs-var">groups</span></a></span></span><span> </span><span id="local-6989586621679194358"><span class="annot"><span class="annottext">Maybe (ClientRandom, Session, Version)
</span><a href="#local-6989586621679194358"><span class="hs-identifier hs-var">mparams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; (Measurement -&gt; Measurement) -&gt; IO ()
</span><a href="Network.TLS.Context.Internal.html#updateMeasure"><span class="hs-identifier hs-var">updateMeasure</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Measurement -&gt; Measurement
</span><a href="Network.TLS.Measurement.html#incrementNbHandshakes"><span class="hs-identifier hs-var">incrementNbHandshakes</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679194361"><span class="annot"><span class="annottext">ClientRandom
</span><a href="#local-6989586621679194361"><span class="hs-identifier hs-var">crand</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194362"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194362"><span class="hs-identifier hs-var">clientSession</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (ClientRandom, Session)
</span><a href="#local-6989586621679194363"><span class="hs-identifier hs-var">generateClientHelloParams</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679194364"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194364"><span class="hs-identifier hs-var">rtt0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194365"><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679194365"><span class="hs-identifier hs-var">sentExtensions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Session -&gt; ClientRandom -&gt; IO (Bool, [ExtensionID])
</span><a href="#local-6989586621679194366"><span class="hs-identifier hs-var">sendClientHello</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194362"><span class="hs-identifier hs-var">clientSession</span></a></span><span> </span><span class="annot"><span class="annottext">ClientRandom
</span><a href="#local-6989586621679194361"><span class="hs-identifier hs-var">crand</span></a></span><span>
</span><span id="line-80"></span><span>    </span><span class="annot"><span class="annottext">Session -&gt; [ExtensionID] -&gt; IO ()
</span><a href="#local-6989586621679194367"><span class="hs-identifier hs-var">recvServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194362"><span class="hs-identifier hs-var">clientSession</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679194365"><span class="hs-identifier hs-var">sentExtensions</span></a></span><span>
</span><span id="line-81"></span><span>    </span><span id="local-6989586621679194368"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194368"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Version -&gt; IO Version
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
-&gt; ((ClientRandom, Session, Version) -&gt; Bool)
-&gt; Maybe (ClientRandom, Session, Version)
-&gt; Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientRandom
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Session
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194373"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194373"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194373"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194368"><span class="hs-identifier hs-var">ver</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (ClientRandom, Session, Version)
</span><a href="#local-6989586621679194358"><span class="hs-identifier hs-var">mparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-83"></span><span>        </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;version changed after hello retry&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-comment">-- recvServerHello sets TLS13HRR according to the server random.</span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-comment">-- For 1st server hello, getTLS13HR returns True if it is HRR and False otherwise.</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-comment">-- For 2nd server hello, getTLS13HR returns False since it is NOT HRR.</span><span>
</span><span id="line-87"></span><span>    </span><span id="local-6989586621679194375"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194375"><span class="hs-identifier hs-var">hrr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Bool -&gt; IO Bool
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Bool
</span><a href="Network.TLS.State.html#getTLS13HRR"><span class="hs-identifier hs-var">getTLS13HRR</span></a></span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194368"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS13"><span class="hs-identifier hs-var">TLS13</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-89"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194375"><span class="hs-identifier hs-var">hrr</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Group] -&gt; [Group]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679194357"><span class="hs-identifier hs-var">groups</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-90"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;group is exhausted in the client side&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>            </span><span id="local-6989586621679194379"><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679194379"><span class="hs-identifier hs-var">groups'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-92"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (ClientRandom, Session, Version) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ClientRandom, Session, Version)
</span><a href="#local-6989586621679194358"><span class="hs-identifier hs-var">mparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-93"></span><span>                    </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server sent too many hello retries&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>                </span><span id="local-6989586621679194383"><span class="annot"><span class="annottext">Maybe KeyShare
</span><a href="#local-6989586621679194383"><span class="hs-identifier hs-var">mks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt (Maybe KeyShare) -&gt; IO (Maybe KeyShare)
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt (Maybe KeyShare)
</span><a href="Network.TLS.State.html#getTLS13KeyShare"><span class="hs-identifier hs-var">getTLS13KeyShare</span></a></span><span>
</span><span id="line-95"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe KeyShare
</span><a href="#local-6989586621679194383"><span class="hs-identifier hs-var">mks</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-96"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#KeyShareHRR"><span class="hs-identifier hs-type">KeyShareHRR</span></a></span><span> </span><span id="local-6989586621679194386"><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679194386"><span class="hs-identifier hs-var">selectedGroup</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679194386"><span class="hs-identifier hs-var">selectedGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Group -&gt; [Group] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679194379"><span class="hs-identifier hs-var">groups'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-98"></span><span>                          </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13 -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13HandshakeMode"><span class="hs-identifier hs-var">setTLS13HandshakeMode</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13
</span><a href="Network.TLS.Handshake.State.html#HelloRetryRequest"><span class="hs-identifier hs-var">HelloRetryRequest</span></a></span><span>
</span><span id="line-99"></span><span>                          </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#clearTxState"><span class="hs-identifier hs-var">clearTxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-100"></span><span>                          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194392"><span class="annot"><span class="annottext">cparams' :: ClientParams
</span><a href="#local-6989586621679194392"><span class="hs-identifier hs-var hs-var">cparams'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#clientEarlyData"><span class="hs-identifier hs-var">clientEarlyData</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nothing</span></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-101"></span><span>                          </span><span class="annot"><span class="annottext">Context -&gt; (forall {b}. Monoid b =&gt; PacketFlightM b ()) -&gt; IO ()
forall a.
Context -&gt; (forall b. Monoid b =&gt; PacketFlightM b a) -&gt; IO a
</span><a href="Network.TLS.IO.html#runPacketFlight"><span class="hs-identifier hs-var">runPacketFlight</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {b}. Monoid b =&gt; PacketFlightM b ()) -&gt; IO ())
-&gt; (forall {b}. Monoid b =&gt; PacketFlightM b ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; PacketFlightM b ()
forall b. Monoid b =&gt; Context -&gt; PacketFlightM b ()
</span><a href="Network.TLS.Handshake.Common13.html#sendChangeCipherSpec13"><span class="hs-identifier hs-var">sendChangeCipherSpec13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-102"></span><span>                          </span><span class="annot"><span class="annottext">ClientParams
-&gt; Context
-&gt; [Group]
-&gt; Maybe (ClientRandom, Session, Version)
-&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#handshakeClient%27"><span class="hs-identifier hs-var">handshakeClient'</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194392"><span class="hs-identifier hs-var">cparams'</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679194386"><span class="hs-identifier hs-var">selectedGroup</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ClientRandom, Session, Version)
-&gt; Maybe (ClientRandom, Session, Version)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientRandom
</span><a href="#local-6989586621679194361"><span class="hs-identifier hs-var">crand</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194362"><span class="hs-identifier hs-var">clientSession</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194368"><span class="hs-identifier hs-var">ver</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server-selected group is not supported&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">KeyShare
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;handshakeClient': invalid KeyShare value&quot;</span></span><span>
</span><span id="line-105"></span><span>                  </span><span class="annot"><span class="annottext">Maybe KeyShare
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;key exchange not implemented in HRR, expected key_share extension&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-107"></span><span>            </span><span class="annot"><span class="annottext">ClientParams -&gt; Context -&gt; Maybe Group -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#handshakeClient13"><span class="hs-identifier hs-var">handshakeClient13</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679194400"><span class="hs-identifier hs-var">groupToSend</span></a></span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-109"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194364"><span class="hs-identifier hs-var">rtt0</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-110"></span><span>            </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server denied TLS 1.3 when connecting with early data&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>        </span><span id="local-6989586621679194401"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194401"><span class="hs-identifier hs-var">sessionResuming</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Bool -&gt; IO Bool
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Bool
</span><a href="Network.TLS.State.html#isSessionResuming"><span class="hs-identifier hs-var">isSessionResuming</span></a></span><span>
</span><span id="line-112"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194401"><span class="hs-identifier hs-var">sessionResuming</span></a></span><span>
</span><span id="line-113"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Role -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common.html#sendChangeCipherAndFinish"><span class="hs-identifier hs-var">sendChangeCipherAndFinish</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ClientRole"><span class="hs-identifier hs-var">ClientRole</span></a></span><span>
</span><span id="line-114"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#sendClientData"><span class="hs-identifier hs-var">sendClientData</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-115"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; Role -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common.html#sendChangeCipherAndFinish"><span class="hs-identifier hs-var">sendChangeCipherAndFinish</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ClientRole"><span class="hs-identifier hs-var">ClientRole</span></a></span><span>
</span><span id="line-116"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common.html#recvChangeCipherAndFinish"><span class="hs-identifier hs-var">recvChangeCipherAndFinish</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-117"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common.html#handshakeTerminate"><span class="hs-identifier hs-var">handshakeTerminate</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679194408"><span class="annot"><span class="annottext">ciphers :: [Cipher]
</span><a href="#local-6989586621679194408"><span class="hs-identifier hs-var hs-var">ciphers</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Cipher]
</span><a href="Network.TLS.Parameters.html#supportedCiphers"><span class="hs-identifier hs-var">supportedCiphers</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [Cipher]) -&gt; Supported -&gt; [Cipher]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-119"></span><span>        </span><span id="local-6989586621679194410"><span class="annot"><span class="annottext">compressions :: [Compression]
</span><a href="#local-6989586621679194410"><span class="hs-identifier hs-var hs-var">compressions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Compression]
</span><a href="Network.TLS.Parameters.html#supportedCompressions"><span class="hs-identifier hs-var">supportedCompressions</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [Compression]) -&gt; Supported -&gt; [Compression]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-120"></span><span>        </span><span id="local-6989586621679194414"><span class="annot"><span class="annottext">highestVer :: Version
</span><a href="#local-6989586621679194414"><span class="hs-identifier hs-var hs-var">highestVer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Version] -&gt; Version
forall a. Ord a =&gt; [a] -&gt; a
forall (t :: * -&gt; *) a. (Foldable t, Ord a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">maximum</span></span><span> </span><span class="annot"><span class="annottext">([Version] -&gt; Version) -&gt; [Version] -&gt; Version
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Version]
</span><a href="Network.TLS.Parameters.html#supportedVersions"><span class="hs-identifier hs-var">supportedVersions</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [Version]) -&gt; Supported -&gt; [Version]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-121"></span><span>        </span><span id="local-6989586621679194418"><span class="annot"><span class="annottext">tls13 :: Bool
</span><a href="#local-6989586621679194418"><span class="hs-identifier hs-var hs-var">tls13</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194414"><span class="hs-identifier hs-var">highestVer</span></a></span><span> </span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS13"><span class="hs-identifier hs-var">TLS13</span></a></span><span>
</span><span id="line-122"></span><span>        </span><span id="local-6989586621679194419"><span class="annot"><span class="annottext">ems :: EMSMode
</span><a href="#local-6989586621679194419"><span class="hs-identifier hs-var hs-var">ems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; EMSMode
</span><a href="Network.TLS.Parameters.html#supportedExtendedMasterSec"><span class="hs-identifier hs-var">supportedExtendedMasterSec</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; EMSMode) -&gt; Supported -&gt; EMSMode
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-123"></span><span>        </span><span id="local-6989586621679194400"><span class="annot"><span class="annottext">groupToSend :: Maybe Group
</span><a href="#local-6989586621679194400"><span class="hs-identifier hs-var hs-var">groupToSend</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Group] -&gt; Maybe Group
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679194357"><span class="hs-identifier hs-var">groups</span></a></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span>        </span><span class="hs-comment">-- List of extensions to send in ClientHello, ordered such that we never</span><span>
</span><span id="line-126"></span><span>        </span><span class="hs-comment">-- terminate with a zero-length extension.  Some buggy implementations</span><span>
</span><span id="line-127"></span><span>        </span><span class="hs-comment">-- are allergic to an extension with empty data at final position.</span><span>
</span><span id="line-128"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-129"></span><span>        </span><span class="hs-comment">-- Without TLS 1.3, the list ends with extension &quot;signature_algorithms&quot;</span><span>
</span><span id="line-130"></span><span>        </span><span class="hs-comment">-- with length &gt;= 2 bytes.  When TLS 1.3 is enabled, extensions</span><span>
</span><span id="line-131"></span><span>        </span><span class="hs-comment">-- &quot;psk_key_exchange_modes&quot; (currently always sent) and &quot;pre_shared_key&quot;</span><span>
</span><span id="line-132"></span><span>        </span><span class="hs-comment">-- (not always present) have length &gt; 0.</span><span>
</span><span id="line-133"></span><span>        </span><span id="local-6989586621679194427"><span class="annot"><span class="annottext">getExtensions :: Maybe (ByteString, b, CipherChoice, Word32)
-&gt; Bool -&gt; IO [Maybe ExtensionRaw]
</span><a href="#local-6989586621679194427"><span class="hs-identifier hs-var hs-var">getExtensions</span></a></span></span><span> </span><span id="local-6989586621679194428"><span class="annot"><span class="annottext">Maybe (ByteString, b, CipherChoice, Word32)
</span><a href="#local-6989586621679194428"><span class="hs-identifier hs-var">pskInfo</span></a></span></span><span> </span><span id="local-6989586621679194429"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194429"><span class="hs-identifier hs-var">rtt0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[IO (Maybe ExtensionRaw)] -&gt; IO [Maybe ExtensionRaw]
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Traversable t, Monad m) =&gt;
t (m a) -&gt; m (t a)
forall (m :: * -&gt; *) a. Monad m =&gt; [m a] -&gt; m [a]
</span><span class="hs-identifier hs-var">sequence</span></span><span>
</span><span id="line-134"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194431"><span class="hs-identifier hs-var">sniExtension</span></a></span><span>
</span><span id="line-135"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194432"><span class="hs-identifier hs-var">secureReneg</span></a></span><span>
</span><span id="line-136"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194433"><span class="hs-identifier hs-var">alpnExtension</span></a></span><span>
</span><span id="line-137"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194434"><span class="hs-identifier hs-var">emsExtension</span></a></span><span>
</span><span id="line-138"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194435"><span class="hs-identifier hs-var">groupExtension</span></a></span><span>
</span><span id="line-139"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194436"><span class="hs-identifier hs-var">ecPointExtension</span></a></span><span>
</span><span id="line-140"></span><span>            </span><span class="hs-comment">--, sessionTicketExtension</span><span>
</span><span id="line-141"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194437"><span class="hs-identifier hs-var">signatureAlgExtension</span></a></span><span>
</span><span id="line-142"></span><span>            </span><span class="hs-comment">--, heartbeatExtension</span><span>
</span><span id="line-143"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194438"><span class="hs-identifier hs-var">versionExtension</span></a></span><span>
</span><span id="line-144"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IO (Maybe ExtensionRaw)
forall {m :: * -&gt; *}. Monad m =&gt; Bool -&gt; m (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194439"><span class="hs-identifier hs-var">earlyDataExtension</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194429"><span class="hs-identifier hs-var">rtt0</span></a></span><span>
</span><span id="line-145"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194440"><span class="hs-identifier hs-var">keyshareExtension</span></a></span><span>
</span><span id="line-146"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194441"><span class="hs-identifier hs-var">cookieExtension</span></a></span><span>
</span><span id="line-147"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194442"><span class="hs-identifier hs-var">postHandshakeAuthExtension</span></a></span><span>
</span><span id="line-148"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194443"><span class="hs-identifier hs-var">pskExchangeModeExtension</span></a></span><span>
</span><span id="line-149"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, b, CipherChoice, Word32)
-&gt; IO (Maybe ExtensionRaw)
forall {m :: * -&gt; *} {b}.
Monad m =&gt;
Maybe (ByteString, b, CipherChoice, Word32)
-&gt; m (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194444"><span class="hs-identifier hs-var">preSharedKeyExtension</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, b, CipherChoice, Word32)
</span><a href="#local-6989586621679194428"><span class="hs-identifier hs-var">pskInfo</span></a></span><span> </span><span class="hs-comment">-- MUST be last (RFC 8446)</span><span>
</span><span id="line-150"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span>        </span><span id="local-6989586621679193822"><span class="annot"><a href="#local-6989586621679194445"><span class="hs-identifier hs-type">toExtensionRaw</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Extension.html#Extension"><span class="hs-identifier hs-type">Extension</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679193822"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679193822"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span></span><span>
</span><span id="line-153"></span><span>        </span><span id="local-6989586621679194445"><span class="annot"><span class="annottext">toExtensionRaw :: forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var hs-var">toExtensionRaw</span></a></span></span><span> </span><span id="local-6989586621679194449"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679194449"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">e -&gt; ExtensionID
forall a. Extension a =&gt; a -&gt; ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID"><span class="hs-identifier hs-var">extensionID</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679194449"><span class="hs-identifier hs-var">ext</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">e -&gt; ByteString
forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679194449"><span class="hs-identifier hs-var">ext</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span>        </span><span id="local-6989586621679194432"><span class="annot"><span class="annottext">secureReneg :: IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194432"><span class="hs-identifier hs-var hs-var">secureReneg</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span>
</span><span id="line-156"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; Bool
</span><a href="Network.TLS.Parameters.html#supportedSecureRenegotiation"><span class="hs-identifier hs-var">supportedSecureRenegotiation</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; Bool) -&gt; Supported -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-157"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt ByteString -&gt; IO ByteString
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; TLSSt ByteString
</span><a href="Network.TLS.State.html#getVerifiedData"><span class="hs-identifier hs-var">getVerifiedData</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ClientRole"><span class="hs-identifier hs-var">ClientRole</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO ByteString
-&gt; (ByteString -&gt; IO (Maybe ExtensionRaw))
-&gt; IO (Maybe ExtensionRaw)
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679194460"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194460"><span class="hs-identifier hs-var">vd</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SecureRenegotiation -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">(SecureRenegotiation -&gt; ExtensionRaw)
-&gt; SecureRenegotiation -&gt; ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString -&gt; SecureRenegotiation
</span><a href="Network.TLS.Extension.html#SecureRenegotiation"><span class="hs-identifier hs-var">SecureRenegotiation</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194460"><span class="hs-identifier hs-var">vd</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-158"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-159"></span><span>        </span><span id="local-6989586621679194433"><span class="annot"><span class="annottext">alpnExtension :: IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194433"><span class="hs-identifier hs-var hs-var">alpnExtension</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-160"></span><span>            </span><span id="local-6989586621679194467"><span class="annot"><span class="annottext">Maybe [ByteString]
</span><a href="#local-6989586621679194467"><span class="hs-identifier hs-var">mprotos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClientHooks -&gt; IO (Maybe [ByteString])
</span><a href="Network.TLS.Parameters.html#onSuggestALPN"><span class="hs-identifier hs-var">onSuggestALPN</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientHooks -&gt; IO (Maybe [ByteString]))
-&gt; ClientHooks -&gt; IO (Maybe [ByteString])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; ClientHooks
</span><a href="Network.TLS.Parameters.html#clientHooks"><span class="hs-identifier hs-var">clientHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span>
</span><span id="line-161"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [ByteString]
</span><a href="#local-6989586621679194467"><span class="hs-identifier hs-var">mprotos</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-162"></span><span>                </span><span class="annot"><span class="annottext">Maybe [ByteString]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-163"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679194470"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679194470"><span class="hs-identifier hs-var">protos</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; TLSSt () -&gt; IO ()
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSSt () -&gt; IO ()) -&gt; TLSSt () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setClientALPNSuggest"><span class="hs-identifier hs-var">setClientALPNSuggest</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679194470"><span class="hs-identifier hs-var">protos</span></a></span><span>
</span><span id="line-165"></span><span>                    </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ApplicationLayerProtocolNegotiation -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">(ApplicationLayerProtocolNegotiation -&gt; ExtensionRaw)
-&gt; ApplicationLayerProtocolNegotiation -&gt; ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ApplicationLayerProtocolNegotiation
</span><a href="Network.TLS.Extension.html#ApplicationLayerProtocolNegotiation"><span class="hs-identifier hs-var">ApplicationLayerProtocolNegotiation</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679194470"><span class="hs-identifier hs-var">protos</span></a></span><span>
</span><span id="line-166"></span><span>        </span><span id="local-6989586621679194434"><span class="annot"><span class="annottext">emsExtension :: IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194434"><span class="hs-identifier hs-var hs-var">emsExtension</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-167"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">EMSMode
</span><a href="#local-6989586621679194419"><span class="hs-identifier hs-var">ems</span></a></span><span> </span><span class="annot"><span class="annottext">EMSMode -&gt; EMSMode -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EMSMode
</span><a href="Network.TLS.Parameters.html#NoEMS"><span class="hs-identifier hs-var">NoEMS</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">(Version -&gt; Bool) -&gt; [Version] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS13"><span class="hs-identifier hs-var">TLS13</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Supported -&gt; [Version]
</span><a href="Network.TLS.Parameters.html#supportedVersions"><span class="hs-identifier hs-var">supportedVersions</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [Version]) -&gt; Supported -&gt; [Version]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-169"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtendedMasterSecret -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtendedMasterSecret
</span><a href="Network.TLS.Extension.html#ExtendedMasterSecret"><span class="hs-identifier hs-var">ExtendedMasterSecret</span></a></span><span>
</span><span id="line-170"></span><span>        </span><span id="local-6989586621679194431"><span class="annot"><span class="annottext">sniExtension :: IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194431"><span class="hs-identifier hs-var hs-var">sniExtension</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Bool
</span><a href="Network.TLS.Parameters.html#clientUseServerNameIndication"><span class="hs-identifier hs-var">clientUseServerNameIndication</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span>
</span><span id="line-171"></span><span>                         </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194492"><span class="annot"><span class="annottext">sni :: String
</span><a href="#local-6989586621679194492"><span class="hs-identifier hs-var hs-var">sni</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String, ByteString) -&gt; String
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((String, ByteString) -&gt; String) -&gt; (String, ByteString) -&gt; String
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; (String, ByteString)
</span><a href="Network.TLS.Parameters.html#clientServerIdentification"><span class="hs-identifier hs-var">clientServerIdentification</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span>
</span><span id="line-172"></span><span>                                 </span><span class="annot"><span class="annottext">Context -&gt; TLSSt () -&gt; IO ()
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSSt () -&gt; IO ()) -&gt; TLSSt () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setClientSNI"><span class="hs-identifier hs-var">setClientSNI</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679194492"><span class="hs-identifier hs-var">sni</span></a></span><span>
</span><span id="line-173"></span><span>                                 </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerName -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerName -&gt; ExtensionRaw) -&gt; ServerName -&gt; ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ServerNameType] -&gt; ServerName
</span><a href="Network.TLS.Extension.html#ServerName"><span class="hs-identifier hs-var">ServerName</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; ServerNameType
</span><a href="Network.TLS.Extension.html#ServerNameHostName"><span class="hs-identifier hs-var">ServerNameHostName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679194492"><span class="hs-identifier hs-var">sni</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-174"></span><span>                         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span>        </span><span id="local-6989586621679194435"><span class="annot"><span class="annottext">groupExtension :: IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194435"><span class="hs-identifier hs-var hs-var">groupExtension</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NegotiatedGroups -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">(NegotiatedGroups -&gt; ExtensionRaw)
-&gt; NegotiatedGroups -&gt; ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Group] -&gt; NegotiatedGroups
</span><a href="Network.TLS.Extension.html#NegotiatedGroups"><span class="hs-identifier hs-var">NegotiatedGroups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Supported -&gt; [Group]
</span><a href="Network.TLS.Parameters.html#supportedGroups"><span class="hs-identifier hs-var">supportedGroups</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [Group]) -&gt; Supported -&gt; [Group]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>        </span><span id="local-6989586621679194436"><span class="annot"><span class="annottext">ecPointExtension :: IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194436"><span class="hs-identifier hs-var hs-var">ecPointExtension</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EcPointFormatsSupported -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">(EcPointFormatsSupported -&gt; ExtensionRaw)
-&gt; EcPointFormatsSupported -&gt; ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[EcPointFormat] -&gt; EcPointFormatsSupported
</span><a href="Network.TLS.Extension.html#EcPointFormatsSupported"><span class="hs-identifier hs-var">EcPointFormatsSupported</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EcPointFormat
</span><a href="Network.TLS.Extension.html#EcPointFormat_Uncompressed"><span class="hs-identifier hs-var">EcPointFormat_Uncompressed</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-178"></span><span>                                </span><span class="hs-comment">--[EcPointFormat_Uncompressed,EcPointFormat_AnsiX962_compressed_prime,EcPointFormat_AnsiX962_compressed_char2]</span><span>
</span><span id="line-179"></span><span>        </span><span class="hs-comment">--heartbeatExtension = return $ Just $ toExtensionRaw $ HeartBeat $ HeartBeat_PeerAllowedToSend</span><span>
</span><span id="line-180"></span><span>        </span><span class="hs-comment">--sessionTicketExtension = return $ Just $ toExtensionRaw $ SessionTicket</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span>        </span><span id="local-6989586621679194437"><span class="annot"><span class="annottext">signatureAlgExtension :: IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194437"><span class="hs-identifier hs-var hs-var">signatureAlgExtension</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SignatureAlgorithms -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">(SignatureAlgorithms -&gt; ExtensionRaw)
-&gt; SignatureAlgorithms -&gt; ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm] -&gt; SignatureAlgorithms
</span><a href="Network.TLS.Extension.html#SignatureAlgorithms"><span class="hs-identifier hs-var">SignatureAlgorithms</span></a></span><span> </span><span class="annot"><span class="annottext">([HashAndSignatureAlgorithm] -&gt; SignatureAlgorithms)
-&gt; [HashAndSignatureAlgorithm] -&gt; SignatureAlgorithms
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [HashAndSignatureAlgorithm]
</span><a href="Network.TLS.Parameters.html#supportedHashSignatures"><span class="hs-identifier hs-var">supportedHashSignatures</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [HashAndSignatureAlgorithm])
-&gt; Supported -&gt; [HashAndSignatureAlgorithm]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Supported
</span><a href="Network.TLS.Parameters.html#clientSupported"><span class="hs-identifier hs-var">clientSupported</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span>        </span><span id="local-6989586621679194438"><span class="annot"><span class="annottext">versionExtension :: IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194438"><span class="hs-identifier hs-var hs-var">versionExtension</span></a></span></span><span>
</span><span id="line-185"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194418"><span class="hs-identifier hs-var">tls13</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-186"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194525"><span class="annot"><span class="annottext">vers :: [Version]
</span><a href="#local-6989586621679194525"><span class="hs-identifier hs-var hs-var">vers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Version -&gt; Bool) -&gt; [Version] -&gt; [Version]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS10"><span class="hs-identifier hs-var">TLS10</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Version] -&gt; [Version]) -&gt; [Version] -&gt; [Version]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Version]
</span><a href="Network.TLS.Parameters.html#supportedVersions"><span class="hs-identifier hs-var">supportedVersions</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [Version]) -&gt; Supported -&gt; [Version]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-187"></span><span>                </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SupportedVersions -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">(SupportedVersions -&gt; ExtensionRaw)
-&gt; SupportedVersions -&gt; ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Version] -&gt; SupportedVersions
</span><a href="Network.TLS.Extension.html#SupportedVersionsClientHello"><span class="hs-identifier hs-var">SupportedVersionsClientHello</span></a></span><span> </span><span class="annot"><span class="annottext">[Version]
</span><a href="#local-6989586621679194525"><span class="hs-identifier hs-var">vers</span></a></span><span>
</span><span id="line-188"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span>        </span><span class="hs-comment">-- FIXME</span><span>
</span><span id="line-191"></span><span>        </span><span id="local-6989586621679194440"><span class="annot"><span class="annottext">keyshareExtension :: IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194440"><span class="hs-identifier hs-var hs-var">keyshareExtension</span></a></span></span><span>
</span><span id="line-192"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194418"><span class="hs-identifier hs-var">tls13</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679194400"><span class="hs-identifier hs-var">groupToSend</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-193"></span><span>                  </span><span class="annot"><span class="annottext">Maybe Group
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-194"></span><span>                  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679194535"><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679194535"><span class="hs-identifier hs-var">grp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-195"></span><span>                      </span><span class="hs-special">(</span><span id="local-6989586621679194536"><span class="annot"><span class="annottext">GroupPrivate
</span><a href="#local-6989586621679194536"><span class="hs-identifier hs-var">cpri</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194537"><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679194537"><span class="hs-identifier hs-var">ent</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Group -&gt; IO (GroupPrivate, KeyShareEntry)
</span><a href="Network.TLS.Handshake.Common13.html#makeClientKeyShare"><span class="hs-identifier hs-var">makeClientKeyShare</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679194535"><span class="hs-identifier hs-var">grp</span></a></span><span>
</span><span id="line-196"></span><span>                      </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GroupPrivate -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setGroupPrivate"><span class="hs-identifier hs-var">setGroupPrivate</span></a></span><span> </span><span class="annot"><span class="annottext">GroupPrivate
</span><a href="#local-6989586621679194536"><span class="hs-identifier hs-var">cpri</span></a></span><span>
</span><span id="line-197"></span><span>                      </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KeyShare -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">(KeyShare -&gt; ExtensionRaw) -&gt; KeyShare -&gt; ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[KeyShareEntry] -&gt; KeyShare
</span><a href="Network.TLS.Extension.html#KeyShareClientHello"><span class="hs-identifier hs-var">KeyShareClientHello</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679194537"><span class="hs-identifier hs-var">ent</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-198"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span>        </span><span id="local-6989586621679194551"><span class="annot"><span class="annottext">sessionAndCipherToResume13 :: Maybe (ByteString, SessionData, Cipher)
</span><a href="#local-6989586621679194551"><span class="hs-identifier hs-var hs-var">sessionAndCipherToResume13</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-201"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194418"><span class="hs-identifier hs-var">tls13</span></a></span><span>
</span><span id="line-202"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679194552"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194552"><span class="hs-identifier hs-var">sid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194553"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194553"><span class="hs-identifier hs-var">sdata</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Maybe (ByteString, SessionData)
</span><a href="Network.TLS.Parameters.html#clientWantSessionResume"><span class="hs-identifier hs-var">clientWantSessionResume</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span>
</span><span id="line-203"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SessionData -&gt; Version
</span><a href="Network.TLS.Types.html#sessionVersion"><span class="hs-identifier hs-var">sessionVersion</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194553"><span class="hs-identifier hs-var">sdata</span></a></span><span> </span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS13"><span class="hs-identifier hs-var">TLS13</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>            </span><span id="local-6989586621679194555"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679194555"><span class="hs-identifier hs-var">sCipher</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Cipher -&gt; Bool) -&gt; [Cipher] -&gt; Maybe Cipher
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679194557"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679194557"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; ExtensionID
</span><a href="Network.TLS.Cipher.html#cipherID"><span class="hs-identifier hs-var">cipherID</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679194557"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ExtensionID -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; ExtensionID
</span><a href="Network.TLS.Types.html#sessionCipher"><span class="hs-identifier hs-var">sessionCipher</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194553"><span class="hs-identifier hs-var">sdata</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679194408"><span class="hs-identifier hs-var">ciphers</span></a></span><span>
</span><span id="line-205"></span><span>            </span><span class="annot"><span class="annottext">(ByteString, SessionData, Cipher)
-&gt; Maybe (ByteString, SessionData, Cipher)
forall a. a -&gt; Maybe a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194552"><span class="hs-identifier hs-var">sid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194553"><span class="hs-identifier hs-var">sdata</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679194555"><span class="hs-identifier hs-var">sCipher</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span>        </span><span id="local-6989586621679194563"><span class="annot"><span class="annottext">getPskInfo :: IO (Maybe (ByteString, SessionData, CipherChoice, Word32))
</span><a href="#local-6989586621679194563"><span class="hs-identifier hs-var hs-var">getPskInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-208"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, Cipher)
</span><a href="#local-6989586621679194551"><span class="hs-identifier hs-var">sessionAndCipherToResume13</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-209"></span><span>                </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, Cipher)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, CipherChoice, Word32)
-&gt; IO (Maybe (ByteString, SessionData, CipherChoice, Word32))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, CipherChoice, Word32)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-210"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679194564"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194564"><span class="hs-identifier hs-var">sid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194565"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194565"><span class="hs-identifier hs-var">sdata</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194566"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679194566"><span class="hs-identifier hs-var">sCipher</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-211"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194567"><span class="annot"><span class="annottext">tinfo :: TLS13TicketInfo
</span><a href="#local-6989586621679194567"><span class="hs-identifier hs-var hs-var">tinfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe TLS13TicketInfo -&gt; TLS13TicketInfo
forall a. String -&gt; Maybe a -&gt; a
</span><a href="Network.TLS.Util.html#fromJust"><span class="hs-identifier hs-var">fromJust</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sessionTicketInfo&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe TLS13TicketInfo -&gt; TLS13TicketInfo)
-&gt; Maybe TLS13TicketInfo -&gt; TLS13TicketInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Maybe TLS13TicketInfo
</span><a href="Network.TLS.Types.html#sessionTicketInfo"><span class="hs-identifier hs-var">sessionTicketInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194565"><span class="hs-identifier hs-var">sdata</span></a></span><span>
</span><span id="line-212"></span><span>                    </span><span id="local-6989586621679194569"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679194569"><span class="hs-identifier hs-var">age</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TLS13TicketInfo -&gt; IO Word32
</span><a href="Network.TLS.Handshake.Common13.html#getAge"><span class="hs-identifier hs-var">getAge</span></a></span><span> </span><span class="annot"><span class="annottext">TLS13TicketInfo
</span><a href="#local-6989586621679194567"><span class="hs-identifier hs-var">tinfo</span></a></span><span>
</span><span id="line-213"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, CipherChoice, Word32)
-&gt; IO (Maybe (ByteString, SessionData, CipherChoice, Word32))
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (ByteString, SessionData, CipherChoice, Word32)
 -&gt; IO (Maybe (ByteString, SessionData, CipherChoice, Word32)))
-&gt; Maybe (ByteString, SessionData, CipherChoice, Word32)
-&gt; IO (Maybe (ByteString, SessionData, CipherChoice, Word32))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; TLS13TicketInfo -&gt; Bool
</span><a href="Network.TLS.Handshake.Common13.html#isAgeValid"><span class="hs-identifier hs-var">isAgeValid</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679194569"><span class="hs-identifier hs-var">age</span></a></span><span> </span><span class="annot"><span class="annottext">TLS13TicketInfo
</span><a href="#local-6989586621679194567"><span class="hs-identifier hs-var">tinfo</span></a></span><span>
</span><span id="line-214"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(ByteString, SessionData, CipherChoice, Word32)
-&gt; Maybe (ByteString, SessionData, CipherChoice, Word32)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194564"><span class="hs-identifier hs-var">sid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194565"><span class="hs-identifier hs-var">sdata</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Version -&gt; Cipher -&gt; CipherChoice
</span><a href="Network.TLS.Handshake.Common13.html#makeCipherChoice"><span class="hs-identifier hs-var">makeCipherChoice</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS13"><span class="hs-identifier hs-var">TLS13</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679194566"><span class="hs-identifier hs-var">sCipher</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word32 -&gt; TLS13TicketInfo -&gt; Word32
</span><a href="Network.TLS.Handshake.Common13.html#ageToObfuscatedAge"><span class="hs-identifier hs-var">ageToObfuscatedAge</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679194569"><span class="hs-identifier hs-var">age</span></a></span><span> </span><span class="annot"><span class="annottext">TLS13TicketInfo
</span><a href="#local-6989586621679194567"><span class="hs-identifier hs-var">tinfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-215"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, CipherChoice, Word32)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span>        </span><span id="local-6989586621679194444"><span class="annot"><span class="annottext">preSharedKeyExtension :: Maybe (ByteString, b, CipherChoice, Word32)
-&gt; m (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194444"><span class="hs-identifier hs-var hs-var">preSharedKeyExtension</span></a></span></span><span> </span><span id="local-6989586621679194584"><span class="annot"><span class="annottext">Maybe (ByteString, b, CipherChoice, Word32)
</span><a href="#local-6989586621679194584"><span class="hs-identifier hs-var">pskInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-218"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, b, CipherChoice, Word32)
</span><a href="#local-6989586621679194584"><span class="hs-identifier hs-var">pskInfo</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-219"></span><span>                </span><span class="annot"><span class="annottext">Maybe (ByteString, b, CipherChoice, Word32)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; m (Maybe ExtensionRaw)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-220"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679194585"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194585"><span class="hs-identifier hs-var">sid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194586"><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679194586"><span class="hs-identifier hs-var">choice</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194587"><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679194587"><span class="hs-identifier hs-var">obfAge</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-221"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194588"><span class="annot"><span class="annottext">zero :: ByteString
</span><a href="#local-6989586621679194588"><span class="hs-identifier hs-var hs-var">zero</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CipherChoice -&gt; ByteString
</span><a href="Network.TLS.Handshake.Common13.html#cZero"><span class="hs-identifier hs-var">cZero</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679194586"><span class="hs-identifier hs-var">choice</span></a></span><span>
</span><span id="line-222"></span><span>                        </span><span id="local-6989586621679194590"><span class="annot"><span class="annottext">identity :: PskIdentity
</span><a href="#local-6989586621679194590"><span class="hs-identifier hs-var hs-var">identity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Word32 -&gt; PskIdentity
</span><a href="Network.TLS.Extension.html#PskIdentity"><span class="hs-identifier hs-var">PskIdentity</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194585"><span class="hs-identifier hs-var">sid</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
</span><a href="#local-6989586621679194587"><span class="hs-identifier hs-var">obfAge</span></a></span><span>
</span><span id="line-223"></span><span>                        </span><span id="local-6989586621679194592"><span class="annot"><span class="annottext">offeredPsks :: PreSharedKey
</span><a href="#local-6989586621679194592"><span class="hs-identifier hs-var hs-var">offeredPsks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PskIdentity] -&gt; [ByteString] -&gt; PreSharedKey
</span><a href="Network.TLS.Extension.html#PreSharedKeyClientHello"><span class="hs-identifier hs-var">PreSharedKeyClientHello</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PskIdentity
</span><a href="#local-6989586621679194590"><span class="hs-identifier hs-var">identity</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194588"><span class="hs-identifier hs-var">zero</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-224"></span><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; m (Maybe ExtensionRaw)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; m (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; m (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PreSharedKey -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">PreSharedKey
</span><a href="#local-6989586621679194592"><span class="hs-identifier hs-var">offeredPsks</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>        </span><span id="local-6989586621679194443"><span class="annot"><span class="annottext">pskExchangeModeExtension :: IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194443"><span class="hs-identifier hs-var hs-var">pskExchangeModeExtension</span></a></span></span><span>
</span><span id="line-227"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194418"><span class="hs-identifier hs-var">tls13</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PskKeyExchangeModes -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">(PskKeyExchangeModes -&gt; ExtensionRaw)
-&gt; PskKeyExchangeModes -&gt; ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PskKexMode] -&gt; PskKeyExchangeModes
</span><a href="Network.TLS.Extension.html#PskKeyExchangeModes"><span class="hs-identifier hs-var">PskKeyExchangeModes</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PskKexMode
</span><a href="Network.TLS.Extension.html#PSK_DHE_KE"><span class="hs-identifier hs-var">PSK_DHE_KE</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-228"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span>        </span><span id="local-6989586621679194439"><span class="annot"><span class="annottext">earlyDataExtension :: Bool -&gt; m (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194439"><span class="hs-identifier hs-var hs-var">earlyDataExtension</span></a></span></span><span> </span><span id="local-6989586621679194611"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194611"><span class="hs-identifier hs-var">rtt0</span></a></span></span><span>
</span><span id="line-231"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194611"><span class="hs-identifier hs-var">rtt0</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; m (Maybe ExtensionRaw)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; m (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; m (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EarlyDataIndication -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Word32 -&gt; EarlyDataIndication
</span><a href="Network.TLS.Extension.html#EarlyDataIndication"><span class="hs-identifier hs-var">EarlyDataIndication</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Word32
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; m (Maybe ExtensionRaw)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span>        </span><span id="local-6989586621679194441"><span class="annot"><span class="annottext">cookieExtension :: IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194441"><span class="hs-identifier hs-var hs-var">cookieExtension</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-235"></span><span>            </span><span id="local-6989586621679194617"><span class="annot"><span class="annottext">Maybe Cookie
</span><a href="#local-6989586621679194617"><span class="hs-identifier hs-var">mcookie</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt (Maybe Cookie) -&gt; IO (Maybe Cookie)
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt (Maybe Cookie)
</span><a href="Network.TLS.State.html#getTLS13Cookie"><span class="hs-identifier hs-var">getTLS13Cookie</span></a></span><span>
</span><span id="line-236"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Cookie
</span><a href="#local-6989586621679194617"><span class="hs-identifier hs-var">mcookie</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-237"></span><span>              </span><span class="annot"><span class="annottext">Maybe Cookie
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-238"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679194619"><span class="annot"><span class="annottext">Cookie
</span><a href="#local-6989586621679194619"><span class="hs-identifier hs-var">cookie</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cookie -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">Cookie
</span><a href="#local-6989586621679194619"><span class="hs-identifier hs-var">cookie</span></a></span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>        </span><span id="local-6989586621679194442"><span class="annot"><span class="annottext">postHandshakeAuthExtension :: IO (Maybe ExtensionRaw)
</span><a href="#local-6989586621679194442"><span class="hs-identifier hs-var hs-var">postHandshakeAuthExtension</span></a></span></span><span>
</span><span id="line-241"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.TLS.Context.Internal.html#ctxQUICMode"><span class="hs-identifier hs-var">ctxQUICMode</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-242"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194418"><span class="hs-identifier hs-var">tls13</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw))
-&gt; Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Maybe ExtensionRaw
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Maybe ExtensionRaw)
-&gt; ExtensionRaw -&gt; Maybe ExtensionRaw
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PostHandshakeAuth -&gt; ExtensionRaw
forall e. Extension e =&gt; e -&gt; ExtensionRaw
</span><a href="#local-6989586621679194445"><span class="hs-identifier hs-var">toExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">PostHandshakeAuth
</span><a href="Network.TLS.Extension.html#PostHandshakeAuth"><span class="hs-identifier hs-var">PostHandshakeAuth</span></a></span><span>
</span><span id="line-243"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw -&gt; IO (Maybe ExtensionRaw)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtensionRaw
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span>        </span><span id="local-6989586621679194637"><span class="annot"><span class="annottext">adjustExtentions :: Maybe (a, SessionData, CipherChoice, d)
-&gt; [ExtensionRaw] -&gt; Handshake -&gt; IO [ExtensionRaw]
</span><a href="#local-6989586621679194637"><span class="hs-identifier hs-var hs-var">adjustExtentions</span></a></span></span><span> </span><span id="local-6989586621679194638"><span class="annot"><span class="annottext">Maybe (a, SessionData, CipherChoice, d)
</span><a href="#local-6989586621679194638"><span class="hs-identifier hs-var">pskInfo</span></a></span></span><span> </span><span id="local-6989586621679194639"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194639"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span id="local-6989586621679194640"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679194640"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-246"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (a, SessionData, CipherChoice, d)
</span><a href="#local-6989586621679194638"><span class="hs-identifier hs-var">pskInfo</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-247"></span><span>                </span><span class="annot"><span class="annottext">Maybe (a, SessionData, CipherChoice, d)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw] -&gt; IO [ExtensionRaw]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194639"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-248"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194641"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194641"><span class="hs-identifier hs-var">sdata</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194642"><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679194642"><span class="hs-identifier hs-var">choice</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-249"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194643"><span class="annot"><span class="annottext">psk :: ByteString
</span><a href="#local-6989586621679194643"><span class="hs-identifier hs-var hs-var">psk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; ByteString
</span><a href="Network.TLS.Types.html#sessionSecret"><span class="hs-identifier hs-var">sessionSecret</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194641"><span class="hs-identifier hs-var">sdata</span></a></span><span>
</span><span id="line-250"></span><span>                          </span><span id="local-6989586621679194645"><span class="annot"><span class="annottext">earlySecret :: BaseSecret EarlySecret
</span><a href="#local-6989586621679194645"><span class="hs-identifier hs-var hs-var">earlySecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CipherChoice -&gt; Maybe ByteString -&gt; BaseSecret EarlySecret
</span><a href="Network.TLS.Handshake.Common13.html#initEarlySecret"><span class="hs-identifier hs-var">initEarlySecret</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679194642"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194643"><span class="hs-identifier hs-var">psk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>                      </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BaseSecret EarlySecret -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13EarlySecret"><span class="hs-identifier hs-var">setTLS13EarlySecret</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret EarlySecret
</span><a href="#local-6989586621679194645"><span class="hs-identifier hs-var">earlySecret</span></a></span><span>
</span><span id="line-252"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194648"><span class="annot"><span class="annottext">ech :: ByteString
</span><a href="#local-6989586621679194648"><span class="hs-identifier hs-var hs-var">ech</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Handshake -&gt; ByteString
</span><a href="Network.TLS.Packet.html#encodeHandshake"><span class="hs-identifier hs-var">encodeHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679194640"><span class="hs-identifier hs-var">ch</span></a></span><span>
</span><span id="line-253"></span><span>                          </span><span id="local-6989586621679194650"><span class="annot"><span class="annottext">h :: Hash
</span><a href="#local-6989586621679194650"><span class="hs-identifier hs-var hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CipherChoice -&gt; Hash
</span><a href="Network.TLS.Handshake.Common13.html#cHash"><span class="hs-identifier hs-var">cHash</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679194642"><span class="hs-identifier hs-var">choice</span></a></span><span>
</span><span id="line-254"></span><span>                          </span><span id="local-6989586621679194652"><span class="annot"><span class="annottext">siz :: Int
</span><a href="#local-6989586621679194652"><span class="hs-identifier hs-var hs-var">siz</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Int
</span><a href="Network.TLS.Crypto.html#hashDigestSize"><span class="hs-identifier hs-var">hashDigestSize</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679194650"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-255"></span><span>                      </span><span id="local-6989586621679194654"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194654"><span class="hs-identifier hs-var">binder</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; BaseSecret EarlySecret
-&gt; Hash
-&gt; Int
-&gt; Maybe ByteString
-&gt; IO ByteString
</span><a href="Network.TLS.Handshake.Common13.html#makePSKBinder"><span class="hs-identifier hs-var">makePSKBinder</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret EarlySecret
</span><a href="#local-6989586621679194645"><span class="hs-identifier hs-var">earlySecret</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679194650"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679194652"><span class="hs-identifier hs-var">siz</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">3</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194648"><span class="hs-identifier hs-var">ech</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194661"><span class="annot"><span class="annottext">exts' :: [ExtensionRaw]
</span><a href="#local-6989586621679194661"><span class="hs-identifier hs-var hs-var">exts'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw] -&gt; [ExtensionRaw]
forall a. HasCallStack =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194639"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw] -&gt; [ExtensionRaw] -&gt; [ExtensionRaw]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ExtensionRaw -&gt; ExtensionRaw
</span><a href="#local-6989586621679194663"><span class="hs-identifier hs-var">adjust</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ExtensionRaw] -&gt; ExtensionRaw
forall a. HasCallStack =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194639"><span class="hs-identifier hs-var">exts</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-257"></span><span>                          </span><span id="local-6989586621679194663"><span class="annot"><span class="annottext">adjust :: ExtensionRaw -&gt; ExtensionRaw
</span><a href="#local-6989586621679194663"><span class="hs-identifier hs-var hs-var">adjust</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span> </span><span id="local-6989586621679194665"><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679194665"><span class="hs-identifier hs-var">eid</span></a></span></span><span> </span><span id="local-6989586621679194666"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194666"><span class="hs-identifier hs-var">withoutBinders</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString -&gt; ExtensionRaw
</span><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-var">ExtensionRaw</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679194665"><span class="hs-identifier hs-var">eid</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194667"><span class="hs-identifier hs-var">withBinders</span></a></span><span>
</span><span id="line-258"></span><span>                            </span><span class="hs-keyword">where</span><span>
</span><span id="line-259"></span><span>                              </span><span id="local-6989586621679194667"><span class="annot"><span class="annottext">withBinders :: ByteString
</span><a href="#local-6989586621679194667"><span class="hs-identifier hs-var hs-var">withBinders</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
</span><a href="Network.TLS.Handshake.Common13.html#replacePSKBinder"><span class="hs-identifier hs-var">replacePSKBinder</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194666"><span class="hs-identifier hs-var">withoutBinders</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194654"><span class="hs-identifier hs-var">binder</span></a></span><span>
</span><span id="line-260"></span><span>                      </span><span class="annot"><span class="annottext">[ExtensionRaw] -&gt; IO [ExtensionRaw]
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194661"><span class="hs-identifier hs-var">exts'</span></a></span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span>        </span><span id="local-6989586621679194363"><span class="annot"><span class="annottext">generateClientHelloParams :: IO (ClientRandom, Session)
</span><a href="#local-6989586621679194363"><span class="hs-identifier hs-var hs-var">generateClientHelloParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-263"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (ClientRandom, Session, Version)
</span><a href="#local-6989586621679194358"><span class="hs-identifier hs-var">mparams</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-264"></span><span>                </span><span class="hs-comment">-- Client random and session in the second client hello for</span><span>
</span><span id="line-265"></span><span>                </span><span class="hs-comment">-- retry must be the same as the first one.</span><span>
</span><span id="line-266"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679194675"><span class="annot"><span class="annottext">ClientRandom
</span><a href="#local-6989586621679194675"><span class="hs-identifier hs-var">crand</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194676"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194676"><span class="hs-identifier hs-var">clientSession</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Version
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(ClientRandom, Session) -&gt; IO (ClientRandom, Session)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientRandom
</span><a href="#local-6989586621679194675"><span class="hs-identifier hs-var">crand</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194676"><span class="hs-identifier hs-var">clientSession</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>                </span><span class="annot"><span class="annottext">Maybe (ClientRandom, Session, Version)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>                    </span><span id="local-6989586621679194677"><span class="annot"><span class="annottext">ClientRandom
</span><a href="#local-6989586621679194677"><span class="hs-identifier hs-var">crand</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ClientRandom
</span><a href="Network.TLS.Handshake.Random.html#clientRandom"><span class="hs-identifier hs-var">clientRandom</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-269"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194681"><span class="annot"><span class="annottext">paramSession :: Session
</span><a href="#local-6989586621679194681"><span class="hs-identifier hs-var hs-var">paramSession</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Maybe (ByteString, SessionData)
</span><a href="Network.TLS.Parameters.html#clientWantSessionResume"><span class="hs-identifier hs-var">clientWantSessionResume</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-270"></span><span>                            </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Session
</span><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-var">Session</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-271"></span><span>                            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679194683"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194683"><span class="hs-identifier hs-var">sid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194684"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194684"><span class="hs-identifier hs-var">sdata</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>                                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Version
</span><a href="Network.TLS.Types.html#sessionVersion"><span class="hs-identifier hs-var">sessionVersion</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194684"><span class="hs-identifier hs-var">sdata</span></a></span><span> </span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS13"><span class="hs-identifier hs-var">TLS13</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Session
</span><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-var">Session</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-273"></span><span>                                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">EMSMode
</span><a href="#local-6989586621679194419"><span class="hs-identifier hs-var">ems</span></a></span><span> </span><span class="annot"><span class="annottext">EMSMode -&gt; EMSMode -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">EMSMode
</span><a href="Network.TLS.Parameters.html#RequireEMS"><span class="hs-identifier hs-var">RequireEMS</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194687"><span class="hs-identifier hs-var">noSessionEMS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Session
</span><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-var">Session</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-274"></span><span>                                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Session
</span><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-var">Session</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194683"><span class="hs-identifier hs-var">sid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>                              </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679194687"><span class="annot"><span class="annottext">noSessionEMS :: Bool
</span><a href="#local-6989586621679194687"><span class="hs-identifier hs-var hs-var">noSessionEMS</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionFlag
</span><a href="Network.TLS.Types.html#SessionEMS"><span class="hs-identifier hs-var">SessionEMS</span></a></span><span> </span><span class="annot"><span class="annottext">SessionFlag -&gt; [SessionFlag] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; [SessionFlag]
</span><a href="Network.TLS.Types.html#sessionFlags"><span class="hs-identifier hs-var">sessionFlags</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194684"><span class="hs-identifier hs-var">sdata</span></a></span><span>
</span><span id="line-276"></span><span>                    </span><span class="hs-comment">-- In compatibility mode a client not offering a pre-TLS 1.3</span><span>
</span><span id="line-277"></span><span>                    </span><span class="hs-comment">-- session MUST generate a new 32-byte value</span><span>
</span><span id="line-278"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194418"><span class="hs-identifier hs-var">tls13</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194681"><span class="hs-identifier hs-var">paramSession</span></a></span><span> </span><span class="annot"><span class="annottext">Session -&gt; Session -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Session
</span><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-var">Session</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.TLS.Context.Internal.html#ctxQUICMode"><span class="hs-identifier hs-var">ctxQUICMode</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-280"></span><span>                            </span><span id="local-6989586621679194695"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194695"><span class="hs-identifier hs-var">randomSession</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Session
</span><a href="Network.TLS.Handshake.Common.html#newSession"><span class="hs-identifier hs-var">newSession</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-281"></span><span>                            </span><span class="annot"><span class="annottext">(ClientRandom, Session) -&gt; IO (ClientRandom, Session)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientRandom
</span><a href="#local-6989586621679194677"><span class="hs-identifier hs-var">crand</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194695"><span class="hs-identifier hs-var">randomSession</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(ClientRandom, Session) -&gt; IO (ClientRandom, Session)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientRandom
</span><a href="#local-6989586621679194677"><span class="hs-identifier hs-var">crand</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194681"><span class="hs-identifier hs-var">paramSession</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span>        </span><span id="local-6989586621679194366"><span class="annot"><span class="annottext">sendClientHello :: Session -&gt; ClientRandom -&gt; IO (Bool, [ExtensionID])
</span><a href="#local-6989586621679194366"><span class="hs-identifier hs-var hs-var">sendClientHello</span></a></span></span><span> </span><span id="local-6989586621679194712"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194712"><span class="hs-identifier hs-var">clientSession</span></a></span></span><span> </span><span id="local-6989586621679194713"><span class="annot"><span class="annottext">ClientRandom
</span><a href="#local-6989586621679194713"><span class="hs-identifier hs-var">crand</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-285"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194714"><span class="annot"><span class="annottext">ver :: Version
</span><a href="#local-6989586621679194714"><span class="hs-identifier hs-var hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194418"><span class="hs-identifier hs-var">tls13</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS12"><span class="hs-identifier hs-var">TLS12</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194414"><span class="hs-identifier hs-var">highestVer</span></a></span><span>
</span><span id="line-286"></span><span>            </span><span id="local-6989586621679194716"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194716"><span class="hs-identifier hs-var">hrr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Bool -&gt; IO Bool
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Bool
</span><a href="Network.TLS.State.html#getTLS13HRR"><span class="hs-identifier hs-var">getTLS13HRR</span></a></span><span>
</span><span id="line-287"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194716"><span class="hs-identifier hs-var">hrr</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Version -&gt; ClientRandom -&gt; IO ()
</span><a href="Network.TLS.Handshake.Process.html#startHandshake"><span class="hs-identifier hs-var">startHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194714"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">ClientRandom
</span><a href="#local-6989586621679194713"><span class="hs-identifier hs-var">crand</span></a></span><span>
</span><span id="line-288"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; TLSSt () -&gt; IO ()
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSSt () -&gt; IO ()) -&gt; TLSSt () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Version -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setVersionIfUnset"><span class="hs-identifier hs-var">setVersionIfUnset</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194414"><span class="hs-identifier hs-var">highestVer</span></a></span><span>
</span><span id="line-289"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194719"><span class="annot"><span class="annottext">cipherIds :: [ExtensionID]
</span><a href="#local-6989586621679194719"><span class="hs-identifier hs-var hs-var">cipherIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Cipher -&gt; ExtensionID) -&gt; [Cipher] -&gt; [ExtensionID]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; ExtensionID
</span><a href="Network.TLS.Cipher.html#cipherID"><span class="hs-identifier hs-var">cipherID</span></a></span><span> </span><span class="annot"><span class="annottext">[Cipher]
</span><a href="#local-6989586621679194408"><span class="hs-identifier hs-var">ciphers</span></a></span><span>
</span><span id="line-290"></span><span>                </span><span id="local-6989586621679194720"><span class="annot"><span class="annottext">compIds :: [CompressionID]
</span><a href="#local-6989586621679194720"><span class="hs-identifier hs-var hs-var">compIds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Compression -&gt; CompressionID) -&gt; [Compression] -&gt; [CompressionID]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Compression -&gt; CompressionID
</span><a href="Network.TLS.Compression.html#compressionID"><span class="hs-identifier hs-var">compressionID</span></a></span><span> </span><span class="annot"><span class="annottext">[Compression]
</span><a href="#local-6989586621679194410"><span class="hs-identifier hs-var">compressions</span></a></span><span>
</span><span id="line-291"></span><span>                </span><span id="local-6989586621679194722"><span class="annot"><span class="annottext">mkClientHello :: [ExtensionRaw] -&gt; Handshake
</span><a href="#local-6989586621679194722"><span class="hs-identifier hs-var hs-var">mkClientHello</span></a></span></span><span> </span><span id="local-6989586621679194723"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194723"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Version
-&gt; ClientRandom
-&gt; Session
-&gt; [ExtensionID]
-&gt; [CompressionID]
-&gt; [ExtensionRaw]
-&gt; Maybe ByteString
-&gt; Handshake
</span><a href="Network.TLS.Struct.html#ClientHello"><span class="hs-identifier hs-var">ClientHello</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194714"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">ClientRandom
</span><a href="#local-6989586621679194713"><span class="hs-identifier hs-var">crand</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194712"><span class="hs-identifier hs-var">clientSession</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679194719"><span class="hs-identifier hs-var">cipherIds</span></a></span><span> </span><span class="annot"><span class="annottext">[CompressionID]
</span><a href="#local-6989586621679194720"><span class="hs-identifier hs-var">compIds</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194723"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-292"></span><span>            </span><span id="local-6989586621679194725"><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, CipherChoice, Word32)
</span><a href="#local-6989586621679194725"><span class="hs-identifier hs-var">pskInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe (ByteString, SessionData, CipherChoice, Word32))
</span><a href="#local-6989586621679194563"><span class="hs-identifier hs-var">getPskInfo</span></a></span><span>
</span><span id="line-293"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194727"><span class="annot"><span class="annottext">rtt0info :: Maybe (CipherChoice, ByteString)
</span><a href="#local-6989586621679194727"><span class="hs-identifier hs-var hs-var">rtt0info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, CipherChoice, Word32)
</span><a href="#local-6989586621679194725"><span class="hs-identifier hs-var">pskInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, CipherChoice, Word32)
-&gt; ((ByteString, SessionData, CipherChoice, Word32)
    -&gt; Maybe (CipherChoice, ByteString))
-&gt; Maybe (CipherChoice, ByteString)
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">(ByteString, SessionData, CipherChoice, Word32)
-&gt; Maybe (CipherChoice, ByteString)
forall {a} {a} {d}. (a, SessionData, a, d) -&gt; Maybe (a, ByteString)
</span><a href="#local-6989586621679194728"><span class="hs-identifier hs-var">get0RTTinfo</span></a></span><span>
</span><span id="line-294"></span><span>                </span><span id="local-6989586621679194729"><span class="annot"><span class="annottext">rtt0 :: Bool
</span><a href="#local-6989586621679194729"><span class="hs-identifier hs-var hs-var">rtt0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (CipherChoice, ByteString) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe (CipherChoice, ByteString)
</span><a href="#local-6989586621679194727"><span class="hs-identifier hs-var">rtt0info</span></a></span><span>
</span><span id="line-295"></span><span>            </span><span id="local-6989586621679194730"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194730"><span class="hs-identifier hs-var">extensions0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Maybe ExtensionRaw] -&gt; [ExtensionRaw]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe ExtensionRaw] -&gt; [ExtensionRaw])
-&gt; IO [Maybe ExtensionRaw] -&gt; IO [ExtensionRaw]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, CipherChoice, Word32)
-&gt; Bool -&gt; IO [Maybe ExtensionRaw]
forall {b}.
Maybe (ByteString, b, CipherChoice, Word32)
-&gt; Bool -&gt; IO [Maybe ExtensionRaw]
</span><a href="#local-6989586621679194427"><span class="hs-identifier hs-var">getExtensions</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, CipherChoice, Word32)
</span><a href="#local-6989586621679194725"><span class="hs-identifier hs-var">pskInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194729"><span class="hs-identifier hs-var">rtt0</span></a></span><span>
</span><span id="line-296"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194733"><span class="annot"><span class="annottext">extensions1 :: [ExtensionRaw]
</span><a href="#local-6989586621679194733"><span class="hs-identifier hs-var hs-var">extensions1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Shared -&gt; [ExtensionRaw]
</span><a href="Network.TLS.Parameters.html#sharedHelloExtensions"><span class="hs-identifier hs-var">sharedHelloExtensions</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientParams -&gt; Shared
</span><a href="Network.TLS.Parameters.html#clientShared"><span class="hs-identifier hs-var">clientShared</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw] -&gt; [ExtensionRaw] -&gt; [ExtensionRaw]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194730"><span class="hs-identifier hs-var">extensions0</span></a></span><span>
</span><span id="line-297"></span><span>            </span><span id="local-6989586621679194736"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194736"><span class="hs-identifier hs-var">extensions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, CipherChoice, Word32)
-&gt; [ExtensionRaw] -&gt; Handshake -&gt; IO [ExtensionRaw]
forall {a} {d}.
Maybe (a, SessionData, CipherChoice, d)
-&gt; [ExtensionRaw] -&gt; Handshake -&gt; IO [ExtensionRaw]
</span><a href="#local-6989586621679194637"><span class="hs-identifier hs-var">adjustExtentions</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData, CipherChoice, Word32)
</span><a href="#local-6989586621679194725"><span class="hs-identifier hs-var">pskInfo</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194733"><span class="hs-identifier hs-var">extensions1</span></a></span><span> </span><span class="annot"><span class="annottext">(Handshake -&gt; IO [ExtensionRaw]) -&gt; Handshake -&gt; IO [ExtensionRaw]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw] -&gt; Handshake
</span><a href="#local-6989586621679194722"><span class="hs-identifier hs-var">mkClientHello</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194733"><span class="hs-identifier hs-var">extensions1</span></a></span><span>
</span><span id="line-298"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Packet -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier hs-var">sendPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet -&gt; IO ()) -&gt; Packet -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake] -&gt; Packet
</span><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-var">Handshake</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[ExtensionRaw] -&gt; Handshake
</span><a href="#local-6989586621679194722"><span class="hs-identifier hs-var">mkClientHello</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194736"><span class="hs-identifier hs-var">extensions</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-299"></span><span>            </span><span id="local-6989586621679194739"><span class="annot"><span class="annottext">Maybe EarlySecretInfo
</span><a href="#local-6989586621679194739"><span class="hs-identifier hs-var">mEarlySecInfo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (CipherChoice, ByteString)
</span><a href="#local-6989586621679194727"><span class="hs-identifier hs-var">rtt0info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-300"></span><span>               </span><span class="annot"><span class="annottext">Maybe (CipherChoice, ByteString)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe EarlySecretInfo -&gt; IO (Maybe EarlySecretInfo)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe EarlySecretInfo
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-301"></span><span>               </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679194740"><span class="annot"><span class="annottext">(CipherChoice, ByteString)
</span><a href="#local-6989586621679194740"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EarlySecretInfo -&gt; Maybe EarlySecretInfo
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(EarlySecretInfo -&gt; Maybe EarlySecretInfo)
-&gt; IO EarlySecretInfo -&gt; IO (Maybe EarlySecretInfo)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(CipherChoice, ByteString) -&gt; IO EarlySecretInfo
</span><a href="#local-6989586621679194741"><span class="hs-identifier hs-var">send0RTT</span></a></span><span> </span><span class="annot"><span class="annottext">(CipherChoice, ByteString)
</span><a href="#local-6989586621679194740"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-302"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194716"><span class="hs-identifier hs-var">hrr</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; ClientState -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#contextSync"><span class="hs-identifier hs-var">contextSync</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientState -&gt; IO ()) -&gt; ClientState -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe EarlySecretInfo -&gt; ClientState
</span><a href="Network.TLS.Handshake.Control.html#SendClientHello"><span class="hs-identifier hs-var">SendClientHello</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EarlySecretInfo
</span><a href="#local-6989586621679194739"><span class="hs-identifier hs-var">mEarlySecInfo</span></a></span><span>
</span><span id="line-303"></span><span>            </span><span class="annot"><span class="annottext">(Bool, [ExtensionID]) -&gt; IO (Bool, [ExtensionID])
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679194729"><span class="hs-identifier hs-var">rtt0</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; ExtensionID) -&gt; [ExtensionRaw] -&gt; [ExtensionID]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span> </span><span id="local-6989586621679194744"><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679194744"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679194744"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679194736"><span class="hs-identifier hs-var">extensions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span>        </span><span id="local-6989586621679194728"><span class="annot"><span class="annottext">get0RTTinfo :: (a, SessionData, a, d) -&gt; Maybe (a, ByteString)
</span><a href="#local-6989586621679194728"><span class="hs-identifier hs-var hs-var">get0RTTinfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194751"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194751"><span class="hs-identifier hs-var">sdata</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194752"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679194752"><span class="hs-identifier hs-var">choice</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-306"></span><span>            </span><span id="local-6989586621679194753"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194753"><span class="hs-identifier hs-var">earlyData</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Maybe ByteString
</span><a href="Network.TLS.Parameters.html#clientEarlyData"><span class="hs-identifier hs-var">clientEarlyData</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span>
</span><span id="line-307"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">B.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194753"><span class="hs-identifier hs-var">earlyData</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Int
</span><a href="Network.TLS.Types.html#sessionMaxEarlyDataSize"><span class="hs-identifier hs-var">sessionMaxEarlyDataSize</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679194751"><span class="hs-identifier hs-var">sdata</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>            </span><span class="annot"><span class="annottext">(a, ByteString) -&gt; Maybe (a, ByteString)
forall a. a -&gt; Maybe a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679194752"><span class="hs-identifier hs-var">choice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194753"><span class="hs-identifier hs-var">earlyData</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span>        </span><span id="local-6989586621679194741"><span class="annot"><span class="annottext">send0RTT :: (CipherChoice, ByteString) -&gt; IO EarlySecretInfo
</span><a href="#local-6989586621679194741"><span class="hs-identifier hs-var hs-var">send0RTT</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679194772"><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679194772"><span class="hs-identifier hs-var">choice</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194773"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194773"><span class="hs-identifier hs-var">earlyData</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-311"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194774"><span class="annot"><span class="annottext">usedCipher :: Cipher
</span><a href="#local-6989586621679194774"><span class="hs-identifier hs-var hs-var">usedCipher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CipherChoice -&gt; Cipher
</span><a href="Network.TLS.Handshake.Common13.html#cCipher"><span class="hs-identifier hs-var">cCipher</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679194772"><span class="hs-identifier hs-var">choice</span></a></span><span>
</span><span id="line-312"></span><span>                    </span><span id="local-6989586621679194776"><span class="annot"><span class="annottext">usedHash :: Hash
</span><a href="#local-6989586621679194776"><span class="hs-identifier hs-var hs-var">usedHash</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CipherChoice -&gt; Hash
</span><a href="Network.TLS.Handshake.Common13.html#cHash"><span class="hs-identifier hs-var">cHash</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679194772"><span class="hs-identifier hs-var">choice</span></a></span><span>
</span><span id="line-313"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679194777"><span class="annot"><span class="annottext">BaseSecret EarlySecret
</span><a href="#local-6989586621679194777"><span class="hs-identifier hs-var">earlySecret</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; HandshakeM (Maybe (BaseSecret EarlySecret))
-&gt; IO (Maybe (BaseSecret EarlySecret))
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM (Maybe (BaseSecret EarlySecret))
</span><a href="Network.TLS.Handshake.State.html#getTLS13EarlySecret"><span class="hs-identifier hs-var">getTLS13EarlySecret</span></a></span><span>
</span><span id="line-314"></span><span>                </span><span class="hs-comment">-- Client hello is stored in hstHandshakeDigest</span><span>
</span><span id="line-315"></span><span>                </span><span class="hs-comment">-- But HandshakeDigestContext is not created yet.</span><span>
</span><span id="line-316"></span><span>                </span><span id="local-6989586621679194779"><span class="annot"><span class="annottext">SecretPair EarlySecret
</span><a href="#local-6989586621679194779"><span class="hs-identifier hs-var">earlyKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; CipherChoice
-&gt; Either ByteString (BaseSecret EarlySecret)
-&gt; Bool
-&gt; IO (SecretPair EarlySecret)
</span><a href="Network.TLS.Handshake.Common13.html#calculateEarlySecret"><span class="hs-identifier hs-var">calculateEarlySecret</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679194772"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BaseSecret EarlySecret
-&gt; Either ByteString (BaseSecret EarlySecret)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">BaseSecret EarlySecret
</span><a href="#local-6989586621679194777"><span class="hs-identifier hs-var">earlySecret</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-317"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194781"><span class="annot"><span class="annottext">clientEarlySecret :: ClientTrafficSecret EarlySecret
</span><a href="#local-6989586621679194781"><span class="hs-identifier hs-var hs-var">clientEarlySecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretPair EarlySecret -&gt; ClientTrafficSecret EarlySecret
forall a. SecretPair a -&gt; ClientTrafficSecret a
</span><a href="Network.TLS.Types.html#pairClient"><span class="hs-identifier hs-var">pairClient</span></a></span><span> </span><span class="annot"><span class="annottext">SecretPair EarlySecret
</span><a href="#local-6989586621679194779"><span class="hs-identifier hs-var">earlyKey</span></a></span><span>
</span><span id="line-318"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.TLS.Context.Internal.html#ctxQUICMode"><span class="hs-identifier hs-var">ctxQUICMode</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-319"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; (forall {b}. Monoid b =&gt; PacketFlightM b ()) -&gt; IO ()
forall a.
Context -&gt; (forall b. Monoid b =&gt; PacketFlightM b a) -&gt; IO a
</span><a href="Network.TLS.IO.html#runPacketFlight"><span class="hs-identifier hs-var">runPacketFlight</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {b}. Monoid b =&gt; PacketFlightM b ()) -&gt; IO ())
-&gt; (forall {b}. Monoid b =&gt; PacketFlightM b ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; PacketFlightM b ()
forall b. Monoid b =&gt; Context -&gt; PacketFlightM b ()
</span><a href="Network.TLS.Handshake.Common13.html#sendChangeCipherSpec13"><span class="hs-identifier hs-var">sendChangeCipherSpec13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-320"></span><span>                    </span><span class="annot"><span class="annottext">Context
-&gt; Hash -&gt; Cipher -&gt; ClientTrafficSecret EarlySecret -&gt; IO ()
forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setTxState"><span class="hs-identifier hs-var">setTxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679194776"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679194774"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ClientTrafficSecret EarlySecret
</span><a href="#local-6989586621679194781"><span class="hs-identifier hs-var">clientEarlySecret</span></a></span><span>
</span><span id="line-321"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194786"><span class="annot"><span class="annottext">len :: Maybe Int
</span><a href="#local-6989586621679194786"><span class="hs-identifier hs-var hs-var">len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Maybe Int
</span><a href="Network.TLS.Context.Internal.html#ctxFragmentSize"><span class="hs-identifier hs-var">ctxFragmentSize</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-322"></span><span>                    </span><span class="annot"><span class="annottext">Maybe Int -&gt; (ByteString -&gt; IO ()) -&gt; ByteString -&gt; IO ()
forall (m :: * -&gt; *) a.
Monad m =&gt;
Maybe Int -&gt; (ByteString -&gt; m a) -&gt; ByteString -&gt; m ()
</span><a href="Network.TLS.Util.html#mapChunks_"><span class="hs-identifier hs-var">mapChunks_</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621679194786"><span class="hs-identifier hs-var">len</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Packet13 -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket13"><span class="hs-identifier hs-var">sendPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet13 -&gt; IO ())
-&gt; (ByteString -&gt; Packet13) -&gt; ByteString -&gt; IO ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#AppData13"><span class="hs-identifier hs-var">AppData13</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194773"><span class="hs-identifier hs-var">earlyData</span></a></span><span>
</span><span id="line-323"></span><span>                </span><span class="hs-comment">-- We set RTT0Sent even in quicMode</span><span>
</span><span id="line-324"></span><span>                </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RTT0Status -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13RTT0Status"><span class="hs-identifier hs-var">setTLS13RTT0Status</span></a></span><span> </span><span class="annot"><span class="annottext">RTT0Status
</span><a href="Network.TLS.Handshake.State.html#RTT0Sent"><span class="hs-identifier hs-var">RTT0Sent</span></a></span><span>
</span><span id="line-325"></span><span>                </span><span class="annot"><span class="annottext">EarlySecretInfo -&gt; IO EarlySecretInfo
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(EarlySecretInfo -&gt; IO EarlySecretInfo)
-&gt; EarlySecretInfo -&gt; IO EarlySecretInfo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; ClientTrafficSecret EarlySecret -&gt; EarlySecretInfo
</span><a href="Network.TLS.Handshake.Control.html#EarlySecretInfo"><span class="hs-identifier hs-var">EarlySecretInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679194774"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ClientTrafficSecret EarlySecret
</span><a href="#local-6989586621679194781"><span class="hs-identifier hs-var">clientEarlySecret</span></a></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span>        </span><span id="local-6989586621679194367"><span class="annot"><span class="annottext">recvServerHello :: Session -&gt; [ExtensionID] -&gt; IO ()
</span><a href="#local-6989586621679194367"><span class="hs-identifier hs-var hs-var">recvServerHello</span></a></span></span><span> </span><span id="local-6989586621679194794"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194794"><span class="hs-identifier hs-var">clientSession</span></a></span></span><span> </span><span id="local-6989586621679194795"><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679194795"><span class="hs-identifier hs-var">sentExts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; RecvState IO -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common.html#runRecvState"><span class="hs-identifier hs-var">runRecvState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">RecvState IO
</span><a href="#local-6989586621679194797"><span class="hs-identifier hs-var">recvState</span></a></span><span>
</span><span id="line-328"></span><span>          </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679194797"><span class="annot"><span class="annottext">recvState :: RecvState IO
</span><a href="#local-6989586621679194797"><span class="hs-identifier hs-var hs-var">recvState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Packet -&gt; IO (RecvState IO)) -&gt; RecvState IO
forall (m :: * -&gt; *). (Packet -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateNext"><span class="hs-identifier hs-var">RecvStateNext</span></a></span><span> </span><span class="annot"><span class="annottext">((Packet -&gt; IO (RecvState IO)) -&gt; RecvState IO)
-&gt; (Packet -&gt; IO (RecvState IO)) -&gt; RecvState IO
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679194815"><span class="annot"><span class="annottext">Packet
</span><a href="#local-6989586621679194815"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-329"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Packet
</span><a href="#local-6989586621679194815"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-330"></span><span>                        </span><span class="annot"><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span id="local-6989586621679194816"><span class="annot"><span class="annottext">[Handshake]
</span><a href="#local-6989586621679194816"><span class="hs-identifier hs-var">hs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context -&gt; RecvState IO -&gt; [Handshake] -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Common.html#onRecvStateHandshake"><span class="hs-identifier hs-var">onRecvStateHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Handshake -&gt; IO (RecvState IO)) -&gt; RecvState IO
forall (m :: * -&gt; *). (Handshake -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateHandshake"><span class="hs-identifier hs-var">RecvStateHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">((Handshake -&gt; IO (RecvState IO)) -&gt; RecvState IO)
-&gt; (Handshake -&gt; IO (RecvState IO)) -&gt; RecvState IO
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; ClientParams
-&gt; Session
-&gt; [ExtensionID]
-&gt; Handshake
-&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#onServerHello"><span class="hs-identifier hs-var">onServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194356"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679194794"><span class="hs-identifier hs-var">clientSession</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679194795"><span class="hs-identifier hs-var">sentExts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Handshake]
</span><a href="#local-6989586621679194816"><span class="hs-identifier hs-var">hs</span></a></span><span> </span><span class="hs-comment">-- this adds SH to hstHandshakeMessages</span><span>
</span><span id="line-331"></span><span>                        </span><span class="annot"><a href="Network.TLS.Struct.html#Alert"><span class="hs-identifier hs-type">Alert</span></a></span><span> </span><span id="local-6989586621679194821"><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)]
</span><a href="#local-6989586621679194821"><span class="hs-identifier hs-var">a</span></a></span></span><span>      </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-332"></span><span>                            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)]
</span><a href="#local-6989586621679194821"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-333"></span><span>                                </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">AlertLevel
</span><a href="Network.TLS.Struct.html#AlertLevel_Warning"><span class="hs-identifier hs-var">AlertLevel_Warning</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnrecognizedName"><span class="hs-identifier hs-var">UnrecognizedName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-334"></span><span>                                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Bool
</span><a href="Network.TLS.Parameters.html#clientUseServerNameIndication"><span class="hs-identifier hs-var">clientUseServerNameIndication</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194355"><span class="hs-identifier hs-var">cparams</span></a></span><span>
</span><span id="line-335"></span><span>                                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">RecvState IO -&gt; IO (RecvState IO)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">RecvState IO
</span><a href="#local-6989586621679194797"><span class="hs-identifier hs-var">recvState</span></a></span><span>
</span><span id="line-336"></span><span>                                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)] -&gt; IO (RecvState IO)
forall {m :: * -&gt; *} {a} {a}. (MonadIO m, Show a) =&gt; a -&gt; m a
</span><a href="#local-6989586621679194824"><span class="hs-identifier hs-var">throwAlert</span></a></span><span> </span><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)]
</span><a href="#local-6989586621679194821"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-337"></span><span>                                </span><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)] -&gt; IO (RecvState IO)
forall {m :: * -&gt; *} {a} {a}. (MonadIO m, Show a) =&gt; a -&gt; m a
</span><a href="#local-6989586621679194824"><span class="hs-identifier hs-var">throwAlert</span></a></span><span> </span><span class="annot"><span class="annottext">[(AlertLevel, AlertDescription)]
</span><a href="#local-6989586621679194821"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-338"></span><span>                        </span><span class="annot"><span class="annottext">Packet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; IO (RecvState IO)
forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Packet -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Packet
</span><a href="#local-6989586621679194815"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;handshake&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>                </span><span id="local-6989586621679194824"><span class="annot"><span class="annottext">throwAlert :: a -&gt; m a
</span><a href="#local-6989586621679194824"><span class="hs-identifier hs-var hs-var">throwAlert</span></a></span></span><span> </span><span id="local-6989586621679194840"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679194840"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; m a) -&gt; TLSError -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;expecting server hello, got alert : &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679194840"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span class="hs-comment">-- | Store the keypair and check that it is compatible with the current protocol</span><span>
</span><span id="line-342"></span><span class="hs-comment">-- version and a list of 'CertificateType' values.</span><span>
</span><span id="line-343"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#storePrivInfoClient"><span class="hs-identifier hs-type">storePrivInfoClient</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-344"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#CertificateType"><span class="hs-identifier hs-type">CertificateType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-345"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Credentials.html#Credential"><span class="hs-identifier hs-type">Credential</span></a></span><span>
</span><span id="line-346"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span id="storePrivInfoClient"><span class="annot"><span class="annottext">storePrivInfoClient :: Context -&gt; [CertificateType] -&gt; Credential -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#storePrivInfoClient"><span class="hs-identifier hs-var hs-var">storePrivInfoClient</span></a></span></span><span> </span><span id="local-6989586621679194842"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194842"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679194843"><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679194843"><span class="hs-identifier hs-var">cTypes</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679194844"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679194844"><span class="hs-identifier hs-var">cc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194845"><span class="annot"><span class="annottext">PrivKey
</span><a href="#local-6989586621679194845"><span class="hs-identifier hs-var">privkey</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-348"></span><span>    </span><span id="local-6989586621679194846"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679194846"><span class="hs-identifier hs-var">pubkey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; CertificateChain -&gt; PrivKey -&gt; IO PubKey
forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; CertificateChain -&gt; PrivKey -&gt; m PubKey
</span><a href="Network.TLS.Handshake.Common.html#storePrivInfo"><span class="hs-identifier hs-var">storePrivInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194842"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679194844"><span class="hs-identifier hs-var">cc</span></a></span><span> </span><span class="annot"><span class="annottext">PrivKey
</span><a href="#local-6989586621679194845"><span class="hs-identifier hs-var">privkey</span></a></span><span>
</span><span id="line-349"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PubKey -&gt; [CertificateType] -&gt; Bool
</span><a href="Network.TLS.Handshake.Signature.html#certificateCompatible"><span class="hs-identifier hs-var">certificateCompatible</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679194846"><span class="hs-identifier hs-var">pubkey</span></a></span><span> </span><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679194843"><span class="hs-identifier hs-var">cTypes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span>
</span><span id="line-351"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; String
</span><a href="Network.TLS.X509.html#pubkeyType"><span class="hs-identifier hs-var">pubkeyType</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679194846"><span class="hs-identifier hs-var">pubkey</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; credential does not match allowed certificate types&quot;</span></span><span>
</span><span id="line-352"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-353"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#InternalError"><span class="hs-identifier hs-var">InternalError</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>    </span><span id="local-6989586621679194851"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194851"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Version -&gt; IO Version
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194842"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679194846"><span class="hs-identifier hs-var">pubkey</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; Version -&gt; Bool
</span><a href="Network.TLS.Handshake.Key.html#versionCompatible"><span class="hs-operator hs-var">`versionCompatible`</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194851"><span class="hs-identifier hs-var">ver</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-356"></span><span>        </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span>
</span><span id="line-357"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; String
</span><a href="Network.TLS.X509.html#pubkeyType"><span class="hs-identifier hs-var">pubkeyType</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679194846"><span class="hs-identifier hs-var">pubkey</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; credential is not supported at version &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Version -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194851"><span class="hs-identifier hs-var">ver</span></a></span><span>
</span><span id="line-358"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-359"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#InternalError"><span class="hs-identifier hs-var">InternalError</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>
</span><span id="line-361"></span><span class="hs-comment">-- | When the server requests a client certificate, we try to</span><span>
</span><span id="line-362"></span><span class="hs-comment">-- obtain a suitable certificate chain and private key via the</span><span>
</span><span id="line-363"></span><span class="hs-comment">-- callback in the client parameters.  It is OK for the callback</span><span>
</span><span id="line-364"></span><span class="hs-comment">-- to return an empty chain, in many cases the client certificate</span><span>
</span><span id="line-365"></span><span class="hs-comment">-- is optional.  If the client wishes to abort the handshake for</span><span>
</span><span id="line-366"></span><span class="hs-comment">-- lack of a suitable certificate, it can throw an exception in</span><span>
</span><span id="line-367"></span><span class="hs-comment">-- the callback.</span><span>
</span><span id="line-368"></span><span class="hs-comment">--</span><span>
</span><span id="line-369"></span><span class="hs-comment">-- The return value is 'Nothing' when no @CertificateRequest@ was</span><span>
</span><span id="line-370"></span><span class="hs-comment">-- received and no @Certificate@ message needs to be sent. An empty</span><span>
</span><span id="line-371"></span><span class="hs-comment">-- chain means that an empty @Certificate@ message needs to be sent</span><span>
</span><span id="line-372"></span><span class="hs-comment">-- to the server, naturally without a @CertificateVerify@.  A non-empty</span><span>
</span><span id="line-373"></span><span class="hs-comment">-- 'CertificateChain' is the chain to send to the server along with</span><span>
</span><span id="line-374"></span><span class="hs-comment">-- a corresponding 'CertificateVerify'.</span><span>
</span><span id="line-375"></span><span class="hs-comment">--</span><span>
</span><span id="line-376"></span><span class="hs-comment">-- With TLS &lt; 1.2 the server's @CertificateRequest@ does not carry</span><span>
</span><span id="line-377"></span><span class="hs-comment">-- a signature algorithm list.  It has a list of supported public</span><span>
</span><span id="line-378"></span><span class="hs-comment">-- key signing algorithms in the @certificate_types@ field.  The</span><span>
</span><span id="line-379"></span><span class="hs-comment">-- hash is implicit.  It is 'SHA1' for DSS and 'SHA1_MD5' for RSA.</span><span>
</span><span id="line-380"></span><span class="hs-comment">--</span><span>
</span><span id="line-381"></span><span class="hs-comment">-- With TLS == 1.2 the server's @CertificateRequest@ always has a</span><span>
</span><span id="line-382"></span><span class="hs-comment">-- @supported_signature_algorithms@ list, as a fixed component of</span><span>
</span><span id="line-383"></span><span class="hs-comment">-- the structure.  This list is (wrongly) overloaded to also limit</span><span>
</span><span id="line-384"></span><span class="hs-comment">-- X.509 signatures in the client's certificate chain.  The BCP</span><span>
</span><span id="line-385"></span><span class="hs-comment">-- strategy is to find a compatible chain if possible, but else</span><span>
</span><span id="line-386"></span><span class="hs-comment">-- ignore the constraint, and let the server verify the chain as it</span><span>
</span><span id="line-387"></span><span class="hs-comment">-- sees fit.  The @supported_signature_algorithms@ field is only</span><span>
</span><span id="line-388"></span><span class="hs-comment">-- obligatory with respect to signatures on TLS messages, in this</span><span>
</span><span id="line-389"></span><span class="hs-comment">-- case the @CertificateVerify@ message.  The @certificate_types@</span><span>
</span><span id="line-390"></span><span class="hs-comment">-- field is still included.</span><span>
</span><span id="line-391"></span><span class="hs-comment">--</span><span>
</span><span id="line-392"></span><span class="hs-comment">-- With TLS 1.3 the server's @CertificateRequest@ has a mandatory</span><span>
</span><span id="line-393"></span><span class="hs-comment">-- @signature_algorithms@ extension, the @signature_algorithms_cert@</span><span>
</span><span id="line-394"></span><span class="hs-comment">-- extension, which is optional, carries a list of algorithms the</span><span>
</span><span id="line-395"></span><span class="hs-comment">-- server promises to support in verifying the certificate chain.</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- As with TLS 1.2, the client's makes a /best-effort/ to deliver</span><span>
</span><span id="line-397"></span><span class="hs-comment">-- a compatible certificate chain where all the CA signatures are</span><span>
</span><span id="line-398"></span><span class="hs-comment">-- known to be supported, but it should not abort the connection</span><span>
</span><span id="line-399"></span><span class="hs-comment">-- just because the chain might not work out, just send the best</span><span>
</span><span id="line-400"></span><span class="hs-comment">-- chain you have and let the server worry about the rest.  The</span><span>
</span><span id="line-401"></span><span class="hs-comment">-- supported public key algorithms are now inferred from the</span><span>
</span><span id="line-402"></span><span class="hs-comment">-- @signature_algorithms@ extension and @certificate_types@ is</span><span>
</span><span id="line-403"></span><span class="hs-comment">-- gone.</span><span>
</span><span id="line-404"></span><span class="hs-comment">--</span><span>
</span><span id="line-405"></span><span class="hs-comment">-- With TLS 1.3, we synthesize and store a @certificate_types@</span><span>
</span><span id="line-406"></span><span class="hs-comment">-- field at the time that the server's @CertificateRequest@</span><span>
</span><span id="line-407"></span><span class="hs-comment">-- message is received.  This is then present across all the</span><span>
</span><span id="line-408"></span><span class="hs-comment">-- protocol versions, and can be used to determine whether</span><span>
</span><span id="line-409"></span><span class="hs-comment">-- a @CertificateRequest@ was received or not.</span><span>
</span><span id="line-410"></span><span class="hs-comment">--</span><span>
</span><span id="line-411"></span><span class="hs-comment">-- If @signature_algorithms@ is 'Nothing', then we're doing</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- TLS 1.0 or 1.1.  The @signature_algorithms_cert@ extension</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- is optional in TLS 1.3, and so the application callback</span><span>
</span><span id="line-414"></span><span class="hs-comment">-- will not be able to distinguish between TLS 1.[01] and</span><span>
</span><span id="line-415"></span><span class="hs-comment">-- TLS 1.3 with no certificate algorithm hints, but this</span><span>
</span><span id="line-416"></span><span class="hs-comment">-- just simplifies the chain selection process, all CA</span><span>
</span><span id="line-417"></span><span class="hs-comment">-- signatures are OK.</span><span>
</span><span id="line-418"></span><span class="hs-comment">--</span><span>
</span><span id="line-419"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#clientChain"><span class="hs-identifier hs-type">clientChain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ClientParams"><span class="hs-identifier hs-type">ClientParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">CertificateChain</span></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span id="clientChain"><span class="annot"><span class="annottext">clientChain :: ClientParams -&gt; Context -&gt; IO (Maybe CertificateChain)
</span><a href="Network.TLS.Handshake.Client.html#clientChain"><span class="hs-identifier hs-var hs-var">clientChain</span></a></span></span><span> </span><span id="local-6989586621679194857"><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194857"><span class="hs-identifier hs-var">cparams</span></a></span></span><span> </span><span id="local-6989586621679194858"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194858"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-421"></span><span>    </span><span class="annot"><span class="annottext">Context
-&gt; HandshakeM (Maybe CertReqCBdata) -&gt; IO (Maybe CertReqCBdata)
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194858"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM (Maybe CertReqCBdata)
</span><a href="Network.TLS.Handshake.State.html#getCertReqCBdata"><span class="hs-identifier hs-var">getCertReqCBdata</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe CertReqCBdata)
-&gt; (Maybe CertReqCBdata -&gt; IO (Maybe CertificateChain))
-&gt; IO (Maybe CertificateChain)
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-422"></span><span>        </span><span class="annot"><span class="annottext">Maybe CertReqCBdata
</span><span class="hs-identifier hs-var">Nothing</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe CertificateChain -&gt; IO (Maybe CertificateChain)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe CertificateChain
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-423"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679194860"><span class="annot"><span class="annottext">CertReqCBdata
</span><a href="#local-6989586621679194860"><span class="hs-identifier hs-var">cbdata</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-424"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194861"><span class="annot"><span class="annottext">callback :: OnCertificateRequest
</span><a href="#local-6989586621679194861"><span class="hs-identifier hs-var hs-var">callback</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClientHooks -&gt; OnCertificateRequest
</span><a href="Network.TLS.Parameters.html#onCertificateRequest"><span class="hs-identifier hs-var">onCertificateRequest</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientHooks -&gt; OnCertificateRequest)
-&gt; ClientHooks -&gt; OnCertificateRequest
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; ClientHooks
</span><a href="Network.TLS.Parameters.html#clientHooks"><span class="hs-identifier hs-var">clientHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194857"><span class="hs-identifier hs-var">cparams</span></a></span><span>
</span><span id="line-425"></span><span>            </span><span id="local-6989586621679194863"><span class="annot"><span class="annottext">Maybe Credential
</span><a href="#local-6989586621679194863"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Maybe Credential) -&gt; IO (Maybe Credential)
forall a. IO a -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe Credential) -&gt; IO (Maybe Credential))
-&gt; IO (Maybe Credential) -&gt; IO (Maybe Credential)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OnCertificateRequest
</span><a href="#local-6989586621679194861"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">CertReqCBdata
</span><a href="#local-6989586621679194860"><span class="hs-identifier hs-var">cbdata</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe Credential)
-&gt; (SomeException -&gt; IO (Maybe Credential))
-&gt; IO (Maybe Credential)
forall a. IO a -&gt; (SomeException -&gt; IO a) -&gt; IO a
</span><a href="Network.TLS.Util.html#catchException"><span class="hs-operator hs-var">`catchException`</span></a></span><span>
</span><span id="line-426"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; SomeException -&gt; IO (Maybe Credential)
forall a. String -&gt; SomeException -&gt; IO a
</span><a href="Network.TLS.Handshake.Client.html#throwMiscErrorOnException"><span class="hs-identifier hs-var">throwMiscErrorOnException</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;certificate request callback failed&quot;</span></span><span>
</span><span id="line-427"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Credential
</span><a href="#local-6989586621679194863"><span class="hs-identifier hs-var">chain</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-428"></span><span>                </span><span class="annot"><span class="annottext">Maybe Credential
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-429"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe CertificateChain -&gt; IO (Maybe CertificateChain)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe CertificateChain -&gt; IO (Maybe CertificateChain))
-&gt; Maybe CertificateChain -&gt; IO (Maybe CertificateChain)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; Maybe CertificateChain
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(CertificateChain -&gt; Maybe CertificateChain)
-&gt; CertificateChain -&gt; Maybe CertificateChain
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SignedExact Certificate] -&gt; CertificateChain
</span><span class="hs-identifier hs-var">CertificateChain</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-430"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CertificateChain</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrivKey
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe CertificateChain -&gt; IO (Maybe CertificateChain)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe CertificateChain -&gt; IO (Maybe CertificateChain))
-&gt; Maybe CertificateChain -&gt; IO (Maybe CertificateChain)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; Maybe CertificateChain
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(CertificateChain -&gt; Maybe CertificateChain)
-&gt; CertificateChain -&gt; Maybe CertificateChain
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SignedExact Certificate] -&gt; CertificateChain
</span><span class="hs-identifier hs-var">CertificateChain</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-432"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679194866"><span class="annot"><span class="annottext">cred :: Credential
</span><a href="#local-6989586621679194866"><span class="hs-identifier hs-var">cred</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621679194867"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679194867"><span class="hs-identifier hs-var">cc</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrivKey
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-434"></span><span>                       </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679194868"><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679194868"><span class="hs-identifier hs-var">cTypes</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe [HashAndSignatureAlgorithm]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DistinguishedName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CertReqCBdata
</span><a href="#local-6989586621679194860"><span class="hs-identifier hs-var">cbdata</span></a></span><span>
</span><span id="line-435"></span><span>                       </span><span class="annot"><span class="annottext">Context -&gt; [CertificateType] -&gt; Credential -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#storePrivInfoClient"><span class="hs-identifier hs-var">storePrivInfoClient</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194858"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679194868"><span class="hs-identifier hs-var">cTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Credential
</span><a href="#local-6989586621679194866"><span class="hs-identifier hs-var">cred</span></a></span><span>
</span><span id="line-436"></span><span>                       </span><span class="annot"><span class="annottext">Maybe CertificateChain -&gt; IO (Maybe CertificateChain)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe CertificateChain -&gt; IO (Maybe CertificateChain))
-&gt; Maybe CertificateChain -&gt; IO (Maybe CertificateChain)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; Maybe CertificateChain
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679194867"><span class="hs-identifier hs-var">cc</span></a></span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span class="hs-comment">-- | Return a most preferred 'HandAndSignatureAlgorithm' that is compatible with</span><span>
</span><span id="line-439"></span><span class="hs-comment">-- the local key and server's signature algorithms (both already saved).  Must</span><span>
</span><span id="line-440"></span><span class="hs-comment">-- only be called for TLS versions 1.2 and up, with compatibility function</span><span>
</span><span id="line-441"></span><span class="hs-comment">-- 'signatureCompatible' or 'signatureCompatible13' based on version.</span><span>
</span><span id="line-442"></span><span class="hs-comment">--</span><span>
</span><span id="line-443"></span><span class="hs-comment">-- The values in the server's @signature_algorithms@ extension are</span><span>
</span><span id="line-444"></span><span class="hs-comment">-- in descending order of preference.  However here the algorithms</span><span>
</span><span id="line-445"></span><span class="hs-comment">-- are selected by client preference in @cHashSigs@.</span><span>
</span><span id="line-446"></span><span class="hs-comment">--</span><span>
</span><span id="line-447"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#getLocalHashSigAlg"><span class="hs-identifier hs-type">getLocalHashSigAlg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-448"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">PubKey</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#HashAndSignatureAlgorithm"><span class="hs-identifier hs-type">HashAndSignatureAlgorithm</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#HashAndSignatureAlgorithm"><span class="hs-identifier hs-type">HashAndSignatureAlgorithm</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-450"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PubKey</span></span><span>
</span><span id="line-451"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#HashAndSignatureAlgorithm"><span class="hs-identifier hs-type">HashAndSignatureAlgorithm</span></a></span><span>
</span><span id="line-452"></span><span id="getLocalHashSigAlg"><span class="annot"><span class="annottext">getLocalHashSigAlg :: Context
-&gt; (PubKey -&gt; HashAndSignatureAlgorithm -&gt; Bool)
-&gt; [HashAndSignatureAlgorithm]
-&gt; PubKey
-&gt; IO HashAndSignatureAlgorithm
</span><a href="Network.TLS.Handshake.Client.html#getLocalHashSigAlg"><span class="hs-identifier hs-var hs-var">getLocalHashSigAlg</span></a></span></span><span> </span><span id="local-6989586621679194872"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194872"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679194873"><span class="annot"><span class="annottext">PubKey -&gt; HashAndSignatureAlgorithm -&gt; Bool
</span><a href="#local-6989586621679194873"><span class="hs-identifier hs-var">isCompatible</span></a></span></span><span> </span><span id="local-6989586621679194874"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679194874"><span class="hs-identifier hs-var">cHashSigs</span></a></span></span><span> </span><span id="local-6989586621679194875"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679194875"><span class="hs-identifier hs-var">pubKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-453"></span><span>    </span><span class="hs-comment">-- Must be present with TLS 1.2 and up.</span><span>
</span><span id="line-454"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CertificateType]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679194876"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679194876"><span class="hs-identifier hs-var">hashSigs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DistinguishedName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; HandshakeM (Maybe CertReqCBdata) -&gt; IO (Maybe CertReqCBdata)
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194872"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM (Maybe CertReqCBdata)
</span><a href="Network.TLS.Handshake.State.html#getCertReqCBdata"><span class="hs-identifier hs-var">getCertReqCBdata</span></a></span><span>
</span><span id="line-455"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194888"><span class="annot"><span class="annottext">want :: HashAndSignatureAlgorithm -&gt; Bool
</span><a href="#local-6989586621679194888"><span class="hs-identifier hs-var hs-var">want</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">(&amp;&amp;)</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool -&gt; Bool)
-&gt; (HashAndSignatureAlgorithm -&gt; Bool)
-&gt; HashAndSignatureAlgorithm
-&gt; Bool
-&gt; Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; HashAndSignatureAlgorithm -&gt; Bool
</span><a href="#local-6989586621679194873"><span class="hs-identifier hs-var">isCompatible</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679194875"><span class="hs-identifier hs-var">pubKey</span></a></span><span>
</span><span id="line-456"></span><span>                    </span><span class="annot"><span class="annottext">(HashAndSignatureAlgorithm -&gt; Bool -&gt; Bool)
-&gt; (HashAndSignatureAlgorithm -&gt; Bool)
-&gt; HashAndSignatureAlgorithm
-&gt; Bool
forall a b.
(HashAndSignatureAlgorithm -&gt; a -&gt; b)
-&gt; (HashAndSignatureAlgorithm -&gt; a)
-&gt; HashAndSignatureAlgorithm
-&gt; b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(HashAndSignatureAlgorithm -&gt; [HashAndSignatureAlgorithm] -&gt; Bool)
-&gt; [HashAndSignatureAlgorithm] -&gt; HashAndSignatureAlgorithm -&gt; Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm -&gt; [HashAndSignatureAlgorithm] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">elem</span></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679194876"><span class="hs-identifier hs-var">hashSigs</span></a></span><span>
</span><span id="line-457"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(HashAndSignatureAlgorithm -&gt; Bool)
-&gt; [HashAndSignatureAlgorithm] -&gt; Maybe HashAndSignatureAlgorithm
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm -&gt; Bool
</span><a href="#local-6989586621679194888"><span class="hs-identifier hs-var">want</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679194874"><span class="hs-identifier hs-var">cHashSigs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-458"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679194890"><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679194890"><span class="hs-identifier hs-var">best</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm -&gt; IO HashAndSignatureAlgorithm
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679194890"><span class="hs-identifier hs-var">best</span></a></span><span>
</span><span id="line-459"></span><span>        </span><span class="annot"><span class="annottext">Maybe HashAndSignatureAlgorithm
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO HashAndSignatureAlgorithm
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO HashAndSignatureAlgorithm)
-&gt; TLSError -&gt; IO HashAndSignatureAlgorithm
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span>
</span><span id="line-460"></span><span>                         </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; String
</span><a href="#local-6989586621679194891"><span class="hs-identifier hs-var">keyerr</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679194875"><span class="hs-identifier hs-var">pubKey</span></a></span><span>
</span><span id="line-461"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-462"></span><span>                         </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span>
</span><span id="line-463"></span><span>                         </span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-465"></span><span>    </span><span id="local-6989586621679194891"><span class="annot"><span class="annottext">keyerr :: PubKey -&gt; String
</span><a href="#local-6989586621679194891"><span class="hs-identifier hs-var hs-var">keyerr</span></a></span></span><span> </span><span id="local-6989586621679194895"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679194895"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;no &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; String
</span><a href="Network.TLS.X509.html#pubkeyType"><span class="hs-identifier hs-var">pubkeyType</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679194895"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; hash algorithm in common with the server&quot;</span></span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span class="hs-comment">-- | Return the supported 'CertificateType' values that are</span><span>
</span><span id="line-468"></span><span class="hs-comment">-- compatible with at least one supported signature algorithm.</span><span>
</span><span id="line-469"></span><span class="hs-comment">--</span><span>
</span><span id="line-470"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#supportedCtypes"><span class="hs-identifier hs-type">supportedCtypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#HashAndSignatureAlgorithm"><span class="hs-identifier hs-type">HashAndSignatureAlgorithm</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-471"></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#CertificateType"><span class="hs-identifier hs-type">CertificateType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-472"></span><span id="supportedCtypes"><span class="annot"><span class="annottext">supportedCtypes :: [HashAndSignatureAlgorithm] -&gt; [CertificateType]
</span><a href="Network.TLS.Handshake.Client.html#supportedCtypes"><span class="hs-identifier hs-var hs-var">supportedCtypes</span></a></span></span><span> </span><span id="local-6989586621679194897"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679194897"><span class="hs-identifier hs-var">hashAlgs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-473"></span><span>    </span><span class="annot"><span class="annottext">[CertificateType] -&gt; [CertificateType]
forall a. Eq a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">nub</span></span><span> </span><span class="annot"><span class="annottext">([CertificateType] -&gt; [CertificateType])
-&gt; [CertificateType] -&gt; [CertificateType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HashAndSignatureAlgorithm
 -&gt; [CertificateType] -&gt; [CertificateType])
-&gt; [CertificateType]
-&gt; [HashAndSignatureAlgorithm]
-&gt; [CertificateType]
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm -&gt; [CertificateType] -&gt; [CertificateType]
</span><a href="#local-6989586621679194900"><span class="hs-identifier hs-var">ctfilter</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679194897"><span class="hs-identifier hs-var">hashAlgs</span></a></span><span>
</span><span id="line-474"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-475"></span><span>    </span><span id="local-6989586621679194900"><span class="annot"><span class="annottext">ctfilter :: HashAndSignatureAlgorithm -&gt; [CertificateType] -&gt; [CertificateType]
</span><a href="#local-6989586621679194900"><span class="hs-identifier hs-var hs-var">ctfilter</span></a></span></span><span> </span><span id="local-6989586621679194903"><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679194903"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679194904"><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679194904"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm -&gt; Maybe CertificateType
</span><a href="Network.TLS.Handshake.Signature.html#hashSigToCertType"><span class="hs-identifier hs-var">hashSigToCertType</span></a></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679194903"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-476"></span><span>       </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679194906"><span class="annot"><span class="annottext">CertificateType
</span><a href="#local-6989586621679194906"><span class="hs-identifier hs-var">cType</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CertificateType
</span><a href="#local-6989586621679194906"><span class="hs-identifier hs-var">cType</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateType -&gt; CertificateType -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">CertificateType
</span><a href="Network.TLS.Struct.html#lastSupportedCertificateType"><span class="hs-identifier hs-var">lastSupportedCertificateType</span></a></span><span>
</span><span id="line-477"></span><span>                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CertificateType
</span><a href="#local-6989586621679194906"><span class="hs-identifier hs-var">cType</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateType -&gt; [CertificateType] -&gt; [CertificateType]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679194904"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-478"></span><span>       </span><span class="annot"><span class="annottext">Maybe CertificateType
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679194904"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-479"></span><span class="hs-comment">--</span><span>
</span><span id="line-480"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#clientSupportedCtypes"><span class="hs-identifier hs-type">clientSupportedCtypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-481"></span><span>                      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#CertificateType"><span class="hs-identifier hs-type">CertificateType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-482"></span><span id="clientSupportedCtypes"><span class="annot"><span class="annottext">clientSupportedCtypes :: Context -&gt; [CertificateType]
</span><a href="Network.TLS.Handshake.Client.html#clientSupportedCtypes"><span class="hs-identifier hs-var hs-var">clientSupportedCtypes</span></a></span></span><span> </span><span id="local-6989586621679194909"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194909"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-483"></span><span>    </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm] -&gt; [CertificateType]
</span><a href="Network.TLS.Handshake.Client.html#supportedCtypes"><span class="hs-identifier hs-var">supportedCtypes</span></a></span><span> </span><span class="annot"><span class="annottext">([HashAndSignatureAlgorithm] -&gt; [CertificateType])
-&gt; [HashAndSignatureAlgorithm] -&gt; [CertificateType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [HashAndSignatureAlgorithm]
</span><a href="Network.TLS.Parameters.html#supportedHashSignatures"><span class="hs-identifier hs-var">supportedHashSignatures</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [HashAndSignatureAlgorithm])
-&gt; Supported -&gt; [HashAndSignatureAlgorithm]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194909"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-484"></span><span class="hs-comment">--</span><span>
</span><span id="line-485"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#sigAlgsToCertTypes"><span class="hs-identifier hs-type">sigAlgsToCertTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span>
</span><span id="line-486"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#HashAndSignatureAlgorithm"><span class="hs-identifier hs-type">HashAndSignatureAlgorithm</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-487"></span><span>                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#CertificateType"><span class="hs-identifier hs-type">CertificateType</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-488"></span><span id="sigAlgsToCertTypes"><span class="annot"><span class="annottext">sigAlgsToCertTypes :: Context -&gt; [HashAndSignatureAlgorithm] -&gt; [CertificateType]
</span><a href="Network.TLS.Handshake.Client.html#sigAlgsToCertTypes"><span class="hs-identifier hs-var hs-var">sigAlgsToCertTypes</span></a></span></span><span> </span><span id="local-6989586621679194911"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194911"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679194912"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679194912"><span class="hs-identifier hs-var">hashSigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-489"></span><span>    </span><span class="annot"><span class="annottext">(CertificateType -&gt; Bool) -&gt; [CertificateType] -&gt; [CertificateType]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CertificateType -&gt; [CertificateType] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm] -&gt; [CertificateType]
</span><a href="Network.TLS.Handshake.Client.html#supportedCtypes"><span class="hs-identifier hs-var">supportedCtypes</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679194912"><span class="hs-identifier hs-var">hashSigs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([CertificateType] -&gt; [CertificateType])
-&gt; [CertificateType] -&gt; [CertificateType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; [CertificateType]
</span><a href="Network.TLS.Handshake.Client.html#clientSupportedCtypes"><span class="hs-identifier hs-var">clientSupportedCtypes</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194911"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span class="hs-comment">-- | TLS 1.2 and below.  Send the client handshake messages that</span><span>
</span><span id="line-492"></span><span class="hs-comment">-- follow the @ServerHello@, etc. except for @CCS@ and @Finished@.</span><span>
</span><span id="line-493"></span><span class="hs-comment">--</span><span>
</span><span id="line-494"></span><span class="hs-comment">-- XXX: Is any buffering done here to combined these messages into</span><span>
</span><span id="line-495"></span><span class="hs-comment">-- a single TCP packet?  Otherwise we're prone to Nagle delays, or</span><span>
</span><span id="line-496"></span><span class="hs-comment">-- in any case needlessly generate multiple small packets, where</span><span>
</span><span id="line-497"></span><span class="hs-comment">-- a single larger packet will do.  The TLS 1.3 code path seems</span><span>
</span><span id="line-498"></span><span class="hs-comment">-- to separating record generation and transmission and sending</span><span>
</span><span id="line-499"></span><span class="hs-comment">-- multiple records in a single packet.</span><span>
</span><span id="line-500"></span><span class="hs-comment">--</span><span>
</span><span id="line-501"></span><span class="hs-comment">--       -&gt; [certificate]</span><span>
</span><span id="line-502"></span><span class="hs-comment">--       -&gt; client key exchange</span><span>
</span><span id="line-503"></span><span class="hs-comment">--       -&gt; [cert verify]</span><span>
</span><span id="line-504"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#sendClientData"><span class="hs-identifier hs-type">sendClientData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ClientParams"><span class="hs-identifier hs-type">ClientParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-505"></span><span id="sendClientData"><span class="annot"><span class="annottext">sendClientData :: ClientParams -&gt; Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#sendClientData"><span class="hs-identifier hs-var hs-var">sendClientData</span></a></span></span><span> </span><span id="local-6989586621679194913"><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194913"><span class="hs-identifier hs-var">cparams</span></a></span></span><span> </span><span id="local-6989586621679194914"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679194915"><span class="hs-identifier hs-var">sendCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679194916"><span class="hs-identifier hs-var">sendClientKeyXchg</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679194917"><span class="hs-identifier hs-var">sendCertificateVerify</span></a></span><span>
</span><span id="line-506"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-507"></span><span>        </span><span id="local-6989586621679194915"><span class="annot"><span class="annottext">sendCertificate :: IO ()
</span><a href="#local-6989586621679194915"><span class="hs-identifier hs-var hs-var">sendCertificate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-508"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setClientCertSent"><span class="hs-identifier hs-var">setClientCertSent</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-509"></span><span>            </span><span class="annot"><span class="annottext">ClientParams -&gt; Context -&gt; IO (Maybe CertificateChain)
</span><a href="Network.TLS.Handshake.Client.html#clientChain"><span class="hs-identifier hs-var">clientChain</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194913"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe CertificateChain)
-&gt; (Maybe CertificateChain -&gt; IO ()) -&gt; IO ()
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-510"></span><span>                </span><span class="annot"><span class="annottext">Maybe CertificateChain
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-511"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679194927"><span class="annot"><span class="annottext">cc :: CertificateChain
</span><a href="#local-6989586621679194927"><span class="hs-identifier hs-var">cc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CertificateChain</span></span><span> </span><span id="local-6989586621679194928"><span class="annot"><span class="annottext">[SignedExact Certificate]
</span><a href="#local-6989586621679194928"><span class="hs-identifier hs-var">certs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-512"></span><span>                    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SignedExact Certificate] -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[SignedExact Certificate]
</span><a href="#local-6989586621679194928"><span class="hs-identifier hs-var">certs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-513"></span><span>                        </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setClientCertSent"><span class="hs-identifier hs-var">setClientCertSent</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-514"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; Packet -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier hs-var">sendPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet -&gt; IO ()) -&gt; Packet -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake] -&gt; Packet
</span><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-var">Handshake</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">CertificateChain -&gt; Handshake
</span><a href="Network.TLS.Struct.html#Certificates"><span class="hs-identifier hs-var">Certificates</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679194927"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-515"></span><span>
</span><span id="line-516"></span><span>        </span><span id="local-6989586621679194916"><span class="annot"><span class="annottext">sendClientKeyXchg :: IO ()
</span><a href="#local-6989586621679194916"><span class="hs-identifier hs-var hs-var">sendClientKeyXchg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-517"></span><span>            </span><span id="local-6989586621679194951"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679194951"><span class="hs-identifier hs-var">cipher</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM Cipher -&gt; IO Cipher
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM Cipher
</span><a href="Network.TLS.Handshake.State.html#getPendingCipher"><span class="hs-identifier hs-var">getPendingCipher</span></a></span><span>
</span><span id="line-518"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679194953"><span class="annot"><span class="annottext">ClientKeyXchgAlgorithmData
</span><a href="#local-6989586621679194953"><span class="hs-identifier hs-var">ckx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194954"><span class="annot"><span class="annottext">HandshakeM ByteString
</span><a href="#local-6989586621679194954"><span class="hs-identifier hs-var">setMasterSec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#cipherKeyExchange"><span class="hs-identifier hs-var">cipherKeyExchange</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679194951"><span class="hs-identifier hs-var">cipher</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-519"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_RSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-520"></span><span>                    </span><span id="local-6989586621679194957"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194957"><span class="hs-identifier hs-var">clientVersion</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM Version -&gt; IO Version
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM Version -&gt; IO Version)
-&gt; HandshakeM Version -&gt; IO Version
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(HandshakeState -&gt; Version) -&gt; HandshakeM Version
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">HandshakeState -&gt; Version
</span><a href="Network.TLS.Handshake.State.html#hstClientVersion"><span class="hs-identifier hs-var">hstClientVersion</span></a></span><span>
</span><span id="line-521"></span><span>                    </span><span class="hs-special">(</span><span id="local-6989586621679194960"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194960"><span class="hs-identifier hs-var">xver</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679194961"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194961"><span class="hs-identifier hs-var">prerand</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt (Version, ByteString) -&gt; IO (Version, ByteString)
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSSt (Version, ByteString) -&gt; IO (Version, ByteString))
-&gt; TLSSt (Version, ByteString) -&gt; IO (Version, ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Version -&gt; ByteString -&gt; (Version, ByteString))
-&gt; TLSSt Version -&gt; TLSSt (ByteString -&gt; (Version, ByteString))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt (ByteString -&gt; (Version, ByteString))
-&gt; TLSSt ByteString -&gt; TLSSt (Version, ByteString)
forall a b. TLSSt (a -&gt; b) -&gt; TLSSt a -&gt; TLSSt b
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TLSSt ByteString
</span><a href="Network.TLS.State.html#genRandom"><span class="hs-identifier hs-var">genRandom</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">46</span></span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194963"><span class="annot"><span class="annottext">premaster :: ByteString
</span><a href="#local-6989586621679194963"><span class="hs-identifier hs-var hs-var">premaster</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Version -&gt; ByteString -&gt; ByteString
</span><a href="Network.TLS.Packet.html#encodePreMasterSecret"><span class="hs-identifier hs-var">encodePreMasterSecret</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194957"><span class="hs-identifier hs-var">clientVersion</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194961"><span class="hs-identifier hs-var">prerand</span></a></span><span>
</span><span id="line-524"></span><span>                        </span><span id="local-6989586621679194967"><span class="annot"><span class="annottext">setMasterSec :: HandshakeM ByteString
</span><a href="#local-6989586621679194967"><span class="hs-identifier hs-var hs-var">setMasterSec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Version -&gt; Role -&gt; ByteString -&gt; HandshakeM ByteString
forall preMaster.
ByteArrayAccess preMaster =&gt;
Version -&gt; Role -&gt; preMaster -&gt; HandshakeM ByteString
</span><a href="Network.TLS.Handshake.State.html#setMasterSecretFromPre"><span class="hs-identifier hs-var">setMasterSecretFromPre</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194960"><span class="hs-identifier hs-var">xver</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ClientRole"><span class="hs-identifier hs-var">ClientRole</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194963"><span class="hs-identifier hs-var">premaster</span></a></span><span>
</span><span id="line-525"></span><span>                    </span><span id="local-6989586621679194969"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194969"><span class="hs-identifier hs-var">encryptedPreMaster</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-526"></span><span>                        </span><span class="hs-comment">-- SSL3 implementation generally forget this length field since it's redundant,</span><span>
</span><span id="line-527"></span><span>                        </span><span class="hs-comment">-- however TLS10 make it clear that the length field need to be present.</span><span>
</span><span id="line-528"></span><span>                        </span><span id="local-6989586621679194970"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194970"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; ByteString -&gt; IO ByteString
</span><a href="Network.TLS.Handshake.Key.html#encryptRSA"><span class="hs-identifier hs-var">encryptRSA</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194963"><span class="hs-identifier hs-var">premaster</span></a></span><span>
</span><span id="line-529"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679194977"><span class="annot"><span class="annottext">extra :: ByteString
</span><a href="#local-6989586621679194977"><span class="hs-identifier hs-var hs-var">extra</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679194960"><span class="hs-identifier hs-var">xver</span></a></span><span> </span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS10"><span class="hs-identifier hs-var">TLS10</span></a></span><span>
</span><span id="line-530"></span><span>                                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier hs-var">B.empty</span></span><span>
</span><span id="line-531"></span><span>                                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ByteString
</span><a href="Network.TLS.Wire.html#encodeWord16"><span class="hs-identifier hs-var">encodeWord16</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtensionID -&gt; ByteString) -&gt; ExtensionID -&gt; ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ExtensionID
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; ExtensionID) -&gt; Int -&gt; ExtensionID
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">B.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194970"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-532"></span><span>                        </span><span class="annot"><span class="annottext">ByteString -&gt; IO ByteString
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; IO ByteString) -&gt; ByteString -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194977"><span class="hs-identifier hs-var">extra</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; ByteString
</span><span class="hs-operator hs-var">`B.append`</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194970"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-533"></span><span>                    </span><span class="annot"><span class="annottext">(ClientKeyXchgAlgorithmData, HandshakeM ByteString)
-&gt; IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; ClientKeyXchgAlgorithmData
</span><a href="Network.TLS.Struct.html#CKX_RSA"><span class="hs-identifier hs-var">CKX_RSA</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194969"><span class="hs-identifier hs-var">encryptedPreMaster</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HandshakeM ByteString
</span><a href="#local-6989586621679194967"><span class="hs-identifier hs-var">setMasterSec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_RSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
</span><a href="#local-6989586621679194984"><span class="hs-identifier hs-var">getCKX_DHE</span></a></span><span>
</span><span id="line-535"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_DSS"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_DSS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
</span><a href="#local-6989586621679194984"><span class="hs-identifier hs-var">getCKX_DHE</span></a></span><span>
</span><span id="line-536"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_RSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
</span><a href="#local-6989586621679194987"><span class="hs-identifier hs-var">getCKX_ECDHE</span></a></span><span>
</span><span id="line-537"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_ECDSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_ECDSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
</span><a href="#local-6989586621679194987"><span class="hs-identifier hs-var">getCKX_ECDHE</span></a></span><span>
</span><span id="line-538"></span><span>                </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError
 -&gt; IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString))
-&gt; TLSError
-&gt; IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;client key exchange unsupported type&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; Packet -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier hs-var">sendPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet -&gt; IO ()) -&gt; Packet -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake] -&gt; Packet
</span><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-var">Handshake</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ClientKeyXchgAlgorithmData -&gt; Handshake
</span><a href="Network.TLS.Struct.html#ClientKeyXchg"><span class="hs-identifier hs-var">ClientKeyXchg</span></a></span><span> </span><span class="annot"><span class="annottext">ClientKeyXchgAlgorithmData
</span><a href="#local-6989586621679194953"><span class="hs-identifier hs-var">ckx</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-540"></span><span>            </span><span id="local-6989586621679194990"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194990"><span class="hs-identifier hs-var">masterSecret</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM ByteString -&gt; IO ByteString
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM ByteString
</span><a href="#local-6989586621679194954"><span class="hs-identifier hs-var">setMasterSec</span></a></span><span>
</span><span id="line-541"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; MasterSecret -&gt; IO ()
forall a. LogLabel a =&gt; Context -&gt; a -&gt; IO ()
</span><a href="Network.TLS.Handshake.Key.html#logKey"><span class="hs-identifier hs-var">logKey</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; MasterSecret
</span><a href="Network.TLS.Types.html#MasterSecret"><span class="hs-identifier hs-var">MasterSecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679194990"><span class="hs-identifier hs-var">masterSecret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-542"></span><span>          </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679194984"><span class="annot"><span class="annottext">getCKX_DHE :: IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
</span><a href="#local-6989586621679194984"><span class="hs-identifier hs-var hs-var">getCKX_DHE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-543"></span><span>                    </span><span id="local-6989586621679195018"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195018"><span class="hs-identifier hs-var">xver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Version -&gt; IO Version
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-544"></span><span>                    </span><span id="local-6989586621679195019"><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679195019"><span class="hs-identifier hs-var">serverParams</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM ServerDHParams -&gt; IO ServerDHParams
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM ServerDHParams
</span><a href="Network.TLS.Handshake.State.html#getServerDHParams"><span class="hs-identifier hs-var">getServerDHParams</span></a></span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195021"><span class="annot"><span class="annottext">params :: DHParams
</span><a href="#local-6989586621679195021"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerDHParams -&gt; DHParams
</span><a href="Network.TLS.Struct.html#serverDHParamsToParams"><span class="hs-identifier hs-var">serverDHParamsToParams</span></a></span><span> </span><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679195019"><span class="hs-identifier hs-var">serverParams</span></a></span><span>
</span><span id="line-547"></span><span>                        </span><span id="local-6989586621679195023"><span class="annot"><span class="annottext">ffGroup :: Maybe Group
</span><a href="#local-6989586621679195023"><span class="hs-identifier hs-var hs-var">ffGroup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DHParams -&gt; Maybe Group
</span><a href="Network.TLS.Crypto.html#findFiniteFieldGroup"><span class="hs-identifier hs-var">findFiniteFieldGroup</span></a></span><span> </span><span class="annot"><span class="annottext">DHParams
</span><a href="#local-6989586621679195021"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-548"></span><span>                        </span><span id="local-6989586621679195025"><span class="annot"><span class="annottext">srvpub :: DHPublic
</span><a href="#local-6989586621679195025"><span class="hs-identifier hs-var hs-var">srvpub</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerDHParams -&gt; DHPublic
</span><a href="Network.TLS.Struct.html#serverDHParamsToPublic"><span class="hs-identifier hs-var">serverDHParamsToPublic</span></a></span><span> </span><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679195019"><span class="hs-identifier hs-var">serverParams</span></a></span><span>
</span><span id="line-549"></span><span>
</span><span id="line-550"></span><span>                    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; (Group -&gt; Bool) -&gt; Maybe Group -&gt; Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Group -&gt; Bool
</span><a href="Network.TLS.Handshake.Common.html#isSupportedGroup"><span class="hs-identifier hs-var">isSupportedGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679195023"><span class="hs-identifier hs-var">ffGroup</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-551"></span><span>                        </span><span id="local-6989586621679195028"><span class="annot"><span class="annottext">GroupUsage
</span><a href="#local-6989586621679195028"><span class="hs-identifier hs-var">groupUsage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClientHooks -&gt; DHParams -&gt; DHPublic -&gt; IO GroupUsage
</span><a href="Network.TLS.Parameters.html#onCustomFFDHEGroup"><span class="hs-identifier hs-var">onCustomFFDHEGroup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientParams -&gt; ClientHooks
</span><a href="Network.TLS.Parameters.html#clientHooks"><span class="hs-identifier hs-var">clientHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679194913"><span class="hs-identifier hs-var">cparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DHParams
</span><a href="#local-6989586621679195021"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">DHPublic
</span><a href="#local-6989586621679195025"><span class="hs-identifier hs-var">srvpub</span></a></span><span> </span><span class="annot"><span class="annottext">IO GroupUsage -&gt; (SomeException -&gt; IO GroupUsage) -&gt; IO GroupUsage
forall a. IO a -&gt; (SomeException -&gt; IO a) -&gt; IO a
</span><a href="Network.TLS.Util.html#catchException"><span class="hs-operator hs-var">`catchException`</span></a></span><span>
</span><span id="line-552"></span><span>                                          </span><span class="annot"><span class="annottext">String -&gt; SomeException -&gt; IO GroupUsage
forall a. String -&gt; SomeException -&gt; IO a
</span><a href="Network.TLS.Handshake.Client.html#throwMiscErrorOnException"><span class="hs-identifier hs-var">throwMiscErrorOnException</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;custom group callback failed&quot;</span></span><span>
</span><span id="line-553"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">GroupUsage
</span><a href="#local-6989586621679195028"><span class="hs-identifier hs-var">groupUsage</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-554"></span><span>                            </span><span class="annot"><span class="annottext">GroupUsage
</span><a href="Network.TLS.Parameters.html#GroupUsageInsecure"><span class="hs-identifier hs-var">GroupUsageInsecure</span></a></span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;FFDHE group is not secure enough&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#InsufficientSecurity"><span class="hs-identifier hs-var">InsufficientSecurity</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-555"></span><span>                            </span><span class="annot"><a href="Network.TLS.Parameters.html#GroupUsageUnsupported"><span class="hs-identifier hs-type">GroupUsageUnsupported</span></a></span><span> </span><span id="local-6989586621679195033"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679195033"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unsupported FFDHE group: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679195033"><span class="hs-identifier hs-var">reason</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-556"></span><span>                            </span><span class="annot"><span class="annottext">GroupUsage
</span><a href="Network.TLS.Parameters.html#GroupUsageInvalidPublic"><span class="hs-identifier hs-var">GroupUsageInvalidPublic</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;invalid server public key&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>                            </span><span class="annot"><span class="annottext">GroupUsage
</span><a href="Network.TLS.Parameters.html#GroupUsageValid"><span class="hs-identifier hs-var">GroupUsageValid</span></a></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-558"></span><span>
</span><span id="line-559"></span><span>                    </span><span class="hs-comment">-- When grp is known but not in the supported list we use it</span><span>
</span><span id="line-560"></span><span>                    </span><span class="hs-comment">-- anyway.  This provides additional validation and a more</span><span>
</span><span id="line-561"></span><span>                    </span><span class="hs-comment">-- efficient implementation.</span><span>
</span><span id="line-562"></span><span>                    </span><span class="hs-special">(</span><span id="local-6989586621679195036"><span class="annot"><span class="annottext">DHPublic
</span><a href="#local-6989586621679195036"><span class="hs-identifier hs-var">clientDHPub</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679195037"><span class="annot"><span class="annottext">DHKey
</span><a href="#local-6989586621679195037"><span class="hs-identifier hs-var">premaster</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-563"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679195023"><span class="hs-identifier hs-var">ffGroup</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-564"></span><span>                             </span><span class="annot"><span class="annottext">Maybe Group
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-565"></span><span>                                 </span><span class="hs-special">(</span><span id="local-6989586621679195038"><span class="annot"><span class="annottext">DHPrivate
</span><a href="#local-6989586621679195038"><span class="hs-identifier hs-var">clientDHPriv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679195039"><span class="annot"><span class="annottext">DHPublic
</span><a href="#local-6989586621679195039"><span class="hs-identifier hs-var">clientDHPub</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; DHParams -&gt; IO (DHPrivate, DHPublic)
</span><a href="Network.TLS.Handshake.Key.html#generateDHE"><span class="hs-identifier hs-var">generateDHE</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">DHParams
</span><a href="#local-6989586621679195021"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-566"></span><span>                                 </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195041"><span class="annot"><span class="annottext">premaster :: DHKey
</span><a href="#local-6989586621679195041"><span class="hs-identifier hs-var hs-var">premaster</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DHParams -&gt; DHPrivate -&gt; DHPublic -&gt; DHKey
</span><a href="Network.TLS.Crypto.DH.html#dhGetShared"><span class="hs-identifier hs-var">dhGetShared</span></a></span><span> </span><span class="annot"><span class="annottext">DHParams
</span><a href="#local-6989586621679195021"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">DHPrivate
</span><a href="#local-6989586621679195038"><span class="hs-identifier hs-var">clientDHPriv</span></a></span><span> </span><span class="annot"><span class="annottext">DHPublic
</span><a href="#local-6989586621679195025"><span class="hs-identifier hs-var">srvpub</span></a></span><span>
</span><span id="line-567"></span><span>                                 </span><span class="annot"><span class="annottext">(DHPublic, DHKey) -&gt; IO (DHPublic, DHKey)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DHPublic
</span><a href="#local-6989586621679195039"><span class="hs-identifier hs-var">clientDHPub</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DHKey
</span><a href="#local-6989586621679195041"><span class="hs-identifier hs-var">premaster</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>                             </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195043"><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679195043"><span class="hs-identifier hs-var">grp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-569"></span><span>                                 </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Group -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setNegotiatedGroup"><span class="hs-identifier hs-var">setNegotiatedGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679195043"><span class="hs-identifier hs-var">grp</span></a></span><span>
</span><span id="line-570"></span><span>                                 </span><span id="local-6989586621679195045"><span class="annot"><span class="annottext">Maybe (DHPublic, DHKey)
</span><a href="#local-6989586621679195045"><span class="hs-identifier hs-var">dhePair</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Group -&gt; DHPublic -&gt; IO (Maybe (DHPublic, DHKey))
</span><a href="Network.TLS.Handshake.Key.html#generateFFDHEShared"><span class="hs-identifier hs-var">generateFFDHEShared</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679195043"><span class="hs-identifier hs-var">grp</span></a></span><span> </span><span class="annot"><span class="annottext">DHPublic
</span><a href="#local-6989586621679195025"><span class="hs-identifier hs-var">srvpub</span></a></span><span>
</span><span id="line-571"></span><span>                                 </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (DHPublic, DHKey)
</span><a href="#local-6989586621679195045"><span class="hs-identifier hs-var">dhePair</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-572"></span><span>                                     </span><span class="annot"><span class="annottext">Maybe (DHPublic, DHKey)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO (DHPublic, DHKey)
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO (DHPublic, DHKey))
-&gt; TLSError -&gt; IO (DHPublic, DHKey)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;invalid server &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Group -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679195043"><span class="hs-identifier hs-var">grp</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; public key&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-573"></span><span>                                     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195047"><span class="annot"><span class="annottext">(DHPublic, DHKey)
</span><a href="#local-6989586621679195047"><span class="hs-identifier hs-var">pair</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(DHPublic, DHKey) -&gt; IO (DHPublic, DHKey)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(DHPublic, DHKey)
</span><a href="#local-6989586621679195047"><span class="hs-identifier hs-var">pair</span></a></span><span>
</span><span id="line-574"></span><span>
</span><span id="line-575"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195050"><span class="annot"><span class="annottext">setMasterSec :: HandshakeM ByteString
</span><a href="#local-6989586621679195050"><span class="hs-identifier hs-var hs-var">setMasterSec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Version -&gt; Role -&gt; DHKey -&gt; HandshakeM ByteString
forall preMaster.
ByteArrayAccess preMaster =&gt;
Version -&gt; Role -&gt; preMaster -&gt; HandshakeM ByteString
</span><a href="Network.TLS.Handshake.State.html#setMasterSecretFromPre"><span class="hs-identifier hs-var">setMasterSecretFromPre</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195018"><span class="hs-identifier hs-var">xver</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ClientRole"><span class="hs-identifier hs-var">ClientRole</span></a></span><span> </span><span class="annot"><span class="annottext">DHKey
</span><a href="#local-6989586621679195037"><span class="hs-identifier hs-var">premaster</span></a></span><span>
</span><span id="line-576"></span><span>                    </span><span class="annot"><span class="annottext">(ClientKeyXchgAlgorithmData, HandshakeM ByteString)
-&gt; IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DHPublic -&gt; ClientKeyXchgAlgorithmData
</span><a href="Network.TLS.Struct.html#CKX_DH"><span class="hs-identifier hs-var">CKX_DH</span></a></span><span> </span><span class="annot"><span class="annottext">DHPublic
</span><a href="#local-6989586621679195036"><span class="hs-identifier hs-var">clientDHPub</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HandshakeM ByteString
</span><a href="#local-6989586621679195050"><span class="hs-identifier hs-var">setMasterSec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-577"></span><span>
</span><span id="line-578"></span><span>                </span><span id="local-6989586621679194987"><span class="annot"><span class="annottext">getCKX_ECDHE :: IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
</span><a href="#local-6989586621679194987"><span class="hs-identifier hs-var hs-var">getCKX_ECDHE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-579"></span><span>                    </span><span class="annot"><a href="Network.TLS.Struct.html#ServerECDHParams"><span class="hs-identifier hs-type">ServerECDHParams</span></a></span><span> </span><span id="local-6989586621679195066"><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679195066"><span class="hs-identifier hs-var">grp</span></a></span></span><span> </span><span id="local-6989586621679195067"><span class="annot"><span class="annottext">GroupPublic
</span><a href="#local-6989586621679195067"><span class="hs-identifier hs-var">srvpub</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM ServerECDHParams -&gt; IO ServerECDHParams
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM ServerECDHParams
</span><a href="Network.TLS.Handshake.State.html#getServerECDHParams"><span class="hs-identifier hs-var">getServerECDHParams</span></a></span><span>
</span><span id="line-580"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; Group -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common.html#checkSupportedGroup"><span class="hs-identifier hs-var">checkSupportedGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679195066"><span class="hs-identifier hs-var">grp</span></a></span><span>
</span><span id="line-581"></span><span>                    </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Group -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setNegotiatedGroup"><span class="hs-identifier hs-var">setNegotiatedGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679195066"><span class="hs-identifier hs-var">grp</span></a></span><span>
</span><span id="line-582"></span><span>                    </span><span id="local-6989586621679195070"><span class="annot"><span class="annottext">Maybe (GroupPublic, GroupKey)
</span><a href="#local-6989586621679195070"><span class="hs-identifier hs-var">ecdhePair</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; GroupPublic -&gt; IO (Maybe (GroupPublic, GroupKey))
</span><a href="Network.TLS.Handshake.Key.html#generateECDHEShared"><span class="hs-identifier hs-var">generateECDHEShared</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">GroupPublic
</span><a href="#local-6989586621679195067"><span class="hs-identifier hs-var">srvpub</span></a></span><span>
</span><span id="line-583"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (GroupPublic, GroupKey)
</span><a href="#local-6989586621679195070"><span class="hs-identifier hs-var">ecdhePair</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-584"></span><span>                        </span><span class="annot"><span class="annottext">Maybe (GroupPublic, GroupKey)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError
 -&gt; IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString))
-&gt; TLSError
-&gt; IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;invalid server &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Group -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679195066"><span class="hs-identifier hs-var">grp</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; public key&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679195072"><span class="annot"><span class="annottext">GroupPublic
</span><a href="#local-6989586621679195072"><span class="hs-identifier hs-var">clipub</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679195073"><span class="annot"><span class="annottext">GroupKey
</span><a href="#local-6989586621679195073"><span class="hs-identifier hs-var">premaster</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-586"></span><span>                            </span><span id="local-6989586621679195074"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195074"><span class="hs-identifier hs-var">xver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Version -&gt; IO Version
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-587"></span><span>                            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195077"><span class="annot"><span class="annottext">setMasterSec :: HandshakeM ByteString
</span><a href="#local-6989586621679195077"><span class="hs-identifier hs-var hs-var">setMasterSec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Version -&gt; Role -&gt; GroupKey -&gt; HandshakeM ByteString
forall preMaster.
ByteArrayAccess preMaster =&gt;
Version -&gt; Role -&gt; preMaster -&gt; HandshakeM ByteString
</span><a href="Network.TLS.Handshake.State.html#setMasterSecretFromPre"><span class="hs-identifier hs-var">setMasterSecretFromPre</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195074"><span class="hs-identifier hs-var">xver</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ClientRole"><span class="hs-identifier hs-var">ClientRole</span></a></span><span> </span><span class="annot"><span class="annottext">GroupKey
</span><a href="#local-6989586621679195073"><span class="hs-identifier hs-var">premaster</span></a></span><span>
</span><span id="line-588"></span><span>                            </span><span class="annot"><span class="annottext">(ClientKeyXchgAlgorithmData, HandshakeM ByteString)
-&gt; IO (ClientKeyXchgAlgorithmData, HandshakeM ByteString)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; ClientKeyXchgAlgorithmData
</span><a href="Network.TLS.Struct.html#CKX_ECDH"><span class="hs-identifier hs-var">CKX_ECDH</span></a></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; ClientKeyXchgAlgorithmData)
-&gt; ByteString -&gt; ClientKeyXchgAlgorithmData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">GroupPublic -&gt; ByteString
</span><a href="Network.TLS.Crypto.IES.html#encodeGroupPublic"><span class="hs-identifier hs-var">encodeGroupPublic</span></a></span><span> </span><span class="annot"><span class="annottext">GroupPublic
</span><a href="#local-6989586621679195072"><span class="hs-identifier hs-var">clipub</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">HandshakeM ByteString
</span><a href="#local-6989586621679195077"><span class="hs-identifier hs-var">setMasterSec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span>        </span><span class="hs-comment">-- In order to send a proper certificate verify message,</span><span>
</span><span id="line-591"></span><span>        </span><span class="hs-comment">-- we have to do the following:</span><span>
</span><span id="line-592"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-593"></span><span>        </span><span class="hs-comment">-- 1. Determine which signing algorithm(s) the server supports</span><span>
</span><span id="line-594"></span><span>        </span><span class="hs-comment">--    (we currently only support RSA).</span><span>
</span><span id="line-595"></span><span>        </span><span class="hs-comment">-- 2. Get the current handshake hash from the handshake state.</span><span>
</span><span id="line-596"></span><span>        </span><span class="hs-comment">-- 3. Sign the handshake hash</span><span>
</span><span id="line-597"></span><span>        </span><span class="hs-comment">-- 4. Send it to the server.</span><span>
</span><span id="line-598"></span><span>        </span><span class="hs-comment">--</span><span>
</span><span id="line-599"></span><span>        </span><span id="local-6989586621679194917"><span class="annot"><span class="annottext">sendCertificateVerify :: IO ()
</span><a href="#local-6989586621679194917"><span class="hs-identifier hs-var hs-var">sendCertificateVerify</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-600"></span><span>            </span><span id="local-6989586621679195094"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195094"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Version -&gt; IO Version
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-601"></span><span>
</span><span id="line-602"></span><span>            </span><span class="hs-comment">-- Only send a certificate verify message when we</span><span>
</span><span id="line-603"></span><span>            </span><span class="hs-comment">-- have sent a non-empty list of certificates.</span><span>
</span><span id="line-604"></span><span>            </span><span class="hs-comment">--</span><span>
</span><span id="line-605"></span><span>            </span><span id="local-6989586621679195095"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195095"><span class="hs-identifier hs-var">certSent</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM Bool -&gt; IO Bool
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM Bool
</span><a href="Network.TLS.Handshake.State.html#getClientCertSent"><span class="hs-identifier hs-var">getClientCertSent</span></a></span><span>
</span><span id="line-606"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195095"><span class="hs-identifier hs-var">certSent</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-607"></span><span>                </span><span id="local-6989586621679195097"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195097"><span class="hs-identifier hs-var">pubKey</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO PubKey
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m PubKey
</span><a href="Network.TLS.Handshake.Key.html#getLocalPublicKey"><span class="hs-identifier hs-var">getLocalPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-608"></span><span>                </span><span id="local-6989586621679195099"><span class="annot"><span class="annottext">Maybe HashAndSignatureAlgorithm
</span><a href="#local-6989586621679195099"><span class="hs-identifier hs-var">mhashSig</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195094"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-609"></span><span>                    </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS12"><span class="hs-identifier hs-var">TLS12</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-610"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195100"><span class="annot"><span class="annottext">cHashSigs :: [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195100"><span class="hs-identifier hs-var hs-var">cHashSigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [HashAndSignatureAlgorithm]
</span><a href="Network.TLS.Parameters.html#supportedHashSignatures"><span class="hs-identifier hs-var">supportedHashSignatures</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [HashAndSignatureAlgorithm])
-&gt; Supported -&gt; [HashAndSignatureAlgorithm]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-611"></span><span>                         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm -&gt; Maybe HashAndSignatureAlgorithm
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(HashAndSignatureAlgorithm -&gt; Maybe HashAndSignatureAlgorithm)
-&gt; IO HashAndSignatureAlgorithm
-&gt; IO (Maybe HashAndSignatureAlgorithm)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; (PubKey -&gt; HashAndSignatureAlgorithm -&gt; Bool)
-&gt; [HashAndSignatureAlgorithm]
-&gt; PubKey
-&gt; IO HashAndSignatureAlgorithm
</span><a href="Network.TLS.Handshake.Client.html#getLocalHashSigAlg"><span class="hs-identifier hs-var">getLocalHashSigAlg</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; HashAndSignatureAlgorithm -&gt; Bool
</span><a href="Network.TLS.Handshake.Signature.html#signatureCompatible"><span class="hs-identifier hs-var">signatureCompatible</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195100"><span class="hs-identifier hs-var">cHashSigs</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195097"><span class="hs-identifier hs-var">pubKey</span></a></span><span>
</span><span id="line-612"></span><span>                    </span><span class="annot"><span class="annottext">Version
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe HashAndSignatureAlgorithm
-&gt; IO (Maybe HashAndSignatureAlgorithm)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe HashAndSignatureAlgorithm
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span>                </span><span class="hs-comment">-- Fetch all handshake messages up to now.</span><span>
</span><span id="line-615"></span><span>                </span><span id="local-6989586621679195101"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195101"><span class="hs-identifier hs-var">msgs</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM ByteString -&gt; IO ByteString
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM ByteString -&gt; IO ByteString)
-&gt; HandshakeM ByteString -&gt; IO ByteString
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">B.concat</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString)
-&gt; HandshakeM [ByteString] -&gt; HandshakeM ByteString
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">HandshakeM [ByteString]
</span><a href="Network.TLS.Handshake.State.html#getHandshakeMessages"><span class="hs-identifier hs-var">getHandshakeMessages</span></a></span><span>
</span><span id="line-616"></span><span>                </span><span id="local-6989586621679195104"><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195104"><span class="hs-identifier hs-var">sigDig</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; Version
-&gt; PubKey
-&gt; Maybe HashAndSignatureAlgorithm
-&gt; ByteString
-&gt; IO DigitallySigned
</span><a href="Network.TLS.Handshake.Signature.html#createCertificateVerify"><span class="hs-identifier hs-var">createCertificateVerify</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195094"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195097"><span class="hs-identifier hs-var">pubKey</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe HashAndSignatureAlgorithm
</span><a href="#local-6989586621679195099"><span class="hs-identifier hs-var">mhashSig</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195101"><span class="hs-identifier hs-var">msgs</span></a></span><span>
</span><span id="line-617"></span><span>                </span><span class="annot"><span class="annottext">Context -&gt; Packet -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket"><span class="hs-identifier hs-var">sendPacket</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679194914"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet -&gt; IO ()) -&gt; Packet -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake] -&gt; Packet
</span><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-var">Handshake</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DigitallySigned -&gt; Handshake
</span><a href="Network.TLS.Struct.html#CertVerify"><span class="hs-identifier hs-var">CertVerify</span></a></span><span> </span><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195104"><span class="hs-identifier hs-var">sigDig</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-618"></span><span>
</span><span id="line-619"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#processServerExtension"><span class="hs-identifier hs-type">processServerExtension</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.State.html#TLSSt"><span class="hs-identifier hs-type">TLSSt</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-620"></span><span id="processServerExtension"><span class="annot"><span class="annottext">processServerExtension :: ExtensionRaw -&gt; TLSSt ()
</span><a href="Network.TLS.Handshake.Client.html#processServerExtension"><span class="hs-identifier hs-var hs-var">processServerExtension</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span> </span><span id="local-6989586621679195108"><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195108"><span class="hs-identifier hs-var">extID</span></a></span></span><span> </span><span id="local-6989586621679195109"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195109"><span class="hs-identifier hs-var">content</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-621"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195108"><span class="hs-identifier hs-var">extID</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ExtensionID -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_SecureRenegotiation"><span class="hs-identifier hs-var">extensionID_SecureRenegotiation</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-622"></span><span>        </span><span id="local-6989586621679195111"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195111"><span class="hs-identifier hs-var">cv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Role -&gt; TLSSt ByteString
</span><a href="Network.TLS.State.html#getVerifiedData"><span class="hs-identifier hs-var">getVerifiedData</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ClientRole"><span class="hs-identifier hs-var">ClientRole</span></a></span><span>
</span><span id="line-623"></span><span>        </span><span id="local-6989586621679195112"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195112"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Role -&gt; TLSSt ByteString
</span><a href="Network.TLS.State.html#getVerifiedData"><span class="hs-identifier hs-var">getVerifiedData</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ServerRole"><span class="hs-identifier hs-var">ServerRole</span></a></span><span>
</span><span id="line-624"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195115"><span class="annot"><span class="annottext">bs :: ByteString
</span><a href="#local-6989586621679195115"><span class="hs-identifier hs-var hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecureRenegotiation -&gt; ByteString
forall a. Extension a =&gt; a -&gt; ByteString
</span><a href="Network.TLS.Extension.html#extensionEncode"><span class="hs-identifier hs-var">extensionEncode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString -&gt; SecureRenegotiation
</span><a href="Network.TLS.Extension.html#SecureRenegotiation"><span class="hs-identifier hs-var">SecureRenegotiation</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195111"><span class="hs-identifier hs-var">cv</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe ByteString -&gt; SecureRenegotiation)
-&gt; Maybe ByteString -&gt; SecureRenegotiation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195112"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-625"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; TLSSt () -&gt; TLSSt ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195115"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; ByteString -&gt; Bool
</span><a href="Network.TLS.Util.html#bytesEq"><span class="hs-operator hs-var">`bytesEq`</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195109"><span class="hs-identifier hs-var">content</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TLSSt () -&gt; TLSSt ()) -&gt; TLSSt () -&gt; TLSSt ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; TLSSt ()
forall a. TLSError -&gt; TLSSt a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; TLSSt ()) -&gt; TLSError -&gt; TLSSt ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server secure renegotiation data not matching&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195108"><span class="hs-identifier hs-var">extID</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ExtensionID -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_SupportedVersions"><span class="hs-identifier hs-var">extensionID_SupportedVersions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MessageType -&gt; ByteString -&gt; Maybe SupportedVersions
forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTServerHello"><span class="hs-identifier hs-var">MsgTServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195109"><span class="hs-identifier hs-var">content</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-627"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#SupportedVersionsServerHello"><span class="hs-identifier hs-type">SupportedVersionsServerHello</span></a></span><span> </span><span id="local-6989586621679195121"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195121"><span class="hs-identifier hs-var">ver</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Version -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setVersion"><span class="hs-identifier hs-var">setVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195121"><span class="hs-identifier hs-var">ver</span></a></span><span>
</span><span id="line-628"></span><span>      </span><span class="annot"><span class="annottext">Maybe SupportedVersions
</span><span class="hs-identifier">_</span></span><span>                                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TLSSt ()
forall a. a -&gt; TLSSt a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195108"><span class="hs-identifier hs-var">extID</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ExtensionID -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_KeyShare"><span class="hs-identifier hs-var">extensionID_KeyShare</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-630"></span><span>        </span><span id="local-6989586621679195124"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195124"><span class="hs-identifier hs-var">hrr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TLSSt Bool
</span><a href="Network.TLS.State.html#getTLS13HRR"><span class="hs-identifier hs-var">getTLS13HRR</span></a></span><span>
</span><span id="line-631"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195125"><span class="annot"><span class="annottext">msgt :: MessageType
</span><a href="#local-6989586621679195125"><span class="hs-identifier hs-var hs-var">msgt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195124"><span class="hs-identifier hs-var">hrr</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTHelloRetryRequest"><span class="hs-identifier hs-var">MsgTHelloRetryRequest</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTServerHello"><span class="hs-identifier hs-var">MsgTServerHello</span></a></span><span>
</span><span id="line-632"></span><span>        </span><span class="annot"><span class="annottext">Maybe KeyShare -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setTLS13KeyShare"><span class="hs-identifier hs-var">setTLS13KeyShare</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe KeyShare -&gt; TLSSt ()) -&gt; Maybe KeyShare -&gt; TLSSt ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MessageType -&gt; ByteString -&gt; Maybe KeyShare
forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="#local-6989586621679195125"><span class="hs-identifier hs-var">msgt</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195109"><span class="hs-identifier hs-var">content</span></a></span><span>
</span><span id="line-633"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195108"><span class="hs-identifier hs-var">extID</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ExtensionID -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_PreSharedKey"><span class="hs-identifier hs-var">extensionID_PreSharedKey</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-634"></span><span>        </span><span class="annot"><span class="annottext">Maybe PreSharedKey -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setTLS13PreSharedKey"><span class="hs-identifier hs-var">setTLS13PreSharedKey</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe PreSharedKey -&gt; TLSSt ()) -&gt; Maybe PreSharedKey -&gt; TLSSt ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MessageType -&gt; ByteString -&gt; Maybe PreSharedKey
forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTServerHello"><span class="hs-identifier hs-var">MsgTServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195109"><span class="hs-identifier hs-var">content</span></a></span><span>
</span><span id="line-635"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#processServerExtension"><span class="hs-identifier hs-var">processServerExtension</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TLSSt ()
forall a. a -&gt; TLSSt a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span id="local-6989586621679193916"><span class="annot"><a href="Network.TLS.Handshake.Client.html#throwMiscErrorOnException"><span class="hs-identifier hs-type">throwMiscErrorOnException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679193916"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-638"></span><span id="throwMiscErrorOnException"><span class="annot"><span class="annottext">throwMiscErrorOnException :: forall a. String -&gt; SomeException -&gt; IO a
</span><a href="Network.TLS.Handshake.Client.html#throwMiscErrorOnException"><span class="hs-identifier hs-var hs-var">throwMiscErrorOnException</span></a></span></span><span> </span><span id="local-6989586621679195134"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679195134"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span id="local-6989586621679195135"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679195135"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-639"></span><span>    </span><span class="annot"><span class="annottext">TLSError -&gt; IO a
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO a) -&gt; TLSError -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Misc"><span class="hs-identifier hs-var">Error_Misc</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; TLSError) -&gt; String -&gt; TLSError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679195134"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679195135"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-640"></span><span>
</span><span id="line-641"></span><span class="hs-comment">-- | onServerHello process the ServerHello message on the client.</span><span>
</span><span id="line-642"></span><span class="hs-comment">--</span><span>
</span><span id="line-643"></span><span class="hs-comment">-- 1) check the version chosen by the server is one allowed by parameters.</span><span>
</span><span id="line-644"></span><span class="hs-comment">-- 2) check that our compression and cipher algorithms are part of the list we sent</span><span>
</span><span id="line-645"></span><span class="hs-comment">-- 3) check extensions received are part of the one we sent</span><span>
</span><span id="line-646"></span><span class="hs-comment">-- 4) process the session parameter to see if the server want to start a new session or can resume</span><span>
</span><span id="line-647"></span><span class="hs-comment">-- 5) if no resume switch to processCertificate SM or in resume switch to expectChangeCipher</span><span>
</span><span id="line-648"></span><span class="hs-comment">--</span><span>
</span><span id="line-649"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#onServerHello"><span class="hs-identifier hs-type">onServerHello</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ClientParams"><span class="hs-identifier hs-type">ClientParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-type">Session</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionID"><span class="hs-identifier hs-type">ExtensionID</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Handshake.Common.html#RecvState"><span class="hs-identifier hs-type">RecvState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span>
</span><span id="line-650"></span><span id="onServerHello"><span class="annot"><span class="annottext">onServerHello :: Context
-&gt; ClientParams
-&gt; Session
-&gt; [ExtensionID]
-&gt; Handshake
-&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#onServerHello"><span class="hs-identifier hs-var hs-var">onServerHello</span></a></span></span><span> </span><span id="local-6989586621679195137"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679195138"><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195138"><span class="hs-identifier hs-var">cparams</span></a></span></span><span> </span><span id="local-6989586621679195139"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679195139"><span class="hs-identifier hs-var">clientSession</span></a></span></span><span> </span><span id="local-6989586621679195140"><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679195140"><span class="hs-identifier hs-var">sentExts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#ServerHello"><span class="hs-identifier hs-type">ServerHello</span></a></span><span> </span><span id="local-6989586621679195142"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195142"><span class="hs-identifier hs-var">rver</span></a></span></span><span> </span><span id="local-6989586621679195143"><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679195143"><span class="hs-identifier hs-var">serverRan</span></a></span></span><span> </span><span id="local-6989586621679195144"><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679195144"><span class="hs-identifier hs-var">serverSession</span></a></span></span><span> </span><span id="local-6989586621679195145"><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195145"><span class="hs-identifier hs-var">cipher</span></a></span></span><span> </span><span id="local-6989586621679195146"><span class="annot"><span class="annottext">CompressionID
</span><a href="#local-6989586621679195146"><span class="hs-identifier hs-var">compression</span></a></span></span><span> </span><span id="local-6989586621679195147"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195147"><span class="hs-identifier hs-var">exts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-651"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195142"><span class="hs-identifier hs-var">rver</span></a></span><span> </span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#SSL2"><span class="hs-identifier hs-var">SSL2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SSL2 is not supported&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#ProtocolVersion"><span class="hs-identifier hs-var">ProtocolVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-652"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195142"><span class="hs-identifier hs-var">rver</span></a></span><span> </span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#SSL3"><span class="hs-identifier hs-var">SSL3</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SSL3 is not supported&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#ProtocolVersion"><span class="hs-identifier hs-var">ProtocolVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-653"></span><span>    </span><span class="hs-comment">-- find the compression and cipher methods that the server want to use.</span><span>
</span><span id="line-654"></span><span>    </span><span id="local-6989586621679195151"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195151"><span class="hs-identifier hs-var">cipherAlg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Cipher -&gt; Bool) -&gt; [Cipher] -&gt; Maybe Cipher
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtensionID -&gt; ExtensionID -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">(==)</span></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195145"><span class="hs-identifier hs-var">cipher</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtensionID -&gt; Bool) -&gt; (Cipher -&gt; ExtensionID) -&gt; Cipher -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; ExtensionID
</span><a href="Network.TLS.Cipher.html#cipherID"><span class="hs-identifier hs-var">cipherID</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Supported -&gt; [Cipher]
</span><a href="Network.TLS.Parameters.html#supportedCiphers"><span class="hs-identifier hs-var">supportedCiphers</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [Cipher]) -&gt; Supported -&gt; [Cipher]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-655"></span><span>                     </span><span class="annot"><span class="annottext">Maybe Cipher
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO Cipher
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO Cipher) -&gt; TLSError -&gt; IO Cipher
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server choose unknown cipher&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span>                     </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195152"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195152"><span class="hs-identifier hs-var">alg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; IO Cipher
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195152"><span class="hs-identifier hs-var">alg</span></a></span><span>
</span><span id="line-657"></span><span>    </span><span id="local-6989586621679195153"><span class="annot"><span class="annottext">Compression
</span><a href="#local-6989586621679195153"><span class="hs-identifier hs-var">compressAlg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Compression -&gt; Bool) -&gt; [Compression] -&gt; Maybe Compression
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CompressionID -&gt; CompressionID -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">(==)</span></span><span> </span><span class="annot"><span class="annottext">CompressionID
</span><a href="#local-6989586621679195146"><span class="hs-identifier hs-var">compression</span></a></span><span> </span><span class="annot"><span class="annottext">(CompressionID -&gt; Bool)
-&gt; (Compression -&gt; CompressionID) -&gt; Compression -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Compression -&gt; CompressionID
</span><a href="Network.TLS.Compression.html#compressionID"><span class="hs-identifier hs-var">compressionID</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Supported -&gt; [Compression]
</span><a href="Network.TLS.Parameters.html#supportedCompressions"><span class="hs-identifier hs-var">supportedCompressions</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [Compression]) -&gt; Supported -&gt; [Compression]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-658"></span><span>                       </span><span class="annot"><span class="annottext">Maybe Compression
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO Compression
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO Compression) -&gt; TLSError -&gt; IO Compression
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server choose unknown compression&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-659"></span><span>                       </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195154"><span class="annot"><span class="annottext">Compression
</span><a href="#local-6989586621679195154"><span class="hs-identifier hs-var">alg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Compression -&gt; IO Compression
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Compression
</span><a href="#local-6989586621679195154"><span class="hs-identifier hs-var">alg</span></a></span><span>
</span><span id="line-660"></span><span>
</span><span id="line-661"></span><span>    </span><span class="hs-comment">-- intersect sent extensions in client and the received extensions from server.</span><span>
</span><span id="line-662"></span><span>    </span><span class="hs-comment">-- if server returns extensions that we didn't request, fail.</span><span>
</span><span id="line-663"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195158"><span class="annot"><span class="annottext">checkExt :: ExtensionRaw -&gt; Bool
</span><a href="#local-6989586621679195158"><span class="hs-identifier hs-var hs-var">checkExt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span> </span><span id="local-6989586621679195159"><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195159"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-664"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195159"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; ExtensionID -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_Cookie"><span class="hs-identifier hs-var">extensionID_Cookie</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-comment">-- for HRR</span><span>
</span><span id="line-665"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>               </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195159"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionID] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionID]
</span><a href="#local-6989586621679195140"><span class="hs-identifier hs-var">sentExts</span></a></span><span>
</span><span id="line-666"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; Bool) -&gt; [ExtensionRaw] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; Bool
</span><a href="#local-6989586621679195158"><span class="hs-identifier hs-var">checkExt</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195147"><span class="hs-identifier hs-var">exts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-667"></span><span>        </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;spurious extensions received&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnsupportedExtension"><span class="hs-identifier hs-var">UnsupportedExtension</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-668"></span><span>
</span><span id="line-669"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195164"><span class="annot"><span class="annottext">resumingSession :: Maybe SessionData
</span><a href="#local-6989586621679195164"><span class="hs-identifier hs-var hs-var">resumingSession</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-670"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Maybe (ByteString, SessionData)
</span><a href="Network.TLS.Parameters.html#clientWantSessionResume"><span class="hs-identifier hs-var">clientWantSessionResume</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195138"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-671"></span><span>                </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679195165"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195165"><span class="hs-identifier hs-var">sessionId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679195166"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679195166"><span class="hs-identifier hs-var">sessionData</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679195144"><span class="hs-identifier hs-var">serverSession</span></a></span><span> </span><span class="annot"><span class="annottext">Session -&gt; Session -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; Session
</span><a href="Network.TLS.Struct.html#Session"><span class="hs-identifier hs-var">Session</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195165"><span class="hs-identifier hs-var">sessionId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; Maybe SessionData
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679195166"><span class="hs-identifier hs-var">sessionData</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe SessionData
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-672"></span><span>                </span><span class="annot"><span class="annottext">Maybe (ByteString, SessionData)
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe SessionData
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-673"></span><span>        </span><span id="local-6989586621679195167"><span class="annot"><span class="annottext">isHRR :: Bool
</span><a href="#local-6989586621679195167"><span class="hs-identifier hs-var hs-var">isHRR</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerRandom -&gt; Bool
</span><a href="Network.TLS.Handshake.Random.html#isHelloRetryRequest"><span class="hs-identifier hs-var">isHelloRetryRequest</span></a></span><span> </span><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679195143"><span class="hs-identifier hs-var">serverRan</span></a></span><span>
</span><span id="line-674"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; TLSSt () -&gt; IO ()
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSSt () -&gt; IO ()) -&gt; TLSSt () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-675"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setTLS13HRR"><span class="hs-identifier hs-var">setTLS13HRR</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195167"><span class="hs-identifier hs-var">isHRR</span></a></span><span>
</span><span id="line-676"></span><span>        </span><span class="annot"><span class="annottext">Maybe Cookie -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setTLS13Cookie"><span class="hs-identifier hs-var">setTLS13Cookie</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195167"><span class="hs-identifier hs-var">isHRR</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe () -&gt; Maybe ByteString -&gt; Maybe ByteString
forall a b. Maybe a -&gt; Maybe b -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_Cookie"><span class="hs-identifier hs-var">extensionID_Cookie</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195147"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; (ByteString -&gt; Maybe Cookie) -&gt; Maybe Cookie
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">MessageType -&gt; ByteString -&gt; Maybe Cookie
forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTServerHello"><span class="hs-identifier hs-var">MsgTServerHello</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-677"></span><span>        </span><span class="annot"><span class="annottext">Session -&gt; Bool -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setSession"><span class="hs-identifier hs-var">setSession</span></a></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679195144"><span class="hs-identifier hs-var">serverSession</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe SessionData -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe SessionData
</span><a href="#local-6989586621679195164"><span class="hs-identifier hs-var">resumingSession</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-678"></span><span>        </span><span class="annot"><span class="annottext">Version -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setVersion"><span class="hs-identifier hs-var">setVersion</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195142"><span class="hs-identifier hs-var">rver</span></a></span><span> </span><span class="hs-comment">-- must be before processing supportedVersions ext</span><span>
</span><span id="line-679"></span><span>        </span><span class="annot"><span class="annottext">(ExtensionRaw -&gt; TLSSt ()) -&gt; [ExtensionRaw] -&gt; TLSSt ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">ExtensionRaw -&gt; TLSSt ()
</span><a href="Network.TLS.Handshake.Client.html#processServerExtension"><span class="hs-identifier hs-var">processServerExtension</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195147"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-680"></span><span>
</span><span id="line-681"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; MessageType -&gt; [ExtensionRaw] -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#setALPN"><span class="hs-identifier hs-var">setALPN</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTServerHello"><span class="hs-identifier hs-var">MsgTServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195147"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-682"></span><span>
</span><span id="line-683"></span><span>    </span><span id="local-6989586621679195175"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195175"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Version -&gt; IO Version
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-684"></span><span>
</span><span id="line-685"></span><span>    </span><span class="hs-comment">-- Some servers set TLS 1.2 as the legacy server hello version, and TLS 1.3</span><span>
</span><span id="line-686"></span><span>    </span><span class="hs-comment">-- in the supported_versions extension, *AND ALSO* set the TLS 1.2</span><span>
</span><span id="line-687"></span><span>    </span><span class="hs-comment">-- downgrade signal in the server random.  If we support TLS 1.3 and</span><span>
</span><span id="line-688"></span><span>    </span><span class="hs-comment">-- actually negotiate TLS 1.3, we must ignore the server random downgrade</span><span>
</span><span id="line-689"></span><span>    </span><span class="hs-comment">-- signal.  Therefore, 'isDowngraded' needs to take into account the</span><span>
</span><span id="line-690"></span><span>    </span><span class="hs-comment">-- negotiated version and the server random, as well as the list of</span><span>
</span><span id="line-691"></span><span>    </span><span class="hs-comment">-- client-side enabled protocol versions.</span><span>
</span><span id="line-692"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-693"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version -&gt; [Version] -&gt; ServerRandom -&gt; Bool
</span><a href="Network.TLS.Handshake.Random.html#isDowngraded"><span class="hs-identifier hs-var">isDowngraded</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195175"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Supported -&gt; [Version]
</span><a href="Network.TLS.Parameters.html#supportedVersions"><span class="hs-identifier hs-var">supportedVersions</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [Version]) -&gt; Supported -&gt; [Version]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Supported
</span><a href="Network.TLS.Parameters.html#clientSupported"><span class="hs-identifier hs-var">clientSupported</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195138"><span class="hs-identifier hs-var">cparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679195143"><span class="hs-identifier hs-var">serverRan</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-694"></span><span>        </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;version downgrade detected&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(Version -&gt; Bool) -&gt; [Version] -&gt; Maybe Version
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195175"><span class="hs-identifier hs-var">ver</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Supported -&gt; [Version]
</span><a href="Network.TLS.Parameters.html#supportedVersions"><span class="hs-identifier hs-var">supportedVersions</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [Version]) -&gt; Supported -&gt; [Version]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-697"></span><span>        </span><span class="annot"><span class="annottext">Maybe Version
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server version &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Version -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195175"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; is not supported&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#ProtocolVersion"><span class="hs-identifier hs-var">ProtocolVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-698"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-699"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195175"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS12"><span class="hs-identifier hs-var">TLS12</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-700"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679195144"><span class="hs-identifier hs-var">serverSession</span></a></span><span> </span><span class="annot"><span class="annottext">Session -&gt; Session -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Session
</span><a href="#local-6989586621679195139"><span class="hs-identifier hs-var">clientSession</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-701"></span><span>            </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;received mismatched legacy session&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-702"></span><span>        </span><span id="local-6989586621679195178"><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679195178"><span class="hs-identifier hs-var">established</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Established
</span><a href="Network.TLS.Context.Internal.html#ctxEstablished"><span class="hs-identifier hs-var">ctxEstablished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-703"></span><span>        </span><span id="local-6989586621679195180"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195180"><span class="hs-identifier hs-var">eof</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO Bool
</span><a href="Network.TLS.Context.Internal.html#ctxEOF"><span class="hs-identifier hs-var">ctxEOF</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-704"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Established
</span><a href="#local-6989586621679195178"><span class="hs-identifier hs-var">established</span></a></span><span> </span><span class="annot"><span class="annottext">Established -&gt; Established -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Established
</span><a href="Network.TLS.Context.Internal.html#Established"><span class="hs-identifier hs-var">Established</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195180"><span class="hs-identifier hs-var">eof</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-705"></span><span>            </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;renegotiation to TLS 1.3 or later is not allowed&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#ProtocolVersion"><span class="hs-identifier hs-var">ProtocolVersion</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-706"></span><span>        </span><span class="annot"><span class="annottext">CompressionID -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; CompressionID -&gt; m ()
</span><a href="Network.TLS.Handshake.Common13.html#ensureNullCompression"><span class="hs-identifier hs-var">ensureNullCompression</span></a></span><span> </span><span class="annot"><span class="annottext">CompressionID
</span><a href="#local-6989586621679195146"><span class="hs-identifier hs-var">compression</span></a></span><span>
</span><span id="line-707"></span><span>        </span><span class="annot"><span class="annottext">IO (Either TLSError ()) -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; m (Either TLSError a) -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#failOnEitherError"><span class="hs-identifier hs-var">failOnEitherError</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Either TLSError ()) -&gt; IO ())
-&gt; IO (Either TLSError ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; HandshakeM (Either TLSError ()) -&gt; IO (Either TLSError ())
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM (Either TLSError ()) -&gt; IO (Either TLSError ()))
-&gt; HandshakeM (Either TLSError ()) -&gt; IO (Either TLSError ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; HandshakeM (Either TLSError ())
</span><a href="Network.TLS.Handshake.State13.html#setHelloParameters13"><span class="hs-identifier hs-var">setHelloParameters13</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195151"><span class="hs-identifier hs-var">cipherAlg</span></a></span><span>
</span><span id="line-708"></span><span>        </span><span class="annot"><span class="annottext">RecvState IO -&gt; IO (RecvState IO)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">RecvState IO
forall (m :: * -&gt; *). RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateDone"><span class="hs-identifier hs-var">RecvStateDone</span></a></span><span>
</span><span id="line-709"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-710"></span><span>        </span><span id="local-6989586621679195187"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195187"><span class="hs-identifier hs-var">ems</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Version -&gt; MessageType -&gt; [ExtensionRaw] -&gt; IO Bool
forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; Version -&gt; MessageType -&gt; [ExtensionRaw] -&gt; m Bool
</span><a href="Network.TLS.Handshake.Common.html#processExtendedMasterSec"><span class="hs-identifier hs-var">processExtendedMasterSec</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195175"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTServerHello"><span class="hs-identifier hs-var">MsgTServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195147"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-711"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Version -&gt; ServerRandom -&gt; Cipher -&gt; Compression -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setServerHelloParameters"><span class="hs-identifier hs-var">setServerHelloParameters</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195142"><span class="hs-identifier hs-var">rver</span></a></span><span> </span><span class="annot"><span class="annottext">ServerRandom
</span><a href="#local-6989586621679195143"><span class="hs-identifier hs-var">serverRan</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195151"><span class="hs-identifier hs-var">cipherAlg</span></a></span><span> </span><span class="annot"><span class="annottext">Compression
</span><a href="#local-6989586621679195153"><span class="hs-identifier hs-var">compressAlg</span></a></span><span>
</span><span id="line-712"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe SessionData
</span><a href="#local-6989586621679195164"><span class="hs-identifier hs-var">resumingSession</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-713"></span><span>            </span><span class="annot"><span class="annottext">Maybe SessionData
</span><span class="hs-identifier hs-var">Nothing</span></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RecvState IO -&gt; IO (RecvState IO)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(RecvState IO -&gt; IO (RecvState IO))
-&gt; RecvState IO -&gt; IO (RecvState IO)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Handshake -&gt; IO (RecvState IO)) -&gt; RecvState IO
forall (m :: * -&gt; *). (Handshake -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateHandshake"><span class="hs-identifier hs-var">RecvStateHandshake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientParams -&gt; Context -&gt; Handshake -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#processCertificate"><span class="hs-identifier hs-var">processCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195138"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-714"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195191"><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679195191"><span class="hs-identifier hs-var">sessionData</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-715"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195194"><span class="annot"><span class="annottext">emsSession :: Bool
</span><a href="#local-6989586621679195194"><span class="hs-identifier hs-var hs-var">emsSession</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionFlag
</span><a href="Network.TLS.Types.html#SessionEMS"><span class="hs-identifier hs-var">SessionEMS</span></a></span><span> </span><span class="annot"><span class="annottext">SessionFlag -&gt; [SessionFlag] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; [SessionFlag]
</span><a href="Network.TLS.Types.html#sessionFlags"><span class="hs-identifier hs-var">sessionFlags</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679195191"><span class="hs-identifier hs-var">sessionData</span></a></span><span>
</span><span id="line-716"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195187"><span class="hs-identifier hs-var">ems</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195194"><span class="hs-identifier hs-var">emsSession</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-717"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195196"><span class="annot"><span class="annottext">err :: String
</span><a href="#local-6989586621679195196"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server resumes a session which is not EMS consistent&quot;</span></span><span>
</span><span id="line-718"></span><span>                     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679195196"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-719"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195197"><span class="annot"><span class="annottext">masterSecret :: ByteString
</span><a href="#local-6989586621679195197"><span class="hs-identifier hs-var hs-var">masterSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SessionData -&gt; ByteString
</span><a href="Network.TLS.Types.html#sessionSecret"><span class="hs-identifier hs-var">sessionSecret</span></a></span><span> </span><span class="annot"><span class="annottext">SessionData
</span><a href="#local-6989586621679195191"><span class="hs-identifier hs-var">sessionData</span></a></span><span>
</span><span id="line-720"></span><span>                </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Version -&gt; Role -&gt; ByteString -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setMasterSecret"><span class="hs-identifier hs-var">setMasterSecret</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195142"><span class="hs-identifier hs-var">rver</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Network.TLS.Types.html#ClientRole"><span class="hs-identifier hs-var">ClientRole</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195197"><span class="hs-identifier hs-var">masterSecret</span></a></span><span>
</span><span id="line-721"></span><span>                </span><span class="annot"><span class="annottext">Context -&gt; MasterSecret -&gt; IO ()
forall a. LogLabel a =&gt; Context -&gt; a -&gt; IO ()
</span><a href="Network.TLS.Handshake.Key.html#logKey"><span class="hs-identifier hs-var">logKey</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195137"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; MasterSecret
</span><a href="Network.TLS.Types.html#MasterSecret"><span class="hs-identifier hs-var">MasterSecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195197"><span class="hs-identifier hs-var">masterSecret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-722"></span><span>                </span><span class="annot"><span class="annottext">RecvState IO -&gt; IO (RecvState IO)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(RecvState IO -&gt; IO (RecvState IO))
-&gt; RecvState IO -&gt; IO (RecvState IO)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Packet -&gt; IO (RecvState IO)) -&gt; RecvState IO
forall (m :: * -&gt; *). (Packet -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateNext"><span class="hs-identifier hs-var">RecvStateNext</span></a></span><span> </span><span class="annot"><span class="annottext">Packet -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#expectChangeCipher"><span class="hs-identifier hs-var">expectChangeCipher</span></a></span><span>
</span><span id="line-723"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#onServerHello"><span class="hs-identifier hs-var">onServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Session
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionID]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679195200"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679195200"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; IO (RecvState IO)
forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handshake -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679195200"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server hello&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-724"></span><span>
</span><span id="line-725"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#processCertificate"><span class="hs-identifier hs-type">processCertificate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ClientParams"><span class="hs-identifier hs-type">ClientParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Handshake.Common.html#RecvState"><span class="hs-identifier hs-type">RecvState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span>
</span><span id="line-726"></span><span id="processCertificate"><span class="annot"><span class="annottext">processCertificate :: ClientParams -&gt; Context -&gt; Handshake -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#processCertificate"><span class="hs-identifier hs-var hs-var">processCertificate</span></a></span></span><span> </span><span id="local-6989586621679195201"><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195201"><span class="hs-identifier hs-var">cparams</span></a></span></span><span> </span><span id="local-6989586621679195202"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195202"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#Certificates"><span class="hs-identifier hs-type">Certificates</span></a></span><span> </span><span id="local-6989586621679195203"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195203"><span class="hs-identifier hs-var">certs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-727"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CertificateChain -&gt; Bool
</span><a href="Network.TLS.X509.html#isNullCertificateChain"><span class="hs-identifier hs-var">isNullCertificateChain</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195203"><span class="hs-identifier hs-var">certs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-728"></span><span>        </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server certificate missing&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#DecodeError"><span class="hs-identifier hs-var">DecodeError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-729"></span><span>    </span><span class="hs-comment">-- run certificate recv hook</span><span>
</span><span id="line-730"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; (Hooks -&gt; IO ()) -&gt; IO ()
forall a. Context -&gt; (Hooks -&gt; IO a) -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#ctxWithHooks"><span class="hs-identifier hs-var">ctxWithHooks</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195202"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hooks -&gt; CertificateChain -&gt; IO ()
</span><a href="Network.TLS.Hooks.html#hookRecvCertificates"><span class="hs-operator hs-var">`hookRecvCertificates`</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195203"><span class="hs-identifier hs-var">certs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-731"></span><span>    </span><span class="hs-comment">-- then run certificate validation</span><span>
</span><span id="line-732"></span><span>    </span><span id="local-6989586621679195208"><span class="annot"><span class="annottext">CertificateUsage
</span><a href="#local-6989586621679195208"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO CertificateUsage
-&gt; (SomeException -&gt; IO CertificateUsage) -&gt; IO CertificateUsage
forall a. IO a -&gt; (SomeException -&gt; IO a) -&gt; IO a
</span><a href="Network.TLS.Util.html#catchException"><span class="hs-identifier hs-var">catchException</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FailedReason] -&gt; CertificateUsage
</span><a href="Network.TLS.X509.html#wrapCertificateChecks"><span class="hs-identifier hs-var">wrapCertificateChecks</span></a></span><span> </span><span class="annot"><span class="annottext">([FailedReason] -&gt; CertificateUsage)
-&gt; IO [FailedReason] -&gt; IO CertificateUsage
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IO [FailedReason]
</span><a href="#local-6989586621679195210"><span class="hs-identifier hs-var">checkCert</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; IO CertificateUsage
</span><a href="Network.TLS.Handshake.Certificate.html#rejectOnException"><span class="hs-identifier hs-var">rejectOnException</span></a></span><span>
</span><span id="line-733"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CertificateUsage
</span><a href="#local-6989586621679195208"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-734"></span><span>        </span><span class="annot"><span class="annottext">CertificateUsage
</span><a href="Network.TLS.X509.html#CertificateUsageAccept"><span class="hs-identifier hs-var">CertificateUsageAccept</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621679195213"><span class="hs-identifier hs-var">checkLeafCertificateKeyUsage</span></a></span><span>
</span><span id="line-735"></span><span>        </span><span class="annot"><a href="Network.TLS.X509.html#CertificateUsageReject"><span class="hs-identifier hs-type">CertificateUsageReject</span></a></span><span> </span><span id="local-6989586621679195215"><span class="annot"><span class="annottext">CertificateRejectReason
</span><a href="#local-6989586621679195215"><span class="hs-identifier hs-var">reason</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CertificateRejectReason -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; CertificateRejectReason -&gt; m a
</span><a href="Network.TLS.Handshake.Certificate.html#certificateRejected"><span class="hs-identifier hs-var">certificateRejected</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateRejectReason
</span><a href="#local-6989586621679195215"><span class="hs-identifier hs-var">reason</span></a></span><span>
</span><span id="line-736"></span><span>    </span><span class="annot"><span class="annottext">RecvState IO -&gt; IO (RecvState IO)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(RecvState IO -&gt; IO (RecvState IO))
-&gt; RecvState IO -&gt; IO (RecvState IO)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Handshake -&gt; IO (RecvState IO)) -&gt; RecvState IO
forall (m :: * -&gt; *). (Handshake -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateHandshake"><span class="hs-identifier hs-var">RecvStateHandshake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Handshake -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#processServerKeyExchange"><span class="hs-identifier hs-var">processServerKeyExchange</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195202"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679195218"><span class="annot"><span class="annottext">shared :: Shared
</span><a href="#local-6989586621679195218"><span class="hs-identifier hs-var hs-var">shared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Shared
</span><a href="Network.TLS.Parameters.html#clientShared"><span class="hs-identifier hs-var">clientShared</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195201"><span class="hs-identifier hs-var">cparams</span></a></span><span>
</span><span id="line-738"></span><span>        </span><span id="local-6989586621679195210"><span class="annot"><span class="annottext">checkCert :: IO [FailedReason]
</span><a href="#local-6989586621679195210"><span class="hs-identifier hs-var hs-var">checkCert</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ClientHooks -&gt; OnServerCertificate
</span><a href="Network.TLS.Parameters.html#onServerCertificate"><span class="hs-identifier hs-var">onServerCertificate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientParams -&gt; ClientHooks
</span><a href="Network.TLS.Parameters.html#clientHooks"><span class="hs-identifier hs-var">clientHooks</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195201"><span class="hs-identifier hs-var">cparams</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shared -&gt; CertificateStore
</span><a href="Network.TLS.Parameters.html#sharedCAStore"><span class="hs-identifier hs-var">sharedCAStore</span></a></span><span> </span><span class="annot"><span class="annottext">Shared
</span><a href="#local-6989586621679195218"><span class="hs-identifier hs-var">shared</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-739"></span><span>                                                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shared -&gt; ValidationCache
</span><a href="Network.TLS.Parameters.html#sharedValidationCache"><span class="hs-identifier hs-var">sharedValidationCache</span></a></span><span> </span><span class="annot"><span class="annottext">Shared
</span><a href="#local-6989586621679195218"><span class="hs-identifier hs-var">shared</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-740"></span><span>                                                              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientParams -&gt; (String, ByteString)
</span><a href="Network.TLS.Parameters.html#clientServerIdentification"><span class="hs-identifier hs-var">clientServerIdentification</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195201"><span class="hs-identifier hs-var">cparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span>                                                              </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195203"><span class="hs-identifier hs-var">certs</span></a></span><span>
</span><span id="line-742"></span><span>        </span><span class="hs-comment">-- also verify that the certificate optional key usage is compatible</span><span>
</span><span id="line-743"></span><span>        </span><span class="hs-comment">-- with the intended key-exchange.  This check is not delegated to</span><span>
</span><span id="line-744"></span><span>        </span><span class="hs-comment">-- x509-validation 'checkLeafKeyUsage' because it depends on negotiated</span><span>
</span><span id="line-745"></span><span>        </span><span class="hs-comment">-- cipher, which is not available from onServerCertificate parameters.</span><span>
</span><span id="line-746"></span><span>        </span><span class="hs-comment">-- Additionally, with only one shared ValidationCache, x509-validation</span><span>
</span><span id="line-747"></span><span>        </span><span class="hs-comment">-- would cache validation result based on a key usage and reuse it with</span><span>
</span><span id="line-748"></span><span>        </span><span class="hs-comment">-- another key usage.</span><span>
</span><span id="line-749"></span><span>        </span><span id="local-6989586621679195213"><span class="annot"><span class="annottext">checkLeafCertificateKeyUsage :: IO ()
</span><a href="#local-6989586621679195213"><span class="hs-identifier hs-var hs-var">checkLeafCertificateKeyUsage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-750"></span><span>            </span><span id="local-6989586621679195231"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195231"><span class="hs-identifier hs-var">cipher</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM Cipher -&gt; IO Cipher
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195202"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM Cipher
</span><a href="Network.TLS.Handshake.State.html#getPendingCipher"><span class="hs-identifier hs-var">getPendingCipher</span></a></span><span>
</span><span id="line-751"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; [ExtKeyUsageFlag]
</span><a href="Network.TLS.Handshake.Client.html#requiredCertKeyUsage"><span class="hs-identifier hs-var">requiredCertKeyUsage</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195231"><span class="hs-identifier hs-var">cipher</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-752"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-753"></span><span>                </span><span id="local-6989586621679195233"><span class="annot"><span class="annottext">[ExtKeyUsageFlag]
</span><a href="#local-6989586621679195233"><span class="hs-identifier hs-var">flags</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ExtKeyUsageFlag] -&gt; CertificateChain -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
[ExtKeyUsageFlag] -&gt; CertificateChain -&gt; m ()
</span><a href="Network.TLS.Handshake.Certificate.html#verifyLeafKeyUsage"><span class="hs-identifier hs-var">verifyLeafKeyUsage</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtKeyUsageFlag]
</span><a href="#local-6989586621679195233"><span class="hs-identifier hs-var">flags</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195203"><span class="hs-identifier hs-var">certs</span></a></span><span>
</span><span id="line-754"></span><span>
</span><span id="line-755"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#processCertificate"><span class="hs-identifier hs-var">processCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679195235"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195235"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679195236"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679195236"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Handshake -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#processServerKeyExchange"><span class="hs-identifier hs-var">processServerKeyExchange</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195235"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679195236"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-756"></span><span>
</span><span id="line-757"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#expectChangeCipher"><span class="hs-identifier hs-type">expectChangeCipher</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Packet"><span class="hs-identifier hs-type">Packet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Handshake.Common.html#RecvState"><span class="hs-identifier hs-type">RecvState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span>
</span><span id="line-758"></span><span id="expectChangeCipher"><span class="annot"><span class="annottext">expectChangeCipher :: Packet -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#expectChangeCipher"><span class="hs-identifier hs-var hs-var">expectChangeCipher</span></a></span></span><span> </span><span class="annot"><span class="annottext">Packet
</span><a href="Network.TLS.Struct.html#ChangeCipherSpec"><span class="hs-identifier hs-var">ChangeCipherSpec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecvState IO -&gt; IO (RecvState IO)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(RecvState IO -&gt; IO (RecvState IO))
-&gt; RecvState IO -&gt; IO (RecvState IO)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Handshake -&gt; IO (RecvState IO)) -&gt; RecvState IO
forall (m :: * -&gt; *). (Handshake -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateHandshake"><span class="hs-identifier hs-var">RecvStateHandshake</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#expectFinish"><span class="hs-identifier hs-var">expectFinish</span></a></span><span>
</span><span id="line-759"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#expectChangeCipher"><span class="hs-identifier hs-var">expectChangeCipher</span></a></span><span> </span><span id="local-6989586621679195239"><span class="annot"><span class="annottext">Packet
</span><a href="#local-6989586621679195239"><span class="hs-identifier hs-var">p</span></a></span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; IO (RecvState IO)
forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Packet -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Packet
</span><a href="#local-6989586621679195239"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;change cipher&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-760"></span><span>
</span><span id="line-761"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#expectFinish"><span class="hs-identifier hs-type">expectFinish</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Handshake.Common.html#RecvState"><span class="hs-identifier hs-type">RecvState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span id="expectFinish"><span class="annot"><span class="annottext">expectFinish :: Handshake -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#expectFinish"><span class="hs-identifier hs-var hs-var">expectFinish</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#Finished"><span class="hs-identifier hs-type">Finished</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecvState IO -&gt; IO (RecvState IO)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">RecvState IO
forall (m :: * -&gt; *). RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateDone"><span class="hs-identifier hs-var">RecvStateDone</span></a></span><span>
</span><span id="line-763"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#expectFinish"><span class="hs-identifier hs-var">expectFinish</span></a></span><span> </span><span id="local-6989586621679195241"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679195241"><span class="hs-identifier hs-var">p</span></a></span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; IO (RecvState IO)
forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handshake -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679195241"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Handshake Finished&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-764"></span><span>
</span><span id="line-765"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#processServerKeyExchange"><span class="hs-identifier hs-type">processServerKeyExchange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Handshake.Common.html#RecvState"><span class="hs-identifier hs-type">RecvState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span>
</span><span id="line-766"></span><span id="processServerKeyExchange"><span class="annot"><span class="annottext">processServerKeyExchange :: Context -&gt; Handshake -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#processServerKeyExchange"><span class="hs-identifier hs-var hs-var">processServerKeyExchange</span></a></span></span><span> </span><span id="local-6989586621679195242"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195242"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#ServerKeyXchg"><span class="hs-identifier hs-type">ServerKeyXchg</span></a></span><span> </span><span id="local-6989586621679195244"><span class="annot"><span class="annottext">ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679195244"><span class="hs-identifier hs-var">origSkx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-767"></span><span>    </span><span id="local-6989586621679195245"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195245"><span class="hs-identifier hs-var">cipher</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM Cipher -&gt; IO Cipher
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195242"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM Cipher
</span><a href="Network.TLS.Handshake.State.html#getPendingCipher"><span class="hs-identifier hs-var">getPendingCipher</span></a></span><span>
</span><span id="line-768"></span><span>    </span><span class="annot"><span class="annottext">Cipher -&gt; ServerKeyXchgAlgorithmData -&gt; IO ()
</span><a href="#local-6989586621679195246"><span class="hs-identifier hs-var">processWithCipher</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195245"><span class="hs-identifier hs-var">cipher</span></a></span><span> </span><span class="annot"><span class="annottext">ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679195244"><span class="hs-identifier hs-var">origSkx</span></a></span><span>
</span><span id="line-769"></span><span>    </span><span class="annot"><span class="annottext">RecvState IO -&gt; IO (RecvState IO)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(RecvState IO -&gt; IO (RecvState IO))
-&gt; RecvState IO -&gt; IO (RecvState IO)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Handshake -&gt; IO (RecvState IO)) -&gt; RecvState IO
forall (m :: * -&gt; *). (Handshake -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateHandshake"><span class="hs-identifier hs-var">RecvStateHandshake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Handshake -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#processCertificateRequest"><span class="hs-identifier hs-var">processCertificateRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195242"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679195246"><span class="annot"><span class="annottext">processWithCipher :: Cipher -&gt; ServerKeyXchgAlgorithmData -&gt; IO ()
</span><a href="#local-6989586621679195246"><span class="hs-identifier hs-var hs-var">processWithCipher</span></a></span></span><span> </span><span id="local-6989586621679195257"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195257"><span class="hs-identifier hs-var">cipher</span></a></span></span><span> </span><span id="local-6989586621679195258"><span class="annot"><span class="annottext">ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679195258"><span class="hs-identifier hs-var">skx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-771"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cipher -&gt; CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#cipherKeyExchange"><span class="hs-identifier hs-var">cipherKeyExchange</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195257"><span class="hs-identifier hs-var">cipher</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679195258"><span class="hs-identifier hs-var">skx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-772"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_RSA</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#SKX_DHE_RSA"><span class="hs-identifier hs-type">SKX_DHE_RSA</span></a></span><span> </span><span id="local-6989586621679195260"><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679195260"><span class="hs-identifier hs-var">dhparams</span></a></span></span><span> </span><span id="local-6989586621679195261"><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195261"><span class="hs-keyword hs-var">signature</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-773"></span><span>                    </span><span class="annot"><span class="annottext">ServerDHParams
-&gt; DigitallySigned -&gt; KeyExchangeSignatureAlg -&gt; IO ()
</span><a href="#local-6989586621679195262"><span class="hs-identifier hs-var">doDHESignature</span></a></span><span> </span><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679195260"><span class="hs-identifier hs-var">dhparams</span></a></span><span> </span><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195261"><span class="hs-keyword hs-var">signature</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_RSA"><span class="hs-identifier hs-var">KX_RSA</span></a></span><span>
</span><span id="line-774"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_DSS"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_DSS</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#SKX_DHE_DSS"><span class="hs-identifier hs-type">SKX_DHE_DSS</span></a></span><span> </span><span id="local-6989586621679195265"><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679195265"><span class="hs-identifier hs-var">dhparams</span></a></span></span><span> </span><span id="local-6989586621679195266"><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195266"><span class="hs-keyword hs-var">signature</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-775"></span><span>                    </span><span class="annot"><span class="annottext">ServerDHParams
-&gt; DigitallySigned -&gt; KeyExchangeSignatureAlg -&gt; IO ()
</span><a href="#local-6989586621679195262"><span class="hs-identifier hs-var">doDHESignature</span></a></span><span> </span><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679195265"><span class="hs-identifier hs-var">dhparams</span></a></span><span> </span><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195266"><span class="hs-keyword hs-var">signature</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_DSS"><span class="hs-identifier hs-var">KX_DSS</span></a></span><span>
</span><span id="line-776"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_RSA</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#SKX_ECDHE_RSA"><span class="hs-identifier hs-type">SKX_ECDHE_RSA</span></a></span><span> </span><span id="local-6989586621679195269"><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679195269"><span class="hs-identifier hs-var">ecdhparams</span></a></span></span><span> </span><span id="local-6989586621679195270"><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195270"><span class="hs-keyword hs-var">signature</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-777"></span><span>                    </span><span class="annot"><span class="annottext">ServerECDHParams
-&gt; DigitallySigned -&gt; KeyExchangeSignatureAlg -&gt; IO ()
</span><a href="#local-6989586621679195271"><span class="hs-identifier hs-var">doECDHESignature</span></a></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679195269"><span class="hs-identifier hs-var">ecdhparams</span></a></span><span> </span><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195270"><span class="hs-keyword hs-var">signature</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_RSA"><span class="hs-identifier hs-var">KX_RSA</span></a></span><span>
</span><span id="line-778"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_ECDSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_ECDSA</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#SKX_ECDHE_ECDSA"><span class="hs-identifier hs-type">SKX_ECDHE_ECDSA</span></a></span><span> </span><span id="local-6989586621679195273"><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679195273"><span class="hs-identifier hs-var">ecdhparams</span></a></span></span><span> </span><span id="local-6989586621679195274"><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195274"><span class="hs-keyword hs-var">signature</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-779"></span><span>                    </span><span class="annot"><span class="annottext">ServerECDHParams
-&gt; DigitallySigned -&gt; KeyExchangeSignatureAlg -&gt; IO ()
</span><a href="#local-6989586621679195271"><span class="hs-identifier hs-var">doECDHESignature</span></a></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679195273"><span class="hs-identifier hs-var">ecdhparams</span></a></span><span> </span><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195274"><span class="hs-keyword hs-var">signature</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="Network.TLS.Crypto.Types.html#KX_ECDSA"><span class="hs-identifier hs-var">KX_ECDSA</span></a></span><span>
</span><span id="line-780"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621679195276"><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="#local-6989586621679195276"><span class="hs-identifier hs-var">cke</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#SKX_Unparsed"><span class="hs-identifier hs-type">SKX_Unparsed</span></a></span><span> </span><span id="local-6989586621679195278"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195278"><span class="hs-identifier hs-var">bytes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-781"></span><span>                    </span><span id="local-6989586621679195279"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195279"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Version -&gt; IO Version
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195242"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-782"></span><span>                    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Version
-&gt; CipherKeyExchangeType
-&gt; ByteString
-&gt; Either TLSError ServerKeyXchgAlgorithmData
</span><a href="Network.TLS.Packet.html#decodeReallyServerKeyXchgAlgorithmData"><span class="hs-identifier hs-var">decodeReallyServerKeyXchgAlgorithmData</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195279"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="#local-6989586621679195276"><span class="hs-identifier hs-var">cke</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195278"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-783"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">TLSError
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unknown server key exchange received, expecting: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">CipherKeyExchangeType -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="#local-6989586621679195276"><span class="hs-identifier hs-var">cke</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-784"></span><span>                        </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679195281"><span class="annot"><span class="annottext">ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679195281"><span class="hs-identifier hs-var">realSkx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; ServerKeyXchgAlgorithmData -&gt; IO ()
</span><a href="#local-6989586621679195246"><span class="hs-identifier hs-var">processWithCipher</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195257"><span class="hs-identifier hs-var">cipher</span></a></span><span> </span><span class="annot"><span class="annottext">ServerKeyXchgAlgorithmData
</span><a href="#local-6989586621679195281"><span class="hs-identifier hs-var">realSkx</span></a></span><span>
</span><span id="line-785"></span><span>                    </span><span class="hs-comment">-- we need to resolve the result. and recall processWithCipher ..</span><span>
</span><span id="line-786"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621679195282"><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="#local-6989586621679195282"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">ServerKeyXchgAlgorithmData
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unknown server key exchange received, expecting: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">CipherKeyExchangeType -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="#local-6989586621679195282"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-787"></span><span>        </span><span id="local-6989586621679195262"><span class="annot"><span class="annottext">doDHESignature :: ServerDHParams
-&gt; DigitallySigned -&gt; KeyExchangeSignatureAlg -&gt; IO ()
</span><a href="#local-6989586621679195262"><span class="hs-identifier hs-var hs-var">doDHESignature</span></a></span></span><span> </span><span id="local-6989586621679195294"><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679195294"><span class="hs-identifier hs-var">dhparams</span></a></span></span><span> </span><span id="local-6989586621679195295"><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195295"><span class="hs-keyword hs-var">signature</span></a></span></span><span> </span><span id="local-6989586621679195296"><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679195296"><span class="hs-identifier hs-var">kxsAlg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-788"></span><span>            </span><span class="hs-comment">-- FF group selected by the server is verified when generating CKX</span><span>
</span><span id="line-789"></span><span>            </span><span id="local-6989586621679195297"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195297"><span class="hs-identifier hs-var">publicKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg -&gt; IO PubKey
</span><a href="#local-6989586621679195298"><span class="hs-identifier hs-var">getSignaturePublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679195296"><span class="hs-identifier hs-var">kxsAlg</span></a></span><span>
</span><span id="line-790"></span><span>            </span><span id="local-6989586621679195299"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195299"><span class="hs-identifier hs-var">verified</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; ServerDHParams -&gt; PubKey -&gt; DigitallySigned -&gt; IO Bool
</span><a href="Network.TLS.Handshake.Signature.html#digitallySignDHParamsVerify"><span class="hs-identifier hs-var">digitallySignDHParamsVerify</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195242"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679195294"><span class="hs-identifier hs-var">dhparams</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195297"><span class="hs-identifier hs-var">publicKey</span></a></span><span> </span><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195295"><span class="hs-keyword hs-var">signature</span></a></span><span>
</span><span id="line-791"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195299"><span class="hs-identifier hs-var">verified</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; m a
</span><a href="Network.TLS.Handshake.Signature.html#decryptError"><span class="hs-identifier hs-var">decryptError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bad &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; String
</span><a href="Network.TLS.X509.html#pubkeyType"><span class="hs-identifier hs-var">pubkeyType</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195297"><span class="hs-identifier hs-var">publicKey</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; signature for dhparams &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">ServerDHParams -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679195294"><span class="hs-identifier hs-var">dhparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-792"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195242"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerDHParams -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setServerDHParams"><span class="hs-identifier hs-var">setServerDHParams</span></a></span><span> </span><span class="annot"><span class="annottext">ServerDHParams
</span><a href="#local-6989586621679195294"><span class="hs-identifier hs-var">dhparams</span></a></span><span>
</span><span id="line-793"></span><span>
</span><span id="line-794"></span><span>        </span><span id="local-6989586621679195271"><span class="annot"><span class="annottext">doECDHESignature :: ServerECDHParams
-&gt; DigitallySigned -&gt; KeyExchangeSignatureAlg -&gt; IO ()
</span><a href="#local-6989586621679195271"><span class="hs-identifier hs-var hs-var">doECDHESignature</span></a></span></span><span> </span><span id="local-6989586621679195312"><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679195312"><span class="hs-identifier hs-var">ecdhparams</span></a></span></span><span> </span><span id="local-6989586621679195313"><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195313"><span class="hs-keyword hs-var">signature</span></a></span></span><span> </span><span id="local-6989586621679195314"><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679195314"><span class="hs-identifier hs-var">kxsAlg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-795"></span><span>            </span><span class="hs-comment">-- EC group selected by the server is verified when generating CKX</span><span>
</span><span id="line-796"></span><span>            </span><span id="local-6989586621679195315"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195315"><span class="hs-identifier hs-var">publicKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg -&gt; IO PubKey
</span><a href="#local-6989586621679195298"><span class="hs-identifier hs-var">getSignaturePublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679195314"><span class="hs-identifier hs-var">kxsAlg</span></a></span><span>
</span><span id="line-797"></span><span>            </span><span id="local-6989586621679195316"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195316"><span class="hs-identifier hs-var">verified</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; ServerECDHParams -&gt; PubKey -&gt; DigitallySigned -&gt; IO Bool
</span><a href="Network.TLS.Handshake.Signature.html#digitallySignECDHParamsVerify"><span class="hs-identifier hs-var">digitallySignECDHParamsVerify</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195242"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679195312"><span class="hs-identifier hs-var">ecdhparams</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195315"><span class="hs-identifier hs-var">publicKey</span></a></span><span> </span><span class="annot"><span class="annottext">DigitallySigned
</span><a href="#local-6989586621679195313"><span class="hs-keyword hs-var">signature</span></a></span><span>
</span><span id="line-798"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195316"><span class="hs-identifier hs-var">verified</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; m a
</span><a href="Network.TLS.Handshake.Signature.html#decryptError"><span class="hs-identifier hs-var">decryptError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bad &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; String
</span><a href="Network.TLS.X509.html#pubkeyType"><span class="hs-identifier hs-var">pubkeyType</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195315"><span class="hs-identifier hs-var">publicKey</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; signature for ecdhparams&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-799"></span><span>            </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195242"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setServerECDHParams"><span class="hs-identifier hs-var">setServerECDHParams</span></a></span><span> </span><span class="annot"><span class="annottext">ServerECDHParams
</span><a href="#local-6989586621679195312"><span class="hs-identifier hs-var">ecdhparams</span></a></span><span>
</span><span id="line-800"></span><span>
</span><span id="line-801"></span><span>        </span><span id="local-6989586621679195298"><span class="annot"><span class="annottext">getSignaturePublicKey :: KeyExchangeSignatureAlg -&gt; IO PubKey
</span><a href="#local-6989586621679195298"><span class="hs-identifier hs-var hs-var">getSignaturePublicKey</span></a></span></span><span> </span><span id="local-6989586621679195340"><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679195340"><span class="hs-identifier hs-var">kxsAlg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-802"></span><span>            </span><span id="local-6989586621679195341"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195341"><span class="hs-identifier hs-var">publicKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM PubKey -&gt; IO PubKey
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195242"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM PubKey
</span><a href="Network.TLS.Handshake.State.html#getRemotePublicKey"><span class="hs-identifier hs-var">getRemotePublicKey</span></a></span><span>
</span><span id="line-803"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg -&gt; PubKey -&gt; Bool
</span><a href="Network.TLS.Crypto.html#isKeyExchangeSignatureKey"><span class="hs-identifier hs-var">isKeyExchangeSignatureKey</span></a></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679195340"><span class="hs-identifier hs-var">kxsAlg</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195341"><span class="hs-identifier hs-var">publicKey</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-804"></span><span>                </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server public key algorithm is incompatible with &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">KeyExchangeSignatureAlg
</span><a href="#local-6989586621679195340"><span class="hs-identifier hs-var">kxsAlg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>            </span><span id="local-6989586621679195344"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195344"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Version -&gt; IO Version
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195242"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-806"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195341"><span class="hs-identifier hs-var">publicKey</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; Version -&gt; Bool
</span><a href="Network.TLS.Handshake.Key.html#versionCompatible"><span class="hs-operator hs-var">`versionCompatible`</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195344"><span class="hs-identifier hs-var">ver</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-807"></span><span>                </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195344"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; has no support for &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; String
</span><a href="Network.TLS.X509.html#pubkeyType"><span class="hs-identifier hs-var">pubkeyType</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195341"><span class="hs-identifier hs-var">publicKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-808"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195345"><span class="annot"><span class="annottext">groups :: [Group]
</span><a href="#local-6989586621679195345"><span class="hs-identifier hs-var hs-var">groups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [Group]
</span><a href="Network.TLS.Parameters.html#supportedGroups"><span class="hs-identifier hs-var">supportedGroups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195242"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-809"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Group -&gt; Bool) -&gt; PubKey -&gt; Bool
</span><a href="Network.TLS.Handshake.Key.html#satisfiesEcPredicate"><span class="hs-identifier hs-var">satisfiesEcPredicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Group -&gt; [Group] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[Group]
</span><a href="#local-6989586621679195345"><span class="hs-identifier hs-var">groups</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195341"><span class="hs-identifier hs-var">publicKey</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-810"></span><span>                </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server public key has unsupported elliptic curve&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-811"></span><span>            </span><span class="annot"><span class="annottext">PubKey -&gt; IO PubKey
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195341"><span class="hs-identifier hs-var">publicKey</span></a></span><span>
</span><span id="line-812"></span><span>
</span><span id="line-813"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#processServerKeyExchange"><span class="hs-identifier hs-var">processServerKeyExchange</span></a></span><span> </span><span id="local-6989586621679195347"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195347"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679195348"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679195348"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Handshake -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#processCertificateRequest"><span class="hs-identifier hs-var">processCertificateRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195347"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679195348"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-814"></span><span>
</span><span id="line-815"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#processCertificateRequest"><span class="hs-identifier hs-type">processCertificateRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Handshake.Common.html#RecvState"><span class="hs-identifier hs-type">RecvState</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span class="hs-special">)</span><span>
</span><span id="line-816"></span><span id="processCertificateRequest"><span class="annot"><span class="annottext">processCertificateRequest :: Context -&gt; Handshake -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#processCertificateRequest"><span class="hs-identifier hs-var hs-var">processCertificateRequest</span></a></span></span><span> </span><span id="local-6989586621679195349"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195349"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct.html#CertRequest"><span class="hs-identifier hs-type">CertRequest</span></a></span><span> </span><span id="local-6989586621679195351"><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679195351"><span class="hs-identifier hs-var">cTypesSent</span></a></span></span><span> </span><span id="local-6989586621679195352"><span class="annot"><span class="annottext">Maybe [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195352"><span class="hs-identifier hs-var">sigAlgs</span></a></span></span><span> </span><span id="local-6989586621679195353"><span class="annot"><span class="annottext">[DistinguishedName]
</span><a href="#local-6989586621679195353"><span class="hs-identifier hs-var">dNames</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-817"></span><span>    </span><span id="local-6989586621679195354"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195354"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Version -&gt; IO Version
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195349"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-818"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195354"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">Version -&gt; Version -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS12"><span class="hs-identifier hs-var">TLS12</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Maybe [HashAndSignatureAlgorithm] -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isNothing</span></span><span> </span><span class="annot"><span class="annottext">Maybe [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195352"><span class="hs-identifier hs-var">sigAlgs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-819"></span><span>        </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span>
</span><span id="line-820"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;missing TLS 1.2 certificate request signature algorithms&quot;</span></span><span>
</span><span id="line-821"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-822"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#InternalError"><span class="hs-identifier hs-var">InternalError</span></a></span><span>
</span><span id="line-823"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-824"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195357"><span class="annot"><span class="annottext">cTypes :: [CertificateType]
</span><a href="#local-6989586621679195357"><span class="hs-identifier hs-var hs-var">cTypes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CertificateType -&gt; Bool) -&gt; [CertificateType] -&gt; [CertificateType]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CertificateType -&gt; CertificateType -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">CertificateType
</span><a href="Network.TLS.Struct.html#lastSupportedCertificateType"><span class="hs-identifier hs-var">lastSupportedCertificateType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679195351"><span class="hs-identifier hs-var">cTypesSent</span></a></span><span>
</span><span id="line-825"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195349"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe CertReqCBdata -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setCertReqCBdata"><span class="hs-identifier hs-var">setCertReqCBdata</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe CertReqCBdata -&gt; HandshakeM ())
-&gt; Maybe CertReqCBdata -&gt; HandshakeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CertReqCBdata -&gt; Maybe CertReqCBdata
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679195357"><span class="hs-identifier hs-var">cTypes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195352"><span class="hs-identifier hs-var">sigAlgs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DistinguishedName]
</span><a href="#local-6989586621679195353"><span class="hs-identifier hs-var">dNames</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-826"></span><span>    </span><span class="annot"><span class="annottext">RecvState IO -&gt; IO (RecvState IO)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(RecvState IO -&gt; IO (RecvState IO))
-&gt; RecvState IO -&gt; IO (RecvState IO)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Handshake -&gt; IO (RecvState IO)) -&gt; RecvState IO
forall (m :: * -&gt; *). (Handshake -&gt; m (RecvState m)) -&gt; RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateHandshake"><span class="hs-identifier hs-var">RecvStateHandshake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Handshake -&gt; IO (RecvState IO)
forall (m :: * -&gt; *). Context -&gt; Handshake -&gt; IO (RecvState m)
</span><a href="Network.TLS.Handshake.Client.html#processServerHelloDone"><span class="hs-identifier hs-var">processServerHelloDone</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195349"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-827"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#processCertificateRequest"><span class="hs-identifier hs-var">processCertificateRequest</span></a></span><span> </span><span id="local-6989586621679195360"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195360"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679195361"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679195361"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-828"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195360"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe CertReqCBdata -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setCertReqCBdata"><span class="hs-identifier hs-var">setCertReqCBdata</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CertReqCBdata
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-829"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; Handshake -&gt; IO (RecvState IO)
forall (m :: * -&gt; *). Context -&gt; Handshake -&gt; IO (RecvState m)
</span><a href="Network.TLS.Handshake.Client.html#processServerHelloDone"><span class="hs-identifier hs-var">processServerHelloDone</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195360"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679195361"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-830"></span><span>
</span><span id="line-831"></span><span id="local-6989586621679193990"><span class="annot"><a href="Network.TLS.Handshake.Client.html#processServerHelloDone"><span class="hs-identifier hs-type">processServerHelloDone</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct.html#Handshake"><span class="hs-identifier hs-type">Handshake</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Handshake.Common.html#RecvState"><span class="hs-identifier hs-type">RecvState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679193990"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-832"></span><span id="processServerHelloDone"><span class="annot"><span class="annottext">processServerHelloDone :: forall (m :: * -&gt; *). Context -&gt; Handshake -&gt; IO (RecvState m)
</span><a href="Network.TLS.Handshake.Client.html#processServerHelloDone"><span class="hs-identifier hs-var hs-var">processServerHelloDone</span></a></span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="Network.TLS.Struct.html#ServerHelloDone"><span class="hs-identifier hs-var">ServerHelloDone</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RecvState m -&gt; IO (RecvState m)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">RecvState m
forall (m :: * -&gt; *). RecvState m
</span><a href="Network.TLS.Handshake.Common.html#RecvStateDone"><span class="hs-identifier hs-var">RecvStateDone</span></a></span><span>
</span><span id="line-833"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#processServerHelloDone"><span class="hs-identifier hs-var">processServerHelloDone</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679195367"><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679195367"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; IO (RecvState m)
forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handshake -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake
</span><a href="#local-6989586621679195367"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server hello data&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-834"></span><span>
</span><span id="line-835"></span><span class="hs-comment">-- Unless result is empty, server certificate must be allowed for at least one</span><span>
</span><span id="line-836"></span><span class="hs-comment">-- of the returned values.  Constraints for RSA-based key exchange are relaxed</span><span>
</span><span id="line-837"></span><span class="hs-comment">-- to avoid rejecting certificates having incomplete extension.</span><span>
</span><span id="line-838"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#requiredCertKeyUsage"><span class="hs-identifier hs-type">requiredCertKeyUsage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Cipher.html#Cipher"><span class="hs-identifier hs-type">Cipher</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">ExtKeyUsageFlag</span></span><span class="hs-special">]</span><span>
</span><span id="line-839"></span><span id="requiredCertKeyUsage"><span class="annot"><span class="annottext">requiredCertKeyUsage :: Cipher -&gt; [ExtKeyUsageFlag]
</span><a href="Network.TLS.Handshake.Client.html#requiredCertKeyUsage"><span class="hs-identifier hs-var hs-var">requiredCertKeyUsage</span></a></span></span><span> </span><span id="local-6989586621679195368"><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195368"><span class="hs-identifier hs-var">cipher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-840"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#cipherKeyExchange"><span class="hs-identifier hs-var">cipherKeyExchange</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195368"><span class="hs-identifier hs-var">cipher</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-841"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_RSA</span></a></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ExtKeyUsageFlag]
</span><a href="#local-6989586621679195369"><span class="hs-identifier hs-var">rsaCompatibility</span></a></span><span>
</span><span id="line-842"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DH_Anon"><span class="hs-identifier hs-var">CipherKeyExchange_DH_Anon</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- unrestricted</span><span>
</span><span id="line-843"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_RSA</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ExtKeyUsageFlag]
</span><a href="#local-6989586621679195369"><span class="hs-identifier hs-var">rsaCompatibility</span></a></span><span>
</span><span id="line-844"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_RSA</span></a></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ExtKeyUsageFlag]
</span><a href="#local-6989586621679195369"><span class="hs-identifier hs-var">rsaCompatibility</span></a></span><span>
</span><span id="line-845"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DHE_DSS"><span class="hs-identifier hs-var">CipherKeyExchange_DHE_DSS</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ExtKeyUsageFlag
</span><span class="hs-identifier hs-var">KeyUsage_digitalSignature</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-846"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DH_DSS"><span class="hs-identifier hs-var">CipherKeyExchange_DH_DSS</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ExtKeyUsageFlag
</span><span class="hs-identifier hs-var">KeyUsage_keyAgreement</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-847"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_DH_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_DH_RSA</span></a></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ExtKeyUsageFlag]
</span><a href="#local-6989586621679195369"><span class="hs-identifier hs-var">rsaCompatibility</span></a></span><span>
</span><span id="line-848"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDH_ECDSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDH_ECDSA</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ExtKeyUsageFlag
</span><span class="hs-identifier hs-var">KeyUsage_keyAgreement</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-849"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDH_RSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDH_RSA</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ExtKeyUsageFlag]
</span><a href="#local-6989586621679195369"><span class="hs-identifier hs-var">rsaCompatibility</span></a></span><span>
</span><span id="line-850"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_ECDHE_ECDSA"><span class="hs-identifier hs-var">CipherKeyExchange_ECDHE_ECDSA</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ExtKeyUsageFlag
</span><span class="hs-identifier hs-var">KeyUsage_digitalSignature</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-851"></span><span>        </span><span class="annot"><span class="annottext">CipherKeyExchangeType
</span><a href="Network.TLS.Cipher.html#CipherKeyExchange_TLS13"><span class="hs-identifier hs-var">CipherKeyExchange_TLS13</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ExtKeyUsageFlag
</span><span class="hs-identifier hs-var">KeyUsage_digitalSignature</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-852"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679195369"><span class="annot"><span class="annottext">rsaCompatibility :: [ExtKeyUsageFlag]
</span><a href="#local-6989586621679195369"><span class="hs-identifier hs-var hs-var">rsaCompatibility</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ExtKeyUsageFlag
</span><span class="hs-identifier hs-var">KeyUsage_digitalSignature</span></span><span>
</span><span id="line-853"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ExtKeyUsageFlag
</span><span class="hs-identifier hs-var">KeyUsage_keyEncipherment</span></span><span>
</span><span id="line-854"></span><span>                           </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ExtKeyUsageFlag
</span><span class="hs-identifier hs-var">KeyUsage_keyAgreement</span></span><span>
</span><span id="line-855"></span><span>                           </span><span class="hs-special">]</span><span>
</span><span id="line-856"></span><span>
</span><span id="line-857"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#handshakeClient13"><span class="hs-identifier hs-type">handshakeClient13</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ClientParams"><span class="hs-identifier hs-type">ClientParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.TLS.Crypto.Types.html#Group"><span class="hs-identifier hs-type">Group</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-858"></span><span id="handshakeClient13"><span class="annot"><span class="annottext">handshakeClient13 :: ClientParams -&gt; Context -&gt; Maybe Group -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#handshakeClient13"><span class="hs-identifier hs-var hs-var">handshakeClient13</span></a></span></span><span> </span><span id="local-6989586621679195379"><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195379"><span class="hs-identifier hs-var">cparams</span></a></span></span><span> </span><span id="local-6989586621679195380"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195380"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679195381"><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679195381"><span class="hs-identifier hs-var">groupSent</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-859"></span><span>    </span><span id="local-6989586621679195382"><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679195382"><span class="hs-identifier hs-var">choice</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Version -&gt; Cipher -&gt; CipherChoice
</span><a href="Network.TLS.Handshake.Common13.html#makeCipherChoice"><span class="hs-identifier hs-var">makeCipherChoice</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="Network.TLS.Types.html#TLS13"><span class="hs-identifier hs-var">TLS13</span></a></span><span> </span><span class="annot"><span class="annottext">(Cipher -&gt; CipherChoice) -&gt; IO Cipher -&gt; IO CipherChoice
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM Cipher -&gt; IO Cipher
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195380"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM Cipher
</span><a href="Network.TLS.Handshake.State.html#getPendingCipher"><span class="hs-identifier hs-var">getPendingCipher</span></a></span><span>
</span><span id="line-860"></span><span>    </span><span class="annot"><span class="annottext">ClientParams -&gt; Context -&gt; Maybe Group -&gt; CipherChoice -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#handshakeClient13%27"><span class="hs-identifier hs-var">handshakeClient13'</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195379"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195380"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679195381"><span class="hs-identifier hs-var">groupSent</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679195382"><span class="hs-identifier hs-var">choice</span></a></span><span>
</span><span id="line-861"></span><span>
</span><span id="line-862"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#handshakeClient13%27"><span class="hs-identifier hs-type">handshakeClient13'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ClientParams"><span class="hs-identifier hs-type">ClientParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Network.TLS.Crypto.Types.html#Group"><span class="hs-identifier hs-type">Group</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Common13.html#CipherChoice"><span class="hs-identifier hs-type">CipherChoice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-863"></span><span id="handshakeClient13%27"><span class="annot"><span class="annottext">handshakeClient13' :: ClientParams -&gt; Context -&gt; Maybe Group -&gt; CipherChoice -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#handshakeClient13%27"><span class="hs-identifier hs-var hs-var">handshakeClient13'</span></a></span></span><span> </span><span id="local-6989586621679195384"><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195384"><span class="hs-identifier hs-var">cparams</span></a></span></span><span> </span><span id="local-6989586621679195385"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679195386"><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679195386"><span class="hs-identifier hs-var">groupSent</span></a></span></span><span> </span><span id="local-6989586621679195387"><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679195387"><span class="hs-identifier hs-var">choice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-864"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cipher
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679195388"><span class="annot"><span class="annottext">SecretTriple HandshakeSecret
</span><a href="#local-6989586621679195388"><span class="hs-identifier hs-var">hkey</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679195389"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195389"><span class="hs-identifier hs-var">resuming</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Cipher, SecretTriple HandshakeSecret, Bool)
</span><a href="#local-6989586621679195390"><span class="hs-identifier hs-var">switchToHandshakeSecret</span></a></span><span>
</span><span id="line-865"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195391"><span class="annot"><span class="annottext">handshakeSecret :: BaseSecret HandshakeSecret
</span><a href="#local-6989586621679195391"><span class="hs-identifier hs-var hs-var">handshakeSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretTriple HandshakeSecret -&gt; BaseSecret HandshakeSecret
forall a. SecretTriple a -&gt; BaseSecret a
</span><a href="Network.TLS.Types.html#triBase"><span class="hs-identifier hs-var">triBase</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple HandshakeSecret
</span><a href="#local-6989586621679195388"><span class="hs-identifier hs-var">hkey</span></a></span><span>
</span><span id="line-866"></span><span>        </span><span id="local-6989586621679195393"><span class="annot"><span class="annottext">clientHandshakeSecret :: ClientTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679195393"><span class="hs-identifier hs-var hs-var">clientHandshakeSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretTriple HandshakeSecret -&gt; ClientTrafficSecret HandshakeSecret
forall a. SecretTriple a -&gt; ClientTrafficSecret a
</span><a href="Network.TLS.Types.html#triClient"><span class="hs-identifier hs-var">triClient</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple HandshakeSecret
</span><a href="#local-6989586621679195388"><span class="hs-identifier hs-var">hkey</span></a></span><span>
</span><span id="line-867"></span><span>        </span><span id="local-6989586621679195395"><span class="annot"><span class="annottext">serverHandshakeSecret :: ServerTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679195395"><span class="hs-identifier hs-var hs-var">serverHandshakeSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretTriple HandshakeSecret -&gt; ServerTrafficSecret HandshakeSecret
forall a. SecretTriple a -&gt; ServerTrafficSecret a
</span><a href="Network.TLS.Types.html#triServer"><span class="hs-identifier hs-var">triServer</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple HandshakeSecret
</span><a href="#local-6989586621679195388"><span class="hs-identifier hs-var">hkey</span></a></span><span>
</span><span id="line-868"></span><span>        </span><span id="local-6989586621679195397"><span class="annot"><span class="annottext">handSecInfo :: HandshakeSecretInfo
</span><a href="#local-6989586621679195397"><span class="hs-identifier hs-var hs-var">handSecInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Cipher -&gt; TrafficSecrets HandshakeSecret -&gt; HandshakeSecretInfo
</span><a href="Network.TLS.Handshake.Control.html#HandshakeSecretInfo"><span class="hs-identifier hs-var">HandshakeSecretInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195399"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ClientTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679195393"><span class="hs-identifier hs-var">clientHandshakeSecret</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">ServerTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679195395"><span class="hs-identifier hs-var">serverHandshakeSecret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-869"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; ClientState -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#contextSync"><span class="hs-identifier hs-var">contextSync</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientState -&gt; IO ()) -&gt; ClientState -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandshakeSecretInfo -&gt; ClientState
</span><a href="Network.TLS.Handshake.Control.html#RecvServerHello"><span class="hs-identifier hs-var">RecvServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeSecretInfo
</span><a href="#local-6989586621679195397"><span class="hs-identifier hs-var">handSecInfo</span></a></span><span>
</span><span id="line-870"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679195401"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195401"><span class="hs-identifier hs-var">rtt0accepted</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679195402"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195402"><span class="hs-identifier hs-var">eexts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RecvHandshake13M IO (Bool, [ExtensionRaw])
-&gt; IO (Bool, [ExtensionRaw])
forall (m :: * -&gt; *) a. MonadIO m =&gt; RecvHandshake13M m a -&gt; m a
</span><a href="Network.TLS.Handshake.Common13.html#runRecvHandshake13"><span class="hs-identifier hs-var">runRecvHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">(RecvHandshake13M IO (Bool, [ExtensionRaw])
 -&gt; IO (Bool, [ExtensionRaw]))
-&gt; RecvHandshake13M IO (Bool, [ExtensionRaw])
-&gt; IO (Bool, [ExtensionRaw])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-871"></span><span>        </span><span id="local-6989586621679195404"><span class="annot"><span class="annottext">(Bool, [ExtensionRaw])
</span><a href="#local-6989586621679195404"><span class="hs-identifier hs-var">accext</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; (Handshake13 -&gt; RecvHandshake13M IO (Bool, [ExtensionRaw]))
-&gt; RecvHandshake13M IO (Bool, [ExtensionRaw])
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Context
-&gt; (Handshake13 -&gt; RecvHandshake13M m a) -&gt; RecvHandshake13M m a
</span><a href="Network.TLS.Handshake.Common13.html#recvHandshake13"><span class="hs-identifier hs-var">recvHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13 -&gt; RecvHandshake13M IO (Bool, [ExtensionRaw])
forall {m :: * -&gt; *}.
MonadIO m =&gt;
Handshake13 -&gt; m (Bool, [ExtensionRaw])
</span><a href="#local-6989586621679195406"><span class="hs-identifier hs-var">expectEncryptedExtensions</span></a></span><span>
</span><span id="line-872"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; RecvHandshake13M IO () -&gt; RecvHandshake13M IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195389"><span class="hs-identifier hs-var">resuming</span></a></span><span> </span><span class="annot"><span class="annottext">(RecvHandshake13M IO () -&gt; RecvHandshake13M IO ())
-&gt; RecvHandshake13M IO () -&gt; RecvHandshake13M IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; (Handshake13 -&gt; RecvHandshake13M IO ())
-&gt; RecvHandshake13M IO ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Context
-&gt; (Handshake13 -&gt; RecvHandshake13M m a) -&gt; RecvHandshake13M m a
</span><a href="Network.TLS.Handshake.Common13.html#recvHandshake13"><span class="hs-identifier hs-var">recvHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13 -&gt; RecvHandshake13M IO ()
forall {m :: * -&gt; *}.
MonadIO m =&gt;
Handshake13 -&gt; RecvHandshake13M m ()
</span><a href="#local-6989586621679195407"><span class="hs-identifier hs-var">expectCertRequest</span></a></span><span>
</span><span id="line-873"></span><span>        </span><span class="annot"><span class="annottext">Context
-&gt; (ByteString -&gt; Handshake13 -&gt; RecvHandshake13M IO ())
-&gt; RecvHandshake13M IO ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Context
-&gt; (ByteString -&gt; Handshake13 -&gt; RecvHandshake13M m a)
-&gt; RecvHandshake13M m a
</span><a href="Network.TLS.Handshake.Common13.html#recvHandshake13hash"><span class="hs-identifier hs-var">recvHandshake13hash</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">((ByteString -&gt; Handshake13 -&gt; RecvHandshake13M IO ())
 -&gt; RecvHandshake13M IO ())
-&gt; (ByteString -&gt; Handshake13 -&gt; RecvHandshake13M IO ())
-&gt; RecvHandshake13M IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ServerTrafficSecret HandshakeSecret
-&gt; ByteString -&gt; Handshake13 -&gt; RecvHandshake13M IO ()
forall {m :: * -&gt; *} {a}.
MonadIO m =&gt;
ServerTrafficSecret a -&gt; ByteString -&gt; Handshake13 -&gt; m ()
</span><a href="#local-6989586621679195409"><span class="hs-identifier hs-var">expectFinished</span></a></span><span> </span><span class="annot"><span class="annottext">ServerTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679195395"><span class="hs-identifier hs-var">serverHandshakeSecret</span></a></span><span>
</span><span id="line-874"></span><span>        </span><span class="annot"><span class="annottext">(Bool, [ExtensionRaw])
-&gt; RecvHandshake13M IO (Bool, [ExtensionRaw])
forall a. a -&gt; RecvHandshake13M IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool, [ExtensionRaw])
</span><a href="#local-6989586621679195404"><span class="hs-identifier hs-var">accext</span></a></span><span>
</span><span id="line-875"></span><span>    </span><span id="local-6989586621679195410"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195410"><span class="hs-identifier hs-var">hChSf</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO ByteString
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ByteString
</span><a href="Network.TLS.Handshake.State13.html#transcriptHash"><span class="hs-identifier hs-var">transcriptHash</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-876"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.TLS.Context.Internal.html#ctxQUICMode"><span class="hs-identifier hs-var">ctxQUICMode</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-877"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; (forall {b}. Monoid b =&gt; PacketFlightM b ()) -&gt; IO ()
forall a.
Context -&gt; (forall b. Monoid b =&gt; PacketFlightM b a) -&gt; IO a
</span><a href="Network.TLS.IO.html#runPacketFlight"><span class="hs-identifier hs-var">runPacketFlight</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {b}. Monoid b =&gt; PacketFlightM b ()) -&gt; IO ())
-&gt; (forall {b}. Monoid b =&gt; PacketFlightM b ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; PacketFlightM b ()
forall b. Monoid b =&gt; Context -&gt; PacketFlightM b ()
</span><a href="Network.TLS.Handshake.Common13.html#sendChangeCipherSpec13"><span class="hs-identifier hs-var">sendChangeCipherSpec13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-878"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195401"><span class="hs-identifier hs-var">rtt0accepted</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; Bool
</span><a href="Network.TLS.Context.Internal.html#ctxQUICMode"><span class="hs-identifier hs-var">ctxQUICMode</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-879"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; Packet13 -&gt; IO ()
</span><a href="Network.TLS.IO.html#sendPacket13"><span class="hs-identifier hs-var">sendPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake13
</span><a href="Network.TLS.Struct13.html#EndOfEarlyData13"><span class="hs-identifier hs-var">EndOfEarlyData13</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-880"></span><span>    </span><span class="annot"><span class="annottext">Context
-&gt; Hash -&gt; Cipher -&gt; ClientTrafficSecret HandshakeSecret -&gt; IO ()
forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setTxState"><span class="hs-identifier hs-var">setTxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679195416"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195399"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ClientTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679195393"><span class="hs-identifier hs-var">clientHandshakeSecret</span></a></span><span>
</span><span id="line-881"></span><span>    </span><span class="annot"><span class="annottext">ClientParams
-&gt; Context -&gt; Hash -&gt; ClientTrafficSecret HandshakeSecret -&gt; IO ()
forall a.
ClientParams -&gt; Context -&gt; Hash -&gt; ClientTrafficSecret a -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#sendClientFlight13"><span class="hs-identifier hs-var">sendClientFlight13</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195384"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679195416"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">ClientTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679195393"><span class="hs-identifier hs-var">clientHandshakeSecret</span></a></span><span>
</span><span id="line-882"></span><span>    </span><span id="local-6989586621679195418"><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
</span><a href="#local-6989586621679195418"><span class="hs-identifier hs-var">appKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BaseSecret HandshakeSecret
-&gt; ByteString -&gt; IO (SecretTriple ApplicationSecret)
</span><a href="#local-6989586621679195419"><span class="hs-identifier hs-var">switchToApplicationSecret</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret HandshakeSecret
</span><a href="#local-6989586621679195391"><span class="hs-identifier hs-var">handshakeSecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195410"><span class="hs-identifier hs-var">hChSf</span></a></span><span>
</span><span id="line-883"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195420"><span class="annot"><span class="annottext">applicationSecret :: BaseSecret ApplicationSecret
</span><a href="#local-6989586621679195420"><span class="hs-identifier hs-var hs-var">applicationSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret -&gt; BaseSecret ApplicationSecret
forall a. SecretTriple a -&gt; BaseSecret a
</span><a href="Network.TLS.Types.html#triBase"><span class="hs-identifier hs-var">triBase</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
</span><a href="#local-6989586621679195418"><span class="hs-identifier hs-var">appKey</span></a></span><span>
</span><span id="line-884"></span><span>    </span><span class="annot"><span class="annottext">BaseSecret ApplicationSecret -&gt; IO ()
</span><a href="#local-6989586621679195421"><span class="hs-identifier hs-var">setResumptionSecret</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret ApplicationSecret
</span><a href="#local-6989586621679195420"><span class="hs-identifier hs-var">applicationSecret</span></a></span><span>
</span><span id="line-885"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195422"><span class="annot"><span class="annottext">appSecInfo :: ApplicationSecretInfo
</span><a href="#local-6989586621679195422"><span class="hs-identifier hs-var hs-var">appSecInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TrafficSecrets ApplicationSecret -&gt; ApplicationSecretInfo
</span><a href="Network.TLS.Handshake.Control.html#ApplicationSecretInfo"><span class="hs-identifier hs-var">ApplicationSecretInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
-&gt; ClientTrafficSecret ApplicationSecret
forall a. SecretTriple a -&gt; ClientTrafficSecret a
</span><a href="Network.TLS.Types.html#triClient"><span class="hs-identifier hs-var">triClient</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
</span><a href="#local-6989586621679195418"><span class="hs-identifier hs-var">appKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
-&gt; ServerTrafficSecret ApplicationSecret
forall a. SecretTriple a -&gt; ServerTrafficSecret a
</span><a href="Network.TLS.Types.html#triServer"><span class="hs-identifier hs-var">triServer</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
</span><a href="#local-6989586621679195418"><span class="hs-identifier hs-var">appKey</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-886"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; ClientState -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#contextSync"><span class="hs-identifier hs-var">contextSync</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(ClientState -&gt; IO ()) -&gt; ClientState -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw] -&gt; ApplicationSecretInfo -&gt; ClientState
</span><a href="Network.TLS.Handshake.Control.html#SendClientFinished"><span class="hs-identifier hs-var">SendClientFinished</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195402"><span class="hs-identifier hs-var">eexts</span></a></span><span> </span><span class="annot"><span class="annottext">ApplicationSecretInfo
</span><a href="#local-6989586621679195422"><span class="hs-identifier hs-var">appSecInfo</span></a></span><span>
</span><span id="line-887"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; IO ()
</span><a href="Network.TLS.Handshake.Common13.html#handshakeTerminate13"><span class="hs-identifier hs-var">handshakeTerminate13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-888"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-889"></span><span>    </span><span id="local-6989586621679195399"><span class="annot"><span class="annottext">usedCipher :: Cipher
</span><a href="#local-6989586621679195399"><span class="hs-identifier hs-var hs-var">usedCipher</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CipherChoice -&gt; Cipher
</span><a href="Network.TLS.Handshake.Common13.html#cCipher"><span class="hs-identifier hs-var">cCipher</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679195387"><span class="hs-identifier hs-var">choice</span></a></span><span>
</span><span id="line-890"></span><span>    </span><span id="local-6989586621679195416"><span class="annot"><span class="annottext">usedHash :: Hash
</span><a href="#local-6989586621679195416"><span class="hs-identifier hs-var hs-var">usedHash</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CipherChoice -&gt; Hash
</span><a href="Network.TLS.Handshake.Common13.html#cHash"><span class="hs-identifier hs-var">cHash</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679195387"><span class="hs-identifier hs-var">choice</span></a></span><span>
</span><span id="line-891"></span><span>
</span><span id="line-892"></span><span>    </span><span id="local-6989586621679195426"><span class="annot"><span class="annottext">hashSize :: Int
</span><a href="#local-6989586621679195426"><span class="hs-identifier hs-var hs-var">hashSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Int
</span><a href="Network.TLS.Crypto.html#hashDigestSize"><span class="hs-identifier hs-var">hashDigestSize</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679195416"><span class="hs-identifier hs-var">usedHash</span></a></span><span>
</span><span id="line-893"></span><span>
</span><span id="line-894"></span><span>    </span><span id="local-6989586621679195390"><span class="annot"><span class="annottext">switchToHandshakeSecret :: IO (Cipher, SecretTriple HandshakeSecret, Bool)
</span><a href="#local-6989586621679195390"><span class="hs-identifier hs-var hs-var">switchToHandshakeSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-895"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ()
</span><a href="Network.TLS.Handshake.Common.html#ensureRecvComplete"><span class="hs-identifier hs-var">ensureRecvComplete</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-896"></span><span>        </span><span id="local-6989586621679195438"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195438"><span class="hs-identifier hs-var">ecdhe</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ByteString
</span><a href="#local-6989586621679195439"><span class="hs-identifier hs-var">calcSharedKey</span></a></span><span>
</span><span id="line-897"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679195440"><span class="annot"><span class="annottext">BaseSecret EarlySecret
</span><a href="#local-6989586621679195440"><span class="hs-identifier hs-var">earlySecret</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679195441"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195441"><span class="hs-identifier hs-var">resuming</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (BaseSecret EarlySecret, Bool)
</span><a href="#local-6989586621679195442"><span class="hs-identifier hs-var">makeEarlySecret</span></a></span><span>
</span><span id="line-898"></span><span>        </span><span id="local-6989586621679195443"><span class="annot"><span class="annottext">SecretTriple HandshakeSecret
</span><a href="#local-6989586621679195443"><span class="hs-identifier hs-var">handKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; CipherChoice
-&gt; BaseSecret EarlySecret
-&gt; ByteString
-&gt; IO (SecretTriple HandshakeSecret)
</span><a href="Network.TLS.Handshake.Common13.html#calculateHandshakeSecret"><span class="hs-identifier hs-var">calculateHandshakeSecret</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679195387"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret EarlySecret
</span><a href="#local-6989586621679195440"><span class="hs-identifier hs-var">earlySecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195438"><span class="hs-identifier hs-var">ecdhe</span></a></span><span>
</span><span id="line-899"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195445"><span class="annot"><span class="annottext">serverHandshakeSecret :: ServerTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679195445"><span class="hs-identifier hs-var hs-var">serverHandshakeSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretTriple HandshakeSecret -&gt; ServerTrafficSecret HandshakeSecret
forall a. SecretTriple a -&gt; ServerTrafficSecret a
</span><a href="Network.TLS.Types.html#triServer"><span class="hs-identifier hs-var">triServer</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple HandshakeSecret
</span><a href="#local-6989586621679195443"><span class="hs-identifier hs-var">handKey</span></a></span><span>
</span><span id="line-900"></span><span>        </span><span class="annot"><span class="annottext">Context
-&gt; Hash -&gt; Cipher -&gt; ServerTrafficSecret HandshakeSecret -&gt; IO ()
forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setRxState"><span class="hs-identifier hs-var">setRxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679195416"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195399"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ServerTrafficSecret HandshakeSecret
</span><a href="#local-6989586621679195445"><span class="hs-identifier hs-var">serverHandshakeSecret</span></a></span><span>
</span><span id="line-901"></span><span>        </span><span class="annot"><span class="annottext">(Cipher, SecretTriple HandshakeSecret, Bool)
-&gt; IO (Cipher, SecretTriple HandshakeSecret, Bool)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195399"><span class="hs-identifier hs-var">usedCipher</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecretTriple HandshakeSecret
</span><a href="#local-6989586621679195443"><span class="hs-identifier hs-var">handKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195441"><span class="hs-identifier hs-var">resuming</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-902"></span><span>
</span><span id="line-903"></span><span>    </span><span id="local-6989586621679195419"><span class="annot"><span class="annottext">switchToApplicationSecret :: BaseSecret HandshakeSecret
-&gt; ByteString -&gt; IO (SecretTriple ApplicationSecret)
</span><a href="#local-6989586621679195419"><span class="hs-identifier hs-var hs-var">switchToApplicationSecret</span></a></span></span><span> </span><span id="local-6989586621679195457"><span class="annot"><span class="annottext">BaseSecret HandshakeSecret
</span><a href="#local-6989586621679195457"><span class="hs-identifier hs-var">handshakeSecret</span></a></span></span><span> </span><span id="local-6989586621679195458"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195458"><span class="hs-identifier hs-var">hChSf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-904"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ()
</span><a href="Network.TLS.Handshake.Common.html#ensureRecvComplete"><span class="hs-identifier hs-var">ensureRecvComplete</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-905"></span><span>        </span><span id="local-6989586621679195459"><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
</span><a href="#local-6989586621679195459"><span class="hs-identifier hs-var">appKey</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; CipherChoice
-&gt; BaseSecret HandshakeSecret
-&gt; ByteString
-&gt; IO (SecretTriple ApplicationSecret)
</span><a href="Network.TLS.Handshake.Common13.html#calculateApplicationSecret"><span class="hs-identifier hs-var">calculateApplicationSecret</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679195387"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret HandshakeSecret
</span><a href="#local-6989586621679195457"><span class="hs-identifier hs-var">handshakeSecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195458"><span class="hs-identifier hs-var">hChSf</span></a></span><span>
</span><span id="line-906"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195461"><span class="annot"><span class="annottext">serverApplicationSecret0 :: ServerTrafficSecret ApplicationSecret
</span><a href="#local-6989586621679195461"><span class="hs-identifier hs-var hs-var">serverApplicationSecret0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
-&gt; ServerTrafficSecret ApplicationSecret
forall a. SecretTriple a -&gt; ServerTrafficSecret a
</span><a href="Network.TLS.Types.html#triServer"><span class="hs-identifier hs-var">triServer</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
</span><a href="#local-6989586621679195459"><span class="hs-identifier hs-var">appKey</span></a></span><span>
</span><span id="line-907"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195462"><span class="annot"><span class="annottext">clientApplicationSecret0 :: ClientTrafficSecret ApplicationSecret
</span><a href="#local-6989586621679195462"><span class="hs-identifier hs-var hs-var">clientApplicationSecret0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
-&gt; ClientTrafficSecret ApplicationSecret
forall a. SecretTriple a -&gt; ClientTrafficSecret a
</span><a href="Network.TLS.Types.html#triClient"><span class="hs-identifier hs-var">triClient</span></a></span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
</span><a href="#local-6989586621679195459"><span class="hs-identifier hs-var">appKey</span></a></span><span>
</span><span id="line-908"></span><span>        </span><span class="annot"><span class="annottext">Context
-&gt; Hash -&gt; Cipher -&gt; ClientTrafficSecret ApplicationSecret -&gt; IO ()
forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setTxState"><span class="hs-identifier hs-var">setTxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679195416"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195399"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ClientTrafficSecret ApplicationSecret
</span><a href="#local-6989586621679195462"><span class="hs-identifier hs-var">clientApplicationSecret0</span></a></span><span>
</span><span id="line-909"></span><span>        </span><span class="annot"><span class="annottext">Context
-&gt; Hash -&gt; Cipher -&gt; ServerTrafficSecret ApplicationSecret -&gt; IO ()
forall ty.
TrafficSecret ty =&gt;
Context -&gt; Hash -&gt; Cipher -&gt; ty -&gt; IO ()
</span><a href="Network.TLS.Handshake.State13.html#setRxState"><span class="hs-identifier hs-var">setRxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679195416"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">Cipher
</span><a href="#local-6989586621679195399"><span class="hs-identifier hs-var">usedCipher</span></a></span><span> </span><span class="annot"><span class="annottext">ServerTrafficSecret ApplicationSecret
</span><a href="#local-6989586621679195461"><span class="hs-identifier hs-var">serverApplicationSecret0</span></a></span><span>
</span><span id="line-910"></span><span>        </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
-&gt; IO (SecretTriple ApplicationSecret)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SecretTriple ApplicationSecret
</span><a href="#local-6989586621679195459"><span class="hs-identifier hs-var">appKey</span></a></span><span>
</span><span id="line-911"></span><span>
</span><span id="line-912"></span><span>    </span><span id="local-6989586621679195439"><span class="annot"><span class="annottext">calcSharedKey :: IO ByteString
</span><a href="#local-6989586621679195439"><span class="hs-identifier hs-var hs-var">calcSharedKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-913"></span><span>        </span><span id="local-6989586621679195481"><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679195481"><span class="hs-identifier hs-var">serverKeyShare</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-914"></span><span>            </span><span id="local-6989586621679195482"><span class="annot"><span class="annottext">Maybe KeyShare
</span><a href="#local-6989586621679195482"><span class="hs-identifier hs-var">mks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt (Maybe KeyShare) -&gt; IO (Maybe KeyShare)
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt (Maybe KeyShare)
</span><a href="Network.TLS.State.html#getTLS13KeyShare"><span class="hs-identifier hs-var">getTLS13KeyShare</span></a></span><span>
</span><span id="line-915"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe KeyShare
</span><a href="#local-6989586621679195482"><span class="hs-identifier hs-var">mks</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-916"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#KeyShareServerHello"><span class="hs-identifier hs-type">KeyShareServerHello</span></a></span><span> </span><span id="local-6989586621679195484"><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679195484"><span class="hs-identifier hs-var">ks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">KeyShareEntry -&gt; IO KeyShareEntry
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679195484"><span class="hs-identifier hs-var">ks</span></a></span><span>
</span><span id="line-917"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">KeyShare
</span><span class="hs-identifier">_</span></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO KeyShareEntry
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO KeyShareEntry) -&gt; TLSError -&gt; IO KeyShareEntry
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;invalid key_share value&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-918"></span><span>              </span><span class="annot"><span class="annottext">Maybe KeyShare
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO KeyShareEntry
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO KeyShareEntry) -&gt; TLSError -&gt; IO KeyShareEntry
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;key exchange not implemented, expected key_share extension&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-919"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195485"><span class="annot"><span class="annottext">grp :: Group
</span><a href="#local-6989586621679195485"><span class="hs-identifier hs-var hs-var">grp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KeyShareEntry -&gt; Group
</span><a href="Network.TLS.Extension.html#keyShareEntryGroup"><span class="hs-identifier hs-var">keyShareEntryGroup</span></a></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679195481"><span class="hs-identifier hs-var">serverKeyShare</span></a></span><span>
</span><span id="line-920"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KeyShareEntry -&gt; Bool
</span><a href="Network.TLS.Handshake.Common13.html#checkKeyShareKeyLength"><span class="hs-identifier hs-var">checkKeyShareKeyLength</span></a></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679195481"><span class="hs-identifier hs-var">serverKeyShare</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-921"></span><span>            </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;broken key_share&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-922"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Group
</span><a href="#local-6989586621679195386"><span class="hs-identifier hs-var">groupSent</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Group -&gt; Maybe Group -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Group -&gt; Maybe Group
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679195485"><span class="hs-identifier hs-var">grp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-923"></span><span>            </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;received incompatible group for (EC)DHE&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-924"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Group -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setNegotiatedGroup"><span class="hs-identifier hs-var">setNegotiatedGroup</span></a></span><span> </span><span class="annot"><span class="annottext">Group
</span><a href="#local-6989586621679195485"><span class="hs-identifier hs-var">grp</span></a></span><span>
</span><span id="line-925"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM GroupPrivate -&gt; IO GroupPrivate
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM GroupPrivate
</span><a href="Network.TLS.Handshake.State.html#getGroupPrivate"><span class="hs-identifier hs-var">getGroupPrivate</span></a></span><span> </span><span class="annot"><span class="annottext">IO GroupPrivate -&gt; (GroupPrivate -&gt; IO ByteString) -&gt; IO ByteString
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry -&gt; GroupPrivate -&gt; IO ByteString
</span><a href="Network.TLS.Handshake.Common13.html#fromServerKeyShare"><span class="hs-identifier hs-var">fromServerKeyShare</span></a></span><span> </span><span class="annot"><span class="annottext">KeyShareEntry
</span><a href="#local-6989586621679195481"><span class="hs-identifier hs-var">serverKeyShare</span></a></span><span>
</span><span id="line-926"></span><span>
</span><span id="line-927"></span><span>    </span><span id="local-6989586621679195442"><span class="annot"><span class="annottext">makeEarlySecret :: IO (BaseSecret EarlySecret, Bool)
</span><a href="#local-6989586621679195442"><span class="hs-identifier hs-var hs-var">makeEarlySecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-928"></span><span>         </span><span id="local-6989586621679195506"><span class="annot"><span class="annottext">Maybe (BaseSecret EarlySecret)
</span><a href="#local-6989586621679195506"><span class="hs-identifier hs-var">mEarlySecretPSK</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; HandshakeM (Maybe (BaseSecret EarlySecret))
-&gt; IO (Maybe (BaseSecret EarlySecret))
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM (Maybe (BaseSecret EarlySecret))
</span><a href="Network.TLS.Handshake.State.html#getTLS13EarlySecret"><span class="hs-identifier hs-var">getTLS13EarlySecret</span></a></span><span>
</span><span id="line-929"></span><span>         </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (BaseSecret EarlySecret)
</span><a href="#local-6989586621679195506"><span class="hs-identifier hs-var">mEarlySecretPSK</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-930"></span><span>           </span><span class="annot"><span class="annottext">Maybe (BaseSecret EarlySecret)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(BaseSecret EarlySecret, Bool) -&gt; IO (BaseSecret EarlySecret, Bool)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CipherChoice -&gt; Maybe ByteString -&gt; BaseSecret EarlySecret
</span><a href="Network.TLS.Handshake.Common13.html#initEarlySecret"><span class="hs-identifier hs-var">initEarlySecret</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679195387"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-931"></span><span>           </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195507"><span class="annot"><span class="annottext">earlySecretPSK :: BaseSecret EarlySecret
</span><a href="#local-6989586621679195507"><span class="hs-identifier hs-var">earlySecretPSK</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Types.html#BaseSecret"><span class="hs-identifier hs-type">BaseSecret</span></a></span><span> </span><span id="local-6989586621679195509"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195509"><span class="hs-identifier hs-var">sec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-932"></span><span>               </span><span id="local-6989586621679195510"><span class="annot"><span class="annottext">Maybe PreSharedKey
</span><a href="#local-6989586621679195510"><span class="hs-identifier hs-var">mSelectedIdentity</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt (Maybe PreSharedKey) -&gt; IO (Maybe PreSharedKey)
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt (Maybe PreSharedKey)
</span><a href="Network.TLS.State.html#getTLS13PreSharedKey"><span class="hs-identifier hs-var">getTLS13PreSharedKey</span></a></span><span>
</span><span id="line-933"></span><span>               </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe PreSharedKey
</span><a href="#local-6989586621679195510"><span class="hs-identifier hs-var">mSelectedIdentity</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-934"></span><span>                 </span><span class="annot"><span class="annottext">Maybe PreSharedKey
</span><span class="hs-identifier hs-var">Nothing</span></span><span>                          </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-935"></span><span>                     </span><span class="annot"><span class="annottext">(BaseSecret EarlySecret, Bool) -&gt; IO (BaseSecret EarlySecret, Bool)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CipherChoice -&gt; Maybe ByteString -&gt; BaseSecret EarlySecret
</span><a href="Network.TLS.Handshake.Common13.html#initEarlySecret"><span class="hs-identifier hs-var">initEarlySecret</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679195387"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-936"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#PreSharedKeyServerHello"><span class="hs-identifier hs-type">PreSharedKeyServerHello</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-937"></span><span>                     </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">B.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195509"><span class="hs-identifier hs-var">sec</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679195426"><span class="hs-identifier hs-var">hashSize</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-938"></span><span>                         </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;selected cipher is incompatible with selected PSK&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-939"></span><span>                     </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13 -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13HandshakeMode"><span class="hs-identifier hs-var">setTLS13HandshakeMode</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13
</span><a href="Network.TLS.Handshake.State.html#PreSharedKey"><span class="hs-identifier hs-var">PreSharedKey</span></a></span><span>
</span><span id="line-940"></span><span>                     </span><span class="annot"><span class="annottext">(BaseSecret EarlySecret, Bool) -&gt; IO (BaseSecret EarlySecret, Bool)
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BaseSecret EarlySecret
</span><a href="#local-6989586621679195507"><span class="hs-identifier hs-var">earlySecretPSK</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-941"></span><span>                 </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">PreSharedKey
</span><span class="hs-identifier">_</span></span><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; IO (BaseSecret EarlySecret, Bool)
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO (BaseSecret EarlySecret, Bool))
-&gt; TLSError -&gt; IO (BaseSecret EarlySecret, Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;selected identity out of range&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#IllegalParameter"><span class="hs-identifier hs-var">IllegalParameter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-942"></span><span>
</span><span id="line-943"></span><span>    </span><span id="local-6989586621679195406"><span class="annot"><span class="annottext">expectEncryptedExtensions :: Handshake13 -&gt; m (Bool, [ExtensionRaw])
</span><a href="#local-6989586621679195406"><span class="hs-identifier hs-var hs-var">expectEncryptedExtensions</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#EncryptedExtensions13"><span class="hs-identifier hs-type">EncryptedExtensions13</span></a></span><span> </span><span id="local-6989586621679195546"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195546"><span class="hs-identifier hs-var">eexts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-944"></span><span>        </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall a. IO a -&gt; m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; MessageType -&gt; [ExtensionRaw] -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#setALPN"><span class="hs-identifier hs-var">setALPN</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTEncryptedExtensions"><span class="hs-identifier hs-var">MsgTEncryptedExtensions</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195546"><span class="hs-identifier hs-var">eexts</span></a></span><span>
</span><span id="line-945"></span><span>        </span><span id="local-6989586621679195548"><span class="annot"><span class="annottext">RTT0Status
</span><a href="#local-6989586621679195548"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM RTT0Status -&gt; m RTT0Status
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM RTT0Status
</span><a href="Network.TLS.Handshake.State.html#getTLS13RTT0Status"><span class="hs-identifier hs-var">getTLS13RTT0Status</span></a></span><span>
</span><span id="line-946"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">RTT0Status
</span><a href="#local-6989586621679195548"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">RTT0Status -&gt; RTT0Status -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">RTT0Status
</span><a href="Network.TLS.Handshake.State.html#RTT0Sent"><span class="hs-identifier hs-var">RTT0Sent</span></a></span><span> </span><span class="hs-keyword">then</span><span>
</span><span id="line-947"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_EarlyData"><span class="hs-identifier hs-var">extensionID_EarlyData</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195546"><span class="hs-identifier hs-var">eexts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-948"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-949"></span><span>                  </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; m ()) -&gt; HandshakeM () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13 -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13HandshakeMode"><span class="hs-identifier hs-var">setTLS13HandshakeMode</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13
</span><a href="Network.TLS.Handshake.State.html#RTT0"><span class="hs-identifier hs-var">RTT0</span></a></span><span>
</span><span id="line-950"></span><span>                  </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; m ()) -&gt; HandshakeM () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RTT0Status -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13RTT0Status"><span class="hs-identifier hs-var">setTLS13RTT0Status</span></a></span><span> </span><span class="annot"><span class="annottext">RTT0Status
</span><a href="Network.TLS.Handshake.State.html#RTT0Accepted"><span class="hs-identifier hs-var">RTT0Accepted</span></a></span><span>
</span><span id="line-951"></span><span>                  </span><span class="annot"><span class="annottext">(Bool, [ExtensionRaw]) -&gt; m (Bool, [ExtensionRaw])
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195546"><span class="hs-identifier hs-var">eexts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-952"></span><span>              </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-953"></span><span>                  </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; m ()) -&gt; HandshakeM () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13 -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13HandshakeMode"><span class="hs-identifier hs-var">setTLS13HandshakeMode</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeMode13
</span><a href="Network.TLS.Handshake.State.html#RTT0"><span class="hs-identifier hs-var">RTT0</span></a></span><span>
</span><span id="line-954"></span><span>                  </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; m ()) -&gt; HandshakeM () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RTT0Status -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13RTT0Status"><span class="hs-identifier hs-var">setTLS13RTT0Status</span></a></span><span> </span><span class="annot"><span class="annottext">RTT0Status
</span><a href="Network.TLS.Handshake.State.html#RTT0Rejected"><span class="hs-identifier hs-var">RTT0Rejected</span></a></span><span>
</span><span id="line-955"></span><span>                  </span><span class="annot"><span class="annottext">(Bool, [ExtensionRaw]) -&gt; m (Bool, [ExtensionRaw])
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195546"><span class="hs-identifier hs-var">eexts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-956"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-957"></span><span>            </span><span class="annot"><span class="annottext">(Bool, [ExtensionRaw]) -&gt; m (Bool, [ExtensionRaw])
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195546"><span class="hs-identifier hs-var">eexts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-958"></span><span>    </span><span class="annot"><a href="#local-6989586621679195406"><span class="hs-identifier hs-var">expectEncryptedExtensions</span></a></span><span> </span><span id="local-6989586621679195554"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195554"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; m (Bool, [ExtensionRaw])
forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handshake13 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195554"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;encrypted extensions&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-959"></span><span>
</span><span id="line-960"></span><span>    </span><span id="local-6989586621679195407"><span class="annot"><span class="annottext">expectCertRequest :: Handshake13 -&gt; RecvHandshake13M m ()
</span><a href="#local-6989586621679195407"><span class="hs-identifier hs-var hs-var">expectCertRequest</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#CertRequest13"><span class="hs-identifier hs-type">CertRequest13</span></a></span><span> </span><span id="local-6989586621679195576"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195576"><span class="hs-identifier hs-var">token</span></a></span></span><span> </span><span id="local-6989586621679195577"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195577"><span class="hs-identifier hs-var">exts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-961"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; ByteString -&gt; [ExtensionRaw] -&gt; RecvHandshake13M m ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; ByteString -&gt; [ExtensionRaw] -&gt; m ()
</span><a href="Network.TLS.Handshake.Client.html#processCertRequest13"><span class="hs-identifier hs-var">processCertRequest13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195576"><span class="hs-identifier hs-var">token</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195577"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-962"></span><span>        </span><span class="annot"><span class="annottext">Context
-&gt; (Handshake13 -&gt; RecvHandshake13M m ()) -&gt; RecvHandshake13M m ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Context
-&gt; (Handshake13 -&gt; RecvHandshake13M m a) -&gt; RecvHandshake13M m a
</span><a href="Network.TLS.Handshake.Common13.html#recvHandshake13"><span class="hs-identifier hs-var">recvHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13 -&gt; RecvHandshake13M m ()
forall {m :: * -&gt; *}.
MonadIO m =&gt;
Handshake13 -&gt; RecvHandshake13M m ()
</span><a href="#local-6989586621679195579"><span class="hs-identifier hs-var">expectCertAndVerify</span></a></span><span>
</span><span id="line-963"></span><span>
</span><span id="line-964"></span><span>    </span><span class="annot"><a href="#local-6989586621679195407"><span class="hs-identifier hs-var">expectCertRequest</span></a></span><span> </span><span id="local-6989586621679195580"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195580"><span class="hs-identifier hs-var">other</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-965"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; RecvHandshake13M m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; RecvHandshake13M m ())
-&gt; HandshakeM () -&gt; RecvHandshake13M m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-966"></span><span>            </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setCertReqToken"><span class="hs-identifier hs-var">setCertReqToken</span></a></span><span>   </span><span class="annot"><span class="annottext">Maybe ByteString
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-967"></span><span>            </span><span class="annot"><span class="annottext">Maybe CertReqCBdata -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setCertReqCBdata"><span class="hs-identifier hs-var">setCertReqCBdata</span></a></span><span>  </span><span class="annot"><span class="annottext">Maybe CertReqCBdata
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-968"></span><span>            </span><span class="hs-comment">-- setCertReqSigAlgsCert Nothing</span><span>
</span><span id="line-969"></span><span>        </span><span class="annot"><span class="annottext">Handshake13 -&gt; RecvHandshake13M m ()
forall {m :: * -&gt; *}.
MonadIO m =&gt;
Handshake13 -&gt; RecvHandshake13M m ()
</span><a href="#local-6989586621679195579"><span class="hs-identifier hs-var">expectCertAndVerify</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195580"><span class="hs-identifier hs-var">other</span></a></span><span>
</span><span id="line-970"></span><span>
</span><span id="line-971"></span><span>    </span><span id="local-6989586621679195579"><span class="annot"><span class="annottext">expectCertAndVerify :: Handshake13 -&gt; RecvHandshake13M m ()
</span><a href="#local-6989586621679195579"><span class="hs-identifier hs-var hs-var">expectCertAndVerify</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#Certificate13"><span class="hs-identifier hs-type">Certificate13</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679195608"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195608"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="annot"><span class="annottext">[[ExtensionRaw]]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-972"></span><span>        </span><span class="annot"><span class="annottext">RecvState IO
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (RecvState IO) -&gt; RecvHandshake13M m (RecvState IO)
forall a. IO a -&gt; RecvHandshake13M m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (RecvState IO) -&gt; RecvHandshake13M m (RecvState IO))
-&gt; IO (RecvState IO) -&gt; RecvHandshake13M m (RecvState IO)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Context -&gt; Handshake -&gt; IO (RecvState IO)
</span><a href="Network.TLS.Handshake.Client.html#processCertificate"><span class="hs-identifier hs-var">processCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195384"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CertificateChain -&gt; Handshake
</span><a href="Network.TLS.Struct.html#Certificates"><span class="hs-identifier hs-var">Certificates</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195608"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-973"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195609"><span class="annot"><span class="annottext">pubkey :: PubKey
</span><a href="#local-6989586621679195609"><span class="hs-identifier hs-var hs-var">pubkey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Certificate -&gt; PubKey
</span><span class="hs-identifier hs-var">certPubKey</span></span><span> </span><span class="annot"><span class="annottext">(Certificate -&gt; PubKey) -&gt; Certificate -&gt; PubKey
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SignedExact Certificate -&gt; Certificate
</span><span class="hs-identifier hs-var">getCertificate</span></span><span> </span><span class="annot"><span class="annottext">(SignedExact Certificate -&gt; Certificate)
-&gt; SignedExact Certificate -&gt; Certificate
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; SignedExact Certificate
</span><a href="Network.TLS.X509.html#getCertificateChainLeaf"><span class="hs-identifier hs-var">getCertificateChainLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195608"><span class="hs-identifier hs-var">cc</span></a></span><span>
</span><span id="line-974"></span><span>        </span><span id="local-6989586621679195613"><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195613"><span class="hs-identifier hs-var">ver</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Version -&gt; RecvHandshake13M m Version
forall a. IO a -&gt; RecvHandshake13M m a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO Version -&gt; RecvHandshake13M m Version)
-&gt; IO Version -&gt; RecvHandshake13M m Version
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt Version -&gt; IO Version
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">TLSSt Version
</span><a href="Network.TLS.State.html#getVersion"><span class="hs-identifier hs-var">getVersion</span></a></span><span>
</span><span id="line-975"></span><span>        </span><span class="annot"><span class="annottext">Version -&gt; PubKey -&gt; RecvHandshake13M m ()
forall (m :: * -&gt; *). MonadIO m =&gt; Version -&gt; PubKey -&gt; m ()
</span><a href="Network.TLS.Handshake.Key.html#checkDigitalSignatureKey"><span class="hs-identifier hs-var">checkDigitalSignatureKey</span></a></span><span> </span><span class="annot"><span class="annottext">Version
</span><a href="#local-6989586621679195613"><span class="hs-identifier hs-var">ver</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195609"><span class="hs-identifier hs-var">pubkey</span></a></span><span>
</span><span id="line-976"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; RecvHandshake13M m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; RecvHandshake13M m ())
-&gt; HandshakeM () -&gt; RecvHandshake13M m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setPublicKey"><span class="hs-identifier hs-var">setPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195609"><span class="hs-identifier hs-var">pubkey</span></a></span><span>
</span><span id="line-977"></span><span>        </span><span class="annot"><span class="annottext">Context
-&gt; (ByteString -&gt; Handshake13 -&gt; RecvHandshake13M m ())
-&gt; RecvHandshake13M m ()
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Context
-&gt; (ByteString -&gt; Handshake13 -&gt; RecvHandshake13M m a)
-&gt; RecvHandshake13M m a
</span><a href="Network.TLS.Handshake.Common13.html#recvHandshake13hash"><span class="hs-identifier hs-var">recvHandshake13hash</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">((ByteString -&gt; Handshake13 -&gt; RecvHandshake13M m ())
 -&gt; RecvHandshake13M m ())
-&gt; (ByteString -&gt; Handshake13 -&gt; RecvHandshake13M m ())
-&gt; RecvHandshake13M m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; ByteString -&gt; Handshake13 -&gt; RecvHandshake13M m ()
forall {m :: * -&gt; *}.
MonadIO m =&gt;
PubKey -&gt; ByteString -&gt; Handshake13 -&gt; m ()
</span><a href="#local-6989586621679195616"><span class="hs-identifier hs-var">expectCertVerify</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195609"><span class="hs-identifier hs-var">pubkey</span></a></span><span>
</span><span id="line-978"></span><span>    </span><span class="annot"><a href="#local-6989586621679195579"><span class="hs-identifier hs-var">expectCertAndVerify</span></a></span><span> </span><span id="local-6989586621679195617"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195617"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; RecvHandshake13M m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handshake13 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195617"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server certificate&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-979"></span><span>
</span><span id="line-980"></span><span>    </span><span id="local-6989586621679195616"><span class="annot"><span class="annottext">expectCertVerify :: PubKey -&gt; ByteString -&gt; Handshake13 -&gt; m ()
</span><a href="#local-6989586621679195616"><span class="hs-identifier hs-var hs-var">expectCertVerify</span></a></span></span><span> </span><span id="local-6989586621679195636"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195636"><span class="hs-identifier hs-var">pubkey</span></a></span></span><span> </span><span id="local-6989586621679195637"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195637"><span class="hs-identifier hs-var">hChSc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#CertVerify13"><span class="hs-identifier hs-type">CertVerify13</span></a></span><span> </span><span id="local-6989586621679195639"><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679195639"><span class="hs-identifier hs-var">sigAlg</span></a></span></span><span> </span><span id="local-6989586621679195640"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195640"><span class="hs-identifier hs-var">sig</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-981"></span><span>        </span><span id="local-6989586621679195641"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195641"><span class="hs-identifier hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; PubKey
-&gt; HashAndSignatureAlgorithm
-&gt; ByteString
-&gt; ByteString
-&gt; m Bool
forall (m :: * -&gt; *).
MonadIO m =&gt;
Context
-&gt; PubKey
-&gt; HashAndSignatureAlgorithm
-&gt; ByteString
-&gt; ByteString
-&gt; m Bool
</span><a href="Network.TLS.Handshake.Common13.html#checkCertVerify"><span class="hs-identifier hs-var">checkCertVerify</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195636"><span class="hs-identifier hs-var">pubkey</span></a></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679195639"><span class="hs-identifier hs-var">sigAlg</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195640"><span class="hs-identifier hs-var">sig</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195637"><span class="hs-identifier hs-var">hChSc</span></a></span><span>
</span><span id="line-982"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679195641"><span class="hs-identifier hs-var">ok</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; m a
</span><a href="Network.TLS.Handshake.Signature.html#decryptError"><span class="hs-identifier hs-var">decryptError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cannot verify CertificateVerify&quot;</span></span><span>
</span><span id="line-983"></span><span>    </span><span class="annot"><a href="#local-6989586621679195616"><span class="hs-identifier hs-var">expectCertVerify</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679195643"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195643"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handshake13 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195643"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;certificate verify&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-984"></span><span>
</span><span id="line-985"></span><span>    </span><span id="local-6989586621679195409"><span class="annot"><span class="annottext">expectFinished :: ServerTrafficSecret a -&gt; ByteString -&gt; Handshake13 -&gt; m ()
</span><a href="#local-6989586621679195409"><span class="hs-identifier hs-var hs-var">expectFinished</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Types.html#ServerTrafficSecret"><span class="hs-identifier hs-type">ServerTrafficSecret</span></a></span><span> </span><span id="local-6989586621679195657"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195657"><span class="hs-identifier hs-var">baseKey</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679195658"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195658"><span class="hs-identifier hs-var">hashValue</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#Finished13"><span class="hs-identifier hs-type">Finished13</span></a></span><span> </span><span id="local-6989586621679195660"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195660"><span class="hs-identifier hs-var">verifyData</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-986"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; Hash -&gt; ByteString -&gt; ByteString -&gt; ByteString -&gt; m ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; Hash -&gt; ByteString -&gt; ByteString -&gt; ByteString -&gt; m ()
</span><a href="Network.TLS.Handshake.Common13.html#checkFinished"><span class="hs-identifier hs-var">checkFinished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679195416"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195657"><span class="hs-identifier hs-var">baseKey</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195658"><span class="hs-identifier hs-var">hashValue</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195660"><span class="hs-identifier hs-var">verifyData</span></a></span><span>
</span><span id="line-987"></span><span>    </span><span class="annot"><a href="#local-6989586621679195409"><span class="hs-identifier hs-var">expectFinished</span></a></span><span> </span><span class="annot"><span class="annottext">ServerTrafficSecret a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679195662"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195662"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe String -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; String -&gt; Maybe String -&gt; m a
</span><a href="Network.TLS.Handshake.Common.html#unexpected"><span class="hs-identifier hs-var">unexpected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Handshake13 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195662"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Maybe String
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;server finished&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-988"></span><span>
</span><span id="line-989"></span><span>    </span><span id="local-6989586621679195421"><span class="annot"><span class="annottext">setResumptionSecret :: BaseSecret ApplicationSecret -&gt; IO ()
</span><a href="#local-6989586621679195421"><span class="hs-identifier hs-var hs-var">setResumptionSecret</span></a></span></span><span> </span><span id="local-6989586621679195665"><span class="annot"><span class="annottext">BaseSecret ApplicationSecret
</span><a href="#local-6989586621679195665"><span class="hs-identifier hs-var">applicationSecret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-990"></span><span>        </span><span id="local-6989586621679195666"><span class="annot"><span class="annottext">BaseSecret ResumptionSecret
</span><a href="#local-6989586621679195666"><span class="hs-identifier hs-var">resumptionSecret</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; CipherChoice
-&gt; BaseSecret ApplicationSecret
-&gt; IO (BaseSecret ResumptionSecret)
</span><a href="Network.TLS.Handshake.Common13.html#calculateResumptionSecret"><span class="hs-identifier hs-var">calculateResumptionSecret</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">CipherChoice
</span><a href="#local-6989586621679195387"><span class="hs-identifier hs-var">choice</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret ApplicationSecret
</span><a href="#local-6989586621679195665"><span class="hs-identifier hs-var">applicationSecret</span></a></span><span>
</span><span id="line-991"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195385"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; IO ()) -&gt; HandshakeM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BaseSecret ResumptionSecret -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setTLS13ResumptionSecret"><span class="hs-identifier hs-var">setTLS13ResumptionSecret</span></a></span><span> </span><span class="annot"><span class="annottext">BaseSecret ResumptionSecret
</span><a href="#local-6989586621679195666"><span class="hs-identifier hs-var">resumptionSecret</span></a></span><span>
</span><span id="line-992"></span><span>
</span><span id="line-993"></span><span id="local-6989586621679194018"><span class="annot"><a href="Network.TLS.Handshake.Client.html#processCertRequest13"><span class="hs-identifier hs-type">processCertRequest13</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679194018"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#CertReqContext"><span class="hs-identifier hs-type">CertReqContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679194018"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-994"></span><span id="processCertRequest13"><span class="annot"><span class="annottext">processCertRequest13 :: forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; ByteString -&gt; [ExtensionRaw] -&gt; m ()
</span><a href="Network.TLS.Handshake.Client.html#processCertRequest13"><span class="hs-identifier hs-var hs-var">processCertRequest13</span></a></span></span><span> </span><span id="local-6989586621679195683"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195683"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679195684"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195684"><span class="hs-identifier hs-var">token</span></a></span></span><span> </span><span id="local-6989586621679195685"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195685"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-995"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195686"><span class="annot"><span class="annottext">hsextID :: ExtensionID
</span><a href="#local-6989586621679195686"><span class="hs-identifier hs-var hs-var">hsextID</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_SignatureAlgorithms"><span class="hs-identifier hs-var">extensionID_SignatureAlgorithms</span></a></span><span>
</span><span id="line-996"></span><span>        </span><span class="hs-comment">-- caextID = extensionID_SignatureAlgorithmsCert</span><span>
</span><span id="line-997"></span><span>    </span><span id="local-6989586621679195688"><span class="annot"><span class="annottext">[DistinguishedName]
</span><a href="#local-6989586621679195688"><span class="hs-identifier hs-var">dNames</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m [DistinguishedName]
</span><a href="#local-6989586621679195689"><span class="hs-identifier hs-var">canames</span></a></span><span>
</span><span id="line-998"></span><span>    </span><span class="hs-comment">-- The @signature_algorithms@ extension is mandatory.</span><span>
</span><span id="line-999"></span><span>    </span><span id="local-6989586621679195690"><span class="annot"><span class="annottext">Maybe [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195690"><span class="hs-identifier hs-var">hsAlgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExtensionID
-&gt; (SignatureAlgorithms -&gt; Maybe [HashAndSignatureAlgorithm])
-&gt; m (Maybe [HashAndSignatureAlgorithm])
forall {m :: * -&gt; *} {t} {a}.
(Extension t, MonadIO m) =&gt;
ExtensionID -&gt; (t -&gt; Maybe a) -&gt; m (Maybe a)
</span><a href="#local-6989586621679195691"><span class="hs-identifier hs-var">extalgs</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195686"><span class="hs-identifier hs-var">hsextID</span></a></span><span> </span><span class="annot"><span class="annottext">SignatureAlgorithms -&gt; Maybe [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195692"><span class="hs-identifier hs-var">unsighash</span></a></span><span>
</span><span id="line-1000"></span><span>    </span><span id="local-6989586621679195693"><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679195693"><span class="hs-identifier hs-var">cTypes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195690"><span class="hs-identifier hs-var">hsAlgs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1001"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195694"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195694"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1002"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679195695"><span class="annot"><span class="annottext">validAs :: [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195695"><span class="hs-identifier hs-var hs-var">validAs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HashAndSignatureAlgorithm -&gt; Bool)
-&gt; [HashAndSignatureAlgorithm] -&gt; [HashAndSignatureAlgorithm]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm -&gt; Bool
</span><a href="Network.TLS.Handshake.Common13.html#isHashSignatureValid13"><span class="hs-identifier hs-var">isHashSignatureValid13</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195694"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-1003"></span><span>             </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[CertificateType] -&gt; m [CertificateType]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([CertificateType] -&gt; m [CertificateType])
-&gt; [CertificateType] -&gt; m [CertificateType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; [HashAndSignatureAlgorithm] -&gt; [CertificateType]
</span><a href="Network.TLS.Handshake.Client.html#sigAlgsToCertTypes"><span class="hs-identifier hs-var">sigAlgsToCertTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195683"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195695"><span class="hs-identifier hs-var">validAs</span></a></span><span>
</span><span id="line-1004"></span><span>        </span><span class="annot"><span class="annottext">Maybe [HashAndSignatureAlgorithm]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; m [CertificateType]
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; m [CertificateType])
-&gt; TLSError -&gt; m [CertificateType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span>
</span><span id="line-1005"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;invalid certificate request&quot;</span></span><span>
</span><span id="line-1006"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1007"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1008"></span><span>    </span><span class="hs-comment">-- Unused:</span><span>
</span><span id="line-1009"></span><span>    </span><span class="hs-comment">-- caAlgs &lt;- extalgs caextID uncertsig</span><span>
</span><span id="line-1010"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; HandshakeM () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195683"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(HandshakeM () -&gt; m ()) -&gt; HandshakeM () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1011"></span><span>        </span><span class="annot"><span class="annottext">Maybe ByteString -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setCertReqToken"><span class="hs-identifier hs-var">setCertReqToken</span></a></span><span>  </span><span class="annot"><span class="annottext">(Maybe ByteString -&gt; HandshakeM ())
-&gt; Maybe ByteString -&gt; HandshakeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Maybe ByteString
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195684"><span class="hs-identifier hs-var">token</span></a></span><span>
</span><span id="line-1012"></span><span>        </span><span class="annot"><span class="annottext">Maybe CertReqCBdata -&gt; HandshakeM ()
</span><a href="Network.TLS.Handshake.State.html#setCertReqCBdata"><span class="hs-identifier hs-var">setCertReqCBdata</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe CertReqCBdata -&gt; HandshakeM ())
-&gt; Maybe CertReqCBdata -&gt; HandshakeM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CertReqCBdata -&gt; Maybe CertReqCBdata
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CertificateType]
</span><a href="#local-6989586621679195693"><span class="hs-identifier hs-var">cTypes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195690"><span class="hs-identifier hs-var">hsAlgs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DistinguishedName]
</span><a href="#local-6989586621679195688"><span class="hs-identifier hs-var">dNames</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1013"></span><span>        </span><span class="hs-comment">-- setCertReqSigAlgsCert caAlgs</span><span>
</span><span id="line-1014"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1015"></span><span>    </span><span id="local-6989586621679195689"><span class="annot"><span class="annottext">canames :: m [DistinguishedName]
</span><a href="#local-6989586621679195689"><span class="hs-identifier hs-var hs-var">canames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span>
</span><span id="line-1016"></span><span>                   </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_CertificateAuthorities"><span class="hs-identifier hs-var">extensionID_CertificateAuthorities</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195685"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1017"></span><span>        </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[DistinguishedName] -&gt; m [DistinguishedName]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1018"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span>  </span><span id="local-6989586621679195708"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195708"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MessageType -&gt; ByteString -&gt; Maybe CertificateAuthorities
forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTCertificateRequest"><span class="hs-identifier hs-var">MsgTCertificateRequest</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195708"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1019"></span><span>                         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#CertificateAuthorities"><span class="hs-identifier hs-type">CertificateAuthorities</span></a></span><span> </span><span id="local-6989586621679195711"><span class="annot"><span class="annottext">[DistinguishedName]
</span><a href="#local-6989586621679195711"><span class="hs-identifier hs-var">names</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[DistinguishedName] -&gt; m [DistinguishedName]
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[DistinguishedName]
</span><a href="#local-6989586621679195711"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-1020"></span><span>                         </span><span class="annot"><span class="annottext">Maybe CertificateAuthorities
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; m [DistinguishedName]
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; m [DistinguishedName])
-&gt; TLSError -&gt; m [DistinguishedName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span>
</span><span id="line-1021"></span><span>                                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;invalid certificate request&quot;</span></span><span>
</span><span id="line-1022"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1023"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1024"></span><span>    </span><span id="local-6989586621679195691"><span class="annot"><span class="annottext">extalgs :: ExtensionID -&gt; (t -&gt; Maybe a) -&gt; m (Maybe a)
</span><a href="#local-6989586621679195691"><span class="hs-identifier hs-var hs-var">extalgs</span></a></span></span><span> </span><span id="local-6989586621679195726"><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195726"><span class="hs-identifier hs-var">extID</span></a></span></span><span> </span><span id="local-6989586621679195727"><span class="annot"><span class="annottext">t -&gt; Maybe a
</span><a href="#local-6989586621679195727"><span class="hs-identifier hs-var">decons</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="#local-6989586621679195726"><span class="hs-identifier hs-var">extID</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195685"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1025"></span><span>        </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier hs-var">Nothing</span></span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1026"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span>  </span><span id="local-6989586621679195728"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195728"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MessageType -&gt; ByteString -&gt; Maybe t
forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="Network.TLS.Extension.html#MsgTCertificateRequest"><span class="hs-identifier hs-var">MsgTCertificateRequest</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195728"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1027"></span><span>                         </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195729"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679195729"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-1028"></span><span>                           </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; m (Maybe a)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>    </span><span class="annot"><span class="annottext">(Maybe a -&gt; m (Maybe a)) -&gt; Maybe a -&gt; m (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; Maybe a
</span><a href="#local-6989586621679195727"><span class="hs-identifier hs-var">decons</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679195729"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1029"></span><span>                         </span><span class="annot"><span class="annottext">Maybe t
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TLSError -&gt; m (Maybe a)
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; m (Maybe a)) -&gt; TLSError -&gt; m (Maybe a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span>
</span><span id="line-1030"></span><span>                                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;invalid certificate request&quot;</span></span><span>
</span><span id="line-1031"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1032"></span><span>                                  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#HandshakeFailure"><span class="hs-identifier hs-var">HandshakeFailure</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-1033"></span><span>    </span><span class="annot"><a href="#local-6989586621679195692"><span class="hs-identifier hs-type">unsighash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Extension.html#SignatureAlgorithms"><span class="hs-identifier hs-type">SignatureAlgorithms</span></a></span><span>
</span><span id="line-1034"></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#HashAndSignatureAlgorithm"><span class="hs-identifier hs-type">HashAndSignatureAlgorithm</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1035"></span><span>    </span><span id="local-6989586621679195692"><span class="annot"><span class="annottext">unsighash :: SignatureAlgorithms -&gt; Maybe [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195692"><span class="hs-identifier hs-var hs-var">unsighash</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#SignatureAlgorithms"><span class="hs-identifier hs-type">SignatureAlgorithms</span></a></span><span> </span><span id="local-6989586621679195730"><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195730"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm] -&gt; Maybe [HashAndSignatureAlgorithm]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195730"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1036"></span><span>    </span><span class="hs-comment">{- Unused for now
    uncertsig :: SignatureAlgorithmsCert
              -&gt; Maybe [HashAndSignatureAlgorithm]
    uncertsig (SignatureAlgorithmsCert a) = Just a
    -}</span><span>
</span><span id="line-1041"></span><span>
</span><span id="line-1042"></span><span id="local-6989586621679194012"><span class="annot"><a href="Network.TLS.Handshake.Client.html#sendClientFlight13"><span class="hs-identifier hs-type">sendClientFlight13</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ClientParams"><span class="hs-identifier hs-type">ClientParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Crypto.html#Hash"><span class="hs-identifier hs-type">Hash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Types.html#ClientTrafficSecret"><span class="hs-identifier hs-type">ClientTrafficSecret</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679194012"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-1043"></span><span id="sendClientFlight13"><span class="annot"><span class="annottext">sendClientFlight13 :: forall a.
ClientParams -&gt; Context -&gt; Hash -&gt; ClientTrafficSecret a -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#sendClientFlight13"><span class="hs-identifier hs-var hs-var">sendClientFlight13</span></a></span></span><span> </span><span id="local-6989586621679195732"><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195732"><span class="hs-identifier hs-var">cparams</span></a></span></span><span> </span><span id="local-6989586621679195733"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679195734"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679195734"><span class="hs-identifier hs-var">usedHash</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Types.html#ClientTrafficSecret"><span class="hs-identifier hs-type">ClientTrafficSecret</span></a></span><span> </span><span id="local-6989586621679195736"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195736"><span class="hs-identifier hs-var">baseKey</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1044"></span><span>    </span><span id="local-6989586621679195737"><span class="annot"><span class="annottext">Maybe CertificateChain
</span><a href="#local-6989586621679195737"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ClientParams -&gt; Context -&gt; IO (Maybe CertificateChain)
</span><a href="Network.TLS.Handshake.Client.html#clientChain"><span class="hs-identifier hs-var">clientChain</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195732"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-1045"></span><span>    </span><span class="annot"><span class="annottext">Context -&gt; (forall {b}. Monoid b =&gt; PacketFlightM b ()) -&gt; IO ()
forall a.
Context -&gt; (forall b. Monoid b =&gt; PacketFlightM b a) -&gt; IO a
</span><a href="Network.TLS.IO.html#runPacketFlight"><span class="hs-identifier hs-var">runPacketFlight</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">((forall {b}. Monoid b =&gt; PacketFlightM b ()) -&gt; IO ())
-&gt; (forall {b}. Monoid b =&gt; PacketFlightM b ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1046"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe CertificateChain
</span><a href="#local-6989586621679195737"><span class="hs-identifier hs-var">chain</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1047"></span><span>            </span><span class="annot"><span class="annottext">Maybe CertificateChain
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; PacketFlightM b ()
forall a. a -&gt; PacketFlightM b a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1048"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195749"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195749"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; HandshakeM (Maybe ByteString)
-&gt; PacketFlightM b (Maybe ByteString)
forall (m :: * -&gt; *) a. MonadIO m =&gt; Context -&gt; HandshakeM a -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#usingHState"><span class="hs-identifier hs-var">usingHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">HandshakeM (Maybe ByteString)
</span><a href="Network.TLS.Handshake.State.html#getCertReqToken"><span class="hs-identifier hs-var">getCertReqToken</span></a></span><span> </span><span class="annot"><span class="annottext">PacketFlightM b (Maybe ByteString)
-&gt; (Maybe ByteString -&gt; PacketFlightM b ()) -&gt; PacketFlightM b ()
forall a b.
PacketFlightM b a -&gt; (a -&gt; PacketFlightM b b) -&gt; PacketFlightM b b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">CertificateChain -&gt; Maybe ByteString -&gt; PacketFlightM b ()
forall {b}.
Monoid b =&gt;
CertificateChain -&gt; Maybe ByteString -&gt; PacketFlightM b ()
</span><a href="#local-6989586621679195751"><span class="hs-identifier hs-var">sendClientData13</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195749"><span class="hs-identifier hs-var">cc</span></a></span><span>
</span><span id="line-1049"></span><span>        </span><span id="local-6989586621679195752"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195752"><span class="hs-identifier hs-var">rawFinished</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; Hash -&gt; ByteString -&gt; PacketFlightM b Handshake13
forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; Hash -&gt; ByteString -&gt; m Handshake13
</span><a href="Network.TLS.Handshake.Common13.html#makeFinished"><span class="hs-identifier hs-var">makeFinished</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679195734"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195736"><span class="hs-identifier hs-var">baseKey</span></a></span><span>
</span><span id="line-1050"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; Packet13 -&gt; PacketFlightM b ()
forall b. Monoid b =&gt; Context -&gt; Packet13 -&gt; PacketFlightM b ()
</span><a href="Network.TLS.IO.html#loadPacket13"><span class="hs-identifier hs-var">loadPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet13 -&gt; PacketFlightM b ()) -&gt; Packet13 -&gt; PacketFlightM b ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195752"><span class="hs-identifier hs-var">rawFinished</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1051"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1052"></span><span>    </span><span id="local-6989586621679195751"><span class="annot"><span class="annottext">sendClientData13 :: CertificateChain -&gt; Maybe ByteString -&gt; PacketFlightM b ()
</span><a href="#local-6989586621679195751"><span class="hs-identifier hs-var hs-var">sendClientData13</span></a></span></span><span> </span><span id="local-6989586621679195772"><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195772"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195773"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195773"><span class="hs-identifier hs-var">token</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1053"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">CertificateChain</span></span><span> </span><span id="local-6989586621679195774"><span class="annot"><span class="annottext">[SignedExact Certificate]
</span><a href="#local-6989586621679195774"><span class="hs-identifier hs-var">certs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195772"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-1054"></span><span>            </span><span id="local-6989586621679195776"><span class="annot"><span class="annottext">certExts :: [[a]]
</span><a href="#local-6989586621679195776"><span class="hs-identifier hs-var hs-var">certExts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; [[a]]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SignedExact Certificate] -&gt; Int
forall a. [a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SignedExact Certificate]
</span><a href="#local-6989586621679195774"><span class="hs-identifier hs-var">certs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1055"></span><span>            </span><span id="local-6989586621679195779"><span class="annot"><span class="annottext">cHashSigs :: [HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195779"><span class="hs-identifier hs-var hs-var">cHashSigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HashAndSignatureAlgorithm -&gt; Bool)
-&gt; [HashAndSignatureAlgorithm] -&gt; [HashAndSignatureAlgorithm]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm -&gt; Bool
</span><a href="Network.TLS.Handshake.Common13.html#isHashSignatureValid13"><span class="hs-identifier hs-var">isHashSignatureValid13</span></a></span><span> </span><span class="annot"><span class="annottext">([HashAndSignatureAlgorithm] -&gt; [HashAndSignatureAlgorithm])
-&gt; [HashAndSignatureAlgorithm] -&gt; [HashAndSignatureAlgorithm]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Supported -&gt; [HashAndSignatureAlgorithm]
</span><a href="Network.TLS.Parameters.html#supportedHashSignatures"><span class="hs-identifier hs-var">supportedHashSignatures</span></a></span><span> </span><span class="annot"><span class="annottext">(Supported -&gt; [HashAndSignatureAlgorithm])
-&gt; Supported -&gt; [HashAndSignatureAlgorithm]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; Supported
</span><a href="Network.TLS.Context.Internal.html#ctxSupported"><span class="hs-identifier hs-var">ctxSupported</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-1056"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; Packet13 -&gt; PacketFlightM b ()
forall b. Monoid b =&gt; Context -&gt; Packet13 -&gt; PacketFlightM b ()
</span><a href="Network.TLS.IO.html#loadPacket13"><span class="hs-identifier hs-var">loadPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet13 -&gt; PacketFlightM b ()) -&gt; Packet13 -&gt; PacketFlightM b ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString -&gt; CertificateChain -&gt; [[ExtensionRaw]] -&gt; Handshake13
</span><a href="Network.TLS.Struct13.html#Certificate13"><span class="hs-identifier hs-var">Certificate13</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195773"><span class="hs-identifier hs-var">token</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><a href="#local-6989586621679195772"><span class="hs-identifier hs-var">chain</span></a></span><span> </span><span class="annot"><span class="annottext">[[ExtensionRaw]]
forall {a}. [[a]]
</span><a href="#local-6989586621679195776"><span class="hs-identifier hs-var">certExts</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1057"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[SignedExact Certificate]
</span><a href="#local-6989586621679195774"><span class="hs-identifier hs-var">certs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1058"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; PacketFlightM b ()
forall a. a -&gt; PacketFlightM b a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1059"></span><span>            </span><span class="annot"><span class="annottext">[SignedExact Certificate]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1060"></span><span>                  </span><span id="local-6989586621679195780"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195780"><span class="hs-identifier hs-var">hChSc</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; PacketFlightM b ByteString
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m ByteString
</span><a href="Network.TLS.Handshake.State13.html#transcriptHash"><span class="hs-identifier hs-var">transcriptHash</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-1061"></span><span>                  </span><span id="local-6989586621679195781"><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195781"><span class="hs-identifier hs-var">pubKey</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; PacketFlightM b PubKey
forall (m :: * -&gt; *). MonadIO m =&gt; Context -&gt; m PubKey
</span><a href="Network.TLS.Handshake.Key.html#getLocalPublicKey"><span class="hs-identifier hs-var">getLocalPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-1062"></span><span>                  </span><span id="local-6989586621679195782"><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679195782"><span class="hs-identifier hs-var">sigAlg</span></a></span></span><span>     </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO HashAndSignatureAlgorithm
-&gt; PacketFlightM b HashAndSignatureAlgorithm
forall a. IO a -&gt; PacketFlightM b a
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO HashAndSignatureAlgorithm
 -&gt; PacketFlightM b HashAndSignatureAlgorithm)
-&gt; IO HashAndSignatureAlgorithm
-&gt; PacketFlightM b HashAndSignatureAlgorithm
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Context
-&gt; (PubKey -&gt; HashAndSignatureAlgorithm -&gt; Bool)
-&gt; [HashAndSignatureAlgorithm]
-&gt; PubKey
-&gt; IO HashAndSignatureAlgorithm
</span><a href="Network.TLS.Handshake.Client.html#getLocalHashSigAlg"><span class="hs-identifier hs-var">getLocalHashSigAlg</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey -&gt; HashAndSignatureAlgorithm -&gt; Bool
</span><a href="Network.TLS.Handshake.Signature.html#signatureCompatible13"><span class="hs-identifier hs-var">signatureCompatible13</span></a></span><span> </span><span class="annot"><span class="annottext">[HashAndSignatureAlgorithm]
</span><a href="#local-6989586621679195779"><span class="hs-identifier hs-var">cHashSigs</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195781"><span class="hs-identifier hs-var">pubKey</span></a></span><span>
</span><span id="line-1063"></span><span>                  </span><span id="local-6989586621679195783"><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195783"><span class="hs-identifier hs-var">vfy</span></a></span></span><span>        </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context
-&gt; PubKey
-&gt; HashAndSignatureAlgorithm
-&gt; ByteString
-&gt; PacketFlightM b Handshake13
forall (m :: * -&gt; *).
MonadIO m =&gt;
Context
-&gt; PubKey
-&gt; HashAndSignatureAlgorithm
-&gt; ByteString
-&gt; m Handshake13
</span><a href="Network.TLS.Handshake.Common13.html#makeCertVerify"><span class="hs-identifier hs-var">makeCertVerify</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">PubKey
</span><a href="#local-6989586621679195781"><span class="hs-identifier hs-var">pubKey</span></a></span><span> </span><span class="annot"><span class="annottext">HashAndSignatureAlgorithm
</span><a href="#local-6989586621679195782"><span class="hs-identifier hs-var">sigAlg</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195780"><span class="hs-identifier hs-var">hChSc</span></a></span><span>
</span><span id="line-1064"></span><span>                  </span><span class="annot"><span class="annottext">Context -&gt; Packet13 -&gt; PacketFlightM b ()
forall b. Monoid b =&gt; Context -&gt; Packet13 -&gt; PacketFlightM b ()
</span><a href="Network.TLS.IO.html#loadPacket13"><span class="hs-identifier hs-var">loadPacket13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195733"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(Packet13 -&gt; PacketFlightM b ()) -&gt; Packet13 -&gt; PacketFlightM b ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Handshake13] -&gt; Packet13
</span><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-var">Handshake13</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195783"><span class="hs-identifier hs-var">vfy</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1065"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-1066"></span><span>    </span><span class="annot"><a href="#local-6989586621679195751"><span class="hs-identifier hs-var">sendClientData13</span></a></span><span> </span><span class="annot"><span class="annottext">CertificateChain
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1067"></span><span>        </span><span class="annot"><span class="annottext">TLSError -&gt; PacketFlightM b ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; PacketFlightM b ()) -&gt; TLSError -&gt; PacketFlightM b ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span>
</span><span id="line-1068"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;missing TLS 1.3 certificate request context token&quot;</span></span><span>
</span><span id="line-1069"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1070"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#InternalError"><span class="hs-identifier hs-var">InternalError</span></a></span><span>
</span><span id="line-1071"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-1072"></span><span>
</span><span id="line-1073"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#setALPN"><span class="hs-identifier hs-type">setALPN</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Extension.html#MessageType"><span class="hs-identifier hs-type">MessageType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Network.TLS.Struct.html#ExtensionRaw"><span class="hs-identifier hs-type">ExtensionRaw</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1074"></span><span id="setALPN"><span class="annot"><span class="annottext">setALPN :: Context -&gt; MessageType -&gt; [ExtensionRaw] -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#setALPN"><span class="hs-identifier hs-var hs-var">setALPN</span></a></span></span><span> </span><span id="local-6989586621679195785"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195785"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679195786"><span class="annot"><span class="annottext">MessageType
</span><a href="#local-6989586621679195786"><span class="hs-identifier hs-var">msgt</span></a></span></span><span> </span><span id="local-6989586621679195787"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195787"><span class="hs-identifier hs-var">exts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExtensionID -&gt; [ExtensionRaw] -&gt; Maybe ByteString
</span><a href="Network.TLS.Handshake.Common.html#extensionLookup"><span class="hs-identifier hs-var">extensionLookup</span></a></span><span> </span><span class="annot"><span class="annottext">ExtensionID
</span><a href="Network.TLS.Extension.html#extensionID_ApplicationLayerProtocolNegotiation"><span class="hs-identifier hs-var">extensionID_ApplicationLayerProtocolNegotiation</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195787"><span class="hs-identifier hs-var">exts</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ByteString
-&gt; (ByteString -&gt; Maybe ApplicationLayerProtocolNegotiation)
-&gt; Maybe ApplicationLayerProtocolNegotiation
forall a b. Maybe a -&gt; (a -&gt; Maybe b) -&gt; Maybe b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">MessageType
-&gt; ByteString -&gt; Maybe ApplicationLayerProtocolNegotiation
forall a. Extension a =&gt; MessageType -&gt; ByteString -&gt; Maybe a
</span><a href="Network.TLS.Extension.html#extensionDecode"><span class="hs-identifier hs-var">extensionDecode</span></a></span><span> </span><span class="annot"><span class="annottext">MessageType
</span><a href="#local-6989586621679195786"><span class="hs-identifier hs-var">msgt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1075"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Extension.html#ApplicationLayerProtocolNegotiation"><span class="hs-identifier hs-type">ApplicationLayerProtocolNegotiation</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679195789"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195789"><span class="hs-identifier hs-var">proto</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context -&gt; TLSSt () -&gt; IO ()
forall a. Context -&gt; TLSSt a -&gt; IO a
</span><a href="Network.TLS.Context.Internal.html#usingState_"><span class="hs-identifier hs-var">usingState_</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195785"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSSt () -&gt; IO ()) -&gt; TLSSt () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1076"></span><span>        </span><span id="local-6989586621679195790"><span class="annot"><span class="annottext">Maybe [ByteString]
</span><a href="#local-6989586621679195790"><span class="hs-identifier hs-var">mprotos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TLSSt (Maybe [ByteString])
</span><a href="Network.TLS.State.html#getClientALPNSuggest"><span class="hs-identifier hs-var">getClientALPNSuggest</span></a></span><span>
</span><span id="line-1077"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [ByteString]
</span><a href="#local-6989586621679195790"><span class="hs-identifier hs-var">mprotos</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1078"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679195792"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679195792"><span class="hs-identifier hs-var">protos</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; TLSSt () -&gt; TLSSt ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195789"><span class="hs-identifier hs-var">proto</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; Bool
forall a. Eq a =&gt; a -&gt; [a] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679195792"><span class="hs-identifier hs-var">protos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TLSSt () -&gt; TLSSt ()) -&gt; TLSSt () -&gt; TLSSt ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1079"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setExtensionALPN"><span class="hs-identifier hs-var">setExtensionALPN</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1080"></span><span>                </span><span class="annot"><span class="annottext">ByteString -&gt; TLSSt ()
</span><a href="Network.TLS.State.html#setNegotiatedProtocol"><span class="hs-identifier hs-var">setNegotiatedProtocol</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195789"><span class="hs-identifier hs-var">proto</span></a></span><span>
</span><span id="line-1081"></span><span>            </span><span class="annot"><span class="annottext">Maybe [ByteString]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; TLSSt ()
forall a. a -&gt; TLSSt a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1082"></span><span>    </span><span class="annot"><span class="annottext">Maybe ApplicationLayerProtocolNegotiation
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1083"></span><span>
</span><span id="line-1084"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#postHandshakeAuthClientWith"><span class="hs-identifier hs-type">postHandshakeAuthClientWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Parameters.html#ClientParams"><span class="hs-identifier hs-type">ClientParams</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Struct13.html#Handshake13"><span class="hs-identifier hs-type">Handshake13</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1085"></span><span id="postHandshakeAuthClientWith"><span class="annot"><span class="annottext">postHandshakeAuthClientWith :: ClientParams -&gt; Context -&gt; Handshake13 -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#postHandshakeAuthClientWith"><span class="hs-identifier hs-var hs-var">postHandshakeAuthClientWith</span></a></span></span><span> </span><span id="local-6989586621679195795"><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195795"><span class="hs-identifier hs-var">cparams</span></a></span></span><span> </span><span id="local-6989586621679195796"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195796"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679195797"><span class="annot"><span class="annottext">h :: Handshake13
</span><a href="#local-6989586621679195797"><span class="hs-identifier hs-var">h</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Network.TLS.Struct13.html#CertRequest13"><span class="hs-identifier hs-type">CertRequest13</span></a></span><span> </span><span id="local-6989586621679195798"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195798"><span class="hs-identifier hs-var">certReqCtx</span></a></span></span><span> </span><span id="local-6989586621679195799"><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195799"><span class="hs-identifier hs-var">exts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1086"></span><span>    </span><span class="annot"><span class="annottext">IO (Saved (Maybe HandshakeState))
-&gt; (Saved (Maybe HandshakeState)
    -&gt; IO (Saved (Maybe HandshakeState)))
-&gt; (Saved (Maybe HandshakeState) -&gt; IO ())
-&gt; IO ()
forall a b c. IO a -&gt; (a -&gt; IO b) -&gt; (a -&gt; IO c) -&gt; IO c
</span><span class="hs-identifier hs-var">bracket</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context -&gt; IO (Saved (Maybe HandshakeState))
</span><a href="Network.TLS.Context.Internal.html#saveHState"><span class="hs-identifier hs-var">saveHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195796"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Context
-&gt; Saved (Maybe HandshakeState)
-&gt; IO (Saved (Maybe HandshakeState))
</span><a href="Network.TLS.Context.Internal.html#restoreHState"><span class="hs-identifier hs-var">restoreHState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195796"><span class="hs-identifier hs-var">ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Saved (Maybe HandshakeState) -&gt; IO ()) -&gt; IO ())
-&gt; (Saved (Maybe HandshakeState) -&gt; IO ()) -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Saved (Maybe HandshakeState)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1087"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; Handshake13 -&gt; IO ()
</span><a href="Network.TLS.Handshake.Process.html#processHandshake13"><span class="hs-identifier hs-var">processHandshake13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195796"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><a href="#local-6989586621679195797"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-1088"></span><span>        </span><span class="annot"><span class="annottext">Context -&gt; ByteString -&gt; [ExtensionRaw] -&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Context -&gt; ByteString -&gt; [ExtensionRaw] -&gt; m ()
</span><a href="Network.TLS.Handshake.Client.html#processCertRequest13"><span class="hs-identifier hs-var">processCertRequest13</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195796"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195798"><span class="hs-identifier hs-var">certReqCtx</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtensionRaw]
</span><a href="#local-6989586621679195799"><span class="hs-identifier hs-var">exts</span></a></span><span>
</span><span id="line-1089"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621679195803"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679195803"><span class="hs-identifier hs-var">usedHash</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Cipher
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679195804"><span class="annot"><span class="annottext">CryptLevel
</span><a href="#local-6989586621679195804"><span class="hs-identifier hs-var">level</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679195805"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195805"><span class="hs-identifier hs-var">applicationSecretN</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Context -&gt; IO (Hash, Cipher, CryptLevel, ByteString)
</span><a href="Network.TLS.Handshake.State13.html#getTxState"><span class="hs-identifier hs-var">getTxState</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195796"><span class="hs-identifier hs-var">ctx</span></a></span><span>
</span><span id="line-1090"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CryptLevel
</span><a href="#local-6989586621679195804"><span class="hs-identifier hs-var">level</span></a></span><span> </span><span class="annot"><span class="annottext">CryptLevel -&gt; CryptLevel -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">CryptLevel
</span><a href="Network.TLS.Record.State.html#CryptApplicationSecret"><span class="hs-identifier hs-var">CryptApplicationSecret</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1091"></span><span>            </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unexpected post-handshake authentication request&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1092"></span><span>        </span><span class="annot"><span class="annottext">ClientParams -&gt; Context -&gt; Hash -&gt; ClientTrafficSecret Any -&gt; IO ()
forall a.
ClientParams -&gt; Context -&gt; Hash -&gt; ClientTrafficSecret a -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#sendClientFlight13"><span class="hs-identifier hs-var">sendClientFlight13</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><a href="#local-6989586621679195795"><span class="hs-identifier hs-var">cparams</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195796"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679195803"><span class="hs-identifier hs-var">usedHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; ClientTrafficSecret Any
forall a. ByteString -&gt; ClientTrafficSecret a
</span><a href="Network.TLS.Types.html#ClientTrafficSecret"><span class="hs-identifier hs-var">ClientTrafficSecret</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679195805"><span class="hs-identifier hs-var">applicationSecretN</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1093"></span><span>
</span><span id="line-1094"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#postHandshakeAuthClientWith"><span class="hs-identifier hs-var">postHandshakeAuthClientWith</span></a></span><span> </span><span class="annot"><span class="annottext">ClientParams
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Context
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Handshake13
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1095"></span><span>    </span><span class="annot"><span class="annottext">TLSError -&gt; IO ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; TLSError -&gt; m a
</span><a href="Network.TLS.Context.Internal.html#throwCore"><span class="hs-identifier hs-var">throwCore</span></a></span><span> </span><span class="annot"><span class="annottext">(TLSError -&gt; IO ()) -&gt; TLSError -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(String, Bool, AlertDescription) -&gt; TLSError
</span><a href="Network.TLS.Struct.html#Error_Protocol"><span class="hs-identifier hs-var">Error_Protocol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unexpected handshake message received in postHandshakeAuthClientWith&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">AlertDescription
</span><a href="Network.TLS.Struct.html#UnexpectedMessage"><span class="hs-identifier hs-var">UnexpectedMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1096"></span><span>
</span><span id="line-1097"></span><span class="annot"><a href="Network.TLS.Handshake.Client.html#contextSync"><span class="hs-identifier hs-type">contextSync</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Network.TLS.Context.Internal.html#Context"><span class="hs-identifier hs-type">Context</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Network.TLS.Handshake.Control.html#ClientState"><span class="hs-identifier hs-type">ClientState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1098"></span><span id="contextSync"><span class="annot"><span class="annottext">contextSync :: Context -&gt; ClientState -&gt; IO ()
</span><a href="Network.TLS.Handshake.Client.html#contextSync"><span class="hs-identifier hs-var hs-var">contextSync</span></a></span></span><span> </span><span id="local-6989586621679195808"><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195808"><span class="hs-identifier hs-var">ctx</span></a></span></span><span> </span><span id="local-6989586621679195809"><span class="annot"><span class="annottext">ClientState
</span><a href="#local-6989586621679195809"><span class="hs-identifier hs-var">ctl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Context -&gt; HandshakeSync
</span><a href="Network.TLS.Context.Internal.html#ctxHandshakeSync"><span class="hs-identifier hs-var">ctxHandshakeSync</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195808"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1099"></span><span>    </span><span class="annot"><a href="Network.TLS.Context.Internal.html#HandshakeSync"><span class="hs-identifier hs-type">HandshakeSync</span></a></span><span> </span><span id="local-6989586621679195812"><span class="annot"><span class="annottext">Context -&gt; ClientState -&gt; IO ()
</span><a href="#local-6989586621679195812"><span class="hs-identifier hs-var">sync</span></a></span></span><span> </span><span class="annot"><span class="annottext">Context -&gt; ServerState -&gt; IO ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Context -&gt; ClientState -&gt; IO ()
</span><a href="#local-6989586621679195812"><span class="hs-identifier hs-var">sync</span></a></span><span> </span><span class="annot"><span class="annottext">Context
</span><a href="#local-6989586621679195808"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">ClientState
</span><a href="#local-6989586621679195809"><span class="hs-identifier hs-var">ctl</span></a></span><span>
</span><span id="line-1100"></span></pre></body></html>