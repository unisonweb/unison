<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Crypto.JOSE.JWK.Store</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">jose-0.11: JSON Object Signing and Encryption (JOSE) and JSON Web Token (JWT) library</span><ul class="links" id="page-menu"><li><a href="src/Crypto.JOSE.JWK.Store.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>Safe-Inferred</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Crypto.JOSE.JWK.Store</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Key stores.  Instances are provided for <code><a href="Crypto-JOSE-JWK.html#t:JWK" title="Crypto.JOSE.JWK">JWK</a></code> and <code><a href="Crypto-JOSE-JWK.html#t:JWKSet" title="Crypto.JOSE.JWK">JWKSet</a></code>.  These
instances ignore the header and payload and just return the JWK/s
they contain.  More complex scenarios, such as efficient key lookup
by <code>&quot;kid&quot;</code> or searching a database, can be implemented by writing a
new instance.</p><p>For example, the following instance looks in a filesystem directory
for keys based on either the JWS Header's <code>&quot;kid&quot;</code> parameter, or the
  <code>&quot;iss&quot;</code> claim in a JWT Claims Set:</p><pre>-- | A KeyDB is just a filesystem directory
newtype KeyDB = KeyDB FilePath

instance (MonadIO m, <code><a href="Crypto-JOSE-Header.html#t:HasKid" title="Crypto.JOSE.Header">HasKid</a></code> h)
    =&gt; VerificationKeyStore m (h p) <code><a href="Crypto-JWT.html#t:ClaimsSet" title="Crypto.JWT">ClaimsSet</a></code> KeyDB where
  <code><a href="Crypto-JOSE-JWK-Store.html#v:getVerificationKeys" title="Crypto.JOSE.JWK.Store">getVerificationKeys</a></code> h claims (KeyDB dir) = liftIO $
    fmap catMaybes . traverse findKey $ catMaybes
      [ preview (<code><a href="Crypto-JOSE-Header.html#v:kid" title="Crypto.JOSE.Header">kid</a></code> . _Just . <code><a href="Crypto-JOSE-Header.html#v:param" title="Crypto.JOSE.Header">param</a></code>) h
      , preview (<code><a href="Crypto-JWT.html#v:claimIss" title="Crypto.JWT">claimIss</a></code> . _Just . <code><a href="Crypto-JWT.html#v:string" title="Crypto.JWT">string</a></code>) claims]
    where
    findKey :: T.Text -&gt; IO (Maybe JWK)
    findKey s =
      let path = dir &lt;&gt; &quot;/&quot; &lt;&gt; T.unpack s &lt;&gt; &quot;.jwk&quot;
      in handle
        (\(_ :: IOException) -&gt; pure Nothing)
        (decode &lt;$&gt; L.readFile path)
</pre><p>The next example shows how to retrieve public keys from a JWK Set
(<code>/.well-known/jwks.json</code>) resource.  For production use, it would
be a good idea to cache the HTTP response.  Thanks to Steve Mao for
this example.</p><pre>-- | URI of JWK Set
newtype JWKsURI = JWKsURI String

instance (MonadIO m, <code><a href="Crypto-JOSE-Header.html#t:HasKid" title="Crypto.JOSE.Header">HasKid</a></code> h)
    =&gt; <code><a href="Crypto-JOSE-JWK-Store.html#t:VerificationKeyStore" title="Crypto.JOSE.JWK.Store">VerificationKeyStore</a></code> m (h p) <code><a href="Crypto-JWT.html#t:ClaimsSet" title="Crypto.JWT">ClaimsSet</a></code> JWKsURI where
  <code><a href="Crypto-JOSE-JWK-Store.html#v:getVerificationKeys" title="Crypto.JOSE.JWK.Store">getVerificationKeys</a></code> h claims (JWKsURI url) = liftIO $
    maybe [] (:[]) . join
      &lt;$&gt; traverse findKey (preview (<code><a href="Crypto-JOSE-Header.html#v:kid" title="Crypto.JOSE.Header">kid</a></code> . _Just . <code><a href="Crypto-JOSE-Header.html#v:param" title="Crypto.JOSE.Header">param</a></code>) h)
    where
    findKey :: T.Text -&gt; IO (Maybe JWK)
    findKey kid' =
      handle (\(_ :: SomeException) -&gt; pure Nothing) $ do
        request &lt;- setRequestCheckStatus &lt;$&gt; parseRequest url
        response &lt;- getResponseBody &lt;$&gt; httpJSON request
        keys &lt;- getVerificationKeys h claims response
        pure $ find (\j -&gt; view <code><a href="Crypto-JOSE-JWK.html#v:jwkKid" title="Crypto.JOSE.JWK">jwkKid</a></code> j == Just kid') keys
</pre></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><span class="keyword">class</span> <a href="#t:VerificationKeyStore">VerificationKeyStore</a> m h s a <span class="keyword">where</span><ul class="subs"><li><a href="#v:getVerificationKeys">getVerificationKeys</a> :: h -&gt; s -&gt; a -&gt; m [<a href="Crypto-JOSE-JWK.html#t:JWK" title="Crypto.JOSE.JWK">JWK</a>]</li></ul></li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><span class="keyword">class</span> <a id="t:VerificationKeyStore" class="def">VerificationKeyStore</a> m h s a <span class="keyword">where</span> <a href="src/Crypto.JOSE.JWK.Store.html#VerificationKeyStore" class="link">Source</a> <a href="#t:VerificationKeyStore" class="selflink">#</a></p><div class="doc"><p>Verification keys.  Lookup operates in effect <code>m</code> with access
 to the JWS header of type <code>h</code> and a payload of type <code>s</code>.</p><p>The returned keys are not guaranteed to be used, e.g. if the JWK
 <code>&quot;use&quot;</code> or <code>&quot;key_ops&quot;</code> field does not allow use for verification.</p></div><div class="subs methods"><p class="caption">Methods</p><p class="src"><a id="v:getVerificationKeys" class="def">getVerificationKeys</a> <a href="src/Crypto.JOSE.JWK.Store.html#getVerificationKeys" class="link">Source</a> <a href="#v:getVerificationKeys" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: h</td><td class="doc"><p>JWS header</p></td></tr><tr><td class="src">-&gt; s</td><td class="doc"><p>Payload</p></td></tr><tr><td class="src">-&gt; a</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; m [<a href="Crypto-JOSE-JWK.html#t:JWK" title="Crypto.JOSE.JWK">JWK</a>]</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Look up verification keys by JWS header and payload.</p></div></div><div class="subs instances"><h4 class="instances details-toggle-control details-toggle" data-details-id="i:VerificationKeyStore">Instances</h4><details id="i:VerificationKeyStore" open="open"><summary class="hide-when-js-enabled">Instances details</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:ic:VerificationKeyStore:VerificationKeyStore:1"></span> <a href="../base-4.18.2.1/Control-Applicative.html#t:Applicative" title="Control.Applicative">Applicative</a> m =&gt; <a href="Crypto-JOSE-JWK-Store.html#t:VerificationKeyStore" title="Crypto.JOSE.JWK.Store">VerificationKeyStore</a> m h s <a href="Crypto-JOSE-JWK.html#t:JWK" title="Crypto.JOSE.JWK">JWK</a></span> <a href="src/Crypto.JOSE.JWK.Store.html#line-98" class="link">Source</a> <a href="#t:VerificationKeyStore" class="selflink">#</a></td><td class="doc"><p>Use a <code><a href="Crypto-JOSE-JWK.html#t:JWK" title="Crypto.JOSE.JWK">JWK</a></code> as a <code><a href="Crypto-JOSE-JWK-Store.html#t:VerificationKeyStore" title="Crypto.JOSE.JWK.Store">VerificationKeyStore</a></code>.  Can be used with any
 payload type.  Header and payload are ignored.  No filtering is
 performed.</p></td></tr><tr><td colspan="2"><details id="i:ic:VerificationKeyStore:VerificationKeyStore:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Crypto-JOSE-JWK-Store.html">Crypto.JOSE.JWK.Store</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:getVerificationKeys">getVerificationKeys</a> :: h -&gt; s -&gt; <a href="Crypto-JOSE-JWK.html#t:JWK" title="Crypto.JOSE.JWK">JWK</a> -&gt; m [<a href="Crypto-JOSE-JWK.html#t:JWK" title="Crypto.JOSE.JWK">JWK</a>] <a href="src/Crypto.JOSE.JWK.Store.html#getVerificationKeys" class="link">Source</a> <a href="#v:getVerificationKeys" class="selflink">#</a></p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:ic:VerificationKeyStore:VerificationKeyStore:2"></span> <a href="../base-4.18.2.1/Control-Applicative.html#t:Applicative" title="Control.Applicative">Applicative</a> m =&gt; <a href="Crypto-JOSE-JWK-Store.html#t:VerificationKeyStore" title="Crypto.JOSE.JWK.Store">VerificationKeyStore</a> m h s <a href="Crypto-JOSE-JWK.html#t:JWKSet" title="Crypto.JOSE.JWK">JWKSet</a></span> <a href="src/Crypto.JOSE.JWK.Store.html#line-105" class="link">Source</a> <a href="#t:VerificationKeyStore" class="selflink">#</a></td><td class="doc"><p>Use a <code><a href="Crypto-JOSE-JWK.html#t:JWKSet" title="Crypto.JOSE.JWK">JWKSet</a></code> as a <code><a href="Crypto-JOSE-JWK-Store.html#t:VerificationKeyStore" title="Crypto.JOSE.JWK.Store">VerificationKeyStore</a></code>.  Can be used with
 any payload type.  Returns all keys in the set; header and
 payload are ignored.  No filtering is performed.</p></td></tr><tr><td colspan="2"><details id="i:ic:VerificationKeyStore:VerificationKeyStore:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Crypto-JOSE-JWK-Store.html">Crypto.JOSE.JWK.Store</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:getVerificationKeys">getVerificationKeys</a> :: h -&gt; s -&gt; <a href="Crypto-JOSE-JWK.html#t:JWKSet" title="Crypto.JOSE.JWK">JWKSet</a> -&gt; m [<a href="Crypto-JOSE-JWK.html#t:JWK" title="Crypto.JOSE.JWK">JWK</a>] <a href="src/Crypto.JOSE.JWK.Store.html#getVerificationKeys" class="link">Source</a> <a href="#v:getVerificationKeys" class="selflink">#</a></p></div></details></td></tr></table></details></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.29.2</p></div></body></html>