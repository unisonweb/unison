<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">U.Codebase.Term.Hashing</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Lens</span></span><span>
</span><span id="line-4"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Foldable</span></span><span>
</span><span id="line-5"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.HashTags</span></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Reference</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Reference</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.HashHandle</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">HashMismatch</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.LocalIds</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LocalIds</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Queries</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Q</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Symbol</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Term.Format</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S.Term</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Sqlite.Term.Format</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TermFormat</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Term</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Term</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C.Term</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Codebase.Type</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C.Type</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">U.Core.ABT</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ABT</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Hash32</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Hash32</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Hash32</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Hashing.V2</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">H2</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Unison.Hashing.V2.Convert2.html"><span class="hs-identifier">Unison.Hashing.V2.Convert2</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">H2</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Prelude</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Symbol</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Unison</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Unison.Var</span></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Var</span></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="annot"><a href="U.Codebase.Term.Hashing.html#verifyTermFormatHash"><span class="hs-identifier hs-type">verifyTermFormatHash</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ComponentHash</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TermFormat.HashTermFormat</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">HashMismatch</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span id="verifyTermFormatHash"><span class="annot"><span class="annottext">verifyTermFormatHash :: ComponentHash -&gt; HashTermFormat -&gt; Maybe HashMismatch
</span><a href="U.Codebase.Term.Hashing.html#verifyTermFormatHash"><span class="hs-identifier hs-var hs-var">verifyTermFormatHash</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ComponentHash</span></span><span> </span><span id="local-6989586621679095118"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679095118"><span class="hs-identifier hs-var">hash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TermFormat.Term</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TermFormat.LocallyIndexedComponent</span></span><span> </span><span id="local-6989586621679095121"><span class="annot"><span class="annottext">Vector (LocalIds' Text Hash32, Term, Type)
</span><a href="#local-6989586621679095121"><span class="hs-identifier hs-var">elements</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-28"></span><span>  </span><span class="annot"><span class="annottext">Vector (LocalIds' Text Hash32, Term, Type)
-&gt; [(LocalIds' Text Hash32, Term, Type)]
forall a. Vector a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">Foldable.toList</span></span><span> </span><span class="annot"><span class="annottext">Vector (LocalIds' Text Hash32, Term, Type)
</span><a href="#local-6989586621679095121"><span class="hs-identifier hs-var">elements</span></a></span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><span class="annottext">[(LocalIds' Text Hash32, Term, Type)]
-&gt; ([(LocalIds' Text Hash32, Term, Type)]
    -&gt; [(Term Symbol, Type Symbol)])
-&gt; [(Term Symbol, Type Symbol)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((LocalIds' Text Hash32, Term, Type) -&gt; (Term Symbol, Type Symbol))
-&gt; [(LocalIds' Text Hash32, Term, Type)]
-&gt; [(Term Symbol, Type Symbol)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(LocalIds' Text Hash32, Term, Type) -&gt; (Term Symbol, Type Symbol)
</span><a href="U.Codebase.Term.Hashing.html#s2cTermWithType"><span class="hs-identifier hs-var">s2cTermWithType</span></a></span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><span class="annottext">[(Term Symbol, Type Symbol)]
-&gt; ([(Term Symbol, Type Symbol)]
    -&gt; [((Term Symbol, Type Symbol), Id)])
-&gt; [((Term Symbol, Type Symbol), Id)]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Hash
-&gt; [(Term Symbol, Type Symbol)]
-&gt; [((Term Symbol, Type Symbol), Id)]
forall k. Hash -&gt; [k] -&gt; [(k, Id)]
</span><span class="hs-identifier hs-var">Reference.component</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679095118"><span class="hs-identifier hs-var">hash</span></a></span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><span class="annottext">[((Term Symbol, Type Symbol), Id)]
-&gt; ([((Term Symbol, Type Symbol), Id)]
    -&gt; [(Id,
         (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
          Term (F' TypeRef) Symbol ()))])
-&gt; [(Id,
     (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
      Term (F' TypeRef) Symbol ()))]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">(((Term Symbol, Type Symbol), Id)
 -&gt; (Id,
     (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
      Term (F' TypeRef) Symbol ())))
-&gt; [((Term Symbol, Type Symbol), Id)]
-&gt; [(Id,
     (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
      Term (F' TypeRef) Symbol ()))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621679095126"><span class="annot"><span class="annottext">Term Symbol
</span><a href="#local-6989586621679095126"><span class="hs-identifier hs-var">tm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679095127"><span class="annot"><span class="annottext">Type Symbol
</span><a href="#local-6989586621679095127"><span class="hs-identifier hs-var">typ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621679095128"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621679095128"><span class="hs-identifier hs-var">refId</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621679095128"><span class="hs-identifier hs-var">refId</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Term Symbol
-&gt; Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol ()
forall text' termRef' typeRef' termLink' typeLink' a.
Term
  (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a
-&gt; Term
     (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a
</span><a href="#local-6989586621679095129"><span class="hs-identifier hs-var">mapTermV</span></a></span><span> </span><span class="annot"><span class="annottext">Term Symbol
</span><a href="#local-6989586621679095126"><span class="hs-identifier hs-var">tm</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type Symbol -&gt; Term (F' TypeRef) Symbol ()
forall r. Term (F' r) Symbol () -&gt; Term (F' r) Symbol ()
</span><a href="#local-6989586621679095130"><span class="hs-identifier hs-var">mapTypeV</span></a></span><span> </span><span class="annot"><span class="annottext">Type Symbol
</span><a href="#local-6989586621679095127"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><span class="annottext">[(Id,
  (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
   Term (F' TypeRef) Symbol ()))]
-&gt; ([(Id,
      (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
       Term (F' TypeRef) Symbol ()))]
    -&gt; Map
         Id
         (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
          Term (F' TypeRef) Symbol ()))
-&gt; Map
     Id
     (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
      Term (F' TypeRef) Symbol ())
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(Id,
  (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
   Term (F' TypeRef) Symbol ()))]
-&gt; Map
     Id
     (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
      Term (F' TypeRef) Symbol ())
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><span class="annottext">Map
  Id
  (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
   Term (F' TypeRef) Symbol ())
-&gt; (Map
      Id
      (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
       Term (F' TypeRef) Symbol ())
    -&gt; Map
         Id (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ()))
-&gt; Map
     Id (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ())
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Hash
-&gt; (Id -&gt; Symbol)
-&gt; Map
     Id
     (Term (F' Text TermRef TypeRef TermLink TypeRef Symbol) Symbol (),
      Term (F' TypeRef) Symbol ())
-&gt; Map
     Id (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ())
forall v extra.
Var v =&gt;
Hash
-&gt; (Id -&gt; v)
-&gt; Map Id (Term v, extra)
-&gt; Map Id (v, HashableTerm v, extra)
</span><span class="hs-identifier hs-var">C.Term.unhashComponent</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679095118"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">Id -&gt; Symbol
forall v. Var v =&gt; Id -&gt; v
</span><span class="hs-identifier hs-var">Var.unnamedRef</span></span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><span class="annottext">Map Id (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ())
-&gt; (Map
      Id (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ())
    -&gt; [(Id,
         (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ()))])
-&gt; [(Id,
     (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ()))]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map Id (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ())
-&gt; [(Id,
     (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ()))]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">Map.toList</span></span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><span class="annottext">[(Id, (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ()))]
-&gt; ([(Id,
      (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ()))]
    -&gt; [(Symbol, (Term Symbol (), Type Symbol (), ()))])
-&gt; [(Symbol, (Term Symbol (), Type Symbol (), ()))]
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((Id, (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ()))
 -&gt; (Symbol, (Term Symbol (), Type Symbol (), ())))
-&gt; [(Id,
     (Symbol, HashableTerm Symbol, Term (F' TypeRef) Symbol ()))]
-&gt; [(Symbol, (Term Symbol (), Type Symbol (), ()))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679095135"><span class="annot"><span class="annottext">Id
</span><a href="#local-6989586621679095135"><span class="hs-identifier hs-var">_refId</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679095136"><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679095136"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679095137"><span class="annot"><span class="annottext">HashableTerm Symbol
</span><a href="#local-6989586621679095137"><span class="hs-identifier hs-var">trm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679095138"><span class="annot"><span class="annottext">Term (F' TypeRef) Symbol ()
</span><a href="#local-6989586621679095138"><span class="hs-identifier hs-var">typ</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Symbol
</span><a href="#local-6989586621679095136"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashableTerm Symbol -&gt; Term Symbol ()
forall v. Ord v =&gt; HashableTerm v -&gt; Term v ()
</span><a href="Unison.Hashing.V2.Convert2.html#v2ToH2Term"><span class="hs-identifier hs-var">H2.v2ToH2Term</span></a></span><span> </span><span class="annot"><span class="annottext">HashableTerm Symbol
</span><a href="#local-6989586621679095137"><span class="hs-identifier hs-var">trm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Term (F' TypeRef) Symbol () -&gt; Type Symbol ()
forall v. Ord v =&gt; TypeR TypeRef v -&gt; Type v ()
</span><a href="Unison.Hashing.V2.Convert2.html#v2ToH2Type"><span class="hs-identifier hs-var">H2.v2ToH2Type</span></a></span><span> </span><span class="annot"><span class="annottext">Term (F' TypeRef) Symbol ()
</span><a href="#local-6989586621679095138"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><span class="annottext">[(Symbol, (Term Symbol (), Type Symbol (), ()))]
-&gt; ([(Symbol, (Term Symbol (), Type Symbol (), ()))]
    -&gt; Map Symbol (Term Symbol (), Type Symbol (), ()))
-&gt; Map Symbol (Term Symbol (), Type Symbol (), ())
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">[(Symbol, (Term Symbol (), Type Symbol (), ()))]
-&gt; Map Symbol (Term Symbol (), Type Symbol (), ())
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">Map.fromList</span></span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><span class="annottext">Map Symbol (Term Symbol (), Type Symbol (), ())
-&gt; (Map Symbol (Term Symbol (), Type Symbol (), ())
    -&gt; Map Symbol (ReferenceId, Term Symbol (), Type Symbol (), ()))
-&gt; Map Symbol (ReferenceId, Term Symbol (), Type Symbol (), ())
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Map Symbol (Term Symbol (), Type Symbol (), ())
-&gt; Map Symbol (ReferenceId, Term Symbol (), Type Symbol (), ())
forall v a extra.
Var v =&gt;
Map v (Term v a, Type v a, extra)
-&gt; Map v (ReferenceId, Term v a, Type v a, extra)
</span><span class="hs-identifier hs-var">H2.hashTermComponents</span></span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="annottext">Map Symbol (ReferenceId, Term Symbol (), Type Symbol (), ())
-&gt; (Map Symbol (ReferenceId, Term Symbol (), Type Symbol (), ())
    -&gt; Maybe HashMismatch)
-&gt; Maybe HashMismatch
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">((ReferenceId, Term Symbol (), Type Symbol (), ())
 -&gt; Maybe HashMismatch)
-&gt; Map Symbol (ReferenceId, Term Symbol (), Type Symbol (), ())
-&gt; Maybe HashMismatch
forall (f :: * -&gt; *) (t :: * -&gt; *) a b.
(Alternative f, Foldable t) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f b
</span><span class="hs-identifier hs-var">altMap</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">H2.ReferenceId</span></span><span> </span><span id="local-6989586621679095144"><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679095144"><span class="hs-identifier hs-var">hash'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679095145"><span class="annot"><span class="annottext">Term Symbol ()
</span><a href="#local-6989586621679095145"><span class="hs-identifier hs-var">_trm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679095146"><span class="annot"><span class="annottext">Type Symbol ()
</span><a href="#local-6989586621679095146"><span class="hs-identifier hs-var">_typ</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679095147"><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621679095147"><span class="hs-identifier hs-var">_extra</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-39"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679095118"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Hash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679095144"><span class="hs-identifier hs-var">hash'</span></a></span><span>
</span><span id="line-40"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe HashMismatch
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-41"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">HashMismatch -&gt; Maybe HashMismatch
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Hash -&gt; Hash -&gt; HashMismatch
</span><span class="hs-identifier hs-var">HashMismatch</span></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679095118"><span class="hs-identifier hs-var">hash</span></a></span><span> </span><span class="annot"><span class="annottext">Hash
</span><a href="#local-6989586621679095144"><span class="hs-identifier hs-var">hash'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-43"></span><span>    </span><span id="local-6989586621679094998"><span id="local-6989586621679094999"><span id="local-6989586621679095000"><span id="local-6989586621679095001"><span id="local-6989586621679095002"><span id="local-6989586621679095003"><span class="annot"><a href="#local-6989586621679095129"><span class="hs-identifier hs-type">mapTermV</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-44"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ABT.Term</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Term.F'</span></span><span> </span><span class="annot"><a href="#local-6989586621679094998"><span class="hs-identifier hs-type">text'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679094999"><span class="hs-identifier hs-type">termRef'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679095000"><span class="hs-identifier hs-type">typeRef'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679095001"><span class="hs-identifier hs-type">termLink'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679095002"><span class="hs-identifier hs-type">typeLink'</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Symbol</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Symbol</span></span><span> </span><span class="annot"><a href="#local-6989586621679095003"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-45"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">ABT.Term</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Term.F'</span></span><span> </span><span class="annot"><a href="#local-6989586621679094998"><span class="hs-identifier hs-type">text'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679094999"><span class="hs-identifier hs-type">termRef'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679095000"><span class="hs-identifier hs-type">typeRef'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679095001"><span class="hs-identifier hs-type">termLink'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679095002"><span class="hs-identifier hs-type">typeLink'</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Unison.Symbol</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Unison.Symbol</span></span><span> </span><span class="annot"><a href="#local-6989586621679095003"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span></span></span><span>
</span><span id="line-46"></span><span>    </span><span id="local-6989586621679095129"><span class="annot"><span class="annottext">mapTermV :: forall text' termRef' typeRef' termLink' typeLink' a.
Term
  (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a
-&gt; Term
     (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a
</span><a href="#local-6989586621679095129"><span class="hs-identifier hs-var hs-var">mapTermV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-47"></span><span>      </span><span class="annot"><span class="annottext">(text' -&gt; text')
-&gt; (termRef' -&gt; termRef')
-&gt; (typeRef' -&gt; typeRef')
-&gt; (termLink' -&gt; termLink')
-&gt; (typeLink' -&gt; typeLink')
-&gt; (Symbol -&gt; Symbol)
-&gt; Term
     (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a
-&gt; Term
     (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a
forall text termRef typeRef termLink typeLink vt text' termRef'
       typeRef' termLink' typeLink' vt' v a.
(Ord v, Ord vt') =&gt;
(text -&gt; text')
-&gt; (termRef -&gt; termRef')
-&gt; (typeRef -&gt; typeRef')
-&gt; (termLink -&gt; termLink')
-&gt; (typeLink -&gt; typeLink')
-&gt; (vt -&gt; vt')
-&gt; Term (F' text termRef typeRef termLink typeLink vt) v a
-&gt; Term (F' text' termRef' typeRef' termLink' typeLink' vt') v a
</span><span class="hs-identifier hs-var">C.Term.extraMap</span></span><span> </span><span class="annot"><span class="annottext">text' -&gt; text'
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">termRef' -&gt; termRef'
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">typeRef' -&gt; typeRef'
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">termLink' -&gt; termLink'
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">typeLink' -&gt; typeLink'
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Symbol
</span><a href="#local-6989586621679095161"><span class="hs-identifier hs-var">symbol2to1</span></a></span><span>
</span><span id="line-48"></span><span>        </span><span class="annot"><span class="annottext">(Term
   (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a
 -&gt; Term
      (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a)
-&gt; (Term
      (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a
    -&gt; Term
         (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a)
-&gt; Term
     (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a
-&gt; Term
     (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a
forall {k} (cat :: k -&gt; k -&gt; *) (a :: k) (b :: k) (c :: k).
Category cat =&gt;
cat a b -&gt; cat b c -&gt; cat a c
</span><span class="hs-operator hs-var">&gt;&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Symbol -&gt; Symbol)
-&gt; Term
     (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a
-&gt; Term
     (F' text' termRef' typeRef' termLink' typeLink' Symbol) Symbol a
forall (f :: * -&gt; *) v' v a.
(Functor f, Foldable f, Ord v') =&gt;
(v -&gt; v') -&gt; Term f v a -&gt; Term f v' a
</span><span class="hs-identifier hs-var">ABT.vmap</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Symbol
</span><a href="#local-6989586621679095161"><span class="hs-identifier hs-var">symbol2to1</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span id="local-6989586621679095004"><span class="annot"><a href="#local-6989586621679095130"><span class="hs-identifier hs-type">mapTypeV</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ABT.Term</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type.F'</span></span><span> </span><span class="annot"><a href="#local-6989586621679095004"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Symbol</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ABT.Term</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Type.F'</span></span><span> </span><span class="annot"><a href="#local-6989586621679095004"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Unison.Symbol</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-50"></span><span>    </span><span id="local-6989586621679095130"><span class="annot"><span class="annottext">mapTypeV :: forall r. Term (F' r) Symbol () -&gt; Term (F' r) Symbol ()
</span><a href="#local-6989586621679095130"><span class="hs-identifier hs-var hs-var">mapTypeV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Symbol -&gt; Symbol)
-&gt; Term (F' r) Symbol () -&gt; Term (F' r) Symbol ()
forall (f :: * -&gt; *) v' v a.
(Functor f, Foldable f, Ord v') =&gt;
(v -&gt; v') -&gt; Term f v a -&gt; Term f v' a
</span><span class="hs-identifier hs-var">ABT.vmap</span></span><span> </span><span class="annot"><span class="annottext">Symbol -&gt; Symbol
</span><a href="#local-6989586621679095161"><span class="hs-identifier hs-var">symbol2to1</span></a></span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><a href="#local-6989586621679095161"><span class="hs-identifier hs-type">symbol2to1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Symbol</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Unison.Symbol</span></span><span>
</span><span id="line-52"></span><span>    </span><span id="local-6989586621679095161"><span class="annot"><span class="annottext">symbol2to1 :: Symbol -&gt; Symbol
</span><a href="#local-6989586621679095161"><span class="hs-identifier hs-var hs-var">symbol2to1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Symbol</span></span><span> </span><span id="local-6989586621679095170"><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679095170"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621679095171"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679095171"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pos -&gt; Type -&gt; Symbol
</span><span class="hs-identifier hs-var">Unison.Symbol</span></span><span> </span><span class="annot"><span class="annottext">Pos
</span><a href="#local-6989586621679095170"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; Type
</span><span class="hs-identifier hs-var">Var.User</span></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679095171"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="annot"><a href="U.Codebase.Term.Hashing.html#s2cTermWithType"><span class="hs-identifier hs-type">s2cTermWithType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">LocalIds.LocalIds'</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Hash32</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Term.Term</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Term.Type</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">C.Term</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Symbol</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">C.Term.Type</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Symbol</span></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span id="s2cTermWithType"><span class="annot"><span class="annottext">s2cTermWithType :: (LocalIds' Text Hash32, Term, Type) -&gt; (Term Symbol, Type Symbol)
</span><a href="U.Codebase.Term.Hashing.html#s2cTermWithType"><span class="hs-identifier hs-var hs-var">s2cTermWithType</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679095174"><span class="annot"><span class="annottext">LocalIds' Text Hash32
</span><a href="#local-6989586621679095174"><span class="hs-identifier hs-var">ids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679095175"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621679095175"><span class="hs-identifier hs-var">tm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679095176"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679095176"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Identity</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679095184"><span class="annot"><span class="annottext">LocalTextId -&gt; Text
</span><a href="#local-6989586621679095184"><span class="hs-identifier hs-var">substText</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679095185"><span class="annot"><span class="annottext">LocalDefnId -&gt; Hash
</span><a href="#local-6989586621679095185"><span class="hs-identifier hs-var">substHash</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Identity Text)
-&gt; (Hash -&gt; Identity Hash)
-&gt; LocalIds' Text Hash
-&gt; Identity (LocalTextId -&gt; Text, LocalDefnId -&gt; Hash)
forall (m :: * -&gt; *) t d.
Monad m =&gt;
(t -&gt; m Text)
-&gt; (d -&gt; m Hash)
-&gt; LocalIds' t d
-&gt; m (LocalTextId -&gt; Text, LocalDefnId -&gt; Hash)
</span><span class="hs-identifier hs-var">Q.localIdsToLookups</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Identity Text
forall a. a -&gt; Identity a
</span><span class="hs-identifier hs-var">Identity</span></span><span> </span><span class="annot"><span class="annottext">Hash -&gt; Identity Hash
forall a. a -&gt; Identity a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Text -&gt; Text)
-&gt; (Hash32 -&gt; Hash) -&gt; LocalIds' Text Hash32 -&gt; LocalIds' Text Hash
forall a b c d.
(a -&gt; b) -&gt; (c -&gt; d) -&gt; LocalIds' a c -&gt; LocalIds' b d
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">Hash32 -&gt; Hash
</span><span class="hs-identifier hs-var">Hash32.toHash</span></span><span> </span><span class="annot"><span class="annottext">LocalIds' Text Hash32
</span><a href="#local-6989586621679095174"><span class="hs-identifier hs-var">ids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LocalTextId -&gt; Text)
-&gt; (LocalDefnId -&gt; Hash) -&gt; Term -&gt; Term Symbol
</span><span class="hs-identifier hs-var">Q.x2cTerm</span></span><span> </span><span class="annot"><span class="annottext">LocalTextId -&gt; Text
</span><a href="#local-6989586621679095184"><span class="hs-identifier hs-var">substText</span></a></span><span> </span><span class="annot"><span class="annottext">LocalDefnId -&gt; Hash
</span><a href="#local-6989586621679095185"><span class="hs-identifier hs-var">substHash</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621679095175"><span class="hs-identifier hs-var">tm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(LocalTextId -&gt; Text)
-&gt; (LocalDefnId -&gt; Hash) -&gt; Type -&gt; Type Symbol
</span><span class="hs-identifier hs-var">Q.x2cTType</span></span><span> </span><span class="annot"><span class="annottext">LocalTextId -&gt; Text
</span><a href="#local-6989586621679095184"><span class="hs-identifier hs-var">substText</span></a></span><span> </span><span class="annot"><span class="annottext">LocalDefnId -&gt; Hash
</span><a href="#local-6989586621679095185"><span class="hs-identifier hs-var">substHash</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621679095176"><span class="hs-identifier hs-var">tp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span></pre></body></html>