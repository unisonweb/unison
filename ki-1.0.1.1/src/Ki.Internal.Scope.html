<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Ki.Internal.Scope</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier">Scope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="Ki.Internal.Scope.html#scoped"><span class="hs-identifier">scoped</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-4"></span><span>    </span><span class="annot"><a href="Ki.Internal.Scope.html#awaitAll"><span class="hs-identifier">awaitAll</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-5"></span><span>    </span><span class="annot"><a href="Ki.Internal.Scope.html#fork"><span class="hs-identifier">fork</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-6"></span><span>    </span><span class="annot"><a href="Ki.Internal.Scope.html#forkWith"><span class="hs-identifier">forkWith</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Ki.Internal.Scope.html#forkWith_"><span class="hs-identifier">forkWith_</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Ki.Internal.Scope.html#fork_"><span class="hs-identifier">fork_</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Ki.Internal.Scope.html#forkTry"><span class="hs-identifier">forkTry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Ki.Internal.Scope.html#forkTryWith"><span class="hs-identifier">forkTryWith</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">where</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">ThreadId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">myThreadId</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">throwTo</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Concurrent.MVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">MVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">newEmptyMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">tryPutMVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">tryTakeMVar</span></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Exception</span></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">Exception</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">fromException</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">toException</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><span class="hs-identifier">MaskingState</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><span class="hs-identifier">SomeException</span></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><span class="hs-identifier">assert</span></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><span class="hs-identifier">asyncExceptionFromException</span></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><span class="hs-identifier">asyncExceptionToException</span></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><span class="hs-identifier">throwIO</span></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><span class="hs-identifier">try</span></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><span class="hs-identifier">uninterruptibleMask</span></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-keyword">pattern</span><span> </span><span class="annot"><span class="hs-identifier">ErrorCall</span></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">guard</span></span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">for_</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Functor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">void</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IntMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IntMap</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.IntMap.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IntMap.Lazy</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Void</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Void</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">absurd</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Conc</span></span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><span class="hs-identifier">TVar</span></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><span class="hs-identifier">atomically</span></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="hs-identifier">enableAllocationLimit</span></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><span class="hs-identifier">labelThread</span></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><span class="hs-identifier">newTVarIO</span></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><span class="hs-identifier">readTVar</span></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><span class="hs-identifier">retry</span></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><span class="hs-identifier">setAllocationCounter</span></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="hs-identifier">throwSTM</span></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><span class="hs-identifier">writeTVar</span></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Conc.Sync</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">readTVarIO</span></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafeUnmask</span></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Ki.Internal.ByteCount.html"><span class="hs-identifier">Ki.Internal.ByteCount</span></a></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Ki.Internal.Counter.html"><span class="hs-identifier">Ki.Internal.Counter</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Ki.Internal.IO.html"><span class="hs-identifier">Ki.Internal.IO</span></a></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Ki.Internal.IO.html#IOResult"><span class="hs-identifier">IOResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>    </span><span class="annot"><a href="Ki.Internal.IO.html#UnexceptionalIO"><span class="hs-identifier">UnexceptionalIO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-54"></span><span>    </span><span class="annot"><a href="Ki.Internal.IO.html#interruptiblyMasked"><span class="hs-identifier">interruptiblyMasked</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><a href="Ki.Internal.IO.html#isAsyncException"><span class="hs-identifier">isAsyncException</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><a href="Ki.Internal.IO.html#unexceptionalTry"><span class="hs-identifier">unexceptionalTry</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><a href="Ki.Internal.IO.html#unexceptionalTryEither"><span class="hs-identifier">unexceptionalTryEither</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><a href="Ki.Internal.IO.html#uninterruptiblyMasked"><span class="hs-identifier">uninterruptiblyMasked</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Ki.Internal.Thread.html"><span class="hs-identifier">Ki.Internal.Thread</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isJust</span></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-comment">-- | A scope.</span><span>
</span><span id="line-64"></span><span class="hs-comment">--</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- ==== __&#128073; Details__</span><span>
</span><span id="line-66"></span><span class="hs-comment">--</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- * A scope delimits the lifetime of all threads created within it.</span><span>
</span><span id="line-68"></span><span class="hs-comment">--</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- * A scope is only valid during the callback provided to 'Ki.scoped'.</span><span>
</span><span id="line-70"></span><span class="hs-comment">--</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- * The thread that creates a scope is considered the parent of all threads created within it.</span><span>
</span><span id="line-72"></span><span class="hs-comment">--</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- * All threads created within a scope can be awaited together (see 'Ki.awaitAll').</span><span>
</span><span id="line-74"></span><span class="hs-comment">--</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- * All threads created within a scope are terminated when the scope closes.</span><span>
</span><span id="line-76"></span><span class="hs-keyword">data</span><span> </span><span id="Scope"><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Scope"><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span></span><span>
</span><span id="line-77"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- The MVar that a child tries to put to, in the case that it tries to propagate an exception to its parent, but</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-comment">-- gets delivered an exception from its parent concurrently (which interrupts the throw). The parent must raise</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- exceptions in its children with asynchronous exceptions uninterruptibly masked for correctness, yet we don't want</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-comment">-- a parent in the process of tearing down to miss/ignore this exception that we're trying to propagate?</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-comment">-- Why a single-celled MVar? What if two siblings are fighting to inform their parent of their death? Well, only</span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-comment">-- one exception can be propagated by the parent anyway, so we wouldn't need or want both.</span><span>
</span><span id="line-84"></span><span>    </span><span id="%24sel%3AchildExceptionVar%3AScope"><span class="annot"><span class="annottext">Scope -&gt; MVar SomeException
</span><a href="Ki.Internal.Scope.html#%24sel%3AchildExceptionVar%3AScope"><span class="hs-identifier hs-var hs-var">childExceptionVar</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MVar</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-comment">-- The set of child threads that are currently running, each keyed by a monotonically increasing int.</span><span>
</span><span id="line-86"></span><span>    </span><span id="%24sel%3AchildrenVar%3AScope"><span class="annot"><span class="annottext">Scope -&gt; TVar (IntMap ThreadId)
</span><a href="Ki.Internal.Scope.html#%24sel%3AchildrenVar%3AScope"><span class="hs-identifier hs-var hs-var">childrenVar</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IntMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-87"></span><span>    </span><span class="hs-comment">-- The counter that holds the (int) key to use for the next child thread.</span><span>
</span><span id="line-88"></span><span>    </span><span id="%24sel%3AnextChildIdCounter%3AScope"><span class="annot"><span class="annottext">Scope -&gt; Counter
</span><a href="Ki.Internal.Scope.html#%24sel%3AnextChildIdCounter%3AScope"><span class="hs-identifier hs-var hs-var">nextChildIdCounter</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="Ki.Internal.Counter.html#Counter"><span class="hs-identifier hs-type">Counter</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-comment">-- The id of the thread that created the scope, which is considered the parent of all threads created within it.</span><span>
</span><span id="line-90"></span><span>    </span><span id="%24sel%3AparentThreadId%3AScope"><span class="annot"><span class="annottext">Scope -&gt; ThreadId
</span><a href="Ki.Internal.Scope.html#%24sel%3AparentThreadId%3AScope"><span class="hs-identifier hs-var hs-var">parentThreadId</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span class="hs-special">,</span><span>
</span><span id="line-91"></span><span>    </span><span id="%24sel%3AstatusVar%3AScope"><span class="annot"><span class="annottext">Scope -&gt; TVar ScopeStatus
</span><a href="Ki.Internal.Scope.html#%24sel%3AstatusVar%3AScope"><span class="hs-identifier hs-var hs-var">statusVar</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-pragma">{-# UNPACK</span><span> </span><span class="hs-pragma">#-}</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#ScopeStatus"><span class="hs-identifier hs-type">ScopeStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="hs-comment">-- The scope status: either open (allowing new threads to be created), closing (disallowing new threads to be</span><span>
</span><span id="line-95"></span><span class="hs-comment">-- created, and in the process of killing living children), or closed (at the very end of `scoped`)</span><span>
</span><span id="line-96"></span><span class="hs-keyword">type</span><span> </span><span id="ScopeStatus"><span class="annot"><a href="Ki.Internal.Scope.html#ScopeStatus"><span class="hs-identifier hs-var">ScopeStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-comment">-- The number of child threads that are guaranteed to be about to start, in the sense that only the GHC scheduler</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- can continue to delay; there's no opportunity for an async exception to strike and prevent one of these threads</span><span>
</span><span id="line-100"></span><span class="hs-comment">-- from starting.</span><span>
</span><span id="line-101"></span><span class="hs-keyword">pattern</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Open"><span class="hs-identifier hs-type">Open</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-102"></span><span class="hs-keyword">pattern</span><span> </span><span id="Open"><span id="%24mOpen"><span class="annot"><span class="annottext">$mOpen :: forall {r}. ScopeStatus -&gt; ((# #) -&gt; r) -&gt; ((# #) -&gt; r) -&gt; r
</span><a href="Ki.Internal.Scope.html#Open"><span class="hs-identifier hs-var hs-var">Open</span></a></span></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">&gt;=</span></span><span> </span><span class="annot"><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="hs-comment">-- The scope is closing.</span><span>
</span><span id="line-105"></span><span class="hs-keyword">pattern</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Closing"><span class="hs-identifier hs-type">Closing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-106"></span><span class="hs-keyword">pattern</span><span> </span><span id="Closing"><span id="%24mClosing"><span id="%24bClosing"><span class="annot"><span class="annottext">$mClosing :: forall {r}. ScopeStatus -&gt; ((# #) -&gt; r) -&gt; ((# #) -&gt; r) -&gt; r
$bClosing :: ScopeStatus
</span><a href="Ki.Internal.Scope.html#Closing"><span class="hs-identifier hs-var hs-var hs-var">Closing</span></a></span></span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">-</span><span class="hs-number">1</span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-comment">-- The scope is closed.</span><span>
</span><span id="line-109"></span><span class="hs-keyword">pattern</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Closed"><span class="hs-identifier hs-type">Closed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-110"></span><span class="hs-keyword">pattern</span><span> </span><span id="Closed"><span id="%24mClosed"><span id="%24bClosed"><span class="annot"><span class="annottext">$mClosed :: forall {r}. ScopeStatus -&gt; ((# #) -&gt; r) -&gt; ((# #) -&gt; r) -&gt; r
$bClosed :: ScopeStatus
</span><a href="Ki.Internal.Scope.html#Closed"><span class="hs-identifier hs-var hs-var hs-var">Closed</span></a></span></span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">-</span><span class="hs-number">2</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span class="hs-pragma">{-# COMPLETE</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Open"><span class="hs-pragma hs-type">Open</span></a></span><span class="hs-pragma">,</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Closing"><span class="hs-pragma hs-type">Closing</span></a></span><span class="hs-pragma">,</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Closed"><span class="hs-pragma hs-type">Closed</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="hs-comment">-- Internal async exception thrown by a parent thread to its children when the scope is closing.</span><span>
</span><span id="line-115"></span><span class="hs-keyword">data</span><span> </span><span id="ScopeClosing"><span class="annot"><a href="Ki.Internal.Scope.html#ScopeClosing"><span class="hs-identifier hs-var">ScopeClosing</span></a></span></span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="ScopeClosing"><span class="annot"><a href="Ki.Internal.Scope.html#ScopeClosing"><span class="hs-identifier hs-var">ScopeClosing</span></a></span></span><span>
</span><span id="line-117"></span><span>
</span><span id="line-118"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679043209"><span id="local-6989586621679043214"><span class="annot"><span class="hs-identifier hs-type">Show</span></span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#ScopeClosing"><span class="hs-identifier hs-type">ScopeClosing</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-119"></span><span>  </span><span id="local-6989586621679043217"><span class="annot"><span class="annottext">show :: ScopeClosing -&gt; String
</span><a href="#local-6989586621679043217"><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="annot"><span class="annottext">ScopeClosing
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ScopeClosing&quot;</span></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679043226"><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#ScopeClosing"><span class="hs-identifier hs-type">ScopeClosing</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-122"></span><span>  </span><span id="local-6989586621679043230"><span class="annot"><span class="annottext">toException :: ScopeClosing -&gt; SomeException
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">toException</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScopeClosing -&gt; SomeException
forall e. Exception e =&gt; e -&gt; SomeException
</span><span class="hs-identifier hs-var">asyncExceptionToException</span></span><span>
</span><span id="line-123"></span><span>  </span><span id="local-6989586621679043232"><span class="annot"><span class="annottext">fromException :: SomeException -&gt; Maybe ScopeClosing
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">fromException</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Maybe ScopeClosing
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">asyncExceptionFromException</span></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span class="hs-comment">-- Trust without verifying that any 'ScopeClosed' exception, which is not exported by this module, was indeed thrown to</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- a thread by its parent. It is possible to write a program that violates this (just catch the async exception and</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- throw it to some other thread)... but who would do that?</span><span>
</span><span id="line-128"></span><span class="annot"><a href="Ki.Internal.Scope.html#isScopeClosingException"><span class="hs-identifier hs-type">isScopeClosingException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-129"></span><span id="isScopeClosingException"><span class="annot"><span class="annottext">isScopeClosingException :: SomeException -&gt; Bool
</span><a href="Ki.Internal.Scope.html#isScopeClosingException"><span class="hs-identifier hs-var hs-var">isScopeClosingException</span></a></span></span><span> </span><span id="local-6989586621679043234"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043234"><span class="hs-identifier hs-var">exception</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-130"></span><span>  </span><span class="annot"><span class="annottext">Maybe ScopeClosing -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">fromException</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Ki.Internal.Scope.html#ScopeClosing"><span class="hs-identifier hs-type">ScopeClosing</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043234"><span class="hs-identifier hs-var">exception</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span class="hs-keyword">pattern</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#IsScopeClosingException"><span class="hs-identifier hs-type">IsScopeClosingException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span>
</span><span id="line-133"></span><span class="hs-keyword">pattern</span><span> </span><span id="IsScopeClosingException"><span id="%24mIsScopeClosingException"><span class="annot"><span class="annottext">$mIsScopeClosingException :: forall {r}. SomeException -&gt; ((# #) -&gt; r) -&gt; ((# #) -&gt; r) -&gt; r
</span><a href="Ki.Internal.Scope.html#IsScopeClosingException"><span class="hs-identifier hs-var hs-var">IsScopeClosingException</span></a></span></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ki.Internal.Scope.html#isScopeClosingException"><span class="hs-identifier hs-type">isScopeClosingException</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span class="hs-comment">-- | Open a scope, perform an IO action with it, then close the scope.</span><span>
</span><span id="line-136"></span><span class="hs-comment">--</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- ==== __&#128073; Details__</span><span>
</span><span id="line-138"></span><span class="hs-comment">--</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- * The thread that creates a scope is considered the parent of all threads created within it.</span><span>
</span><span id="line-140"></span><span class="hs-comment">--</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- * A scope is only valid during the callback provided to 'Ki.scoped'.</span><span>
</span><span id="line-142"></span><span class="hs-comment">--</span><span>
</span><span id="line-143"></span><span class="hs-comment">-- * When a scope closes (/i.e./ just before 'Ki.scoped' returns):</span><span>
</span><span id="line-144"></span><span class="hs-comment">--</span><span>
</span><span id="line-145"></span><span class="hs-comment">--     * The parent thread raises an exception in all of its living children.</span><span>
</span><span id="line-146"></span><span class="hs-comment">--     * The parent thread blocks until those threads terminate.</span><span>
</span><span id="line-147"></span><span id="local-6989586621679042984"><span class="annot"><a href="Ki.Internal.Scope.html#scoped"><span class="hs-identifier hs-type">scoped</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679042984"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679042984"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-148"></span><span id="scoped"><span class="annot"><span class="annottext">scoped :: forall a. (Scope -&gt; IO a) -&gt; IO a
</span><a href="Ki.Internal.Scope.html#scoped"><span class="hs-identifier hs-var hs-var">scoped</span></a></span></span><span> </span><span id="local-6989586621679043265"><span class="annot"><span class="annottext">Scope -&gt; IO a
</span><a href="#local-6989586621679043265"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-149"></span><span>  </span><span id="local-6989586621679043266"><span class="annot"><span class="annottext">scope :: Scope
</span><a href="#local-6989586621679043266"><span class="hs-identifier hs-var">scope</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679043267"><span class="annot"><span class="annottext">MVar SomeException
$sel:childExceptionVar:Scope :: Scope -&gt; MVar SomeException
childExceptionVar :: MVar SomeException
</span><a href="Ki.Internal.Scope.html#%24sel%3AchildExceptionVar%3AScope"><span class="hs-identifier hs-var hs-var">childExceptionVar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679043268"><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
$sel:childrenVar:Scope :: Scope -&gt; TVar (IntMap ThreadId)
childrenVar :: TVar (IntMap ThreadId)
</span><a href="Ki.Internal.Scope.html#%24sel%3AchildrenVar%3AScope"><span class="hs-identifier hs-var hs-var">childrenVar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679043269"><span class="annot"><span class="annottext">TVar ScopeStatus
$sel:statusVar:Scope :: Scope -&gt; TVar ScopeStatus
statusVar :: TVar ScopeStatus
</span><a href="Ki.Internal.Scope.html#%24sel%3AstatusVar%3AScope"><span class="hs-identifier hs-var hs-var">statusVar</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Scope
</span><a href="Ki.Internal.Scope.html#allocateScope"><span class="hs-identifier hs-var">allocateScope</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span>  </span><span class="annot"><span class="annottext">((forall a. IO a -&gt; IO a) -&gt; IO a) -&gt; IO a
forall b. ((forall a. IO a -&gt; IO a) -&gt; IO b) -&gt; IO b
</span><span class="hs-identifier hs-var">uninterruptibleMask</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679043271"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679043271"><span class="hs-identifier hs-var">restore</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-152"></span><span>    </span><span id="local-6989586621679043272"><span class="annot"><span class="annottext">Either SomeException a
</span><a href="#local-6989586621679043272"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO (Either SomeException a)
forall e a. Exception e =&gt; IO a -&gt; IO (Either e a)
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679043271"><span class="hs-identifier hs-var">restore</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; IO a
</span><a href="#local-6989586621679043265"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043266"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679043273"><span class="annot"><span class="annottext">IntMap ThreadId
</span><a href="#local-6989586621679043273"><span class="hs-identifier hs-var">livingChildren</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-155"></span><span>      </span><span id="local-6989586621679043274"><span class="annot"><span class="annottext">IntMap ThreadId
</span><a href="#local-6989586621679043274"><span class="hs-identifier hs-var">livingChildren0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-156"></span><span>        </span><span class="annot"><span class="annottext">STM (IntMap ThreadId) -&gt; IO (IntMap ThreadId)
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-157"></span><span>          </span><span class="hs-comment">-- Block until we haven't committed to starting any threads. Without this, we may create a thread concurrently</span><span>
</span><span id="line-158"></span><span>          </span><span class="hs-comment">-- with closing its scope, and not grab its thread id to throw an exception to.</span><span>
</span><span id="line-159"></span><span>          </span><span id="local-6989586621679043275"><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043275"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus -&gt; STM ScopeStatus
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus
</span><a href="#local-6989586621679043269"><span class="hs-identifier hs-var">statusVar</span></a></span><span>
</span><span id="line-160"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; STM () -&gt; STM ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043275"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus -&gt; ScopeStatus -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; STM ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043275"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus -&gt; ScopeStatus -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>          </span><span class="hs-comment">-- Indicate that this scope is closing, so attempts to create a new thread within it will throw ScopeClosing</span><span>
</span><span id="line-162"></span><span>          </span><span class="hs-comment">-- (as if the calling thread was a parent of this scope, which it should be, and we threw it a ScopeClosing</span><span>
</span><span id="line-163"></span><span>          </span><span class="hs-comment">-- ourselves).</span><span>
</span><span id="line-164"></span><span>          </span><span class="annot"><span class="annottext">TVar ScopeStatus -&gt; ScopeStatus -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus
</span><a href="#local-6989586621679043269"><span class="hs-identifier hs-var">statusVar</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="Ki.Internal.Scope.html#Closing"><span class="hs-identifier hs-var">Closing</span></a></span><span>
</span><span id="line-165"></span><span>          </span><span class="hs-comment">-- Return the list of currently-running children to kill. Some of them may have *just* started (e.g. if we</span><span>
</span><span id="line-166"></span><span>          </span><span class="hs-comment">-- initially retried in `guard (n == 0)` above). That's fine - kill them all!</span><span>
</span><span id="line-167"></span><span>          </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId) -&gt; STM (IntMap ThreadId)
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
</span><a href="#local-6989586621679043268"><span class="hs-identifier hs-var">childrenVar</span></a></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>      </span><span class="hs-comment">-- If one of our children propagated an exception to us, then we know it's about to terminate, so we don't bother</span><span>
</span><span id="line-170"></span><span>      </span><span class="hs-comment">-- throwing an exception to it.</span><span>
</span><span id="line-171"></span><span>      </span><span class="annot"><span class="annottext">IntMap ThreadId -&gt; IO (IntMap ThreadId)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either SomeException a
</span><a href="#local-6989586621679043272"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-172"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; Maybe ThreadFailed
forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">fromException</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><a href="Ki.Internal.Thread.html#ThreadFailed"><span class="hs-identifier hs-type">ThreadFailed</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679043277"><span class="annot"><span class="annottext">ScopeStatus
childId :: ScopeStatus
$sel:childId:ThreadFailed :: ThreadFailed -&gt; ScopeStatus
</span><a href="#local-6989586621679043277"><span class="hs-identifier hs-var hs-var">childId</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScopeStatus -&gt; IntMap ThreadId -&gt; IntMap ThreadId
forall a. ScopeStatus -&gt; IntMap a -&gt; IntMap a
</span><span class="hs-identifier hs-var">IntMap.Lazy.delete</span></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043277"><span class="hs-identifier hs-var">childId</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap ThreadId
</span><a href="#local-6989586621679043274"><span class="hs-identifier hs-var">livingChildren0</span></a></span><span>
</span><span id="line-173"></span><span>        </span><span class="annot"><span class="annottext">Either SomeException a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IntMap ThreadId
</span><a href="#local-6989586621679043274"><span class="hs-identifier hs-var">livingChildren0</span></a></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-comment">-- Deliver a ScopeClosing exception to every living child.</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-comment">-- This happens to throw in the order the children were created... but I think we decided this feature isn't very</span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-comment">-- useful in practice, so maybe we should simplify the internals and just keep a set of children?</span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><span class="annottext">[ThreadId] -&gt; (ThreadId -&gt; IO ()) -&gt; IO ()
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Foldable t, Applicative f) =&gt;
t a -&gt; (a -&gt; f b) -&gt; f ()
</span><span class="hs-identifier hs-var">for_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntMap ThreadId -&gt; [ThreadId]
forall a. IntMap a -&gt; [a]
</span><span class="hs-identifier hs-var">IntMap.Lazy.elems</span></span><span> </span><span class="annot"><span class="annottext">IntMap ThreadId
</span><a href="#local-6989586621679043273"><span class="hs-identifier hs-var">livingChildren</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679043281"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043281"><span class="hs-identifier hs-var">livingChild</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ThreadId -&gt; ScopeClosing -&gt; IO ()
forall e. Exception e =&gt; ThreadId -&gt; e -&gt; IO ()
</span><span class="hs-identifier hs-var">throwTo</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043281"><span class="hs-identifier hs-var">livingChild</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeClosing
</span><a href="Ki.Internal.Scope.html#ScopeClosing"><span class="hs-identifier hs-var">ScopeClosing</span></a></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-182"></span><span>      </span><span class="hs-comment">-- Block until all children have terminated; this relies on children respecting the async exception, which they</span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-comment">-- must, for correctness. Otherwise, a thread could indeed outlive the scope in which it's created, which is</span><span>
</span><span id="line-184"></span><span>      </span><span class="hs-comment">-- definitely not structured concurrency!</span><span>
</span><span id="line-185"></span><span>      </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId) -&gt; STM ()
forall a. TVar (IntMap a) -&gt; STM ()
</span><a href="Ki.Internal.Scope.html#blockUntilEmpty"><span class="hs-identifier hs-var">blockUntilEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
</span><a href="#local-6989586621679043268"><span class="hs-identifier hs-var">childrenVar</span></a></span><span>
</span><span id="line-186"></span><span>      </span><span class="hs-comment">-- Record the scope as closed (from closing), so subsequent attempts to use it will throw a runtime exception</span><span>
</span><span id="line-187"></span><span>      </span><span class="annot"><span class="annottext">TVar ScopeStatus -&gt; ScopeStatus -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus
</span><a href="#local-6989586621679043269"><span class="hs-identifier hs-var">statusVar</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="Ki.Internal.Scope.html#Closed"><span class="hs-identifier hs-var">Closed</span></a></span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-comment">-- By now there are three sources of exception:</span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-191"></span><span>    </span><span class="hs-comment">--   1) A sync or async exception thrown during the callback, captured in `result`. If applicable, we want to unwrap</span><span>
</span><span id="line-192"></span><span>    </span><span class="hs-comment">--      the `ThreadFailed` off of this, which was only used to indicate it came from one of our children.</span><span>
</span><span id="line-193"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-comment">--   2) A sync or async exception left for us in `childExceptionVar` by a child that tried to propagate it to us</span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-comment">--      directly, but failed (because we killed it concurrently).</span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-comment">--   3) An async exception waiting in our exception queue, because we still have async exceptions uninterruptibly</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-comment">--      masked.</span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-comment">-- We cannot throw more than one, so throw them in that priority order.</span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either SomeException a
</span><a href="#local-6989586621679043272"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-202"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621679043283"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043283"><span class="hs-identifier hs-var">exception</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; IO a
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; SomeException
</span><a href="Ki.Internal.Thread.html#unwrapThreadFailed"><span class="hs-identifier hs-var">unwrapThreadFailed</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043283"><span class="hs-identifier hs-var">exception</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679043285"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679043285"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-204"></span><span>        </span><span class="annot"><span class="annottext">MVar SomeException -&gt; IO (Maybe SomeException)
forall a. MVar a -&gt; IO (Maybe a)
</span><span class="hs-identifier hs-var">tryTakeMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar SomeException
</span><a href="#local-6989586621679043267"><span class="hs-identifier hs-var">childExceptionVar</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Maybe SomeException) -&gt; (Maybe SomeException -&gt; IO a) -&gt; IO a
forall a b. IO a -&gt; (a -&gt; IO b) -&gt; IO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-205"></span><span>          </span><span class="annot"><span class="annottext">Maybe SomeException
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; IO a
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679043285"><span class="hs-identifier hs-var">value</span></a></span><span>
</span><span id="line-206"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679043286"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043286"><span class="hs-identifier hs-var">exception</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; IO a
forall e a. Exception e =&gt; e -&gt; IO a
</span><span class="hs-identifier hs-var">throwIO</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043286"><span class="hs-identifier hs-var">exception</span></a></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="hs-comment">-- Allocate a new scope.</span><span>
</span><span id="line-209"></span><span class="annot"><a href="Ki.Internal.Scope.html#allocateScope"><span class="hs-identifier hs-type">allocateScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span>
</span><span id="line-210"></span><span id="allocateScope"><span class="annot"><span class="annottext">allocateScope :: IO Scope
</span><a href="Ki.Internal.Scope.html#allocateScope"><span class="hs-identifier hs-var hs-var">allocateScope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-211"></span><span>  </span><span id="local-6989586621679043287"><span class="annot"><span class="annottext">MVar SomeException
</span><a href="#local-6989586621679043287"><span class="hs-identifier hs-var">childExceptionVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (MVar SomeException)
forall a. IO (MVar a)
</span><span class="hs-identifier hs-var">newEmptyMVar</span></span><span>
</span><span id="line-212"></span><span>  </span><span id="local-6989586621679043288"><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
</span><a href="#local-6989586621679043288"><span class="hs-identifier hs-var">childrenVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IntMap ThreadId -&gt; IO (TVar (IntMap ThreadId))
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">IntMap ThreadId
forall a. IntMap a
</span><span class="hs-identifier hs-var">IntMap.Lazy.empty</span></span><span>
</span><span id="line-213"></span><span>  </span><span id="local-6989586621679043290"><span class="annot"><span class="annottext">Counter
</span><a href="#local-6989586621679043290"><span class="hs-identifier hs-var">nextChildIdCounter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Counter
</span><a href="Ki.Internal.Counter.html#newCounter"><span class="hs-identifier hs-var">newCounter</span></a></span><span>
</span><span id="line-214"></span><span>  </span><span id="local-6989586621679043292"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043292"><span class="hs-identifier hs-var">parentThreadId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-215"></span><span>  </span><span id="local-6989586621679043293"><span class="annot"><span class="annottext">TVar ScopeStatus
</span><a href="#local-6989586621679043293"><span class="hs-identifier hs-var">statusVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScopeStatus -&gt; IO (TVar ScopeStatus)
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><span class="hs-number">0</span></span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><span class="annottext">Scope -&gt; IO Scope
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">MVar SomeException
$sel:childExceptionVar:Scope :: MVar SomeException
childExceptionVar :: MVar SomeException
</span><a href="Ki.Internal.Scope.html#%24sel%3AchildExceptionVar%3AScope"><span class="hs-identifier hs-var hs-var">childExceptionVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
$sel:childrenVar:Scope :: TVar (IntMap ThreadId)
childrenVar :: TVar (IntMap ThreadId)
</span><a href="Ki.Internal.Scope.html#%24sel%3AchildrenVar%3AScope"><span class="hs-identifier hs-var hs-var">childrenVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Counter
$sel:nextChildIdCounter:Scope :: Counter
nextChildIdCounter :: Counter
</span><a href="Ki.Internal.Scope.html#%24sel%3AnextChildIdCounter%3AScope"><span class="hs-identifier hs-var hs-var">nextChildIdCounter</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ThreadId
$sel:parentThreadId:Scope :: ThreadId
parentThreadId :: ThreadId
</span><a href="Ki.Internal.Scope.html#%24sel%3AparentThreadId%3AScope"><span class="hs-identifier hs-var hs-var">parentThreadId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus
$sel:statusVar:Scope :: TVar ScopeStatus
statusVar :: TVar ScopeStatus
</span><a href="Ki.Internal.Scope.html#%24sel%3AstatusVar%3AScope"><span class="hs-identifier hs-var hs-var">statusVar</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="hs-comment">-- Spawn a thread in a scope, providing it its child id and a function that sets the masking state to the requested</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- masking state. The given action is called with async exceptions interruptibly masked.</span><span>
</span><span id="line-220"></span><span class="annot"><a href="Ki.Internal.Scope.html#spawn"><span class="hs-identifier hs-type">spawn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ki.Internal.Thread.html#ThreadOptions"><span class="hs-identifier hs-type">ThreadOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ki.Internal.Thread.html#Tid"><span class="hs-identifier hs-type">Tid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679043296"><span class="annot"><a href="#local-6989586621679043296"><span class="hs-identifier hs-type">x</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679043296"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679043296"><span class="hs-identifier hs-type">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ki.Internal.IO.html#UnexceptionalIO"><span class="hs-identifier hs-type">UnexceptionalIO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span>
</span><span id="line-221"></span><span id="spawn"><span class="annot"><span class="annottext">spawn :: Scope
-&gt; ThreadOptions
-&gt; (ScopeStatus -&gt; (forall a. IO a -&gt; IO a) -&gt; UnexceptionalIO ())
-&gt; IO ThreadId
</span><a href="Ki.Internal.Scope.html#spawn"><span class="hs-identifier hs-var hs-var">spawn</span></a></span></span><span>
</span><span id="line-222"></span><span>  </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679043297"><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
$sel:childrenVar:Scope :: Scope -&gt; TVar (IntMap ThreadId)
childrenVar :: TVar (IntMap ThreadId)
</span><a href="Ki.Internal.Scope.html#%24sel%3AchildrenVar%3AScope"><span class="hs-identifier hs-var hs-var">childrenVar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679043298"><span class="annot"><span class="annottext">Counter
$sel:nextChildIdCounter:Scope :: Scope -&gt; Counter
nextChildIdCounter :: Counter
</span><a href="Ki.Internal.Scope.html#%24sel%3AnextChildIdCounter%3AScope"><span class="hs-identifier hs-var hs-var">nextChildIdCounter</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679043299"><span class="annot"><span class="annottext">TVar ScopeStatus
$sel:statusVar:Scope :: Scope -&gt; TVar ScopeStatus
statusVar :: TVar ScopeStatus
</span><a href="Ki.Internal.Scope.html#%24sel%3AstatusVar%3AScope"><span class="hs-identifier hs-var hs-var">statusVar</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><a href="Ki.Internal.Thread.html#ThreadOptions"><span class="hs-identifier hs-type">ThreadOptions</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679043301"><span class="annot"><span class="annottext">ThreadAffinity
affinity :: ThreadAffinity
$sel:affinity:ThreadOptions :: ThreadOptions -&gt; ThreadAffinity
</span><a href="#local-6989586621679043301"><span class="hs-identifier hs-var hs-var">affinity</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679043303"><span class="annot"><span class="annottext">Maybe ByteCount
allocationLimit :: Maybe ByteCount
$sel:allocationLimit:ThreadOptions :: ThreadOptions -&gt; Maybe ByteCount
</span><a href="#local-6989586621679043303"><span class="hs-identifier hs-var hs-var">allocationLimit</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679043305"><span class="annot"><span class="annottext">String
label :: String
$sel:label:ThreadOptions :: ThreadOptions -&gt; String
</span><a href="#local-6989586621679043305"><span class="hs-keyword hs-var hs-var">label</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">$sel:maskingState:ThreadOptions :: ThreadOptions -&gt; MaskingState
</span><a href="Ki.Internal.Thread.html#%24sel%3AmaskingState%3AThreadOptions"><span class="hs-identifier hs-var">maskingState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621679043308"><span class="annot"><span class="annottext">MaskingState
</span><a href="#local-6989586621679043308"><span class="hs-identifier hs-var">requestedChildMaskingState</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-224"></span><span>  </span><span id="local-6989586621679043309"><span class="annot"><span class="annottext">ScopeStatus -&gt; (forall a. IO a -&gt; IO a) -&gt; UnexceptionalIO ()
</span><a href="#local-6989586621679043309"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-comment">-- Interruptible mask is enough so long as none of the STM operations below block.</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-comment">-- Unconditionally set masking state to MaskedInterruptible, even though we might already be at MaskedInterruptible</span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-comment">-- or MaskedUninterruptible, to avoid a branch on parentMaskingState.</span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ThreadId
forall a. IO a -&gt; IO a
</span><a href="Ki.Internal.IO.html#interruptiblyMasked"><span class="hs-identifier hs-var">interruptiblyMasked</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>      </span><span class="hs-comment">-- Record the thread as being about to start. Not allowed to retry.</span><span>
</span><span id="line-231"></span><span>      </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>        </span><span id="local-6989586621679043310"><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043310"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus -&gt; STM ScopeStatus
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus
</span><a href="#local-6989586621679043299"><span class="hs-identifier hs-var">statusVar</span></a></span><span>
</span><span id="line-233"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; STM () -&gt; STM ()
forall a. HasCallStack =&gt; Bool -&gt; a -&gt; a
</span><span class="hs-identifier hs-var hs-var">assert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043310"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus -&gt; ScopeStatus -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">ScopeStatus
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043310"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-235"></span><span>            </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="Ki.Internal.Scope.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus -&gt; ScopeStatus -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus
</span><a href="#local-6989586621679043299"><span class="hs-identifier hs-var">statusVar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScopeStatus -&gt; STM ()) -&gt; ScopeStatus -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043310"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus -&gt; ScopeStatus -&gt; ScopeStatus
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><span class="hs-number">1</span></span><span>
</span><span id="line-236"></span><span>            </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="Ki.Internal.Scope.html#Closing"><span class="hs-identifier hs-var">Closing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ScopeClosing -&gt; STM ()
forall e a. Exception e =&gt; e -&gt; STM a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="annot"><span class="annottext">ScopeClosing
</span><a href="Ki.Internal.Scope.html#ScopeClosing"><span class="hs-identifier hs-var">ScopeClosing</span></a></span><span>
</span><span id="line-237"></span><span>            </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="Ki.Internal.Scope.html#Closed"><span class="hs-identifier hs-var">Closed</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ErrorCall -&gt; STM ()
forall e a. Exception e =&gt; e -&gt; STM a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ErrorCall
</span><span class="hs-identifier hs-var">ErrorCall</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ki: scope closed&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span>      </span><span id="local-6989586621679043313"><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043313"><span class="hs-identifier hs-var">childId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Counter -&gt; IO ScopeStatus
</span><a href="Ki.Internal.Counter.html#incrCounter"><span class="hs-identifier hs-var">incrCounter</span></a></span><span> </span><span class="annot"><span class="annottext">Counter
</span><a href="#local-6989586621679043298"><span class="hs-identifier hs-var">nextChildIdCounter</span></a></span><span>
</span><span id="line-240"></span><span>
</span><span id="line-241"></span><span>      </span><span id="local-6989586621679043315"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043315"><span class="hs-identifier hs-var">childThreadId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-242"></span><span>        </span><span class="annot"><span class="annottext">ThreadAffinity -&gt; IO () -&gt; IO ThreadId
</span><a href="Ki.Internal.Thread.html#forkWithAffinity"><span class="hs-identifier hs-var">forkWithAffinity</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadAffinity
</span><a href="#local-6989586621679043301"><span class="hs-identifier hs-var">affinity</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; IO () -&gt; IO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Bool
forall a. [a] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679043305"><span class="hs-keyword hs-var">label</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-244"></span><span>            </span><span id="local-6989586621679043319"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043319"><span class="hs-identifier hs-var">childThreadId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO ThreadId
</span><span class="hs-identifier hs-var">myThreadId</span></span><span>
</span><span id="line-245"></span><span>            </span><span class="annot"><span class="annottext">ThreadId -&gt; String -&gt; IO ()
</span><span class="hs-identifier hs-var">labelThread</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043319"><span class="hs-identifier hs-var">childThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679043305"><span class="hs-keyword hs-var">label</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ByteCount
</span><a href="#local-6989586621679043303"><span class="hs-identifier hs-var">allocationLimit</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-248"></span><span>            </span><span class="annot"><span class="annottext">Maybe ByteCount
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679043320"><span class="annot"><span class="annottext">ByteCount
</span><a href="#local-6989586621679043320"><span class="hs-identifier hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-250"></span><span>              </span><span class="annot"><span class="annottext">Int64 -&gt; IO ()
</span><span class="hs-identifier hs-var">setAllocationCounter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteCount -&gt; Int64
</span><a href="Ki.Internal.ByteCount.html#byteCountToInt64"><span class="hs-identifier hs-var">byteCountToInt64</span></a></span><span> </span><span class="annot"><span class="annottext">ByteCount
</span><a href="#local-6989586621679043320"><span class="hs-identifier hs-var">bytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>              </span><span class="annot"><span class="annottext">IO ()
</span><span class="hs-identifier hs-var">enableAllocationLimit</span></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Action that sets the masking state from the current (MaskedInterruptible) to the requested one.</span><span>
</span><span id="line-254"></span><span>              </span><span id="local-6989586621679043322"><span class="annot"><a href="#local-6989586621679043323"><span class="hs-identifier hs-type">atRequestedMaskingState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679043322"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679043322"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-255"></span><span>              </span><span id="local-6989586621679043323"><span class="annot"><span class="annottext">atRequestedMaskingState :: forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679043323"><span class="hs-identifier hs-var hs-var">atRequestedMaskingState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-256"></span><span>                </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MaskingState
</span><a href="#local-6989586621679043308"><span class="hs-identifier hs-var">requestedChildMaskingState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-257"></span><span>                  </span><span class="annot"><span class="annottext">MaskingState
</span><span class="hs-identifier hs-var">Unmasked</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. IO a -&gt; IO a
</span><span class="hs-identifier hs-var">unsafeUnmask</span></span><span>
</span><span id="line-258"></span><span>                  </span><span class="annot"><span class="annottext">MaskingState
</span><span class="hs-identifier hs-var">MaskedInterruptible</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-259"></span><span>                  </span><span class="annot"><span class="annottext">MaskingState
</span><span class="hs-identifier hs-var">MaskedUninterruptible</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. IO a -&gt; IO a
</span><a href="Ki.Internal.IO.html#uninterruptiblyMasked"><span class="hs-identifier hs-var">uninterruptiblyMasked</span></a></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span>          </span><span class="annot"><span class="annottext">UnexceptionalIO () -&gt; IO ()
forall a. UnexceptionalIO a -&gt; IO a
</span><a href="Ki.Internal.IO.html#%24sel%3ArunUnexceptionalIO%3AUnexceptionalIO"><span class="hs-identifier hs-var">runUnexceptionalIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScopeStatus -&gt; (forall a. IO a -&gt; IO a) -&gt; UnexceptionalIO ()
</span><a href="#local-6989586621679043309"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043313"><span class="hs-identifier hs-var">childId</span></a></span><span> </span><span class="annot"><span class="annottext">IO x -&gt; IO x
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679043323"><span class="hs-identifier hs-var">atRequestedMaskingState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span>          </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (IntMap ThreadId) -&gt; ScopeStatus -&gt; STM ()
</span><a href="Ki.Internal.Scope.html#unrecordChild"><span class="hs-identifier hs-var">unrecordChild</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
</span><a href="#local-6989586621679043297"><span class="hs-identifier hs-var">childrenVar</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043313"><span class="hs-identifier hs-var">childId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span>      </span><span class="hs-comment">-- Record the child as having started. Not allowed to retry.</span><span>
</span><span id="line-266"></span><span>      </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-267"></span><span>        </span><span id="local-6989586621679043330"><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043330"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus -&gt; STM ScopeStatus
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus
</span><a href="#local-6989586621679043299"><span class="hs-identifier hs-var">statusVar</span></a></span><span>
</span><span id="line-268"></span><span>        </span><span class="annot"><span class="annottext">TVar ScopeStatus -&gt; ScopeStatus -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus
</span><a href="#local-6989586621679043299"><span class="hs-identifier hs-var">statusVar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScopeStatus -&gt; STM ()) -&gt; ScopeStatus -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043330"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus -&gt; ScopeStatus -&gt; ScopeStatus
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><span class="hs-number">1</span></span><span>
</span><span id="line-269"></span><span>        </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId) -&gt; ScopeStatus -&gt; ThreadId -&gt; STM ()
</span><a href="Ki.Internal.Scope.html#recordChild"><span class="hs-identifier hs-var">recordChild</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
</span><a href="#local-6989586621679043297"><span class="hs-identifier hs-var">childrenVar</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043313"><span class="hs-identifier hs-var">childId</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043315"><span class="hs-identifier hs-var">childThreadId</span></a></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span>      </span><span class="annot"><span class="annottext">ThreadId -&gt; IO ThreadId
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043315"><span class="hs-identifier hs-var">childThreadId</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span class="hs-comment">-- Record our child by either:</span><span>
</span><span id="line-274"></span><span class="hs-comment">--</span><span>
</span><span id="line-275"></span><span class="hs-comment">--   * Flipping `Nothing` to `Just childThreadId` (common case: we record child before it unrecords itself)</span><span>
</span><span id="line-276"></span><span class="hs-comment">--   * Flipping `Just _` to `Nothing` (uncommon case: we observe that a child already unrecorded itself)</span><span>
</span><span id="line-277"></span><span class="hs-comment">--</span><span>
</span><span id="line-278"></span><span class="hs-comment">-- Never retries.</span><span>
</span><span id="line-279"></span><span class="annot"><a href="Ki.Internal.Scope.html#recordChild"><span class="hs-identifier hs-type">recordChild</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IntMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ki.Internal.Thread.html#Tid"><span class="hs-identifier hs-type">Tid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span id="recordChild"><span class="annot"><span class="annottext">recordChild :: TVar (IntMap ThreadId) -&gt; ScopeStatus -&gt; ThreadId -&gt; STM ()
</span><a href="Ki.Internal.Scope.html#recordChild"><span class="hs-identifier hs-var hs-var">recordChild</span></a></span></span><span> </span><span id="local-6989586621679043332"><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
</span><a href="#local-6989586621679043332"><span class="hs-identifier hs-var">childrenVar</span></a></span></span><span> </span><span id="local-6989586621679043333"><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043333"><span class="hs-identifier hs-var">childId</span></a></span></span><span> </span><span id="local-6989586621679043334"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043334"><span class="hs-identifier hs-var">childThreadId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-281"></span><span>  </span><span id="local-6989586621679043335"><span class="annot"><span class="annottext">IntMap ThreadId
</span><a href="#local-6989586621679043335"><span class="hs-identifier hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId) -&gt; STM (IntMap ThreadId)
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
</span><a href="#local-6989586621679043332"><span class="hs-identifier hs-var">childrenVar</span></a></span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId) -&gt; IntMap ThreadId -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
</span><a href="#local-6989586621679043332"><span class="hs-identifier hs-var">childrenVar</span></a></span><span> </span><span class="annot"><span class="annottext">(IntMap ThreadId -&gt; STM ()) -&gt; IntMap ThreadId -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ThreadId -&gt; Maybe ThreadId)
-&gt; ScopeStatus -&gt; IntMap ThreadId -&gt; IntMap ThreadId
forall a.
(Maybe a -&gt; Maybe a) -&gt; ScopeStatus -&gt; IntMap a -&gt; IntMap a
</span><span class="hs-identifier hs-var">IntMap.Lazy.alter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ThreadId
-&gt; (ThreadId -&gt; Maybe ThreadId) -&gt; Maybe ThreadId -&gt; Maybe ThreadId
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; Maybe ThreadId
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043334"><span class="hs-identifier hs-var">childThreadId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ThreadId -&gt; ThreadId -&gt; Maybe ThreadId
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Maybe ThreadId
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043333"><span class="hs-identifier hs-var">childId</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap ThreadId
</span><a href="#local-6989586621679043335"><span class="hs-identifier hs-var">children</span></a></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span class="hs-comment">-- Unrecord a child (ourselves) by either:</span><span>
</span><span id="line-285"></span><span class="hs-comment">--</span><span>
</span><span id="line-286"></span><span class="hs-comment">--   * Flipping `Just childThreadId` to `Nothing` (common case: parent recorded us first)</span><span>
</span><span id="line-287"></span><span class="hs-comment">--   * Flipping `Nothing` to `Just undefined` (uncommon case: we terminate and unrecord before parent can record us).</span><span>
</span><span id="line-288"></span><span class="hs-comment">--</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- Never retries.</span><span>
</span><span id="line-290"></span><span class="annot"><a href="Ki.Internal.Scope.html#unrecordChild"><span class="hs-identifier hs-type">unrecordChild</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IntMap</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">ThreadId</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ki.Internal.Thread.html#Tid"><span class="hs-identifier hs-type">Tid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span id="unrecordChild"><span class="annot"><span class="annottext">unrecordChild :: TVar (IntMap ThreadId) -&gt; ScopeStatus -&gt; STM ()
</span><a href="Ki.Internal.Scope.html#unrecordChild"><span class="hs-identifier hs-var hs-var">unrecordChild</span></a></span></span><span> </span><span id="local-6989586621679043339"><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
</span><a href="#local-6989586621679043339"><span class="hs-identifier hs-var">childrenVar</span></a></span></span><span> </span><span id="local-6989586621679043340"><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043340"><span class="hs-identifier hs-var">childId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-292"></span><span>  </span><span id="local-6989586621679043341"><span class="annot"><span class="annottext">IntMap ThreadId
</span><a href="#local-6989586621679043341"><span class="hs-identifier hs-var">children</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId) -&gt; STM (IntMap ThreadId)
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
</span><a href="#local-6989586621679043339"><span class="hs-identifier hs-var">childrenVar</span></a></span><span>
</span><span id="line-293"></span><span>  </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId) -&gt; IntMap ThreadId -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
</span><a href="#local-6989586621679043339"><span class="hs-identifier hs-var">childrenVar</span></a></span><span> </span><span class="annot"><span class="annottext">(IntMap ThreadId -&gt; STM ()) -&gt; IntMap ThreadId -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ThreadId -&gt; Maybe ThreadId)
-&gt; ScopeStatus -&gt; IntMap ThreadId -&gt; IntMap ThreadId
forall a.
(Maybe a -&gt; Maybe a) -&gt; ScopeStatus -&gt; IntMap a -&gt; IntMap a
</span><span class="hs-identifier hs-var">IntMap.Lazy.alter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ThreadId
-&gt; (ThreadId -&gt; Maybe ThreadId) -&gt; Maybe ThreadId -&gt; Maybe ThreadId
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; Maybe ThreadId
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
forall a. HasCallStack =&gt; a
</span><span class="hs-identifier hs-var">undefined</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ThreadId -&gt; ThreadId -&gt; Maybe ThreadId
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Maybe ThreadId
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043340"><span class="hs-identifier hs-var">childId</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap ThreadId
</span><a href="#local-6989586621679043341"><span class="hs-identifier hs-var">children</span></a></span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span class="annot"><span class="hs-comment">-- | Wait until all threads created within a scope terminate.</span></span><span>
</span><span id="line-296"></span><span class="annot"><a href="Ki.Internal.Scope.html#awaitAll"><span class="hs-identifier hs-type">awaitAll</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span id="awaitAll"><span class="annot"><span class="annottext">awaitAll :: Scope -&gt; STM ()
</span><a href="Ki.Internal.Scope.html#awaitAll"><span class="hs-identifier hs-var hs-var">awaitAll</span></a></span></span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679043343"><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
$sel:childrenVar:Scope :: Scope -&gt; TVar (IntMap ThreadId)
childrenVar :: TVar (IntMap ThreadId)
</span><a href="Ki.Internal.Scope.html#%24sel%3AchildrenVar%3AScope"><span class="hs-identifier hs-var hs-var">childrenVar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679043344"><span class="annot"><span class="annottext">TVar ScopeStatus
$sel:statusVar:Scope :: Scope -&gt; TVar ScopeStatus
statusVar :: TVar ScopeStatus
</span><a href="Ki.Internal.Scope.html#%24sel%3AstatusVar%3AScope"><span class="hs-identifier hs-var hs-var">statusVar</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>  </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId) -&gt; STM ()
forall a. TVar (IntMap a) -&gt; STM ()
</span><a href="Ki.Internal.Scope.html#blockUntilEmpty"><span class="hs-identifier hs-var">blockUntilEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (IntMap ThreadId)
</span><a href="#local-6989586621679043343"><span class="hs-identifier hs-var">childrenVar</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span id="local-6989586621679043345"><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043345"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus -&gt; STM ScopeStatus
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus
</span><a href="#local-6989586621679043344"><span class="hs-identifier hs-var">statusVar</span></a></span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043345"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="Ki.Internal.Scope.html#Open"><span class="hs-identifier hs-var">Open</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; STM ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043345"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus -&gt; ScopeStatus -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="Ki.Internal.Scope.html#Closing"><span class="hs-identifier hs-var">Closing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM ()
forall a. STM a
</span><span class="hs-identifier hs-var">retry</span></span><span> </span><span class="hs-comment">-- block until closed</span><span>
</span><span id="line-303"></span><span>    </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="Ki.Internal.Scope.html#Closed"><span class="hs-identifier hs-var">Closed</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; STM ()
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="hs-comment">-- Block until an IntMap becomes empty.</span><span>
</span><span id="line-306"></span><span id="local-6989586621679043005"><span class="annot"><a href="Ki.Internal.Scope.html#blockUntilEmpty"><span class="hs-identifier hs-type">blockUntilEmpty</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TVar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IntMap</span></span><span> </span><span class="annot"><a href="#local-6989586621679043005"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">STM</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-307"></span><span id="blockUntilEmpty"><span class="annot"><span class="annottext">blockUntilEmpty :: forall a. TVar (IntMap a) -&gt; STM ()
</span><a href="Ki.Internal.Scope.html#blockUntilEmpty"><span class="hs-identifier hs-var hs-var">blockUntilEmpty</span></a></span></span><span> </span><span id="local-6989586621679043348"><span class="annot"><span class="annottext">TVar (IntMap a)
</span><a href="#local-6989586621679043348"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-308"></span><span>  </span><span id="local-6989586621679043349"><span class="annot"><span class="annottext">IntMap a
</span><a href="#local-6989586621679043349"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (IntMap a) -&gt; STM (IntMap a)
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (IntMap a)
</span><a href="#local-6989586621679043348"><span class="hs-identifier hs-var">var</span></a></span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; STM ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntMap a -&gt; Bool
forall a. IntMap a -&gt; Bool
</span><span class="hs-identifier hs-var">IntMap.Lazy.null</span></span><span> </span><span class="annot"><span class="annottext">IntMap a
</span><a href="#local-6989586621679043349"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span class="hs-comment">-- | Create a child thread to execute an action within a scope.</span><span>
</span><span id="line-312"></span><span class="hs-comment">--</span><span>
</span><span id="line-313"></span><span class="hs-comment">-- /Note/: The child thread does not mask asynchronous exceptions, regardless of the parent thread's masking state. To</span><span>
</span><span id="line-314"></span><span class="hs-comment">-- create a child thread with a different initial masking state, use 'Ki.forkWith'.</span><span>
</span><span id="line-315"></span><span id="local-6989586621679043043"><span class="annot"><a href="Ki.Internal.Scope.html#fork"><span class="hs-identifier hs-type">fork</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679043043"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ki.Internal.Thread.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043043"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-316"></span><span id="fork"><span class="annot"><span class="annottext">fork :: forall a. Scope -&gt; IO a -&gt; IO (Thread a)
</span><a href="Ki.Internal.Scope.html#fork"><span class="hs-identifier hs-var hs-var">fork</span></a></span></span><span> </span><span id="local-6989586621679043351"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043351"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-317"></span><span>  </span><span class="annot"><span class="annottext">Scope -&gt; ThreadOptions -&gt; IO a -&gt; IO (Thread a)
forall a. Scope -&gt; ThreadOptions -&gt; IO a -&gt; IO (Thread a)
</span><a href="Ki.Internal.Scope.html#forkWith"><span class="hs-identifier hs-var">forkWith</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043351"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadOptions
</span><a href="Ki.Internal.Thread.html#defaultThreadOptions"><span class="hs-identifier hs-var">defaultThreadOptions</span></a></span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span class="annot"><span class="hs-comment">-- | Variant of 'Ki.fork' for threads that never return.</span></span><span>
</span><span id="line-320"></span><span class="annot"><a href="Ki.Internal.Scope.html#fork_"><span class="hs-identifier hs-type">fork_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span id="fork_"><span class="annot"><span class="annottext">fork_ :: Scope -&gt; IO Void -&gt; IO ()
</span><a href="Ki.Internal.Scope.html#fork_"><span class="hs-identifier hs-var hs-var">fork_</span></a></span></span><span> </span><span id="local-6989586621679043353"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043353"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-322"></span><span>  </span><span class="annot"><span class="annottext">Scope -&gt; ThreadOptions -&gt; IO Void -&gt; IO ()
</span><a href="Ki.Internal.Scope.html#forkWith_"><span class="hs-identifier hs-var">forkWith_</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043353"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadOptions
</span><a href="Ki.Internal.Thread.html#defaultThreadOptions"><span class="hs-identifier hs-var">defaultThreadOptions</span></a></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span class="annot"><span class="hs-comment">-- | Variant of 'Ki.fork' that takes an additional options argument.</span></span><span>
</span><span id="line-325"></span><span id="local-6989586621679043046"><span class="annot"><a href="Ki.Internal.Scope.html#forkWith"><span class="hs-identifier hs-type">forkWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ki.Internal.Thread.html#ThreadOptions"><span class="hs-identifier hs-type">ThreadOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679043046"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ki.Internal.Thread.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043046"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-326"></span><span id="forkWith"><span class="annot"><span class="annottext">forkWith :: forall a. Scope -&gt; ThreadOptions -&gt; IO a -&gt; IO (Thread a)
</span><a href="Ki.Internal.Scope.html#forkWith"><span class="hs-identifier hs-var hs-var">forkWith</span></a></span></span><span> </span><span id="local-6989586621679043360"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043360"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621679043361"><span class="annot"><span class="annottext">ThreadOptions
</span><a href="#local-6989586621679043361"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621679043362"><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679043362"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-327"></span><span>  </span><span id="local-6989586621679043363"><span class="annot"><span class="annottext">TVar (Result a)
</span><a href="#local-6989586621679043363"><span class="hs-identifier hs-var">resultVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Result a -&gt; IO (TVar (Result a))
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Result a
forall a. Result a
</span><a href="Ki.Internal.Scope.html#NoResultYet"><span class="hs-identifier hs-var">NoResultYet</span></a></span><span>
</span><span id="line-328"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679043365"><span class="annot"><span class="annottext">done :: Result a -&gt; UnexceptionalIO ()
</span><a href="#local-6989586621679043365"><span class="hs-identifier hs-var hs-var">done</span></a></span></span><span> </span><span id="local-6989586621679043366"><span class="annot"><span class="annottext">Result a
</span><a href="#local-6989586621679043366"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; UnexceptionalIO ()
forall a. IO a -&gt; UnexceptionalIO a
</span><a href="Ki.Internal.IO.html#UnexceptionalIO"><span class="hs-identifier hs-var">UnexceptionalIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (Result a) -&gt; Result a -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (Result a)
</span><a href="#local-6989586621679043363"><span class="hs-identifier hs-var">resultVar</span></a></span><span> </span><span class="annot"><span class="annottext">Result a
</span><a href="#local-6989586621679043366"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>  </span><span id="local-6989586621679043368"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043368"><span class="hs-identifier hs-var">ident</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-330"></span><span>    </span><span class="annot"><span class="annottext">Scope
-&gt; ThreadOptions
-&gt; (ScopeStatus -&gt; (forall a. IO a -&gt; IO a) -&gt; UnexceptionalIO ())
-&gt; IO ThreadId
</span><a href="Ki.Internal.Scope.html#spawn"><span class="hs-identifier hs-var">spawn</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043360"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadOptions
</span><a href="#local-6989586621679043361"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679043369"><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043369"><span class="hs-identifier hs-var">childId</span></a></span></span><span> </span><span id="local-6989586621679043370"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679043370"><span class="hs-identifier hs-var">masking</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-331"></span><span>      </span><span id="local-6989586621679043371"><span class="annot"><span class="annottext">IOResult a
</span><a href="#local-6989586621679043371"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; UnexceptionalIO (IOResult a)
forall a. IO a -&gt; UnexceptionalIO (IOResult a)
</span><a href="Ki.Internal.IO.html#unexceptionalTry"><span class="hs-identifier hs-var">unexceptionalTry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679043370"><span class="hs-identifier hs-var">masking</span></a></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679043362"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IOResult a
</span><a href="#local-6989586621679043371"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-333"></span><span>        </span><span class="annot"><a href="Ki.Internal.IO.html#Failure"><span class="hs-identifier hs-type">Failure</span></a></span><span> </span><span id="local-6989586621679043373"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043373"><span class="hs-identifier hs-var">exception</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-334"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; UnexceptionalIO () -&gt; UnexceptionalIO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span>
</span><span id="line-335"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; Bool
</span><a href="Ki.Internal.Scope.html#isScopeClosingException"><span class="hs-identifier hs-var">isScopeClosingException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043373"><span class="hs-identifier hs-var">exception</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; ScopeStatus -&gt; SomeException -&gt; UnexceptionalIO ()
</span><a href="Ki.Internal.Scope.html#propagateException"><span class="hs-identifier hs-var">propagateException</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043360"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043369"><span class="hs-identifier hs-var">childId</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043373"><span class="hs-identifier hs-var">exception</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>          </span><span class="hs-comment">-- even put async exceptions that we propagated. this isn't totally ideal because a caller awaiting this</span><span>
</span><span id="line-338"></span><span>          </span><span class="hs-comment">-- thread would not be able to distinguish between async exceptions delivered to this thread, or itself</span><span>
</span><span id="line-339"></span><span>          </span><span class="annot"><span class="annottext">Result a -&gt; UnexceptionalIO ()
</span><a href="#local-6989586621679043365"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; Result a
forall a. SomeException -&gt; Result a
</span><a href="Ki.Internal.Scope.html#BadResult"><span class="hs-identifier hs-var">BadResult</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043373"><span class="hs-identifier hs-var">exception</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>        </span><span class="annot"><a href="Ki.Internal.IO.html#Success"><span class="hs-identifier hs-type">Success</span></a></span><span> </span><span id="local-6989586621679043377"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679043377"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Result a -&gt; UnexceptionalIO ()
</span><a href="#local-6989586621679043365"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Result a
forall a. a -&gt; Result a
</span><a href="Ki.Internal.Scope.html#GoodResult"><span class="hs-identifier hs-var">GoodResult</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679043377"><span class="hs-identifier hs-var">value</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679043382"><span class="annot"><span class="annottext">doAwait :: STM a
</span><a href="#local-6989586621679043382"><span class="hs-identifier hs-var hs-var">doAwait</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-342"></span><span>        </span><span class="annot"><span class="annottext">TVar (Result a) -&gt; STM (Result a)
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (Result a)
</span><a href="#local-6989586621679043363"><span class="hs-identifier hs-var">resultVar</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Result a) -&gt; (Result a -&gt; STM a) -&gt; STM a
forall a b. STM a -&gt; (a -&gt; STM b) -&gt; STM b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-343"></span><span>          </span><span class="annot"><span class="annottext">Result a
</span><a href="Ki.Internal.Scope.html#NoResultYet"><span class="hs-identifier hs-var">NoResultYet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM a
forall a. STM a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-344"></span><span>          </span><span class="annot"><a href="Ki.Internal.Scope.html#BadResult"><span class="hs-identifier hs-type">BadResult</span></a></span><span> </span><span id="local-6989586621679043383"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043383"><span class="hs-identifier hs-var">exception</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; STM a
forall e a. Exception e =&gt; e -&gt; STM a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043383"><span class="hs-identifier hs-var">exception</span></a></span><span>
</span><span id="line-345"></span><span>          </span><span class="annot"><a href="Ki.Internal.Scope.html#GoodResult"><span class="hs-identifier hs-type">GoodResult</span></a></span><span> </span><span id="local-6989586621679043384"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679043384"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a -&gt; STM a
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679043384"><span class="hs-identifier hs-var">value</span></a></span><span>
</span><span id="line-346"></span><span>  </span><span class="annot"><span class="annottext">Thread a -&gt; IO (Thread a)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; STM a -&gt; Thread a
forall a. ThreadId -&gt; STM a -&gt; Thread a
</span><a href="Ki.Internal.Thread.html#makeThread"><span class="hs-identifier hs-var">makeThread</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043368"><span class="hs-identifier hs-var">ident</span></a></span><span> </span><span class="annot"><span class="annottext">STM a
</span><a href="#local-6989586621679043382"><span class="hs-identifier hs-var">doAwait</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span class="annot"><span class="hs-comment">-- | Variant of 'Ki.forkWith' for threads that never return.</span></span><span>
</span><span id="line-349"></span><span class="annot"><a href="Ki.Internal.Scope.html#forkWith_"><span class="hs-identifier hs-type">forkWith_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ki.Internal.Thread.html#ThreadOptions"><span class="hs-identifier hs-type">ThreadOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span id="forkWith_"><span class="annot"><span class="annottext">forkWith_ :: Scope -&gt; ThreadOptions -&gt; IO Void -&gt; IO ()
</span><a href="Ki.Internal.Scope.html#forkWith_"><span class="hs-identifier hs-var hs-var">forkWith_</span></a></span></span><span> </span><span id="local-6989586621679043386"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043386"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621679043387"><span class="annot"><span class="annottext">ThreadOptions
</span><a href="#local-6989586621679043387"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621679043388"><span class="annot"><span class="annottext">IO Void
</span><a href="#local-6989586621679043388"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-351"></span><span>  </span><span id="local-6989586621679043389"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043389"><span class="hs-identifier hs-var">_childThreadId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-352"></span><span>    </span><span class="annot"><span class="annottext">Scope
-&gt; ThreadOptions
-&gt; (ScopeStatus -&gt; (forall a. IO a -&gt; IO a) -&gt; UnexceptionalIO ())
-&gt; IO ThreadId
</span><a href="Ki.Internal.Scope.html#spawn"><span class="hs-identifier hs-var">spawn</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043386"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadOptions
</span><a href="#local-6989586621679043387"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679043390"><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043390"><span class="hs-identifier hs-var">childId</span></a></span></span><span> </span><span id="local-6989586621679043391"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679043391"><span class="hs-identifier hs-var">masking</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-353"></span><span>      </span><span class="annot"><span class="annottext">(SomeException -&gt; UnexceptionalIO ())
-&gt; (Void -&gt; UnexceptionalIO ()) -&gt; IO Void -&gt; UnexceptionalIO ()
forall a b.
(SomeException -&gt; UnexceptionalIO b)
-&gt; (a -&gt; UnexceptionalIO b) -&gt; IO a -&gt; UnexceptionalIO b
</span><a href="Ki.Internal.IO.html#unexceptionalTryEither"><span class="hs-identifier hs-var">unexceptionalTryEither</span></a></span><span>
</span><span id="line-354"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679043392"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043392"><span class="hs-identifier hs-var">exception</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; UnexceptionalIO () -&gt; UnexceptionalIO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; Bool
</span><a href="Ki.Internal.Scope.html#isScopeClosingException"><span class="hs-identifier hs-var">isScopeClosingException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043392"><span class="hs-identifier hs-var">exception</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; ScopeStatus -&gt; SomeException -&gt; UnexceptionalIO ()
</span><a href="Ki.Internal.Scope.html#propagateException"><span class="hs-identifier hs-var">propagateException</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043386"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043390"><span class="hs-identifier hs-var">childId</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043392"><span class="hs-identifier hs-var">exception</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>        </span><span class="annot"><span class="annottext">Void -&gt; UnexceptionalIO ()
forall a. Void -&gt; a
</span><span class="hs-identifier hs-var">absurd</span></span><span>
</span><span id="line-356"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO Void -&gt; IO Void
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679043391"><span class="hs-identifier hs-var">masking</span></a></span><span> </span><span class="annot"><span class="annottext">IO Void
</span><a href="#local-6989586621679043388"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>  </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span class="hs-comment">-- | Like 'Ki.fork', but the child thread does not propagate exceptions that are both:</span><span>
</span><span id="line-360"></span><span class="hs-comment">--</span><span>
</span><span id="line-361"></span><span class="hs-comment">-- * Synchronous (/i.e./ not an instance of 'SomeAsyncException').</span><span>
</span><span id="line-362"></span><span class="hs-comment">-- * An instance of @e@.</span><span>
</span><span id="line-363"></span><span class="annot"><a href="Ki.Internal.Scope.html#forkTry"><span class="hs-identifier hs-type">forkTry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679043057"><span class="annot"><a href="#local-6989586621679043057"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621679043058"><span class="annot"><a href="#local-6989586621679043058"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="#local-6989586621679043057"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679043058"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ki.Internal.Thread.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="#local-6989586621679043057"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043058"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span id="forkTry"><span class="annot"><span class="annottext">forkTry :: forall e a.
Exception e =&gt;
Scope -&gt; IO a -&gt; IO (Thread (Either e a))
</span><a href="Ki.Internal.Scope.html#forkTry"><span class="hs-identifier hs-var hs-var">forkTry</span></a></span></span><span> </span><span id="local-6989586621679043395"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043395"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-365"></span><span>  </span><span class="annot"><span class="annottext">Scope -&gt; ThreadOptions -&gt; IO a -&gt; IO (Thread (Either e a))
forall e a.
Exception e =&gt;
Scope -&gt; ThreadOptions -&gt; IO a -&gt; IO (Thread (Either e a))
</span><a href="Ki.Internal.Scope.html#forkTryWith"><span class="hs-identifier hs-var">forkTryWith</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043395"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadOptions
</span><a href="Ki.Internal.Thread.html#defaultThreadOptions"><span class="hs-identifier hs-var">defaultThreadOptions</span></a></span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span class="hs-keyword">data</span><span> </span><span id="Result"><span class="annot"><a href="Ki.Internal.Scope.html#Result"><span class="hs-identifier hs-var">Result</span></a></span></span><span> </span><span id="local-6989586621679043049"><span class="annot"><a href="#local-6989586621679043049"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-368"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="NoResultYet"><span class="annot"><a href="Ki.Internal.Scope.html#NoResultYet"><span class="hs-identifier hs-var">NoResultYet</span></a></span></span><span>
</span><span id="line-369"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="BadResult"><span class="annot"><a href="Ki.Internal.Scope.html#BadResult"><span class="hs-identifier hs-var">BadResult</span></a></span></span><span> </span><span class="hs-glyph">!</span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-comment">-- sync or async</span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="GoodResult"><span class="annot"><a href="Ki.Internal.Scope.html#GoodResult"><span class="hs-identifier hs-var">GoodResult</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679043049"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span class="annot"><span class="hs-comment">-- | Variant of 'Ki.forkTry' that takes an additional options argument.</span></span><span>
</span><span id="line-373"></span><span class="annot"><a href="Ki.Internal.Scope.html#forkTryWith"><span class="hs-identifier hs-type">forkTryWith</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679043061"><span class="annot"><a href="#local-6989586621679043061"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621679043062"><span class="annot"><a href="#local-6989586621679043062"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Exception</span></span><span> </span><span class="annot"><a href="#local-6989586621679043061"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ki.Internal.Thread.html#ThreadOptions"><span class="hs-identifier hs-type">ThreadOptions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621679043062"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Ki.Internal.Thread.html#Thread"><span class="hs-identifier hs-type">Thread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="#local-6989586621679043061"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679043062"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span id="forkTryWith"><span class="annot"><span class="annottext">forkTryWith :: forall e a.
Exception e =&gt;
Scope -&gt; ThreadOptions -&gt; IO a -&gt; IO (Thread (Either e a))
</span><a href="Ki.Internal.Scope.html#forkTryWith"><span class="hs-identifier hs-var hs-var">forkTryWith</span></a></span></span><span> </span><span id="local-6989586621679043407"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043407"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621679043408"><span class="annot"><span class="annottext">ThreadOptions
</span><a href="#local-6989586621679043408"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span id="local-6989586621679043409"><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679043409"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-375"></span><span>  </span><span id="local-6989586621679043410"><span class="annot"><span class="annottext">TVar (Result a)
</span><a href="#local-6989586621679043410"><span class="hs-identifier hs-var">resultVar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Result a -&gt; IO (TVar (Result a))
forall a. a -&gt; IO (TVar a)
</span><span class="hs-identifier hs-var">newTVarIO</span></span><span> </span><span class="annot"><span class="annottext">Result a
forall a. Result a
</span><a href="Ki.Internal.Scope.html#NoResultYet"><span class="hs-identifier hs-var">NoResultYet</span></a></span><span>
</span><span id="line-376"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679043411"><span class="annot"><span class="annottext">done :: Result a -&gt; UnexceptionalIO ()
</span><a href="#local-6989586621679043411"><span class="hs-identifier hs-var hs-var">done</span></a></span></span><span> </span><span id="local-6989586621679043412"><span class="annot"><span class="annottext">Result a
</span><a href="#local-6989586621679043412"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; UnexceptionalIO ()
forall a. IO a -&gt; UnexceptionalIO a
</span><a href="Ki.Internal.IO.html#UnexceptionalIO"><span class="hs-identifier hs-var">UnexceptionalIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (Result a) -&gt; Result a -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><span class="hs-identifier hs-var">writeTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (Result a)
</span><a href="#local-6989586621679043410"><span class="hs-identifier hs-var">resultVar</span></a></span><span> </span><span class="annot"><span class="annottext">Result a
</span><a href="#local-6989586621679043412"><span class="hs-identifier hs-var">result</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>  </span><span id="local-6989586621679043413"><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043413"><span class="hs-identifier hs-var">childThreadId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-378"></span><span>    </span><span class="annot"><span class="annottext">Scope
-&gt; ThreadOptions
-&gt; (ScopeStatus -&gt; (forall a. IO a -&gt; IO a) -&gt; UnexceptionalIO ())
-&gt; IO ThreadId
</span><a href="Ki.Internal.Scope.html#spawn"><span class="hs-identifier hs-var">spawn</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043407"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadOptions
</span><a href="#local-6989586621679043408"><span class="hs-identifier hs-var">opts</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679043414"><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043414"><span class="hs-identifier hs-var">childId</span></a></span></span><span> </span><span id="local-6989586621679043415"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679043415"><span class="hs-identifier hs-var">masking</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-379"></span><span>      </span><span id="local-6989586621679043416"><span class="annot"><span class="annottext">IOResult a
</span><a href="#local-6989586621679043416"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO a -&gt; UnexceptionalIO (IOResult a)
forall a. IO a -&gt; UnexceptionalIO (IOResult a)
</span><a href="Ki.Internal.IO.html#unexceptionalTry"><span class="hs-identifier hs-var">unexceptionalTry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO a -&gt; IO a
forall a. IO a -&gt; IO a
</span><a href="#local-6989586621679043415"><span class="hs-identifier hs-var">masking</span></a></span><span> </span><span class="annot"><span class="annottext">IO a
</span><a href="#local-6989586621679043409"><span class="hs-identifier hs-var">action</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IOResult a
</span><a href="#local-6989586621679043416"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-381"></span><span>        </span><span class="annot"><a href="Ki.Internal.IO.html#Failure"><span class="hs-identifier hs-type">Failure</span></a></span><span> </span><span id="local-6989586621679043417"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043417"><span class="hs-identifier hs-var">exception</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-382"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679043421"><span class="annot"><span class="annottext">shouldPropagate :: Bool
</span><a href="#local-6989586621679043421"><span class="hs-identifier hs-var hs-var">shouldPropagate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-383"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Bool
</span><a href="Ki.Internal.Scope.html#isScopeClosingException"><span class="hs-identifier hs-var">isScopeClosingException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043417"><span class="hs-identifier hs-var">exception</span></a></span><span>
</span><span id="line-384"></span><span>                  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-385"></span><span>                  </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">fromException</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679043061"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043417"><span class="hs-identifier hs-var">exception</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-386"></span><span>                    </span><span class="annot"><span class="annottext">Maybe e
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-387"></span><span>                    </span><span class="hs-comment">-- if the user calls `forkTry @MyAsyncException`, we still want to propagate the async exception</span><span>
</span><span id="line-388"></span><span>                    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">e
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; Bool
</span><a href="Ki.Internal.IO.html#isAsyncException"><span class="hs-identifier hs-var">isAsyncException</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043417"><span class="hs-identifier hs-var">exception</span></a></span><span>
</span><span id="line-389"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; UnexceptionalIO () -&gt; UnexceptionalIO ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679043421"><span class="hs-identifier hs-var">shouldPropagate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; ScopeStatus -&gt; SomeException -&gt; UnexceptionalIO ()
</span><a href="Ki.Internal.Scope.html#propagateException"><span class="hs-identifier hs-var">propagateException</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621679043407"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043414"><span class="hs-identifier hs-var">childId</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043417"><span class="hs-identifier hs-var">exception</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-390"></span><span>          </span><span class="annot"><span class="annottext">Result a -&gt; UnexceptionalIO ()
</span><a href="#local-6989586621679043411"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeException -&gt; Result a
forall a. SomeException -&gt; Result a
</span><a href="Ki.Internal.Scope.html#BadResult"><span class="hs-identifier hs-var">BadResult</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043417"><span class="hs-identifier hs-var">exception</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-391"></span><span>        </span><span class="annot"><a href="Ki.Internal.IO.html#Success"><span class="hs-identifier hs-type">Success</span></a></span><span> </span><span id="local-6989586621679043422"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679043422"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Result a -&gt; UnexceptionalIO ()
</span><a href="#local-6989586621679043411"><span class="hs-identifier hs-var">done</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Result a
forall a. a -&gt; Result a
</span><a href="Ki.Internal.Scope.html#GoodResult"><span class="hs-identifier hs-var">GoodResult</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679043422"><span class="hs-identifier hs-var">value</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679043430"><span class="annot"><span class="annottext">doAwait :: STM (Either e a)
</span><a href="#local-6989586621679043430"><span class="hs-identifier hs-var hs-var">doAwait</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-393"></span><span>        </span><span class="annot"><span class="annottext">TVar (Result a) -&gt; STM (Result a)
forall a. TVar a -&gt; STM a
</span><span class="hs-identifier hs-var">readTVar</span></span><span> </span><span class="annot"><span class="annottext">TVar (Result a)
</span><a href="#local-6989586621679043410"><span class="hs-identifier hs-var">resultVar</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Result a)
-&gt; (Result a -&gt; STM (Either e a)) -&gt; STM (Either e a)
forall a b. STM a -&gt; (a -&gt; STM b) -&gt; STM b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-394"></span><span>          </span><span class="annot"><span class="annottext">Result a
</span><a href="Ki.Internal.Scope.html#NoResultYet"><span class="hs-identifier hs-var">NoResultYet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM (Either e a)
forall a. STM a
</span><span class="hs-identifier hs-var">retry</span></span><span>
</span><span id="line-395"></span><span>          </span><span class="annot"><a href="Ki.Internal.Scope.html#BadResult"><span class="hs-identifier hs-type">BadResult</span></a></span><span> </span><span id="local-6989586621679043431"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043431"><span class="hs-identifier hs-var">exception</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-396"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall e. Exception e =&gt; SomeException -&gt; Maybe e
</span><span class="hs-identifier hs-var">fromException</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679043061"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043431"><span class="hs-identifier hs-var">exception</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-397"></span><span>              </span><span class="annot"><span class="annottext">Maybe e
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; STM (Either e a)
forall e a. Exception e =&gt; e -&gt; STM a
</span><span class="hs-identifier hs-var">throwSTM</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043431"><span class="hs-identifier hs-var">exception</span></a></span><span>
</span><span id="line-398"></span><span>              </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679043432"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679043432"><span class="hs-identifier hs-var">expectedException</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either e a -&gt; STM (Either e a)
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">e -&gt; Either e a
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621679043432"><span class="hs-identifier hs-var">expectedException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-399"></span><span>          </span><span class="annot"><a href="Ki.Internal.Scope.html#GoodResult"><span class="hs-identifier hs-type">GoodResult</span></a></span><span> </span><span id="local-6989586621679043433"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679043433"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either e a -&gt; STM (Either e a)
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; Either e a
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679043433"><span class="hs-identifier hs-var">value</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-400"></span><span>  </span><span class="annot"><span class="annottext">Thread (Either e a) -&gt; IO (Thread (Either e a))
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; STM (Either e a) -&gt; Thread (Either e a)
forall a. ThreadId -&gt; STM a -&gt; Thread a
</span><a href="Ki.Internal.Thread.html#makeThread"><span class="hs-identifier hs-var">makeThread</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043413"><span class="hs-identifier hs-var">childThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Either e a)
</span><a href="#local-6989586621679043430"><span class="hs-identifier hs-var">doAwait</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span class="hs-comment">-- We have a non-`ScopeClosing` exception to propagate to our parent.</span><span>
</span><span id="line-403"></span><span class="hs-comment">--</span><span>
</span><span id="line-404"></span><span class="hs-comment">-- If our scope has already begun closing (`statusVar` is Closing), then either...</span><span>
</span><span id="line-405"></span><span class="hs-comment">--</span><span>
</span><span id="line-406"></span><span class="hs-comment">--   (A) We already received a `ScopeClosing`, but then ended up trying to propagate an exception anyway, because we</span><span>
</span><span id="line-407"></span><span class="hs-comment">--   threw a synchronous exception (or were hit by a different asynchronous exception) during our teardown procedure.</span><span>
</span><span id="line-408"></span><span class="hs-comment">--</span><span>
</span><span id="line-409"></span><span class="hs-comment">--   or</span><span>
</span><span id="line-410"></span><span class="hs-comment">--</span><span>
</span><span id="line-411"></span><span class="hs-comment">--   (B) We will receive a `ScopeClosing` imminently, because our parent has *just* finished setting `statusVar` to</span><span>
</span><span id="line-412"></span><span class="hs-comment">--   Closing, and will proceed to throw ScopeClosing to all of its children.</span><span>
</span><span id="line-413"></span><span class="hs-comment">--</span><span>
</span><span id="line-414"></span><span class="hs-comment">-- If (A), our parent has asynchronous exceptions masked, so we must inform it of our exception via `childExceptionVar`</span><span>
</span><span id="line-415"></span><span class="hs-comment">-- rather than throwTo. If (B), either mechanism would work. And because we don't if we're in case (A) or (B), we just</span><span>
</span><span id="line-416"></span><span class="hs-comment">-- `childExceptionVar`.</span><span>
</span><span id="line-417"></span><span class="hs-comment">--</span><span>
</span><span id="line-418"></span><span class="hs-comment">-- And if our scope has not already begun closing (`statusVar` is not Closing), then we ought to throw our exception to</span><span>
</span><span id="line-419"></span><span class="hs-comment">-- it. But that might fail due to either...</span><span>
</span><span id="line-420"></span><span class="hs-comment">--</span><span>
</span><span id="line-421"></span><span class="hs-comment">--   (C) Our parent concurrently closing the scope and sending us a `ScopeClosing`; because it has asynchronous</span><span>
</span><span id="line-422"></span><span class="hs-comment">--   exceptions uninterruptibly masked and we only have asynchronous exception *synchronously* masked, its `throwTo`</span><span>
</span><span id="line-423"></span><span class="hs-comment">--   will return `()`, and ours will throw that `ScopeClosing` asynchronous exception. In this case, since we now know</span><span>
</span><span id="line-424"></span><span class="hs-comment">--   our parent is tearing down and has asynchronous exceptions masked, we again inform it via `childExceptionVar`.</span><span>
</span><span id="line-425"></span><span class="hs-comment">--</span><span>
</span><span id="line-426"></span><span class="hs-comment">--   (D) Some *other* non-`ScopeClosing` asynchronous exception is raised here. This is truly odd: maybe it's a heap</span><span>
</span><span id="line-427"></span><span class="hs-comment">--   overflow exception from the GHC runtime? Maybe some other thread has smuggled our `ThreadId` out and has manually</span><span>
</span><span id="line-428"></span><span class="hs-comment">--   thrown us an exception for some reason? Either way, because we already have an exception that we are trying to</span><span>
</span><span id="line-429"></span><span class="hs-comment">--   propagate, we just scoot these freaky exceptions under the rug.</span><span>
</span><span id="line-430"></span><span class="hs-comment">--</span><span>
</span><span id="line-431"></span><span class="hs-comment">-- Precondition: interruptibly masked</span><span>
</span><span id="line-432"></span><span class="annot"><a href="Ki.Internal.Scope.html#propagateException"><span class="hs-identifier hs-type">propagateException</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ki.Internal.Thread.html#Tid"><span class="hs-identifier hs-type">Tid</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SomeException</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Ki.Internal.IO.html#UnexceptionalIO"><span class="hs-identifier hs-type">UnexceptionalIO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span id="propagateException"><span class="annot"><span class="annottext">propagateException :: Scope -&gt; ScopeStatus -&gt; SomeException -&gt; UnexceptionalIO ()
</span><a href="Ki.Internal.Scope.html#propagateException"><span class="hs-identifier hs-var hs-var">propagateException</span></a></span></span><span> </span><span class="annot"><a href="Ki.Internal.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679043434"><span class="annot"><span class="annottext">MVar SomeException
$sel:childExceptionVar:Scope :: Scope -&gt; MVar SomeException
childExceptionVar :: MVar SomeException
</span><a href="Ki.Internal.Scope.html#%24sel%3AchildExceptionVar%3AScope"><span class="hs-identifier hs-var hs-var">childExceptionVar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679043435"><span class="annot"><span class="annottext">ThreadId
$sel:parentThreadId:Scope :: Scope -&gt; ThreadId
parentThreadId :: ThreadId
</span><a href="Ki.Internal.Scope.html#%24sel%3AparentThreadId%3AScope"><span class="hs-identifier hs-var hs-var">parentThreadId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679043436"><span class="annot"><span class="annottext">TVar ScopeStatus
$sel:statusVar:Scope :: Scope -&gt; TVar ScopeStatus
statusVar :: TVar ScopeStatus
</span><a href="Ki.Internal.Scope.html#%24sel%3AstatusVar%3AScope"><span class="hs-identifier hs-var hs-var">statusVar</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621679043437"><span class="annot"><span class="annottext">ScopeStatus
</span><a href="#local-6989586621679043437"><span class="hs-identifier hs-var">childId</span></a></span></span><span> </span><span id="local-6989586621679043438"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043438"><span class="hs-identifier hs-var">exception</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-434"></span><span>  </span><span class="annot"><span class="annottext">IO ScopeStatus -&gt; UnexceptionalIO ScopeStatus
forall a. IO a -&gt; UnexceptionalIO a
</span><a href="Ki.Internal.IO.html#UnexceptionalIO"><span class="hs-identifier hs-var">UnexceptionalIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar ScopeStatus -&gt; IO ScopeStatus
forall a. TVar a -&gt; IO a
</span><span class="hs-identifier hs-var">readTVarIO</span></span><span> </span><span class="annot"><span class="annottext">TVar ScopeStatus
</span><a href="#local-6989586621679043436"><span class="hs-identifier hs-var">statusVar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UnexceptionalIO ScopeStatus
-&gt; (ScopeStatus -&gt; UnexceptionalIO ()) -&gt; UnexceptionalIO ()
forall a b.
UnexceptionalIO a -&gt; (a -&gt; UnexceptionalIO b) -&gt; UnexceptionalIO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-435"></span><span>    </span><span class="annot"><span class="annottext">ScopeStatus
</span><a href="Ki.Internal.Scope.html#Closing"><span class="hs-identifier hs-var">Closing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnexceptionalIO ()
</span><a href="#local-6989586621679043439"><span class="hs-identifier hs-var">tryPutChildExceptionVar</span></a></span><span> </span><span class="hs-comment">-- (A) / (B)</span><span>
</span><span id="line-436"></span><span>    </span><span class="annot"><span class="annottext">ScopeStatus
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnexceptionalIO ()
</span><a href="#local-6989586621679043440"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-comment">-- we know status is Open here</span><span>
</span><span id="line-437"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-438"></span><span>    </span><span class="annot"><a href="#local-6989586621679043440"><span class="hs-identifier hs-type">loop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ki.Internal.IO.html#UnexceptionalIO"><span class="hs-identifier hs-type">UnexceptionalIO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>    </span><span id="local-6989586621679043440"><span class="annot"><span class="annottext">loop :: UnexceptionalIO ()
</span><a href="#local-6989586621679043440"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-440"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; UnexceptionalIO (IOResult ())
forall a. IO a -&gt; UnexceptionalIO (IOResult a)
</span><a href="Ki.Internal.IO.html#unexceptionalTry"><span class="hs-identifier hs-var">unexceptionalTry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ThreadId -&gt; ThreadFailed -&gt; IO ()
forall e. Exception e =&gt; ThreadId -&gt; e -&gt; IO ()
</span><span class="hs-identifier hs-var">throwTo</span></span><span> </span><span class="annot"><span class="annottext">ThreadId
</span><a href="#local-6989586621679043435"><span class="hs-identifier hs-var">parentThreadId</span></a></span><span> </span><span class="annot"><a href="Ki.Internal.Thread.html#ThreadFailed"><span class="hs-identifier hs-type">ThreadFailed</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ScopeStatus
$sel:childId:ThreadFailed :: ScopeStatus
childId :: ScopeStatus
</span><a href="Ki.Internal.Thread.html#%24sel%3AchildId%3AThreadFailed"><span class="hs-identifier hs-var hs-var">childId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SomeException
exception :: SomeException
$sel:exception:ThreadFailed :: SomeException
</span><a href="#local-6989586621679043438"><span class="hs-identifier hs-var hs-var">exception</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UnexceptionalIO (IOResult ())
-&gt; (IOResult () -&gt; UnexceptionalIO ()) -&gt; UnexceptionalIO ()
forall a b.
UnexceptionalIO a -&gt; (a -&gt; UnexceptionalIO b) -&gt; UnexceptionalIO b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-441"></span><span>        </span><span class="annot"><a href="Ki.Internal.IO.html#Failure"><span class="hs-identifier hs-type">Failure</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="Ki.Internal.Scope.html#IsScopeClosingException"><span class="hs-identifier hs-var">IsScopeClosingException</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnexceptionalIO ()
</span><a href="#local-6989586621679043439"><span class="hs-identifier hs-var">tryPutChildExceptionVar</span></a></span><span> </span><span class="hs-comment">-- (C)</span><span>
</span><span id="line-442"></span><span>        </span><span class="annot"><a href="Ki.Internal.IO.html#Failure"><span class="hs-identifier hs-type">Failure</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UnexceptionalIO ()
</span><a href="#local-6989586621679043440"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-comment">-- (D)</span><span>
</span><span id="line-443"></span><span>        </span><span class="annot"><a href="Ki.Internal.IO.html#Success"><span class="hs-identifier hs-type">Success</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; UnexceptionalIO ()
forall a. a -&gt; UnexceptionalIO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span>    </span><span class="annot"><a href="#local-6989586621679043439"><span class="hs-identifier hs-type">tryPutChildExceptionVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Ki.Internal.IO.html#UnexceptionalIO"><span class="hs-identifier hs-type">UnexceptionalIO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>    </span><span id="local-6989586621679043439"><span class="annot"><span class="annottext">tryPutChildExceptionVar :: UnexceptionalIO ()
</span><a href="#local-6989586621679043439"><span class="hs-identifier hs-var hs-var">tryPutChildExceptionVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-447"></span><span>      </span><span class="annot"><span class="annottext">IO () -&gt; UnexceptionalIO ()
forall a. IO a -&gt; UnexceptionalIO a
</span><a href="Ki.Internal.IO.html#UnexceptionalIO"><span class="hs-identifier hs-var">UnexceptionalIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO Bool -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar SomeException -&gt; SomeException -&gt; IO Bool
forall a. MVar a -&gt; a -&gt; IO Bool
</span><span class="hs-identifier hs-var">tryPutMVar</span></span><span> </span><span class="annot"><span class="annottext">MVar SomeException
</span><a href="#local-6989586621679043434"><span class="hs-identifier hs-var">childExceptionVar</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621679043438"><span class="hs-identifier hs-var">exception</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-448"></span></pre></body></html>