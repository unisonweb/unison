<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns, FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# OPTIONS_HADDOCK hide, prune #-}</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- Module         : Data.ByteString.Search.Internal.Utils</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- Copyright      : Daniel Fischer</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- Licence        : BSD3</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Maintainer     : Daniel Fischer &lt;daniel.is.fischer@googlemail.com&gt;</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- Stability      : Provisional</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- Portabiltity   : non-portable</span><span>
</span><span id="line-10"></span><span class="hs-comment">--</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- Author         : Daniel Fischer</span><span>
</span><span id="line-12"></span><span class="hs-comment">--</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- Utilities for several searching algorithms.</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.ByteString.Search.Internal.Utils</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#kmpBorders"><span class="hs-identifier">kmpBorders</span></a></span><span>
</span><span id="line-16"></span><span>                                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#automaton"><span class="hs-identifier">automaton</span></a></span><span>
</span><span id="line-17"></span><span>                                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#occurs"><span class="hs-identifier">occurs</span></a></span><span>
</span><span id="line-18"></span><span>                                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#suffShifts"><span class="hs-identifier">suffShifts</span></a></span><span>
</span><span id="line-19"></span><span>                                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#ldrop"><span class="hs-identifier">ldrop</span></a></span><span>
</span><span id="line-20"></span><span>                                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#ltake"><span class="hs-identifier">ltake</span></a></span><span>
</span><span id="line-21"></span><span>                                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#lsplit"><span class="hs-identifier">lsplit</span></a></span><span>
</span><span id="line-22"></span><span>                                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#release"><span class="hs-identifier">release</span></a></span><span>
</span><span id="line-23"></span><span>                                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#keep"><span class="hs-identifier">keep</span></a></span><span>
</span><span id="line-24"></span><span>                                             </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#strictify"><span class="hs-identifier">strictify</span></a></span><span>
</span><span id="line-25"></span><span>                                             </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Lazy</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">L</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.ByteString.Unsafe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafeIndex</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Array.Base</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">unsafeRead</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unsafeWrite</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unsafeAt</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Array.ST</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Array.Unboxed</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">when</span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bits</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Word</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Word8</span></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-40"></span><span class="hs-comment">--                              Preprocessing                               --</span><span>
</span><span id="line-41"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#automaton"><span class="hs-pragma hs-type">automaton</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-44"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#automaton"><span class="hs-identifier hs-type">automaton</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UArray</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-45"></span><span id="automaton"><span class="annot"><span class="annottext">automaton :: ByteString -&gt; UArray Int Int
</span><a href="Data.ByteString.Search.Internal.Utils.html#automaton"><span class="hs-identifier hs-var hs-var">automaton</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053029"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053029"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall s. ST s (STUArray s Int Int)) -&gt; UArray Int Int
forall i e. (forall s. ST s (STUArray s i e)) -&gt; UArray i e
</span><span class="hs-identifier hs-var">runSTUArray</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053051"><span class="annot"><span class="annottext">patLen :: Int
</span><a href="#local-6989586621679053051"><span class="hs-identifier hs-var hs-var">patLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">S.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053029"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-47"></span><span>        </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679053053"><span class="hs-pragma hs-type">patAt</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-48"></span><span>        </span><span id="local-6989586621679053053"><span class="annot"><span class="annottext">patAt :: Int -&gt; b
</span><a href="#local-6989586621679053053"><span class="hs-identifier hs-var hs-var">patAt</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053058"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053058"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; b
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">unsafeIndex</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053029"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053058"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679053059"><span class="annot"><span class="annottext">bord :: UArray Int Int
</span><a href="#local-6989586621679053059"><span class="hs-identifier hs-var hs-var">bord</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; UArray Int Int
</span><a href="Data.ByteString.Search.Internal.Utils.html#kmpBorders"><span class="hs-identifier hs-var">kmpBorders</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053029"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span id="local-6989586621679053060"><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053060"><span class="hs-identifier hs-var">aut</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; Int -&gt; ST s (STUArray s Int Int)
forall i. Ix i =&gt; (i, i) -&gt; Int -&gt; ST s (STUArray s i Int)
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
(i, i) -&gt; e -&gt; m (a i e)
</span><span class="hs-identifier hs-var">newArray</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053051"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">256</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; ST s ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; ST s ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053060"><span class="hs-identifier hs-var">aut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int
forall {b}. Num b =&gt; Int -&gt; b
</span><a href="#local-6989586621679053053"><span class="hs-identifier hs-var">patAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053076"><span class="annot"><span class="annottext">loop :: Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053076"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053077"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053077"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-53"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053081"><span class="annot"><span class="annottext">base :: Int
</span><a href="#local-6989586621679053081"><span class="hs-identifier hs-var hs-var">base</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053077"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Bits a =&gt; a -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">`shiftL`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">8</span></span><span>
</span><span id="line-54"></span><span>                </span><span id="local-6989586621679053108"><span class="annot"><span class="annottext">inner :: Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053108"><span class="hs-identifier hs-var hs-var">inner</span></a></span></span><span> </span><span id="local-6989586621679053109"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">j</span></a></span></span><span>
</span><span id="line-55"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053077"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053051"><span class="hs-identifier hs-var">patLen</span></a></span><span>
</span><span id="line-56"></span><span>                                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; m (STUArray s Int Int)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053060"><span class="hs-identifier hs-var">aut</span></a></span><span>
</span><span id="line-57"></span><span>                                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053076"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053077"><span class="hs-identifier hs-var">state</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-59"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053113"><span class="annot"><span class="annottext">i :: Int
</span><a href="#local-6989586621679053113"><span class="hs-identifier hs-var hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053081"><span class="hs-identifier hs-var">base</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall {b}. Num b =&gt; Int -&gt; b
</span><a href="#local-6989586621679053053"><span class="hs-identifier hs-var">patAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">j</span></a></span><span>
</span><span id="line-60"></span><span>                        </span><span id="local-6989586621679053114"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053114"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; m Int
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; m Int
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; m e
</span><span class="hs-identifier hs-var">unsafeRead</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053060"><span class="hs-identifier hs-var">aut</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053113"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-61"></span><span>                        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053114"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; m ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; m ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053060"><span class="hs-identifier hs-var">aut</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053113"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">j</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>                        </span><span class="annot"><span class="annottext">Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053108"><span class="hs-identifier hs-var">inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UArray Int Int -&gt; Int -&gt; Int
forall i. Ix i =&gt; UArray i Int -&gt; Int -&gt; Int
forall (a :: * -&gt; * -&gt; *) e i.
(IArray a e, Ix i) =&gt;
a i e -&gt; Int -&gt; e
</span><span class="hs-identifier hs-var">unsafeAt</span></span><span> </span><span class="annot"><span class="annottext">UArray Int Int
</span><a href="#local-6989586621679053059"><span class="hs-identifier hs-var">bord</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053109"><span class="hs-identifier hs-var">j</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053077"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053051"><span class="hs-identifier hs-var">patLen</span></a></span><span>
</span><span id="line-64"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053108"><span class="hs-identifier hs-var">inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UArray Int Int -&gt; Int -&gt; Int
forall i. Ix i =&gt; UArray i Int -&gt; Int -&gt; Int
forall (a :: * -&gt; * -&gt; *) e i.
(IArray a e, Ix i) =&gt;
a i e -&gt; Int -&gt; e
</span><span class="hs-identifier hs-var">unsafeAt</span></span><span> </span><span class="annot"><span class="annottext">UArray Int Int
</span><a href="#local-6989586621679053059"><span class="hs-identifier hs-var">bord</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053077"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053108"><span class="hs-identifier hs-var">inner</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053077"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; ST s (STUArray s Int Int)
forall {m :: * -&gt; *}.
MArray (STUArray s) Int m =&gt;
Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053076"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-comment">-- kmpBorders calculates the width of the widest borders of the prefixes</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- of the pattern which are not extensible to borders of the next</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- longer prefix. Most entries will be 0.</span><span>
</span><span id="line-71"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#kmpBorders"><span class="hs-pragma hs-type">kmpBorders</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-72"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#kmpBorders"><span class="hs-identifier hs-type">kmpBorders</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UArray</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-73"></span><span id="kmpBorders"><span class="annot"><span class="annottext">kmpBorders :: ByteString -&gt; UArray Int Int
</span><a href="Data.ByteString.Search.Internal.Utils.html#kmpBorders"><span class="hs-identifier hs-var hs-var">kmpBorders</span></a></span></span><span> </span><span id="local-6989586621679053115"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053115"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall s. ST s (STUArray s Int Int)) -&gt; UArray Int Int
forall i e. (forall s. ST s (STUArray s i e)) -&gt; UArray i e
</span><span class="hs-identifier hs-var">runSTUArray</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053128"><span class="annot"><span class="annottext">patLen :: Int
</span><a href="#local-6989586621679053128"><span class="hs-identifier hs-var hs-var">patLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">S.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053115"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-75"></span><span>        </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679053129"><span class="hs-pragma hs-type">patAt</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-76"></span><span>        </span><span class="annot"><a href="#local-6989586621679053129"><span class="hs-identifier hs-type">patAt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Word8</span></span><span>
</span><span id="line-77"></span><span>        </span><span id="local-6989586621679053129"><span class="annot"><span class="annottext">patAt :: Int -&gt; Word8
</span><a href="#local-6989586621679053129"><span class="hs-identifier hs-var hs-var">patAt</span></a></span></span><span> </span><span id="local-6989586621679053130"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053130"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">unsafeIndex</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053115"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053130"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span id="local-6989586621679053131"><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053131"><span class="hs-identifier hs-var">ar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; ST s (STUArray s Int Int)
forall i. Ix i =&gt; (i, i) -&gt; ST s (STUArray s i Int)
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
(i, i) -&gt; m (a i e)
</span><span class="hs-identifier hs-var">newArray_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053128"><span class="hs-identifier hs-var">patLen</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>    </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; ST s ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; ST s ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053131"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053152"><span class="annot"><span class="annottext">dec :: Word8 -&gt; Int -&gt; m Int
</span><a href="#local-6989586621679053152"><span class="hs-identifier hs-var hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621679053153"><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679053153"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621679053154"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053154"><span class="hs-identifier hs-var">j</span></a></span></span><span>
</span><span id="line-81"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053154"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679053153"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8
</span><a href="#local-6989586621679053129"><span class="hs-identifier hs-var">patAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053154"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m Int
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; m Int) -&gt; Int -&gt; m Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053154"><span class="hs-identifier hs-var">j</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-82"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; m Int
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; m Int
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; m e
</span><span class="hs-identifier hs-var">unsafeRead</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053131"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053154"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">m Int -&gt; (Int -&gt; m Int) -&gt; m Int
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; m Int
</span><a href="#local-6989586621679053152"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679053153"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-83"></span><span>        </span><span id="local-6989586621679053182"><span class="annot"><span class="annottext">bordLoop :: Int -&gt; Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053182"><span class="hs-identifier hs-var hs-var">bordLoop</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053183"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053183"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053184"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053184"><span class="hs-identifier hs-var">j</span></a></span></span><span>
</span><span id="line-84"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053128"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053183"><span class="hs-identifier hs-var">i</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; m (STUArray s Int Int)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053131"><span class="hs-identifier hs-var">ar</span></a></span><span>
</span><span id="line-85"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-86"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053187"><span class="annot"><span class="annottext">w :: Word8
</span><a href="#local-6989586621679053187"><span class="hs-identifier hs-var hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8
</span><a href="#local-6989586621679053129"><span class="hs-identifier hs-var">patAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053183"><span class="hs-identifier hs-var">i</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>                </span><span id="local-6989586621679053188"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053188"><span class="hs-identifier hs-var">j'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int -&gt; m Int
forall {m :: * -&gt; *}.
MArray (STUArray s) Int m =&gt;
Word8 -&gt; Int -&gt; m Int
</span><a href="#local-6989586621679053152"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679053187"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053184"><span class="hs-identifier hs-var">j</span></a></span><span>
</span><span id="line-88"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053183"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053128"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8
</span><a href="#local-6989586621679053129"><span class="hs-identifier hs-var">patAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053188"><span class="hs-identifier hs-var">j'</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8
</span><a href="#local-6989586621679053129"><span class="hs-identifier hs-var">patAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053183"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-89"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; m Int
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; m Int
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; m e
</span><span class="hs-identifier hs-var">unsafeRead</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053131"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053188"><span class="hs-identifier hs-var">j'</span></a></span><span> </span><span class="annot"><span class="annottext">m Int -&gt; (Int -&gt; m ()) -&gt; m ()
forall a b. m a -&gt; (a -&gt; m b) -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; m ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; m ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053131"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053183"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-90"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; m ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; m ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053131"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053183"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053188"><span class="hs-identifier hs-var">j'</span></a></span><span>
</span><span id="line-91"></span><span>                </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053182"><span class="hs-identifier hs-var">bordLoop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053183"><span class="hs-identifier hs-var">i</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053188"><span class="hs-identifier hs-var">j'</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; ST s (STUArray s Int Int)
forall {m :: * -&gt; *}.
MArray (STUArray s) Int m =&gt;
Int -&gt; Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053182"><span class="hs-identifier hs-var">bordLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-95"></span><span class="hs-comment">--                        Boyer-Moore Preprocessing                         --</span><span>
</span><span id="line-96"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-comment">{- Table of last occurrences of bytes in the pattern.

For each byte we record the (negated) position of its last
occurrence in the pattern except at the last position.

Thus, if byte b gives a mismatch at pattern position patPos,
we know that we can shift the window right by at least

patPos - (last occurrence of b in init pat)

or, since we negated the positions,

patPos + (occurs pat)

If the byte doesn't occur in the pattern, we can shift the window
so that the start of the pattern is aligned with the byte after this,
hence the default value of 1.

Complexity: O(patLen + size of alphabet)

-}</span><span>
</span><span id="line-119"></span><span class="hs-comment">{- Precondition: non-empty pattern

This invariant is guaranteed by not exporting occurs,
inside this module, we don't call it for empty patterns.

-}</span><span>
</span><span id="line-125"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#occurs"><span class="hs-pragma hs-type">occurs</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-126"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#occurs"><span class="hs-identifier hs-type">occurs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UArray</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-127"></span><span id="occurs"><span class="annot"><span class="annottext">occurs :: ByteString -&gt; UArray Int Int
</span><a href="Data.ByteString.Search.Internal.Utils.html#occurs"><span class="hs-identifier hs-var hs-var">occurs</span></a></span></span><span> </span><span id="local-6989586621679053190"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053190"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall s. ST s (STUArray s Int Int)) -&gt; UArray Int Int
forall i e. (forall s. ST s (STUArray s i e)) -&gt; UArray i e
</span><span class="hs-identifier hs-var">runSTUArray</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053202"><span class="annot"><span class="annottext">patEnd :: Int
</span><a href="#local-6989586621679053202"><span class="hs-identifier hs-var hs-var">patEnd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">S.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053190"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-129"></span><span>        </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679053203"><span class="hs-pragma hs-type">patAt</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-130"></span><span>        </span><span class="annot"><a href="#local-6989586621679053203"><span class="hs-identifier hs-type">patAt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-131"></span><span>        </span><span id="local-6989586621679053203"><span class="annot"><span class="annottext">patAt :: Int -&gt; Int
</span><a href="#local-6989586621679053203"><span class="hs-identifier hs-var hs-var">patAt</span></a></span></span><span> </span><span id="local-6989586621679053204"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053204"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">unsafeIndex</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053190"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053204"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>    </span><span id="local-6989586621679053205"><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053205"><span class="hs-identifier hs-var">ar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; Int -&gt; ST s (STUArray s Int Int)
forall i. Ix i =&gt; (i, i) -&gt; Int -&gt; ST s (STUArray s i Int)
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
(i, i) -&gt; e -&gt; m (a i e)
</span><span class="hs-identifier hs-var">newArray</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">255</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053225"><span class="annot"><span class="annottext">loop :: Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053225"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053226"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053226"><span class="hs-identifier hs-var">i</span></a></span></span><span>
</span><span id="line-134"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053226"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053202"><span class="hs-identifier hs-var">patEnd</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; m (STUArray s Int Int)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053205"><span class="hs-identifier hs-var">ar</span></a></span><span>
</span><span id="line-135"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-136"></span><span>                </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; m ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; m ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053205"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int
</span><a href="#local-6989586621679053203"><span class="hs-identifier hs-var">patAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053226"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053226"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>                </span><span class="annot"><span class="annottext">Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053225"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053226"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; ST s (STUArray s Int Int)
forall {m :: * -&gt; *}.
MArray (STUArray s) Int m =&gt;
Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053225"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="hs-comment">{- Table of suffix-shifts.

When a mismatch occurs at pattern position patPos, assumed to be not the
last position in the pattern, the suffix u of length (patEnd - patPos)
has been successfully matched.
Let c be the byte in the pattern at position patPos.

If the sub-pattern u also occurs in the pattern somewhere *not* preceded
by c, let uPos be the position of the last byte in u for the last of
all such occurrences. Then there can be no match if the window is shifted
less than (patEnd - uPos) places, because either the part of the string
which matched the suffix u is not aligned with an occurrence of u in the
pattern, or it is aligned with an occurrence of u which is preceded by
the same byte c as the originally matched suffix.

If the complete sub-pattern u does not occur again in the pattern, or all
of its occurrences are preceded by the byte c, then we can align the
pattern with the string so that a suffix v of u matches a prefix of the
pattern. If v is chosen maximal, no smaller shift can give a match, so
we can shift by at least (patLen - length v).

If a complete match is encountered, we can shift by at least the same
amount as if the first byte of the pattern was a mismatch, no complete
match is possible between these positions.

For non-periodic patterns, only very short suffixes will usually occur
again in the pattern, so if a longer suffix has been matched before a
mismatch, the window can then be shifted entirely past the partial
match, so that part of the string will not be re-compared.
For periodic patterns, the suffix shifts will be shorter in general,
leading to an O(strLen * patLen) worst-case performance.

To compute the suffix-shifts, we use an array containing the lengths of
the longest common suffixes of the entire pattern and its prefix ending
with position pos.

-}</span><span>
</span><span id="line-177"></span><span class="hs-comment">{- Precondition: non-empty pattern -}</span><span>
</span><span id="line-178"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#suffShifts"><span class="hs-pragma hs-type">suffShifts</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-179"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#suffShifts"><span class="hs-identifier hs-type">suffShifts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UArray</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-180"></span><span id="suffShifts"><span class="annot"><span class="annottext">suffShifts :: ByteString -&gt; UArray Int Int
</span><a href="Data.ByteString.Search.Internal.Utils.html#suffShifts"><span class="hs-identifier hs-var hs-var">suffShifts</span></a></span></span><span> </span><span id="local-6989586621679053227"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053227"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall s. ST s (STUArray s Int Int)) -&gt; UArray Int Int
forall i e. (forall s. ST s (STUArray s i e)) -&gt; UArray i e
</span><span class="hs-identifier hs-var">runSTUArray</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053237"><span class="annot"><span class="annottext">patLen :: Int
</span><a href="#local-6989586621679053237"><span class="hs-identifier hs-var hs-var">patLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">S.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053227"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-182"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679053240"><span class="annot"><span class="annottext">patEnd :: Int
</span><a href="#local-6989586621679053240"><span class="hs-identifier hs-var hs-var">patEnd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053237"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-183"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679053241"><span class="annot"><span class="annottext">suff :: UArray Int Int
</span><a href="#local-6989586621679053241"><span class="hs-identifier hs-var hs-var">suff</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; UArray Int Int
</span><a href="Data.ByteString.Search.Internal.Utils.html#suffLengths"><span class="hs-identifier hs-var">suffLengths</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053227"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span id="local-6989586621679053243"><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053243"><span class="hs-identifier hs-var">ar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; Int -&gt; ST s (STUArray s Int Int)
forall i. Ix i =&gt; (i, i) -&gt; Int -&gt; ST s (STUArray s i Int)
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
(i, i) -&gt; e -&gt; m (a i e)
</span><span class="hs-identifier hs-var">newArray</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053240"><span class="hs-identifier hs-var">patEnd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053237"><span class="hs-identifier hs-var">patLen</span></a></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053267"><span class="annot"><span class="annottext">preShift :: Int -&gt; Int -&gt; m ()
</span><a href="#local-6989586621679053267"><span class="hs-identifier hs-var hs-var">preShift</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053268"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053268"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053269"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053269"><span class="hs-identifier hs-var">j</span></a></span></span><span>
</span><span id="line-186"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053268"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">UArray Int Int
</span><a href="#local-6989586621679053241"><span class="hs-identifier hs-var">suff</span></a></span><span> </span><span class="annot"><span class="annottext">UArray Int Int -&gt; Int -&gt; Int
forall i. Ix i =&gt; UArray i Int -&gt; Int -&gt; Int
forall (a :: * -&gt; * -&gt; *) e i.
(IArray a e, Ix i) =&gt;
a i e -&gt; Int -&gt; e
</span><span class="hs-operator hs-var">`unsafeAt`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053268"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053268"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-188"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053271"><span class="annot"><span class="annottext">shf :: Int
</span><a href="#local-6989586621679053271"><span class="hs-identifier hs-var hs-var">shf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053240"><span class="hs-identifier hs-var">patEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053268"><span class="hs-identifier hs-var">idx</span></a></span><span>
</span><span id="line-189"></span><span>                    </span><span id="local-6989586621679053288"><span class="annot"><span class="annottext">fillToShf :: Int -&gt; m ()
</span><a href="#local-6989586621679053288"><span class="hs-identifier hs-var hs-var">fillToShf</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053289"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053289"><span class="hs-identifier hs-var">i</span></a></span></span><span>
</span><span id="line-190"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053289"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053271"><span class="hs-identifier hs-var">shf</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>                            </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; m ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; m ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053243"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053289"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053271"><span class="hs-identifier hs-var">shf</span></a></span><span>
</span><span id="line-193"></span><span>                            </span><span class="annot"><span class="annottext">Int -&gt; m ()
</span><a href="#local-6989586621679053288"><span class="hs-identifier hs-var">fillToShf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053289"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>                </span><span class="annot"><span class="annottext">Int -&gt; m ()
forall {m :: * -&gt; *}. MArray (STUArray s) Int m =&gt; Int -&gt; m ()
</span><a href="#local-6989586621679053288"><span class="hs-identifier hs-var">fillToShf</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053269"><span class="hs-identifier hs-var">j</span></a></span><span>
</span><span id="line-195"></span><span>                </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; m ()
</span><a href="#local-6989586621679053267"><span class="hs-identifier hs-var">preShift</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053268"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053271"><span class="hs-identifier hs-var">shf</span></a></span><span>
</span><span id="line-196"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; m ()
</span><a href="#local-6989586621679053267"><span class="hs-identifier hs-var">preShift</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053268"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053269"><span class="hs-identifier hs-var">j</span></a></span><span>
</span><span id="line-197"></span><span>        </span><span id="local-6989586621679053310"><span class="annot"><span class="annottext">sufShift :: Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053310"><span class="hs-identifier hs-var hs-var">sufShift</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053311"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053311"><span class="hs-identifier hs-var">idx</span></a></span></span><span>
</span><span id="line-198"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053311"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053240"><span class="hs-identifier hs-var">patEnd</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; m (STUArray s Int Int)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053243"><span class="hs-identifier hs-var">ar</span></a></span><span>
</span><span id="line-199"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-200"></span><span>                </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; m ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; m ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053243"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053240"><span class="hs-identifier hs-var">patEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">UArray Int Int -&gt; Int -&gt; Int
forall i. Ix i =&gt; UArray i Int -&gt; Int -&gt; Int
forall (a :: * -&gt; * -&gt; *) e i.
(IArray a e, Ix i) =&gt;
a i e -&gt; Int -&gt; e
</span><span class="hs-identifier hs-var">unsafeAt</span></span><span> </span><span class="annot"><span class="annottext">UArray Int Int
</span><a href="#local-6989586621679053241"><span class="hs-identifier hs-var">suff</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053311"><span class="hs-identifier hs-var">idx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053240"><span class="hs-identifier hs-var">patEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053311"><span class="hs-identifier hs-var">idx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>                </span><span class="annot"><span class="annottext">Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053310"><span class="hs-identifier hs-var">sufShift</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053311"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; ST s ()
forall {m :: * -&gt; *}.
MArray (STUArray s) Int m =&gt;
Int -&gt; Int -&gt; m ()
</span><a href="#local-6989586621679053267"><span class="hs-identifier hs-var">preShift</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053240"><span class="hs-identifier hs-var">patEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-203"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; ST s (STUArray s Int Int)
forall {m :: * -&gt; *}.
MArray (STUArray s) Int m =&gt;
Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053310"><span class="hs-identifier hs-var">sufShift</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span class="hs-comment">{- Table of suffix-lengths.

The value of this array at place i is the length of the longest common
suffix of the entire pattern and the prefix of the pattern ending at
position i.

Usually, most of the entries will be 0. Only if the byte at position i
is the same as the last byte of the pattern can the value be positive.
In any case the value at index patEnd is patLen (since the pattern is
identical to itself) and 0 &lt;= value at i &lt;= (i + 1).

To keep this part of preprocessing linear in the length of the pattern,
the implementation must be non-obvious (the obvious algorithm for this
is quadratic).

When the index under consideration is inside a previously identified
common suffix, we align that suffix with the end of the pattern and
check whether the suffix ending at the position corresponding to idx
is shorter than the part of the suffix up to idx. If that is the case,
the length of the suffix ending at idx is that of the suffix at the
corresponding position. Otherwise extend the suffix as far as possible.
If the index under consideration is not inside a previously identified
common suffix, compare with the last byte of the pattern. If that gives
a suffix of length &gt; 1, for the next index we're in the previous
situation, otherwise we're back in the same situation for the next
index.

-}</span><span>
</span><span id="line-233"></span><span class="hs-comment">{- Precondition: non-empty pattern -}</span><span>
</span><span id="line-234"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#suffLengths"><span class="hs-pragma hs-type">suffLengths</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-235"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#suffLengths"><span class="hs-identifier hs-type">suffLengths</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">UArray</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-236"></span><span id="suffLengths"><span class="annot"><span class="annottext">suffLengths :: ByteString -&gt; UArray Int Int
</span><a href="Data.ByteString.Search.Internal.Utils.html#suffLengths"><span class="hs-identifier hs-var hs-var">suffLengths</span></a></span></span><span> </span><span id="local-6989586621679053312"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053312"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall s. ST s (STUArray s Int Int)) -&gt; UArray Int Int
forall i e. (forall s. ST s (STUArray s i e)) -&gt; UArray i e
</span><span class="hs-identifier hs-var">runSTUArray</span></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><span id="line-237"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053321"><span class="annot"><span class="annottext">patLen :: Int
</span><a href="#local-6989586621679053321"><span class="hs-identifier hs-var hs-var">patLen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">S.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053312"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-238"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679053324"><span class="annot"><span class="annottext">patEnd :: Int
</span><a href="#local-6989586621679053324"><span class="hs-identifier hs-var hs-var">patEnd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053321"><span class="hs-identifier hs-var">patLen</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-239"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679053327"><span class="annot"><span class="annottext">preEnd :: Int
</span><a href="#local-6989586621679053327"><span class="hs-identifier hs-var hs-var">preEnd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053324"><span class="hs-identifier hs-var">patEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-240"></span><span>        </span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="#local-6989586621679053328"><span class="hs-pragma hs-type">patAt</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-241"></span><span>        </span><span id="local-6989586621679053328"><span class="annot"><span class="annottext">patAt :: Int -&gt; Word8
</span><a href="#local-6989586621679053328"><span class="hs-identifier hs-var hs-var">patAt</span></a></span></span><span> </span><span id="local-6989586621679053329"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053329"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int -&gt; Word8
</span><span class="hs-identifier hs-var">unsafeIndex</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053312"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053329"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-242"></span><span>        </span><span class="hs-comment">-- last byte for comparisons</span><span>
</span><span id="line-243"></span><span>        </span><span class="hs-glyph">!</span><span id="local-6989586621679053330"><span class="annot"><span class="annottext">pe :: Word8
</span><a href="#local-6989586621679053330"><span class="hs-identifier hs-var hs-var">pe</span></a></span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8
</span><a href="#local-6989586621679053328"><span class="hs-identifier hs-var">patAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053324"><span class="hs-identifier hs-var">patEnd</span></a></span><span>
</span><span id="line-244"></span><span>        </span><span class="hs-comment">-- find index preceding the longest suffix</span><span>
</span><span id="line-245"></span><span>        </span><span id="local-6989586621679053337"><span class="annot"><span class="annottext">dec :: Int -&gt; Int -&gt; Int
</span><a href="#local-6989586621679053337"><span class="hs-identifier hs-var hs-var">dec</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053338"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053338"><span class="hs-identifier hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053339"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053339"><span class="hs-identifier hs-var">j</span></a></span></span><span>
</span><span id="line-246"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053339"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8
</span><a href="#local-6989586621679053328"><span class="hs-identifier hs-var">patAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053339"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8
</span><a href="#local-6989586621679053328"><span class="hs-identifier hs-var">patAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053339"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053338"><span class="hs-identifier hs-var">diff</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053339"><span class="hs-identifier hs-var">j</span></a></span><span>
</span><span id="line-247"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
</span><a href="#local-6989586621679053337"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053338"><span class="hs-identifier hs-var">diff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053339"><span class="hs-identifier hs-var">j</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>    </span><span id="local-6989586621679053341"><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053341"><span class="hs-identifier hs-var">ar</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int, Int) -&gt; ST s (STUArray s Int Int)
forall i. Ix i =&gt; (i, i) -&gt; ST s (STUArray s i Int)
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
(i, i) -&gt; m (a i e)
</span><span class="hs-identifier hs-var">newArray_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053324"><span class="hs-identifier hs-var">patEnd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>    </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; ST s ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; ST s ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053341"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053324"><span class="hs-identifier hs-var">patEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053321"><span class="hs-identifier hs-var">patLen</span></a></span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679053401"><span class="annot"><span class="annottext">noSuff :: Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053401"><span class="hs-identifier hs-var hs-var">noSuff</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053402"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053402"><span class="hs-identifier hs-var">i</span></a></span></span><span>
</span><span id="line-251"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053402"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; m (STUArray s Int Int)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053341"><span class="hs-identifier hs-var">ar</span></a></span><span>
</span><span id="line-252"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8
</span><a href="#local-6989586621679053328"><span class="hs-identifier hs-var">patAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053402"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679053330"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-253"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053404"><span class="annot"><span class="annottext">diff :: Int
</span><a href="#local-6989586621679053404"><span class="hs-identifier hs-var hs-var">diff</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053324"><span class="hs-identifier hs-var">patEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053402"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-254"></span><span>                    </span><span class="hs-glyph">!</span><span id="local-6989586621679053407"><span class="annot"><span class="annottext">nextI :: Int
</span><a href="#local-6989586621679053407"><span class="hs-identifier hs-var hs-var">nextI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053402"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-255"></span><span>                    </span><span class="hs-glyph">!</span><span id="local-6989586621679053408"><span class="annot"><span class="annottext">prevI :: Int
</span><a href="#local-6989586621679053408"><span class="hs-identifier hs-var hs-var">prevI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
</span><a href="#local-6989586621679053337"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053404"><span class="hs-identifier hs-var">diff</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053407"><span class="hs-identifier hs-var">nextI</span></a></span><span>
</span><span id="line-256"></span><span>                </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053408"><span class="hs-identifier hs-var">prevI</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053407"><span class="hs-identifier hs-var">nextI</span></a></span><span>
</span><span id="line-257"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; m ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; m ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053341"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053402"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m (STUArray s Int Int) -&gt; m (STUArray s Int Int)
forall a b. m a -&gt; m b -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053401"><span class="hs-identifier hs-var">noSuff</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053407"><span class="hs-identifier hs-var">nextI</span></a></span><span>
</span><span id="line-258"></span><span>                    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; m ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; m ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053341"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053402"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053402"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053408"><span class="hs-identifier hs-var">prevI</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-259"></span><span>                            </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053409"><span class="hs-identifier hs-var">suffLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053408"><span class="hs-identifier hs-var">prevI</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053327"><span class="hs-identifier hs-var">preEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053407"><span class="hs-identifier hs-var">nextI</span></a></span><span>
</span><span id="line-260"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-261"></span><span>                </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; m ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; m ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053341"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053402"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-262"></span><span>                </span><span class="annot"><span class="annottext">Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053401"><span class="hs-identifier hs-var">noSuff</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053402"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>        </span><span id="local-6989586621679053409"><span class="annot"><span class="annottext">suffLoop :: Int -&gt; Int -&gt; Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053409"><span class="hs-identifier hs-var hs-var">suffLoop</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053410"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053410"><span class="hs-identifier hs-var">pre</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053411"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053411"><span class="hs-identifier hs-var">end</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053412"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span></span><span>
</span><span id="line-264"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; m (STUArray s Int Int)
forall a. a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053341"><span class="hs-identifier hs-var">ar</span></a></span><span>
</span><span id="line-265"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053410"><span class="hs-identifier hs-var">pre</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-266"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Word8
</span><a href="#local-6989586621679053328"><span class="hs-identifier hs-var">patAt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Word8 -&gt; Word8 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Word8
</span><a href="#local-6989586621679053330"><span class="hs-identifier hs-var">pe</span></a></span><span>
</span><span id="line-267"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; m ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; m ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053341"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">m () -&gt; m (STUArray s Int Int) -&gt; m (STUArray s Int Int)
forall a b. m a -&gt; m b -&gt; m b
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053409"><span class="hs-identifier hs-var">suffLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053410"><span class="hs-identifier hs-var">pre</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053411"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-269"></span><span>                    </span><span id="local-6989586621679053413"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053413"><span class="hs-identifier hs-var">prevS</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; m Int
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; m Int
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; m e
</span><span class="hs-identifier hs-var">unsafeRead</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053341"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053411"><span class="hs-identifier hs-var">end</span></a></span><span>
</span><span id="line-270"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053410"><span class="hs-identifier hs-var">pre</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053413"><span class="hs-identifier hs-var">prevS</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span>
</span><span id="line-271"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; m ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; m ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053341"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053413"><span class="hs-identifier hs-var">prevS</span></a></span><span>
</span><span id="line-272"></span><span>                                </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053409"><span class="hs-identifier hs-var">suffLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053410"><span class="hs-identifier hs-var">pre</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053411"><span class="hs-identifier hs-var">end</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053415"><span class="annot"><span class="annottext">prI :: Int
</span><a href="#local-6989586621679053415"><span class="hs-identifier hs-var hs-var">prI</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
</span><a href="#local-6989586621679053337"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053324"><span class="hs-identifier hs-var">patEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053410"><span class="hs-identifier hs-var">pre</span></a></span><span>
</span><span id="line-274"></span><span>                                </span><span class="annot"><span class="annottext">STUArray s Int Int -&gt; Int -&gt; Int -&gt; m ()
forall i. Ix i =&gt; STUArray s i Int -&gt; Int -&gt; Int -&gt; m ()
forall (a :: * -&gt; * -&gt; *) e (m :: * -&gt; *) i.
(MArray a e m, Ix i) =&gt;
a i e -&gt; Int -&gt; e -&gt; m ()
</span><span class="hs-identifier hs-var">unsafeWrite</span></span><span> </span><span class="annot"><span class="annottext">STUArray s Int Int
</span><a href="#local-6989586621679053341"><span class="hs-identifier hs-var">ar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053415"><span class="hs-identifier hs-var">prI</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>                                </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053409"><span class="hs-identifier hs-var">suffLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053415"><span class="hs-identifier hs-var">prI</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053327"><span class="hs-identifier hs-var">preEnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053401"><span class="hs-identifier hs-var">noSuff</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053412"><span class="hs-identifier hs-var">idx</span></a></span><span>
</span><span id="line-277"></span><span>    </span><span class="annot"><span class="annottext">Int -&gt; ST s (STUArray s Int Int)
forall {m :: * -&gt; *}.
MArray (STUArray s) Int m =&gt;
Int -&gt; m (STUArray s Int Int)
</span><a href="#local-6989586621679053401"><span class="hs-identifier hs-var">noSuff</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053327"><span class="hs-identifier hs-var">preEnd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-280"></span><span class="hs-comment">--                             Helper Functions                             --</span><span>
</span><span id="line-281"></span><span class="hs-comment">------------------------------------------------------------------------------</span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#strictify"><span class="hs-pragma hs-type">strictify</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-284"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#strictify"><span class="hs-identifier hs-type">strictify</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">L.ByteString</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span>
</span><span id="line-285"></span><span id="strictify"><span class="annot"><span class="annottext">strictify :: ByteString -&gt; ByteString
</span><a href="Data.ByteString.Search.Internal.Utils.html#strictify"><span class="hs-identifier hs-var hs-var">strictify</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ByteString] -&gt; ByteString
</span><span class="hs-identifier hs-var">S.concat</span></span><span> </span><span class="annot"><span class="annottext">([ByteString] -&gt; ByteString)
-&gt; (ByteString -&gt; [ByteString]) -&gt; ByteString -&gt; ByteString
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString]
</span><span class="hs-identifier hs-var">L.toChunks</span></span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span class="hs-comment">-- drop k bytes from a list of strict ByteStrings</span><span>
</span><span id="line-288"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#ldrop"><span class="hs-pragma hs-type">ldrop</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-289"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#ldrop"><span class="hs-identifier hs-type">ldrop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span class="hs-special">]</span><span>
</span><span id="line-290"></span><span id="ldrop"><span class="annot"><span class="annottext">ldrop :: Int -&gt; [ByteString] -&gt; [ByteString]
</span><a href="Data.ByteString.Search.Internal.Utils.html#ldrop"><span class="hs-identifier hs-var hs-var">ldrop</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-291"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#ldrop"><span class="hs-identifier hs-var">ldrop</span></a></span><span> </span><span id="local-6989586621679053419"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053419"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679053420"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053420"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679053421"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053421"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053419"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053422"><span class="hs-identifier hs-var">l</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">S.drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053419"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053420"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053421"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [ByteString] -&gt; [ByteString]
</span><a href="Data.ByteString.Search.Internal.Utils.html#ldrop"><span class="hs-identifier hs-var">ldrop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053419"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053422"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053421"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-295"></span><span>      </span><span class="hs-glyph">!</span><span id="local-6989586621679053422"><span class="annot"><span class="annottext">l :: Int
</span><a href="#local-6989586621679053422"><span class="hs-identifier hs-var hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">S.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053420"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-comment">-- take k bytes from a list of strict ByteStrings</span><span>
</span><span id="line-298"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#ltake"><span class="hs-pragma hs-type">ltake</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-299"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#ltake"><span class="hs-identifier hs-type">ltake</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span class="hs-special">]</span><span>
</span><span id="line-300"></span><span id="ltake"><span class="annot"><span class="annottext">ltake :: Int -&gt; [ByteString] -&gt; [ByteString]
</span><a href="Data.ByteString.Search.Internal.Utils.html#ltake"><span class="hs-identifier hs-var hs-var">ltake</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-301"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#ltake"><span class="hs-identifier hs-var">ltake</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053424"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053424"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679053425"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053425"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679053426"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053426"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053427"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053424"><span class="hs-identifier hs-var">k</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053425"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [ByteString] -&gt; [ByteString]
</span><a href="Data.ByteString.Search.Internal.Utils.html#ltake"><span class="hs-identifier hs-var">ltake</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053424"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053427"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053426"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int -&gt; ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">S.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053424"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053425"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-305"></span><span>      </span><span class="hs-glyph">!</span><span id="local-6989586621679053427"><span class="annot"><span class="annottext">l :: Int
</span><a href="#local-6989586621679053427"><span class="hs-identifier hs-var hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">S.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053425"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span class="hs-comment">-- split a list of strict ByteStrings at byte k</span><span>
</span><span id="line-308"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#lsplit"><span class="hs-pragma hs-type">lsplit</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-309"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#lsplit"><span class="hs-identifier hs-type">lsplit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span id="lsplit"><span class="annot"><span class="annottext">lsplit :: Int -&gt; [ByteString] -&gt; ([ByteString], [ByteString])
</span><a href="Data.ByteString.Search.Internal.Utils.html#lsplit"><span class="hs-identifier hs-var hs-var">lsplit</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-311"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#lsplit"><span class="hs-identifier hs-var">lsplit</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053429"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053429"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679053430"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053430"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679053431"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053431"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-identifier hs-var">compare</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053429"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053433"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-313"></span><span>      </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">LT</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int -&gt; ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">S.take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053429"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053430"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ByteString -&gt; ByteString
</span><span class="hs-identifier hs-var">S.drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053429"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053430"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053431"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-314"></span><span>      </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">EQ</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053430"><span class="hs-identifier hs-var">h</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053431"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>      </span><span class="annot"><span class="annottext">Ordering
</span><span class="hs-identifier hs-var">GT</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679053435"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053435"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679053436"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053436"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [ByteString] -&gt; ([ByteString], [ByteString])
</span><a href="Data.ByteString.Search.Internal.Utils.html#lsplit"><span class="hs-identifier hs-var">lsplit</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053429"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053433"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053431"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053430"><span class="hs-identifier hs-var">h</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053435"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053436"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-316"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-glyph">!</span><span id="local-6989586621679053433"><span class="annot"><span class="annottext">l :: Int
</span><a href="#local-6989586621679053433"><span class="hs-identifier hs-var hs-var">l</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">S.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053430"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="hs-comment">-- release is used to keep the zipper in lazySearcher from remembering</span><span>
</span><span id="line-321"></span><span class="hs-comment">-- the leading part of the searched string.  The deep parameter is the</span><span>
</span><span id="line-322"></span><span class="hs-comment">-- number of characters that the past needs to hold.  This ensures</span><span>
</span><span id="line-323"></span><span class="hs-comment">-- lazy streaming consumption of the searched string.</span><span>
</span><span id="line-324"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#release"><span class="hs-pragma hs-type">release</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-325"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#release"><span class="hs-identifier hs-type">release</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span class="hs-special">]</span><span>
</span><span id="line-326"></span><span id="release"><span class="annot"><span class="annottext">release :: Int -&gt; [ByteString] -&gt; [ByteString]
</span><a href="Data.ByteString.Search.Internal.Utils.html#release"><span class="hs-identifier hs-var hs-var">release</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053437"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053437"><span class="hs-identifier hs-var">deep</span></a></span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053437"><span class="hs-identifier hs-var">deep</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-328"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#release"><span class="hs-identifier hs-var">release</span></a></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053439"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053439"><span class="hs-identifier hs-var">deep</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679053440"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053440"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679053441"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053441"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053443"><span class="annot"><span class="annottext">rest :: [ByteString]
</span><a href="#local-6989586621679053443"><span class="hs-identifier hs-var hs-var">rest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [ByteString] -&gt; [ByteString]
</span><a href="Data.ByteString.Search.Internal.Utils.html#release"><span class="hs-identifier hs-var">release</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053439"><span class="hs-identifier hs-var">deep</span></a></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">S.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053440"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053441"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053440"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053443"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-329"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#release"><span class="hs-identifier hs-var">release</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [ByteString]
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;stringsearch.release could not find enough past!&quot;</span></span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span class="hs-comment">-- keep is like release, only we mustn't forget the part of the past</span><span>
</span><span id="line-332"></span><span class="hs-comment">-- we don't need anymore for matching but have to keep it for</span><span>
</span><span id="line-333"></span><span class="hs-comment">-- breaking, splitting and replacing.</span><span>
</span><span id="line-334"></span><span class="hs-comment">-- The names would be more appropriate the other way round, but that's</span><span>
</span><span id="line-335"></span><span class="hs-comment">-- a historical accident, so what?</span><span>
</span><span id="line-336"></span><span class="hs-pragma">{-# INLINE</span><span> </span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#keep"><span class="hs-pragma hs-type">keep</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-337"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#keep"><span class="hs-identifier hs-type">keep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">S.ByteString</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span id="keep"><span class="annot"><span class="annottext">keep :: Int -&gt; [ByteString] -&gt; ([ByteString], [ByteString])
</span><a href="Data.ByteString.Search.Internal.Utils.html#keep"><span class="hs-identifier hs-var hs-var">keep</span></a></span></span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621679053445"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053445"><span class="hs-identifier hs-var">deep</span></a></span></span><span> </span><span id="local-6989586621679053446"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053446"><span class="hs-identifier hs-var">xs</span></a></span></span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053445"><span class="hs-identifier hs-var">deep</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053446"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#keep"><span class="hs-identifier hs-var">keep</span></a></span><span> </span><span id="local-6989586621679053447"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053447"><span class="hs-identifier hs-var">deep</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679053448"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053448"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679053449"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053449"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">!</span><span id="local-6989586621679053451"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053451"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621679053452"><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053452"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [ByteString] -&gt; ([ByteString], [ByteString])
</span><a href="Data.ByteString.Search.Internal.Utils.html#keep"><span class="hs-identifier hs-var">keep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679053447"><span class="hs-identifier hs-var">deep</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">ByteString -&gt; Int
</span><span class="hs-identifier hs-var">S.length</span></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053448"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053449"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621679053448"><span class="hs-identifier hs-var">x</span></a></span><span class="annot"><span class="annottext">ByteString -&gt; [ByteString] -&gt; [ByteString]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053451"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621679053452"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span class="annot"><a href="Data.ByteString.Search.Internal.Utils.html#keep"><span class="hs-identifier hs-var">keep</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ([ByteString], [ByteString])
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Forgot too much&quot;</span></span><span>
</span><span id="line-342"></span></pre></body></html>